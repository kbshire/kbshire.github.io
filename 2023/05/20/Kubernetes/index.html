



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="http://example.com/2023/05/20/Kubernetes/">



  <title>
Kubernetes |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Kubernetes
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2023-05-20 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2023-05-20T13:38:45+08:00">2023-05-20</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gicit31ffoj20zk0m8naf.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclh5u05ej20zk0m87df.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipevarprfj20zk0m8npd.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giciryrr3rj20zk0m8nhk.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclh3brzpj20zk0m8ann.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclhpw3lwj20zk0m8gvw.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/20/Kubernetes/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="kubernetes"><a class="markdownIt-Anchor" href="#kubernetes">#</a> Kubernetes</h1>
<p>[TOC]</p>
<p>VPC 私有网络，不同 VPC 之间相互隔离</p>
<p>k8s 大规模容器编排系统</p>
<p>master/node 模式</p>
<h2 id="k8s特性"><a class="markdownIt-Anchor" href="#k8s特性">#</a> k8s 特性</h2>
<blockquote>
<ul>
<li><strong>服务发现和负载均衡</strong><br>
 Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器，如果进入容器的流量很大， Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</li>
<li><strong>存储编排</strong><br>
 Kubernetes 允许你自动挂载你选择的存储系统，例如本地存储、公共云提供商等。</li>
<li><strong>自动部署和回滚</strong><br>
你可以使用 Kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态 更改为期望状态。例如，你可以自动化 Kubernetes 来为你的部署创建新容器， 删除现有容器并将它们的所有资源用于新容器。</li>
<li><strong>自动完成装箱计算</strong><br>
 Kubernetes 允许你指定每个容器所需 CPU 和内存（RAM）。 当容器指定了资源请求时，Kubernetes 可以做出更好的决策来管理容器的资源。</li>
<li><strong>自我修复</strong><br>
 Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的 运行状况检查的容器，并且在准备好服务之前不将其通告给客户端。</li>
<li><strong>密钥与配置管理</strong><br>
 Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。 你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</li>
</ul>
</blockquote>
<h2 id="架构"><a class="markdownIt-Anchor" href="#架构">#</a> 架构</h2>
<p>主节点 (master) + 工作节点 (worker)</p>
<p>K8s 集群至少需要一个主节点 (Master) 和多个工作节点 (Worker)，Master 节点是集群的控制节点，负责整个集群的管理和控制，主节点主要用于暴露 API，调度部署和节点的管理。工作节点主要是运行容器的。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/components-of-kubernetes.svg" alt="Kubernetes 组件"></p>
<p>多 master 节点高可用架构</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230423162509705.png" alt="image-20230423162509705"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kubectl：管理K8s的命令行工具，可以操作K8s中的资源对象。</span><br><span class="line"></span><br><span class="line">etcd： 是一个高可用的键值数据库，存储K8s的资源状态信息和网络信息的，etcd中的数据变更是通过api server进行的。</span><br><span class="line"></span><br><span class="line">apiserver:  提供K8s api，是整个系统的对外接口，提供资源操作的唯一入口，供客户端和其它组件调用，提供了K8s各类资源对象（pod,deployment,Service等）的增删改查，是整个系统的数据总线和数据中心，并提供认证、授权、访问控制、API注册和发现等机制，并将操作对象持久化到etcd中。相当于“营业厅”。</span><br><span class="line"></span><br><span class="line">scheduler：负责K8s集群中pod的调度的 ， scheduler通过与apiserver交互监听到创建Pod副本的信息后，它会检索所有符合该Pod要求的工作节点列表，开始执行Pod调度逻辑。调度成功后将Pod绑定到目标节点上，相当于“调度室”。</span><br><span class="line"></span><br><span class="line">controller-manager：与apiserver交互，实时监控和维护K8s集群的控制器的健康情况，对有故障的进行处理和恢复，相当于“大总管”。</span><br><span class="line"></span><br><span class="line">kubelet： 每个Node节点上的kubelet定期就会调用API Server的REST接口报告自身状态，API Server接收这些信息后，将节点状态信息更新到etcd中。kubelet也通过API Server监听Pod信息，从而对Node机器上的POD进行管理，如创建、删除、更新Pod</span><br><span class="line"></span><br><span class="line">kube-proxy：提供网络代理和负载均衡，是实现service的通信与负载均衡机制的重要组件，kube-proxy负责为Pod创建代理服务，从apiserver获取所有service信息，并根据service信息创建代理服务，实现service到Pod的请求路由和转发，从而实现K8s层级的虚拟转发网络，将到service的请求转发到后端的pod上。 </span><br><span class="line"></span><br><span class="line">calico:网络插件，提供IP，策略隔离</span><br><span class="line"></span><br><span class="line">coredns:域名解析</span><br></pre></td></tr></table></figure>
<h3 id="资源对象"><a class="markdownIt-Anchor" href="#资源对象">#</a> 资源对象</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Pod是Kubernetes中的最小调度单元，当指派容器时，容器实际上并不会指派到物理硬件上，容器会被分配到一个Pod里。Pod代表集群上正在运行的一个进程，一个Pod封装一个容器（也可以封装多个容器），Pod里的容器共享存储、网络等。也就是说，应该把整个pod看作虚拟机，然后每个容器相当于运行在虚拟机的进程。</span><br><span class="line"></span><br><span class="line">Replicaset</span><br><span class="line">Kubernetes中的副本控制器，管理Pod，使pod副本的数量始终维持在预设的个数。</span><br><span class="line"></span><br><span class="line">Deployment管理Replicaset和Pod的副本控制器，Deployment可以管理多个Replicaset，是比Replicaset更高级的控制器，也即是说在创建Deployment的时候，会自动创建Replicaset，由Replicaset再创建Pod，Deployment能对Pod扩容、缩容、滚动更新和回滚、维持Pod数量。</span><br><span class="line"></span><br><span class="line">Service</span><br><span class="line">在kubernetes中，Pod是有生命周期的，如果Pod重启IP很有可能会发生变化。如果我们的服务都是将Pod的IP地址写死，Pod的挂掉或者重启，和刚才重启的pod相关联的其他服务将会找不到它所关联的Pod，为了解决这个问题，在kubernetes中定义了service资源对象，Service 定义了一个服务访问的入口，客户端通过这个入口即可访问服务背后的应用集群实例，service是一组Pod的逻辑集合，这一组 Pod 能够被 Service 访问到，通常是通过 Label Selector实现的。</span><br><span class="line"></span><br><span class="line">Statefulset</span><br><span class="line"></span><br><span class="line">Job &amp; CronJob</span><br><span class="line"></span><br><span class="line">Ingress </span><br><span class="line"></span><br><span class="line">Configmap和Secret</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>开发代码 -&gt; 提交代码到代码仓库 -&gt;Jenkins 调 K8s API-&gt; 动态生成 Jenkins Slave Pod-&gt;Slave Pod 拉取 git 上的代码 -&gt; 编译代码 -&gt; 打包镜像 -&gt; 推送镜像到镜像仓库 harbor 或者 docker hub-&gt; 通过 K8s 编排服务发布到测试、生产平台 -&gt; Slave Pod 工作完成之后自动删除 &gt; 通过 Ingress 发布服务。</p>
<h3 id="kubeadm安装k8s多master高可用集群"><a class="markdownIt-Anchor" href="#kubeadm安装k8s多master高可用集群">#</a> kubeadm 安装 k8s 多 master 高可用集群</h3>
<blockquote>
<p>kubeadm 是官方提供的开源工具，是一个开源项目，用于快速搭建 kubernetes 集群，目前是比较方便和推荐使用的。kubeadm init 以及 kubeadm join 这两个命令可以快速创建 kubernetes 集群。Kubeadm 初始化 k8s，所有的组件都是以 pod 形式运行的，具备故障自恢复能力。</p>
<p>kubeadm 是工具，可以快速搭建集群，也就是相当于用程序脚本帮我们装好了集群，属于自动部署，简化部署操作，自动部署屏蔽了很多细节，使得对各个模块感知很少，如果对 k8s 架构组件理解不深的话，遇到问题比较难排查。</p>
<p>kubeadm 适合需要经常部署 k8s，或者对自动化要求比较高的场景下使用。</p>
<p>二进制：在官网下载相关组件的二进制包，如果手动安装，对 kubernetes 理解也会更全面。</p>
<p>Kubeadm 和二进制都适合生产环境，在生产环境运行都很稳定，具体如何选择，可以根据实际项目进行评估。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --prefix= --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt=<span class="string">&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic&#x27;</span> --with-ld-opt=<span class="string">&#x27;-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E&#x27;</span> --with-stream </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">auto eth0</span><br><span class="line">iface eth0 inet static</span><br><span class="line">address 192.168.13.198</span><br><span class="line">gateway 192.168.13.2</span><br><span class="line">netmask 255.255.255.0</span><br></pre></td></tr></table></figure>
<h2 id="安装"><a class="markdownIt-Anchor" href="#安装">#</a> 安装</h2>
<p>1. 安装 docker</p>
<p>2. 安装 kubelet</p>
<p>3. 安装 kubectl</p>
<p>4. 安装 kubeadm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">预配环境：</span><br><span class="line">#各个机器设置自己的域名</span><br><span class="line">hostnamectl set-hostname xxxx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 将 SELinux 设置为 permissive 模式（相当于将其禁用）</span><br><span class="line">sudo setenforce 0</span><br><span class="line">sudo sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">#关闭swap</span><br><span class="line">swapoff -a  </span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="line"></span><br><span class="line">#允许 iptables 检查桥接流量</span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure>
<p>安装 kubelet、kubeadm、kubectl</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span></span><br><span class="line"><span class="string">   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">exclude=kubelet kubeadm kubectl</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now kubelet</span><br></pre></td></tr></table></figure>
<p>安装 kubelet、kubeadm、kubectl</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> ./images.sh &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">images=(</span><br><span class="line">kube-apiserver:v1.20.9</span><br><span class="line">kube-proxy:v1.20.9</span><br><span class="line">kube-controller-manager:v1.20.9</span><br><span class="line">kube-scheduler:v1.20.9</span><br><span class="line">coredns:1.7.0</span><br><span class="line">etcd:3.4.13-0</span><br><span class="line">pause:3.2</span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">EOF</span><br><span class="line">   </span><br><span class="line"><span class="built_in">chmod</span> +x ./images.sh &amp;&amp; ./images.sh</span><br></pre></td></tr></table></figure>
<p>初始化主节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所有机器添加master域名映射，以下需要修改为自己的</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;172.23.142.216  k8s-master&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#主节点初始化</span></span><br><span class="line">kubeadm init \</span><br><span class="line">--apiserver-advertise-address=172.23.142.216 \</span><br><span class="line">--control-plane-endpoint=k8s-master \</span><br><span class="line">--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \</span><br><span class="line">--kubernetes-version v1.20.9 \</span><br><span class="line">--service-cidr=10.96.0.0/16 \</span><br><span class="line">--pod-network-cidr=192.168.0.0/16</span><br><span class="line"></span><br><span class="line"><span class="comment">#所有网络范围不重叠</span></span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now <span class="built_in">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and <span class="keyword">then</span> running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm <span class="built_in">join</span> cluster-endpoint:6443 --token 902kx7.ic9ncjvtuksmf2rw \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:753403dbd24f4cef391a276ad67e8c9c8d91cec64467998426e3021123381b36 \</span><br><span class="line">    --control-plane </span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> cluster-endpoint:6443 --token 902kx7.ic9ncjvtuksmf2rw \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:753403dbd24f4cef391a276ad67e8c9c8d91cec64467998426e3021123381b36 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">主节点</span><br><span class="line"> <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"> sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"> sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  </span><br><span class="line"> 主节点</span><br><span class="line"> 下载calico</span><br><span class="line">https://docs.tigera.io/archive/v3.22/getting-started/kubernetes/self-managed-onprem/onpremises</span><br><span class="line">curl https://projectcalico.docs.tigera.io/archive/v3.22/manifests/calico.yaml -O</span><br><span class="line"></span><br><span class="line"> kubectl apply -f calico.yaml</span><br><span class="line"> </span><br><span class="line"> [root@i-taf5qf6u ~]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE         NAME                                       READY   STATUS              RESTARTS   AGE</span><br><span class="line">kube-system       calico-kube-controllers-57c7b58f66-jq7lm   0/1     ContainerCreating   0          22m</span><br><span class="line">kube-system       calico-node-4bttn                          1/1     Running             0          22m</span><br><span class="line">kube-system       coredns-5897cd56c4-2fhkm                   1/1     Running             0          55m</span><br><span class="line">kube-system       coredns-5897cd56c4-2l59f                   1/1     Running             0          55m</span><br><span class="line">kube-system       etcd-master                                1/1     Running             0          55m</span><br><span class="line">kube-system       kube-apiserver-master                      1/1     Running             0          55m</span><br><span class="line">kube-system       kube-controller-manager-master             1/1     Running             0          55m</span><br><span class="line">kube-system       kube-proxy-d4sgz                           1/1     Running             0          55m</span><br><span class="line">kube-system       kube-scheduler-master                      1/1     Running             0          55m</span><br><span class="line">tigera-operator   tigera-operator-57cb64cf85-kqsvh           1/1     Running             0          37m</span><br><span class="line">[root@i-taf5qf6u ~]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME     STATUS   ROLES                  AGE   VERSION</span><br><span class="line">master   Ready    control-plane,master   56m   v1.20.9</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群所有节点</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 很久配置文件，给集群创建资源</span></span><br><span class="line">kubectl appy -f xxx.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群部署了那些命令</span></span><br><span class="line">kubectl get pods -A</span><br><span class="line"><span class="comment"># 类似于docker ps -a</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># worker 加入master</span></span><br><span class="line">kubeadm <span class="built_in">join</span> cluster-endpoint:6443 --token 902kx7.ic9ncjvtuksmf2rw \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:753403dbd24f4cef391a276ad67e8c9c8d91cec64467998426e3021123381b36 </span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新创建新的令牌</span></span><br><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>
<p>==== new =====</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重置kubeadm</span></span><br><span class="line">kubeadm reset</span><br><span class="line"><span class="comment"># 相当于卸载k8s</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据机器上安装了哪些组件区分</span></span><br><span class="line"><span class="comment"># master</span></span><br><span class="line">apiserver controller-manager scheduler etcd kube-proxy  docker calico</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># node </span></span><br><span class="line">coredns</span><br><span class="line">calico</span><br><span class="line">kubelet</span><br><span class="line">kube-proxy</span><br><span class="line">docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Swap是交换分区，如果机器内存不够，会使用swap分区，但是swap分区的性能较低，k8s设计的时候为了能提升性能，默认是不允许使用交换分区的。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定--ignore-preflight-errors=Swap来解决。</span><br><span class="line">free -m</span><br><span class="line"></span><br><span class="line">1.24之后使用contained </span><br><span class="line"></span><br><span class="line">Kubeadm:  kubeadm是一个工具，用来初始化k8s集群的</span><br><span class="line">kubelet:   安装在集群所有节点上，用于启动Pod的</span><br><span class="line">kubectl:   通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl config view </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.13.249:16443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line"><span class="built_in">users</span>:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br><span class="line"></span><br><span class="line"><span class="comment"># 想在其他机器上执行kubevtl需要有/root/.kube/config </span></span><br><span class="line"></span><br><span class="line">kubeadm 在执行安装之前进行了相当细致的环境检测</span><br><span class="line"></span><br><span class="line">   1) 检查执行 init 命令的用户是否为 root，如果不是 root，直接快速失败（fail fast）；</span><br><span class="line">   2) 检查待安装的 k8s 版本是否被当前版本的 kubeadm 支持（kubeadm 版本 &gt;= 待安装 k8s 版本）；</span><br><span class="line">   3) 检查防火墙，如果防火墙未关闭，提示开放端口 10250；</span><br><span class="line">   4) 检查端口是否已被占用，6443（或你指定的监听端口）、10257、10259；</span><br><span class="line">   5) 检查文件是否已经存在，/etc/kubernetes/manifests/*.yaml；</span><br><span class="line">   6) 检查是否存在代理，连接本机网络、服务网络、Pod网络，都会检查，目前不允许代理；</span><br><span class="line">   7) 检查容器运行时，使用 CRI 还是 Docker，如果是 Docker，进一步检查 Docker 服务是否已启动，是否设置了开机自启动；</span><br><span class="line">   8) 对于 Linux 系统，会额外检查以下内容：</span><br><span class="line">       8.1) 检查以下命令是否存在：crictl、ip、iptables、mount、nsenter、ebtables、ethtool、socat、tc、<span class="built_in">touch</span>；</span><br><span class="line">       8.2) 检查 /proc/sys/net/bridge/bridge-nf-call-iptables、/proc/sys/net/ipv4/ip-forward 内容是否为 1；</span><br><span class="line">       8.3) 检查 swap 是否是关闭状态；</span><br><span class="line">    9) 检查内核是否被支持，Docker 版本及后端存储 GraphDriver 是否被支持；</span><br><span class="line">         对于 Linux 系统，还需检查 OS 版本和 cgroup 支持程度（支持哪些资源的隔离）；</span><br><span class="line">    10) 检查主机名访问可达性；</span><br><span class="line">    11) 检查 kubelet 版本，要高于 kubeadm 需要的最低版本，同时不高于待安装的 k8s 版本；</span><br><span class="line">    12) 检查 kubelet 服务是否开机自启动；</span><br><span class="line">    13) 检查 10250 端口是否被占用；</span><br><span class="line">    14) 如果开启 IPVS 功能，检查系统内核是否加载了 ipvs 模块；</span><br><span class="line">    15) 对于 etcd，如果使用 Local etcd，则检查 2379 端口是否被占用， /var/lib/etcd/ 是否为空目录；</span><br><span class="line">          如果使用 External etcd，则检查证书文件是否存在（CA、key、cert），验证 etcd 服务版本是否符合要求；</span><br><span class="line">    16) 如果使用 IPv6，</span><br><span class="line">           检查 /proc/sys/net/bridge/bridge-nf-call-iptables、/proc/sys/net/ipv6/conf/default/forwarding 内容是否为 1；</span><br><span class="line"></span><br><span class="line">完成安装前的配置</span><br><span class="line">       1) 在 kube-system 命名空间创建 ConfigMap kubeadm-config，同时对其配置 RBAC 权限；</span><br><span class="line">       2) 在 kube-system 命名空间创建 ConfigMap kubelet-config-&lt;version&gt;，同时对其配置 RBAC 权限；</span><br><span class="line">       3) 为当前节点（Master）打标记：node-role.kubernetes.io/master=；</span><br><span class="line">       4) 为当前节点（Master）补充 Annotation；</span><br><span class="line">       5) 如果启用了 DynamicKubeletConfig 特性，设置本节点 kubelet 的配置数据源为 ConfigMap 形式；</span><br><span class="line">       6) 创建 BootStrap token Secret，并对其配置 RBAC 权限；</span><br><span class="line">       7) 在 kube-public 命名空间创建 ConfigMap cluster-info，同时对其配置 RBAC 权限；</span><br><span class="line">       8) 与 apiserver 通信，部署 DNS 服务；</span><br><span class="line">       9) 与 apiserver 通信，部署 kube-proxy 服务；</span><br><span class="line">       10) 如果启用了 self-hosted 特性，将 Control Plane 转为 DaemonSet 形式运行；</span><br><span class="line">       11) 打印 <span class="built_in">join</span> 语句；</span><br><span class="line">       </span><br><span class="line">Kubeadm生成的k8s证书内容说明：</span><br><span class="line">一、证书分组</span><br><span class="line">Kubernetes把证书放在了两个文件夹中</span><br><span class="line">/etc/kubernetes/pki</span><br><span class="line">/etc/kubernetes/pki/etcd</span><br><span class="line"></span><br><span class="line">二、Kubernetes 集群根证书</span><br><span class="line">Kubernetes 集群根证书CA(Kubernetes集群组件的证书签发机构)</span><br><span class="line">/etc/kubernetes/pki/ca.crt</span><br><span class="line">/etc/kubernetes/pki/ca.key</span><br><span class="line"></span><br><span class="line">以上这组证书为签发其他Kubernetes组件证书使用的根证书, 可以认为是Kubernetes集群中证书签发机构之一</span><br><span class="line"></span><br><span class="line">由此根证书签发的证书有:</span><br><span class="line">1、kube-apiserver apiserver证书</span><br><span class="line">/etc/kubernetes/pki/apiserver.crt</span><br><span class="line">/etc/kubernetes/pki/apiserver.key</span><br><span class="line">2、kubelet客户端证书, 用作 kube-apiserver 主动向 kubelet 发起请求时的客户端认证</span><br><span class="line">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span><br><span class="line">/etc/kubernetes/pki/apiserver-kubelet-client.key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">三、kube-apiserver 代理根证书(客户端证书)</span><br><span class="line">用在requestheader-client-ca-file配置选项中, kube-apiserver 使用该证书来验证客户端证书是否为自己所签发</span><br><span class="line">/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">/etc/kubernetes/pki/front-proxy-ca.key</span><br><span class="line"></span><br><span class="line">由此根证书签发的证书只有一组:</span><br><span class="line">代理层(如汇聚层aggregator)使用此套代理证书来向 kube-apiserver 请求认证</span><br><span class="line">代理端使用的客户端证书, 用作代用户与 kube-apiserver 认证</span><br><span class="line">/etc/kubernetes/pki/front-proxy-client.crt</span><br><span class="line">/etc/kubernetes/pki/front-proxy-client.key</span><br><span class="line"></span><br><span class="line">三、etcd 集群根证书</span><br><span class="line">etcd集群所用到的证书都保存在/etc/kubernetes/pki/etcd这路径下, 很明显, 这一套证书是用来专门给etcd集群服务使用的, 设计以下证书文件</span><br><span class="line">etcd 集群根证书CA(etcd 所用到的所有证书的签发机构)</span><br><span class="line">/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">/etc/kubernetes/pki/etcd/ca.key</span><br><span class="line"></span><br><span class="line">由此根证书签发机构签发的证书有:</span><br><span class="line">1、etcd server 持有的服务端证书</span><br><span class="line">/etc/kubernetes/pki/etcd/server.crt</span><br><span class="line">/etc/kubernetes/pki/etcd/server.key</span><br><span class="line"></span><br><span class="line">2、peer 集群中节点互相通信使用的客户端证书</span><br><span class="line">/etc/kubernetes/pki/etcd/peer.crt</span><br><span class="line">/etc/kubernetes/pki/etcd/peer.key</span><br><span class="line">注: Peer：对同一个etcd集群中另外一个Member的称呼</span><br><span class="line">3、pod 中定义 Liveness 探针使用的客户端证书</span><br><span class="line">kubeadm 部署的 Kubernetes 集群是以 pod 的方式运行 etcd 服务的, 在该 pod 的定义中, 配置了 Liveness 探活探针</span><br><span class="line">/etc/kubernetes/pki/etcd/healthcheck-client.crt</span><br><span class="line">/etc/kubernetes/pki/etcd/healthcheck-client.key</span><br><span class="line"></span><br><span class="line">当你 describe etcd 的 pod 时, 会看到如下一行配置:</span><br><span class="line">Liveness: <span class="built_in">exec</span> [/bin/sh -ec ETCDCTL_API=3 etcdctl --endpoints=https://[127.0.0.1]:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt --key=/etc/kubernetes/pki/etcd/healthcheck-client.key get foo] delay=15s <span class="built_in">timeout</span>=15s period=10s <span class="comment">#success=1 #failure=8</span></span><br><span class="line"></span><br><span class="line">4、配置在 kube-apiserver 中用来与 etcd server 做双向认证的客户端证书</span><br><span class="line">/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br><span class="line">/etc/kubernetes/pki/apiserver-etcd-client.key</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230425155408675.png" alt="image-20230425155408675"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Calico网络模型主要工作组件：</span><br><span class="line">1.Felix：运行在每一台 Host 的 agent 进程，主要负责网络接口管理和监听、路由、ARP 管理、ACL 管理和同步、状态上报等。保证跨主机容器网络互通。</span><br><span class="line">2.etcd：分布式键值存储，相当于k8s集群中的数据库，存储着Calico网络模型中IP地址等相关信息。主要负责网络元数据一致性，确保 Calico 网络状态的准确性；</span><br><span class="line">3.BGP Client（BIRD）：Calico 为每一台 Host 部署一个 BGP Client，即每台host上部署一个BIRD。 主要负责把 Felix 写入 Kernel 的路由信息分发到当前 Calico 网络，确保 Workload 间的通信的有效性；</span><br><span class="line">4.BGP Route Reflector：在大型网络规模中，如果仅仅使用 BGP client 形成 mesh 全网互联的方案就会导致规模限制，因为所有节点之间俩俩互联，需要 N^2 个连接，为了解决这个规模问题，可以采用 BGP 的 Router Reflector 的方法，通过一个或者多个 BGP Route Reflector 来完成集中式的路由分发。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">扩展：calico的IPIP模式和BGP模式对比分析</span><br><span class="line">1）IPIP</span><br><span class="line">把一个IP数据包又套在一个IP包里，即把IP层封装到IP层的一个 tunnel，它的作用其实基本上就相当于一个基于IP层的网桥，一般来说，普通的网桥是基于mac层的，根本不需要IP，而这个ipip则是通过两端的路由做一个tunnel，把两个本来不通的网络通过点对点连接起来；</span><br><span class="line"></span><br><span class="line">calico以ipip模式部署完毕后，node上会有一个tunl0的网卡设备，这是ipip做隧道封装用的,也是一种overlay模式的网络。当我们把节点下线，calico容器都停止后，这个设备依然还在，执行 rmmodipip命令可以将它删除。</span><br><span class="line"></span><br><span class="line">2）BGP</span><br><span class="line">BGP模式直接使用物理机作为虚拟路由路（vRouter），不再创建额外的tunnel</span><br><span class="line"></span><br><span class="line">边界网关协议（BorderGateway Protocol, BGP）是互联网上一个核心的去中心化的自治路由协议。它通过维护IP路由表或‘前缀’表来实现自治系统（AS）之间的可达性，属于矢量路由协议。BGP不使用传统的内部网关协议（IGP）的指标，而是基于路径、网络策略或规则集来决定路由。因此，它更适合被称为矢量性协议，而不是路由协议，通俗的说就是将接入到机房的多条线路（如电信、联通、移动等）融合为一体，实现多线单IP；</span><br><span class="line"></span><br><span class="line">BGP 机房的优点：服务器只需要设置一个IP地址，最佳访问路由是由网络上的骨干路由器根据路由跳数与其它技术指标来确定的，不会占用服务器的任何系统；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">常见网络插件</span><br><span class="line">Flannel</span><br><span class="line">Calico</span><br><span class="line">Weave</span><br><span class="line">canal</span><br><span class="line">kubeadm init --config kubeadm.yaml --ignore-preflight-errors=SystemVerification</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.20.6</span><br><span class="line">controlPlaneEndpoint: 192.168.13.249:16443</span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers</span><br><span class="line">apiServer:</span><br><span class="line"> certSANs:</span><br><span class="line"> - 192.168.13.211</span><br><span class="line"> - 192.168.13.177</span><br><span class="line"> - 192.168.13.188</span><br><span class="line"> - 192.168.13.249</span><br><span class="line">networking:</span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">  serviceSubnet: 10.96.0.0/16</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind:  KubeProxyConfiguration</span><br><span class="line">mode: ipvs</span><br><span class="line">kubectl label node xianchaonode1 node-role.kubernetes.io/worker=worker</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 脚本一键安装</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line"></span><br><span class="line"><span class="comment"># IP地址,默认为本机第一块网卡IP地址(不包含lo网卡)</span></span><br><span class="line">ip=</span><br><span class="line"><span class="comment"># 主机名称,默认为当前主机名称</span></span><br><span class="line">hostName=master</span><br><span class="line"><span class="comment"># Docker版本</span></span><br><span class="line">dockerVersion=20.10.6</span><br><span class="line"><span class="comment"># Kubernetes版本</span></span><br><span class="line">k8sVersion=1.23.0</span><br><span class="line"><span class="comment"># Pod网段</span></span><br><span class="line">podSubnet=<span class="string">&quot;10.244.0.0/16&quot;</span></span><br><span class="line"><span class="comment"># Service网段</span></span><br><span class="line">serviceSubnet=<span class="string">&quot;10.10.0.0/16&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">openNetwork</span></span>()&#123;</span><br><span class="line">ping -c 1 www.baidu.com &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">	action <span class="string">&quot;外网权限:&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	action <span class="string">&quot;外网权限:&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;此脚本需要访问外网权限才可成功执行,退出脚本&quot;</span></span><br><span class="line">	<span class="built_in">exit</span> 5</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stopFirewall</span></span>()&#123;</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld --now &amp;&gt;/dev/null</span><br><span class="line">setenforce 0 &amp;&gt;/dev/null</span><br><span class="line">sed  -i.$(<span class="built_in">date</span> +%F) -r <span class="string">&#x27;s/SELINUX=[ep].*/SELINUX=disabled/g&#x27;</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (grep SELINUX=disabled /etc/selinux/config) &amp;&gt;/dev/null;<span class="keyword">then</span></span><br><span class="line">	action <span class="string">&quot;关闭防火墙:&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	action <span class="string">&quot;关闭防火墙:&quot;</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">hostName</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="variable">$&#123;ip&#125;</span> ]];<span class="keyword">then</span></span><br><span class="line">	ip=$(ip addr | grep -oP <span class="string">&#x27;(?&lt;=inet\s)\d+\.\d+\.\d+\.\d+&#x27;</span>|egrep -v <span class="string">&quot;127.0.0.1|172.17.0.1&quot;</span>|awk NR==1)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="variable">$&#123;hostName&#125;</span> ]];<span class="keyword">then</span></span><br><span class="line">	hostName=<span class="string">&quot;<span class="variable">$&#123;HOSTNAME&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ! (egrep -w <span class="string">&quot;<span class="variable">$&#123;ip&#125;</span> +<span class="variable">$&#123;hostName&#125;</span>&quot;</span> /etc/hosts) &amp;&gt;/dev/null;<span class="keyword">then</span></span><br><span class="line">	hostnamectl set-hostname <span class="variable">$&#123;hostName&#125;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;ip&#125;</span> <span class="variable">$&#123;hostName&#125;</span>&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (egrep -w <span class="string">&quot;<span class="variable">$&#123;ip&#125;</span> +<span class="variable">$&#123;hostName&#125;</span>&quot;</span> /etc/hosts) &amp;&gt;/dev/null;<span class="keyword">then</span></span><br><span class="line">	action <span class="string">&quot;添加本地域名解析:&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        action <span class="string">&quot;添加本地域名解析:&quot;</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">timeSync</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> ! (<span class="built_in">which</span> ntpdate &amp;&gt;/dev/null);<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> -e <span class="string">&quot;\033[32m# ntpdate未安装,开始进行安装....\033[0m&quot;</span></span><br><span class="line">	(yum -y install ntpdate) &amp;&gt;/dev/null;<span class="built_in">sleep</span> 0.3</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">which</span> ntpdate &amp;&gt;/dev/null);<span class="keyword">then</span></span><br><span class="line">		action <span class="string">&quot;ntpdate安装成功:&quot;</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ntpdate ntp1.aliyun.com &amp;&gt;/dev/null);<span class="keyword">then</span></span><br><span class="line">	<span class="keyword">if</span> ! (egrep <span class="string">&quot;ntpdate +ntp1.aliyun.com&quot;</span> /var/spool/cron/root &amp;&gt;/dev/null);<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;0 1 * * * ntpdate ntp1.aliyun.com&quot;</span> &gt;&gt; /var/spool/cron/root</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">		action <span class="string">&quot;时间同步:&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	action <span class="string">&quot;时间同步:&quot;</span> <span class="literal">false</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">swapOff</span></span>()&#123;</span><br><span class="line">swapoff --all</span><br><span class="line">sed -i -r <span class="string">&#x27;/swap/ s/^/#/&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ $(free | grep -i swap | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>) -eq 0 ]]; <span class="keyword">then</span></span><br><span class="line">    action <span class="string">&quot;关闭交换分区:&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    action <span class="string">&quot;关闭交换分区:&quot;</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">addKernelArg</span></span>()&#123;</span><br><span class="line">KernelArg=(<span class="string">&quot;net.bridge.bridge-nf-call-ip6tables&quot;</span> <span class="string">&quot;net.bridge.bridge-nf-call-iptables&quot;</span> <span class="string">&quot;net.ipv4.ip_forward&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断内核参数是否存在,如果不存在则添加</span></span><br><span class="line"><span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$&#123;#KernelArg[@]&#125;</span>;i++))<span class="keyword">do</span></span><br><span class="line">	<span class="keyword">if</span> [[ $(sysctl -n <span class="variable">$&#123;KernelArg[i]&#125;</span>) -ne 1 ]];<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;KernelArg[i]&#125;</span> = 1&quot;</span> &gt;&gt; /etc/sysctl.d/kubernetes.conf</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">modprobe br_netfilter &amp;&gt;/dev/null</span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ $(sysctl -n <span class="variable">$&#123;KernelArg[0]&#125;</span>) -eq 1 &amp;&amp; $(sysctl -n <span class="variable">$&#123;KernelArg[1]&#125;</span>) -eq 1 &amp;&amp; $(sysctl -n <span class="variable">$&#123;KernelArg[2]&#125;</span>) -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">		action <span class="string">&quot;添加内核参数&quot;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		action <span class="string">&quot;添加内核参数&quot;</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ipvs</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">command</span> -v ipset &amp;&gt;/dev/null &amp;&amp; <span class="built_in">command</span> -v ipvsadm &amp;&gt;/dev/null);<span class="keyword">then</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">modprobe -- ip_vs</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_sh</span></span><br><span class="line"><span class="string">modprobe -- nf_conntrack_ipv4  </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">	<span class="built_in">chmod</span> +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">	/etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> -e <span class="string">&quot;\033[32m# ipvs未安装,开始进行安装....\033[0m&quot;</span></span><br><span class="line">	yum -y install ipset ipvsadm &amp;&gt;/dev/null</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">command</span> -v ipset &amp;&gt;/dev/null &amp;&amp; <span class="built_in">command</span> -v ipvsadm &amp;&gt;/dev/null);<span class="keyword">then</span></span><br><span class="line">		action <span class="string">&quot;ipvs安装成功:&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">modprobe -- ip_vs</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_sh</span></span><br><span class="line"><span class="string">modprobe -- nf_conntrack_ipv4  </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">	        <span class="built_in">chmod</span> +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">        	/etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">modprobe br_netfilter &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (lsmod | grep -q -e ip_vs -e nf_conntrack_ipv4)&amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">	action <span class="string">&quot;启用ipvs模块:&quot;</span> </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	action <span class="string">&quot;启用ipvs模块:&quot;</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">dockerInstall</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> ! (<span class="built_in">command</span> -v docker &amp;&gt;/dev/null);<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> -e <span class="string">&quot;\033[32m# Docker未安装,开始进行安装....\033[0m&quot;</span></span><br><span class="line">	(curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo) &amp;&gt;/dev/null</span><br><span class="line">	(wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo) &amp;&gt;/dev/null</span><br><span class="line">	(yum install -y yum-utils) &amp;&gt;/dev/null</span><br><span class="line">	(yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo) &amp;&gt;/dev/null</span><br><span class="line">	(yum install docker-ce-<span class="variable">$&#123;dockerVersion&#125;</span> docker-ce-cli-<span class="variable">$&#123;dockerVersion&#125;</span> -y) &amp;&gt;/dev/null</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">command</span> -v docker &amp;&gt;/dev/null);<span class="keyword">then</span></span><br><span class="line">		action <span class="string">&quot;Docker安装成功:&quot;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		action <span class="string">&quot;Docker安装成功:&quot;</span> <span class="literal">false</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /etc/docker &amp;&gt;/dev/null</span><br><span class="line"><span class="keyword">if</span> [[ -f /etc/docker/daemon.json ]];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">mv</span> /etc/docker/daemon.json&#123;,.$(<span class="built_in">date</span> +%F)&#125;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/docker/daemon.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://aoewjvel.mirror.aliyuncs.com&quot;],</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">(systemctl <span class="built_in">enable</span> docker --now) &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -f /etc/docker/daemon.json ]];<span class="keyword">then</span></span><br><span class="line">	action <span class="string">&quot;Docker镜像加速源:&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	action <span class="string">&quot;Docker镜像加速源:&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">k8sInstall</span></span>()&#123;</span><br><span class="line">k8scommand=(<span class="string">&quot;kubeadm&quot;</span> <span class="string">&quot;kubelet&quot;</span> <span class="string">&quot;kubectl&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -f /etc/yum.repos.d/kubernetes.repo ]];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">mv</span> /etc/yum.repos.d/kubernetes.repo&#123;,.$(<span class="built_in">date</span> +%F)&#125;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m# 正在安装K8S,请耐心等待......\033[0m&quot;</span></span><br><span class="line">(yum -y install --<span class="built_in">setopt</span>=obsoletes=0 kubeadm-<span class="variable">$&#123;k8sVersion&#125;</span> kubelet-<span class="variable">$&#123;k8sVersion&#125;</span> kubectl-<span class="variable">$&#123;k8sVersion&#125;</span>) &amp;&gt;/dev/null</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet.service --now  &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$&#123;#k8scommand[@]&#125;</span>;i++))<span class="keyword">do</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">command</span> -v <span class="variable">$&#123;k8scommand[i]&#125;</span> &amp;&gt;/dev/null);<span class="keyword">then</span></span><br><span class="line">		action <span class="string">&quot;安装<span class="variable">$&#123;k8scommand[i]&#125;</span>组件:&quot;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		action <span class="string">&quot;安装<span class="variable">$&#123;k8scommand[i]&#125;</span>组件:&quot;</span> <span class="literal">false</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">k8sInit</span></span>()&#123;</span><br><span class="line"><span class="comment"># 通过hosts文件获取IP地址</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="variable">$&#123;ip&#125;</span> ]];<span class="keyword">then</span></span><br><span class="line">	ip=$(grep <span class="variable">$&#123;HOSTNAME&#125;</span> /etc/hosts|awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>| awk NR==1)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -f /root/kubeadm-config.yaml ]];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">mv</span> /root/kubeadm-config.yaml&#123;,.$(<span class="built_in">date</span> +%F)&#125;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; /root/kubeadm-config.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="string">bootstrapTokens:</span></span><br><span class="line"><span class="string">- groups:</span></span><br><span class="line"><span class="string">  - system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line"><span class="string">  token: abcdef.0123456789abcdef</span></span><br><span class="line"><span class="string">  ttl: 24h0m0s</span></span><br><span class="line"><span class="string">  usages:</span></span><br><span class="line"><span class="string">  - signing</span></span><br><span class="line"><span class="string">  - authentication</span></span><br><span class="line"><span class="string">kind: InitConfiguration</span></span><br><span class="line"><span class="string">localAPIEndpoint:</span></span><br><span class="line"><span class="string">  advertiseAddress: $&#123;ip&#125;</span></span><br><span class="line"><span class="string">  bindPort: 6443</span></span><br><span class="line"><span class="string">nodeRegistration:</span></span><br><span class="line"><span class="string">  imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  name: node</span></span><br><span class="line"><span class="string">  taints: null</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiServer:</span></span><br><span class="line"><span class="string">  timeoutForControlPlane: 4m0s</span></span><br><span class="line"><span class="string">apiVersion: kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="string">certificatesDir: /etc/kubernetes/pki</span></span><br><span class="line"><span class="string">clusterName: kubernetes</span></span><br><span class="line"><span class="string">controllerManager: &#123;&#125;</span></span><br><span class="line"><span class="string">dns: &#123;&#125;</span></span><br><span class="line"><span class="string">etcd:</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    dataDir: /var/lib/etcd</span></span><br><span class="line"><span class="string">imageRepository: registry.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="string">kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">kubernetesVersion: $&#123;k8sVersion&#125;</span></span><br><span class="line"><span class="string">networking:</span></span><br><span class="line"><span class="string">  dnsDomain: cluster.local</span></span><br><span class="line"><span class="string">  serviceSubnet: $&#123;serviceSubnet&#125;</span></span><br><span class="line"><span class="string">  podSubnet: $&#123;podSubnet&#125;</span></span><br><span class="line"><span class="string">scheduler: &#123;&#125;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="string">kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">mode: ipvs</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">kind: KubeletConfiguration</span></span><br><span class="line"><span class="string">cgroupDriver: systemd</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -f /root/kubeadm-config.yaml ]];<span class="keyword">then</span></span><br><span class="line">        action <span class="string">&quot;生成K8s初始化文件:&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        action <span class="string">&quot;生成K8s初始化文件:&quot;</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m# K8s初始化中,时间可能较长,可以使用 tailf k8s_init.log 可追踪整个过程....\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> </span><br><span class="line">kubeadm init --config /root/kubeadm-config.yaml --ignore-preflight-errors=SystemVerification &amp;&gt;k8s_init.log</span><br><span class="line"><span class="keyword">if</span> [[ $? -eq 0 ]];<span class="keyword">then</span></span><br><span class="line">	action <span class="string">&quot;K8s初始化:&quot;</span></span><br><span class="line">	<span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">	sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">	sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	action <span class="string">&quot;K8s初始化:&quot;</span> <span class="literal">false</span></span><br><span class="line">	<span class="built_in">exit</span> 5</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">k8sNetwork</span></span>()&#123;</span><br><span class="line">(wget -O /root/calico.yaml  http://120.48.34.146/calico.yaml) &amp;&gt;/dev/null</span><br><span class="line">(kubectl apply -f  /root/calico.yaml) &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ $? -eq 0 ]];<span class="keyword">then</span></span><br><span class="line">	action <span class="string">&quot;K8s网络插件:&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	action <span class="string">&quot;K8s网络插件:&quot;</span>  <span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">k8sTaint</span></span>()&#123;</span><br><span class="line">(kubectl taint nodes --all node-role.kubernetes.io/master-) &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ $? -eq 0 ]];<span class="keyword">then</span></span><br><span class="line">        action <span class="string">&quot;设置Master节点可调度:&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        action <span class="string">&quot;设置Master节点可调度:&quot;</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">initEnv</span></span>()&#123;</span><br><span class="line">clear;<span class="built_in">echo</span> <span class="string">&quot;一键部署单机版K8S脚本&quot;</span></span><br><span class="line">openNetwork</span><br><span class="line">hostName</span><br><span class="line">stopFirewall</span><br><span class="line">swapOff</span><br><span class="line">timeSync</span><br><span class="line">ipvs</span><br><span class="line">addKernelArg</span><br><span class="line">dockerInstall</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">k8s</span></span>()&#123;</span><br><span class="line">clear;k8sInstall</span><br><span class="line">k8sInit</span><br><span class="line">k8sNetwork</span><br><span class="line">k8sTaint</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m# K8s单机版部署完成,等待Pod全部运行成功即可使用 使用 kubectl get pods -n kube-system 关注Pod状态...\033[0m&quot;</span></span><br><span class="line">bash</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initEnv</span><br><span class="line">k8s</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="部署dashboard"><a class="markdownIt-Anchor" href="#部署dashboard">#</a> 部署 dashboard</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubernetes-dashboard   dashboard-metrics-scraper-79c5968bdc-24bws   1/1     Running   0          2m5s</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard-658485d5c7-9hpsc        1/1     Running   0          2m5s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">设置访问端口</span><br><span class="line">kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">:/type</span><br><span class="line">改为 NodePort</span><br><span class="line"></span><br><span class="line">kubectl get svc -A |grep kubernetes-dashboard</span><br><span class="line"><span class="comment">## 找到端口，在安全组放行</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get svc -A |grep kubernetes-dashboard</span></span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper   ClusterIP   10.96.232.147   &lt;none&gt;        8000/TCP                 6m7s</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard        NodePort    10.96.28.103    &lt;none&gt;        443:31882/TCP            6m7s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过token访问</span></span><br><span class="line">[root@master ~]<span class="comment"># vi dash-user.yml</span></span><br><span class="line"><span class="comment">#创建访问账号，准备一个yaml文件； vi dash.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl apply -f dash-user.yml </span></span><br><span class="line">serviceaccount/admin-user created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取访问令牌</span></span><br><span class="line">kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath=<span class="string">&quot;&#123;.secrets[0].name&#125;&quot;</span>) -o go-template=<span class="string">&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</span></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IkY5LU9Jc0pnblNNOVJhM1dlWVl6c09DTjNnbFNQa1hzcWhOSThHVENEdlUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXp3NmRzIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJkOTRmMDZlNi1kNTkxLTRmMzktODMxNC0zNzI2MDVhM2RkN2MiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.TMTc8QDTIo3qhsGTYD05c8txOyq2op7xW9ZQB5ICVw5x4fg-L0iUnn1jGyo4REP6ci63zBR-xmirqHy1eQ5GgT1nwGZnv4oKqNElm8-wkAit5rEgVN7ATo5GN3VrRQgNyBsHwqFhe1SsrK47flCZcmBvWbgmU4ugFfrNZ8xHkSURKrLAPUPjsYUC6ugyrEMqfwhcxzMiZcSKxG20jjLgVK7Pd_T01NAObUb_lCjq7mrEV0KdHcYTtSYwVwV88mTu5vwb39k-10V0s6HOqiDx87lp7fPtctrcR3mRiT1PkEvsyhCb8qAuFDPuaJZtESFu2dCXP_fVmv5g7AhSO_qUHg</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410143529721.png" alt="image-20230410143529721"></p>
<p>如果页面没有接受风险，换浏览器或者空白输入 thisisunsafe</p>
<p><strong>通过 token 访问 dashboard</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看token </span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:kubernetes-dashboard</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get secrets -n kubernetes-dashboard </span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl describe secrets kubernetes-dashboard-token-dmv8x -n kubernetes-dashboard </span></span><br></pre></td></tr></table></figure>
<p><strong>通过 kubeconfig 访问 dashborad</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes/pki/</span><br><span class="line">kubectl config set-cluster kubernetes --certificate-authority=./ca.crt --server=<span class="string">&quot;https://192.168.40.249:6443&quot;</span> --embed-certs=<span class="literal">true</span> --kueconfig=/root/dashboard-admin.conf</span><br><span class="line">DEF_NS_ADMIN_TOKEN=$(kubectl get secret kubernetes-dashboard-token-dmv8x -n kubernetes-dashboard  -o jsonpath=&#123;.data.token&#125;|<span class="built_in">base64</span> -d</span><br><span class="line">kubectl config set-credentials dashboard-admin --token=<span class="variable">$DEF_NS_ADMIN_TOKEN</span> --kubeconfig=/root/dashboard-admin.conf</span><br><span class="line">kubectl config set-context dashboard-admin@kubernetes --cluster=kubernetes --user=dashboard-admin --kubeconfig=/root/dashboard-admin.onf</span><br><span class="line">kubectl config use-context dashboard-admin@kubernetes --kubeconfig=/root/dashboard-admin.conf</span><br><span class="line">vim /root/dashboard-admin.conf </span><br></pre></td></tr></table></figure>
<h3 id="安装containerd"><a class="markdownIt-Anchor" href="#安装containerd">#</a> 安装 containerd</h3>
<p>对于 1.24 以上的版本，使用 containerd 管理和运行容器，在此版本之前使用的是 docker</p>
<p><strong>Kubernetes 中的容器运行时就像一个保姆一样，它负责管理容器的生命周期和资源隔离，确保容器能够在节点上稳定地运行。其中，containerd 就是一个常用的容器运行时，它实现了 Kubernetes 规定的 CRI 接口，因此可以被 Kubernetes 作为容器运行时来使用。简单来说，就是 Kubernetes 需要容器运行时来管理和运行容器，而 containerd 就是 Kubernetes 中常用的一种容器运行时，能够让 Kubernetes 更加高效、稳定地运行容器化应用。</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">yum install  containerd.io-1.6.6 -y</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line">vim /etc/containerd/config.toml  <span class="comment"># 修改</span></span><br><span class="line">SystemdCgroup = <span class="literal">true</span></span><br><span class="line">sandbox_image=<span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">相比 cgroupfs，systemd-cgroup 在资源隔离方面提供了更好的性能和更多的特性。例如，systemd-cgroup 可以使用更多的内存压缩算法，以便更有效地使用内存。此外，systemd-cgroup 还提供了更好的 cgroup 监控和控制机制，可以更精确地调整容器的资源使用量。</span><br><span class="line">总之，使用 systemd-cgroup 作为容器运行时的 cgroup 驱动程序，可以提高 Kubernetes 集群中容器的资源管理效率，从而提升整个集群的性能。</span><br><span class="line"></span><br><span class="line">在 Kubernetes 中，每个 Pod 中都有一个 pause 容器，这个容器不会运行任何应用，只是简单地 <span class="built_in">sleep</span>。它的作用是为了保证 Pod 中所有的容器共享同一个网络命名空间和 IPC 命名空间。pause 容器会在 Pod 的初始化过程中首先启动，然后为 Pod 中的其他容器创建对应的网络和 IPC 命名空间，并且在其他容器启动之前保持运行状态，以保证其他容器可以加入到共享的命名空间中。</span><br><span class="line">简单来说，pause 容器就是一个占位符，它为 Pod 中的其他容器提供了一个共享的环境，使它们可以共享同一个网络和 IPC 命名空间。这也是 Kubernetes 实现容器间通信和网络隔离的重要机制之一。</span><br><span class="line"> </span><br><span class="line">创建/etc/crictl.yaml文件</span><br><span class="line">[root@xianchaomaster1 ~]<span class="comment">#cat &gt; /etc/crictl.yaml &lt;&lt;EOF</span></span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line"><span class="built_in">timeout</span>: 10</span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">这个文件是 crictl 工具的配置文件，用于指定与 containerd 交互的相关设置：</span><br><span class="line"></span><br><span class="line">指定unix:///run/containerd/containerd.sock 是为了告诉 crictl 使用 Unix 域套接字的方式来连接 containerd 的 API。containerd 提供了一个 socket 文件 /run/containerd/containerd.sock，crictl 通过连接该 socket 文件，可以与 containerd 进行通信，管理容器和镜像等操作。</span><br><span class="line"></span><br><span class="line">1）runtime-endpoint：指定 containerd 的运行时接口地址，以便 crictl 可以与 containerd 通信来管理容器生命周期和资源隔离。</span><br><span class="line">2）image-endpoint：指定 containerd 的镜像接口地址，以便 crictl 可以与 containerd 通信来管理镜像的拉取和推送。</span><br><span class="line">3）<span class="built_in">timeout</span>：指定 crictl 等待 containerd 响应的最大时间，避免出现无响应的情况。</span><br><span class="line">4）debug：开启或关闭 crictl 的调试模式，方便排查问题。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#systemctl enable containerd  --now</span></span><br><span class="line"></span><br><span class="line">配置containerd镜像加速器，k8s所有节点均按照以下配置：</span><br><span class="line">编辑vim /etc/containerd/config.toml文件</span><br><span class="line">找到config_path = <span class="string">&quot;&quot;</span>，修改成如下目录：</span><br><span class="line">config_path = <span class="string">&quot;/etc/containerd/certs.d&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#保存退出</span></span><br><span class="line"><span class="built_in">mkdir</span> /etc/containerd/certs.d/docker.io/ -p</span><br><span class="line">vim /etc/containerd/certs.d/docker.io/hosts.toml</span><br><span class="line"><span class="comment">#写入如下内容：</span></span><br><span class="line">[host.<span class="string">&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;</span>,host.<span class="string">&quot;https://registry.docker-cn.com&quot;</span>]</span><br><span class="line">  capabilities = [<span class="string">&quot;pull&quot;</span>,<span class="string">&quot;push&quot;</span>]</span><br><span class="line"></span><br><span class="line">重启containerd：</span><br><span class="line">systemctl restart containerd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum install  docker-ce  -y</span><br><span class="line"><span class="comment"># 为了使用dockerfile所以还要装docker</span></span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">写入如下内容：</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;registry-mirrors&quot;</span>:[<span class="string">&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;</span>,<span class="string">&quot;https://registry.docker-cn.com&quot;</span>,<span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,<span class="string">&quot;https://dockerhub.azk8s.cn&quot;</span>,<span class="string">&quot;http://hub-mirror.c.163.com&quot;</span>]</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">重启docker：</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.ctr是containerd自带的CLI命令行工具，crictl是k8s中CRI（容器运行时接口）的客户端，k8s使用该客户端和containerd进行交互；</span><br><span class="line"></span><br><span class="line">2.ctr和crictl命令具体区别如下，也可以--help查看。crictl缺少对具体镜像的管理能力，可能是k8s层面镜像管理可以由用户自行控制，能配置pod里面容器的统一镜像仓库，镜像的管理可以有habor</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230426170330957.png" alt="image-20230426170330957"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">K8s官方文档：https://kubernetes.io/</span><br><span class="line">K8s中文官方文档： https://kubernetes.io/zh/</span><br><span class="line">K8s Github地址：https://github.com/kubernetes/kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="namespace"><a class="markdownIt-Anchor" href="#namespace">#</a> Namespace</h2>
<p>Kubernetes 支持多个虚拟集群，它们底层依赖于同一个物理集群。 这些虚拟集群被称为命名空间。</p>
<p>命名空间 namespace 是 k8s 集群级别的资源，可以给不同的用户、租户、环境或项目创建对应的命名空间</p>
<p>命名空间适用于存在很多跨多个团队或项目的用户的场景。默认存放在 default 空间下</p>
<p>隔离资源，不隔离网络</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl get ns </span></span><br><span class="line">NAME                   STATUS   AGE</span><br><span class="line">calico-system          Active   41h</span><br><span class="line">default                Active   41h</span><br><span class="line">kube-node-lease        Active   41h</span><br><span class="line">kube-public            Active   41h</span><br><span class="line">kube-system            Active   41h</span><br><span class="line">kubernetes-dashboard   Active   27m</span><br><span class="line">tigera-operator        Active   41h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有命名空间下</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pods -A </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认命名空间</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定名称空间</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pods -n kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除名称空间</span></span><br><span class="line">kubectl delete ns 111</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建名称空间</span></span><br><span class="line">kubectl create ns 111</span><br><span class="line">kubectl get ns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过yaml创建名称空间</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: hello</span><br><span class="line"></span><br><span class="line">kubectl explain ResourceQuota</span><br><span class="line"><span class="comment"># 创建资源限额的namespace</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ResourceQuota</span><br><span class="line">metadata:</span><br><span class="line">  name: mem-cpu-quota</span><br><span class="line">  namespace: testing</span><br><span class="line">spec:</span><br><span class="line">  hard:</span><br><span class="line">    requests.cpu: <span class="string">&quot;2&quot;</span></span><br><span class="line">    requests.memory: 2Gi</span><br><span class="line">    limits.cpu: <span class="string">&quot;4&quot;</span></span><br><span class="line">    limits.memory: 4Gi</span><br><span class="line">    </span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get resourcequotas -n testing </span></span><br><span class="line">NAME            AGE   REQUEST                                     LIMIT</span><br><span class="line">mem-cpu-quota   18s   requests.cpu: 0/2, requests.memory: 0/1Gi   limits.cpu: 0/4, limits.memory: 0/2Gi</span><br><span class="line"></span><br><span class="line">request node必须有空闲的request指定的内存才会调度pod到该node上</span><br><span class="line"><span class="built_in">limit</span>是限制不能超过指定的内存和CPU</span><br><span class="line"><span class="comment"># 在namespace下面定义的pod加起来必须满足request和limit</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-test</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  labels:</span><br><span class="line">    app: tomcat-pod-test</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name:  tomcat-test</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    image: tomcat-8.5-jre8</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: <span class="string">&quot;100Mi&quot;</span></span><br><span class="line">        cpu: <span class="string">&quot;500m&quot;</span></span><br><span class="line">      limits:</span><br><span class="line">        memory: <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">        cpu: <span class="string">&quot;2&quot;</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># 即pod request和limit不能超过namespace的request和limit，否则不能创建</span></span><br><span class="line"><span class="comment"># namespace指定request和limit，pod也必须指定</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pod超过了ns的限制会无法创建</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="pod"><a class="markdownIt-Anchor" href="#pod">#</a> pod</h2>
<p>运行中的一组容器，Pod 是 kubernetes 中应用的最小调度单元 k8s 是通过定义一个 Pod 的资源，然后在 Pod 里面运行容器，容器需要指定一个镜像，这样就可以用来运行具体的服务。</p>
<p>一个 Pod 封装一个容器（也可以封装多个容器），<strong>Pod 里的容器共享存储、网络等</strong>。也就是说，应该把整个 pod 看作虚拟机，然后每个容器相当于运行在虚拟机的进程。</p>
<p>Pod 是需要调度到 k8s 集群的工作节点来运行的，具体调度到哪个节点，是<strong>根据 scheduler 调度器实现的。</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410144807975.png" alt="image-20230410144807975" style="zoom:67%;" /> <img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410144917082.png" alt="image-20230410144917082" style="zoom:67%;" /></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526165706388.png" alt="image-20230526165706388"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526170239453.png" alt="image-20230526170239453"></p>
<h3 id="pod管理多个容器"><a class="markdownIt-Anchor" href="#pod管理多个容器">#</a> pod 管理多个容器</h3>
<p>pod 之间隔离，pod 中可以运行多个容器，pod 中共享资源</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410145136606.png" alt="image-20230410145136606"></p>
<p>Pod 中可以同时运行多个容器。同一个 Pod 中的容器会自动的分配到同一个 node 上。同一个 Pod 中的容器共享资源、网络环境，它们总是被同时调度，在一个 Pod 中同时运行多个容器是一种比较高级的用法，只有当你的容器需要紧密配合协作的时候才考虑用这种模式。</p>
<p>例如，你有一个容器作为 web 服务器运行，需要用到共享的 volume，有另一个 “sidecar” 容器来从远端获取资源更新这些文件。</p>
<p>一些 Pod 有 init 容器和应用容器。 在应用程序容器启动之前，运行初始化容器。比如 es 就需要有 init 容器修改 es 内核参数</p>
<h3 id="pod网络"><a class="markdownIt-Anchor" href="#pod网络">#</a> Pod 网络</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pki]<span class="comment"># kubectl get pod -A -owide</span></span><br><span class="line">NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE   IP               NODE      </span><br><span class="line">default                nginx-7f466444dc-jbhpm                       1/1     Running   0          77m   10.244.166.134   node1     &lt;none&gt;  </span><br><span class="line">kube-system            calico-kube-controllers-57c7b58f66-b7pw7     1/1     Running   0          24h   10.244.166.132   node1     &lt;none&gt;   </span><br><span class="line">kube-system            calico-node-fdzw9                            1/1     Running   1          24h   192.168.13.188   master2   &lt;none&gt;   </span><br><span class="line">kube-system            calico-node-hz96l                            1/1     Running   1          24h   192.168.13.199   node1     &lt;none&gt;   </span><br><span class="line"></span><br><span class="line">Pod是有IP地址的，假如pod不是共享物理机ip，由网络插件（calico、flannel、weave）划分的ip，每个pod都被分配唯一的IP地址</span><br><span class="line"></span><br><span class="line">控制节点组件 pod ip和物理机ip一样</span><br><span class="line">如果pod由calico分配，且不共享物理机IP，那么IP唯一,ip地址段在配置时指定</span><br><span class="line"></span><br><span class="line">docker 容器间通信，通过--net container参数，指定其和已经存在的某个容器共享一个 Network Namespace。</span><br><span class="line">docker run --name container2 --net=container:none  -it --privileged=<span class="literal">true</span> centos</span><br><span class="line"></span><br><span class="line">Kubernetes中容器共享的方式</span><br><span class="line">在k8s中，启动Pod时，会先启动⼀个pause 的容器，然后将后续的所有容器都 <span class="built_in">link</span> 到这个pause 的容器，以实现⽹络共享</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526171816395.png" alt="image-20230526171816395"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427134601678.png" alt="image-20230427134601678"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230426173422564.png" alt="image-20230426173422564"></p>
<h3 id="pod-存储"><a class="markdownIt-Anchor" href="#pod-存储">#</a> pod 存储</h3>
<p>创建 Pod 的时候可以指定挂载的存储卷。 POD 中的所有容器都可以访问共享卷，允许这些容器共享数据。 Pod 只要挂载持久化数据卷，Pod 重启之后数据还是会存在的</p>
<p>volume 可以是 nfs，cefs，或者云存储</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230426173643049.png" alt="image-20230426173643049"></p>
<p>Pod 中的所用容器会被一致调度、同节点部署，并且在一个 “共享环境” 中运行。</p>
<p>1）所有容器共享一个 IP 地址和端口空间，意味着容器之间可以通过 localhost 高效访问，不能有端口冲突</p>
<p>2）允许容器之间共享存储卷，通过文件系统交互信息</p>
<p>些容器需要紧密联系，需要一起工作。Pod 提供了比容器更高层次的抽象， Pod 中的所有容器使用同一个网络的 namespace，即相同的 IP 地址和 Port 空间。它们可以直接用 localhost 通信。同样的，这些容器可以共享存储，当 K8s 挂载 Volume 到 Pod 上，本质上是将 volume 挂载到 Pod 中的每一个容器里。</p>
<p>通过 pod 可以实现代码自动更新和日志收集</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230426175239516.png" alt="image-20230426175239516"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">生产环境部署了一个go的应用，而且部署了几百个节点，希望这个应用可以定时的同步最新的代码，以便自动升级线上环境。这时，我们不希望改动原来的go应用，可以开发一个Git代码仓库的自动同步服务，然后通过Pod的方式进行编排，并共享代码目录，就可以达到更新java应用代码的效果。</span><br></pre></td></tr></table></figure>
<p>pod 实现日志收集并 aggregate</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230426175303038.png" alt="image-20230426175303038"></p>
<p>使用 Pod 的方式，通过简单的编排，既可以保持原有服务逻辑、部署方式不变，又可以增加新的日志收集服务。<br>
而且如果我们对所有服务的日志生成有一个统一的标准，或者仅对日志收集服务稍加修改，就可以将日志收集服务和其他服务进行 Pod 编排，提供统一、标准的日志收集方式。<br>
这里的 “核心业务服务”、“日志收集服务” 分别是一个镜像，运行在隔离的容器环境中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建方式</span></span><br><span class="line"><span class="number">1.</span><span class="string">kubectl</span> <span class="string">run</span> <span class="string">命令行创建</span>  <span class="string">(不常用)</span></span><br><span class="line"><span class="number">2.</span><span class="string">yaml文件创建</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pod工作方式</span></span><br><span class="line"><span class="number">1</span><span class="string">.自主式pod：直接定义一个pod资源</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">tomcat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">tomcat-java</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pod -A -owide -l app=tomcat</span></span><br><span class="line"><span class="string">NAMESPACE</span>   <span class="string">NAME</span>          <span class="string">READY</span>   <span class="string">STATUS</span>              <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>       <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">default</span>     <span class="string">tomcat-test</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">66s</span>   <span class="string">&lt;none&gt;</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod被删之后不会在重启</span> <span class="string">kubectl</span> <span class="string">delete</span> <span class="string">pod</span> </span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">.控制器管理pod</span></span><br><span class="line"><span class="string">常见的管理Pod的控制器：Replicaset、Deployment、Job、CronJob、Daemonset、Statefulset。</span></span><br><span class="line"><span class="string">控制器管理的Pod可以确保Pod始终维持在指定的副本数运行。</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment、Job...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-deploy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">xianchao/nginx:v1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h3 id="pod-创建机制"><a class="markdownIt-Anchor" href="#pod-创建机制">#</a> pod 创建机制</h3>
<p>kubectl 执行的时候先找 kubeconfig 的环境变量，如果没有就找～/.kube/config</p>
<p><code>kubectl config view</code>  查看不带 key 的 config</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl config view </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.13.249:16443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">REDACTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">REDACTED</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用kubernetes-admin访问192.168.13.249:16443，找到apiserver</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427135535238.png" alt="image-20230427135535238"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx-deploy.yaml-&gt;找到config文件，基于config文件指定的用户访问指定的集群，这样就找到了apiserver</span><br><span class="line"></span><br><span class="line">第一步：</span><br><span class="line">通过 kubectl 命令向 apiserver 提交创建pod的请求，apiserver接收到pod创建请求后，会将pod的属性信息(metadata)写入etcd。</span><br><span class="line"></span><br><span class="line">第二步：</span><br><span class="line">apiserver触发watch机制准备创建pod，信息转发给调度器scheduler，调度器使用调度算法选择node，调度器将node信息给apiserver，apiserver将绑定的node信息写入etcd</span><br><span class="line"></span><br><span class="line">第三步：</span><br><span class="line">apiserver又通过watch机制，调用kubelet，指定pod信息，调用容器运行时创建并启动pod内的容器。</span><br><span class="line"></span><br><span class="line">第四步：</span><br><span class="line">创建完成之后反馈给kubelet, kubelet又将pod的状态信息给apiserver,</span><br><span class="line">apiserver又将pod的状态信息写入etcd。</span><br></pre></td></tr></table></figure>
<h3 id="yaml创建pod"><a class="markdownIt-Anchor" href="#yaml创建pod">#</a> yaml 创建 pod</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master2</span> <span class="string">~</span>]<span class="comment"># kubectl explain pod </span></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">Pod</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DESCRIPTION:</span></span><br><span class="line">     <span class="string">Pod</span> <span class="string">is</span> <span class="string">a</span> <span class="string">collection</span> <span class="string">of</span> <span class="string">containers</span> <span class="string">that</span> <span class="string">can</span> <span class="string">run</span> <span class="string">on</span> <span class="string">a</span> <span class="string">host.</span> <span class="string">This</span> <span class="string">resource</span> <span class="string">is</span></span><br><span class="line">     <span class="string">created</span> <span class="string">by</span> <span class="string">clients</span> <span class="string">and</span> <span class="string">scheduled</span> <span class="string">onto</span> <span class="string">hosts.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">apiVersion</span>	<span class="string">&lt;string&gt;</span></span><br><span class="line">     <span class="string">APIVersion</span> <span class="string">defines</span> <span class="string">the</span> <span class="string">versioned</span> <span class="string">schema</span> <span class="string">of</span> <span class="string">this</span> <span class="string">representation</span> <span class="string">of</span> <span class="string">an</span></span><br><span class="line">     <span class="string">object.</span> <span class="string">Servers</span> <span class="string">should</span> <span class="string">convert</span> <span class="string">recognized</span> <span class="string">schemas</span> <span class="string">to</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">internal</span></span><br><span class="line">     <span class="string">value,</span> <span class="attr">and may reject unrecognized values. More info:</span></span><br><span class="line">     <span class="string">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span></span><br><span class="line"></span><br><span class="line">   <span class="string">kind</span>	<span class="string">&lt;string&gt;</span></span><br><span class="line">     <span class="string">Kind</span> <span class="string">is</span> <span class="string">a</span> <span class="string">string</span> <span class="string">value</span> <span class="string">representing</span> <span class="string">the</span> <span class="string">REST</span> <span class="string">resource</span> <span class="string">this</span> <span class="string">object</span></span><br><span class="line">     <span class="string">represents.</span> <span class="string">Servers</span> <span class="string">may</span> <span class="string">infer</span> <span class="string">this</span> <span class="string">from</span> <span class="string">the</span> <span class="string">endpoint</span> <span class="string">the</span> <span class="string">client</span> <span class="string">submits</span></span><br><span class="line">     <span class="attr">requests to. Cannot be updated. In CamelCase. More info:</span></span><br><span class="line">     <span class="string">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span></span><br><span class="line"></span><br><span class="line">   <span class="string">metadata</span>	<span class="string">&lt;Object&gt;</span></span><br><span class="line">     <span class="string">Standard</span> <span class="string">object&#x27;s</span> <span class="attr">metadata. More info:</span></span><br><span class="line">     <span class="string">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class="line"></span><br><span class="line">   <span class="string">spec</span>	<span class="string">&lt;Object&gt;</span></span><br><span class="line">     <span class="attr">Specification of the desired behavior of the pod. More info:</span></span><br><span class="line">     <span class="string">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class="line"></span><br><span class="line">   <span class="string">status</span>	<span class="string">&lt;Object&gt;</span></span><br><span class="line">     <span class="string">Most</span> <span class="string">recently</span> <span class="string">observed</span> <span class="string">status</span> <span class="string">of</span> <span class="string">the</span> <span class="string">pod.</span> <span class="string">This</span> <span class="string">data</span> <span class="string">may</span> <span class="string">not</span> <span class="string">be</span> <span class="string">up</span> <span class="string">to</span> <span class="string">date.</span></span><br><span class="line">     <span class="attr">Populated by the system. Read-only. More info:</span></span><br><span class="line">     <span class="string">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master2</span> <span class="string">~</span>]<span class="comment"># kubectl explain pod.metadata</span></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">Pod</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">RESOURCE:</span> <span class="string">metadata</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DESCRIPTION:</span></span><br><span class="line">     <span class="string">Standard</span> <span class="string">object&#x27;s</span> <span class="attr">metadata. More info:</span></span><br><span class="line">     <span class="string">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class="line"></span><br><span class="line">     <span class="string">ObjectMeta</span> <span class="string">is</span> <span class="string">metadata</span> <span class="string">that</span> <span class="string">all</span> <span class="string">persisted</span> <span class="string">resources</span> <span class="string">must</span> <span class="string">have,</span> <span class="string">which</span></span><br><span class="line">     <span class="string">includes</span> <span class="string">all</span> <span class="string">objects</span> <span class="string">users</span> <span class="string">must</span> <span class="string">create.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">annotations</span>	<span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">     <span class="string">Annotations</span> <span class="string">is</span> <span class="string">an</span> <span class="string">unstructured</span> <span class="string">key</span> <span class="string">value</span> <span class="string">map</span> <span class="string">stored</span> <span class="string">with</span> <span class="string">a</span> <span class="string">resource</span> <span class="string">that</span></span><br><span class="line">     <span class="string">may</span> <span class="string">be</span> <span class="string">set</span> <span class="string">by</span> <span class="string">external</span> <span class="string">tools</span> <span class="string">to</span> <span class="string">store</span> <span class="string">and</span> <span class="string">retrieve</span> <span class="string">arbitrary</span> <span class="string">metadata.</span> <span class="string">They</span></span><br><span class="line">     <span class="string">are</span> <span class="string">not</span> <span class="string">queryable</span> <span class="string">and</span> <span class="string">should</span> <span class="string">be</span> <span class="string">preserved</span> <span class="string">when</span> <span class="string">modifying</span> <span class="string">objects.</span> <span class="string">More</span></span><br><span class="line">     <span class="attr">info:</span> <span class="string">http://kubernetes.io/docs/user-guide/annotations</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master2</span> <span class="string">~</span>]<span class="comment"># kubectl explain pod.spec</span></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">Pod</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">RESOURCE:</span> <span class="string">spec</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DESCRIPTION:</span></span><br><span class="line">     <span class="attr">Specification of the desired behavior of the pod. More info:</span></span><br><span class="line">     <span class="string">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class="line"></span><br><span class="line">     <span class="string">PodSpec</span> <span class="string">is</span> <span class="string">a</span> <span class="string">description</span> <span class="string">of</span> <span class="string">a</span> <span class="string">pod.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">activeDeadlineSeconds</span>	<span class="string">&lt;integer&gt;</span></span><br><span class="line">     <span class="string">Optional</span> <span class="string">duration</span> <span class="string">in</span> <span class="string">seconds</span> <span class="string">the</span> <span class="string">pod</span> <span class="string">may</span> <span class="string">be</span> <span class="string">active</span> <span class="string">on</span> <span class="string">the</span> <span class="string">node</span> <span class="string">relative</span> <span class="string">to</span></span><br><span class="line">     <span class="string">StartTime</span> <span class="string">before</span> <span class="string">the</span> <span class="string">system</span> <span class="string">will</span> <span class="string">actively</span> <span class="string">try</span> <span class="string">to</span> <span class="string">mark</span> <span class="string">it</span> <span class="string">failed</span> <span class="string">and</span> <span class="string">kill</span></span><br><span class="line">     <span class="string">associated</span> <span class="string">containers.</span> <span class="string">Value</span> <span class="string">must</span> <span class="string">be</span> <span class="string">a</span> <span class="string">positive</span> <span class="string">integer.</span></span><br><span class="line"></span><br><span class="line">   <span class="string">affinity</span>	<span class="string">&lt;Object&gt;</span></span><br><span class="line">     <span class="string">If</span> <span class="string">specified,</span> <span class="string">the</span> <span class="string">pod&#x27;s</span> <span class="string">scheduling</span> <span class="string">constraints</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master2</span> <span class="string">~</span>]<span class="comment"># kubectl explain pod.spec.containers </span></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">Pod</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">RESOURCE:</span> <span class="string">containers</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DESCRIPTION:</span></span><br><span class="line">     <span class="string">List</span> <span class="string">of</span> <span class="string">containers</span> <span class="string">belonging</span> <span class="string">to</span> <span class="string">the</span> <span class="string">pod.</span> <span class="string">Containers</span> <span class="string">cannot</span> <span class="string">currently</span> <span class="string">be</span></span><br><span class="line">     <span class="string">added</span> <span class="string">or</span> <span class="string">removed.</span> <span class="string">There</span> <span class="string">must</span> <span class="string">be</span> <span class="string">at</span> <span class="string">least</span> <span class="string">one</span> <span class="string">container</span> <span class="string">in</span> <span class="string">a</span> <span class="string">Pod.</span> <span class="string">Cannot</span> <span class="string">be</span></span><br><span class="line">     <span class="string">updated.</span></span><br><span class="line"></span><br><span class="line">     <span class="string">A</span> <span class="string">single</span> <span class="string">application</span> <span class="string">container</span> <span class="string">that</span> <span class="string">you</span> <span class="string">want</span> <span class="string">to</span> <span class="string">run</span> <span class="string">within</span> <span class="string">a</span> <span class="string">pod.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">args</span>	<span class="string">&lt;[]string&gt;</span></span><br><span class="line">     <span class="string">Arguments</span> <span class="string">to</span> <span class="string">the</span> <span class="string">entrypoint.</span> <span class="string">The</span> <span class="string">docker</span> <span class="string">image&#x27;s</span> <span class="string">CMD</span> <span class="string">is</span> <span class="string">used</span> <span class="string">if</span> <span class="string">this</span> <span class="string">is</span> <span class="string">not</span></span><br><span class="line">     <span class="string">provided.</span> <span class="string">Variable</span> <span class="string">references</span> <span class="string">$(VAR_NAME)</span> <span class="string">are</span> <span class="string">expanded</span> <span class="string">using</span> <span class="string">the</span></span><br><span class="line">     <span class="string">container&#x27;s</span> <span class="string">environment.</span> <span class="string">If</span> <span class="string">a</span> <span class="string">variable</span> <span class="string">cannot</span> <span class="string">be</span> <span class="string">resolved,</span> <span class="string">the</span> <span class="string">reference</span> <span class="string">in</span></span><br><span class="line">     <span class="string">the</span> <span class="string">input</span> <span class="string">string</span> <span class="string">will</span> <span class="string">be</span> <span class="string">unchanged.</span> <span class="string">The</span> <span class="string">$(VAR_NAME)</span> <span class="string">syntax</span> <span class="string">can</span> <span class="string">be</span> <span class="string">escaped</span></span><br><span class="line">     <span class="string">with</span> <span class="string">a</span> <span class="string">double</span> <span class="string">$$,</span> <span class="attr">ie:</span> <span class="string">$$(VAR_NAME).</span> <span class="string">Escaped</span> <span class="string">references</span> <span class="string">will</span> <span class="string">never</span> <span class="string">be</span></span><br><span class="line">     <span class="string">expanded,</span> <span class="string">regardless</span> <span class="string">of</span> <span class="string">whether</span> <span class="string">the</span> <span class="string">variable</span> <span class="string">exists</span> <span class="string">or</span> <span class="string">not.</span> <span class="string">Cannot</span> <span class="string">be</span></span><br><span class="line">     <span class="attr">updated. More info:</span></span><br><span class="line">     <span class="string">https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/#running-a-command-in-a-shell</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master2</span> <span class="string">~</span>]<span class="comment"># kubectl explain pod.spec.containers.ports</span></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">Pod</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">RESOURCE:</span> <span class="string">ports</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DESCRIPTION:</span></span><br><span class="line">     <span class="string">List</span> <span class="string">of</span> <span class="string">ports</span> <span class="string">to</span> <span class="string">expose</span> <span class="string">from</span> <span class="string">the</span> <span class="string">container.</span> <span class="string">Exposing</span> <span class="string">a</span> <span class="string">port</span> <span class="string">here</span> <span class="string">gives</span> <span class="string">the</span></span><br><span class="line">     <span class="string">system</span> <span class="string">additional</span> <span class="string">information</span> <span class="string">about</span> <span class="string">the</span> <span class="string">network</span> <span class="string">connections</span> <span class="string">a</span> <span class="string">container</span></span><br><span class="line">     <span class="string">uses,</span> <span class="string">but</span> <span class="string">is</span> <span class="string">primarily</span> <span class="string">informational.</span> <span class="string">Not</span> <span class="string">specifying</span> <span class="string">a</span> <span class="string">port</span> <span class="string">here</span> <span class="string">DOES</span> <span class="string">NOT</span></span><br><span class="line">     <span class="string">prevent</span> <span class="string">that</span> <span class="string">port</span> <span class="string">from</span> <span class="string">being</span> <span class="string">exposed.</span> <span class="string">Any</span> <span class="string">port</span> <span class="string">which</span> <span class="string">is</span> <span class="string">listening</span> <span class="string">on</span> <span class="string">the</span></span><br><span class="line">     <span class="string">default</span> <span class="string">&quot;0.0.0.0&quot;</span> <span class="string">address</span> <span class="string">inside</span> <span class="string">a</span> <span class="string">container</span> <span class="string">will</span> <span class="string">be</span> <span class="string">accessible</span> <span class="string">from</span> <span class="string">the</span></span><br><span class="line">     <span class="string">network.</span> <span class="string">Cannot</span> <span class="string">be</span> <span class="string">updated.</span></span><br><span class="line"></span><br><span class="line">     <span class="string">ContainerPort</span> <span class="string">represents</span> <span class="string">a</span> <span class="string">network</span> <span class="string">port</span> <span class="string">in</span> <span class="string">a</span> <span class="string">single</span> <span class="string">container.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">containerPort</span>	<span class="string">&lt;integer&gt;</span> <span class="string">-required-</span></span><br><span class="line">     <span class="string">Number</span> <span class="string">of</span> <span class="string">port</span> <span class="string">to</span> <span class="string">expose</span> <span class="string">on</span> <span class="string">the</span> <span class="string">pod&#x27;s</span> <span class="string">IP</span> <span class="string">address.</span> <span class="string">This</span> <span class="string">must</span> <span class="string">be</span> <span class="string">a</span> <span class="string">valid</span> <span class="string">port</span></span><br><span class="line">     <span class="string">number,</span> <span class="number">0</span> <span class="string">&lt;</span> <span class="string">x</span> <span class="string">&lt;</span> <span class="number">65536</span><span class="string">.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim pod2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-cattt</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">activeDeadlineSeconds:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">containers:</span> <span class="comment"># 对象列表下面字段需要有 -  </span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat-doggg</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat:9.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>  <span class="comment"># always 总是从镜像仓库拉取镜像   ifnot 有就用，没有就拉</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># metadat下面对齐需要一样，spec下面的对齐需要一样，但是metadata和spec下面的字段对齐不需要一样</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f pod2.yaml </span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pod 常用命令</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl run mynginx --image=nginx --image-pull-policy=&#x27;IfNotPresent&#x27; --port=8080</span></span><br><span class="line"></span><br><span class="line">NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">default                mynginx                                      1/1     Running   0          84s</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment">#kubectl describe pod</span></span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  2m17s  default-scheduler  Successfully assigned default/mynginx to node2</span><br><span class="line">  Normal  Pulling    2m16s  kubelet            Pulling image <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  Normal  Pulled     71s    kubelet            Successfully pulled image <span class="string">&quot;nginx&quot;</span> <span class="keyword">in</span> 1m5.193735599s</span><br><span class="line">  Normal  Created    67s    kubelet            Created container mynginx</span><br><span class="line">  Normal  Started    67s    kubelet            Started container mynginx</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># docker ps | grep mynginx </span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pods -A</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -l app=tomcat</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod --show-labels</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl delete pod mynginx -n default</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yaml创建pod</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    run: mynginx</span><br><span class="line">  name: mynginx</span><br><span class="line"><span class="comment">#  namespace: default</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    name: mynginx</span><br><span class="line">    </span><br><span class="line">[root@master ~]<span class="comment"># kubectl apply -f pod.yml </span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl delete -f pod.yml </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl logs -f mynginx </span></span><br><span class="line">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br><span class="line">/docker-entrypoint.sh: Looking <span class="keyword">for</span> shell scripts <span class="keyword">in</span> /docker-entrypoint.d/</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 <span class="keyword">in</span> /etc/nginx/conf.d/default.conf</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh</span><br><span class="line">/docker-entrypoint.sh: Configuration complete; ready <span class="keyword">for</span> start up</span><br><span class="line">2023/04/10 07:09:42 [notice] 1<span class="comment">#1: using the &quot;epoll&quot; event method</span></span><br><span class="line">2023/04/10 07:09:42 [notice] 1<span class="comment">#1: nginx/1.21.5</span></span><br><span class="line">2023/04/10 07:09:42 [notice] 1<span class="comment">#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6) </span></span><br><span class="line">2023/04/10 07:09:42 [notice] 1<span class="comment">#1: OS: Linux 3.10.0-1160.el7.x86_64</span></span><br><span class="line">2023/04/10 07:09:42 [notice] 1<span class="comment">#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span></span><br><span class="line">2023/04/10 07:09:42 [notice] 1<span class="comment">#1: start worker processes</span></span><br><span class="line">2023/04/10 07:09:42 [notice] 1<span class="comment">#1: start worker process 31</span></span><br><span class="line">2023/04/10 07:09:42 [notice] 1<span class="comment">#1: start worker process 32</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个podk8s都会分配ip，保证k8s中所有应用都能访问到</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod -owide </span></span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE     IP              NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">mynginx   1/1     Running   0          3m55s   192.168.104.4   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="comment"># 使用IP + Port访问</span></span><br><span class="line">[root@master ~]<span class="comment"># curl 192.168.104.4 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl exec -it mynginx -- /bin/bash</span></span><br><span class="line"><span class="comment"># 进入pod指定的容器 -c</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it tomcat-cattt -c tomcat-doggg  -- /bin/bash</span></span><br><span class="line"></span><br><span class="line">集群中的任意一个机器，任意一个应用都能通过pod分配的ip访问pod</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pods -l app=tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定位pod错误，查看describe和logs</span></span><br><span class="line"></span><br><span class="line">NAME      READY   STATUS        RESTARTS   AGE    IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">busybox   1/1     Terminating   0          127m   10.244.166.130   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">10.244网段只能在集群内访问</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pod内部署多容器</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    run: myapp</span><br><span class="line">  name: myapp</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    name: nginx</span><br><span class="line">  - image: tomcat:8.5.68</span><br><span class="line">    name: tomcat</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 同一pod内共享网络空间和存储</span></span><br><span class="line">pod内只需要通过127.0.0.1即可访问</span><br><span class="line"></span><br><span class="line">pod内两个容器占用同一个端口会导致error</span><br></pre></td></tr></table></figure>
<h2 id="labels"><a class="markdownIt-Anchor" href="#labels">#</a> labels</h2>
<p>标签其实就一对 key/value ，被关联到对象上，比如 Pod, 标签的使用我们倾向于能够表示对象的特殊特点，就是一眼就看出了这个 Pod 是干什么的，标签可以用来划分特定的对象（比如版本，服务类型等），标签可以在创建一个对象的时候直接定义，也可以在后期随时修改，每一个对象可以拥有多个标签，但是，key 值必须是唯一的。创建标签之后也可以方便我们对资源进行分组管理。如果对 pod 打标签，之后就可以使用标签来查看、删除指定的 pod。<br>
在 k8s 中，大部分资源都可以打标签。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl label pods tomcat release=v1</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod --show-labels </span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">tomcat-cattt             1/1     Running   0          69m   app=tomcat</span><br><span class="line">   </span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl label pods tomcat-cattt hahaha=shabi</span></span><br><span class="line">pod/tomcat-cattt labeled</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod --show-labels -n default</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">tomcat-cattt             1/1     Running   0          70m   app=tomcat,hahaha=shabi</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod tomcat-cattt  --show-labels -n default </span></span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">tomcat-cattt   1/1     Running   0          72m   app=tomcat,hahaha=shabi</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -l hahaha   #-l指定标签的key</span></span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE</span><br><span class="line">tomcat-cattt   1/1     Running   0          72m</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -l hahaha --show-labels </span></span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">tomcat-cattt   1/1     Running   0          73m   app=tomcat,hahaha=shabi</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -L hahaha  # -L显示标签的key-value</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   HAHAHA</span><br><span class="line">tomcat-cattt             1/1     Running   0          73m   shabi</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -L hahaha,app</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   HAHAHA   APP</span><br><span class="line">tomcat-cattt             1/1     Running   0          74m   shabi    tomcat</span><br><span class="line">tomcat-test              1/1     Running   0          21h            tomcat</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pods --all-namespaces --show-labels </span></span><br><span class="line">NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">default                busybox                                      1/1     Running   0          46h   run=busybox</span><br><span class="line">default                nginx-7f466444dc-8pbkp                       1/1     Running   0          23h   k8s-app=nginx,pod-template-hash=7f466444dc</span><br><span class="line">default                nginx-7f466444dc-jbhpm                       1/1     Running   0          23h   k8s-app=nginx,pod-template-hash=7f466444dc</span><br><span class="line">default                tomcat-cattt                                 1/1     Running   0          75m   app=tomcat,hahaha=shabi</span><br><span class="line">default                tomcat-test                                  1/1     Running   0          21h   app=tomcat</span><br><span class="line">kube-system            calico-kube-controllers-57c7b58f66-b7pw7     1/1     Running   0          46h   k8s-app=calico-kube</span><br></pre></td></tr></table></figure>
<h2 id="node节点选择器"><a class="markdownIt-Anchor" href="#node节点选择器">#</a> node 节点选择器</h2>
<p>我们在创建 pod 资源的时候，pod 会根据 schduler 进行调度，那么默认会调度到随机的一个工作节点，如果我们想要 pod 调度到指定节点或者调度到一些具有相同特点的 node 节点，<br>
可以使用 pod 中的 nodeName 或者 nodeSelector 字段指定要调度到的 node 节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用nodename调度pod</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: demo-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">    <span class="built_in">env</span>: dev</span><br><span class="line">spec:</span><br><span class="line">  nodeName: master3   <span class="comment"># 指定运行pod的node</span></span><br><span class="line">  containers:</span><br><span class="line">  - name:  tomcat-pod-java</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    image: tomcat:9.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: busybox:latest</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>:    <span class="comment"># 容器中必须有前台进程才不会启动后立即退出</span></span><br><span class="line">    - <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">    - <span class="string">&quot;-c&quot;</span></span><br><span class="line">    - <span class="string">&quot;sleep 3600&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># kubectl get pod -owide </span></span><br><span class="line">default                demo-pod        2/2     Running   0          2m20s   10.244.136.2     master3   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用nodeselector调度pod</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: demo-pod-1</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">    <span class="built_in">env</span>: dev</span><br><span class="line">spec:</span><br><span class="line">  nodeSelector:</span><br><span class="line">    disk: ceph</span><br><span class="line">  containers:</span><br><span class="line">  - name:  tomcat-pod-java</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    image: tomcat:9.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pod -owide</span></span><br><span class="line">demo-pod-1                         0/1     Pending   0          17s     &lt;none&gt;          &lt;none&gt;              &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get nodes --show-labels </span></span><br><span class="line">NAME      STATUS   ROLES                  AGE   VERSION   LABELS</span><br><span class="line">master1   Ready    control-plane,master   47h   v1.20.6   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master1,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=</span><br><span class="line">master2   Ready    control-plane,master   47h   v1.20.6   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master2,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=</span><br><span class="line"></span><br><span class="line"><span class="comment"># apply -f 不能正常调度，因为所有的node都没有ceph的标签，pod状态为pending</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl label nodes master1 disk=ceph</span></span><br><span class="line">apply -f</span><br><span class="line">0/4 nodes are available: 1 node(s) didn<span class="string">&#x27;t match Pod&#x27;</span>s node affinity, 3 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class="string">&#x27;t tolerate.</span></span><br><span class="line"><span class="string">[root@master1 ~]# kubectl label nodes node1 disk=ceph</span></span><br><span class="line"><span class="string">[root@master1 ~]# kubectl apply -f </span></span><br><span class="line"><span class="string">demo-pod-1               1/1     Running   0       95s    10.244.166.139   node1     &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 删除节点标签</span></span><br><span class="line"><span class="string">[root@master1 ~]# kubectl label nodes master1 disk-</span></span><br><span class="line"><span class="string">node/master1 labeled</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 只有nodename可以强行调度到master，nodeselector不能强行调度到master即使label匹配</span></span><br><span class="line"><span class="string"># kubectl delete -f x.yaml --force --grace-period=0  强行删除pod</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同时使用nodename 和 nodeselector调度pod</span></span><br><span class="line">spec:</span><br><span class="line">  nodeName: node2</span><br><span class="line">  nodeSelector:</span><br><span class="line">    disk: ceph</span><br><span class="line"><span class="comment"># nodename 和 nodeselector都存在的时候</span></span><br><span class="line"><span class="comment"># 如果其中有一个不匹配</span></span><br><span class="line"><span class="comment"># 会Predicate NodeAffinity failed 亲和性调度失败，因为两个标签不完全匹配</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 但是两个都是匹配时可以正常运行，比如node2中有disk:ceph的标签</span></span><br><span class="line"><span class="comment"># 并且由于nodeName优先级更高，如果master节点同时满足，也能调度到master节点(kubectl  v1.23.1)</span></span><br><span class="line"></span><br><span class="line">总结:同一个yaml文件里定义pod资源，如果同时定义了nodeName和NodeSelector，那么条件必须都满足才可以，有一个不满足都会调度失败</span><br></pre></td></tr></table></figure>
<h2 id="节点亲和性-反亲和性"><a class="markdownIt-Anchor" href="#节点亲和性-反亲和性">#</a> 节点亲和性、反亲和性</h2>
<p><strong>node 节点亲和性调度：nodeAffinity</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl explain pods.spec.affinity</span></span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">RESOURCE: affinity &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     If specified, the pod<span class="string">&#x27;s scheduling constraints</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     Affinity is a group of affinity scheduling rules.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FIELDS:</span></span><br><span class="line"><span class="string">   nodeAffinity	&lt;Object&gt;</span></span><br><span class="line"><span class="string">     Describes node affinity scheduling rules for the pod.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   podAffinity	&lt;Object&gt;</span></span><br><span class="line"><span class="string">     Describes pod affinity scheduling rules (e.g. co-locate this pod in the</span></span><br><span class="line"><span class="string">     same node, zone, etc. as some other pod(s)).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   podAntiAffinity	&lt;Object&gt;</span></span><br><span class="line"><span class="string">     Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod</span></span><br><span class="line"><span class="string">     in the same node, zone, etc. as some other pod(s)).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># node亲和性</span></span><br><span class="line"><span class="string">[root@prometheus-master ~]# kubectl explain pods.spec.affinity.nodeAffinity</span></span><br><span class="line"><span class="string">KIND:     Pod</span></span><br><span class="line"><span class="string">VERSION:  v1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FIELDS:</span></span><br><span class="line"><span class="string">   preferredDuringSchedulingIgnoredDuringExecution	&lt;[]Object&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   requiredDuringSchedulingIgnoredDuringExecution	&lt;Object&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">prefered表示有节点尽量满足这个位置定义的亲和性，这不是一个必须的条件，软亲和性</span></span><br><span class="line"><span class="string">require表示必须有节点满足这个位置定义的亲和性，这是个硬性条件，硬亲和性</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">可以使用operator字段来为Kubernetes设置在解释规则时要使用的逻辑操作符。你可以使用In、NotIn, Exists , DoesNotExist,Gt和Lt之一作为操作符。</span></span><br><span class="line"><span class="string">NotIn和 DoesNotExist可用来实现节点反亲和性行为。你也可以使用节点污点将Pod从特定节点上驱逐。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 硬亲和性</span></span><br><span class="line"><span class="string">vim pod6.yaml</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod-affinity</span></span><br><span class="line"><span class="string">  namespace: default</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: myapp</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: pod-affinity</span></span><br><span class="line"><span class="string">    image: tomcat-8.5-jre8</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  affinity:</span></span><br><span class="line"><span class="string">    nodeAffinity:</span></span><br><span class="line"><span class="string">      requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="string">        nodeSelectorTerms:</span></span><br><span class="line"><span class="string">        - matchExpressions:</span></span><br><span class="line"><span class="string">          - key: zone    # label key</span></span><br><span class="line"><span class="string">            operator: In   # condition</span></span><br><span class="line"><span class="string">            values:   # label value</span></span><br><span class="line"><span class="string">            - foo</span></span><br><span class="line"><span class="string">            - bar</span></span><br><span class="line"><span class="string">     </span></span><br><span class="line"><span class="string">由于初始没有node有zone这个label，所以会pending，一定有某个node被label对应的标签，pod会被立刻创建</span></span><br><span class="line"><span class="string">pod-affinity                       0/1     Pending   0             78s     &lt;none&gt;          prometheus-node2   </span></span><br><span class="line"><span class="string">pod-affinity                       0/1     ContainerCreating   0             78s     &lt;none&gt;          prometheus-node2   </span></span><br><span class="line"><span class="string">pod-affinity                       0/1     ContainerCreating   0             79s     &lt;none&gt;          prometheus-node2   </span></span><br><span class="line"><span class="string">pod-affinity                       1/1     Running             0             80s     10.244.64.44    prometheus-node2    </span></span><br><span class="line"><span class="string">由于是硬亲和性，因此如果没有node有对应的label就不调度</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@master1 ~]# kubectl apply -f pod6.yaml </span></span><br><span class="line"><span class="string">0/4 nodes are available: 1 node(s) didn&#x27;</span>t match Pod<span class="string">&#x27;s node affinity, 3 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn&#x27;</span>t tolerate.</span><br><span class="line"><span class="comment"># 必须在工作node上调度，他无法容忍master的污点。因此即使master有对应的label，pod也不会被调度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 软亲和性</span></span><br><span class="line">vim pod7.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-node-affinity-demo-2</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">    tier: frontend</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: tomcat-8.5-jre8 </span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  affinity:</span><br><span class="line">    nodeAffinity:</span><br><span class="line">      preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">      - preference:</span><br><span class="line">          matchExpressions: </span><br><span class="line">          - key: zone1</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - foo1</span><br><span class="line">            - bar1</span><br><span class="line">        weight: 10</span><br><span class="line">      - preference:</span><br><span class="line">          matchExpressions:</span><br><span class="line">          - key: zone2</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - foo2</span><br><span class="line">            - bar2</span><br><span class="line">        weight: 20</span><br><span class="line"> <span class="comment"># 软亲和性，如果没有node匹配label也会调度</span></span><br><span class="line"> <span class="comment"># prefer是软亲和性，可以设置weight，由多个preference时，会往weight高的node调度</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod </span></span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-node-affinity-demo-2   1/1     Running   0          5s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl label nodes master1 zone1=foo1</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl label nodes master2 zone2=foo2</span></span><br><span class="line"><span class="comment"># 这里prefer也无法忍受master的污点，所以即使有标签的weight他也不会往master上调度，但是如果多个node都有label，他会往weight高的label调度</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 去除标签</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl label nodes master2 zone2-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl delete -f pod7.yaml --force --grace-period=0</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl delete pods pod-affinity --force --grace-period=0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>pod 节点亲和性</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pod自身的亲和性调度有两种表示形式：</span></span><br><span class="line"><span class="string">podaffinity：pod和pod更倾向在一起，把相近的pod结合到相近的位置，如同一区域，同一机架，这样的话pod和pod之间更好通信，比方说有两个机房，这两个机房部署的集群有1000台主机，那么我们希望把nginx和tomcat都部署同一个地方的node节点上，可以提高通信效率；</span></span><br><span class="line"></span><br><span class="line"><span class="string">podunaffinity：pod和pod更倾向不j在一起，如果部署两套程序，那么这两套程序更倾向于反亲和性，这样相互之间不会有影响。</span></span><br><span class="line"></span><br><span class="line"><span class="string">prefer：软亲和性</span></span><br><span class="line"><span class="string">required：硬亲和性</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">topologyKey：判断pod是否在同一位置</span></span><br><span class="line"><span class="string">位置拓扑的键，这个是必须字段</span></span><br><span class="line"><span class="string">怎么判断是不是同一个位置：</span></span><br><span class="line"><span class="string">rack=rack1</span></span><br><span class="line"><span class="string">row=row1</span></span><br><span class="line"><span class="string">使用rack的键是同一个位置</span></span><br><span class="line"><span class="string">使用row的键是同一个位置</span></span><br><span class="line"></span><br><span class="line"><span class="string">labelSelector：</span></span><br><span class="line"><span class="string">我们要判断pod跟别的pod亲和，跟哪个pod亲和，需要靠labelSelector，通过labelSelector选则一组能作为亲和对象的pod资源</span></span><br><span class="line"><span class="string">namespace：</span></span><br><span class="line"><span class="string">labelSelector需要选则一组资源，那么这组资源是在哪个名称空间中呢，通过namespace指定，如果不指定namespaces，那么就是当前创建pod的名称空间</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">pod8.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-first</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app2:</span> <span class="string">myapp2</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">image:</span>  <span class="string">tomcat-8.5-jre8</span> </span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">pod9.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-second</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">affinity:</span></span><br><span class="line">      <span class="attr">podAffinity:</span></span><br><span class="line">         <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">labelSelector:</span>   <span class="comment"># 根具有那个标签的pod调度</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app2</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">&quot;myapp2&quot;</span>]&#125;</span><br><span class="line">           <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span>     <span class="comment"># kubernetes.io/hostname相同的pod是一个位置</span></span><br><span class="line"></span><br><span class="line"><span class="string">pod-first</span>                <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">19m</span>    <span class="number">10.244</span><span class="number">.166</span><span class="number">.145</span>   <span class="string">node1</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-second</span>               <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">101s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.146</span>   <span class="string">node1</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">先判断标签是否一样，来决定pod是否调度到一起，在根据topologyKey决定调度到那个node</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果硬亲和label不满足，会pending状态</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-second</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">affinity:</span></span><br><span class="line">      <span class="attr">podAffinity:</span></span><br><span class="line">        <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">podAffinityTerm:</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app1</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">&quot;myapp1&quot;</span>]&#125;</span><br><span class="line"><span class="comment"># 此时pod-second不满足软亲和性，依然可以调度，但是不会和pod-first调度到一起</span></span><br></pre></td></tr></table></figure>
<p><strong>pod 反亲和性</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">pod10.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-first</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app1:</span> <span class="string">myapp1</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">tomcat-8.5-jre8</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pod -owide  -l app1=myapp1</span></span><br><span class="line"><span class="string">NAME</span>        <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">pod-first</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">28s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.147</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">pod11.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-second</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">affinity:</span></span><br><span class="line">      <span class="attr">podAntiAffinity:</span></span><br><span class="line">         <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app1</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">&quot;myapp1&quot;</span>]&#125;</span><br><span class="line">           <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只有一个work node的情况下：</span></span><br><span class="line"><span class="string">pod-first</span>                <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m26s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.147</span>   <span class="string">node1</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-second</span>               <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">25s</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span>    <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="comment"># 说明pod反亲和性也不能容忍master的污点，因为此时只有一个node，于是他pending了</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果存在多个工作节点，second会去找topologyKey的value值不同的节点</span></span><br><span class="line"><span class="string">pod-first</span>                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>             <span class="string">52s</span>     <span class="number">10.244</span><span class="number">.216</span><span class="number">.124</span>   <span class="string">prometheus-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-second</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>             <span class="string">10s</span>     <span class="number">10.244</span><span class="number">.64</span><span class="number">.48</span>     <span class="string">prometheus-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更换topologyKey</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">node</span> <span class="string">node1</span> <span class="string">zone=foo</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">node</span> <span class="string">node2</span> <span class="string">zone=foo</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">po12.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-first</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app3:</span> <span class="string">myapp3</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">tomcat-8.5-jre8</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">pod13.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-second</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">affinity:</span></span><br><span class="line">      <span class="attr">podAntiAffinity:</span></span><br><span class="line">         <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app3</span> ,<span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">&quot;myapp3&quot;</span>]&#125;</span><br><span class="line">           <span class="attr">topologyKey:</span>  <span class="string">zone</span></span><br><span class="line">           </span><br><span class="line"><span class="string">pod-first</span>                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>             <span class="string">62s</span>     <span class="number">10.244</span><span class="number">.216</span><span class="number">.125</span>   <span class="string">prometheus-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-second</span>                         <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>             <span class="string">5s</span>      <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span>             <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line">           </span><br><span class="line"><span class="comment"># topologyKey 相同时pod会认为这是同一个位置。因此pod-first在node1或node2上时，pod-second不会再这两个节点调度，他又无法忍受master污点，所以他pending了</span></span><br><span class="line"><span class="comment"># 如果在反亲和性这个位置把required改成preferred，那么也会运行。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-second</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">affinity:</span></span><br><span class="line">      <span class="attr">podAntiAffinity:</span></span><br><span class="line">        <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">podAffinityTerm:</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">zone</span></span><br><span class="line">            <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app3</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">&quot;myapp3&quot;</span>]&#125;</span><br><span class="line"><span class="string">pod-first</span>                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>             <span class="string">6m43s</span>   <span class="number">10.244</span><span class="number">.216</span><span class="number">.125</span>   <span class="string">prometheus-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-second</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>             <span class="string">21s</span>     <span class="number">10.244</span><span class="number">.216</span><span class="number">.126</span>   <span class="string">prometheus-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>podaffinity：pod 节点亲和性，pod 倾向于哪个 pod</strong><br>
<strong>podantiaffinity:pod 反亲和性</strong><br>
<strong> nodeaffinity：node 节点亲和性，pod 倾向于哪个 node</strong></p>
<h2 id="污点容忍度"><a class="markdownIt-Anchor" href="#污点容忍度">#</a> 污点，容忍度</h2>
<p>给了节点选则的主动权，我们给节点打一个污点，不容忍的 pod 就运行不上来，污点就是定义在节点上的键值属性数据，可以定决定拒绝那些 pod；<br>
taints 是键值数据，用在节点上，定义污点；</p>
<p>tolerations 是键值数据，用在 pod 上，定义容忍度，能容忍哪些污点</p>
<p>pod 亲和性是 pod 属性；但是污点是 node 的属性，污点定义在 k8s 集群的节点上的一个字段</p>
<p>master 上会有污点<br>
 <code>Taints:             node-role.kubernetes.io/master:NoSchedule</code></p>
<p>taints 的 effect 用来定义对 pod 对象的排斥等级（效果）：</p>
<blockquote>
<p><code>NoSchedule：</code> <br>
仅影响 pod 调度过程，当 pod 能容忍这个节点污点，就可以调度到当前节点，后来这个节点的污点改了，加了一个新的污点，使得之前调度的 pod 不能容忍了，那这个 pod 会怎么处理，对现存的 pod 对象不产生影响</p>
<p><code>NoExecute：</code> <br>
既影响调度过程，又影响现存的 pod 对象，如果现存的 pod 不能容忍节点后来加的污点，这个 pod 就会被驱逐</p>
<p><code>PreferNoSchedule：</code> <br>
最好不，也可以，是 NoSchedule 的柔性版本</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl get pod -n kube-system -owide | grep master1</span></span><br><span class="line">calico-node-mptp2                          1/1     Running   1          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-7f89b7bc75-gtmmh                   1/1     Running   1          5d4h   10.244.137.67    master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-7f89b7bc75-hc7ns                   1/1     Running   1          5d4h   10.244.137.68    master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">etcd-master1                               1/1     Running   3          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-master1                     1/1     Running   5          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-controller-manager-master1            1/1     Running   2          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-t9td4                           1/1     Running   1          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-scheduler-master1                     1/1     Running   2          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于定义了Tolerations，上面这些pod能容忍master的污点</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl describe pods -n kube-system kube-apiserver-master1 </span></span><br><span class="line">Tolerations:       :NoExecute op=Exists</span><br><span class="line"></span><br><span class="line"><span class="comment"># exist NoExecute的trait等级要比NoSchedule高，能容忍NoExecute一定能容忍NoSchedule和PreferNoSchedule</span></span><br><span class="line"><span class="comment"># op=exist 情况下 排斥等级可以理解为 NoExecute &gt; NoSchedule &gt; PreferNoSchedule</span></span><br><span class="line"><span class="comment"># equal是严格比配，不能有exist跨级匹配</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl taint node node1 node-type=prod:NoSchedule</span></span><br><span class="line">node/node1 tainted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim pod14.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: taint-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    tomcat:  tomcat-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name:  taint-pod</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    image: tomcat-8.5-jre8</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    </span><br><span class="line">taint-pod                          1/1     Running   0             3s      10.244.216.127   prometheus-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">重新创建pod，pod无法忍受node1的污点</span><br><span class="line">taint-pod                          1/1     Running   0             4s      10.244.64.49   prometheus-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NoExecute污点，没有定义容忍度的pod会被驱逐</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl taint node node1 node-type=dev:NoExecute</span></span><br><span class="line">default                nginx-7f466444dc-klcl9                       1/1     Terminating   0          4m32s   10.244.166.152   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">vim pod15.yaml</span><br><span class="line"><span class="comment"># 定义容忍度为NoExecute</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">    release: canary</span><br><span class="line">spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp</span><br><span class="line">        image: tomcat-8.5-jre8</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: <span class="string">&quot;node-type&quot;</span></span><br><span class="line">        operator: <span class="string">&quot;Equal&quot;</span></span><br><span class="line">        value: <span class="string">&quot;dev&quot;</span></span><br><span class="line">        effect: <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line">        tolerationSeconds: 3600</span><br><span class="line"><span class="comment"># 此时等值匹配情况下，只有能忍受node-type=dev:NoExecute 的node可以被调度</span></span><br><span class="line">myapp-deploy             1/1     Running   0          2m27s   10.244.166.154   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对于equals等值匹配，能容忍noexecute也不能容忍noschedule，因为是严格等值匹配</span></span><br><span class="line"><span class="comment"># 保持pod容忍不变，改变node污点为noschedule</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl taint node node1 node-type=dev:NoSchedule</span></span><br><span class="line">myapp-deploy             0/1     Pending   0          3s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义容忍度为NoSchedule</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">    release: canary</span><br><span class="line">spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp</span><br><span class="line">        image: tomcat-8.5-jre8</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: <span class="string">&quot;node-type&quot;</span></span><br><span class="line">        operator: <span class="string">&quot;Equal&quot;</span></span><br><span class="line">        value: <span class="string">&quot;dev&quot;</span></span><br><span class="line">        effect: <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">myapp-deploy             1/1     Running   0          28s    10.244.166.157   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对于noschedule，不需要定义容忍时间(tolerationSeconds)，因为不会驱逐原有pod</span></span><br><span class="line"><span class="comment"># noexecute如果有新的污点pod不能忍受，经过tolerationSeconds  pod会被驱逐</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为exists特性：</span></span><br><span class="line">      tolerations:</span><br><span class="line">      - key: <span class="string">&quot;node-type&quot;</span></span><br><span class="line">        operator: <span class="string">&quot;Exists&quot;</span></span><br><span class="line">        value: <span class="string">&quot;&quot;</span></span><br><span class="line">        effect: <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line"><span class="comment"># 可以不写value，只要key和effect匹配就行</span></span><br><span class="line"></span><br><span class="line">      tolerations:</span><br><span class="line">      - key: <span class="string">&quot;node-type&quot;</span></span><br><span class="line">        operator: <span class="string">&quot;Exists&quot;</span></span><br><span class="line">        value: <span class="string">&quot;&quot;</span></span><br><span class="line">        effect: <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 可以容忍key匹配的一切污点</span></span><br><span class="line">myapp-deploy             1/1     Running   0          6s     10.244.166.158   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">当某种条件为真时，节点控制器会自动给节点添加一个污点。当前内置的污点包括：</span><br><span class="line"></span><br><span class="line">node.kubernetes.io/not-ready：节点未准备好。这相当于节点状况 Ready 的值为 &quot;False&quot;。</span><br><span class="line">node.kubernetes.io/unreachable：节点控制器访问不到节点. 这相当于节点状况 Ready 的值为 &quot;Unknown&quot;。</span><br><span class="line">node.kubernetes.io/memory-pressure：节点存在内存压力。</span><br><span class="line">node.kubernetes.io/disk-pressure：节点存在磁盘压力。</span><br><span class="line">node.kubernetes.io/pid-pressure: 节点的 PID 压力。</span><br><span class="line">node.kubernetes.io/network-unavailable：节点网络不可用。</span><br><span class="line">node.kubernetes.io/unschedulable: 节点不可调度。</span><br><span class="line">node.cloudprovider.kubernetes.io/uninitialized：如果 kubelet 启动时指定了一个“外部”云平台驱动， 它将给当前节点添加一个污点将其标志为不可用。在 cloud-controller-manager 的一个控制器初始化这个节点后，kubelet 将删除这个污点。</span><br><span class="line">在节点被驱逐时，节点控制器或者 kubelet 会添加带有 NoExecute 效果的相关污点。 如果异常状态恢复正常，kubelet 或节点控制器能够移除相关的污点。</span><br><span class="line"></span><br><span class="line">在某些情况下，当节点不可达时，API 服务器无法与节点上的 kubelet 进行通信。 在与 API 服务器的通信被重新建立之前，删除 Pod 的决定无法传递到 kubelet。 同时，被调度进行删除的那些 Pod 可能会继续运行在分区后的节点上。</span><br><span class="line"></span><br><span class="line">这些值都可以修改，比如在内存剩余不足指定数量后会自动打上node.kubernetes.io/disk-pressure的污点，且不能手工删除，除非空出指定大小的内存之后</span><br></pre></td></tr></table></figure>
<h2 id="pod常见状态和重启策略"><a class="markdownIt-Anchor" href="#pod常见状态和重启策略">#</a> pod 常见状态和重启策略</h2>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230430215552262.png" alt="image-20230430215552262"></p>
<blockquote>
<p>第一阶段：<br>
挂起（ <code>Pending</code> ）：<br>
1、正在创建 Pod 但是 Pod 中的容器还没有全部被创建完成，处于此状态的 Pod 应该检查 Pod 依赖的存储是否有权限挂载、镜像是否可以下载、调度是否正常等</p>
<p>2、我们在请求创建 pod 时，条件不满足，调度没有完成，没有任何一个节点能满足调度条件，已经创建了 pod 但是没有适合它运行的节点叫做挂起，调度没有完成。</p>
<p>失败（ <code>Failed</code> ）：Pod 中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非 0 状态退出或者被系统终止。</p>
<p>未知（ <code>Unknown</code> ）：未知状态，所谓 pod 是什么状态是 apiserver 和运行在 pod 节点的 kubelet 进行通信获取状态信息的，如果节点之上的 kubelet 本身出故障，那么 apiserver 就连不上 kubelet，得不到信息了，就会看 Unknown，通常是由于与 pod 所在的 node 节点通信错误。</p>
<p><code>Error</code>  状态：Pod 启动过程中发生了错误</p>
<p>成功（ <code>Succeeded</code> ）：Pod 中的所有容器都被成功终止，即 pod 里所有的 containers 均已 terminated。</p>
<p>第二阶段：<br>
 <code>Unschedulable</code> ：Pod 不能被调度， scheduler 没有匹配到合适的 node 节点</p>
<p><code>PodScheduled</code> ：pod 正处于调度中，在 scheduler 刚开始调度的时候，还没有将 pod 分配到指定的 node，在筛选出合适的节点后就会更新 etcd 数据，将 pod 分配到指定的 node</p>
<p><code>Initialized</code> ：所有 pod 中的初始化容器已经完成了</p>
<p><code>ImagePullBackOff</code> ：Pod 所在的 node 节点下载镜像失败</p>
<p><code>Running</code> ：Pod 内部的容器已经被创建并且启动。</p>
<p><code>Ready</code></p>
<p>扩展：还有其他状态，如下：</p>
<p><code>Evicted</code>  状态：出现这种情况，多见于系统内存或硬盘资源不足，可 df-h 查看 docker 存储所在目录的资源使用情况，如果百分比大于 85%，就要及时清理下资源，尤其是一些大文件、docker 镜像。</p>
<p>CrashLoopBackOff：容器曾经启动了，但可能又异常退出了</p>
<p>查看内存，CPU，磁盘：</p>
<p>free -mh</p>
<p>top</p>
<p>df -hl</p>
<p>kubectl describe pod_name</p>
<p>kubectl logs pod_name</p>
</blockquote>
<p><strong>Pod 重启策略</strong></p>
<blockquote>
<p>Pod 的重启策略（RestartPolicy）应用于 Pod 内的所有容器，当某个容器异常退出或者健康检查失败时，kubelet 将根据 重启策略来进行相应的操作。</p>
<p>Pod 的 spec 中包含一个 restartPolicy 字段，其可能取值包括 Always、OnFailure 和 Never。默认值是 Always。</p>
<p>Always：只要容器异常退出，kubelet 就会自动重启该容器。（这个是默认的重启策略）</p>
<p>OnFailure：当容器终止运行且退出码不为 0 时，由 kubelet 自动重启该容器。</p>
<p>Never：不论容器运行状态如何，kubelet 都不会重启该容器。</p>
<p>(重启的不是 pod，是 pod 中的容器)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">name: demo-pod</span><br><span class="line">namespace: default</span><br><span class="line">labels:</span><br><span class="line"> app: myapp</span><br><span class="line">spec:</span><br><span class="line">restartPolicy: Always</span><br><span class="line">containers:</span><br><span class="line">  - name:  tomcat-pod-java</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    image: tomcat-8.5-jre8</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it demo-pod -- /bin/bash</span><br><span class="line">/usr/local/tomcat/bin/shutdown.sh</span><br><span class="line"># always - complete - 重启</span><br><span class="line"># onFailure - complete - 不会重启</span><br><span class="line"># never - complete状态，不会重启</span><br><span class="line"></span><br><span class="line">kill 1</span><br><span class="line"># always error - 立刻重启</span><br><span class="line"># onFailure - error - 重启</span><br><span class="line"># never - error - 不重启</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="pod生命周期"><a class="markdownIt-Anchor" href="#pod生命周期">#</a> pod 生命周期</h2>
<p>pod 从开始创建到终止退出的时间范围称为 Pod 生命周期</p>
<p>生命周期包含以下几个重要流程：<br>
创建主容器（containers）是必须的操作，初始化容器（initContainers），容器启动后钩子，启动探测、存活性探测，就绪性探测，容器停止前钩子。</p>
<p>其中 initcontainers、容器启动后钩子、探测、容器终止前钩子这些是可选项 -</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230430224431424.png" alt="image-20230430224431424"></p>
<p><strong>pod 在整个生命周期的过程中总会处于以下几个状态：</strong></p>
<blockquote>
<p>Pending：创建了 pod 资源并存入 etcd 中，但尚未完成调度。</p>
<p>ContainerCreating：Pod 的调度完成，被分配到指定 Node 上。处于容器创建的过程中。通常是在拉取镜像的过程中。</p>
<p>Running：Pod 包含的所有容器都已经成功创建，并且成功运行起来。</p>
<p>Succeeded：Pod 中的所有容器都已经成功终止并且不会被重启（重启策略是 never）</p>
<p>Failed：所有容器都已经终止，但至少有一个容器终止失败，也就是说容器返回了非 0 值的退出状态或已经被系统终止。</p>
<p>Unknown：因为某些原因无法取得 Pod 的状态。这种情况通常是因为与 Pod 所在主机通信失败。</p>
</blockquote>
<p><strong>pod 生命周期的重要行为：</strong></p>
<blockquote>
<p>1、在启动任何容器之前，先创建 pause 基础容器，它初始化 Pod 的环境并为后续加⼊的容器提供共享的名称空间。</p>
<p>2. 初始化容器（initcontainer）：</p>
<p>一个 pod 可以拥有任意数量的 init 容器。init 容器是按照顺序以此执行的，并且仅当最后一个 init 容器执行完毕才会去启动主容器。</p>
<p>3. 生命周期钩子：</p>
<p>pod 允许定义两种类型的生命周期钩子，启动后 (post-start) 钩子和停止前 (pre-stop) 钩子</p>
<p>这些生命周期钩子是基于每个容器来指定的，和 init 容器不同的是，init 容器是应用到整个 pod。而这些钩子是针对容器的，是在容器启动后和停止前执行的。比如启动时复制文件到容器中，结束后发送信息到监控</p>
<p>4. 容器探测：</p>
<p>对 Pod 健康状态诊断。分为三种： Startupprobe、Livenessprobe (存活性探测)， Readinessprobe (就绪性检测)</p>
<p>Startup（启动探测）: 探测容器是否正常运行</p>
<p>Liveness (存活性探测)：判断容器是否处于 runnning 状态，根据重启策略决定是否重启容器</p>
<p>Readiness (就绪性检测)：判断容器是否准备就绪并对外提供服务，将容器设置为不可用，不接受 service 转发的请求</p>
</blockquote>
<p><strong>三种探针用于 Pod 检测：</strong></p>
<blockquote>
<p>ExecAction：在容器中执行一个命令，并根据返回的状态码进行诊断，只有返回 0 为成功</p>
<p>TCPSocketAction：通过与容器的某 TCP 端口尝试建立连接</p>
<p>HTTPGetAction：通过向容器 IP 地址的某指定端口的 path 发起 HTTP GET 请求。</p>
</blockquote>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230430230843299.png" alt="image-20230430230843299"></p>
<p>6.pod 的终止过程</p>
<blockquote>
<p>终止过程主要分为如下几个步骤：</p>
<p>(1) 用户发出删除 pod 命令：kubectl delete pods ，kubectl delete -f yaml</p>
<p>(2) Pod 对象随着时间的推移更新，在宽限期（默认情况下 30 秒），pod 被视为 “dead” 状态</p>
<p>(3) 将 pod 标记为 “Terminating” 状态</p>
<p>(4) 第三步同时运行，监控到 pod 对象为 “Terminating” 状态的同时启动 pod 关闭过程</p>
<p>(5) 第三步同时进行，endpoints 控制器监控到 pod 对象关闭，将 pod 与 service 匹配的 endpoints 列表中删除</p>
<p>(6) 如果 pod 中定义了 preStop 钩子处理程序，则 pod 被标记为 “Terminating” 状态时以同步的方式启动执行；若宽限期结束后，preStop 仍未执行结束，第二步会重新执行并额外获得一个 2 秒的小宽限期</p>
<p>(7) Pod 内对象的容器收到 TERM 信号</p>
<p>(8) 宽限期结束之后，若存在任何一个运行的进程，pod 会收到 SIGKILL 信号</p>
<p>(9) Kubelet 请求 API Server 将此 Pod 资源宽限期设置为 0 从而完成删除操作</p>
</blockquote>
<h3 id="initcontainer"><a class="markdownIt-Anchor" href="#initcontainer">#</a> initcontainer</h3>
<p>spec 字段下有个 initContainers 字段 (初始化容器)，Init 容器就是做初始化工作的容器。可以有一个或多个，如果多个按照定义的顺序依次执行，先执行初始化容器 1，再执行初始化容器 2 等，等初始化容器执行完具体操作之后初始化容器就退出了，只有所有的初始化容器执行完后，主容器才启动。</p>
<p>由于一个 Pod 里容器存储卷是共享的，所以 Init Container 里产生的数据可以被主容器使用到，Init Container 可以在多种 K8S 资源里被使用到，如 Deployment、DaemonSet, StatefulSet、Job 等，但都是在 Pod 启动时，在主容器启动前执行，做初始化工作。</p>
<p>初始化容器与主容器区别是:<br>
1、初始化容器不支持 Readinessprobe, 因为它们必须在 Pod 就绪之前运行完成<br>
 2、每个 Init 容器必须运行成功，下一个才能够运行</p>
<p>初始化容器的官方地址：<br>
<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL3BvZHMvaW5pdC1jb250YWluZXJzLyNpbml0LWNvbnRhaW5lcnMtaW4tdXNl">https://kubernetes.io/docs/concepts/workloads/pods/init-containers/#init-containers-in-use</span></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-pod</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">spec:</span><br><span class="line">  initContainers:</span><br><span class="line">  - name: init-myservice</span><br><span class="line">    image: busybox:1.28</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&quot;until nslookup myservice.<span class="subst">$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>.svc.cluster.local; do echo waiting for myservice; sleep 2; done&quot;</span>]</span><br><span class="line">  - name: init-mydb</span><br><span class="line">    image: busybox:1.28</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&quot;until nslookup mydb.<span class="subst">$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>.svc.cluster.local; do echo waiting for mydb; sleep 2; done&quot;</span>]</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp-container</span><br><span class="line">    image: busybox:1.28</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo The app is running! &amp;&amp; sleep 3600&#x27;</span>]</span><br><span class="line"></span><br><span class="line">myapp-pod                0/1     Init:0/2   0          4s</span><br><span class="line">由于两个初始化容器一直无法解析nslookup的域名，导致主容器一致不会创建</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化容器拉取百度页面，主容器使用</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: initnginx</span><br><span class="line">spec:</span><br><span class="line">  initContainers:</span><br><span class="line">  - name: install</span><br><span class="line">    image: docker.io/library/busybox:1.28</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - wget</span><br><span class="line">    - <span class="string">&quot;-O&quot;</span></span><br><span class="line">    - <span class="string">&quot;/work-dir/index.html&quot;</span></span><br><span class="line">    - <span class="string">&quot;https://www.baidu.com&quot;</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: workdir</span><br><span class="line">      mountPath: /work-dir</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: workdir</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  dnsPolicy: Default</span><br><span class="line">  volumes:</span><br><span class="line">  - name: workdir</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># curl 10.244.166.161</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;!--STATUS OK--&gt;&lt;html&gt; &lt;<span class="built_in">head</span>&gt;&lt;meta http-equiv=content-type content=text/html;charset=utf-8&gt;&lt;meta http-equiv=X-UA-Compatible content=IE=Edge&gt;&lt;meta content=always name=referrer&gt;&lt;<span class="built_in">link</span> rel=stylesheet <span class="built_in">type</span>=text/css href=https://ss1.bdstatic.com/5eN1bjq8AAUYm2zgoY3K/r/www/cache/bdorz/baidu.min.css&gt;&lt;title&gt;百度一下，你就知道&lt;/title&gt;</span><br></pre></td></tr></table></figure>
<h3 id="主容器"><a class="markdownIt-Anchor" href="#主容器">#</a> 主容器</h3>
<p>1、容器钩子</p>
<p>初始化容器启动之后，开始启动主容器，在主容器启动之后有一个 post start hook（容器启动后钩子）和 pre stop hook（容器结束前钩子），无论启动后还是结束前所做的事我们可以把它放两个钩子，这个钩子就表示用户可以用它来钩住一些命令，非必须选项</p>
<p>postStart：该钩子在容器被创建后立刻执行，如果该钩子对应的探测执行失败，则该容器会被杀死，并根据该容器的重启策略决定是否要重启该容器，这个钩子不需要传递任何参数。</p>
<p>preStop：该钩子在容器被删除前执行，主要用于释放资源和优雅关闭程序</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">image:</span> <span class="string">sample:v2</span>  </span><br><span class="line">     <span class="attr">name:</span> <span class="string">war</span></span><br><span class="line">     <span class="string">lifecycle：</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">       <span class="attr">exec:</span></span><br><span class="line">         <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;cp&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;/sample.war&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;/app&quot;</span></span><br><span class="line">      <span class="attr">prestop:</span></span><br><span class="line">       <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">monitor.com</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/waring</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br></pre></td></tr></table></figure>
<p>以上示例中，定义了一个 Pod，包含一个 JAVA 的 web 应用容器，其中设置了 PostStart 和 PreStop 回调函数。即在容器创建成功后，复制 /sample.war 到 /app 文件夹中。而在容器终止之前，发送 HTTP 请求到 http://monitor.com:8080/waring，即向监控系统发送警告。</p>
<p>优雅的删除资源对象</p>
<p>当用户请求删除含有 pod 的资源对象时（如 RC、deployment 等），K8S 为了让应用程序优雅关闭（即让应用程序完成正在处理的请求后，再关闭软件），K8S 提供两种信息通知：</p>
<p>1）、默认：K8S 通知 node 执行 docker stop 命令，docker 会先向容器中 PID 为 1 的进程发送系统信号 SIGTERM，然后等待容器中的应用程序终止执行，如果等待时间达到设定的超时时间，或者默认超时时间（30s），会继续发送 SIGKILL 的系统信号强行 kill 掉进程。</p>
<p>2）、使用 pod 生命周期（利用 PreStop 回调函数），它执行在发送终止信号之前。<br>
默认情况下，所有的删除操作的优雅退出时间都在 30 秒以内。kubectl delete 命令支持–grace-period = 的选项，以运行用户来修改默认值。0 表示删除立即执行，并且立即从 API 中删除 pod。在节点上，被设置了立即结束的的 pod，仍然会给一个很短的优雅退出时间段，才会开始被强制杀死。如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-demo</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">centos:nginx</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="comment"># nginx -s quit gracefully terminate while SIGTERM triggers a quick exit</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/usr/local/nginx/sbin/nginx&quot;</span>,<span class="string">&quot;-s&quot;</span>,<span class="string">&quot;quit&quot;</span>]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          </span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">life-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lifecycle-demo-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">         <span class="attr">exec:</span></span><br><span class="line">           <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;lifecycle hookshandler&#x27; &gt; /usr/share/nginx/html/test.html&quot;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">         <span class="attr">exec:</span></span><br><span class="line">           <span class="attr">command:</span></span><br><span class="line">           <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">           <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">           <span class="bullet">-</span> <span class="string">&quot;nginx -s stop&quot;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">pod</span>]<span class="comment"># kubectl exec -it life-demo -- /bin/bash </span></span><br><span class="line"><span class="string">root@life-demo:/#</span> <span class="string">ls</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line"><span class="string">50x.html</span>  <span class="string">index.html</span>  <span class="string">test.html</span></span><br><span class="line"><span class="string">root@life-demo:/#</span> <span class="string">cat</span> <span class="string">/usr/share/nginx/html/test.html</span> </span><br><span class="line"><span class="string">lifecycle</span> <span class="string">hookshandler</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">event</span></span><br><span class="line"><span class="string">0s</span>          <span class="string">Normal</span>    <span class="string">Killing</span>          <span class="string">pod/life-demo</span>                          <span class="string">Stopping</span> <span class="string">container</span> <span class="string">lifecycle-demo-container</span></span><br><span class="line"><span class="string">0s</span>          <span class="string">Normal</span>    <span class="string">Killing</span>          <span class="string">pod/life-demo</span>                          <span class="string">Stopping</span> <span class="string">container</span> <span class="string">lifecycle-demo-container</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>pod 在整个生命周期中有非常多的用户行为：</p>
<p>1、初始化容器完成初始化</p>
<p>2、主容器启动后可以做启动后钩子</p>
<p>3、主容器结束前可以做结束前钩子</p>
<p>4、在主容器运行中可以做一些健康检测，如 startupprobe、livenessprobe，readnessprobe</p>
<h2 id="容器探测"><a class="markdownIt-Anchor" href="#容器探测">#</a> 容器探测</h2>
<p>在 Kubernetes 中 Pod 是最小的计算单元，而一个 Pod 又由多个容器组成，相当于每个容器就是一个应用，应用在运行期间，可能因为某些意外情况致使程序挂掉。那么如何监控这些容器状态稳定性，保证服务在运行期间不会发生问题，发生问题后进行重启等机制，就成为了重中之重的事情，考虑到这点 kubernetes 推出了活性探针机制。有了存活性探针能保证程序在运行中如果挂掉能够自动重启，但是还有个经常遇到的问题，比如说，在 Kubernetes 中启动 Pod，显示明明 Pod 已经启动成功，且能访问里面的端口，但是却返回错误信息。还有就是在执行滚动更新时候，总会出现一段时间，Pod 对外提供网络访问，但是访问却发生 404，这两个原因，都是因为 Pod 已经成功启动，但是 Pod 的的容器中应用程序还在启动中导致，考虑到这点 Kubernetes 推出了就绪性探针机制。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">check</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">check</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span> <span class="number">10</span><span class="string">;exit</span></span><br></pre></td></tr></table></figure>
<p>k8s 提供了三种来实现容器探测的方法，分别是：</p>
<blockquote>
<p>1、startupProbe：探测容器中的应用是否已经启动。如果提供了启动探测 (startup probe)，则暂时禁用所有其他探测，直到它成功为止。如果启动探测失败，kubelet 将杀死容器，容器服从其重启策略进行重启。如果容器没有提供启动探测，则默认状态为成功 Success。</p>
<p>2、livenessprobe：用指定的方式（exec、tcp、http）<strong>检测 pod 中的容器是否正常运行</strong>，如果检测失败，则认为容器不健康，那么 Kubelet 将根据 Pod 中设置的 restartPolicy 策略来判断 Pod 是否要进行重启操作，如果容器配置中没有配置 livenessProbe，Kubelet 将认为存活探针探测一直为 success（成功）状态。</p>
<p>3、readnessprobe：就绪性探针，<strong>用于检测容器中的应用是否可以接受请求</strong>，当探测成功后才使 Pod 对外提供网络访问，将容器标记为就绪状态，可以加到 pod 前端负载，如果探测失败，则将容器标记为未就绪状态，会把 pod 从前端负载移除。</p>
</blockquote>
<p>可以自定义在 pod 启动时是否执行这些检测，如果不设置，则检测结果均默认为通过，如果设置，则顺序为 startupProbe&gt;readinessProbe 和 livenessProbe，readinessProbe 和 livenessProbe 是并发关系</p>
<p>目前 LivenessProbe 和 ReadinessProbe、startupprobe 探测都支持下面三种探针：</p>
<blockquote>
<p>1、exec：在容器中执行指定的命令，如果执行成功，退出码为 0 则探测成功。</p>
<p>2、TCPSocket：通过容器的 IP 地址和端口号执行 TCP 检 查，如果能够建立 TCP 连接，则表明容器健康。</p>
<p>3、HTTPGet：通过容器的 IP 地址、端口号及路径调用 HTTP Get 方法，如果响应的状态码大于等于 200 且小于 400，则认为容器健康</p>
</blockquote>
<p>探针探测结果有以下值：</p>
<blockquote>
<p>1、Success：表示通过检测。</p>
<p>2、Failure：表示未通过检测。</p>
<p>3、Unknown：表示检测没有正常进行。</p>
</blockquote>
<p>Pod 探针相关的属性：</p>
<p>探针 (Probe) 有许多可选字段，可以用来更加精确的控制 Liveness 和 Readiness 两种探针的行为</p>
<blockquote>
<p>initialDelaySeconds：容器启动后要等待多少秒后探针开始工作，单位 “秒”，默认是 0 秒，最小值是 0</p>
<p>periodSeconds： 执行探测的时间间隔（单位是秒），默认为 10s，单位 “秒”，最小值是 1</p>
<p>timeoutSeconds： 探针执行检测请求后，等待响应的超时时间，默认为 1，单位 “秒”。</p>
<p>successThreshold：连续探测几次成功，才认为探测成功，默认为 1，在 Liveness 探针中必须为 1，最小值为 1。</p>
<p>failureThreshold： 探测失败的重试次数，重试一定次数后将认为失败，在 readiness 探针中，Pod 会被标记为未就绪，默认为 3，最小值为 1</p>
</blockquote>
<p>两种探针区别：</p>
<p>ReadinessProbe 和 livenessProbe 可以使用相同探测方式，只是对 Pod 的处置方式不同：</p>
<blockquote>
<p>readinessProbe 当检测失败后，<strong>将 Pod 的 IP:Port 从对应的 EndPoint 列表中删除。</strong></p>
<p>livenessProbe 当检测失败后，<strong>将杀死容器并根据 Pod 的重启策略来决定作出对应的措施。</strong></p>
</blockquote>
<h3 id="启动探测"><a class="markdownIt-Anchor" href="#启动探测">#</a> 启动探测</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1、exec模式</span></span><br><span class="line"><span class="comment"># kubectl explain pod.spec.containers.startupProbe</span></span><br><span class="line"><span class="comment"># startupProbe</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">startupprobe</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">startup</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat-8.5-jre8</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">startupProbe:</span></span><br><span class="line">     <span class="attr">exec:</span></span><br><span class="line">       <span class="attr">command:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&quot;ps aux | grep tomcat&quot;</span></span><br><span class="line">     <span class="attr">initialDelaySeconds:</span> <span class="number">20</span> <span class="comment">#容器启动后多久开始探测</span></span><br><span class="line">     <span class="attr">periodSeconds:</span> <span class="number">20</span> <span class="comment">#执行探测的时间间隔</span></span><br><span class="line">     <span class="attr">timeoutSeconds:</span> <span class="number">10</span> <span class="comment">#探针执行检测请求后，等待响应的超时时间</span></span><br><span class="line">     <span class="attr">successThreshold:</span> <span class="number">1</span> <span class="comment">#成功多少次才算成功</span></span><br><span class="line">     <span class="attr">failureThreshold:</span> <span class="number">3</span> <span class="comment">#失败多少次才算失败</span></span><br><span class="line"><span class="comment"># 第一次探测失败多久会重启</span></span><br><span class="line"><span class="string">initialDelaySeconds</span> <span class="string">+</span> <span class="string">(periodSeconds</span> <span class="string">+</span> <span class="string">timeoutSeconds)</span> <span class="string">*</span> <span class="string">failureThreshold</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcpsocket模式</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">startupprobe</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">startup</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat:9.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">startupProbe:</span></span><br><span class="line">     <span class="attr">tcpSocket:</span></span><br><span class="line">       <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">     <span class="attr">initialDelaySeconds:</span> <span class="number">20</span> <span class="comment">#容器启动后多久开始探测</span></span><br><span class="line">     <span class="attr">periodSeconds:</span> <span class="number">20</span> <span class="comment">#执行探测的时间间隔</span></span><br><span class="line">     <span class="attr">timeoutSeconds:</span> <span class="number">10</span> <span class="comment">#探针执行检测请求后，等待响应的超时时间</span></span><br><span class="line">     <span class="attr">successThreshold:</span> <span class="number">1</span> <span class="comment">#成功多少次才算成功</span></span><br><span class="line">     <span class="attr">failureThreshold:</span> <span class="number">3</span> <span class="comment">#失败多少次才算失败</span></span><br><span class="line"></span><br><span class="line"><span class="string">startupprobe</span>             <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span>      <span class="string">&lt;none&gt;</span>           <span class="string">node1</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">startupprobe</span>             <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">1s</span>      <span class="string">&lt;none&gt;</span>           <span class="string">node1</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">startupprobe</span>             <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">2s</span>      <span class="number">10.244</span><span class="number">.166</span><span class="number">.168</span>   <span class="string">node1</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">startupprobe</span>             <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">36s</span>     <span class="number">10.244</span><span class="number">.166</span><span class="number">.168</span>   <span class="string">node1</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">startupprobe</span>             <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">78s</span>     <span class="number">10.244</span><span class="number">.166</span><span class="number">.168</span>   <span class="string">node1</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># httpget模式</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">startupprobe</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">startup</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat:9.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">startupProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">     <span class="attr">initialDelaySeconds:</span> <span class="number">20</span> <span class="comment">#容器启动后多久开始探测</span></span><br><span class="line">     <span class="attr">periodSeconds:</span> <span class="number">20</span> <span class="comment">#执行探测的时间间隔</span></span><br><span class="line">     <span class="attr">timeoutSeconds:</span> <span class="number">10</span> <span class="comment">#探针执行检测请求后，等待响应的超时时间</span></span><br><span class="line">     <span class="attr">successThreshold:</span> <span class="number">1</span> <span class="comment">#成功多少次才算成功</span></span><br><span class="line">     <span class="attr">failureThreshold:</span> <span class="number">3</span> <span class="comment">#失败多少次才算失败</span></span><br></pre></td></tr></table></figure>
<h3 id="存活探测"><a class="markdownIt-Anchor" href="#存活探测">#</a> 存活探测</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># livenessProbe</span></span><br><span class="line"><span class="comment"># exec</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-exec</span><br><span class="line">  labels:</span><br><span class="line">    app: liveness</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: busybox:1.28</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    args:                       <span class="comment">#创建测试探针探测的文件</span></span><br><span class="line">    - /bin/sh</span><br><span class="line">    - -c</span><br><span class="line">    - <span class="built_in">touch</span> /tmp/healthy; <span class="built_in">sleep</span> 30; <span class="built_in">rm</span> -rf /tmp/healthy; <span class="built_in">sleep</span> 600</span><br><span class="line">    livenessProbe:</span><br><span class="line">      initialDelaySeconds: 10   <span class="comment">#延迟检测时间</span></span><br><span class="line">      periodSeconds: 5          <span class="comment">#检测时间间隔</span></span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - <span class="built_in">cat</span></span><br><span class="line">        - /tmp/healthy</span><br><span class="line"></span><br><span class="line">liveness-exec            1/1     Running             0          2s      10.244.166.171   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">liveness-exec            1/1     Running             1          76s     10.244.166.171   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">liveness-exec            1/1     Running             2          2m30s   10.244.166.171   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">10 + 20 * 3</span><br></pre></td></tr></table></figure>
<p>容器启动设置执行的命令：</p>
<p>/bin/sh -c “touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600”</p>
<p>容器在初始化后，首先创建一个 /tmp/healthy 文件，然后执行睡眠命令，睡眠 30 秒，到时间后执行删除 /tmp/healthy 文件命令。而设置的存活探针检检测方式为执行 shell 命令，用 cat 命令输出 healthy 文件的内容，如果能成功执行这条命令，存活探针就认为探测成功，否则探测失败。在前 30 秒内，由于文件存在，所以存活探针探测时执行 cat /tmp/healthy 命令成功执行。30 秒后 healthy 文件被删除，所以执行命令失败，Kubernetes 会根据 Pod 设置的重启策略来判断，是否重启 Pod。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-http</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mydlqclub/springboot-helloworld:0.0.1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">20</span>   <span class="comment">#延迟加载时间</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span>          <span class="comment">#重试时间间隔</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">10</span>        <span class="comment">#超时时间设置</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line"><span class="comment"># localhost:8081/actuator/health</span></span><br></pre></td></tr></table></figure>
<p>上面 Pod 中启动的容器是一个 SpringBoot 应用，其中引用了 Actuator 组件，提供了 /actuator/health 健康检查地址，存活探针可以使用 HTTPGet 方式向服务发起请求，请求 8081 端口的 /actuator/health 路径来进行存活判断：</p>
<p>任何大于或等于 200 且小于 400 的代码表示探测成功。</p>
<p>任何其他代码表示失败。</p>
<p>如果探测失败，则会杀死 Pod 进行重启操作。</p>
<p>httpGet 探测方式有如下可选的控制字段:</p>
<blockquote>
<p>scheme: 用于连接 host 的协议，默认为 HTTP。</p>
<p>host：要连接的主机名，默认为 Pod IP，可以在 http request head 中设置 host 头部。</p>
<p>port：容器上要访问端口号或名称。</p>
<p>path：http 服务器上的访问 URI。</p>
<p>httpHeaders：自定义 HTTP 请求 headers，HTTP 允许重复 headers。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcp</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-tcp</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h3 id="就绪探测"><a class="markdownIt-Anchor" href="#就绪探测">#</a> 就绪探测</h3>
<p>Pod 的 ReadinessProbe 探针使用方式和 LivenessProbe 探针探测方法一样，也是支持三种，只是一个是用于探测应用的存活，一个是判断是否对外提供流量的条件。这里用一个 Springboot 项目，设置 ReadinessProbe 探测 SpringBoot 项目的 8081 端口下的 /actuator/health 接口，如果探测成功则代表内部程序以及启动，就开放对外提供接口访问，否则内部应用没有成功启动，暂不对外提供访问，直到就绪探针探测成功。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readiness </span></span><br><span class="line"><span class="comment"># exec</span></span><br><span class="line"><span class="comment"># http</span></span><br><span class="line"><span class="comment"># exec</span></span><br><span class="line">当检测失败后，将 Pod 的 IP:Port 从对应的 EndPoint 列表中删除。</span><br><span class="line">检测成功后才会加到service的endpoint中</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: springboot</span><br><span class="line">  labels:</span><br><span class="line">    app: springboot</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: server</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    nodePort: 31180</span><br><span class="line">  - name: management</span><br><span class="line">    port: 8081</span><br><span class="line">    targetPort: 8081</span><br><span class="line">    nodePort: 31181</span><br><span class="line">  selector:</span><br><span class="line">    app: springboot</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: springboot</span><br><span class="line">  labels:</span><br><span class="line">    app: springboot</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: springboot</span><br><span class="line">    image: mydlqclub/springboot-helloworld:0.0.1</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">    - name: server</span><br><span class="line">      containerPort: 8080</span><br><span class="line">    - name: management</span><br><span class="line">      containerPort: 8081</span><br><span class="line">    readinessProbe:</span><br><span class="line">      initialDelaySeconds: 20   </span><br><span class="line">      periodSeconds: 5          </span><br><span class="line">      timeoutSeconds: 10   </span><br><span class="line">      httpGet:</span><br><span class="line">        scheme: HTTP</span><br><span class="line">        port: 8081</span><br><span class="line">        path: /actuator/health</span><br></pre></td></tr></table></figure>
<h3 id="混合使用三种探测"><a class="markdownIt-Anchor" href="#混合使用三种探测">#</a> 混合使用三种探测</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 混合使用三种探测</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: springboot-live</span><br><span class="line">  labels:</span><br><span class="line">    app: springboot</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: server</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    nodePort: 31180</span><br><span class="line">  - name: management</span><br><span class="line">    port: 8081</span><br><span class="line">    targetPort: 8081</span><br><span class="line">    nodePort: 31181</span><br><span class="line">  selector:</span><br><span class="line">    app: springboot</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: springboot-live</span><br><span class="line">  labels:</span><br><span class="line">    app: springboot</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: springboot</span><br><span class="line">    image: mydlqclub/springboot-helloworld:0.0.1</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">    - name: server</span><br><span class="line">      containerPort: 8080</span><br><span class="line">    - name: management</span><br><span class="line">      containerPort: 8081</span><br><span class="line">    readinessProbe:</span><br><span class="line">      initialDelaySeconds: 20   </span><br><span class="line">      periodSeconds: 5          </span><br><span class="line">      timeoutSeconds: 10   </span><br><span class="line">      httpGet:</span><br><span class="line">        scheme: HTTP</span><br><span class="line">        port: 8081</span><br><span class="line">        path: /actuator/health</span><br><span class="line">    livenessProbe:</span><br><span class="line">      initialDelaySeconds: 20</span><br><span class="line">      periodSeconds: 5</span><br><span class="line">      timeoutSeconds: 10</span><br><span class="line">      httpGet:</span><br><span class="line">        scheme: HTTP</span><br><span class="line">        port: 8081</span><br><span class="line">        path: /actuator/health</span><br><span class="line">    startupProbe:</span><br><span class="line">      initialDelaySeconds: 20</span><br><span class="line">      periodSeconds: 5</span><br><span class="line">      timeoutSeconds: 10</span><br><span class="line">      httpGet:</span><br><span class="line">        scheme: HTTP</span><br><span class="line">        port: 8081</span><br><span class="line">        path: /actuator/health</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先启动探测，成功之后执行就绪和存活，后两个并行执行</span></span><br></pre></td></tr></table></figure>
<h2 id="replicaset"><a class="markdownIt-Anchor" href="#replicaset">#</a> Replicaset</h2>
<p>Pod 类型的自主式 pod，但是这存在一个问题，假如 pod 被删除了，那这个 pod 就不能自我恢复，就会彻底被删除，线上这种情况非常危险，pod 的控制器，所谓控制器就是能够管理 pod，监测 pod 运行状况，当 pod 发生故障，可以自动恢复 pod。也就是说能够代我们去管理 pod 中间层，并帮助我们确保每一个 pod 资源始终处于我们所定义或者我们所期望的目标状态，一旦 pod 资源出现故障，那么控制器会尝试重启 pod 或者里面的容器，如果一直重启有问题的话那么它可能会基于某种策略来进行重新布派或者重新编排；如果 pod 副本数量低于用户所定义的目标数量，它也会自动补全；如果多余，也会自动终止 pod 资源。</p>
<p>kubectl explain rs</p>
<p>ReplicaSet 是 kubernetes 中的一种副本控制器，简称 rs，主要作用是控制由其管理的 pod，使 pod 副本的数量始终维持在预设的个数。它的主要作用就是保证一定数量的 Pod 能够在集群中正常运行，它会持续监听这些 Pod 的运行状态，在 Pod 发生故障时重启 pod，pod 数量减少时重新运行新的 Pod 副本。官方推荐不要直接使用 ReplicaSet，用 Deployments 取而代之，Deployments 是比 ReplicaSet 更高级的概念，它会管理 ReplicaSet 并提供很多其它有用的特性，最重要的是 Deployments 支持声明式更新，声明式更新的好处是不会丢失历史变更。所以 Deployment 控制器不直接管理 Pod 对象，而是由 Deployment 管理 ReplicaSet，再由 ReplicaSet 负责管理 Pod 对象。</p>
<p>Replicaset 控制器主要由三个部分组成：</p>
<blockquote>
<p>1、用户期望的 pod 副本数：用来定义由这个控制器管控的 pod 副本有几个</p>
<p>2、标签选择器：选定哪些 pod 是自己管理的，如果通过标签选择器选到的 pod 副本数量少于我们指定的数量，需要用到下面的组件</p>
<p>3、pod 资源模板：如果集群中现存的 pod 数量不够我们定义的副本中期望的数量怎么办，需要新建 pod，这就需要 pod 模板，新建的 pod 是基于模板来创建的。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">shabi</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">zhizhang</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span> </span><br><span class="line">      <span class="attr">tier1:</span> <span class="string">frontend1</span></span><br><span class="line">  <span class="comment"># pod 模板</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier1:</span> <span class="string">frontend1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">20</span>   </span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span>          </span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">10</span>   </span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">startupProbe:</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">20</span>   </span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span>          </span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">10</span>   </span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">20</span>   </span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span>          </span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">10</span>   </span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">  </span><br><span class="line">		</span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">replicaset</span>]<span class="comment"># kubectl get rs</span></span><br><span class="line"><span class="string">NAME</span>                         <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">frontend</span>                     <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>       <span class="string">8s</span></span><br><span class="line"></span><br><span class="line"><span class="string">pod名字</span> <span class="string">=</span> <span class="string">repset名字</span> <span class="bullet">-</span> <span class="string">随机数,所以在template中只需要定义标签，不需要名字</span></span><br><span class="line"><span class="string">删除pod之后，pod</span> <span class="string">ip会变，会产生一个IP不同的新的pod</span></span><br><span class="line"><span class="string">repset永远让pod数量维持</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">replicaset</span>]<span class="comment"># kubectl get pod -owide </span></span><br><span class="line"><span class="string">NAME</span>                               <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>       <span class="string">AGE</span>     <span class="string">IP</span>               <span class="string">NODE</span>               <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">frontend-8t7jx</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>              <span class="string">56s</span>     <span class="number">10.244</span><span class="number">.216</span><span class="number">.104</span>   <span class="string">prometheus-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">frontend-qx7dx</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>              <span class="string">56s</span>     <span class="number">10.244</span><span class="number">.64</span><span class="number">.21</span>     <span class="string">prometheus-node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">frontend-s8jgx</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>              <span class="string">56s</span>     <span class="number">10.244</span><span class="number">.216</span><span class="number">.103</span>   <span class="string">prometheus-node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="pod动态扩缩容"><a class="markdownIt-Anchor" href="#pod动态扩缩容">#</a> pod 动态扩缩容</h3>
<p>replicaset 可以实现动态变更副本数和镜像</p>
<p>变更镜像的时候需要手动删除原来的 pod (delete pods) 不会滚动更新，如果增加副本数只需要在原有基础上增加 pod 即可，删除副本是随机删除 pod</p>
<p>ReplicaSet 最核心的功能是可以动态扩容和回缩，如果我们觉得两个副本太少了，想要增加，只需要修改配置文件 replicaset.yaml 里的 replicas 的值即可，原来 replicas: 3，现在变成 replicaset: 4，修改之后，执行如下命令更新：<br>
kubectl apply -f replicaset.yaml</p>
<p>生产环境如果升级，可以删除一个 pod，观察一段时间之后没问题再删除另一个 pod，但是这样需要人工干预多次；实际生产环境一般采用蓝绿发布，原来有一个 rs1，再创建一个 rs2（控制器），通过修改 service 标签，修改 service 可以匹配到 rs2 的控制器，这样才是蓝绿发布，这个也需要我们精心的部署规划，我们有一个控制器就是建立在 rs 之上完成的，叫做 Deployment</p>
<h2 id="deployment"><a class="markdownIt-Anchor" href="#deployment">#</a> deployment</h2>
<p>Deployment 是 kubernetes 中最常用的资源对象，为 ReplicaSet 和 Pod 的创建提供了一种声明式的定义方法，在 Deployment 对象中描述一个期望的状态，Deployment 控制器就会按照一定的控制速率把实际状态改成期望状态，通过定义一个 Deployment 控制器会创建一个新的 ReplicaSet 控制器，通过 ReplicaSet 创建 pod，删除 Deployment 控制器，也会删除 Deployment 控制器下对应的 ReplicaSet 控制器和 pod 资源.</p>
<p>使用 Deployment 而不直接创建 ReplicaSet 是因为 Deployment 对象拥有许多 ReplicaSet 没有的特性，例如滚动升级、金丝雀发布、蓝绿部署和回滚。</p>
<p>声明式定义是指直接修改资源清单 yaml 文件，然后通过 kubectl apply -f 资源清单 yaml 文件，就可以更改资源</p>
<p>Deployment 控制器是建立在 rs 之上的一个控制器，可以管理多个 rs，每次更新镜像版本，都会生成一个新的 rs，把旧的 rs 替换掉，多个 rs 同时存在，但是只有一个 rs 运行。</p>
<p>Deployment 可以使用声明式定义，直接在命令行通过纯命令的方式完成对应资源版本的内容的修改，也就是通过打补丁的方式进行修改；Deployment 能提供滚动式自定义自控制的更新；对 Deployment 来讲，我们在实现更新时还可以实现控制更新节奏和更新逻辑。（先创建还是先删除）</p>
<p>通过 Deployment 对象，你可以做到以下事情：</p>
<blockquote>
<p>1、创建 ReplicaSet 和 Pod</p>
<p>2、滚动升级（不停止旧服务的状态下升级）和回滚应用（将应用回滚到之前的版本）</p>
<p>3、平滑地扩容和缩容</p>
<p>4、暂停和继续 Deployment</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@</span> <span class="string">~</span>]<span class="comment"># kubectl explain deploy.spec.strategy.rollingUpdate</span></span><br><span class="line"><span class="string">maxSurge</span>	<span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="comment">#我们更新的过程当中最多允许超出的指定的目标副本数有几个； </span></span><br><span class="line"><span class="string">它有两种取值方式，第一种直接给定数量，第二种根据百分比，百分比表示原本是5个，最多可以超出20%，那就允许多一个，最多可以超过40%，那就允许多两个</span></span><br><span class="line"><span class="string">maxUnavailable</span>	<span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="comment">#最多允许几个不可用</span></span><br><span class="line"><span class="string">假设有5个副本，最多一个不可用，就表示最少有4个可用</span></span><br><span class="line"></span><br><span class="line"><span class="string">假如pod数为5，surge和maxun都是2</span></span><br><span class="line"><span class="string">那么最大超出的副本数是5+2</span></span><br><span class="line"><span class="string">最少副本数为5-2</span></span><br><span class="line"><span class="string">maxsurge</span> <span class="string">出现小数向上取整</span></span><br><span class="line"><span class="string">maxunavailable</span> <span class="string">出现小数向下取整</span> </span><br><span class="line"></span><br><span class="line"><span class="string">ctr</span> <span class="string">-n=k8s.io</span> <span class="string">images</span> <span class="string">import</span> <span class="string">x.tar.gz</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span> </span><br><span class="line">           <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">           <span class="attr">httpGet:</span></span><br><span class="line">             <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">             <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">             <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">           <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">           <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">           <span class="attr">httpGet:</span></span><br><span class="line">             <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">             <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">             <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">           <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">           <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">           <span class="attr">httpGet:</span></span><br><span class="line">             <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">             <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">             <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> [root@master1 ~]<span class="comment"># kubectl get deployment</span></span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">myapp-v1   2/2     2            2           57s</span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get replicaset </span></span><br><span class="line">NAME                 DESIRED   CURRENT   READY   AGE</span><br><span class="line">myapp-v1-b5d4c8b9d   2         2         2       72s</span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get pods </span></span><br><span class="line">myapp-v1-b5d4c8b9d-cxcvr   1/1     Running   0          108s</span><br><span class="line">myapp-v1-b5d4c8b9d-ptsv4   1/1     Running   0          108s</span><br><span class="line"></span><br><span class="line">1.NAME ：列出名称空间中deployment的名称。</span><br><span class="line">2.READY：显示deployment有多少副本数。它遵循ready/desired的模式。</span><br><span class="line">3.UP-TO-DATE： 显示已更新到所需状态的副本数。</span><br><span class="line">4.AVAILABLE： 显示你的可以使用多少个应用程序副本。</span><br><span class="line">5.AGE ：显示应用程序已运行的时间。</span><br><span class="line"></span><br><span class="line">1.NAME： 列出名称空间中ReplicaSet资源</span><br><span class="line">2.DESIRED：显示应用程序的所需副本数，这些副本数是在创建时定义的。这是所需的状态。</span><br><span class="line">3.CURRENT： 显示当前正在运行多少个副本。</span><br><span class="line">4.READY： 显示你的用户可以使用多少个应用程序副本。</span><br><span class="line">5.AGE ：显示应用程序已运行的时间。 </span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扩容缩容</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">声明式更新 - apply -f</span><br></pre></td></tr></table></figure>
<h3 id="滚动更新"><a class="markdownIt-Anchor" href="#滚动更新">#</a> 滚动更新</h3>
<p>滚动更新是一种自动化程度较高的发布方式，用户体验比较平滑，是目前成熟型技术组织所采用的主流发布方式，一次滚动发布一般由若干个发布批次组成，每批的数量一般是可以配置的（可以通过发布模板定义），例如第一批 1 台，第二批 10%，第三批 50%，第四批 100%。每个批次之间留观察间隔，通过手工验证或监控反馈确保没有问题再发下一批次，所以总体上滚动式发布过程是比较缓慢的</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rollingupdate</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">explain</span> <span class="string">deploy.spec.strategy.rollingUpdate</span></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">Deployment</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">RESOURCE:</span> <span class="string">rollingUpdate</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"><span class="attr">DESCRIPTION:</span></span><br><span class="line">     <span class="string">Rolling</span> <span class="string">update</span> <span class="string">config</span> <span class="string">params.</span> <span class="string">Present</span> <span class="string">only</span> <span class="string">if</span> <span class="string">DeploymentStrategyType</span> <span class="string">=</span></span><br><span class="line">     <span class="string">RollingUpdate.</span></span><br><span class="line">     <span class="string">Spec</span> <span class="string">to</span> <span class="string">control</span> <span class="string">the</span> <span class="string">desired</span> <span class="string">behavior</span> <span class="string">of</span> <span class="string">rolling</span> <span class="string">update.</span></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">maxSurge</span>	<span class="string">&lt;string&gt;</span></span><br><span class="line">     <span class="string">The</span> <span class="string">maximum</span> <span class="string">number</span> <span class="string">of</span> <span class="string">pods</span> <span class="string">that</span> <span class="string">can</span> <span class="string">be</span> <span class="string">scheduled</span> <span class="string">above</span> <span class="string">the</span> <span class="string">desired</span> <span class="string">number</span></span><br><span class="line">     <span class="string">of</span> <span class="string">pods.</span> <span class="string">Value</span> <span class="string">can</span> <span class="string">be</span> <span class="string">an</span> <span class="string">absolute</span> <span class="string">number</span> <span class="string">(ex:</span> <span class="number">5</span><span class="string">)</span> <span class="string">or</span> <span class="string">a</span> <span class="string">percentage</span> <span class="string">of</span> <span class="string">desired</span></span><br><span class="line">     <span class="string">pods</span> <span class="string">(ex:</span> <span class="number">10</span><span class="string">%).</span> <span class="string">This</span> <span class="string">can</span> <span class="string">not</span> <span class="string">be</span> <span class="number">0</span> <span class="string">if</span> <span class="string">MaxUnavailable</span> <span class="string">is</span> <span class="number">0</span><span class="string">.</span> <span class="string">Absolute</span> <span class="string">number</span></span><br><span class="line">     <span class="string">is</span> <span class="string">calculated</span> <span class="string">from</span> <span class="string">percentage</span> <span class="string">by</span> <span class="string">rounding</span> <span class="string">up.</span> <span class="string">Defaults</span> <span class="string">to</span> <span class="number">25</span><span class="string">%.</span> <span class="attr">Example:</span></span><br><span class="line">     <span class="string">when</span> <span class="string">this</span> <span class="string">is</span> <span class="string">set</span> <span class="string">to</span> <span class="number">30</span><span class="string">%,</span> <span class="string">the</span> <span class="string">new</span> <span class="string">ReplicaSet</span> <span class="string">can</span> <span class="string">be</span> <span class="string">scaled</span> <span class="string">up</span> <span class="string">immediately</span></span><br><span class="line">     <span class="string">when</span> <span class="string">the</span> <span class="string">rolling</span> <span class="string">update</span> <span class="string">starts,</span> <span class="string">such</span> <span class="string">that</span> <span class="string">the</span> <span class="string">total</span> <span class="string">number</span> <span class="string">of</span> <span class="string">old</span> <span class="string">and</span> <span class="string">new</span></span><br><span class="line">     <span class="string">pods</span> <span class="string">do</span> <span class="string">not</span> <span class="string">exceed</span> <span class="number">130</span><span class="string">%</span> <span class="string">of</span> <span class="string">desired</span> <span class="string">pods.</span> <span class="string">Once</span> <span class="string">old</span> <span class="string">pods</span> <span class="string">have</span> <span class="string">been</span> <span class="string">killed,</span></span><br><span class="line">     <span class="string">new</span> <span class="string">ReplicaSet</span> <span class="string">can</span> <span class="string">be</span> <span class="string">scaled</span> <span class="string">up</span> <span class="string">further,</span> <span class="string">ensuring</span> <span class="string">that</span> <span class="string">total</span> <span class="string">number</span> <span class="string">of</span> <span class="string">pods</span></span><br><span class="line">     <span class="string">running</span> <span class="string">at</span> <span class="string">any</span> <span class="string">time</span> <span class="string">during</span> <span class="string">the</span> <span class="string">update</span> <span class="string">is</span> <span class="string">at</span> <span class="string">most</span> <span class="number">130</span><span class="string">%</span> <span class="string">of</span> <span class="string">desired</span> <span class="string">pods.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#我们更新的过程当中最多允许超出的指定的目标副本数有几个； </span></span><br><span class="line"><span class="string">它有两种取值方式，第一种直接给定数量，第二种根据百分比，百分比表示原本是5个，最多可以超出20%，那就允许多一个，最多可以超过40%，那就允许多两个</span></span><br><span class="line">   <span class="string">maxUnavailable</span>	<span class="string">&lt;string&gt;</span></span><br><span class="line">     <span class="string">The</span> <span class="string">maximum</span> <span class="string">number</span> <span class="string">of</span> <span class="string">pods</span> <span class="string">that</span> <span class="string">can</span> <span class="string">be</span> <span class="string">unavailable</span> <span class="string">during</span> <span class="string">the</span> <span class="string">update.</span> <span class="string">Value</span></span><br><span class="line">     <span class="string">can</span> <span class="string">be</span> <span class="string">an</span> <span class="string">absolute</span> <span class="string">number</span> <span class="string">(ex:</span> <span class="number">5</span><span class="string">)</span> <span class="string">or</span> <span class="string">a</span> <span class="string">percentage</span> <span class="string">of</span> <span class="string">desired</span> <span class="string">pods</span> <span class="string">(ex:</span></span><br><span class="line">     <span class="number">10</span><span class="string">%).</span> <span class="string">Absolute</span> <span class="string">number</span> <span class="string">is</span> <span class="string">calculated</span> <span class="string">from</span> <span class="string">percentage</span> <span class="string">by</span> <span class="string">rounding</span> <span class="string">down.</span> <span class="string">This</span></span><br><span class="line">     <span class="string">can</span> <span class="string">not</span> <span class="string">be</span> <span class="number">0</span> <span class="string">if</span> <span class="string">MaxSurge</span> <span class="string">is</span> <span class="number">0</span><span class="string">.</span> <span class="string">Defaults</span> <span class="string">to</span> <span class="number">25</span><span class="string">%.</span> <span class="attr">Example:</span> <span class="string">when</span> <span class="string">this</span> <span class="string">is</span> <span class="string">set</span></span><br><span class="line">     <span class="string">to</span> <span class="number">30</span><span class="string">%,</span> <span class="string">the</span> <span class="string">old</span> <span class="string">ReplicaSet</span> <span class="string">can</span> <span class="string">be</span> <span class="string">scaled</span> <span class="string">down</span> <span class="string">to</span> <span class="number">70</span><span class="string">%</span> <span class="string">of</span> <span class="string">desired</span> <span class="string">pods</span></span><br><span class="line">     <span class="string">immediately</span> <span class="string">when</span> <span class="string">the</span> <span class="string">rolling</span> <span class="string">update</span> <span class="string">starts.</span> <span class="string">Once</span> <span class="string">new</span> <span class="string">pods</span> <span class="string">are</span> <span class="string">ready,</span> <span class="string">old</span></span><br><span class="line">     <span class="string">ReplicaSet</span> <span class="string">can</span> <span class="string">be</span> <span class="string">scaled</span> <span class="string">down</span> <span class="string">further,</span> <span class="string">followed</span> <span class="string">by</span> <span class="string">scaling</span> <span class="string">up</span> <span class="string">the</span> <span class="string">new</span></span><br><span class="line">     <span class="string">ReplicaSet,</span> <span class="string">ensuring</span> <span class="string">that</span> <span class="string">the</span> <span class="string">total</span> <span class="string">number</span> <span class="string">of</span> <span class="string">pods</span> <span class="string">available</span> <span class="string">at</span> <span class="string">all</span> <span class="string">times</span></span><br><span class="line">     <span class="string">during</span> <span class="string">the</span> <span class="string">update</span> <span class="string">is</span> <span class="string">at</span> <span class="string">least</span> <span class="number">70</span><span class="string">%</span> <span class="string">of</span> <span class="string">desired</span> <span class="string">pods.</span></span><br><span class="line"><span class="comment">#最多允许几个不可用</span></span><br><span class="line"><span class="string">假设有5个副本，最多一个不可用，就表示最少有4个可用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看历史版本</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl rollout history deployment myapp-v1 </span></span><br><span class="line"><span class="string">deployment.apps/myapp-v1</span> </span><br><span class="line"><span class="string">REVISION</span>  <span class="string">CHANGE-CAUSE</span></span><br><span class="line"><span class="number">1</span>         <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="number">2</span>         <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">滚动更新后会创建一个新的replicaset</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">rs</span> </span><br><span class="line"><span class="string">NAME</span>                  <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp-v1-75fb478d6c</span>   <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>       <span class="string">2m7s</span></span><br><span class="line"><span class="string">myapp-v1-67fd9fc9c8</span>   <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>       <span class="string">25m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">rollout</span> <span class="string">undo</span> <span class="string">deployment/myapp-v1</span> <span class="string">--to-revision=1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="自动滚动更新策略"><a class="markdownIt-Anchor" href="#自动滚动更新策略">#</a> 自动滚动更新策略</h3>
<p>maxUnavailable: [0%, 100%] 向下取整，比如 10 个副本，5% 的话<mark> 0.5 个，但计算按照 0 个；<br>
maxSurge: [0%, 100%] 向上取整，比如 10 个副本，5% 的话</mark> 0.5 个，但计算按照 1 个；</p>
<p>建议配置，不少于目标副本数，但是 maxsurge 变大可以实现更快的更新</p>
<ol>
<li>maxUnavailable == 0</li>
<li>maxSurge == 1</li>
</ol>
<p>即 “一上一下，先上后下” 最平滑原则：</p>
<p>maxUnavailable：和期望的副本数比，不可用副本数最大比例（或最大值），这个值越小，越能保证服务稳定，更新越平滑；<br>
maxSurge：和期望的副本数比，超过期望副本数最大比例（或最大值），这个值调的越大，副本更新速度越快。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">deploy.spec.strategy.type</span></span><br><span class="line"><span class="string">==</span> <span class="string">Recreate</span></span><br><span class="line"><span class="string">==</span> <span class="string">RollingUpdate(default)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义策略 通过命令</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">patch</span> <span class="string">deployment</span> <span class="string">myapp-v1</span> <span class="string">-p</span> <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;strategy&quot;:&#123;&quot;rollingUpdate&quot;: &#123;&quot;maxSurge&quot;:1,&quot;maxUnavailable&quot;:1&#125;&#125;&#125;&#125;&#x27;</span> </span><br><span class="line"><span class="comment"># 自定义策略 通过yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="comment"># 删除一个pod再新建一个pod</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重建式方式</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="comment"># 先把所有pod干掉在新建</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-zslxg</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m3s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-nvjhq</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m24s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-gglnb</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m24s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-gglnb</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m24s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-nvjhq</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m24s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-zslxg</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m3s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-gglnb</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m25s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-gglnb</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m25s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-gglnb</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m25s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-zslxg</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m4s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-zslxg</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m4s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-zslxg</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m4s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-nvjhq</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m25s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-nvjhq</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m25s</span></span><br><span class="line"><span class="string">myapp-v1-59c458cb84-nvjhq</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">5m25s</span></span><br><span class="line"><span class="comment"># 最好别用reCreate</span></span><br></pre></td></tr></table></figure>
<h3 id="蓝绿部署"><a class="markdownIt-Anchor" href="#蓝绿部署">#</a> 蓝绿部署</h3>
<p>蓝绿部署中，一共有两套系统：一套是正在提供服务系统，标记为 “绿色”；另一套是准备发布的系统，标记为 “蓝色”。两套系统都是功能完善的、正在运行的系统，只是系统版本和对外服务情况不同。</p>
<p>开发新版本，要用新版本替换线上的旧版本，在线上的系统之外，搭建了一个使用新版本代码的全新系统。 这时候，一共有两套系统在运行，正在对外提供服务的老系统是绿色系统，新部署的系统是蓝色系统。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230619175716206.png" alt="image-20230619175716206"></p>
<p>用来做发布前测试，测试过程中发现任何问题，可以直接在蓝色系统上修改，不干扰用户正在使用的系统。（注意，两套系统没有耦合的时候才能百分百保证不干扰）<br>
蓝色系统经过反复的测试、修改、验证，确定达到上线标准之后，直接将用户切换到蓝色系统：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230619180146410.png" alt="image-20230619180146410"></p>
<p>切换后的一段时间内，依旧是蓝绿两套系统并存，但是用户访问的已经是蓝色系统。这段时间内观察蓝色系统（新系统）工作状态，如果出现问题，直接切换回绿色系统。</p>
<p>当确信对外提供服务的蓝色系统工作正常，不对外提供服务的绿色系统已经不再需要的时候，蓝色系统正式成为对外提供服务系统，成为新的绿色系统。 原先的绿色系统可以销毁，将资源释放出来，用于部署下一个蓝色系统。</p>
<p>优点：</p>
<blockquote>
<p>1、更新过程无需停机，风险较少</p>
<p>2、回滚方便，只需要更改路由或者切换 DNS 服务器，效率较高</p>
</blockquote>
<p>缺点：</p>
<blockquote>
<p>1、成本较高，需要部署两套环境。如果新版本中基础服务出现问题，会瞬间影响全网用户；如果新版本有问题也会影响全网用户。</p>
<p>2、需要部署两套机器，费用开销大</p>
<p>3、在非隔离的机器（Docker、VM）上操作时，可能会导致蓝绿环境被摧毁风险</p>
<p>4、负载均衡器 / 反向代理 / 路由 / DNS 处理不当，将导致流量没有切换过来情况出现</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment实现蓝绿部署</span></span><br><span class="line"><span class="comment"># 创建绿色系统</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blue-green</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">   <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">     <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">   <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">janakiramm/myapp:v1</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建蓝色系统</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blue-green</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">   <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">     <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">   <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">janakiramm/myapp:v2</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="comment"># 此时同时有两组pod存在</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建四层代理</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-lan-lv</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blue-green</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30062</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line"><span class="comment"># 蓝绿部署需要service 通过service中selector选择不同label选择不同pod实现service代理到不同deploy，实现动态流量切换</span></span><br><span class="line"><span class="comment"># 切换到蓝色</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line"><span class="comment"># 切换到绿色</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="金丝雀发布"><a class="markdownIt-Anchor" href="#金丝雀发布">#</a> 金丝雀发布</h3>
<p>金丝雀发布（又称灰度发布、灰度更新）：金丝雀发布一般先发 1 台，或者一个小比例，例如 2% 的服务器，主要做流量验证用，也称为金丝雀 (Canary) 测试 （国内常称灰度测试）。</p>
<p>简单的金丝雀测试一般通过手工测试验证，复杂的金丝雀测试需要比较完善的监控基础设施配合，通过监控指标反馈，观察金丝雀的健康状况，作为后续发布或回退的依据。 如果金丝测试通过，则把剩余的 V1 版本全部升级为 V2 版本。如果金丝雀测试失败，则直接回退金丝雀，发布失败。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230619182743417.png" alt="image-20230619182743417"></p>
<p>优点：灵活，策略自定义，可以按照流量或具体的内容进行灰度 (比如不同账号，不同参数)，出现问题不会影响全网用户</p>
<p>缺点：没有覆盖到所有的用户导致出现问题不好排查</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先创建一个deployment</span></span><br><span class="line">kubectl apply -f .yaml</span><br><span class="line"><span class="comment"># 只更新一个pod，此时有n+1个pod,立刻暂停更新，新的pod称为金丝雀</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment myapp-v1 myapp=nginx  -n blue-green &amp;&amp; kubectl rollout pause deployment myapp-v1 -n blue-green</span><br><span class="line"></span><br><span class="line">上面的解释说明把myapp这个容器的镜像更新到nginx版本 更新镜像之后，创建一个新的pod就立即暂停，这就是我们说的金丝雀发布；如果暂停几个小时之后没有问题，那么取消暂停，就会依次执行后面步骤，把所有pod都升级。</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全部pod更新，解除暂停</span></span><br><span class="line">kubectl rollout resume deployment myapp-v1 -n blue-green</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kubectl run mynginx --image=nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过命令行创建deployment</span></span><br><span class="line"></span><br><span class="line">kubectl create deployment mytomcat --image=tomcat:8.5.68</span><br><span class="line"><span class="comment"># delete 之后会立刻重新起一个新的pod，称为自愈能力</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get deploy</span></span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">mytomcat   1/1     1            1           4m6s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl delete  deploy mytomcat</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多副本</span></span><br><span class="line">kubectl create deployment my-dep --image=nginx --replicas=3</span><br></pre></td></tr></table></figure>
<p>使用 web 页面</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410160308833.png" alt="image-20230410160308833"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-dep</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-dep</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">my-dep</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">my-dep</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扩缩容</span></span><br><span class="line">kubectl scale --replicas=5 deployment/my-dep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件实现扩缩容</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl edit deploy my-dep</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自愈 - 故障转移</span></span><br><span class="line">自愈： 尝试重启pod</span><br><span class="line">故障转移： 将pod从故障的机器转移到好的机器</span><br><span class="line"></span><br><span class="line"><span class="comment"># 滚动更新</span></span><br><span class="line"><span class="comment"># 实现不停机更新</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl set image deployment/my-dep nginx=nginx:1.16.1 --record</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl rollout status deployment/my-dep</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看deploy信息</span></span><br><span class="line">kubectl get deploy my-dep -oyaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 版本回退</span></span><br><span class="line"><span class="comment">#历史记录</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/my-dep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看某个历史详情</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/my-dep --revision=2</span><br><span class="line"></span><br><span class="line"><span class="comment">#回滚(回到上次)</span></span><br><span class="line">kubectl rollout undo deployment/my-dep</span><br><span class="line"></span><br><span class="line"><span class="comment">#回滚(回到指定版本)</span></span><br><span class="line">kubectl rollout undo deployment/my-dep --to-revision=2</span><br></pre></td></tr></table></figure>
<p>除了 Deployment，k8s 还有  <code>StatefulSet</code>  、 <code>DaemonSet</code>  、 <code>Job</code>   等 类型资源。我们都称为  <code>工作负载</code> 。</p>
<p>有状态应用使用   <code>StatefulSet</code>   部署，无状态应用使用  <code>Deployment</code>  部署</p>
<p>其他工作负载</p>
<p>Deployment: 无状态应用部署，比如微服务，提供多副本等功能</p>
<p>StatefulSet: 有状态应用部署，比如 redis，提供稳定的存储、网络等功能</p>
<p>DaemonSet: 守护型应用部署，比如日志收集组件，在每个机器都运行一份</p>
<p>Job/CronJob: 定时任务部署，比如垃圾清理组件，可以在指定时间运行</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410164854497.png" alt="image-20230410164854497"></p>
<h2 id="service"><a class="markdownIt-Anchor" href="#service">#</a> service</h2>
<p>在 kubernetes 中，Pod 是有生命周期的，如果 Pod 重启它的 IP 很有可能会发生变化。如果我们的服务都是将 Pod 的 IP 地址写死，Pod 挂掉或者重启，和刚才重启的 pod 相关联的其他服务将会找不到它所关联的 Pod，为了解决这个问题，在 kubernetes 中定义了 service 资源对象，Service 定义了一个服务访问的入口，客户端通过这个入口即可访问服务背后的应用集群实例，service 是一组 Pod 的逻辑集合，这一组 Pod 能够被 Service 访问到，通常是通过 Label Selector 实现的。</p>
<p>创建 service 的时候会创建同名的 endpoint，会把 pod 的 ip 和端口加入到 endpoint 中</p>
<p>service 创建的时候有 service 的 ip，关联到 pod 的 ip 和端口，都保存在防火墙规则中：iptables 或者 ipvs</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  127.0.0.1:30821 rr</span><br><span class="line">  -&gt; 10.244.166.155:80            Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.166.156:80            Masq    1      0          0         </span><br><span class="line">TCP  127.0.0.1:31180 rr</span><br><span class="line">  -&gt; 10.244.166.172:8080          Masq    1      0          0         </span><br><span class="line">TCP  127.0.0.1:31181 rr</span><br><span class="line">  -&gt; 10.244.166.172:8081          Masq    1      0          0         </span><br><span class="line">TCP  127.0.0.1:31441 rr</span><br><span class="line">  -&gt; 10.244.180.1:8443            Masq    1      0          0         </span><br><span class="line">TCP  172.17.0.1:30821 rr</span><br><span class="line">  -&gt; 10.244.166.155:80            Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.166.156:80            Masq    1      0          0         </span><br><span class="line">TCP  172.17.0.1:31180 rr</span><br><span class="line">  -&gt; 10.244.166.172:8080          Masq    1      0          0         </span><br><span class="line">TCP  172.17.0.1:31181 rr</span><br><span class="line">  -&gt; 10.244.166.172:8081          Masq    1      0          0         </span><br><span class="line">TCP  172.17.0.1:31441 rr</span><br><span class="line">  -&gt; 10.244.180.1:8443            Masq    1      0          0         </span><br><span class="line">TCP  192.168.13.177:30821 rr</span><br><span class="line">  -&gt; 10.244.166.155:80            Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.166.156:80            Masq    1      0          0         </span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>kube-proxy 这个组件将始终监视着 apiserver 中有关 service 资源的变动信息，需要跟 master 之上的 apiserver 交互，随时连接到 apiserver 上获取任何一个与 service 资源相关的资源变动状态，这种是通过 kubernetes 中固有的一种请求方法 watch（监视）来实现的，一旦有 service 资源的内容发生变动（如创建，删除），kube-proxy 都会将它转化成当前节点之上的能够实现 service 资源调度，把我们请求调度到后端特定的 pod 资源之上的规则，这个规则可能是 iptables，也可能是 ipvs，取决于 service 的实现方式。</p>
<p>k8s 在创建 Service 时，会根据标签选择器 selector (lable selector) 来查找 Pod，据此创建与 Service 同名的 endpoint 对象，当 Pod 地址发生变化时，endpoint 也会随之发生变化，service 接收前端 client 请求的时候，就会通过 endpoint，找到转发到哪个 Pod 进行访问的地址。(至于转发到哪个节点的 Pod，由负载均衡 kube-proxy 决定)</p>
<p><strong>kubernetes 集群中有三类 IP 地址</strong></p>
<p>1、Node Network（节点网络）：物理节点或者虚拟节点的网络，如 ens33 接口上的网路地址</p>
<p>2、Pod network（pod 网络），创建的 Pod 具有的 IP 地址<br>
 Node Network 和 Pod network 这两种网络地址是我们实实在在配置的，其中节点网络地址是配置在节点接口之上，而 pod 网络地址是配置在 pod 资源之上的，因此这些地址都是配置在某些设备之上的，这些设备可能是硬件，也可能是软件模拟的</p>
<p>3、Cluster Network（集群地址，也称为 service network），这个地址是虚拟的地址（virtual ip），没有配置在某个接口上，只是出现在 service 的规则当中。</p>
<p>三个网段不能冲突</p>
<p>–type=ClusterIP 集群内部访问</p>
<p>–type=NodePort  集群外也能访问</p>
<p>–type=ExternalName</p>
<p>–type=LoadBalancer</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@ ~]# kubectl explain service.spec.ports</span><br><span class="line">KIND:     Service</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: ports &lt;[]Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     The list of ports that are exposed by this service. More info:</span><br><span class="line">     https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies</span><br><span class="line">     ServicePort contains information on service&#x27;s port.</span><br><span class="line">FIELDS:</span><br><span class="line">   appProtocol	&lt;string&gt;</span><br><span class="line">   name	&lt;string&gt;  #定义端口的名字</span><br><span class="line">   nodePort	&lt;integer&gt;   #service在物理机映射的端口，默认在 30000-32767 之间</span><br><span class="line">   port	&lt;integer&gt; -required-  #service的端口，这个是k8s集群内部服务可访问的端口</span><br><span class="line">   protocol	&lt;string&gt;</span><br><span class="line">   targetPort	&lt;string&gt;</span><br><span class="line"># targetPort是pod上的端口，从port和nodePort上来的流量，经过kube-proxy流入到后端pod的targetPort上，最后进入容器。 </span><br></pre></td></tr></table></figure>
<h3 id="cluster-ip"><a class="markdownIt-Anchor" href="#cluster-ip">#</a> cluster-ip</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认的type类型</span></span><br><span class="line"><span class="comment"># 创建nginx的deployment</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: my-nginx</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        run: my-nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80  <span class="comment">#pod中的容器需要暴露的端口</span></span><br><span class="line">        startupProbe:</span><br><span class="line">           periodSeconds: 5</span><br><span class="line">           initialDelaySeconds: 60</span><br><span class="line">           timeoutSeconds: 10</span><br><span class="line">           httpGet:</span><br><span class="line">             scheme: HTTP</span><br><span class="line">             port: 80</span><br><span class="line">             path: /</span><br><span class="line">        livenessProbe:</span><br><span class="line">           periodSeconds: 5</span><br><span class="line">           initialDelaySeconds: 60</span><br><span class="line">           timeoutSeconds: 10</span><br><span class="line">           httpGet:</span><br><span class="line">             scheme: HTTP</span><br><span class="line">             port: 80</span><br><span class="line">             path: /</span><br><span class="line">        readinessProbe:</span><br><span class="line">           periodSeconds: 5</span><br><span class="line">           initialDelaySeconds: 60</span><br><span class="line">           timeoutSeconds: 10</span><br><span class="line">           httpGet:</span><br><span class="line">             scheme: HTTP</span><br><span class="line">             port: 80</span><br><span class="line">             path: /</span><br><span class="line">---           </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-nginx</span><br><span class="line">  labels:</span><br><span class="line">    run: my-nginx</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80   <span class="comment">#service的端口，暴露给k8s集群内部服务访问</span></span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80    <span class="comment">#pod容器中定义的端口</span></span><br><span class="line">  selector:</span><br><span class="line">    run: my-nginx  <span class="comment">#选择拥有run=my-nginx标签的pod</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl describe svc my-nginx </span></span><br><span class="line">Name:              my-nginx</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            run=my-nginx</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          run=my-nginx</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Families:       &lt;none&gt;</span><br><span class="line">IP:                10.96.60.147</span><br><span class="line">IPs:               10.96.60.147</span><br><span class="line">Port:              &lt;<span class="built_in">unset</span>&gt;  30080/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         10.244.166.180:80,10.244.166.181:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line">You have new mail <span class="keyword">in</span> /var/spool/mail/root</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl describe ep my-nginx </span></span><br><span class="line">Name:         my-nginx</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       run=my-nginx</span><br><span class="line">Annotations:  endpoints.kubernetes.io/last-change-trigger-time: 2023-05-10T12:28:47Z</span><br><span class="line">Subsets:</span><br><span class="line">  Addresses:          10.244.166.180,10.244.166.181</span><br><span class="line">  NotReadyAddresses:  &lt;none&gt;</span><br><span class="line">  Ports:</span><br><span class="line">    Name     Port  Protocol</span><br><span class="line">    ----     ----  --------</span><br><span class="line">    &lt;<span class="built_in">unset</span>&gt;  80    TCP</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line"><span class="comment"># 只能在集群内访问</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>service 只要创建完成，我们就可以直接解析它的服务名，每一个服务创建完成后都会在集群 dns 中动态添加一个资源记录，添加完成后我们就可以解析了，资源记录格式是：</p>
<p>SVC_NAME.NS_NAME.DOMAIN.LTD.<br>
 服务名。命名空间。域名后缀<br>
集群默认的域名后缀是 svc.cluster.local.</p>
<p>就像我们上面创建的 my-nginx 这个服务，它的完整名称解析就是<br>
 my-nginx.default.svc.cluster.local</p>
<p>这个域名只能 service 关联的 pod 内访问</p>
<p>使用就绪探测防止容器还没能提供服务就加入 endpoint 中，不能通过 service 访问</p>
<hr>
<p>pod 的发现与负载均衡</p>
<p>将一组 Pods 公开为网络服务的抽象方法。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl expose deploy my-dep --port=8000 --target-port=80  --type=ClusterIP</span></span><br><span class="line">service/my-dep exposed</span><br><span class="line">[root@master ~]<span class="comment"># kubectl delete service my-dep</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get service </span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod --show-labels </span></span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">my-dep-5b7868d854-29j5l   1/1     Running   0          21h   app=my-dep,pod-template-hash=5b7868d854</span><br><span class="line">my-dep-5b7868d854-67vg6   1/1     Running   0          21h   app=my-dep,pod-template-hash=5b7868d854</span><br><span class="line">my-dep-5b7868d854-9x4j8   1/1     Running   0          21h   app=my-dep,pod-template-hash=5b7868d854</span><br><span class="line">my-dep-5b7868d854-jtpbw   1/1     Running   0          21h   app=my-dep,pod-template-hash=5b7868d854</span><br><span class="line">my-dep-5b7868d854-nb4kn   1/1     Running   0          21h   app=my-dep,pod-template-hash=5b7868d854</span><br><span class="line"></span><br><span class="line">在集群内使用IP:port 可以实现负载均衡访问</span><br><span class="line"></span><br><span class="line">也可以使用svc域名直接访问，域名规则： 服务名.所在namespace.svc     只能在pod内使用域名访问</span><br><span class="line"></span><br><span class="line">curl my-dep.default.svc:8000</span><br><span class="line"></span><br><span class="line">root@my-dep-5b7868d854-nb4kn:/<span class="comment"># cat /etc/hosts </span></span><br><span class="line"><span class="comment"># Kubernetes-managed hosts file.</span></span><br><span class="line">127.0.0.1       localhost</span><br><span class="line">::1     localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">fe00::0 ip6-mcastprefix</span><br><span class="line">fe00::1 ip6-allnodes</span><br><span class="line">fe00::2 ip6-allrouters</span><br><span class="line">192.168.166.142 my-dep-5b7868d854-nb4kn</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-dep</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-dep</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-dep</span>      <span class="comment"># 选择标签</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230411140954966.png" alt="image-20230411140954966"></p>
<h3 id="nodeport"><a class="markdownIt-Anchor" href="#nodeport">#</a> NodePort</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx-nodeport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">my-nginx-nodeport</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">my-nginx-nodeport</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx-nodeport-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx-nodeport</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx-nodeport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30380</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx-nodeport</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get svc </span></span><br><span class="line"><span class="string">NAME</span>                <span class="string">TYPE</span>           <span class="string">CLUSTER-IP</span>      <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                         <span class="string">AGE</span></span><br><span class="line"><span class="string">my-nginx-nodeport</span>   <span class="string">NodePort</span>       <span class="number">10.96</span><span class="number">.152</span><span class="number">.128</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:30380/TCP</span>                    <span class="string">4s</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># ss -lntup | grep 30380</span></span><br><span class="line"><span class="string">tcp</span>    <span class="string">LISTEN</span>     <span class="number">0</span>      <span class="number">128</span>       <span class="string">*:30380</span>                 <span class="string">*:*</span>                   <span class="string">users:((&quot;kube-proxy&quot;,pid=14706,fd=10))</span></span><br><span class="line"><span class="string">会在每一个节点上监听这个端口</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get  ep </span></span><br><span class="line"><span class="string">NAME</span>                <span class="string">ENDPOINTS</span>                                                     <span class="string">AGE</span></span><br><span class="line"><span class="string">my-nginx-nodeport</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.184</span><span class="string">:80,10.244.166.185:80</span>                           <span class="string">5m2s</span></span><br><span class="line"></span><br><span class="line"><span class="string">curl节点中任何一个节点都能请求到</span></span><br><span class="line"></span><br><span class="line"><span class="string">客户端请求http://192.168.13.177:30380-&gt;docker0虚拟网卡:172.17.0.1:30380-&gt;</span> <span class="number">10.244</span><span class="number">.166</span><span class="number">.184</span><span class="string">:80,10.244.166.185:80</span>         </span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230411141906087.png" alt="image-20230411141906087"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl expose deploy my-dep --port=8000 --target-port=80 --type=NodePort</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get service </span></span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP          2d17h</span><br><span class="line">my-dep       NodePort    10.96.206.111   &lt;none&gt;        8000:32666/TCP   6m59s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用masterip或nodeip + 端口都可以访问</span></span><br><span class="line"><span class="comment"># 容器内部仍可以通过域名访问，主语端口还是原来的8000</span></span><br><span class="line"></span><br><span class="line">32666只是用于外部访问的端口，实现公网访问</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="externalname"><a class="markdownIt-Anchor" href="#externalname">#</a> externalName</h3>
<p>跨名称空间访问</p>
<p>需求：default 名称空间下的 client 服务想要访问 nginx-ns 名称空间下的 nginx-svc 服务</p>
<p>service 正常情况只能代理自己 ns 下面的 pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx-ns</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">   <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">   <span class="attr">spec:</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">       <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">       <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">     <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">     <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">     <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">   <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">   <span class="attr">spec:</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">       <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">       <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">       <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 36000&quot;</span>]</span><br><span class="line"><span class="meta">---    </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">client-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ExternalName</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">nginx-svc.nginx-ns.svc.cluster.local</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">wget</span> <span class="string">-q</span> <span class="string">-O</span> <span class="string">client-svc</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get svc </span></span><br><span class="line"><span class="string">NAME</span>              <span class="string">TYPE</span>           <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>                            <span class="string">PORT(S)</span>                         <span class="string">AGE</span></span><br><span class="line"><span class="string">client-svc</span>        <span class="string">ExternalName</span>   <span class="string">&lt;none&gt;</span>         <span class="string">nginx-svc.nginx-ns.svc.cluster.local</span>   <span class="number">80</span><span class="string">/TCP</span>                          <span class="string">15s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span>  <span class="string">client-76b6556d97-xk7mg</span> <span class="string">--</span> <span class="string">/bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># wget -q -O - client-svc</span></span><br><span class="line">    <span class="string">wget</span> <span class="string">-q</span> <span class="string">-O</span> <span class="bullet">-</span> <span class="string">nginx-svc.nginx-ns.svc.cluster.local</span></span><br><span class="line"><span class="string">上面两个请求的结果一样</span></span><br><span class="line"></span><br><span class="line"><span class="string">此时client-svc相当于</span> <span class="string">nginx-svc.nginx-ns.svc.cluster.local的软链，可以不使用名称空间直接访问软链的资源</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 映射外部服务</span></span><br><span class="line"><span class="comment"># k8s引用集群外的mysql</span></span><br><span class="line"><span class="comment"># 工作节点安装mysql</span></span><br><span class="line">https://zhuanlan.zhihu.com/p/623778183</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 没有selector找不到endpoint</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl describe svc mysql </span></span><br><span class="line">Name:              mysql</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            &lt;none&gt;</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          &lt;none&gt;</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Families:       &lt;none&gt;</span><br><span class="line">IP:                10.96.96.21</span><br><span class="line">IPs:               10.96.96.21</span><br><span class="line">Port:              &lt;<span class="built_in">unset</span>&gt;  3306/TCP</span><br><span class="line">TargetPort:        3306/TCP</span><br><span class="line">Endpoints:         &lt;none&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手动创建EP</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span> <span class="comment"># 和service name一致</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.199</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl describe svc mysql</span></span><br><span class="line"><span class="attr">Name:</span>              <span class="string">mysql</span></span><br><span class="line"><span class="attr">Namespace:</span>         <span class="string">default</span></span><br><span class="line"><span class="attr">Labels:</span>            <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Selector:</span>          <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Type:</span>              <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">IP Families:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">IP:</span>                <span class="number">10.96</span><span class="number">.159</span><span class="number">.210</span></span><br><span class="line"><span class="attr">IPs:</span>               <span class="number">10.96</span><span class="number">.159</span><span class="number">.210</span></span><br><span class="line"><span class="attr">Port:</span>              <span class="string">&lt;unset&gt;</span>  <span class="number">3306</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">TargetPort:</span>        <span class="number">3306</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">Endpoints:</span>         <span class="number">192.168</span><span class="number">.13</span><span class="number">.199</span><span class="string">:3306</span></span><br><span class="line"><span class="attr">Session Affinity:</span>  <span class="string">None</span></span><br><span class="line"><span class="attr">Events:</span>            <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="coredns"><a class="markdownIt-Anchor" href="#coredns">#</a> coredns</h3>
<p>CoreDNS 其实就是一个 DNS 服务，而 DNS 作为一种常见的服务发现手段，所以很多开源项目以及工程师都会使用 CoreDNS 为集群提供服务发现的功能，Kubernetes 就在集群中使用 CoreDNS 解决服务发现的问题。</p>
<p>service fqdn == service_name.namespace.svc.cluster.local</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dig</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dig</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">dig</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@</span>] <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">dig</span> <span class="string">--</span> <span class="string">nslookup</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">Server:</span>		<span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">Address:</span>	<span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span><span class="comment">#53</span></span><br><span class="line"><span class="attr">Name:</span>	<span class="string">kubernetes.default.svc.cluster.local</span></span><br><span class="line"><span class="attr">Address:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="string">在k8s中创建service之后，service默认的FQDN是&lt;servicename&gt;.&lt;namespace&gt;.svc.cluster.local，那么k8s集群内部的服务就可以通过FQDN访问</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">service</span>]<span class="comment"># kubectl get svc -n kube-system </span></span><br><span class="line"><span class="string">NAME</span>                 <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>       <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                  <span class="string">AGE</span></span><br><span class="line"><span class="string">kube-dns</span>             <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span>       <span class="string">&lt;none&gt;</span>        <span class="number">53</span><span class="string">/UDP,53/TCP,9153/TCP</span>   <span class="string">16d</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">service</span>]<span class="comment"># kubectl describe svc -n kube-system kube-dns </span></span><br><span class="line"><span class="attr">Name:</span>              <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">Namespace:</span>         <span class="string">kube-system</span></span><br><span class="line"><span class="attr">IP Families:</span>       <span class="string">IPv4</span></span><br><span class="line"><span class="attr">IP:</span>                <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">IPs:</span>               <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">Port:</span>              <span class="string">dns</span>  <span class="number">53</span><span class="string">/UDP</span></span><br><span class="line"><span class="attr">TargetPort:</span>        <span class="number">53</span><span class="string">/UDP</span></span><br><span class="line"><span class="attr">Endpoints:</span>         <span class="number">10.244</span><span class="number">.229</span><span class="number">.92</span><span class="string">:53,10.244.229.93:53</span></span><br><span class="line"><span class="attr">Port:</span>              <span class="string">dns-tcp</span>  <span class="number">53</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">TargetPort:</span>        <span class="number">53</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">Endpoints:</span>         <span class="number">10.244</span><span class="number">.229</span><span class="number">.92</span><span class="string">:53,10.244.229.93:53</span></span><br><span class="line"><span class="attr">Port:</span>              <span class="string">metrics</span>  <span class="number">9153</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">TargetPort:</span>        <span class="number">9153</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">Endpoints:</span>         <span class="number">10.244</span><span class="number">.229</span><span class="number">.92</span><span class="string">:9153,10.244.229.93:9153</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># coredns 实现service域名解析</span></span><br><span class="line"><span class="string">coredns-6d8c4cb4d-jmstd</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">5</span> <span class="string">(30h</span> <span class="string">ago)</span>     <span class="string">16d</span>     <span class="number">10.244</span><span class="number">.229</span><span class="number">.93</span>    <span class="string">prometheus-master</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">coredns-6d8c4cb4d-pg4sb</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">5</span> <span class="string">(30h</span> <span class="string">ago)</span>     <span class="string">16d</span>     <span class="number">10.244</span><span class="number">.229</span><span class="number">.92</span>    <span class="string">prometheus-master</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">coredns</span> <span class="string">也可以解析外部域名</span></span><br><span class="line">[<span class="string">root@xianchaomaster1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it dig -- nslookup www.baidu.com</span></span><br></pre></td></tr></table></figure>
<h2 id="ingress"><a class="markdownIt-Anchor" href="#ingress">#</a> ingress</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Service可以通过标签选择器找到它所关联的Pod。但是属于四层代理，只能基于IP和端口代理。</span></span><br><span class="line"></span><br><span class="line"><span class="string">Service的type类型有很多，如NodePort、clusterIp、loadbalancer、externalname，如果Service想要被k8s集群外部访问，需要用NodePort类型，但是NodePort类型的svc有如下几个问题：</span></span><br><span class="line"><span class="string">nodeport会在物理机映射一个端口，绑定到物理机上，这样就导致，每个服务都要映射一个端口，端口过多，维护困难，还有就是Service底层使用的是iptables或者ipvs，仅支持四层代理，无法基于https协议做代理，因此我们这节课讲解的是ingress-nginx-controller七层代理。</span></span><br><span class="line"></span><br><span class="line"><span class="string">四层负载和七层负载的区别：</span></span><br><span class="line"><span class="string">区别：</span></span><br><span class="line"><span class="number">1</span><span class="string">）四层负载：四层的负载均衡就是基于IP+端口的负载均衡：在三层负载均衡的基础上，通过发布三层的IP地址（VIP），然后加四层的端口号，来决定哪些流量需要做负载均衡，对需要处理的流量进行NAT处理，转发至后台服务器，并记录下这个TCP或者UDP的流量是由哪台服务器处理的，后续这个连接的所有流量都同样转发到同一台服务器处理。</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">）七层的负载均衡就是基于虚拟的URL或主机IP的负载均衡：在四层负载均衡的基础上（没有四层是绝对不可能有七层的），再考虑应用层的特征，比如同一个Web服务器的负载均衡，除了根据VIP加80端口辨别是否需要处理的流量，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。举个例子，如果你的Web服务器分成两组，一组是中文语言的，一组是英文语言的，那么七层负载均衡就可以当用户来访问你的域名时，自动辨别用户语言，然后选择对应的语言服务器组进行负载均衡处理。</span></span><br><span class="line"><span class="number">3</span><span class="string">）四层负载均衡工作在传输层，七层负载均衡工作在应用层</span></span><br><span class="line"></span><br><span class="line"><span class="string">ingress是k8s中的资源，主要是管理ingress-controller这个代理的配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="string">Ingress</span> <span class="string">Controller是一个七层负载均衡调度器，客户端的请求先到达这个七层负载均衡调度器，由七层负载均衡器在反向代理到后端pod，常见的七层负载均衡器有nginx、traefik，以我们熟悉的nginx为例，假如请求到达nginx，会通过upstream反向代理到后端pod应用，但是后端pod的ip地址是一直在变化的，因此在后端pod前需要加一个service，这个service只是起到分组的作用，那么我们upstream只需要填写service地址即可。</span></span><br><span class="line"></span><br><span class="line"><span class="string">ingress-controller封装的nginx，你ingress维护配置，ingress创建好之后，会自动的把配置文件传到ingress-controller这个pod里，会自动进行reload，然后配置就生效了。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（1）部署Ingress</span> <span class="string">controller，我们ingress</span> <span class="string">controller使用的是nginx</span></span><br><span class="line"><span class="string">（2）创建Pod应用，可以通过控制器创建pod</span></span><br><span class="line"><span class="string">（3）创建Service，用来分组pod</span></span><br><span class="line"><span class="string">（4）创建Ingress</span> <span class="string">http，测试通过http访问应用</span></span><br><span class="line"><span class="string">（5）创建Ingress</span> <span class="string">https，测试通过https访问应用</span></span><br><span class="line"><span class="string">客户端通过七层调度器访问后端pod的方式</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ingress 高可用</span></span><br><span class="line"><span class="string">Ingress</span> <span class="string">Controller是集群流量的接入层，对它做高可用非常重要，可以基于keepalive实现nginx-ingress-controller高可用，具体实现如下：</span></span><br><span class="line"><span class="string">Ingress-controller根据Deployment+</span> <span class="string">nodeSeletor+pod反亲和性方式部署在k8s指定的两个work节点，nginx-ingress-controller这个pod共享宿主机ip，然后通过keepalive+nginx实现nginx-ingress-controller高可用</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">ingress</span>]<span class="comment"># kubectl get pod -n ingress-nginx -owide </span></span><br><span class="line"><span class="string">NAME</span>                                        <span class="string">READY</span>   <span class="string">STATUS</span>      <span class="string">RESTARTS</span>   <span class="string">AGE</span>    <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">ingress-nginx-admission-create-g4qzz</span>        <span class="number">0</span><span class="string">/1</span>     <span class="string">Completed</span>   <span class="number">0</span>          <span class="string">8m2s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.180</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">ingress-nginx-admission-patch-r62tp</span>         <span class="number">0</span><span class="string">/1</span>     <span class="string">Completed</span>   <span class="number">1</span>          <span class="string">8m2s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.181</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">ingress-nginx-controller-6c8ffbbfcf-28tmg</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">0</span>          <span class="string">82s</span>    <span class="number">192.168</span><span class="number">.13</span><span class="number">.199</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># webhook报错</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-A</span> <span class="string">ValidatingWebhookConfiguration</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装nginx，keepalived，并修改配置，上传check_nginx.sh</span></span><br><span class="line"><span class="string">user</span> <span class="string">nginx;</span></span><br><span class="line"><span class="string">worker_processes</span> <span class="string">auto;</span></span><br><span class="line"><span class="string">error_log</span> <span class="string">/var/log/nginx/error.log;</span></span><br><span class="line"><span class="string">pid</span> <span class="string">/run/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include /usr/share/nginx/modules/*.conf;</span></span><br><span class="line"></span><br><span class="line"><span class="string">events</span> &#123;</span><br><span class="line">    <span class="string">worker_connections</span> <span class="number">1024</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 四层负载均衡，为两台Master apiserver组件提供负载均衡</span></span><br><span class="line"><span class="string">stream</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="string">log_format</span>  <span class="string">main</span>  <span class="string">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">access_log</span>  <span class="string">/var/log/nginx/k8s-access.log</span>  <span class="string">main;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">upstream</span> <span class="string">k8s-ingress-controller</span>&#123;</span><br><span class="line">       <span class="string">server</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.181</span><span class="string">:80</span> <span class="string">weight=5</span> <span class="string">max_fails=3</span> <span class="string">fail_timeout=30s;</span>   </span><br><span class="line">       <span class="string">server</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.182</span><span class="string">:80</span> <span class="string">weight=5</span> <span class="string">max_fails=3</span> <span class="string">fail_timeout=30s;</span>  </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">       <span class="string">listen</span> <span class="number">30080</span><span class="string">;</span> </span><br><span class="line">       <span class="string">proxy_pass</span> <span class="string">k8s-ingress-controller;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line">    <span class="string">log_format</span>  <span class="string">main</span>  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">access_log</span>  <span class="string">/var/log/nginx/access.log</span>  <span class="string">main;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">sendfile</span>            <span class="string">on;</span></span><br><span class="line">    <span class="string">tcp_nopush</span>          <span class="string">on;</span></span><br><span class="line">    <span class="string">tcp_nodelay</span>         <span class="string">on;</span></span><br><span class="line">    <span class="string">keepalive_timeout</span>   <span class="number">65</span><span class="string">;</span></span><br><span class="line">    <span class="string">types_hash_max_size</span> <span class="number">2048</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">include</span>             <span class="string">/etc/nginx/mime.types;</span></span><br><span class="line">    <span class="string">default_type</span>        <span class="string">application/octet-stream;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">enable</span> <span class="string">nginx</span> <span class="string">keepalived</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">start</span> <span class="string">nginx</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">start</span> <span class="string">keepalived</span></span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDU5MzI3NS9hcnRpY2xlL2RldGFpbHMvMTI2MzIyMDk5P3NwbT0xMDAxLjIxMDEuMzAwMS42NjUwLjcmYW1wO3V0bV9tZWRpdW09ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+QmxvZ0NvbW1lbmRGcm9tQmFpZHV+UmF0ZS03LTEyNjMyMjA5OS1ibG9nLTEwOTgxODIyMS5wY19yZWxldmFudF8zbW90aG5fc3RyYXRlZ3lfYW5kX2RhdGFfcmVjb3ZlcnkmYW1wO2RlcHRoXzEtdXRtX3NvdXJjZT1kaXN0cmlidXRlLnBjX3JlbGV2YW50Lm5vbmUtdGFzay1ibG9nLTJ+ZGVmYXVsdH5CbG9nQ29tbWVuZEZyb21CYWlkdX5SYXRlLTctMTI2MzIyMDk5LWJsb2ctMTA5ODE4MjIxLnBjX3JlbGV2YW50XzNtb3Robl9zdHJhdGVneV9hbmRfZGF0YV9yZWNvdmVyeSZhbXA7dXRtX3JlbGV2YW50X2luZGV4PTg=">(85 条消息) REK 安装 K8S 后，Ingress-nginx 一直状态为 ContainerCreating_ingress-nginx-controller 一直是 containercreating_Steady Ben 的博客 - CSDN 博客</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># http</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat</span><br><span class="line">    release: canary</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    port: 8080</span><br><span class="line">  - name: ajp</span><br><span class="line">    targetPort: 8009</span><br><span class="line">    port: 8009</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat</span><br><span class="line">      release: canary</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat</span><br><span class="line">        release: canary</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat</span><br><span class="line">        image: tomcat:9.0</span><br><span class="line">        imagePullPolicy: IfNotPresent  </span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">          name: ajp</span><br><span class="line">          containerPort: 8009</span><br><span class="line"></span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-myapp</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    #kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.shabi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          service:</span><br><span class="line">            name: tomcat</span><br><span class="line">            port: </span><br><span class="line">              number: 8080</span><br><span class="line">        path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line"></span><br><span class="line">[root@master1 ingress]# kubectl get ingress</span><br><span class="line">NAME            CLASS   HOSTS              ADDRESS          PORTS   AGE</span><br><span class="line">ingress-myapp   nginx   tomcat.shabi.com   192.168.13.199   80      3m29s</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># https</span><br><span class="line">openssl genrsa -out tls.key 2048</span><br><span class="line">openssl req -new -x509 -key tls.key -out tls.crt -subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=hhh.com</span><br><span class="line">kubectl create secret tls tomcat-ingress-secret --cert=tls.crt --key=tls.key</span><br><span class="line"></span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-tomcat-tls</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    -  tomcat.shabi.com</span><br><span class="line">    secretName: tomcat-ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: tomcat.shabi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType:  Prefix</span><br><span class="line">        backend:</span><br><span class="line">         service:</span><br><span class="line">           name: tomcat</span><br><span class="line">           port:</span><br><span class="line">            number: 8080</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ingress-实现业务发布"><a class="markdownIt-Anchor" href="#ingress-实现业务发布">#</a> ingress 实现业务发布</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">假设线上运行了一套对外提供 7 层服务的 Service A 服务，后来开发了个新版本 Service A’ 想要上线，但又不想直接替换掉原来的 Service A，希望先灰度一小部分用户，等运行一段时间足够稳定了再逐渐全量上线新版本，最后平滑下线旧版本。这个时候就可以利用 Nginx Ingress 基于 Header 或 Cookie 进行流量切分的策略来发布，业务使用 Header 或 Cookie 来标识不同类型的用户，我们通过配置 Ingress 来实现让带有指定 Header 或 Cookie 的请求被转发到新版本，其它的仍然转发到旧版本，从而实现将新版本灰度给部分用户:</span><br><span class="line"></span><br><span class="line">nginx.ingress.kubernetes.io/canary-by-header：基于Request Header的流量切分，适用于灰度发布以及 A/B 测试。当Request Header 设置为 always时，请求将会被一直发送到 Canary 版本；当 Request Header 设置为 never时，请求不会被发送到 Canary 入口。</span><br><span class="line"></span><br><span class="line">nginx.ingress.kubernetes.io/canary-by-header-value：要匹配的 Request Header 的值，用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务。当 Request Header 设置为此值时，它将被路由到 Canary 入口。</span><br><span class="line"></span><br><span class="line">nginx.ingress.kubernetes.io/canary-weight：基于服务权重的流量切分，适用于蓝绿部署，权重范围 0 - 100 按百分比将请求路由到 Canary Ingress 中指定的服务。权重为 0 意味着该金丝雀规则不会向 Canary 入口的服务发送任何请求。权重为60意味着60%流量转到canary。权重为 100 意味着所有请求都将被发送到 Canary 入口。</span><br><span class="line"></span><br><span class="line">nginx.ingress.kubernetes.io/canary-by-cookie：基于 Cookie 的流量切分，适用于灰度发布与 A/B 测试。用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务的cookie。当 cookie 值设置为 always时，它将被路由到 Canary 入口；当 cookie 值设置为 never时，请求不会被发送到 Canary 入口。</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">&quot;openresty/openresty:centos&quot;</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/local/openresty/nginx/conf/nginx.conf</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">nginx.conf</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">nginx.conf:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    worker_processes  1;</span></span><br><span class="line"><span class="string">    events &#123;</span></span><br><span class="line"><span class="string">        accept_mutex on;</span></span><br><span class="line"><span class="string">        multi_accept on;</span></span><br><span class="line"><span class="string">        use epoll;</span></span><br><span class="line"><span class="string">        worker_connections  1024;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    http &#123;</span></span><br><span class="line"><span class="string">        ignore_invalid_headers off;</span></span><br><span class="line"><span class="string">        server &#123;</span></span><br><span class="line"><span class="string">            listen 80;</span></span><br><span class="line"><span class="string">            location / &#123;</span></span><br><span class="line"><span class="string">                access_by_lua &#x27;</span></span><br><span class="line"><span class="string">                    local header_str = ngx.say(&quot;nginx-v1&quot;)</span></span><br><span class="line"><span class="string">                &#x27;;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">canary.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>  <span class="comment">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class="line">        <span class="attr">pathType:</span>  <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span>  <span class="comment">#配置后端服务</span></span><br><span class="line">         <span class="attr">service:</span></span><br><span class="line">           <span class="attr">name:</span> <span class="string">nginx-v1</span></span><br><span class="line">           <span class="attr">port:</span></span><br><span class="line">            <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line"><span class="string">curl</span> <span class="string">-H</span> <span class="string">&quot;Host: canary.example.com&quot;</span> <span class="string">http://192.168.13.199</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 基于 Header 的流量切分：</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: nginx</span><br><span class="line">    nginx.ingress.kubernetes.io/canary: &quot;true&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-header: &quot;Region&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/canary-by-header-pattern: &quot;cd|sz&quot;</span><br><span class="line">  name: nginx-canary</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: canary.example.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /  #配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span><br><span class="line">        pathType:  Prefix</span><br><span class="line">        backend:  #配置后端服务</span><br><span class="line">         service:</span><br><span class="line">           name: nginx-v2</span><br><span class="line">           port:</span><br><span class="line">            number: 80</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">curl -H &quot;Host: canary.example.com&quot; -H &quot;Region: cd&quot; http://192.168.13.199   //v2</span><br><span class="line">curl -H &quot;Host: canary.example.com&quot; -H &quot;Region: sz&quot; http://192.168.13.199   //v2</span><br><span class="line">curl -H &quot;Host: canary.example.com&quot; -H &quot;Region: cc&quot; http://192.168.13.199   //v1</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">基于</span> <span class="string">Cookie</span> <span class="string">的流量切分：</span></span><br><span class="line"><span class="string">与前面</span> <span class="string">Header</span> <span class="string">类似，不过使用</span> <span class="string">Cookie</span> <span class="string">就无法自定义</span> <span class="string">value</span> <span class="string">了，这里以模拟灰度成都地域用户为例，仅将带有名为</span> <span class="string">user_from_cd</span> <span class="string">的</span> <span class="string">cookie</span> <span class="string">的请求转发给当前</span> <span class="string">Canary</span> <span class="string">Ingress</span> <span class="string">。先删除前面基于</span> <span class="string">Header</span> <span class="string">的流量切分的</span> <span class="string">Canary</span> <span class="string">Ingress，然后创建下面新的</span> <span class="attr">Canary Ingress:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary-by-cookie:</span> <span class="string">&quot;user_from_cd&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">canary.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>  <span class="comment">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class="line">        <span class="attr">pathType:</span>  <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span>  <span class="comment">#配置后端服务</span></span><br><span class="line">         <span class="attr">service:</span></span><br><span class="line">           <span class="attr">name:</span> <span class="string">nginx-v2</span></span><br><span class="line">           <span class="attr">port:</span></span><br><span class="line">            <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-s</span> <span class="string">-H</span> <span class="string">&quot;Host: canary.example.com&quot;</span> <span class="string">--cookie</span> <span class="string">&quot;user_from_cd=always&quot;</span> <span class="string">http://192.168.13.199</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">基于服务权重的流量切分</span></span><br><span class="line"><span class="string">基于服务权重的</span> <span class="string">Canary</span> <span class="string">Ingress</span> <span class="string">就简单了，直接定义需要导入的流量比例，这里以导入</span> <span class="number">10</span><span class="string">%</span> <span class="string">流量到</span> <span class="string">v2</span> <span class="string">版本为例</span> <span class="string">(如果有，先删除之前的</span> <span class="string">Canary</span> <span class="string">Ingress):</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">canary.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>  <span class="comment">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class="line">        <span class="attr">pathType:</span>  <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span>  <span class="comment">#配置后端服务</span></span><br><span class="line">         <span class="attr">service:</span></span><br><span class="line">           <span class="attr">name:</span> <span class="string">nginx-v2</span></span><br><span class="line">           <span class="attr">port:</span></span><br><span class="line">            <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">            </span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..10</span>&#125;<span class="string">;</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-H</span> <span class="string">&quot;Host: canary.example.com&quot;</span> <span class="string">http://192.168.13.199;</span> <span class="string">done;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ingress service 的统一网关入口</span></span><br><span class="line"><span class="comment"># service pod的统一入口</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230411143640824.png" alt="image-20230411143640824"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ingress</span></span><br><span class="line"><span class="comment"># 使用如下yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/controller-serviceaccount.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">automountServiceAccountToken:</span> <span class="literal">true</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/controller-configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/clusterrole.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">networking.k8s.io</span>   <span class="comment"># k8s 1.14+</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">networking.k8s.io</span>   <span class="comment"># k8s 1.14+</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">networking.k8s.io</span>   <span class="comment"># k8s 1.14+</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressclasses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/clusterrolebinding.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/controller-role.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">networking.k8s.io</span>   <span class="comment"># k8s 1.14+</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">networking.k8s.io</span>   <span class="comment"># k8s 1.14+</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">networking.k8s.io</span>   <span class="comment"># k8s 1.14+</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressclasses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">resourceNames:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingress-controller-leader-nginx</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/controller-rolebinding.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/controller-service-webhook.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-controller-admission</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https-webhook</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">webhook</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/controller-service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/controller-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">minReadySeconds:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">controller</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/ingress-nginx-controller:v0.46.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">/wait-shutdown</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/nginx-ingress-controller</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--election-id=ingress-controller-leader</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--ingress-class=nginx</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--validating-webhook=:8443</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--validating-webhook-certificate=/usr/local/certificates/cert</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--validating-webhook-key=/usr/local/certificates/key</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">capabilities:</span></span><br><span class="line">              <span class="attr">drop:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">              <span class="attr">add:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">101</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LD_PRELOAD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/usr/local/lib/libmimalloc.so</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook-cert</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/usr/local/certificates/</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">90Mi</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webhook-cert</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/admission-webhooks/validating-webhook.yaml</span></span><br><span class="line"><span class="comment"># before changing this value, check the required kubernetes version</span></span><br><span class="line"><span class="comment"># https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#prerequisites</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingWebhookConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">admission-webhook</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">validate.nginx.ingress.kubernetes.io</span></span><br><span class="line">    <span class="attr">matchPolicy:</span> <span class="string">Equivalent</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">        <span class="attr">apiVersions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">v1beta1</span></span><br><span class="line">        <span class="attr">operations:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">CREATE</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">UPDATE</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">    <span class="attr">sideEffects:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">admissionReviewVersions:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">v1beta1</span></span><br><span class="line">    <span class="attr">clientConfig:</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">ingress-nginx-controller-admission</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/networking/v1beta1/ingresses</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/serviceaccount.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">helm.sh/hook:</span> <span class="string">pre-install,pre-upgrade,post-install,post-upgrade</span></span><br><span class="line">    <span class="attr">helm.sh/hook-delete-policy:</span> <span class="string">before-hook-creation,hook-succeeded</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">admission-webhook</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrole.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">helm.sh/hook:</span> <span class="string">pre-install,pre-upgrade,post-install,post-upgrade</span></span><br><span class="line">    <span class="attr">helm.sh/hook-delete-policy:</span> <span class="string">before-hook-creation,hook-succeeded</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">admission-webhook</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">admissionregistration.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">validatingwebhookconfigurations</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrolebinding.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">helm.sh/hook:</span> <span class="string">pre-install,pre-upgrade,post-install,post-upgrade</span></span><br><span class="line">    <span class="attr">helm.sh/hook-delete-policy:</span> <span class="string">before-hook-creation,hook-succeeded</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">admission-webhook</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/role.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">helm.sh/hook:</span> <span class="string">pre-install,pre-upgrade,post-install,post-upgrade</span></span><br><span class="line">    <span class="attr">helm.sh/hook-delete-policy:</span> <span class="string">before-hook-creation,hook-succeeded</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">admission-webhook</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/rolebinding.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">helm.sh/hook:</span> <span class="string">pre-install,pre-upgrade,post-install,post-upgrade</span></span><br><span class="line">    <span class="attr">helm.sh/hook-delete-policy:</span> <span class="string">before-hook-creation,hook-succeeded</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">admission-webhook</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/job-createSecret.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-admission-create</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">helm.sh/hook:</span> <span class="string">pre-install,pre-upgrade</span></span><br><span class="line">    <span class="attr">helm.sh/hook-delete-policy:</span> <span class="string">before-hook-creation,hook-succeeded</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">admission-webhook</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ingress-nginx-admission-create</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/component:</span> <span class="string">admission-webhook</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">docker.io/jettech/kube-webhook-certgen:v1.5.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--namespace=$(POD_NAMESPACE)</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--secret-name=ingress-nginx-admission</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">2000</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: ingress-nginx/templates/admission-webhooks/job-patch/job-patchWebhook.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx-admission-patch</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">helm.sh/hook:</span> <span class="string">post-install,post-upgrade</span></span><br><span class="line">    <span class="attr">helm.sh/hook-delete-policy:</span> <span class="string">before-hook-creation,hook-succeeded</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">admission-webhook</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ingress-nginx-admission-patch</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.33.0</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.47</span><span class="number">.0</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/component:</span> <span class="string">admission-webhook</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">patch</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">docker.io/jettech/kube-webhook-certgen:v1.5.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--webhook-name=ingress-nginx-admission</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--namespace=$(POD_NAMESPACE)</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--patch-mutating=false</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--secret-name=ingress-nginx-admission</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--patch-failure-policy=Fail</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">ingress-nginx-admission</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">2000</span></span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="创建ingress"><a class="markdownIt-Anchor" href="#创建ingress">#</a> 创建 ingress</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl apply -f ingress.yml</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get service -A </span></span><br><span class="line">NAMESPACE              NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">calico-system          calico-typha                         ClusterIP   10.96.222.97    &lt;none&gt;        5473/TCP                     2d17h</span><br><span class="line">default                kubernetes                           ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP                      2d17h</span><br><span class="line">default                my-dep                               NodePort    10.96.206.111   &lt;none&gt;        8000:32666/TCP               22m</span><br><span class="line">ingress-nginx          ingress-nginx-controller             NodePort    10.96.18.49     &lt;none&gt;        80:31625/TCP,443:31507/TCP   112s</span><br><span class="line">ingress-nginx          ingress-nginx-controller-admission   ClusterIP   10.96.19.25     &lt;none&gt;        443/TCP                      112s</span><br><span class="line"></span><br><span class="line">ingress 就是一个nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https://139.198.179.44:31507/</span><br><span class="line">http://139.198.179.44:31625</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ingress.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hello-server</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hello-server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hello-server</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/hello-server</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9000</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-demo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-demo</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-demo</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-demo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-demo</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">hello-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">hello-server</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IkY5LU9Jc0pnblNNOVJhM1dlWVl6c09DTjNnbFNQa1hzcWhOSThHVENEdlUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXp3NmRzIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJkOTRmMDZlNi1kNTkxLTRmMzktODMxNC0zNzI2MDVhM2RkN2MiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.TMTc8QDTIo3qhsGTYD05c8txOyq2op7xW9ZQB5ICVw5x4fg-L0iUnn1jGyo4REP6ci63zBR-xmirqHy1eQ5GgT1nwGZnv4oKqNElm8-wkAit5rEgVN7ATo5GN3VrRQgNyBsHwqFhe1SsrK47flCZcmBvWbgmU4ugFfrNZ8xHkSURKrLAPUPjsYUC6ugyrEMqfwhcxzMiZcSKxG20jjLgVK7Pd_T01NAObUb_lCjq7mrEV0KdHcYTtSYwVwV88mTu5vwb39k-10V0s6HOqiDx87lp7fPtctrcR3mRiT1PkEvsyhCb8qAuFDPuaJZtESFu2dCXP_fVmv5g7AhSO_qUHg</span><br></pre></td></tr></table></figure>
<h3 id="域名访问"><a class="markdownIt-Anchor" href="#域名访问">#</a> 域名访问</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span>  </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-host-bar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&quot;hello.atguigu.com&quot;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">hello-server</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8000</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&quot;demo.atguigu.com&quot;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/nginx&quot;</span>  <span class="comment"># 把请求会转给下面的服务，下面的服务一定要能处理这个路径，不能处理就是404</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-demo</span>  <span class="comment">## java，比如使用路径重写，去掉前缀nginx</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8000</span></span><br></pre></td></tr></table></figure>
<h3 id="路径重写"><a class="markdownIt-Anchor" href="#路径重写">#</a> 路径重写</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span>  </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-host-bar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&quot;hello.atguigu.com&quot;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">hello-server</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8000</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&quot;demo.atguigu.com&quot;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/nginx(/|$)(.*)&quot;</span>  <span class="comment"># 把请求会转给下面的服务，下面的服务一定要能处理这个路径，不能处理就是404</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-demo</span>  <span class="comment">## java，比如使用路径重写，去掉前缀nginx</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8000</span></span><br></pre></td></tr></table></figure>
<h3 id="流量限制"><a class="markdownIt-Anchor" href="#流量限制">#</a> 流量限制</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-limit-rate</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/limit-rps:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&quot;haha.atguigu.com&quot;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Exact</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-demo</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8000</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230411153649369.png" alt="image-20230411153649369"></p>
<h2 id="存储抽象"><a class="markdownIt-Anchor" href="#存储抽象">#</a> 存储抽象</h2>
<p>在 k8s 中部署的应用都是以 pod 容器的形式运行的，假如我们部署 MySQL、Redis 等数据库，需要对这些数据库产生的数据做备份。因为 Pod 是有生命周期的，如果 pod 不挂载数据卷，那 pod 被删除或重启后这些数据会随之消失，如果想要长久的保留这些数据就要用到 pod 数据持久化存储。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl explain pod.spec.volumes</span></span><br><span class="line">   awsElasticBlockStore	&lt;Object&gt;</span><br><span class="line">   azureDisk	&lt;Object&gt;</span><br><span class="line">   azureFile	&lt;Object&gt;</span><br><span class="line">   cephfs	&lt;Object&gt;</span><br><span class="line">   cinder	&lt;Object&gt;</span><br><span class="line">   configMap	&lt;Object&gt;</span><br><span class="line">   csi	&lt;Object&gt;</span><br><span class="line">   downwardAPI	&lt;Object&gt;</span><br><span class="line">   emptyDir	&lt;Object&gt;</span><br><span class="line">   ephemeral	&lt;Object&gt;</span><br><span class="line">   <span class="built_in">fc</span>	&lt;Object&gt;</span><br><span class="line">   flexVolume	&lt;Object&gt;</span><br><span class="line">   flocker	&lt;Object&gt;</span><br><span class="line">   gcePersistentDisk	&lt;Object&gt;</span><br><span class="line">   gitRepo	&lt;Object&gt;</span><br><span class="line">   glusterfs	&lt;Object&gt;</span><br><span class="line">   hostPath	&lt;Object&gt;</span><br><span class="line">   iscsi	&lt;Object&gt;</span><br><span class="line">   name	&lt;string&gt; -required-</span><br><span class="line">   nfs	&lt;Object&gt;</span><br><span class="line">   persistentVolumeClaim	&lt;Object&gt;</span><br><span class="line">   photonPersistentDisk	&lt;Object&gt;</span><br><span class="line">   portworxVolume	&lt;Object&gt;</span><br><span class="line">   projected	&lt;Object&gt;</span><br><span class="line">   quobyte	&lt;Object&gt;</span><br><span class="line">   rbd	&lt;Object&gt;</span><br><span class="line">   scaleIO	&lt;Object&gt;</span><br><span class="line">   secret	&lt;Object&gt;</span><br><span class="line">   storageos	&lt;Object&gt;</span><br><span class="line">   vsphereVolume	&lt;Object&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>常用的如下：<br>
emptyDir 临时目录<br>
 hostPath<br>
nfs<br>
persistentVolumeClaim<br>
glusterfs<br>
cephfs<br>
configMap<br>
secret</p>
<p>我们想要使用存储卷，需要经历如下步骤</p>
<p>1、定义 pod 的 volume，这个 volume 指明它要关联到哪个存储上的</p>
<p>2、在容器中要使用 volumemounts 挂载对应的存储</p>
<h3 id="emptydir"><a class="markdownIt-Anchor" href="#emptydir">#</a> emptydir</h3>
<p>emptyDir 类型的 Volume 是在 Pod 分配到 Node 上时被创建，Kubernetes 会在 Node 上自动分配一个目录，因此无需指定宿主机 Node 上对应的目录文件。 这个目录的初始内容为空，当 Pod 从 Node 上移除时，emptyDir 中的数据会被永久删除。emptyDir Volume 主要用于某些应用程序无需永久保存的临时目录，多个容器的共享目录等。</p>
<p>emptyDir 的一些用途:</p>
<p>缓存空间，例如基于磁盘的归并排序。</p>
<p>为耗时较长的计算任务提供检查点，以便任务能方便地从崩溃前状态恢复执行。</p>
<p>在 Web 服务器容器服务数据时，保存内容管理器容器获取的文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-emptydir</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">container-emptydir</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [root@master1 ~]# kubectl describe pod pod-emptydir </span></span><br><span class="line"><span class="attr">Name:</span>         <span class="string">pod-emptydir</span></span><br><span class="line"><span class="attr">Namespace:</span>    <span class="string">default</span></span><br><span class="line"><span class="attr">Node:</span>         <span class="string">node1/192.168.13.199</span></span><br><span class="line"><span class="attr">Start Time:</span>   <span class="string">Thu,</span> <span class="number">18</span> <span class="string">May</span> <span class="number">2023 14:15:22</span> <span class="string">+0800</span></span><br><span class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Status:</span>       <span class="string">Running</span></span><br><span class="line"><span class="attr">IP:</span>           <span class="number">10.244</span><span class="number">.166</span><span class="number">.189</span></span><br><span class="line"><span class="attr">IPs:</span></span><br><span class="line">  <span class="attr">IP:</span>  <span class="number">10.244</span><span class="number">.166</span><span class="number">.189</span></span><br><span class="line"><span class="attr">Containers:</span></span><br><span class="line">  <span class="attr">container-emptydir:</span></span><br><span class="line">    <span class="attr">Container ID:</span>   <span class="string">docker://4496b67a7a687a878e8f644d2064e45e6a1356cb7fc84b98093d6d37bb281a2a</span></span><br><span class="line">    <span class="attr">Image:</span>          <span class="string">nginx</span></span><br><span class="line">    <span class="attr">Image ID:</span>       <span class="string">docker-pullable://nginx@sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31</span></span><br><span class="line">    <span class="attr">Port:</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line">    <span class="attr">Host Port:</span>      <span class="string">&lt;none&gt;</span></span><br><span class="line">    <span class="attr">State:</span>          <span class="string">Running</span></span><br><span class="line">      <span class="attr">Started:</span>      <span class="string">Thu,</span> <span class="number">18</span> <span class="string">May</span> <span class="number">2023 14:15:24</span> <span class="string">+0800</span></span><br><span class="line">    <span class="attr">Ready:</span>          <span class="literal">True</span></span><br><span class="line">    <span class="attr">Restart Count:</span>  <span class="number">0</span></span><br><span class="line">    <span class="attr">Environment:</span>    <span class="string">&lt;none&gt;</span></span><br><span class="line">    <span class="attr">Mounts:</span></span><br><span class="line">      <span class="string">/cache</span> <span class="string">from</span> <span class="string">cache-volume</span> <span class="string">(rw)</span></span><br><span class="line">      <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span> <span class="string">from</span> <span class="string">default-token-sc5zb</span> <span class="string">(ro)</span></span><br><span class="line"><span class="attr">Volumes:</span></span><br><span class="line">  <span class="attr">cache-volume:</span></span><br><span class="line">    <span class="attr">Type:</span>       <span class="string">EmptyDir</span> <span class="string">(a</span> <span class="string">temporary</span> <span class="string">directory</span> <span class="string">that</span> <span class="string">shares</span> <span class="string">a</span> <span class="string">pod&#x27;s</span> <span class="string">lifetime)</span></span><br><span class="line">    <span class="attr">Medium:</span>     </span><br><span class="line">    <span class="attr">SizeLimit:</span>  <span class="string">&lt;unset&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># emptydir 会在宿主机上创建一个名字为pod uid的临时目录，pod被调度到的节点都会创建这个目录</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pod pod-emptydir -oyaml | grep uid</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">d952eb75-575e-4bf3-b08f-c7faed4f4bbd</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@node1</span> <span class="string">~</span>]<span class="comment"># tree /var/lib/kubelet/pods/d952eb75-575e-4bf3-b08f-c7faed4f4bbd</span></span><br><span class="line"><span class="string">/var/lib/kubelet/pods/d952eb75-575e-4bf3-b08f-c7faed4f4bbd</span></span><br><span class="line"><span class="string">├──</span> <span class="string">containers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">container-emptydir</span></span><br><span class="line"><span class="string">│</span>       <span class="string">└──</span> <span class="number">21760842</span></span><br><span class="line"><span class="string">├──</span> <span class="string">etc-hosts</span></span><br><span class="line"><span class="string">├──</span> <span class="string">plugins</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">kubernetes.io~empty-dir</span></span><br><span class="line"><span class="string">│</span>       <span class="string">├──</span> <span class="string">cache-volume</span></span><br><span class="line"><span class="string">│</span>       <span class="string">│</span>   <span class="string">└──</span> <span class="string">ready</span></span><br><span class="line"><span class="string">│</span>       <span class="string">└──</span> <span class="string">wrapped_default-token-sc5zb</span></span><br><span class="line"><span class="string">│</span>           <span class="string">└──</span> <span class="string">ready</span></span><br><span class="line"><span class="string">└──</span> <span class="string">volumes</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">kubernetes.io~empty-dir</span></span><br><span class="line">    <span class="string">│</span>   <span class="string">└──</span> <span class="string">cache-volume</span>   <span class="comment"># pod内部文件存储路径  </span></span><br><span class="line">    <span class="string">└──</span> <span class="string">kubernetes.io~secret</span></span><br><span class="line">        <span class="string">└──</span> <span class="string">default-token-sc5zb</span></span><br><span class="line">            <span class="string">├──</span> <span class="string">ca.crt</span> <span class="string">-&gt;</span> <span class="string">..data/ca.crt</span></span><br><span class="line">            <span class="string">├──</span> <span class="string">namespace</span> <span class="string">-&gt;</span> <span class="string">..data/namespace</span></span><br><span class="line">            <span class="string">└──</span> <span class="string">token</span> <span class="string">-&gt;</span> <span class="string">..data/token</span></span><br><span class="line"></span><br><span class="line"><span class="number">11</span> <span class="string">directories,</span> <span class="number">7</span> <span class="string">files</span></span><br></pre></td></tr></table></figure>
<h3 id="hostpath"><a class="markdownIt-Anchor" href="#hostpath">#</a> hostpath</h3>
<p>hostPath Volume 是指 Pod 挂载宿主机上的目录或文件。 hostPath Volume 使得容器可以使用宿主机的文件系统进行存储，hostpath（宿主机路径）：节点级别的存储卷，在 pod 被删除，这个存储卷还是存在的，不会被删除，所以只要同一个 pod 被调度到同一个节点上来，在 pod 被删除重新被调度到这个节点之后，对应的数据依然是存在的。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-hostpath</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/test-nginx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat:9.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/test-tomcat</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it test-hostpath -c test-nginx -- /bin/bash </span></span><br><span class="line"><span class="string">root@test-hostpath:/#</span> <span class="string">cd</span> <span class="string">/test-nginx/</span></span><br><span class="line"></span><br><span class="line"><span class="string">https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/</span></span><br><span class="line"></span><br><span class="line"><span class="string">不会删除宿主机目录，但是如果调度到不同node还是会丢失数据</span> <span class="attr">nodeName:</span> <span class="string">node2</span></span><br></pre></td></tr></table></figure>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230518151050405.png" alt="image-20230518151050405" style="zoom:150%;" /> 
<p>可以用分布式存储：</p>
<p>nfs，cephfs，glusterfs</p>
<h3 id="nfs"><a class="markdownIt-Anchor" href="#nfs">#</a> nfs</h3>
<p>NFS：网络文件系统，英文 Network File System (NFS)，是由 SUN 公司研制的 UNIX 表示层协议 (presentation layer protocol)，能使使用者访问网络上别处的文件就像在使用自己的计算机一样。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># yum install nfs-utils -y</span></span><br><span class="line"><span class="comment">#在宿主机创建NFS需要的共享目录</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># mkdir /data/volumes -pv </span></span><br><span class="line"><span class="attr">mkdir:</span> <span class="string">created</span> <span class="string">directory</span> <span class="string">‘/data’</span></span><br><span class="line"><span class="attr">mkdir:</span> <span class="string">created</span> <span class="string">directory</span> <span class="string">‘/data/volumes’</span></span><br><span class="line"><span class="comment">#配置nfs共享服务器上的/data/volumes目录</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># systemctl start nfs</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim /etc/exports</span></span><br><span class="line"><span class="string">/data/volumes</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="comment">#rw 该主机对该共享目录有读写权限</span></span><br><span class="line"><span class="comment"># no_root_squash 登入 NFS 主机使用分享目录的使用者，如果是 root 的话，那么对于这个分享的目录来说，他就具有 root 的权限</span></span><br><span class="line"><span class="string">exportfs</span> <span class="string">-avr</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># service nfs restart</span></span><br><span class="line"><span class="comment">#设置成开机自启动</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># systemctl enable nfs</span></span><br><span class="line"><span class="comment">#查看nfs是否启动成功</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># systemctl status nfs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#node2和node1上也安装nfs驱动</span></span><br><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">nfs-utils</span> <span class="string">-y</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">enable</span>  <span class="string">nfs</span> <span class="string">–now</span></span><br><span class="line"><span class="comment"># node节点测试</span></span><br><span class="line"><span class="string">showmount</span> <span class="string">-e</span> </span><br><span class="line"><span class="string">mount</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.177</span><span class="string">:/data/volumes</span> <span class="string">/test/</span></span><br><span class="line"><span class="string">df</span> <span class="string">-h</span></span><br><span class="line"><span class="string">umount</span> <span class="string">/test</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">cunchu:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">cunchu:</span> <span class="string">nfs</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">test-nfs</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-volumes</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-volumes</span></span><br><span class="line">        <span class="attr">nfs:</span></span><br><span class="line">          <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.177</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/data/volumes</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># cd /data/volumes/</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">volumes</span>]<span class="comment"># vim index.html</span></span><br><span class="line"><span class="string">&lt;h1&gt;woshishabi&lt;h1&gt;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">volumes</span>]<span class="comment"># curl 10.244.166.191</span></span><br><span class="line"><span class="string">&lt;h1&gt;woshishabi&lt;/h1&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">删除pod，pod重新创建后仍然存在挂载目录中的内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#上面说明挂载nfs存储卷成功了，nfs支持多个客户端挂载，可以创建多个pod，挂载同一个nfs服务器共享出来的目录；但是nfs如果宕机了，数据也就丢失了，所以需要使用分布式存储，常见的分布式存储有glusterfs和cephfs</span></span><br></pre></td></tr></table></figure>
<p>假设我们使用 nfs 作为存储层</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装nfs</span></span><br><span class="line">yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主节点</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot;</span> &gt; /etc/exports</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /nfs/data</span><br><span class="line">systemctl <span class="built_in">enable</span> rpcbind --now</span><br><span class="line">systemctl <span class="built_in">enable</span> nfs-server --now</span><br><span class="line"><span class="comment">#配置生效</span></span><br><span class="line">exportfs -r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从节点</span></span><br><span class="line">showmount -e 172.31.0.4</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行以下命令挂载 nfs 服务器上的共享目录到本机路径 /root/nfsmount</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /nfs/data</span><br><span class="line"></span><br><span class="line">mount -t nfs 172.31.0.4:/nfs/data /nfs/data</span><br><span class="line"><span class="comment"># 写入一个测试文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello nfs server&quot;</span> &gt; /nfs/data/test.txt</span><br></pre></td></tr></table></figure>
<h3 id="原生方式挂载"><a class="markdownIt-Anchor" href="#原生方式挂载">#</a> 原生方式挂载</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-pv-demo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pv-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pv-demo</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pv-demo</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs/data/nginx-pv</span></span><br></pre></td></tr></table></figure>
<h3 id="持久卷"><a class="markdownIt-Anchor" href="#持久卷">#</a> 持久卷</h3>
<p>PV：持久卷（Persistent Volume），将应用需要持久化的数据保存到指定位置</p>
<p>PVC：持久卷申明（<strong>Persistent Volume Claim</strong>），申明需要使用的持久卷规格</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">PersistentVolume（PV）是群集中的一块存储，由管理员配置或使用存储类动态配置。 它是集群中的资源，就像pod是k8s集群资源一样。 PV是容量插件，如Volumes，其生命周期独立于使用PV的任何单个pod。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PersistentVolumeClaim（PVC）是一个持久化存储卷，我们在创建pod时可以定义这个类型的存储卷。 它类似于一个pod。 Pod消耗节点资源，PVC消耗PV资源。 Pod可以请求特定级别的资源（CPU和内存）。 pvc在申请pv的时候也可以请求特定的大小和访问模式（例如，可以一次读写或多次只读）。</span><br><span class="line"></span><br><span class="line">PV是群集中的资源。 PVC是对这些资源的请求。 </span><br><span class="line">PV和PVC之间的相互作用遵循以下生命周期：</span><br><span class="line"></span><br><span class="line">（1）pv的供应方式</span><br><span class="line">可以通过两种方式配置PV：静态或动态。</span><br><span class="line"></span><br><span class="line">静态的：</span><br><span class="line">集群管理员创建了许多PV。它们包含可供群集用户使用的实际存储的详细信息。它们存在于Kubernetes API中，可供使用。</span><br><span class="line"></span><br><span class="line">动态的：</span><br><span class="line">当管理员创建的静态PV都不匹配用户的PersistentVolumeClaim时，群集可能会尝试为PVC专门动态配置卷。此配置基于StorageClasses，PVC必须请求存储类，管理员必须创建并配置该类，以便进行动态配置。</span><br><span class="line"></span><br><span class="line">（2）绑定</span><br><span class="line">用户创建pvc并指定需要的资源和访问模式。在找到可用pv之前，pvc会保持未绑定状态</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">（3）使用</span><br><span class="line">a）需要找一个存储服务器，把它划分成多个存储空间；</span><br><span class="line">b）k8s管理员可以把这些存储空间定义成多个pv；</span><br><span class="line">c）在pod中使用pvc类型的存储卷之前需要先创建pvc，通过定义需要使用的pv的大小和对应的访问模式，找到合适的pv；</span><br><span class="line">d）pvc被创建之后，就可以当成存储卷来使用了，我们在定义pod时就可以使用这个pvc的存储卷</span><br><span class="line">e）pvc和pv它们是一一对应的关系，pv如果被pvc绑定了，就不能被其他pvc使用了；</span><br><span class="line">f）我们在创建pvc的时候，应该确保和底下的pv能绑定，如果没有合适的pv，那么pvc就会处于pending状态。</span><br><span class="line"></span><br><span class="line">（4）回收策略</span><br><span class="line">当我们创建pod时如果使用pvc做为存储卷，那么它会和pv绑定，当删除pod，pvc和pv绑定就会解除，解除之后和pvc绑定的pv卷里的数据需要怎么处理，目前，卷可以保留，回收或删除：</span><br><span class="line">Retain</span><br><span class="line">Recycle （不推荐使用，1.15可能被废弃了）</span><br><span class="line">Delete</span><br><span class="line">1、Retain</span><br><span class="line">当删除pvc的时候，pv仍然存在，处于released状态，但是它不能被其他pvc绑定使用，里面的数据还是存在的，当我们下次再使用的时候，数据还是存在的，这个是默认的回收策略</span><br><span class="line"> </span><br><span class="line">Delete</span><br><span class="line">删除pvc时即会从Kubernetes中移除PV，也会从相关的外部设施中删除存储资产</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mkdir</span> <span class="string">/data/volume_test/v&#123;1,2,3,4,5,6,7,8,9,10&#125;</span> <span class="string">-p</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">/etc/exports</span></span><br><span class="line"><span class="string">/data/volume_test/v1</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/volume_test/v2</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/volume_test/v3</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/volume_test/v4</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/volume_test/v5</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/volume_test/v6</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/volume_test/v7</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/volume_test/v8</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/volume_test/v9</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/volume_test/v10</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"></span><br><span class="line"><span class="string">exportfs</span> <span class="string">-arv</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.177</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span> </span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.177</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadOnlyMany&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span> </span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v3</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">v3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v3</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.177</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span> </span><br><span class="line">    <span class="attr">storage:</span> <span class="string">3Gi</span>  </span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">RWO：readwariteonce:</span>  <span class="string">单路读写，允许同一个node节点上的pod访问</span></span><br><span class="line"><span class="string">ROX：</span> <span class="attr">readonlymany:</span>    <span class="string">多路只读，允许不同node节点的pod以只读方式访问</span></span><br><span class="line"><span class="string">RWX：</span> <span class="attr">readwritemany:</span>  <span class="string">多路读写，允许不同的node节点的pod以读写方式访问</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pv</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>   <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">v1</span>     <span class="string">1Gi</span>        <span class="string">RWO</span>            <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">9m1s</span></span><br><span class="line"><span class="string">v2</span>     <span class="string">2Gi</span>        <span class="string">ROX</span>            <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">9m1s</span></span><br><span class="line"><span class="string">v3</span>     <span class="string">3Gi</span>        <span class="string">RWX</span>            <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">9m1s</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span> </span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadOnlyMany&quot;</span>]</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span> </span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-v3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">v3</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span> </span><br><span class="line">      <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pvc </span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">STATUS</span>   <span class="string">VOLUME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">STORAGECLASS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pvc-v1</span>   <span class="string">Bound</span>    <span class="string">v1</span>       <span class="string">1Gi</span>        <span class="string">RWO</span>                           <span class="string">3m13s</span></span><br><span class="line"><span class="string">pvc-v2</span>   <span class="string">Bound</span>    <span class="string">v2</span>       <span class="string">2Gi</span>        <span class="string">ROX</span>                           <span class="string">43s</span></span><br><span class="line"><span class="string">pvc-v3</span>   <span class="string">Bound</span>    <span class="string">v3</span>       <span class="string">3Gi</span>        <span class="string">RWX</span>                           <span class="string">43s</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">cunchu:</span> <span class="string">pvc</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">cunchu:</span> <span class="string">pvc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">test-nfs</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-html</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">pvc-v1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-html</span></span><br><span class="line">        </span><br><span class="line"><span class="number">1</span><span class="string">、我们每次创建pvc的时候，需要事先有划分好的pv，这样可能不方便，那么可以在创建pvc的时候直接动态创建一个pv这个存储类，pv事先是不存在的</span></span><br><span class="line"><span class="number">2</span><span class="string">、pvc和pv绑定，如果使用默认的回收策略retain，那么删除pvc之后，pv会处于released状态，我们想要继续使用这个pv，需要手动删除pv，kubectl</span> <span class="string">delete</span> <span class="string">pv</span> <span class="string">pv_name，删除pv，不会删除pv里的数据，当我们重新创建pvc时还会和这个最匹配的pv绑定，数据还是原来数据，不会丢失。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">删除pvc的步骤：</span></span><br><span class="line"><span class="string">需要先删除使用pvc的pod</span></span><br><span class="line"><span class="string">再删除pvc</span></span><br><span class="line"></span><br><span class="line"><span class="string">回收策略为retain，删除pvc，pv状态release，需要删除pv重新创建才能为bound状态</span></span><br><span class="line"><span class="string">Delete策略，删除pvc，pv状态Failed</span></span><br><span class="line"></span><br><span class="line"><span class="string">Delete策略，删除pv后端存储所用的数据目录不会被删除，与回收策略无关</span></span><br></pre></td></tr></table></figure>
<p>创建 pv</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv01-10m</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10M</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs/data/01</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv02-1gi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs/data/02</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv03-3gi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs/data/03</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl get persistentvolume</span></span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">pv01-10m   10M        RWX            Retain           Available           nfs                     59s</span><br><span class="line">pv02-1gi   1Gi        RWX            Retain           Available           nfs                     59s</span><br><span class="line">pv03-3gi   3Gi        RWX            Retain           Available           nfs                     59s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>创建 pvc</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">200Mi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl get pv </span></span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="line">pv01-10m   10M        RWX            Retain           Available                       nfs                     3m48s</span><br><span class="line">pv02-1gi   1Gi        RWX            Retain           Bound       default/nginx-pvc   nfs                     3m48s</span><br><span class="line">pv03-3gi   3Gi        RWX            Retain           Available                       nfs                     3m48s</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME        STATUS   VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">nginx-pvc   Bound    pv02-1gi   1Gi        RWX            nfs            107s</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建dep时挂载</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-deploy-pvc</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deploy-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-deploy-pvc</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-deploy-pvc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">nginx-pvc</span></span><br></pre></td></tr></table></figure>
<h3 id="storageclass"><a class="markdownIt-Anchor" href="#storageclass">#</a> storageclass</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">上面介绍的PV和PVC模式都是需要先创建好PV，然后定义好PVC和pv进行一对一的Bond，但是如果PVC请求成千上万，那么就需要创建成千上万的PV，对于运维人员来说维护成本很高，Kubernetes提供一种自动创建PV的机制，叫StorageClass，它的作用就是创建PV的模板。k8s集群管理员通过创建storageclass可以动态生成一个存储卷pv供k8s</span> <span class="string">pvc使用。</span></span><br><span class="line"></span><br><span class="line"><span class="string">每个StorageClass都包含字段provisioner，parameters和reclaimPolicy。</span> </span><br><span class="line"></span><br><span class="line"><span class="string">具体来说，StorageClass会定义以下两部分：</span></span><br><span class="line"><span class="number">1</span><span class="string">、PV的属性</span> <span class="string">，比如存储的大小、类型等；</span></span><br><span class="line"><span class="number">2</span><span class="string">、创建这种PV需要使用到的存储插件，比如Ceph、NFS等</span></span><br><span class="line"></span><br><span class="line"><span class="string">有了这两部分信息，Kubernetes就能够根据用户提交的PVC，找到对应的StorageClass，然后Kubernetes就会调用</span> <span class="string">StorageClass声明的存储插件，创建出需要的PV。</span></span><br><span class="line"></span><br><span class="line"><span class="string">provisioner：供应商，storageclass需要有一个供应者，用来确定我们使用什么样的存储来创建pv，常见的provisioner如下</span></span><br><span class="line"></span><br><span class="line"><span class="string">（https://kubernetes.io/zh/docs/concepts/storage/storage-classes/）：</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">provisioner既可以由内部供应商提供，也可以由外部供应商提供，如果是外部供应商可以参考https://github.com/kubernetes-incubator/external-storage/下提供的方法创建。</span></span><br><span class="line"></span><br><span class="line"><span class="string">https://github.com/kubernetes-sigs/sig-storage-lib-external-provisioner</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230519162407835.png" alt="image-20230519162407835"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">以NFS为例，要想使用NFS，我们需要一个nfs-client的自动装载程序，称之为provisioner，这个程序会使用我们已经配置好的NFS服务器自动创建持久卷，也就是自动帮我们创建PV。</span><br><span class="line"></span><br><span class="line">reclaimPolicy：回收策略</span><br><span class="line"></span><br><span class="line">allowVolumeExpansion：允许卷扩展，PersistentVolume 可以配置成可扩展。将此功能设置为true时，允许用户通过编辑相应的 PVC 对象来调整卷大小。当基础存储类的allowVolumeExpansion字段设置为 true 时，以下类型的卷支持卷扩展。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230519162535255.png" alt="image-20230519162535255"></p>
<p>注意：此功能仅用于扩容卷，不能用于缩小卷。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">步骤总结：</span><br><span class="line">1、供应商：创建一个nfs provisioner</span><br><span class="line">2、创建storageclass，storageclass指定刚才创建的供应商</span><br><span class="line">3、创建pvc，这个pvc指定storageclass</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">创建pvc时不需要先创建pv，只需要先创建sc，sc动态生成pv，pvc自动和pv绑定</span><br></pre></td></tr></table></figure>
<h2 id="statefulset"><a class="markdownIt-Anchor" href="#statefulset">#</a> statefulset</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">StatefulSet是为了管理有状态服务的问题而设计的</span><br><span class="line"></span><br><span class="line">有状态服务</span><br><span class="line">StatefulSet是有状态的集合，管理有状态的服务，它所管理的Pod的名称不能随意变化。数据持久化的目录也是不一样，每一个Pod都有自己独有的数据持久化存储目录。比如MySQL主从、redis集群等。</span><br><span class="line">pod删除后名字不变</span><br><span class="line"></span><br><span class="line">无状态服务</span><br><span class="line">RC、Deployment、DaemonSet都是管理无状态的服务，它们所管理的Pod的IP、名字，启停顺序等都是随机的。个体对整体无影响，所有pod都是共用一个数据卷的，部署的tomcat就是无状态的服务，tomcat被删除，在启动一个新的tomcat，加入到集群即可，跟tomcat的名字无关。</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    name: web</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  serviceName: &quot;nginx&quot;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx </span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: web</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: www</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: www</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [&quot;ReadWriteMany&quot;]</span><br><span class="line">      storageClassName: nfs</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 1Gi</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get sts</span><br><span class="line">NAME   READY   AGE</span><br><span class="line">web    2/2     66s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pod </span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-provisioner-68878cc575-zckvq   1/1     Running   0          18</span><br><span class="line">web-0                              1/1     Running   0          68s</span><br><span class="line">web-1                              1/1     Running   0          64s</span><br><span class="line">[root@master1 ~]# kubectl get pvc </span><br><span class="line">NAME          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">test-claim1   Bound    pvc-c23b6e3e-6e95-47b7-9fba-98e97101a541   1Gi        RWX            nfs            16m</span><br><span class="line">www-web-0     Bound    pvc-6b0fb835-f835-49cd-b6b8-8805d52af664   1Gi        RWX            nfs            73s</span><br><span class="line">www-web-1     Bound    pvc-e4001db8-3ffe-4274-86db-2386933b3b1c   1Gi        RWX            nfs            69s</span><br><span class="line">[root@master1 ~]# kubectl get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   REASON </span><br><span class="line">pvc-6b0fb835-f835-49cd-b6b8-8805d52af664   1Gi        RWX            Delete           Bound    default/www-web-0     nfs                   </span><br><span class="line">pvc-c23b6e3e-6e95-47b7-9fba-98e97101a541   1Gi        RWX            Delete           Bound    default/test-claim1   nfs                   </span><br><span class="line">pvc-e4001db8-3ffe-4274-86db-2386933b3b1c   1Gi        RWX            Delete           Bound    default/www-web-1     nfs    </span><br><span class="line"></span><br><span class="line">//pod独享数据目录</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Statefulset总结：</span><br><span class="line"></span><br><span class="line">1、Statefulset管理的pod，pod名字是有序的，由statefulset的名字-0、1、2这种格式组成</span><br><span class="line">2、创建statefulset资源的时候，必须事先创建好一个service,如果创建的service没有ip，那对这个service做dns解析，会找到它所关联的pod ip，如果创建的service有ip，那对这个service做dns解析，会解析到service本身ip。</span><br><span class="line">3、statefulset管理的pod，删除pod，新创建的pod名字跟删除的pod名字是一样的</span><br><span class="line">4、statefulset具有volumeclaimtemplate这个字段，这个是卷申请模板，会自动创建pv，pvc也会自动生成，跟pv进行绑定，那如果创建的statefulset使用了volumeclaimtemplate这个字段，那创建pod，数据目录是独享的</span><br><span class="line">5、ststefulset创建的pod，是域名的（域名组成：pod-name.svc-name.svc-namespace.svc.cluster.local）</span><br></pre></td></tr></table></figure>
<p>statefulset 扩缩容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">replicas:</span> <span class="string">+</span> <span class="bullet">-</span></span><br><span class="line"><span class="string">缩容删除pod顺序是由大到小</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl explain sts.spec.updateStrategy</span></span><br><span class="line"><span class="attr">KIND:</span>     <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">VERSION:</span>  <span class="string">apps/v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">RESOURCE:</span> <span class="string">updateStrategy</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DESCRIPTION:</span></span><br><span class="line">     <span class="string">updateStrategy</span> <span class="string">indicates</span> <span class="string">the</span> <span class="string">StatefulSetUpdateStrategy</span> <span class="string">that</span> <span class="string">will</span> <span class="string">be</span></span><br><span class="line">     <span class="string">employed</span> <span class="string">to</span> <span class="string">update</span> <span class="string">Pods</span> <span class="string">in</span> <span class="string">the</span> <span class="string">StatefulSet</span> <span class="string">when</span> <span class="string">a</span> <span class="string">revision</span> <span class="string">is</span> <span class="string">made</span> <span class="string">to</span></span><br><span class="line">     <span class="string">Template.</span></span><br><span class="line"></span><br><span class="line">     <span class="string">StatefulSetUpdateStrategy</span> <span class="string">indicates</span> <span class="string">the</span> <span class="string">strategy</span> <span class="string">that</span> <span class="string">the</span> <span class="string">StatefulSet</span></span><br><span class="line">     <span class="string">controller</span> <span class="string">will</span> <span class="string">use</span> <span class="string">to</span> <span class="string">perform</span> <span class="string">updates.</span> <span class="string">It</span> <span class="string">includes</span> <span class="string">any</span> <span class="string">additional</span></span><br><span class="line">     <span class="string">parameters</span> <span class="string">necessary</span> <span class="string">to</span> <span class="string">perform</span> <span class="string">the</span> <span class="string">update</span> <span class="string">for</span> <span class="string">the</span> <span class="string">indicated</span> <span class="string">strategy.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">FIELDS:</span></span><br><span class="line">   <span class="string">rollingUpdate</span>	<span class="string">&lt;Object&gt;</span></span><br><span class="line">     <span class="string">RollingUpdate</span> <span class="string">is</span> <span class="string">used</span> <span class="string">to</span> <span class="string">communicate</span> <span class="string">parameters</span> <span class="string">when</span> <span class="string">Type</span> <span class="string">is</span></span><br><span class="line">     <span class="string">RollingUpdateStatefulSetStrategyType.</span></span><br><span class="line"></span><br><span class="line">   <span class="string">type</span>	<span class="string">&lt;string&gt;</span></span><br><span class="line">     <span class="string">Type</span> <span class="string">indicates</span> <span class="string">the</span> <span class="string">type</span> <span class="string">of</span> <span class="string">the</span> <span class="string">StatefulSetUpdateStrategy.</span> <span class="string">Default</span> <span class="string">is</span></span><br><span class="line">     <span class="string">RollingUpdate.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">partition:</span> <span class="number">1</span>  <span class="comment"># 先更新序号&gt;=1的pod</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span> </span><br><span class="line">    <span class="attr">spec:</span>  </span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"><span class="string">web-0</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">57s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">55s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">71s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">71s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">72s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">73s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>   <span class="number">0</span>          <span class="string">73s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>       <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>       <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">2s</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">3s</span></span><br><span class="line"></span><br><span class="line"><span class="string">partition：1</span> <span class="string">更新的时候会把pod序号&gt;=1的进行更新</span></span><br><span class="line"><span class="string">partition：0</span> <span class="string">所有和yaml不符的pod都会更新</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">type:</span> <span class="string">OnDelte</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OnDelete</span></span><br><span class="line"><span class="string">pod不会自动更新，需要手动删除pod，statefulset会在自动用新的yaml创建新的pod</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="daemonset"><a class="markdownIt-Anchor" href="#daemonset">#</a> DaemonSet</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">DaemonSet控制器能够确保k8s集群所有的节点都运行一个相同的pod副本，当向k8s集群中增加node节点时，这个node节点也会自动创建一个pod副本，当node节点从集群移除，这些pod也会自动删除；删除Daemonset也会删除它们创建的pod</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">daemonset的控制器会监听kuberntes的daemonset对象、pod对象、node对象，这些被监听的对象之变动，就会触发syncLoop循环让kubernetes集群朝着daemonset对象描述的状态进行演进。</span></span><br><span class="line"></span><br><span class="line"><span class="string">在集群的每个节点上运行存储，比如：glusterd</span> <span class="string">或</span> <span class="string">ceph。</span></span><br><span class="line"><span class="string">在每个节点上运行日志收集组件，比如：flunentd</span> <span class="string">、</span> <span class="string">logstash、filebeat等。</span></span><br><span class="line"><span class="string">在每个节点上运行监控组件，比如：Prometheus、</span> <span class="string">Node</span> <span class="string">Exporter</span> <span class="string">、collectd等。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">Deployment</span> <span class="string">部署的副本</span> <span class="string">Pod</span> <span class="string">会分布在各个</span> <span class="string">Node</span> <span class="string">上，每个</span> <span class="string">Node</span> <span class="string">都可能运行好几个副本。</span></span><br><span class="line"><span class="string">DaemonSet</span> <span class="string">的不同之处在于：每个</span> <span class="string">Node</span> <span class="string">上最多只能运行一个副本。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluentd-logging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span> </span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varcontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">fluentd</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varcontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pod -n kube-system -l name=fluentd -owide </span></span><br><span class="line"><span class="string">NAME</span>            <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>               <span class="string">NODE</span>      <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">fluentd-gv4jk</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">87s</span>   <span class="number">10.244</span><span class="number">.136</span><span class="number">.3</span>     <span class="string">master3</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">fluentd-ttcgl</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">87s</span>   <span class="number">10.244</span><span class="number">.180</span><span class="number">.2</span>     <span class="string">master2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">fluentd-w5vxw</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">87s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.146</span>   <span class="string">node1</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">fluentd-w9m2w</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">87s</span>   <span class="number">10.244</span><span class="number">.137</span><span class="number">.70</span>    <span class="string">master1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">四个pod因为集群是三主一从，且定义了容忍度容忍matser污点</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get ds -n kube-system </span></span><br><span class="line"><span class="string">NAME</span>          <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">NODE</span> <span class="string">SELECTOR</span>            <span class="string">AGE</span></span><br><span class="line"><span class="string">fluentd</span>       <span class="number">4</span>         <span class="number">4</span>         <span class="number">4</span>       <span class="number">4</span>            <span class="number">4</span>           <span class="string">&lt;none&gt;</span>                   <span class="string">106s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span>  <span class="comment"># 更新期间最大只能有一个不可用，即一个一个更新</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新镜像 控制器名字 pod名字</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">set</span> <span class="string">image</span> <span class="string">daemonset</span> <span class="string">fluentd</span> <span class="string">fluentd=nginx</span> <span class="string">-n</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="string">fluentd-55p5p</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">14s</span></span><br><span class="line"><span class="string">fluentd-55p5p</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">14s</span></span><br><span class="line"><span class="string">fluentd-55p5p</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">14s</span></span><br><span class="line"><span class="string">fluentd-55p5p</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">14s</span></span><br><span class="line"><span class="string">fluentd-qk56k</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>             <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">fluentd-qk56k</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>             <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">fluentd-qk56k</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">fluentd-qk56k</span>                              <span class="number">0</span><span class="string">/1</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">3s</span></span><br><span class="line"><span class="string">fluentd-qk56k</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">3s</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="configmap"><a class="markdownIt-Anchor" href="#configmap">#</a> ConfigMap</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Configmap是k8s中的资源对象，用于保存非机密性的配置的，数据可以用key/value键值对的形式保存，也可通过文件的形式保存。</span><br><span class="line"></span><br><span class="line">我们在部署服务的时候，每个服务都有自己的配置文件，如果一台服务器上部署多个服务：nginx、tomcat、apache等，那么这些配置都存在这个节点上，假如一台服务器不能满足线上高并发的要求，需要对服务器扩容，扩容之后的服务器还是需要部署多个服务：nginx、tomcat、apache，新增加的服务器上还是要管理这些服务的配置，如果有一个服务出现问题，需要修改配置文件，每台物理节点上的配置都需要修改，这种方式肯定满足不了线上大批量的配置变更要求。 所以，k8s中引入了Configmap资源对象，可以当成volume挂载到pod中，实现统一的配置管理。</span><br><span class="line"></span><br><span class="line">1、Configmap是k8s中的资源， 相当于配置文件，可以有一个或者多个Configmap；</span><br><span class="line">2、Configmap可以做成Volume，k8s pod启动之后，通过 volume 形式映射到容器内部指定目录上；</span><br><span class="line">3、容器中应用程序按照原有方式读取容器特定目录上的配置文件。</span><br><span class="line">4、在容器看来，配置文件就像是打包在容器内部特定目录，整个过程对应用没有任何。</span><br><span class="line"></span><br><span class="line">1、使用k8s部署应用，当你将应用配置写进代码中，更新配置时也需要打包镜像，configmap可以将配置信息和docker镜像解耦，以便实现镜像的可移植性和可复用性，因为一个configMap其实就是一系列配置信息的集合，可直接注入到Pod中给容器使用。configmap注入方式有两种，一种将configMap做为存储卷，一种是将configMap通过env中configMapKeyRef注入到容器中。</span><br><span class="line"></span><br><span class="line">2、使用微服务架构的话，存在多个服务共用配置的情况，如果每个服务中单独一份配置的话，那么更新配置就很麻烦，使用configmap可以友好的进行配置共享。</span><br><span class="line"></span><br><span class="line">ConfigMap在设计上不是用来保存大量数据的。在ConfigMap中保存的数据不可超过1 MiB。如果你需要保存超出此尺寸限制的数据，可以考虑挂载存储卷或者使用独立的数据库或者文件服务。</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令行创建</span></span><br><span class="line">kubectl create configmap tomcat-config --from-literal=tomcat_port=8080 --from-literal=server_name=myapp.tomcat.com</span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl get cm</span></span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">kube-root-ca.crt   1      25d</span><br><span class="line">tomcat-config      2      6s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl describe configmap tomcat-config</span></span><br><span class="line">Name:         tomcat-config</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">server_name:</span><br><span class="line">----</span><br><span class="line">myapp.tomcat.com</span><br><span class="line">tomcat_port:</span><br><span class="line">----</span><br><span class="line">8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件创建</span></span><br><span class="line">//nginx.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    root html;</span><br><span class="line">&#125;</span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl create cm www-nginx --from-file=www=./nginx.conf </span></span><br><span class="line">configmap/www-nginx created</span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl describe cm www</span></span><br><span class="line">Name:         www-nginx</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">www:</span><br><span class="line">----</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80; </span><br><span class="line">    root html;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 不指定cm名称就是文件名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目录创建</span></span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl create cm mysql-config --from-file=./test/</span></span><br><span class="line">configmap/mysql-config created</span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl describe cm mysql-config </span></span><br><span class="line">Name:         mysql-config</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">my-cnf:</span><br><span class="line">----</span><br><span class="line">server-id=1</span><br><span class="line"></span><br><span class="line">my-slave-cnf:</span><br><span class="line">----</span><br><span class="line">server-id=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># yaml文件创建</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">  labels:</span><br><span class="line">    app: mysql</span><br><span class="line">data:</span><br><span class="line">  master.cnf: |</span><br><span class="line">    [mysqld]</span><br><span class="line">    log-bin</span><br><span class="line">    log_bin_trust_function_creators=1</span><br><span class="line">    lower_case_table_names=1</span><br><span class="line">  slave.cnf: |</span><br><span class="line">    [mysqld]</span><br><span class="line">    super-read-only</span><br><span class="line">    log_bin_trust_function_creators=1</span><br><span class="line">| 代表配置文件有多行</span><br><span class="line"></span><br><span class="line"><span class="comment"># yaml文件创建pod中使用</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">  labels:</span><br><span class="line">    app: mysql</span><br><span class="line">data:</span><br><span class="line">    <span class="built_in">log</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">    lower: <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="comment"># 通过环境变量引入：使用configMapKeyRef </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysql</span><br><span class="line">    image: busybox</span><br><span class="line">    <span class="built_in">command</span>: [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 3600&quot;</span> ]</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: log_bin   <span class="comment">#定义环境变量log_bin</span></span><br><span class="line">      valueFrom: </span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: mysql     <span class="comment">#指定configmap的名字</span></span><br><span class="line">          key: <span class="built_in">log</span> <span class="comment">#指定configmap中的key</span></span><br><span class="line">    - name: lower   <span class="comment">#定义环境变量lower</span></span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: mysql</span><br><span class="line">          key: lower</span><br><span class="line">  restartPolicy: Never</span><br><span class="line">  </span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it mysql-pod -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># printenv </span></span><br><span class="line">log_bin=1</span><br><span class="line">lower=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用envfrom</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pod-envfrom</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysql</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 3600&quot;</span> ]</span><br><span class="line">    envFrom: </span><br><span class="line">    - configMapRef:</span><br><span class="line">       name: mysql     <span class="comment">#指定configmap的名字</span></span><br><span class="line">  restartPolicy: Never</span><br><span class="line">  </span><br><span class="line">[root@master1 ~]<span class="comment"># kubectl exec -it mysql-pod-envfrom -c mysql -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># printenv </span></span><br><span class="line">lower=1</span><br><span class="line"><span class="built_in">log</span>=1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 以存储卷方式挂载</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">  labels:</span><br><span class="line">    app: mysql</span><br><span class="line">data:</span><br><span class="line">    log: &quot;1&quot;</span><br><span class="line">    lower: &quot;1&quot;</span><br><span class="line">    my.cnf: |</span><br><span class="line">      [mysqld]</span><br><span class="line">      haha=shabi</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pod-volume</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysql</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    command: [ &quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot; ]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: mysql-config</span><br><span class="line">      mountPath: /tmp/config</span><br><span class="line">  volumes:</span><br><span class="line">  - name: mysql-config</span><br><span class="line">    configMap:</span><br><span class="line">      name: mysql</span><br><span class="line">  restartPolicy: Never</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl exec -it mysql-pod-volume -c mysql -- /bin/sh</span><br><span class="line">/ # cd /tmp/config/</span><br><span class="line">/tmp/config # ls </span><br><span class="line">log     lower   my.cnf</span><br><span class="line">/tmp/config # cat my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">haha=shabi</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">configmap在以volume启动时可以热加载，cm修改，pod内配置也会自动更新，但需要一定时间</span><br><span class="line">环境变量注入不会自动更新</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl create cm redis-conf --from-file=redis.conf </span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get cm</span></span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">kube-root-ca.crt   1      3d16h</span><br><span class="line">redis-conf         1      6s</span><br><span class="line"></span><br><span class="line"><span class="comment"># configmap 会保存在 etcd中</span></span><br><span class="line">[root@master ~]<span class="comment"># rm -rf redis.conf </span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get cm redis-conf -oyaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  redis.conf: |</span><br><span class="line">    appendonly <span class="built_in">yes</span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-conf</span><br><span class="line">  namespace: default</span><br><span class="line"><span class="comment"># data是所有真正的数据</span></span><br><span class="line"><span class="comment"># key默认是文件名 value是配置文件内容 </span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-server</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/redis-master/redis.conf&quot;</span>  <span class="comment">#指的是redis容器内部的位置</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/redis-master</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span>    <span class="comment"># config 是下面configmap的名字</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis-conf</span>   <span class="comment"># redis-conf的configmap在上面已经创建过</span></span><br><span class="line">        <span class="attr">items:</span>			<span class="comment"># items获取data中的内容</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">redis.conf</span>   <span class="comment"># 取出redis-conf对应的value</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">redis.conf</span>  <span class="comment"># /redis-master/redis.conf </span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master</span> <span class="string">~</span>]<span class="comment"># kubectl edit cm redis-conf </span></span><br><span class="line"><span class="string">configmap/redis-conf</span> <span class="string">edited</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 外部修改配置文件，内部自动同步</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">redis-cli</span></span><br><span class="line"><span class="string">config</span> <span class="string">get</span> <span class="string">appendonly</span></span><br><span class="line"><span class="comment"># 需要重新启动pod，因为pod的中间件没有热更新能力</span></span><br></pre></td></tr></table></figure>
<h2 id="secret"><a class="markdownIt-Anchor" href="#secret">#</a> secret</h2>
<p>Secret 对象类型用来保存敏感信息，例如密码、OAuth 令牌和 SSH 密钥。 将这些信息放在 secret 中比放在 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL3BvZHMvcG9kLW92ZXJ2aWV3Lw==">Pod</span> 的定义或者 <span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poL2RvY3MvcmVmZXJlbmNlL2dsb3NzYXJ5Lz9hbGw9dHJ1ZSN0ZXJtLWltYWdl">容器镜像</span> 中来说更加安全和灵活。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Configmap一般是用来存放明文数据的，如配置文件，对于一些敏感数据，如密码、私钥等数据时，要用secret类型。</span><br><span class="line"></span><br><span class="line">Secret解决了密码、token、秘钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者Pod Spec中。Secret可以以Volume或者环境变量的方式使用。</span><br><span class="line"></span><br><span class="line">要使用 secret，pod 需要引用 secret。Pod 可以用两种方式使用 secret：作为 volume 中的文件被挂载到 pod 中的一个或者多个容器里，或者当 kubelet 为 pod 拉取镜像时使用。</span><br><span class="line"></span><br><span class="line">secret可选参数有三种:</span><br><span class="line">generic: 通用类型，通常用于存储密码数据。</span><br><span class="line">　　tls：此类型仅用于存储私钥和证书。</span><br><span class="line">　　docker-registry: 若要保存docker仓库的认证信息的话，就必须使用此种类型来创建。</span><br><span class="line">　　</span><br><span class="line">Secret类型：</span><br><span class="line">Service Account：用于被 serviceaccount 引用。serviceaccout 创建时 Kubernetes 会默认创建对应的 secret。Pod 如果使用了 serviceaccount，对应的 secret 会自动挂载到 Pod 的 /run/secrets/kubernetes.io/serviceaccount 目录中。 </span><br><span class="line"></span><br><span class="line">Opaque：base64编码格式的Secret，用来存储密码、秘钥等。可以通过base64 --decode解码获得原始数据，因此安全性弱</span><br><span class="line"></span><br><span class="line">kubernetes.io/dockerconfigjson：用来存储私有docker registry的认证信息。</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 secret]<span class="comment"># kubectl create secret generic mysql-password --from-literal=password=123456</span></span><br><span class="line">secret/mysql-password created</span><br><span class="line"></span><br><span class="line">[root@master1 secret]<span class="comment"># kubectl get secrets </span></span><br><span class="line">NAME                          TYPE                                  DATA   AGE</span><br><span class="line">default-token-sc5zb           kubernetes.io/service-account-token   3      25d</span><br><span class="line">mysql-password                Opaque                                1      11s</span><br><span class="line">nfs-provisioner-token-dgf2x   kubernetes.io/service-account-token   3      26h</span><br><span class="line"></span><br><span class="line">[root@master1 secret]<span class="comment"># kubectl describe secrets mysql-password </span></span><br><span class="line">Name:         mysql-password</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password:  6 bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境变量挂载</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-secret</span><br><span class="line">  labels:</span><br><span class="line">     app: myapp</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">     - name: MYSQL_ROOT_PASSWORD   <span class="comment">#它是Pod启动成功后,Pod中容器的环境变量名.</span></span><br><span class="line">       valueFrom:</span><br><span class="line">          secretKeyRef:</span><br><span class="line">            name: mysql-password  <span class="comment">#这是secret的对象名</span></span><br><span class="line">            key: password      <span class="comment">#它是secret中的key名</span></span><br><span class="line"></span><br><span class="line">[root@master1 secret]<span class="comment"># kubectl exec -it pod-secret -- /bin/sh</span></span><br><span class="line"><span class="comment"># printenv</span></span><br><span class="line">MYSQL_ROOT_PASSWORD=123456</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 secret]<span class="comment"># echo -n &quot;admin&quot; | base64</span></span><br><span class="line">YWRtaW4=</span><br><span class="line">[root@master1 secret]<span class="comment"># echo -n &quot;YWRtaW4=&quot; | base64 -d </span></span><br><span class="line">admin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: mysecret</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">data:</span><br><span class="line">  username: YWRtaW4=</span><br><span class="line">  password: MTIzNDU2</span><br><span class="line"></span><br><span class="line">[root@master1 secret]<span class="comment"># kubectl describe secrets mysecret </span></span><br><span class="line">Name:         mysecret</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password:  6 bytes</span><br><span class="line">username:  5 bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># volume挂载</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-secret-volume</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: secret-volume</span><br><span class="line">      mountPath: /etc/secret</span><br><span class="line">      readOnly: <span class="literal">true</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: secret-volume</span><br><span class="line">    secret:</span><br><span class="line">      secretName: mysecret</span><br><span class="line"></span><br><span class="line">[root@master1 secret]<span class="comment"># kubectl exec -it pod-secret-volume -c myapp -- /bin/bash</span></span><br><span class="line">root@pod-secret-volume:/<span class="comment"># cd /etc/secret</span></span><br><span class="line">root@pod-secret-volume:/etc/secret<span class="comment"># ls </span></span><br><span class="line">password  username</span><br><span class="line">root@pod-secret-volume:/etc/secret<span class="comment"># cat password </span></span><br><span class="line">123456</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl create secret docker-registry kbshire-docker --docker-username=kbshire --docker-password=shabi --docker-email=kbshire@163.com</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get secret </span></span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-mlttj   kubernetes.io/service-account-token   3      3d17h</span><br><span class="line">kbshire-docker        kubernetes.io/dockerconfigjson        1      43s</span><br><span class="line">[root@master ~]<span class="comment"># kubectl get secret kbshire-docker -oyaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  .dockerconfigjson: eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJrYnNoaXJlIiwicGFzc3dvcmQiOiIxODMxMDg5MTNhYkMiLCJlbWFpbCI6Imtic2hpcmVAMTYzLmNvbSIsImF1dGgiOiJhMkp6YUdseVpUb3hPRE14TURnNU1UTmhZa009In19fQ==</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2023-04-12T05:50:16Z&quot;</span></span><br><span class="line">  managedFields:</span><br><span class="line">  - apiVersion: v1</span><br><span class="line">    fieldsType: FieldsV1</span><br><span class="line">    fieldsV1:</span><br><span class="line">      f:data:</span><br><span class="line">        .: &#123;&#125;</span><br><span class="line">        f:.dockerconfigjson: &#123;&#125;</span><br><span class="line">      f:<span class="built_in">type</span>: &#123;&#125;</span><br><span class="line">    manager: kubectl-create</span><br><span class="line">    operation: Update</span><br><span class="line">    time: <span class="string">&quot;2023-04-12T05:50:16Z&quot;</span></span><br><span class="line">  name: kbshire-docker</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">&quot;621248&quot;</span></span><br><span class="line">  uid: 84367164-813e-4f1d-8641-da19acd151b7</span><br><span class="line"><span class="built_in">type</span>: kubernetes.io/dockerconfigjson</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">private-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">private-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">leifengyang/guignginx:v1.0</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kbshire-docker</span>    <span class="comment"># 创建过的secret名称</span></span><br></pre></td></tr></table></figure>
<h2 id="rbac"><a class="markdownIt-Anchor" href="#rbac">#</a> RBAC</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 认证</span></span><br><span class="line"><span class="string">kubernetes主要通过APIserver对外提供服务，那么就需要对访问apiserver的用户做认证，如果任何人都能访问apiserver，那么就可以随意在k8s集群部署资源，这是非常危险的，也容易被黑客攻击渗透，所以需要我们对访问k8s系统的apiserver的用户进行认证，确保是合法的符合要求的用户。</span></span><br><span class="line"><span class="comment"># 授权</span></span><br><span class="line"><span class="string">认证通过后仅代表它是一个被apiserver信任的用户，能访问apiserver，但是用户是否拥有删除资源的权限，</span> <span class="string">需要进行授权操作，常见的授权方式有rbac授权。</span></span><br><span class="line"><span class="comment"># 准入控制</span></span><br><span class="line"><span class="string">当用户经过认证和授权之后，最后一步就是准入控制了，k8s提供了多种准入控制机制，它有点类似&quot;插件&quot;，为apiserver提供了很好的&quot;可扩展性&quot;。请求apiserver时，通过认证、鉴权后、持久化(&quot;api对象&quot;保存到etcd)前，会经过&quot;准入控制器&quot;，让它可以做&quot;变更和验证&quot;。</span></span><br><span class="line"><span class="string">如果我们创建pod时定义了资源上下限，但不满足LimitRange规则中定义的资源上下限，此时LimitRanger就会拒绝我们创建此pod</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">k8s客户端访问apiserver的几种认证方式</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">）客户端认证：</span></span><br><span class="line"><span class="string">客户端认证也称为双向TLS认证，</span> <span class="string">kubectl在访问apiserver的时候，apiserver也要认证kubectl是否是合法的，他们都会通过ca根证书来进行验证，如下图：</span></span><br><span class="line"><span class="number">2</span><span class="string">）Bearertoken</span></span><br><span class="line"><span class="string">Bearertoken的方式，可以理解为apiserver将一个密码通过了非对称加密的方式告诉了kubectl，然后通过该密码进行相互访问，如下图：</span></span><br><span class="line"><span class="string">上面客户端证书认证和Bearertoken的两种认证方式，都是外部访问apiserver的时候使用的方式，那么我们这次说的Serviceaccount是内部访问pod和apiserver交互时候采用的一种方式。Serviceaccount包括了，namespace、token、ca，且通过目录挂载的方式给予pod，当pod运行起来的时候，就会读取到这些信息，从而使用该方式和apiserver进行通信。如下图：</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">在K8S集群当中，当我们使用kubectl操作k8s资源时候，需要确定我们用哪个用户访问哪个k8s集群，kubectl操作k8s集群资源会去/root/.kube目录下找config文件，可以通过kubectl</span> <span class="string">config查看config文件配置，如下：</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl config view </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.13.249:16443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">REDACTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">REDACTED</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">--kubeconfig=/root/.kube/config</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="授权"><a class="markdownIt-Anchor" href="#授权">#</a> 授权</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">用户通过认证之后，什么权限都没有，需要一些后续的授权操作，如对资源的增删该查等，kubernetes1.6之后开始有RBAC（基于角色的访问控制机制）授权检查机制。</span><br><span class="line"> Kubernetes的授权是基于插件形成的，其常用的授权插件有以下几种：</span><br><span class="line">1）Node（节点认证）</span><br><span class="line">2）ABAC(基于属性的访问控制)</span><br><span class="line">3）RBAC（基于角色的访问控制）***</span><br><span class="line">4）Webhook（基于http回调机制的访问控制）</span><br><span class="line"></span><br><span class="line">什么是RBAC（基于角色的授权）？</span><br><span class="line"> 让一个用户（Users）扮演一个角色（Role），角色拥有权限，从而让用户拥有这样的权限，随后在授权机制当中，只需要将权限授予某个角色，此时用户将获取对应角色的权限，从而实现角色的访问控制。</span><br><span class="line"> 另外，k8s为此还有一种集群级别的授权机制，就是定义一个集群角色（ClusterRole），对集群内的所有资源都有可操作的权限，从而将User2通过ClusterRoleBinding到ClusterRole，从而使User2拥有集群的操作权限。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Role、RoleBinding、ClusterRole和ClusterRoleBinding的关系如下：</span><br><span class="line">1.用户基于rolebinding绑定到role</span><br><span class="line">限定在rolebinding所在的名称空间</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230522152729791.png" alt="image-20230522152729791"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2.用户基于rolebinding绑定到clusterrole</span><br><span class="line">RoleBinding仅仅对当前名称空间有对应的权限</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230522153654517.png" alt="image-20230522153654517"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（1）用户通过rolebinding绑定role</span><br><span class="line">（2）用户通过rolebinding绑定clusterrole</span><br><span class="line"></span><br><span class="line">rolebinding绑定clusterrole的好处：</span><br><span class="line">假如有6个名称空间，每个名称空间的用户都需要对自己的名称空间有管理员权限，那么需要定义6个role和rolebinding，然后依次绑定，如果名称空间更多，我们需要定义更多的role，这个是很麻烦的，所以我们引入clusterrole，定义一个clusterrole，对clusterrole授予所有权限，然后用户通过rolebinding绑定到clusterrole，就会拥有自己名称空间的管理员权限了</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3、用户基于clusterrolebinding绑定到clusterrole</span><br><span class="line">不限定名称空间</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230522154527804.png" alt="image-20230522154527804"></p>
<h3 id="准入控制"><a class="markdownIt-Anchor" href="#准入控制">#</a> 准入控制</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">在k8s上准入控制器的模块有很多，其中比较常用的有LimitRanger、ResourceQuota、ServiceAccount、PodSecurityPolicy(k8s1.25废弃了)等等，对于前面三种准入控制器系统默认是启用的，我们只需要定义对应的规则即可；对于PodSecurityPolicy(k8s1.25废弃了)这种准入控制器，系统默认没有启用，如果我们要使用，就必需启用以后，对应规则才会正常生效；这里需要注意一点，对应psp准入控制器，一定要先写好对应的规则，把规则和权限绑定好以后，在启用对应的准入控制器，否则先启用准入控制器，没有对应的规则，默认情况它是拒绝操作，这可能导致现有的k8s系统跑的系统级pod无法正常工作；所以对于psp准入控制器要慎用，如果规则和权限做的足够精细，它会给我们的k8s系统安全带来大幅度的提升，反之，可能导致整个k8s系统不可用。</span><br><span class="line"></span><br><span class="line">cat /etc/kubernetes/manifests/kube-apiserver.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: 192.168.40.63:6443</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    component: kube-apiserver</span><br><span class="line">    tier: control-plane</span><br><span class="line">  name: kube-apiserver</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - command:</span><br><span class="line">    - kube-apiserver</span><br><span class="line">    - --advertise-address=192.168.40.180</span><br><span class="line">    …</span><br><span class="line">- --enable-admission-plugins=NodeRestriction</span><br><span class="line"></span><br><span class="line">LimitRanger、ResourceQuota、ServiceAccount 是自动开启的</span><br></pre></td></tr></table></figure>
<h3 id="useraccount-serviceaccount"><a class="markdownIt-Anchor" href="#useraccount-serviceaccount">#</a> useraccount 、serviceaccount</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">kubernetes中账户分为：UserAccounts（用户账户） 和 ServiceAccounts（服务账户） 两种：</span><br><span class="line">UserAccount是给kubernetes集群外部用户使用的，如kubectl访问k8s集群要用useraccount用户， kubeadm安装的k8s，默认的useraccount用户是kubernetes-admin；</span><br><span class="line"></span><br><span class="line">ServiceAccount是Pod使用的账号，Pod容器的进程需要访问API Server时用的就是ServiceAccount账户；ServiceAccount仅局限它所在的namespace，每个namespace创建时都会自动创建一个default service account；创建Pod时，如果没有指定Service Account，Pod则会使用default Service Account。</span><br><span class="line"></span><br><span class="line">ua是kubectl访问集群的</span><br><span class="line">sa是pod访问api-server</span><br><span class="line"></span><br><span class="line">kubectl create sa sa-test</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: sa-test</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: sa</span><br><span class="line">spec:</span><br><span class="line">  serviceAccountName: sa-test</span><br><span class="line">  containers:</span><br><span class="line">  - name:  sa-tomcat</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 rbac]# kubectl exec -it sa-test -- /bin/bash </span><br><span class="line">root@sa-test:/# cd /var/run/secrets/kubernetes.io/serviceaccount/</span><br><span class="line">root@sa-test:/var/run/secrets/kubernetes.io/serviceaccount# ls </span><br><span class="line">ca.crt	namespace  token</span><br><span class="line">root@sa-test:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt  -H &quot;Authorization: Bearer $(cat ./token)&quot;   https://kubernetes/api/v1/namespaces/kube-system</span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;namespaces \&quot;kube-system\&quot; is forbidden: User \&quot;system:serviceaccount:default:sa-test\&quot; cannot get resource \&quot;namespaces\&quot; in API group \&quot;\&quot; in the namespace \&quot;kube-system\&quot;&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Forbidden&quot;,</span><br><span class="line">  &quot;details&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;kube-system&quot;,</span><br><span class="line">    &quot;kind&quot;: &quot;namespaces&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;code&quot;: 403</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding sa-test-admin --clusterrole=cluster-admin  --serviceaccount=default:sa-test</span><br><span class="line"></span><br><span class="line">root@sa-test:/var/run/secrets/kubernetes.io/serviceaccount# curl --cacert ./ca.crt  -H &quot;Authorization: Bearer $(cat ./token)&quot;   https://kubernetes/api/v1/namespaces/kube-system</span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Namespace&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;kube-system&quot;,</span><br><span class="line">    &quot;uid&quot;: &quot;b25c9a07-c34a-4ce7-8afe-a7b3b1fa6895&quot;,</span><br><span class="line">    &quot;resourceVersion&quot;: &quot;4&quot;,</span><br><span class="line">    &quot;creationTimestamp&quot;: &quot;2023-04-25T08:50:07Z&quot;,</span><br><span class="line">    &quot;managedFields&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;manager&quot;: &quot;kube-apiserver&quot;,</span><br><span class="line">        &quot;operation&quot;: &quot;Update&quot;,</span><br><span class="line">        &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">        &quot;time&quot;: &quot;2023-04-25T08:50:07Z&quot;,</span><br><span class="line">        &quot;fieldsType&quot;: &quot;FieldsV1&quot;,</span><br><span class="line">        &quot;fieldsV1&quot;: &#123;&quot;f:status&quot;:&#123;&quot;f:phase&quot;:&#123;&#125;&#125;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;spec&quot;: &#123;</span><br><span class="line">    &quot;finalizers&quot;: [</span><br><span class="line">      &quot;kubernetes&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: &#123;</span><br><span class="line">    &quot;phase&quot;: &quot;Active&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="rbac-2"><a class="markdownIt-Anchor" href="#rbac-2">#</a> rbac</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">在Kubernetes中，所有资源对象都是通过API进行操作，他们保存在etcd里。而对etcd的操作我们需要通过访问 kube-apiserver 来实现，上面的Service Account其实就是APIServer的认证过程，而授权的机制是通过RBAC：基于角色的访问控制实现。</span><br><span class="line"></span><br><span class="line">RBAC有四个资源对象，分别是Role、ClusterRole、RoleBinding、ClusterRoleBinding</span><br><span class="line"></span><br><span class="line">role:</span><br><span class="line"></span><br><span class="line">一组权限的集合，在一个命名空间中，可以用其来定义一个角色，只能对命名空间内的资源进行授权。如果是集群级别的资源，则需要使用ClusterRole。例如：定义一个角色用来读取Pod的权限</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  namespace: rbac</span><br><span class="line">  name: pod-read</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;pods&quot;]</span><br><span class="line">  resourceNames: []</span><br><span class="line">verbs: [&quot;get&quot;,&quot;watch&quot;,&quot;list&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rules中的参数说明：</span><br><span class="line">1、apiGroups：支持的API组列表，例如：&quot;apiVersion: apps/v1&quot;等</span><br><span class="line">2、resources：支持的资源对象列表，例如pods、deployments、jobs等</span><br><span class="line">3、resourceNames: 指定resource的名称</span><br><span class="line">4、verbs：对资源对象的操作方法列表。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ClusterRole：集群角色</span><br><span class="line"></span><br><span class="line">具有和角色一致的命名空间资源的管理能力，还可用于以下特殊元素的授权</span><br><span class="line">1、集群范围的资源，例如Node</span><br><span class="line">2、非资源型的路径，例如：/healthz</span><br><span class="line">3、包含全部命名空间的资源，例如Pods</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: secrets-clusterrole</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line"> resources: [&quot;secrets&quot;]</span><br><span class="line">verbs: [&quot;get&quot;,&quot;watch&quot;,&quot;list&quot;]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">RoleBinding：角色绑定、ClusterRolebinding：集群角色绑定</span><br><span class="line"></span><br><span class="line">角色绑定和集群角色绑定用于把一个角色绑定在一个目标上，可以是User，Group，Service Account，使用RoleBinding为某个命名空间授权，使用ClusterRoleBinding为集群范围内授权。</span><br><span class="line">例如：将在rbac命名空间中把pod-read角色授予用户es</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-read-bind</span><br><span class="line">  namespace: rbac</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: es</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">- kind: Role</span><br><span class="line">  name: pod-read</span><br><span class="line">  apiGroup: rbac.authorizatioin.k8s.io</span><br><span class="line"></span><br><span class="line">RoleBinding也可以引用ClusterRole，对属于同一命名空间内的ClusterRole定义的资源主体进行授权， 例如：es能获取到集群中所有的资源信息</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: es-allresource</span><br><span class="line">  namespace: rbac</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: es</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># api 访问k8s资源</span></span><br><span class="line"><span class="string">多数资源可以用其名称的字符串表示，也就是Endpoint中的URL相对路径，例如pod中的日志是GET</span> <span class="string">/api/v1/namaspaces/&#123;namespace&#125;/pods/&#123;podname&#125;/log</span></span><br><span class="line"><span class="string">如果需要在一个RBAC对象中体现上下级资源，就需要使用“/”分割资源和下级资源。</span></span><br><span class="line"><span class="string">例如：若想授权让某个主体同时能够读取Pod和Pod</span> <span class="string">log，则可以配置</span> <span class="string">resources为一个数组</span></span><br><span class="line">[<span class="string">root@xianchaomaster1</span> <span class="string">~</span>]<span class="comment"># kubectl create  ns test</span></span><br><span class="line">[<span class="string">root@xianchaomaster1</span> <span class="string">~</span>]<span class="comment"># vim role-test.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">logs-reader</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>,<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">rbac</span>]<span class="comment"># kubectl get role -n test </span></span><br><span class="line"><span class="string">NAME</span>          <span class="string">CREATED</span> <span class="string">AT</span></span><br><span class="line"><span class="string">logs-reader</span>   <span class="number">2023-05-23T06:33:45Z</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">rbac</span>]<span class="comment"># kubectl create sa sa-test -n test </span></span><br><span class="line"><span class="string">serviceaccount/sa-test</span> <span class="string">created</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">rbac</span>]<span class="comment"># kubectl create rolebinding sa-test-1 -n test  --role=logs-reader --serviceaccount=test:sa-test</span></span><br><span class="line"><span class="string">rolebinding.rbac.authorization.k8s.io/sa-test-1</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sa-test-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">sa-test</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">sa-tomcat</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">rbac</span>]<span class="comment"># kubectl exec -it -n test sa-test-pod -- /bin/bash </span></span><br><span class="line"><span class="string">root@sa-test-pod:/#</span> <span class="string">cd</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/</span></span><br><span class="line"><span class="string">root@sa-test-pod:/var/run/secrets/kubernetes.io/serviceaccount#</span> <span class="string">ls</span> </span><br><span class="line"><span class="string">ca.crt</span>	<span class="string">namespace</span>  <span class="string">token</span></span><br><span class="line"><span class="string">root@sa-test-pod:/var/run/secrets/kubernetes.io/serviceaccount#</span> <span class="string">curl</span> <span class="string">--cacert</span> <span class="string">./ca.crt</span>  <span class="string">-H</span> <span class="string">&quot;Authorization: Bearer $(cat ./token)&quot;</span>  <span class="string">https://kubernetes.default/api/v1/namespaces/test/pods/sa-test-pod/logs</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;kind&quot;:</span> <span class="string">&quot;Status&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;:</span> <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;metadata&quot;:</span> &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;status&quot;:</span> <span class="string">&quot;Failure&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;message&quot;:</span> <span class="string">&quot;pods \&quot;sa-test-pod\&quot; is forbidden: User \&quot;system:serviceaccount:test:sa-test\&quot; cannot get resource \&quot;pods/logs\&quot; in API group \&quot;\&quot; in the namespace \&quot;test\&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;reason&quot;:</span> <span class="string">&quot;Forbidden&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;details&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;sa-test-pod&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;kind&quot;:</span> <span class="string">&quot;pods&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;code&quot;:</span> <span class="number">403</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">root@sa-test-pod:/var/run/secrets/kubernetes.io/serviceaccount#</span> <span class="string">curl</span> <span class="string">--cacert</span> <span class="string">./ca.crt</span>  <span class="string">-H</span> <span class="string">&quot;Authorization: Bearer $(cat ./token)&quot;</span>  <span class="string">https://kuberntes.default/api/v1/namespaces/test/pods/sa-test-pod/log</span></span><br><span class="line"><span class="string">/docker-entrypoint.sh:</span> <span class="string">/docker-entrypoint.d/</span> <span class="string">is</span> <span class="string">not</span> <span class="string">empty,</span> <span class="string">will</span> <span class="string">attempt</span> <span class="string">to</span> <span class="string">perform</span> <span class="string">configuration</span></span><br><span class="line"><span class="string">/docker-entrypoint.sh:</span> <span class="string">Looking</span> <span class="string">for</span> <span class="string">shell</span> <span class="string">scripts</span> <span class="string">in</span> <span class="string">/docker-entrypoint.d/</span></span><br><span class="line"><span class="string">/docker-entrypoint.sh:</span> <span class="string">Launching</span> <span class="string">/docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span></span><br><span class="line"><span class="attr">10-listen-on-ipv6-by-default.sh: info:</span> <span class="string">Getting</span> <span class="string">the</span> <span class="string">checksum</span> <span class="string">of</span> <span class="string">/etc/nginx/conf.d/default.conf</span></span><br><span class="line"><span class="attr">10-listen-on-ipv6-by-default.sh: info:</span> <span class="string">Enabled</span> <span class="string">listen</span> <span class="string">on</span> <span class="string">IPv6</span> <span class="string">in</span> <span class="string">/etc/nginx/conf.d/default.conf</span></span><br><span class="line"><span class="string">/docker-entrypoint.sh:</span> <span class="string">Launching</span> <span class="string">/docker-entrypoint.d/20-envsubst-on-templates.sh</span></span><br><span class="line"><span class="string">/docker-entrypoint.sh:</span> <span class="string">Launching</span> <span class="string">/docker-entrypoint.d/30-tune-worker-processes.sh</span></span><br><span class="line"><span class="string">/docker-entrypoint.sh:</span> <span class="string">Configuration</span> <span class="string">complete;</span> <span class="string">ready</span> <span class="string">for</span> <span class="string">start</span> <span class="string">up</span></span><br><span class="line"><span class="number">2023</span><span class="string">/05/23</span> <span class="number">06</span><span class="string">:37:45</span> [<span class="string">notice</span>] <span class="number">1</span><span class="comment">#1: using the &quot;epoll&quot; event method</span></span><br><span class="line"><span class="number">2023</span><span class="string">/05/23</span> <span class="number">06</span><span class="string">:37:45</span> [<span class="string">notice</span>] <span class="number">1</span><span class="comment">#1: nginx/1.21.5</span></span><br><span class="line"><span class="number">2023</span><span class="string">/05/23</span> <span class="number">06</span><span class="string">:37:45</span> [<span class="string">notice</span>] <span class="number">1</span><span class="comment">#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6) </span></span><br><span class="line"><span class="number">2023</span><span class="string">/05/23</span> <span class="number">06</span><span class="string">:37:45</span> [<span class="string">notice</span>] <span class="number">1</span><span class="comment">#1: OS: Linux 3.10.0-1160.el7.x86_64</span></span><br><span class="line"><span class="number">2023</span><span class="string">/05/23</span> <span class="number">06</span><span class="string">:37:45</span> [<span class="string">notice</span>] <span class="number">1</span><span class="comment">#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span></span><br><span class="line"><span class="number">2023</span><span class="string">/05/23</span> <span class="number">06</span><span class="string">:37:45</span> [<span class="string">notice</span>] <span class="number">1</span><span class="comment">#1: start worker processes</span></span><br><span class="line"><span class="number">2023</span><span class="string">/05/23</span> <span class="number">06</span><span class="string">:37:45</span> [<span class="string">notice</span>] <span class="number">1</span><span class="comment">#1: start worker process 32</span></span><br><span class="line"><span class="number">2023</span><span class="string">/05/23</span> <span class="number">06</span><span class="string">:37:45</span> [<span class="string">notice</span>] <span class="number">1</span><span class="comment">#1: start worker process 33</span></span><br><span class="line"><span class="number">2023</span><span class="string">/05/23</span> <span class="number">06</span><span class="string">:37:45</span> [<span class="string">notice</span>] <span class="number">1</span><span class="comment">#1: start worker process 34</span></span><br><span class="line"><span class="number">2023</span><span class="string">/05/23</span> <span class="number">06</span><span class="string">:37:45</span> [<span class="string">notice</span>] <span class="number">1</span><span class="comment">#1: start worker process 35</span></span><br><span class="line"></span><br><span class="line"><span class="string">资源还可以通过名称（ResourceName）进行引用，在指定ResourceName后，使用get、delete、update、patch请求，就会被限制在这个资源实例范围内</span></span><br><span class="line"></span><br><span class="line"><span class="string">例如，下面的声明让一个主体只能对名为my-configmap的Configmap进行get和update操作：</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rabc.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namaspace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configmap-update</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&quot;my-configmap&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;update&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 常见角色实例</span></span><br><span class="line"><span class="string">（1）允许读取核心API组的Pod资源</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="string">（2）允许读写apps</span> <span class="string">API组中的deployment资源</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;delete&quot;</span>]</span><br><span class="line"><span class="string">（3）允许读取Pod以及读写job信息</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;jobs&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;delete&quot;</span>]</span><br><span class="line"><span class="string">（4）允许读取一个名为my-config的ConfigMap（必须绑定到一个RoleBinding来限制到一个Namespace下的ConfigMap）：</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&quot;my-configmap&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="string">（5）读取核心组的Node资源（Node属于集群级的资源，所以必须存在于ClusterRole中，并使用ClusterRoleBinding进行绑定）：</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="string">（6）允许对非资源端点“/healthz”及其所有子路径进行GET和POST操作（必须使用ClusterRole和ClusterRoleBinding）：</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> [<span class="string">&quot;/healthz&quot;</span>,<span class="string">&quot;/healthz/*&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;post&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">常见的角色绑定示例</span></span><br><span class="line"><span class="string">（1）用户名alice</span>	</span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alice</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">　　</span><br><span class="line"><span class="string">（2）组名alice</span>	</span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alice</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br><span class="line"><span class="string">（3）kube-system命名空间中默认Service</span> <span class="string">Account</span>	</span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SA授权</span></span><br><span class="line"><span class="string">（1）my-namespace中的my-sa</span> <span class="string">Service</span> <span class="string">Account授予只读权限</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">rolebinding</span> <span class="string">my-sa-view</span> <span class="string">--clusterrole=view</span> <span class="string">--serviceaccount=my-namespace:my-sa</span> <span class="string">--namespace=my-namespace</span></span><br><span class="line"></span><br><span class="line"><span class="string">（2）为一个命名空间中名为default的Service</span> <span class="string">Account授权</span></span><br><span class="line"><span class="string">如果一个应用没有指定</span> <span class="string">serviceAccountName，则会使用名为default的Service</span> <span class="string">Account。注意，赋予Service</span> <span class="string">Account</span> <span class="string">“default”的权限会让所有没有指定serviceAccountName的Pod都具有这些权限</span></span><br><span class="line"></span><br><span class="line"><span class="string">（3）为命名空间中所有Service</span> <span class="string">Account都授予一个角色</span></span><br><span class="line"><span class="string">如果希望在一个命名空间中，任何Service</span> <span class="string">Account应用都具有一个角色，则可以为这一命名空间的Service</span> <span class="string">Account群组进行授权</span></span><br><span class="line">	</span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">rolebinding</span> <span class="string">serviceaccounts-view</span> <span class="string">--clusterrole=view</span> <span class="string">--group=system:serviceaccounts:my-namespace</span> <span class="string">--namespace=my-namespace</span></span><br><span class="line"></span><br><span class="line"><span class="string">（4）为集群范围内所有Service</span> <span class="string">Account都授予一个低权限角色</span></span><br><span class="line"><span class="string">如果不想为每个命名空间管理授权，则可以把一个集群级别的角色赋给所有Service</span> <span class="string">Account。</span></span><br><span class="line">	</span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">serviceaccounts-view</span> <span class="string">--clusterrole=view</span> <span class="string">--group=system:serviceaccounts</span></span><br><span class="line"></span><br><span class="line"><span class="string">（5）为所有Service</span> <span class="string">Account授予超级用户权限</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">serviceaccounts-view</span> <span class="string">--clusterrole=cluster-admin</span> <span class="string">--group=system:serviceaccounts</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl创建资源对象</span></span><br><span class="line"><span class="string">（1）在命名空间rbac中为用户es授权admin</span> <span class="string">ClusterRole：</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">rolebinding</span> <span class="string">bob-admin-binding</span> <span class="string">--clusterrole=admin</span> <span class="string">--user=es</span> <span class="string">--namespace=rbac</span></span><br><span class="line"></span><br><span class="line">　　</span><br><span class="line"><span class="string">（2）在命名空间rbac中为名为myapp的Service</span> <span class="string">Account授予view</span> <span class="string">ClusterRole：</span></span><br><span class="line">	</span><br><span class="line"><span class="string">kubctl</span> <span class="string">create</span> <span class="string">rolebinding</span> <span class="string">myapp-role-binding</span> <span class="string">--clusterrole=view</span> <span class="string">--serviceaccount=rbac:myapp</span> <span class="string">--namespace=rbac</span></span><br><span class="line"></span><br><span class="line">　　</span><br><span class="line"><span class="string">（3）在全集群范围内为用户root授予cluster-admin</span> <span class="string">ClusterRole：</span></span><br><span class="line">	</span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">cluster-binding</span> <span class="string">--clusterrole=cluster-admin</span> <span class="string">--user=root</span></span><br><span class="line"></span><br><span class="line">　　</span><br><span class="line"><span class="string">（4）在全集群范围内为名为myapp的Service</span> <span class="string">Account授予view</span> <span class="string">ClusterRole：</span></span><br><span class="line">	</span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">service-account-binding</span> <span class="string">--clusterrole=view</span> <span class="string">--serviceaccount=myapp</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制不同用户访问k8s</span></span><br><span class="line"><span class="string">（1）生成一个私钥</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/etc/kubernetes/pki/</span></span><br><span class="line"><span class="string">(umask</span> <span class="number">077</span><span class="string">;</span> <span class="string">openssl</span> <span class="string">genrsa</span> <span class="string">-out</span> <span class="string">lucky.key</span> <span class="number">2048</span><span class="string">)</span> </span><br><span class="line"><span class="string">（2）生成一个证书请求</span></span><br><span class="line"><span class="string">openssl</span> <span class="string">req</span> <span class="string">-new</span> <span class="string">-key</span> <span class="string">lucky.key</span> <span class="string">-out</span> <span class="string">lucky.csr</span> <span class="string">-subj</span> <span class="string">&quot;/CN=lucky&quot;</span></span><br><span class="line"><span class="string">（3）生成一个证书</span></span><br><span class="line"><span class="string">openssl</span> <span class="string">x509</span> <span class="string">-req</span> <span class="string">-in</span> <span class="string">lucky.csr</span> <span class="string">-CA</span> <span class="string">ca.crt</span> <span class="string">-CAkey</span> <span class="string">ca.key</span> <span class="string">-CAcreateserial</span> <span class="string">-out</span> <span class="string">lucky.crt</span> <span class="string">-days</span> <span class="number">3650</span></span><br><span class="line"><span class="string">在kubeconfig下新增加一个lucky这个用户</span></span><br><span class="line"><span class="string">（1）把lucky这个用户添加到kubernetes集群中，可以用来认证apiserver的连接</span></span><br><span class="line">[<span class="string">root@xianchaomaster1</span> <span class="string">pki</span>]<span class="comment"># kubectl config set-credentials lucky --client-certificate=./lucky.crt --client-key=./lucky.key --embed-certs=true  </span></span><br><span class="line"><span class="string">（2）在kubeconfig下新增加一个lucky这个账号</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">set-context</span> <span class="string">lucky@kubernetes</span> <span class="string">--cluster=kubernetes</span> <span class="string">--user=lucky</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">lucky</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lucky@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">REDACTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">REDACTED</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lucky</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">REDACTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">REDACTED</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">pki</span>]<span class="comment"># kubectl get pod -n lucky-test </span></span><br><span class="line"><span class="literal">No</span> <span class="string">resources</span> <span class="string">found</span> <span class="string">in</span> <span class="string">lucky-test</span> <span class="string">namespace.</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">pki</span>]<span class="comment"># kubectl get pod -n default </span></span><br><span class="line"><span class="string">Error</span> <span class="string">from</span> <span class="string">server</span> <span class="string">(Forbidden):</span> <span class="attr">pods is forbidden:</span> <span class="string">User</span> <span class="string">&quot;lucky&quot;</span> <span class="string">cannot</span> <span class="string">list</span> <span class="string">resource</span> <span class="string">&quot;pods&quot;</span> <span class="string">in</span> <span class="string">API</span> <span class="string">group</span> <span class="string">&quot;&quot;</span> <span class="string">in</span> <span class="string">the</span> <span class="string">namespace</span> <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="resourcequota准入控制器"><a class="markdownIt-Anchor" href="#resourcequota准入控制器">#</a> <strong>ResourceQuota 准入控制器</strong></h3>
<p><strong>ResourceQuota 准入控制器是 k8s 上内置的准入控制器，默认该控制器是启用的状态，它主要作用是用来限制一个名称空间下的资源的使用，它能防止在一个名称空间下的 pod 被过多创建时，导致过多占用 k8s 资源，简单讲它是用来在名称空间级别限制用户的资源使用。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">quota-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">quota</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;6&quot;</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">2Gi</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">10Gi</span></span><br><span class="line">    <span class="attr">count/deployments.apps:</span> <span class="string">&quot;6&quot;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;6&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">quota</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">1</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">2</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">quota</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">rbac</span>]<span class="comment"># kubectl get pod -n quota </span></span><br><span class="line"><span class="string">NAME</span>                    <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">quota-8b9bc78cd-d2jcc</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">16s</span></span><br><span class="line"><span class="string">quota-8b9bc78cd-dzxp8</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">16s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">quota</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">7</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">quota</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">1</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">quota</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">rbac</span>]<span class="comment"># kubectl get pod -n quota </span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">quota-646fb6b848-c2h8z</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">24s</span></span><br><span class="line"><span class="string">quota-646fb6b848-v5pmr</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">24s</span></span><br><span class="line"><span class="string">quota-646fb6b848-z2p5k</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">24s</span></span><br><span class="line"><span class="string">quota-646fb6b848-zwwd7</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">24s</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span><span class="string">、限制存储空间大小</span></span><br><span class="line">[<span class="string">root@xianchaomaster1</span> <span class="string">~</span>]<span class="comment"># vim resourcequota-2.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">quota-storage-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">quota</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">requests.storage:</span> <span class="string">&quot;5Gi&quot;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;5&quot;</span></span><br><span class="line">    <span class="attr">requests.ephemeral-storage:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">    <span class="attr">limits.ephemeral-storage:</span> <span class="string">&quot;2Gi&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="limitranger准入控制器"><a class="markdownIt-Anchor" href="#limitranger准入控制器">#</a> LimitRanger 准入控制器 \</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">LimitRanger准入控制器是k8s上一个内置的准入控制器，LimitRange是k8s上的一个标准资源，它主要用来定义在某个名称空间下限制pod或pod里的容器对k8s上的cpu和内存资源使用；它能够定义我们在某个名称空间下创建pod时使用的cpu和内存的上限和下限以及默认cpu、内存的上下限。</span></span><br><span class="line"><span class="string">如果我们创建pod时定义了资源上下限，但不满足LimitRange规则中定义的资源上下限，此时LimitRanger就会拒绝我们创建此pod；如果我们在LimitRange规则中定义了默认的资源上下限制，我们创建资源没有指定其资源限制，它默认会使用LimitRange规则中的默认资源限制；同样的逻辑LimitRanger可以限制一个pod使用资源的上下限，它还可以限制pod中的容器的资源上下限，比限制pod更加精准；不管是针对pod还是pod里的容器，它始终只是限制单个pod资源使用。</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limit</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-memory</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">limit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">default:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1000Mi</span></span><br><span class="line">    <span class="attr">defaultRequest:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">max:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">2000Mi</span></span><br><span class="line">    <span class="attr">maxLimitRequestRatio:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="number">4</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">limit</span> <span class="comment">#ClusterRoleBinding的名字</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">default</span>  <span class="comment">#serviceaccount资源对象的name</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">limit</span> <span class="comment">#serviceaccount的namespace</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span> <span class="comment">#k8s集群中最高权限的角色</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span> <span class="comment"># ServiceAccount的名字</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">limit</span> <span class="comment"># serviceaccount的namespace</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">default</span> <span class="comment">#ServiceAccount的标签</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">limit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attr">Limits:</span></span><br><span class="line">      <span class="attr">cpu:</span>     <span class="number">1</span></span><br><span class="line">      <span class="attr">memory:</span>  <span class="string">1000Mi</span></span><br><span class="line">    <span class="attr">Requests:</span></span><br><span class="line">      <span class="attr">cpu:</span>        <span class="string">500m</span></span><br><span class="line">      <span class="attr">memory:</span>     <span class="string">500Mi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-request</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">limit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">rbac</span>]<span class="comment"># kubectl apply -f haha.yaml </span></span><br><span class="line"><span class="string">Error</span> <span class="string">from</span> <span class="string">server</span> <span class="string">(Forbidden):</span> <span class="string">error</span> <span class="string">when</span> <span class="string">creating</span> <span class="attr">&quot;haha.yaml&quot;:</span> <span class="string">pods</span> <span class="string">&quot;pod-request&quot;</span> <span class="attr">is forbidden:</span> [<span class="string">minimum</span> <span class="string">cpu</span> <span class="string">usage</span> <span class="string">per</span> <span class="string">Container</span> <span class="string">is</span> <span class="string">500m</span>, <span class="string">but</span> <span class="string">request</span> <span class="string">is</span> <span class="string">100m</span>, <span class="string">cpu</span> <span class="string">max</span> <span class="string">limit</span> <span class="string">to</span> <span class="string">request</span> <span class="string">ratio</span> <span class="string">per</span> <span class="string">Container</span> <span class="string">is</span> <span class="number">4</span>, <span class="string">but</span> <span class="string">provided</span> <span class="string">ratio</span> <span class="string">is</span> <span class="number">10.000000</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="kubesphere"><a class="markdownIt-Anchor" href="#kubesphere">#</a> kubesphere</h1>
<p>建议配置： master：4c8g  node：4c16g</p>
<h2 id="平台安装"><a class="markdownIt-Anchor" href="#平台安装">#</a> 平台安装</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now <span class="built_in">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and <span class="keyword">then</span> running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm <span class="built_in">join</span> k8s-master:6443 --token butsu9.lcap4rmxigogjm3g \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:96ec447684310e31f9890dab205123d2081c5e1acbf025e88c727a1951fe0f54 \</span><br><span class="line">    --control-plane </span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> k8s-master:6443 --token butsu9.lcap4rmxigogjm3g \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:96ec447684310e31f9890dab205123d2081c5e1acbf025e88c727a1951fe0f54 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="配置前置存储类"><a class="markdownIt-Anchor" href="#配置前置存储类">#</a> 配置前置存储类</h3>
<p>安装 nfs-server</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在每个机器。</span></span><br><span class="line">yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在master 执行以下命令 </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot;</span> &gt; /etc/exports</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行以下命令，启动 nfs 服务;创建共享目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /nfs/data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在master执行</span></span><br><span class="line">systemctl <span class="built_in">enable</span> rpcbind</span><br><span class="line">systemctl <span class="built_in">enable</span> nfs-server</span><br><span class="line">systemctl start rpcbind</span><br><span class="line">systemctl start nfs-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使配置生效</span></span><br><span class="line">exportfs -r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查配置是否生效</span></span><br><span class="line">exportfs</span><br></pre></td></tr></table></figure>
<p>配置 nfs-client</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">showmount -e 172.23.142.216</span><br><span class="line"></span><br><span class="line">mkdir -p /nfs/data</span><br><span class="line"></span><br><span class="line">mount -t nfs 172.23.142.216:/nfs/data /nfs/data</span><br></pre></td></tr></table></figure>
<p>配置默认存储</p>
<p>配置动态供应的默认存储类</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建了一个存储类</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-storage</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">storageclass.kubernetes.io/is-default-class:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;true&quot;</span>  <span class="comment">## 删除pv的时候，pv的内容是否要备份</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/nfs-subdir-external-provisioner:v4.0.2</span></span><br><span class="line">          <span class="comment"># resources:</span></span><br><span class="line">          <span class="comment">#    limits:</span></span><br><span class="line">          <span class="comment">#      cpu: 10m</span></span><br><span class="line">          <span class="comment">#    requests:</span></span><br><span class="line">          <span class="comment">#      cpu: 10m</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">172.23</span><span class="number">.142</span><span class="number">.216</span> <span class="comment">## 指定自己nfs服务器地址</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span>  </span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfs/data</span>  <span class="comment">## nfs服务器共享的目录</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">172.23</span><span class="number">.142</span><span class="number">.216</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs/data</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl apply -f sc.yml </span></span><br><span class="line">storageclass.storage.k8s.io/nfs-storage created</span><br><span class="line">deployment.apps/nfs-client-provisioner created</span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span><br><span class="line">role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get sc    # storageclass</span></span><br><span class="line">NAME                    PROVISIONER                                   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">nfs-storage (default)   k8s-sigs.io/nfs-subdir-external-provisioner   Delete          Immediate           <span class="literal">false</span>                  18s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-pvc</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 200Mi</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl apply -f pvc.yml </span></span><br><span class="line">persistentvolumeclaim/nginx-pvc created</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">nginx-pvc   Bound    pvc-2f0e7123-3311-4045-bba9-acdcbad0a572   200Mi      RWX            nfs-storage    10s</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pv</span></span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="line">pv01-10m                                   10M        RWX            Retain           Available                       nfs                     22h</span><br><span class="line">pv02-1gi                                   1Gi        RWX            Retain           Released    default/nginx-pvc   nfs                     22h</span><br><span class="line">pv03-3gi                                   3Gi        RWX            Retain           Available                       nfs                     22h</span><br><span class="line">pvc-2f0e7123-3311-4045-bba9-acdcbad0a572   200Mi      RWX            Delete           Bound       default/nginx-pvc   nfs-storage             24s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="安装metrics-server"><a class="markdownIt-Anchor" href="#安装metrics-server">#</a> 安装 metrics-server</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-admin:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-edit:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-view:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:aggregated-metrics-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/stats</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server-auth-reader</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">extension-apiserver-authentication-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server:system:auth-delegator</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:auth-delegator</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--cert-dir=/tmp</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-insecure-tls</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--secure-port=4443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-use-node-status-port</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/metrics-server:v0.4.3</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/livez</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">https</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4443</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/readyz</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">https</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">metrics-server</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1beta1.metrics.k8s.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">  <span class="attr">groupPriorityMinimum:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">insecureSkipTLSVerify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1beta1</span></span><br><span class="line">  <span class="attr">versionPriority:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl apply -f metrics </span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl top nodes </span></span><br><span class="line">NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%     </span><br><span class="line">master   258m         12%    1889Mi          49%         </span><br><span class="line">node1    &lt;unknown&gt;                           &lt;unknown&gt;               &lt;unknown&gt;               &lt;unknown&gt;               </span><br><span class="line">node2    &lt;unknown&gt;                           &lt;unknown&gt;               &lt;unknown&gt;               &lt;unknown&gt;               </span><br><span class="line">        </span><br><span class="line">[root@master ~]<span class="comment"># kubectl top pods  -A </span></span><br><span class="line">NAMESPACE         NAME                                       CPU(cores)   MEMORY(bytes)   </span><br><span class="line">default           nfs-client-provisioner-786945db78-788mx    1m           11Mi            </span><br><span class="line">kube-system       calico-kube-controllers-57c7b58f66-jq7lm   3m           23Mi            </span><br><span class="line">kube-system       calico-node-4bttn                          38m          150Mi           </span><br><span class="line">kube-system       coredns-5897cd56c4-2fhkm                   2m           14Mi            </span><br><span class="line">kube-system       coredns-5897cd56c4-2l59f                   3m           10Mi            </span><br><span class="line">kube-system       etcd-master                                13m          49Mi            </span><br><span class="line">kube-system       kube-apiserver-master                      54m          467Mi           </span><br><span class="line">kube-system       kube-controller-manager-master             22m          58Mi            </span><br><span class="line">kube-system       kube-proxy-d4sgz                           1m           14Mi            </span><br><span class="line">kube-system       kube-scheduler-master                      3m           23Mi            </span><br><span class="line">kube-system       metrics-server-6497cc6c5f-n4l62            3m           13Mi            </span><br><span class="line">tigera-operator   tigera-operator-57cb64cf85-kqsvh           3m           27Mi          </span><br></pre></td></tr></table></figure>
<h3 id="全功能安装"><a class="markdownIt-Anchor" href="#全功能安装">#</a> 全功能安装</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubesphere/ks-installer/releases/download/v3.3.2/kubesphere-installer.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wget https://github.com/kubesphere/ks-installer/releases/download/v3.3.2/cluster-configuration.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># vi cluster-configuration.yaml </span></span><br><span class="line">[root@master ~]<span class="comment"># vim cluster-configuration.yaml </span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl apply -f kubesphere-installer.yaml </span></span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterconfigurations.installer.kubesphere.io created</span><br><span class="line">namespace/kubesphere-system created</span><br><span class="line">serviceaccount/ks-installer created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/ks-installer created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/ks-installer created</span><br><span class="line">deployment.apps/ks-installer created</span><br><span class="line">[root@master ~]<span class="comment"># kubectl apply -f cluster-configuration.yaml </span></span><br><span class="line">clusterconfiguration.installer.kubesphere.io/ks-installer created</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改clust.yml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: installer.kubesphere.io/v1alpha1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  name: ks-installer</span><br><span class="line">  namespace: kubesphere-system</span><br><span class="line">  labels:</span><br><span class="line">    version: v3.1.1</span><br><span class="line">spec:</span><br><span class="line">  persistence:</span><br><span class="line">    storageClass: <span class="string">&quot;&quot;</span>        <span class="comment"># If there is no default StorageClass in your cluster, you need to specify an existing StorageClass here.</span></span><br><span class="line">  authentication:</span><br><span class="line">    jwtSecret: <span class="string">&quot;&quot;</span>           <span class="comment"># Keep the jwtSecret consistent with the Host Cluster. Retrieve the jwtSecret by executing &quot;kubectl -n kubesphere-system get cm kubesphere-config -o yaml | grep -v &quot;apiVersion&quot; | grep jwtSecret&quot; on the Host Cluster.</span></span><br><span class="line">  local_registry: <span class="string">&quot;&quot;</span>        <span class="comment"># Add your private registry address if it is needed.</span></span><br><span class="line">  etcd:</span><br><span class="line">    monitoring: <span class="literal">true</span>       <span class="comment"># Enable or disable etcd monitoring dashboard installation. You have to create a Secret for etcd before you enable it.</span></span><br><span class="line">    endpointIps: 172.31.0.4  <span class="comment"># etcd cluster EndpointIps. It can be a bunch of IPs here.</span></span><br><span class="line">    port: 2379              <span class="comment"># etcd port.</span></span><br><span class="line">    tlsEnable: <span class="literal">true</span></span><br><span class="line">  common:</span><br><span class="line">    redis:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">    openldap:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">    minioVolumeSize: 20Gi <span class="comment"># Minio PVC size.</span></span><br><span class="line">    openldapVolumeSize: 2Gi   <span class="comment"># openldap PVC size.</span></span><br><span class="line">    redisVolumSize: 2Gi <span class="comment"># Redis PVC size.</span></span><br><span class="line">    monitoring:</span><br><span class="line">      <span class="comment"># type: external   # Whether to specify the external prometheus stack, and need to modify the endpoint at the next line.</span></span><br><span class="line">      endpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090 <span class="comment"># Prometheus endpoint to get metrics data.</span></span><br><span class="line">    es:   <span class="comment"># Storage backend for logging, events and auditing.</span></span><br><span class="line">      <span class="comment"># elasticsearchMasterReplicas: 1   # The total number of master nodes. Even numbers are not allowed.</span></span><br><span class="line">      <span class="comment"># elasticsearchDataReplicas: 1     # The total number of data nodes.</span></span><br><span class="line">      elasticsearchMasterVolumeSize: 4Gi   <span class="comment"># The volume size of Elasticsearch master nodes.</span></span><br><span class="line">      elasticsearchDataVolumeSize: 20Gi    <span class="comment"># The volume size of Elasticsearch data nodes.</span></span><br><span class="line">      logMaxAge: 7                     <span class="comment"># Log retention time in built-in Elasticsearch. It is 7 days by default.</span></span><br><span class="line">      elkPrefix: logstash              <span class="comment"># The string making up index names. The index name will be formatted as ks-&lt;elk_prefix&gt;-log.</span></span><br><span class="line">      basicAuth:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">        username: <span class="string">&quot;&quot;</span></span><br><span class="line">        password: <span class="string">&quot;&quot;</span></span><br><span class="line">      externalElasticsearchUrl: <span class="string">&quot;&quot;</span></span><br><span class="line">      externalElasticsearchPort: <span class="string">&quot;&quot;</span></span><br><span class="line">  console:</span><br><span class="line">    enableMultiLogin: <span class="literal">true</span>  <span class="comment"># Enable or disable simultaneous logins. It allows different users to log in with the same account at the same time.</span></span><br><span class="line">    port: 30880</span><br><span class="line">  alerting:                <span class="comment"># (CPU: 0.1 Core, Memory: 100 MiB) It enables users to customize alerting policies to send messages to receivers in time with different time intervals and alerting levels to choose from.</span></span><br><span class="line">    enabled: <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Alerting System.</span></span><br><span class="line">    <span class="comment"># thanosruler:</span></span><br><span class="line">    <span class="comment">#   replicas: 1</span></span><br><span class="line">    <span class="comment">#   resources: &#123;&#125;</span></span><br><span class="line">  auditing:                <span class="comment"># Provide a security-relevant chronological set of records，recording the sequence of activities happening on the platform, initiated by different tenants.</span></span><br><span class="line">    enabled: <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Auditing Log System. </span></span><br><span class="line">  devops:                  <span class="comment"># (CPU: 0.47 Core, Memory: 8.6 G) Provide an out-of-the-box CI/CD system based on Jenkins, and automated workflow tools including Source-to-Image &amp; Binary-to-Image.</span></span><br><span class="line">    enabled: <span class="literal">true</span>             <span class="comment"># Enable or disable the KubeSphere DevOps System.</span></span><br><span class="line">    jenkinsMemoryLim: 2Gi      <span class="comment"># Jenkins memory limit.</span></span><br><span class="line">    jenkinsMemoryReq: 1500Mi   <span class="comment"># Jenkins memory request.</span></span><br><span class="line">    jenkinsVolumeSize: 8Gi     <span class="comment"># Jenkins volume size.</span></span><br><span class="line">    jenkinsJavaOpts_Xms: 512m  <span class="comment"># The following three fields are JVM parameters.</span></span><br><span class="line">    jenkinsJavaOpts_Xmx: 512m</span><br><span class="line">    jenkinsJavaOpts_MaxRAM: 2g</span><br><span class="line">  events:                  <span class="comment"># Provide a graphical web console for Kubernetes Events exporting, filtering and alerting in multi-tenant Kubernetes clusters.</span></span><br><span class="line">    enabled: <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Events System.</span></span><br><span class="line">    ruler:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">      replicas: 2</span><br><span class="line">  logging:                 <span class="comment"># (CPU: 57 m, Memory: 2.76 G) Flexible logging functions are provided for log query, collection and management in a unified console. Additional log collectors can be added, such as Elasticsearch, Kafka and Fluentd.</span></span><br><span class="line">    enabled: <span class="literal">true</span>         <span class="comment"># Enable or disable the KubeSphere Logging System.</span></span><br><span class="line">    logsidecar:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">      replicas: 2</span><br><span class="line">  metrics_server:                    <span class="comment"># (CPU: 56 m, Memory: 44.35 MiB) It enables HPA (Horizontal Pod Autoscaler).</span></span><br><span class="line">    enabled: <span class="literal">false</span>                   <span class="comment"># Enable or disable metrics-server.</span></span><br><span class="line">  monitoring:</span><br><span class="line">    storageClass: <span class="string">&quot;&quot;</span>                 <span class="comment"># If there is an independent StorageClass you need for Prometheus, you can specify it here. The default StorageClass is used by default.</span></span><br><span class="line">    <span class="comment"># prometheusReplicas: 1          # Prometheus replicas are responsible for monitoring different segments of data source and providing high availability.</span></span><br><span class="line">    prometheusMemoryRequest: 400Mi   <span class="comment"># Prometheus request memory.</span></span><br><span class="line">    prometheusVolumeSize: 20Gi       <span class="comment"># Prometheus PVC size.</span></span><br><span class="line">    <span class="comment"># alertmanagerReplicas: 1          # AlertManager Replicas.</span></span><br><span class="line">  multicluster:</span><br><span class="line">    clusterRole: none  <span class="comment"># host | member | none  # You can install a solo cluster, or specify it as the Host or Member Cluster.</span></span><br><span class="line">  network:</span><br><span class="line">    networkpolicy: <span class="comment"># Network policies allow network isolation within the same cluster, which means firewalls can be set up between certain instances (Pods).</span></span><br><span class="line">      <span class="comment"># Make sure that the CNI network plugin used by the cluster supports NetworkPolicy. There are a number of CNI network plugins that support NetworkPolicy, including Calico, Cilium, Kube-router, Romana and Weave Net.</span></span><br><span class="line">      enabled: <span class="literal">true</span> <span class="comment"># Enable or disable network policies.</span></span><br><span class="line">    ippool: <span class="comment"># Use Pod IP Pools to manage the Pod network address space. Pods to be created can be assigned IP addresses from a Pod IP Pool.</span></span><br><span class="line">      <span class="built_in">type</span>: calico <span class="comment"># Specify &quot;calico&quot; for this field if Calico is used as your CNI plugin. &quot;none&quot; means that Pod IP Pools are disabled.</span></span><br><span class="line">    topology: <span class="comment"># Use Service Topology to view Service-to-Service communication based on Weave Scope.</span></span><br><span class="line">      <span class="built_in">type</span>: none <span class="comment"># Specify &quot;weave-scope&quot; for this field to enable Service Topology. &quot;none&quot; means that Service Topology is disabled.</span></span><br><span class="line">  openpitrix: <span class="comment"># An App Store that is accessible to all platform tenants. You can use it to manage apps across their entire lifecycle.</span></span><br><span class="line">    store:</span><br><span class="line">      enabled: <span class="literal">true</span> <span class="comment"># Enable or disable the KubeSphere App Store.</span></span><br><span class="line">  servicemesh:         <span class="comment"># (0.3 Core, 300 MiB) Provide fine-grained traffic management, observability and tracing, and visualized traffic topology.</span></span><br><span class="line">    enabled: <span class="literal">true</span>     <span class="comment"># Base component (pilot). Enable or disable KubeSphere Service Mesh (Istio-based).</span></span><br><span class="line">  kubeedge:          <span class="comment"># Add edge nodes to your cluster and deploy workloads on edge nodes.</span></span><br><span class="line">    enabled: <span class="literal">true</span>   <span class="comment"># Enable or disable KubeEdge.</span></span><br><span class="line">    cloudCore:</span><br><span class="line">      nodeSelector: &#123;<span class="string">&quot;node-role.kubernetes.io/worker&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">      tolerations: []</span><br><span class="line">      cloudhubPort: <span class="string">&quot;10000&quot;</span></span><br><span class="line">      cloudhubQuicPort: <span class="string">&quot;10001&quot;</span></span><br><span class="line">      cloudhubHttpsPort: <span class="string">&quot;10002&quot;</span></span><br><span class="line">      cloudstreamPort: <span class="string">&quot;10003&quot;</span></span><br><span class="line">      tunnelPort: <span class="string">&quot;10004&quot;</span></span><br><span class="line">      cloudHub:</span><br><span class="line">        advertiseAddress: <span class="comment"># At least a public IP address or an IP address which can be accessed by edge nodes must be provided.</span></span><br><span class="line">          - <span class="string">&quot;&quot;</span>            <span class="comment"># Note that once KubeEdge is enabled, CloudCore will malfunction if the address is not provided.</span></span><br><span class="line">        nodeLimit: <span class="string">&quot;100&quot;</span></span><br><span class="line">      service:</span><br><span class="line">        cloudhubNodePort: <span class="string">&quot;30000&quot;</span></span><br><span class="line">        cloudhubQuicNodePort: <span class="string">&quot;30001&quot;</span></span><br><span class="line">        cloudhubHttpsNodePort: <span class="string">&quot;30002&quot;</span></span><br><span class="line">        cloudstreamNodePort: <span class="string">&quot;30003&quot;</span></span><br><span class="line">        tunnelNodePort: <span class="string">&quot;30004&quot;</span></span><br><span class="line">    edgeWatcher:</span><br><span class="line">      nodeSelector: &#123;<span class="string">&quot;node-role.kubernetes.io/worker&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">      tolerations: []</span><br><span class="line">      edgeWatcherAgent:</span><br><span class="line">        nodeSelector: &#123;<span class="string">&quot;node-role.kubernetes.io/worker&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">        tolerations: []</span><br></pre></td></tr></table></figure>
<p>检查日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l <span class="string">&#x27;app in (ks-install, ks-installer)&#x27;</span> -o jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 排查</span></span><br><span class="line">kubectl describe pod -n namespace name</span><br></pre></td></tr></table></figure>
<p>etcd 监控证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs  --from-file=etcd-client-ca.crt=/etc/kubernetes/pki/etcd/ca.crt  --from-file=etcd-client.crt=/etc/kubernetes/pki/apiserver-etcd-client.crt  --from-file=etcd-client.key=/etc/kubernetes/pki/apiserver-etcd-client.key</span><br></pre></td></tr></table></figure>
<h2 id="linxu-安装-单节点"><a class="markdownIt-Anchor" href="#linxu-安装-单节点">#</a> linxu 安装 单节点</h2>
<p>1. 准备 kubekey</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export KKZONE=cn</span><br><span class="line">curl -sfL https://get-kk.kubesphere.io | VERSION=v3.0.7 sh -</span><br><span class="line">chmod +x kk</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2. 使用 kubekey 引导安装集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./kk create cluster [--with-kubernetes version] [--with-kubesphere version]</span><br><span class="line">./kk create cluster --with-kubernetes v1.22.12 --with-kubesphere v3.3.2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这样不是全功能平台</p>
<p>安装后开启功能</p>
<blockquote>
<ol>
<li></li>
<li>
<p>以  <code>admin</code>  用户登录控制台，点击左上角的<strong>平台管理</strong>，选择<strong>集群管理</strong>。</p>
</li>
<li>
<p>点击<strong>定制资源定义</strong>，在搜索栏中输入  <code>clusterconfiguration</code> ，点击搜索结果查看其详细页面。</p>
<p>信息</p>
<p>定制资源定义（CRD）允许用户在不新增 API 服务器的情况下创建一种新的资源类型，用户可以像使用其他 Kubernetes 原生对象一样使用这些定制资源。</p>
</li>
<li>
<p>在<strong>自定义资源</strong>中，点击  <code>ks-installer</code>  右侧的 <img data-src="https://kubesphere.io/images/docs/v3.3/zh-cn/enable-pluggable-components/kubesphere-devops-system/three-dots.png" alt="img">，选择<strong>编辑 YAML</strong>。</p>
</li>
<li>
<p>在该 YAML 文件中，搜索  <code>devops</code> ，将  <code>enabled</code>  的  <code>false</code>  改为  <code>true</code> 。完成后，点击右下角的<strong>确定</strong>，保存配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">devops:</span><br><span class="line">  enabled: true # 将“false”更改为“true”。</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 kubectl 中执行以下命令检查安装过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l &#x27;app in (ks-install, ks-installer)&#x27; -o jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;) -f</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<h2 id="linux多节点安装"><a class="markdownIt-Anchor" href="#linux多节点安装">#</a> linux 多节点安装</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master节点</span></span><br><span class="line"><span class="built_in">export</span> KKZONE=cn</span><br><span class="line">curl -sfL https://get-kk.kubesphere.io | VERSION=v3.0.7 sh -</span><br><span class="line"><span class="built_in">chmod</span> +x kk</span><br><span class="line"></span><br><span class="line"> ./kk create config --with-kubernetes v1.22.12 --with-kubesphere v3.3.2</span><br><span class="line"></span><br><span class="line">vim config.sample</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - &#123;name: master, address: 192.168.0.2, internalAddress: 192.168.0.2, user: ubuntu, password: Testing123&#125;</span><br><span class="line">  - &#123;name: node1, address: 192.168.0.3, internalAddress: 192.168.0.3, user: ubuntu, password: Testing123&#125;</span><br><span class="line">  - &#123;name: node2, address: 192.168.0.4, internalAddress: 192.168.0.4, user: ubuntu, password: Testing123&#125;</span><br><span class="line">  roleGroups:</span><br><span class="line">    etcd:</span><br><span class="line">    - master</span><br><span class="line">    control-plane:</span><br><span class="line">    - master</span><br><span class="line">    worker:</span><br><span class="line">    - node1</span><br><span class="line">    - node2</span><br><span class="line">  controlPlaneEndpoint:</span><br><span class="line">    domain: lb.kubesphere.local</span><br><span class="line">    address: <span class="string">&quot;&quot;</span></span><br><span class="line">    port: 6443</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">./kk create cluster -f config-sample.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9rdWJlc3BoZXJlLmlvL3poL2RvY3MvdjMuMy9pbnN0YWxsaW5nLW9uLWxpbnV4L2ludHJvZHVjdGlvbi9tdWx0aW92ZXJ2aWV3LyMlRTYlQUQlQTUlRTklQUElQTQtMyVFNSU4OCU5QiVFNSVCQiVCQSVFOSU5QiU4NiVFNyVCRSVBNA==">多节点安装 (kubesphere.io)</span></p>
<h2 id="部署应用"><a class="markdownIt-Anchor" href="#部署应用">#</a> 部署应用</h2>
<h3 id="使用镜像部署"><a class="markdownIt-Anchor" href="#使用镜像部署">#</a> 使用镜像部署</h3>
<p>deploy：部署无状态应用</p>
<p>stateful：部署有状态应用，中间件</p>
<p>daemon：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230413152836946.png" alt="image-20230413152836946"></p>
<p>工作负载 -&gt; PVC -&gt; configmap -&gt; service -&gt; ingress</p>
<p>pvc 建议现用现创</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 建议部署流程</span></span><br><span class="line">1.定义配置字典</span><br><span class="line">2.应用负载-创建工作负载</span><br><span class="line">3.创建工作负载时创建持久卷</span><br></pre></td></tr></table></figure>
<h3 id="使用应用市场部署"><a class="markdownIt-Anchor" href="#使用应用市场部署">#</a> 使用应用市场部署</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230414155446759.png" alt="image-20230414155446759"></p>
<h3 id="使用应用模板部署"><a class="markdownIt-Anchor" href="#使用应用模板部署">#</a> 使用应用模板部署</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9oZWxtLnNoLw==">Helm</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9hcnRpZmFjdGh1Yi5pby8=">Artifact Hub</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.找到仓库地址</span><br><span class="line">https://charts.bitnami.com/bitnami</span><br><span class="line">2.找到对应的工作空间</span><br><span class="line">添加应用仓库</span><br><span class="line">创建应用时从应用模板创建</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230414155403399.png" alt="image-20230414155403399"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230414155326651.png" alt="image-20230414155326651"></p>
<h2 id="部署ruoyi-cloud"><a class="markdownIt-Anchor" href="#部署ruoyi-cloud">#</a> 部署 ruoyi cloud</h2>
<h3 id="本地部署"><a class="markdownIt-Anchor" href="#本地部署">#</a> 本地部署</h3>
<p>1. 下载 ruoyi cloud 源码</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20veV9wcm9qZWN0L1J1b1lpLUNsb3Vk">RuoYi-Cloud: 🎉 基于 Spring Boot、Spring Cloud &amp; Alibaba 的分布式微服务架构权限管理系统，同时提供了 Vue3 的版本 (gitee.com)</span></p>
<p>2. 下载 nacos</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9uYWNvcy5pby96aC1jbi9kb2NzL3F1aWNrLXN0YXJ0Lmh0bWw=">Nacos 快速开始</span></p>
<p>3. 修改配置文件</p>
<p><code>application.properties</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.platform=mysql</span><br><span class="line"><span class="comment"># spring.sql.init.platform=mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Count of DB:</span></span><br><span class="line">db.num=1</span><br><span class="line"></span><br><span class="line"><span class="comment">### Connect URL of DB:</span></span><br><span class="line">db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=<span class="literal">true</span>&amp;useUnicode=<span class="literal">true</span>&amp;useSSL=<span class="literal">false</span>&amp;serverTimezone=UTC</span><br><span class="line">db.user.0=root</span><br><span class="line">db.password.0=root123</span><br></pre></td></tr></table></figure>
<p>创建数据库 nacos</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230414161432325.png" alt="image-20230414161432325"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright 1999-2018 Alibaba Group Holding Ltd.</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) DEFAULT NULL,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class="line">  `src_ip` varchar(50) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  `c_desc` varchar(256) DEFAULT NULL,</span><br><span class="line">  `c_use` varchar(64) DEFAULT NULL,</span><br><span class="line">  `effect` varchar(64) DEFAULT NULL,</span><br><span class="line">  `type` varchar(64) DEFAULT NULL,</span><br><span class="line">  `c_schema` text,</span><br><span class="line">  `encrypted_data_key` text NOT NULL COMMENT &#x27;秘钥&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info_aggr   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info_aggr` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `datum_id` varchar(255) NOT NULL COMMENT &#x27;datum_id&#x27;,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;内容&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;增加租户字段&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info_beta   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info_beta` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class="line">  `beta_ips` varchar(1024) DEFAULT NULL COMMENT &#x27;betaIps&#x27;,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class="line">  `src_ip` varchar(50) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  `encrypted_data_key` text NOT NULL COMMENT &#x27;秘钥&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_beta&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info_tag   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info_tag` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class="line">  `tag_id` varchar(128) NOT NULL COMMENT &#x27;tag_id&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class="line">  `src_ip` varchar(50) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_tag&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_tags_relation   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_tags_relation` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;id&#x27;,</span><br><span class="line">  `tag_name` varchar(128) NOT NULL COMMENT &#x27;tag_name&#x27;,</span><br><span class="line">  `tag_type` varchar(64) DEFAULT NULL COMMENT &#x27;tag_type&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class="line">  `nid` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  PRIMARY KEY (`nid`),</span><br><span class="line">  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_tag_relation&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = group_capacity   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `group_capacity` (</span><br><span class="line">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Group ID，空字符表示整个集群&#x27;,</span><br><span class="line">  `quota` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;配额，0表示使用默认值&#x27;,</span><br><span class="line">  `usage` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;使用量&#x27;,</span><br><span class="line">  `max_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;聚合子配置最大个数，，0表示使用默认值&#x27;,</span><br><span class="line">  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;最大变更历史数量&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_group_id` (`group_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;集群、各Group容量信息表&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = his_config_info   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `his_config_info` (</span><br><span class="line">  `id` bigint(20) unsigned NOT NULL,</span><br><span class="line">  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `data_id` varchar(255) NOT NULL,</span><br><span class="line">  `group_id` varchar(128) NOT NULL,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class="line">  `content` longtext NOT NULL,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  `src_user` text,</span><br><span class="line">  `src_ip` varchar(50) DEFAULT NULL,</span><br><span class="line">  `op_type` char(10) DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  `encrypted_data_key` text NOT NULL COMMENT &#x27;秘钥&#x27;,</span><br><span class="line">  PRIMARY KEY (`nid`),</span><br><span class="line">  KEY `idx_gmt_create` (`gmt_create`),</span><br><span class="line">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class="line">  KEY `idx_did` (`data_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;多租户改造&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = tenant_capacity   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `tenant_capacity` (</span><br><span class="line">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Tenant ID&#x27;,</span><br><span class="line">  `quota` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;配额，0表示使用默认值&#x27;,</span><br><span class="line">  `usage` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;使用量&#x27;,</span><br><span class="line">  `max_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;聚合子配置最大个数&#x27;,</span><br><span class="line">  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;最大变更历史数量&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;租户容量信息表&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE `tenant_info` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `kp` varchar(128) NOT NULL COMMENT &#x27;kp&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) default &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class="line">  `tenant_name` varchar(128) default &#x27;&#x27; COMMENT &#x27;tenant_name&#x27;,</span><br><span class="line">  `tenant_desc` varchar(256) DEFAULT NULL COMMENT &#x27;tenant_desc&#x27;,</span><br><span class="line">  `create_source` varchar(32) DEFAULT NULL COMMENT &#x27;create_source&#x27;,</span><br><span class="line">  `gmt_create` bigint(20) NOT NULL COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` bigint(20) NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;tenant_info&#x27;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `users` (</span><br><span class="line">	`username` varchar(50) NOT NULL PRIMARY KEY,</span><br><span class="line">	`password` varchar(500) NOT NULL,</span><br><span class="line">	`enabled` boolean NOT NULL</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE `roles` (</span><br><span class="line">	`username` varchar(50) NOT NULL,</span><br><span class="line">	`role` varchar(50) NOT NULL,</span><br><span class="line">	UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE `permissions` (</span><br><span class="line">    `role` varchar(50) NOT NULL,</span><br><span class="line">    `resource` varchar(255) NOT NULL,</span><br><span class="line">    `action` varchar(8) NOT NULL,</span><br><span class="line">    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO users (username, password, enabled) VALUES (&#x27;nacos&#x27;, &#x27;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#x27;, TRUE);</span><br><span class="line"></span><br><span class="line">INSERT INTO roles (username, role) VALUES (&#x27;nacos&#x27;, &#x27;ROLE_ADMIN&#x27;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">startup.cmd -m standalone</span><br><span class="line">http://localhost:8848/nacos/#/configurationManagement?dataId=&amp;group=&amp;appName=&amp;namespace=&amp;pageSize=&amp;pageNo=</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">导入</span><br><span class="line">ry_config_20220929.sql</span><br><span class="line"></span><br><span class="line">#  修改配置文件</span><br><span class="line"></span><br><span class="line">db.url.0=jdbc:mysql://127.0.0.1:3306/ry-config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span><br><span class="line">db.user.0=root</span><br><span class="line">db.password.0=root123</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建</span><br><span class="line">ry_20230223.sql</span><br></pre></td></tr></table></figure>
<p>启动 service</p>
<h3 id="上云部署"><a class="markdownIt-Anchor" href="#上云部署">#</a> 上云部署</h3>
<h4 id="1移至mysql"><a class="markdownIt-Anchor" href="#1移至mysql">#</a> 1. 移至 mysql</h4>
<p>将本地 mysql 使用 mysql workbench migrate 到云上</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230415151254966.png" alt="image-20230415151254966"></p>
<p>移植成功</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230415151322174.png" alt="image-20230415151322174"></p>
<h4 id="2部署中间件-nacos"><a class="markdownIt-Anchor" href="#2部署中间件-nacos">#</a> 2. 部署中间件 nacos</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230415152614222.png" alt="image-20230415152614222"></p>
<p>kubesphere 中创建 nacos service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nacos-v1-0.nacos.hos.svc.cluster.local:8848</span><br><span class="line">nacos-v1-1.nacos.hos.svc.cluster.local:8848</span><br></pre></td></tr></table></figure>
<h4 id="部署微服务"><a class="markdownIt-Anchor" href="#部署微服务">#</a> 部署微服务</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8-jdk</span><br><span class="line">LABEL maintainer=leifengyang</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#docker run -e PARAMS=&quot;--server.port 9090&quot;</span></span><br><span class="line">ENV PARAMS=<span class="string">&quot;--server.port=8080 --spring.profiles.active=prod --spring.cloud.nacos.discovery.server-addr=his-nacos.his:8848 --spring.cloud.nacos.config.server-addr=nacos.hos:8848 --spring.cloud.nacos.config.namespace=prod --spring.cloud.nacos.config.file-extension=yml&quot;</span></span><br><span class="line">RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt;/etc/timezone</span><br><span class="line"></span><br><span class="line">COPY target/*.jar /app.jar</span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;java -Dfile.encoding=utf8 -Djava.security.egd=file:/dev/./urandom -jar app.jar <span class="variable">$&#123;PARAMS&#125;</span>&quot;</span>] </span><br></pre></td></tr></table></figure>
<p>打包:<br>
maveh 打成可执行 jar, 上传给服务器 (master)</p>
<p>制作镜像:docker 根据 Dockerfile 把包打成指定的镜像</p>
<p>推送镜像：将镜像推送给 docker hub（阿里云镜像仓库)</p>
<p>应用部署：给 k8s 部署应用，node1 节点部署应用</p>
<p>docker tag [ImageId] <span class="exturl" data-url="aHR0cDovL3JlZ2lzdHJ5LmNuLWhhbmd6aG91LmFsaXl1bmNzLmNvbS9zaGlueWEvJUU5JTk1JTlDJUU1JTgzJThGJUU1JTkwJThEOnYx">registry.cn-hangzhou.aliyuncs.com/shinya/ 镜像名:v1</span></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230416213506519.png" alt="image-20230416213506519"></p>
<p><span class="exturl" data-url="aHR0cDovLzEwNi4xNC4yMi4xMjg6MzAxNTYvbG9naW4/cmVkaXJlY3Q9JTJGc3lzdGVtJTJGdXNlcg==">若依管理系统</span></p>
<h1 id="devops"><a class="markdownIt-Anchor" href="#devops">#</a> DevOps</h1>
<p>DevOps <strong>是一系列做法和工具</strong>，可以使 IT 和软件开发团队之间的<strong>流程实现自动化</strong>。其中，随着敏捷软件开发日趋流行，<strong>持续集成 (CI)</strong> 和<strong>持续交付 (CD)</strong> 已经成为该领域一个理想的解决方案。在 CI/CD 工作流中，每次集成都通过自动化构建来验证，包括编码、发布和测试，从而帮助开发者提前发现集成错误，团队也可以快速、安全、可靠地将内部软件交付到生产环境。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vbGVpZmVuZ3lhbmcveXlnaC1wYXJlbnQ=">https://gitee.com/leifengyang/yygh-parent</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vbGVpZmVuZ3lhbmcveXlnaC1hZG1pbg==">https://gitee.com/leifengyang/yygh-admin</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vbGVpZmVuZ3lhbmcveXlnaC1zaXRl">https://gitee.com/leifengyang/yygh-site</span></p>
<h4 id="中间件"><a class="markdownIt-Anchor" href="#中间件">#</a> 中间件</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sentinel.hos:8080</span><br><span class="line">http://106.14.22.128:30395/#/login</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mongodb.hos:27017</span><br><span class="line">http://106.14.22.128:30417</span><br><span class="line"></span><br><span class="line">redis.hos</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql.hos</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rabbitm-j17f1z-rabbitmq.hos</span><br></pre></td></tr></table></figure>
<p>mvn clean package -Dmaven.test.skip=true</p>
<ul>
<li>
<p>使用 admin 登陆 ks</p>
</li>
<li>
<p>进入集群管理</p>
</li>
<li>
<p>进入配置中心</p>
</li>
<li>
<p>找到配置</p>
</li>
<li>
<ul>
<li><span class="exturl" data-url="aHR0cDovLzEzOS4xOTguMTY1LjIzODozMDg4MC9jbHVzdGVycy9kZWZhdWx0L3Byb2plY3RzL2t1YmVzcGhlcmUtZGV2b3BzLXN5c3RlbS9jb25maWdtYXBzL2tzLWRldm9wcy1hZ2VudA==">ks-devops-agent</span></li>
<li>修改这个配置。加入 maven 阿里云镜像加速地址</li>
<li>使用 admin 登陆 ks</li>
<li>进入集群管理</li>
<li>进入配置中心</li>
<li>找到配置</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li><span class="exturl" data-url="aHR0cDovLzEzOS4xOTguMTY1LjIzODozMDg4MC9jbHVzdGVycy9kZWZhdWx0L3Byb2plY3RzL2t1YmVzcGhlcmUtZGV2b3BzLXN5c3RlbS9jb25maWdtYXBzL2tzLWRldm9wcy1hZ2VudA==">ks-devops-agent</span></li>
<li>修改这个配置。加入 maven 阿里云镜像加速地址</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">      label <span class="string">&#x27;maven&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">&#x27;拉取代码&#x27;</span>) &#123;</span><br><span class="line">      agent none</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">          git(url: <span class="string">&#x27;https://gitee.com/kbshire/yygh-parent&#x27;</span>, credentialsId: <span class="string">&#x27;giteeid&#x27;</span>, branch: <span class="string">&#x27;master&#x27;</span>, changelog: <span class="literal">true</span>, poll: <span class="literal">false</span>)</span><br><span class="line">          sh <span class="string">&#x27;ls -al&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;项目编译&#x27;</span>) &#123;</span><br><span class="line">      agent none</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">          sh <span class="string">&#x27;ls -al&#x27;</span></span><br><span class="line">          sh <span class="string">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;default-2&#x27;</span>) &#123;</span><br><span class="line">      parallel &#123;</span><br><span class="line">        stage(<span class="string">&#x27;构建hospital镜像&#x27;</span>) &#123;</span><br><span class="line">          agent none</span><br><span class="line">          steps &#123;</span><br><span class="line">            container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">              sh <span class="string">&#x27;docker build -t hospital-manage:latest -f hospital-manage/Dockerfile hospital-manage/&#x27;</span></span><br><span class="line">              sh <span class="string">&#x27;ls -al hospital-manage/target&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;构建server-gateway&#x27;</span>) &#123;</span><br><span class="line">          agent none</span><br><span class="line">          steps &#123;</span><br><span class="line">            container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">              sh <span class="string">&#x27;ls -al server-gateway/target&#x27;</span></span><br><span class="line">              sh <span class="string">&#x27;docker build -t server-gateway:latest -f server-gateway/Dockerfile server-gateway/&#x27;</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;构建service-cmn镜像&#x27;</span>) &#123;</span><br><span class="line">          agent none</span><br><span class="line">          steps &#123;</span><br><span class="line">            container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">              sh <span class="string">&#x27;docker build -t service-cmn:latest -f service/service-cmn/Dockerfile ./service/service-cmn/&#x27;</span></span><br><span class="line">              sh <span class="string">&#x27;ls -al service/service-cmn/target&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;构建service-hosp镜像&#x27;</span>) &#123;</span><br><span class="line">          agent none</span><br><span class="line">          steps &#123;</span><br><span class="line">            container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">              sh <span class="string">&#x27;docker build -t service-hosp:latest -f service/service-hosp/Dockerfile ./service/service-hosp/&#x27;</span></span><br><span class="line">              sh <span class="string">&#x27;ls -al service/service-hosp/target&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;构建service-order镜像&#x27;</span>) &#123;</span><br><span class="line">          agent none</span><br><span class="line">          steps &#123;</span><br><span class="line">            container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">              sh <span class="string">&#x27;docker build -t service-order:latest -f service/service-order/Dockerfile ./service/service-order/&#x27;</span></span><br><span class="line">              sh <span class="string">&#x27;ls -al service/service-order/target&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;构建service-oss镜像&#x27;</span>) &#123;</span><br><span class="line">          agent none</span><br><span class="line">          steps &#123;</span><br><span class="line">            container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">              sh <span class="string">&#x27;docker build -t service-oss:latest -f service/service-oss/Dockerfile ./service/service-oss/&#x27;</span></span><br><span class="line">              sh <span class="string">&#x27;ls -al service/service-oss/target&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;构建service-sms镜像&#x27;</span>) &#123;</span><br><span class="line">          agent none</span><br><span class="line">          steps &#123;</span><br><span class="line">            container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">              sh <span class="string">&#x27;docker build -t service-sms:latest -f service/service-sms/Dockerfile ./service/service-sms/&#x27;</span></span><br><span class="line">              sh <span class="string">&#x27;ls -al service/service-sms/target&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;构建service-statistics镜像&#x27;</span>) &#123;</span><br><span class="line">          agent none</span><br><span class="line">          steps &#123;</span><br><span class="line">            container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">              sh <span class="string">&#x27;docker build -t service-statistics:latest -f service/service-statistics/Dockerfile ./service/service-statistics/&#x27;</span></span><br><span class="line">              sh <span class="string">&#x27;ls -al service/service-statistics/target&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;构建service-task镜像&#x27;</span>) &#123;</span><br><span class="line">          agent none</span><br><span class="line">          steps &#123;</span><br><span class="line">            container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">              sh <span class="string">&#x27;docker build -t service-task:latest -f service/service-task/Dockerfile ./service/service-task/&#x27;</span></span><br><span class="line">              sh <span class="string">&#x27;ls -al service/service-task/target&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;构建service-user镜像&#x27;</span>) &#123;</span><br><span class="line">          agent none</span><br><span class="line">          steps &#123;</span><br><span class="line">            container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">              sh <span class="string">&#x27;docker build -t service-user:latest -f service/service-user/Dockerfile ./service/service-user/&#x27;</span></span><br><span class="line">              sh <span class="string">&#x27;ls -al service/service-user/target&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;push latest&#x27;</span>) &#123;</span><br><span class="line">      when &#123;</span><br><span class="line">        branch <span class="string">&#x27;master&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">          sh <span class="string">&#x27;docker tag  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:SNAPSHOT-$BRANCH_NAME-$BUILD_NUMBER $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:latest &#x27;</span></span><br><span class="line">          sh <span class="string">&#x27;docker push  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:latest &#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;deploy to dev&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">          input(<span class="built_in">id</span>: <span class="string">&#x27;deploy-to-dev&#x27;</span>, message: <span class="string">&#x27;deploy to dev?&#x27;</span>)</span><br><span class="line">          withCredentials([kubeconfigContent(credentialsId : <span class="string">&#x27;KUBECONFIG_CREDENTIAL_ID&#x27;</span> ,variable : <span class="string">&#x27;KUBECONFIG_CONFIG&#x27;</span> ,)]) &#123;</span><br><span class="line">            sh <span class="string">&#x27;mkdir -p ~/.kube/&#x27;</span></span><br><span class="line">            sh <span class="string">&#x27;echo &quot;$KUBECONFIG_CONFIG&quot; &gt; ~/.kube/config&#x27;</span></span><br><span class="line">            sh <span class="string">&#x27;envsubst &lt; deploy/dev-ol/deploy.yaml | kubectl apply -f -&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;deploy to production&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">          input(<span class="built_in">id</span>: <span class="string">&#x27;deploy-to-production&#x27;</span>, message: <span class="string">&#x27;deploy to production?&#x27;</span>)</span><br><span class="line">          withCredentials([kubeconfigContent(credentialsId : <span class="string">&#x27;KUBECONFIG_CREDENTIAL_ID&#x27;</span> ,variable : <span class="string">&#x27;KUBECONFIG_CONFIG&#x27;</span> ,)]) &#123;</span><br><span class="line">            sh <span class="string">&#x27;mkdir -p ~/.kube/&#x27;</span></span><br><span class="line">            sh <span class="string">&#x27;echo &quot;$KUBECONFIG_CONFIG&quot; &gt; ~/.kube/config&#x27;</span></span><br><span class="line">            sh <span class="string">&#x27;envsubst &lt; deploy/prod-ol/deploy.yaml | kubectl apply -f -&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  environment &#123;</span><br><span class="line">  //定义的所有变量可以在任意位置使用</span><br><span class="line">    DOCKER_CREDENTIAL_ID = <span class="string">&#x27;dockerhub-id&#x27;</span></span><br><span class="line">    GITHUB_CREDENTIAL_ID = <span class="string">&#x27;github-id&#x27;</span></span><br><span class="line">    KUBECONFIG_CREDENTIAL_ID = <span class="string">&#x27;demo-kubeconfig&#x27;</span></span><br><span class="line">    REGISTRY = <span class="string">&#x27;docker.io&#x27;</span></span><br><span class="line">    DOCKERHUB_NAMESPACE = <span class="string">&#x27;docker_username&#x27;</span></span><br><span class="line">    GITHUB_ACCOUNT = <span class="string">&#x27;kubesphere&#x27;</span></span><br><span class="line">    APP_NAME = <span class="string">&#x27;devops-java-sample&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  parameters &#123;</span><br><span class="line">    string(name: <span class="string">&#x27;TAG_NAME&#x27;</span>, defaultValue: <span class="string">&#x27;&#x27;</span>, description: <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/shinya_hello/ruoyi-visual-monitor:</span><br><span class="line"></span><br><span class="line">sh &#x27;docker tag hospital-manage:latest $registry/$DOCKERHUB_NAMESPACE/hospital-manage:SNAPSHOT-$BUILD_NUMBER&#x27;</span><br><span class="line">sh &#x27;docker push  $REGISTRY/$DOCKERHUB_NAMESPACE/hospital-manage:SNAPSHOT-$BUILD_NUMBER&#x27;</span><br></pre></td></tr></table></figure>
<p>加载阿里云镜像密钥</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418174358540.png" alt="image-20230418174358540"></p>
<p><span class="exturl" data-url="aHR0cDovLzEwNi4xNC4yMi4xMjg6MzA4ODAvZGV2b3BzX3dlYmhvb2svZ2l0Lz91cmw9aHR0cHM6Ly9naXRlZS5jb20va2JzaGlyZS95eWdoLXNpdGU=">http://106.14.22.128:30880/devops_webhook/git/?url=https://gitee.com/kbshire/yygh-site</span></p>
<p><span class="exturl" data-url="aHR0cDovLzEwNi4xNC4yMi4xMjg6MzA4ODAvZGV2b3BzX3dlYmhvb2svZ2l0Lz91cmw9aHR0cHM6Ly9naXRlZS5jb20va2JzaGlyZS95eWdoLWFkbWlu">http://106.14.22.128:30880/devops_webhook/git/?url=https://gitee.com/kbshire/yygh-admin</span></p>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2023-06-23 12:09:43" itemprop="dateModified" datetime="2023-06-23T12:09:43+08:00">2023-06-23</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2023/05/20/Kubernetes/" title="Kubernetes">http://example.com/2023/05/20/Kubernetes/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/05/20/yuque/Kubernetes/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipewf5l51j20zk0m8b29.jpg" title="Kubernetes">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Kubernetes</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/06/02/yuque/k8s%E9%AB%98%E7%BA%A7/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipevarprfj20zk0m8npd.jpg" title="k8s高级">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>k8s高级</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes"><span class="toc-number">1.</span> <span class="toc-text"> Kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E7%89%B9%E6%80%A7"><span class="toc-number">1.1.</span> <span class="toc-text"> k8s 特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text"> 架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 资源对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubeadm%E5%AE%89%E8%A3%85k8s%E5%A4%9Amaster%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.2.</span> <span class="toc-text"> kubeadm 安装 k8s 多 master 高可用集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.</span> <span class="toc-text"> 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2dashboard"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 部署 dashboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85containerd"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 安装 containerd</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#namespace"><span class="toc-number">1.4.</span> <span class="toc-text"> Namespace</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pod"><span class="toc-number">1.5.</span> <span class="toc-text"> pod</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pod%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-number">1.5.1.</span> <span class="toc-text"> pod 管理多个容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pod%E7%BD%91%E7%BB%9C"><span class="toc-number">1.5.2.</span> <span class="toc-text"> Pod 网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pod-%E5%AD%98%E5%82%A8"><span class="toc-number">1.5.3.</span> <span class="toc-text"> pod 存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pod-%E5%88%9B%E5%BB%BA%E6%9C%BA%E5%88%B6"><span class="toc-number">1.5.4.</span> <span class="toc-text"> pod 创建机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yaml%E5%88%9B%E5%BB%BApod"><span class="toc-number">1.5.5.</span> <span class="toc-text"> yaml 创建 pod</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#labels"><span class="toc-number">1.6.</span> <span class="toc-text"> labels</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#node%E8%8A%82%E7%82%B9%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-number">1.7.</span> <span class="toc-text"> node 节点选择器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7-%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-number">1.8.</span> <span class="toc-text"> 节点亲和性、反亲和性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%A1%E7%82%B9%E5%AE%B9%E5%BF%8D%E5%BA%A6"><span class="toc-number">1.9.</span> <span class="toc-text"> 污点，容忍度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pod%E5%B8%B8%E8%A7%81%E7%8A%B6%E6%80%81%E5%92%8C%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-number">1.10.</span> <span class="toc-text"> pod 常见状态和重启策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.11.</span> <span class="toc-text"> pod 生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#initcontainer"><span class="toc-number">1.11.1.</span> <span class="toc-text"> initcontainer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%AE%B9%E5%99%A8"><span class="toc-number">1.11.2.</span> <span class="toc-text"> 主容器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.12.</span> <span class="toc-text"> 容器探测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.12.1.</span> <span class="toc-text"> 启动探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E6%B4%BB%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.12.2.</span> <span class="toc-text"> 存活探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%B1%E7%BB%AA%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.12.3.</span> <span class="toc-text"> 就绪探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B7%E5%90%88%E4%BD%BF%E7%94%A8%E4%B8%89%E7%A7%8D%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.12.4.</span> <span class="toc-text"> 混合使用三种探测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#replicaset"><span class="toc-number">1.13.</span> <span class="toc-text"> Replicaset</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pod%E5%8A%A8%E6%80%81%E6%89%A9%E7%BC%A9%E5%AE%B9"><span class="toc-number">1.13.1.</span> <span class="toc-text"> pod 动态扩缩容</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deployment"><span class="toc-number">1.14.</span> <span class="toc-text"> deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="toc-number">1.14.1.</span> <span class="toc-text"> 滚动更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-number">1.14.2.</span> <span class="toc-text"> 自动滚动更新策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%93%9D%E7%BB%BF%E9%83%A8%E7%BD%B2"><span class="toc-number">1.14.3.</span> <span class="toc-text"> 蓝绿部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83"><span class="toc-number">1.14.4.</span> <span class="toc-text"> 金丝雀发布</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#service"><span class="toc-number">1.15.</span> <span class="toc-text"> service</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cluster-ip"><span class="toc-number">1.15.1.</span> <span class="toc-text"> cluster-ip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nodeport"><span class="toc-number">1.15.2.</span> <span class="toc-text"> NodePort</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#externalname"><span class="toc-number">1.15.3.</span> <span class="toc-text"> externalName</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#coredns"><span class="toc-number">1.15.4.</span> <span class="toc-text"> coredns</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ingress"><span class="toc-number">1.16.</span> <span class="toc-text"> ingress</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ingress-%E5%AE%9E%E7%8E%B0%E4%B8%9A%E5%8A%A1%E5%8F%91%E5%B8%83"><span class="toc-number">1.16.1.</span> <span class="toc-text"> ingress 实现业务发布</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAingress"><span class="toc-number">1.16.2.</span> <span class="toc-text"> 创建 ingress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE"><span class="toc-number">1.16.3.</span> <span class="toc-text"> 域名访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E9%87%8D%E5%86%99"><span class="toc-number">1.16.4.</span> <span class="toc-text"> 路径重写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E9%99%90%E5%88%B6"><span class="toc-number">1.16.5.</span> <span class="toc-text"> 流量限制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E6%8A%BD%E8%B1%A1"><span class="toc-number">1.17.</span> <span class="toc-text"> 存储抽象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#emptydir"><span class="toc-number">1.17.1.</span> <span class="toc-text"> emptydir</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hostpath"><span class="toc-number">1.17.2.</span> <span class="toc-text"> hostpath</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nfs"><span class="toc-number">1.17.3.</span> <span class="toc-text"> nfs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E6%96%B9%E5%BC%8F%E6%8C%82%E8%BD%BD"><span class="toc-number">1.17.4.</span> <span class="toc-text"> 原生方式挂载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8D%B7"><span class="toc-number">1.17.5.</span> <span class="toc-text"> 持久卷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#storageclass"><span class="toc-number">1.17.6.</span> <span class="toc-text"> storageclass</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#statefulset"><span class="toc-number">1.18.</span> <span class="toc-text"> statefulset</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#daemonset"><span class="toc-number">1.19.</span> <span class="toc-text"> DaemonSet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configmap"><span class="toc-number">1.20.</span> <span class="toc-text"> ConfigMap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#secret"><span class="toc-number">1.21.</span> <span class="toc-text"> secret</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rbac"><span class="toc-number">1.22.</span> <span class="toc-text"> RBAC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-number">1.22.1.</span> <span class="toc-text"> 授权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">1.22.2.</span> <span class="toc-text"> 准入控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useraccount-serviceaccount"><span class="toc-number">1.22.3.</span> <span class="toc-text"> useraccount 、serviceaccount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rbac-2"><span class="toc-number">1.22.4.</span> <span class="toc-text"> rbac</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#resourcequota%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">1.22.5.</span> <span class="toc-text"> ResourceQuota 准入控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limitranger%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">1.22.6.</span> <span class="toc-text"> LimitRanger 准入控制器 \</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubesphere"><span class="toc-number">2.</span> <span class="toc-text"> kubesphere</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B3%E5%8F%B0%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.</span> <span class="toc-text"> 平台安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%89%8D%E7%BD%AE%E5%AD%98%E5%82%A8%E7%B1%BB"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 配置前置存储类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85metrics-server"><span class="toc-number">2.1.2.</span> <span class="toc-text"> 安装 metrics-server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%8A%9F%E8%83%BD%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.3.</span> <span class="toc-text"> 全功能安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linxu-%E5%AE%89%E8%A3%85-%E5%8D%95%E8%8A%82%E7%82%B9"><span class="toc-number">2.2.</span> <span class="toc-text"> linxu 安装 单节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux%E5%A4%9A%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.</span> <span class="toc-text"> linux 多节点安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8"><span class="toc-number">2.4.</span> <span class="toc-text"> 部署应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%95%9C%E5%83%8F%E9%83%A8%E7%BD%B2"><span class="toc-number">2.4.1.</span> <span class="toc-text"> 使用镜像部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%BA%94%E7%94%A8%E5%B8%82%E5%9C%BA%E9%83%A8%E7%BD%B2"><span class="toc-number">2.4.2.</span> <span class="toc-text"> 使用应用市场部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%BA%94%E7%94%A8%E6%A8%A1%E6%9D%BF%E9%83%A8%E7%BD%B2"><span class="toc-number">2.4.3.</span> <span class="toc-text"> 使用应用模板部署</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2ruoyi-cloud"><span class="toc-number">2.5.</span> <span class="toc-text"> 部署 ruoyi cloud</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2"><span class="toc-number">2.5.1.</span> <span class="toc-text"> 本地部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BA%91%E9%83%A8%E7%BD%B2"><span class="toc-number">2.5.2.</span> <span class="toc-text"> 上云部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E7%A7%BB%E8%87%B3mysql"><span class="toc-number">2.5.2.1.</span> <span class="toc-text"> 1. 移至 mysql</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E9%83%A8%E7%BD%B2%E4%B8%AD%E9%97%B4%E4%BB%B6-nacos"><span class="toc-number">2.5.2.2.</span> <span class="toc-text"> 2. 部署中间件 nacos</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.5.2.3.</span> <span class="toc-text"> 部署微服务</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#devops"><span class="toc-number">3.</span> <span class="toc-text"> DevOps</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">3.0.0.1.</span> <span class="toc-text"> 中间件</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">68</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">4</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/05/20/yuque/Kubernetes/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/06/02/yuque/k8s%E9%AB%98%E7%BA%A7/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/06/27/SSRF/" title="SSRF">SSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/06/27/yuque/SSRF/" title="SSRF">SSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/07/15/yuque/%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/" title="中间件漏洞">中间件漏洞</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/01/17/Segment%20Routing/" title="Segment Routing">Segment Routing</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/08/02/yuque/Capabilities/" title="docker底层原理+capability">docker底层原理+capability</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/03/16/yuque/SQL%E6%B3%A8%E5%85%A5/" title="SQL injection">SQL injection</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" title="SQL injection">SQL injection</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/12/27/yuque/SSTI/" title="SSTI">SSTI</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/11/27/CDN/" title="CDN&amp;DNS">CDN&DNS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/02/28/XSS/" title="XSS">XSS</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/05/20/Kubernetes/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
