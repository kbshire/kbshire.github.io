



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="运维" />


<link rel="canonical" href="http://example.com/2023/04/05/Docker/">



  <title>
docker - 运维 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">docker
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2023-04-05 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2023-04-05T13:38:45+08:00">2023-04-05</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/3cff3fc776e129c36936b1cf83a34b68.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/2aaa20665dd5e5704a35cf4f6de766db.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/07c8c664e3753d83c410cd2c54f8f185.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/226cdddcc87f721f3412378f31d5c9d1.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/560306a4274d1fc26eb475dd52237387.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/2e0802e6e5cfd05c700bc3f911f9351c.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="item" rel="index" title="In 运维"><span itemprop="name">运维</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/05/Docker/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="docker"><a class="markdownIt-Anchor" href="#docker">#</a> Docker</h1>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5kb2NrZXIuY29t">www.docker.com</span></p>
<p><span class="exturl" data-url="aHR0cDovL2h1Yi5kb2NrZXIuY29t">hub.docker.com</span></p>
<p>虚拟机缺点：</p>
<p>1. 资源占有多</p>
<p>2. 冗余步骤多</p>
<p>3. 启动慢</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328205458587.png" alt="image-20230328205458587"></p>
<p>容器化技术：不是完整的操作系统，只保留了最核心的部分。直接运行在操作系统之上。容器之间相互隔离</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328203952292.png" alt="image-20230328203952292"></p>
<p>传统虚拟机：虚拟出一套硬件，运行一套完整的操作系统，再运行软件</p>
<p>容器内的应用直接运行在宿主机的内核，是没有自己内核的，也没有虚拟硬件，所以轻便。每个容器相互隔离，都有属于自己的文件系统</p>
<p>更高效的资源应用</p>
<p>更见的系统运维</p>
<p>更便捷的升级和扩缩容</p>
<p>应用更快速的交付和部署</p>
<h2 id="docker安装"><a class="markdownIt-Anchor" href="#docker安装">#</a> docker 安装</h2>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328205612777.png" alt="image-20230328205612777"></p>
<p><code>镜像</code> ：image 类似于模板，可以通过模板创建容器服务。镜像 run 之后就是一个容器，用于提供服务。通过这个镜像可以创建多个容器，项目运行就是在容器中</p>
<p><code>容器</code> ：container docker 利用容器，独立运行一个或者一组应用，通过镜像来创建 ，可以启动，删除，停止等。可以把容器理解为一个简易的 linux 系统</p>
<p><code>仓库</code> ：repository 存放镜像的地方。分为共有和私有仓库，比如 docker hub。国内需要配置镜像加速，利用阿里云容器服务器或者其他</p>
<p>环境：centos7 + 华为云 + xshell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]# uname -r</span><br><span class="line">3.10.0-1160.53.1.el7.x86_64</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]# cat /etc/os-release </span><br><span class="line">NAME=&quot;CentOS Linux&quot;</span><br><span class="line">VERSION=&quot;7 (Core)&quot;</span><br><span class="line">ID=&quot;centos&quot;</span><br><span class="line">ID_LIKE=&quot;rhel fedora&quot;</span><br><span class="line">VERSION_ID=&quot;7&quot;</span><br><span class="line">PRETTY_NAME=&quot;CentOS Linux 7 (Core)&quot;</span><br><span class="line">ANSI_COLOR=&quot;0;31&quot;</span><br><span class="line">CPE_NAME=&quot;cpe:/o:centos:centos:7&quot;</span><br><span class="line">HOME_URL=&quot;https://www.centos.org/&quot;</span><br><span class="line">BUG_REPORT_URL=&quot;https://bugs.centos.org/&quot;</span><br><span class="line"></span><br><span class="line">CENTOS_MANTISBT_PROJECT=&quot;CentOS-7&quot;</span><br><span class="line">CENTOS_MANTISBT_PROJECT_VERSION=&quot;7&quot;</span><br><span class="line">REDHAT_SUPPORT_PRODUCT=&quot;centos&quot;</span><br><span class="line">REDHAT_SUPPORT_PRODUCT_VERSION=&quot;7&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>1. 卸载旧版本</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker \</span><br><span class="line">                 docker-client \</span><br><span class="line">                 docker-client-latest \</span><br><span class="line">                 docker-common \</span><br><span class="line">                 docker-latest \</span><br><span class="line">                 docker-latest-logrotate \</span><br><span class="line">                 docker-logrotate \</span><br><span class="line">                 docker-engine</span><br></pre></td></tr></table></figure>
<p><strong>2. 安装基本环境</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br></pre></td></tr></table></figure>
<p><strong>3. 设置镜像仓库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">更新软件包索引</span><br><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure>
<p><strong>4. 安装 docker 相关内容</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure>
<p><strong>5. 启动 docker</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">docker version</span><br></pre></td></tr></table></figure>
<p><strong>6. 测试 docker 安装是否成功</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>
<p><strong>7. 查看 hello-world 镜像</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
<p><strong>8. 卸载 docker</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">卸载依赖</span><br><span class="line">sudo yum remove docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin docker-ce-rootless-extras</span><br><span class="line">删除资源，也就是docker的默认工作路径</span><br><span class="line">sudo rm -rf /var/lib/docker</span><br><span class="line">sudo rm -rf /var/lib/containerd</span><br></pre></td></tr></table></figure>
<h2 id="内核参数调优"><a class="markdownIt-Anchor" href="#内核参数调优">#</a> 内核参数调优</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">内核参数修改：br_netfilter模块用于将桥接流量转发至iptables链，br_netfilter内核参数需要开启转发。</span><br><span class="line">[root@xianchaomaster1 ~]<span class="comment"># modprobe br_netfilter</span></span><br><span class="line">[root@xianchaomaster1 ~]<span class="comment"># cat &gt; /etc/sysctl.d/docker.conf &lt;&lt;EOF</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#使参数生效</span></span><br><span class="line">[root@xianchaomaster1 ~]<span class="comment"># sysctl -p /etc/sysctl.d/docker.conf</span></span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ngsql]<span class="comment"># lsmod | grep br_</span></span><br><span class="line">br_netfilter           22256  0 </span><br><span class="line">bridge                151336  2 br_netfilter,ebtable_broute</span><br><span class="line"></span><br><span class="line">重启后模块失效，下面是开机自动加载模块的脚本</span><br><span class="line">在/etc/新建rc.sysinit 文件</span><br><span class="line"><span class="built_in">cat</span> /etc/rc.sysinit</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> /etc/sysconfig/modules/*.modules ; <span class="keyword">do</span></span><br><span class="line">[ -x <span class="variable">$file</span> ] &amp;&amp; <span class="variable">$file</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">在/etc/sysconfig/modules/目录下新建文件如下</span><br><span class="line"><span class="built_in">cat</span> /etc/sysconfig/modules/br_netfilter.modules</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"></span><br><span class="line">增加权限</span><br><span class="line">[root@xianchaomaster1 ~]<span class="comment"># chmod 755 /etc/sysconfig/modules/br_netfilter.modules</span></span><br><span class="line"></span><br><span class="line">重启机器模块也会自动加载</span><br><span class="line">[root@localhost ~]<span class="comment"># lsmod |grep br_netfilter</span></span><br><span class="line">br_netfilter 22209 0</span><br><span class="line">bridge 136173 1 br_netfilter</span><br><span class="line"></span><br><span class="line">注：</span><br><span class="line">Docker 安装后出现：WARNING: bridge-nf-call-iptables is disabled 的解决办法：</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line"></span><br><span class="line">net.ipv4.ip_forward = 1：</span><br><span class="line">将Linux系统作为路由或者VPN服务就必须要开启IP转发功能。当linux主机有多个网卡时一个网卡收到的信息是否能够传递给其他的网卡 ，如果设置成1 的话 可以进行数据包转发，可以实现VxLAN 等功能。不开启会导致docker部署应用无法访问。</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启docker</span></span><br><span class="line">[root@xianchaomaster1 ~]<span class="comment"># systemctl restart docker  </span></span><br></pre></td></tr></table></figure>
<h2 id="镜像加速"><a class="markdownIt-Anchor" href="#镜像加速">#</a> 镜像加速</h2>
<p><span class="exturl" data-url="aHR0cDovL2NyLmNvbnNvbGUuYWxpeXVuLmNvbQ==">cr.console.aliyun.com</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">您可以通过修改daemon配置文件/etc/docker/daemon.json来使用加速器</span><br><span class="line"></span><br><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://fn5y0qpk.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
<h2 id="docker-run之后发生了什么"><a class="markdownIt-Anchor" href="#docker-run之后发生了什么">#</a> docker run 之后发生了什么</h2>
<p><strong>1. 本机寻找镜像</strong></p>
<p><strong>2.1 本机有镜像，使用镜像运行</strong></p>
<p><strong>2.2 去 dockerhub 上下载</strong></p>
<p><strong>3.1 dockerhub 找不到镜像 - 返回错误</strong></p>
<p><strong>3.2dockerhub 找到镜像，下载到本地</strong></p>
<p><strong>4. 运行</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230329195956959.png" alt="image-20230329195956959"></p>
<p>docker 是一个 cs 结构的系统，docker 的守护进程运行在主机上。通过 socket 从客户端访问</p>
<p>docker server 接收到 client 指定，就会执行这个命令</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230329200521395.png" alt="image-20230329200521395"></p>
<p>docker 有着比虚拟机更少的抽象层</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230329200736029.png" alt="image-20230329200736029"></p>
<p>docker 用的是宿主机的内核，vm 需要 guest os</p>
<p>docker 不需要重新加载操作系统内核，避免引导。</p>
<h2 id="docker命令"><a class="markdownIt-Anchor" href="#docker命令">#</a> docker 命令</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker version/info    # 版本信息，系统信息</span><br><span class="line">docker --help          # 帮助命令</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="镜像命令"><a class="markdownIt-Anchor" href="#镜像命令">#</a> 镜像命令</h3>
<p><code>docker images   # 查看所有镜像</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]# docker images </span><br><span class="line">REPOSITORY                TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">loadbalancejsp_lbsnode1   latest    8d19a7525948   3 months ago    240MB</span><br><span class="line">loadbalancejsp_lbsnode2   latest    8d19a7525948   3 months ago    240MB</span><br><span class="line">tomcat                    8-jre8    f0e282263192   3 months ago    240MB</span><br><span class="line"></span><br><span class="line">仓库源                     标签       镜像ID          创建时间         镜像大小</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-a 显示全部镜像</span><br><span class="line"></span><br><span class="line">-q 只显示镜像ID</span><br></pre></td></tr></table></figure>
<p><code>docker search  # 搜索镜像</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]# docker search mysql</span><br><span class="line">NAME                            DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">mysql                           MySQL is a widely used, open-source relation…   13988     [OK]       </span><br><span class="line">mariadb                         MariaDB Server is a high performing open sou…   5333      [OK]       </span><br><span class="line">percona                         Percona Server is a fork of the MySQL relati…   602       [OK]       </span><br><span class="line"></span><br><span class="line">docker search mysql --filter=STARS=9000   STARS&gt;9000</span><br></pre></td></tr></table></figure>
<p><code>docker pull   #下载镜像</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]# docker pull mysql</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/mysql</span><br><span class="line">72a69066d2fe: Pull complete   # 分层下载</span><br><span class="line">93619dbc5b36: Pull complete </span><br><span class="line">99da31dd6142: Pull complete </span><br><span class="line">626033c43d70: Pull complete </span><br><span class="line">37d5d7efb64e: Pull complete </span><br><span class="line">ac563158d721: Pull complete </span><br><span class="line">d2ba16033dad: Pull complete </span><br><span class="line">688ba7d5c01a: Pull complete </span><br><span class="line">00e060b6d11d: Pull complete </span><br><span class="line">1c04857f594f: Pull complete </span><br><span class="line">4d7cfa90e6ea: Pull complete </span><br><span class="line">e0431212d27d: Pull complete </span><br><span class="line">Digest: sha256:e9027fe4d91c0153429607251656806cc784e914937271037f7738bd5b8e7709</span><br><span class="line">Status: Downloaded newer image for mysql:latest</span><br><span class="line">docker.io/library/mysql:latest  # 真实地址</span><br><span class="line"></span><br><span class="line">==</span><br><span class="line">docker pull docker.io/library/mysql:latest</span><br><span class="line"></span><br><span class="line">分层可以实现层的共用</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]# docker pull mysql:5.7</span><br><span class="line">5.7: Pulling from library/mysql</span><br><span class="line">72a69066d2fe: Already exists </span><br><span class="line">93619dbc5b36: Already exists </span><br><span class="line">99da31dd6142: Already exists </span><br><span class="line">626033c43d70: Already exists </span><br><span class="line">37d5d7efb64e: Already exists </span><br><span class="line">ac563158d721: Already exists </span><br><span class="line">d2ba16033dad: Already exists </span><br><span class="line">0ceb82207cd7: Pull complete </span><br><span class="line">37f2405cae96: Pull complete </span><br><span class="line">e2482e017e53: Pull complete </span><br><span class="line">70deed891d42: Pull complete </span><br><span class="line">Digest: sha256:f2ad209efe9c67104167fc609cca6973c8422939491c9345270175a300419f94</span><br><span class="line">Status: Downloaded newer image for mysql:5.7</span><br><span class="line">docker.io/library/mysql:5.7</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>docker rmi    # 删除镜像</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]# docker rmi c20</span><br><span class="line">Untagged: mysql:5.7</span><br><span class="line">Untagged: mysql@sha256:f2ad209efe9c67104167fc609cca6973c8422939491c9345270175a300419f94</span><br><span class="line">Deleted: sha256:c20987f18b130f9d144c9828df630417e2a9523148930dc3963e9d0dab302a76</span><br><span class="line">Deleted: sha256:6567396b065ee734fb2dbb80c8923324a778426dfd01969f091f1ab2d52c7989</span><br><span class="line">Deleted: sha256:0910f12649d514b471f1583a16f672ab67e3d29d9833a15dc2df50dd5536e40f</span><br><span class="line">Deleted: sha256:6682af2fb40555c448b84711c7302d0f86fc716bbe9c7dc7dbd739ef9d757150</span><br><span class="line">Deleted: sha256:5c062c3ac20f576d24454e74781511a5f96739f289edaadf2de934d06e910b92</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]# docker rmi c20 321  # 删除多个镜像</span><br><span class="line"></span><br><span class="line">#docker删除全部容器</span><br><span class="line">[root@hecs-346515 ~]# docker rmi -f $(docker images -qa)</span><br></pre></td></tr></table></figure>
<h3 id="容器命令"><a class="markdownIt-Anchor" href="#容器命令">#</a> 容器命令</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]# docker pull centos</span><br></pre></td></tr></table></figure>
<p><strong>新建容器并启动</strong></p>
<p><code>docker run</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 参数说明</span><br><span class="line">--name=&quot;Name&quot;   容器名字，用于区分容器</span><br><span class="line">-d   以后台运行</span><br><span class="line">-it  使用交互方式运行，进入容器查看内容</span><br><span class="line">-p   指定容器端口 -p 8080:8080</span><br><span class="line">	-p ip:主机端口:容器端口</span><br><span class="line">	-p 主机端口:容器端口</span><br><span class="line">	-p 容器端口</span><br><span class="line">	容器端口</span><br><span class="line">-P   随机指定端口</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]# docker run -it centos /bin/bash   # 启动并进入容器</span><br><span class="line">[root@3505a169c989 /]# exit</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>列出所有运行的容器</strong></p>
<p><code>docker ps -a</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]# docker ps -a </span><br><span class="line">CONTAINER ID   IMAGE                     COMMAND                  CREATED         STATUS                          PORTS     NAMES</span><br><span class="line">3505a169c989   centos                    &quot;/bin/bash&quot;              2 minutes ago   Exited (0) About a minute ago             lucid_hypatia</span><br><span class="line">efe24d96f682   hello-world               &quot;/hello&quot;                 23 hours ago    Exited (0) 23 hours ago                   goofy_lichterman</span><br><span class="line">85c7b4c3d350   nginx:1.17                &quot;nginx -g &#x27;daemon of…&quot;   3 months ago    Exited (1) 3 months ago                   loadbalancejsp_nginx_1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-a 列出历史容器和当前运行的容器</span><br><span class="line">-n=?  显示最近创建的容器个数</span><br><span class="line">-q  只显示容器编号</span><br><span class="line"></span><br><span class="line">docker ps -qa</span><br></pre></td></tr></table></figure>
<p><strong>退出容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exit  停止并退出</span><br><span class="line">ctrl + q + p  容器不停止退出</span><br></pre></td></tr></table></figure>
<p><strong>删除容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker rm id</span><br><span class="line">docker rm -f $(docker ps -aq)   # 删除所有容器</span><br><span class="line">docker ps -aq | xargs docker rm  # 删除所有容器</span><br></pre></td></tr></table></figure>
<p><strong>启动和停止容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker start id</span><br><span class="line">docker restart id</span><br><span class="line">docker stop id</span><br><span class="line">docker kill id</span><br></pre></td></tr></table></figure>
<p><strong>后台启动容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d centos</span><br><span class="line"></span><br><span class="line">启动完之后因为没有前台进程，容器发现没有应用，自动停止</span><br></pre></td></tr></table></figure>
<p><strong>查看日志</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker logs</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]# docker logs -f -t 741  </span><br><span class="line">[root@hecs-346515 ~]# docker logs -f -t --tail 10  741</span><br></pre></td></tr></table></figure>
<p><strong>查看容器中的进程信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]# docker top 741</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                8024                8006                0                   14:05               ?                   00:00:00            nginx: master process nginx -g daemon off;</span><br><span class="line">101                 8075                8024                0                   14:05               ?                   00:00:00            nginx: worker process</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>查看镜像元数据</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]<span class="comment"># docker inspect 741</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;741038301edd946e2f2e193803d8e29aa31897212a310730c85f8b8194dbf45f&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2023-03-30T06:05:28.540089191Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/docker-entrypoint.sh&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;nginx&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-g&quot;</span>,</span><br><span class="line">            <span class="string">&quot;daemon off;&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;State&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;running&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Running&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;Paused&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Restarting&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;OOMKilled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Dead&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Pid&quot;</span>: 8024,</span><br><span class="line">            <span class="string">&quot;ExitCode&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;Error&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;StartedAt&quot;</span>: <span class="string">&quot;2023-03-30T06:05:28.79217804Z&quot;</span>,</span><br><span class="line">            <span class="string">&quot;FinishedAt&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;sha256:605c77e624ddb75e6110f997c58876baa13f8754486b461117934b24a9dc3a85&quot;</span>,</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>进入当前运行容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]# docker exec -it 741 /bin/bash</span><br><span class="line">root@741038301edd:/# </span><br><span class="line"># 进入容器后开启新终端</span><br><span class="line">-i：以交互模式运行容器</span><br><span class="line">-t：为容器重新分配一个伪输入终端</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]# docker attach 8cf</span><br><span class="line">[root@8cf0c194eae8 /]# </span><br><span class="line"># 进入容器正在执行的终端，不会启动新的进程</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>容器内拷贝文件到主机上</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker cp id:/root/ /home</span><br><span class="line">docker cp id:/容器目录  /本机目录</span><br><span class="line">docker 容器内命令</span><br><span class="line"></span><br><span class="line">-v 卷可以实现自动同步</span><br></pre></td></tr></table></figure>
<h2 id="使用docker"><a class="markdownIt-Anchor" href="#使用docker">#</a> 使用 docker</h2>
<h3 id="安装nginx"><a class="markdownIt-Anchor" href="#安装nginx">#</a> 安装 nginx</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker search nginx</span><br><span class="line">docker pull nginx </span><br><span class="line">docker run -d --name=nginx01 -p 8991:80 nginx</span><br><span class="line">curl 121.37.191.89:8991</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whereis nginx 找到nginx</span><br></pre></td></tr></table></figure>
<h3 id="安装tomcat"><a class="markdownIt-Anchor" href="#安装tomcat">#</a> 安装 tomcat</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm  tomcat /bin/bash   # rm用完就删，一般用于测试</span><br><span class="line"></span><br><span class="line">docker run -d -p 8877:8080 --name=tomcat01 tomcat</span><br><span class="line">docker exec -it tomcat01 /bin/bash</span><br></pre></td></tr></table></figure>
<h3 id="安装eskibana"><a class="markdownIt-Anchor" href="#安装eskibana">#</a> 安装 es+kibana</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name es -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker stats   # 查看cpu状态</span><br><span class="line"></span><br><span class="line">docker run -d --name es2 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; elasticsearch </span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230330195235840.png" alt="image-20230330195235840"></p>
<h2 id="可视化"><a class="markdownIt-Anchor" href="#可视化">#</a> 可视化</h2>
<p><strong>portainer</strong></p>
<p><strong>Rancher</strong></p>
<p>portainer docker 图形化界面管理工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8088:9000 --restart=always -v /var/run/docker.sock:/var/run/docker.sock --privileged=true portainer/portainer</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331202120533.png" alt="image-20230331202120533"></p>
<p>选择 local</p>
<h2 id="联合文件系统"><a class="markdownIt-Anchor" href="#联合文件系统">#</a> 联合文件系统</h2>
<p>UnionFS</p>
<p>UnionFS (联合文件系统）:Union 文件系统 (UnionFS) 是一种分层、轻量级并且高性能的文件系统，它支持对文件系统的修改作为一次提交来壬层层的叠加，同时可以将不同目录挂载到同一个虚拟文件系统下 (unite several directories into a single virtualfilesystem)。Union 文件系统是 Docker 镜像的基础。镜像可以通过分层来进行继承，基于基础镜像（没有父镜像），可以制作各种具体的应用镜像。</p>
<p>特性∶一次同时加载多个文件系统，但从外面看起来，只能看到一个文件系统，联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录</p>
<p>bootfs (boot file system) 主要包含 bootloader 和 kernel, bootloader 主要是引导加载 kernel, Linux 刚启动时会加载 bootfs 文件系统，在 Docker 镜像的最底层 bootfs。这一层与我们典型的 LinuxlUnix 系统是一样的，包含 boot 加载器和内核。当 boot 加载完成之后整个内核就都在内存中了，此时内存的使用权已由 bootfs 转交给内核，此时系统也会卸载 bootfs。</p>
<p>roots (root fle system)，在 boots 之上。包含的就是典型 Linux 系统中的 /dev, /proc, /bin, letc 等标准目录和文件。rootfs 就是各种不同的操作系统发行版，比如 Ubuntu，centos 等等。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331203141142.png" alt="image-20230331203141142"></p>
<p>对于一个精简的 OS , rootfs 可以很小，只需要包含最基本的命令，工具和程序库就可以了，因为底层直接用 Host 的 kernel , 自己只需要提供 rootfs 就可以了。由此可见对于不同的 linux 发行版，bootfs 基本是一致的，rootfs 会有差别，因此不同的发行版可以公用<br>
 bootfs。</p>
<h2 id="分层原理"><a class="markdownIt-Anchor" href="#分层原理">#</a> 分层原理</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&quot;RootFS&quot;: &#123;</span><br><span class="line">            &quot;Type&quot;: &quot;layers&quot;,</span><br><span class="line">            &quot;Layers&quot;: [</span><br><span class="line">                &quot;sha256:6515074984c6f8bb1b8a9962c8fb5f310fc85e70b04c88442a3939c026dbfad3&quot;,</span><br><span class="line">                &quot;sha256:4f169ae5a253d68d25f3f5fdd0deb31af20096bcffdec1fdda5cf8810d507d1f&quot;,</span><br><span class="line">                &quot;sha256:edae32ac2ac2a7f24eebb4b62ad2fa0a9434f47f4b56a3739106e1da4cb1aa6a&quot;,</span><br><span class="line">                &quot;sha256:f05805c5815d0394d09d3b64e3a58727f8d647f2c5a4d1fbb5e40ed5f8424e84&quot;,</span><br><span class="line">                &quot;sha256:460c946f1b353b51ebb7548ea8f8127118d9bdc7be5f8f2c3c4e73fc9968d705&quot;,</span><br><span class="line">                &quot;sha256:3241d073343d5c09cb9854032919de8fe88433c2867fac073a61ed5669e8cae8&quot;,</span><br><span class="line">                &quot;sha256:f5c79923df4c5c22157139e199d0143e8af29ac0f11f73fd4a56759c1f080c05&quot;,</span><br><span class="line">                &quot;sha256:a5d2135a0fbf3b167b687e40028e54e271588a2ece546bcdcf8da5751c4ba828&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331203518152.png" alt="image-20230331203518152"></p>
<p>在添加额外的镜像层的同时，镜像始终保持是当前所有镜像的组合，理解这一点非常重要。下图中举了一个简单的例子，每个镜像层包含 3 个文件，而镜像包含了来自两个镜像层的 6 个文件。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331203612551.png" alt="image-20230331203612551"></p>
<p>下图中展示了一个稍微复杂的三层镜像，在外部看来整个镜像只有 6 个文件，这是因为最上层中的文件 7 是文件 5 的一个更新版本。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331203723498.png" alt="image-20230331203723498"></p>
<p>这种情况下，上层镜像层中的文件覆盖了底层镜像层中的文件。这样就使得文件的更新版本作为一个新镜像层添加到镜像当中。Docker 通过存储引擎 (新版本采用快照机制) 的方式来实现镜像层堆栈，并保证多镜像层对外展示为统一的文件系统。</p>
<p>Linux 上可用的存储引擎有 AUFS、Overlay2、Device Mapper、Btrfs 以及 ZFS。顾名思义，每种存储引擎都基于 Linux 中对应的文件系统或者块设备技术，并且每种存储引擎都有其独有的性能特点。</p>
<p>Docker 在 Windows 上仅支持 windowsfilter 一种存储引擎，该引擎基于 NTFS 文件系统之上实现了分层和 CoW [1]。下图展示了与系统显示相同的三层镜像。所有镜像层堆叠并合并，对外提供统一的视图。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331203816012.png" alt="image-20230331203816012"></p>
<p>Docker 镜像都是只读的，当容器启动时，一个新的可写层被加载到镜像的顶部！</p>
<p>这一层就是我们通常说的容器层，容器之下的都叫镜像层！</p>
<h2 id="commit"><a class="markdownIt-Anchor" href="#commit">#</a> commit</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker commit # 提交容器称为新的副本</span><br><span class="line">docker commit -m=&quot;descriptor&quot; -a=&quot;author&quot; id  name:tag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -it -p 8898:8080 tomcat</span><br><span class="line">docker exec -it ffcc /bin/bash</span><br><span class="line"></span><br><span class="line">docker commit -a=&quot;shabi&quot; -m=&quot;webapp/&quot; ffccc tomcatshabi:1.22</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331205200662.png" alt="image-20230331205200662"></p>
<p>通过 commit 提交后，在原始 tomcat 上面又增加了一层，所以文件会稍微变大一些</p>
<h2 id="容器数据卷"><a class="markdownIt-Anchor" href="#容器数据卷">#</a> 容器数据卷</h2>
<p>如果数据都在容器中，容器删除数据就会丢失，不能持久化</p>
<p>容器之间需要一个数据共享技术。docker 容器中产生的数据同步到本地，防止数据丢失</p>
<p>其实就是目录挂载。将我们容器内的目录，挂载到虚拟机上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.数据卷在容器启动时初始化，如果容器使用的镜像在挂载点包含了数据，这些数据会被拷贝到新初始化的数据卷中</span><br><span class="line">2.数据卷可以在容器之间共享和重用</span><br><span class="line">3.可以对数据卷里的内容直接进行修改</span><br><span class="line">4.数据卷的变化不会影像镜像的更新</span><br><span class="line">5.卷会一直存在，即使挂载数据卷的容器已经被删除</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331210323928.png" alt="image-20230331210323928"></p>
<p>容器间数据也是可以共享的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v 主机目录:容器目录 -p 8767:8080</span><br><span class="line"></span><br><span class="line">docker run -it -v  /home/testing:/home -p 8767:8080 tomcat /bin/bash</span><br><span class="line"></span><br><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;bind&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/home/testing&quot;,    //主机地址</span><br><span class="line">                &quot;Destination&quot;: &quot;/home&quot;,       //docker内地址</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>同步不受容器停止影响</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v  /usr/local/nginx/conf/nginx.conf:/usr/local/nginx/conf/nginx.conf -p 80:80 nginx /bin/bash</span><br></pre></td></tr></table></figure>
<p>以后只需要本地修改即可，容器自动同步</p>
<p>安装 mysql，并挂载数据卷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -v /home/mysql_conf:/etc/mysql/conf.d/ -v /home/mysql_data:/var/lib/mysql  -p 3307:3306 -e MYSQL_ROOT_PASSWORD=123456 --name=mysql002  mysql</span><br><span class="line"></span><br><span class="line">mysql -uroot -p123456 -h121.37.191.89 -p3307</span><br></pre></td></tr></table></figure>
<p>删除容器也不会丢失数据，但会占用两倍内存</p>
<p>这就实现了容器持久化功能</p>
<p><strong>具名挂载、匿名挂载</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">-v 容器内路径 </span><br><span class="line">docker run -d -P --name nginx01 -v /etc/nginx nginx</span><br><span class="line"></span><br><span class="line"># 查看卷的情况</span><br><span class="line">[root@hecs-346515 ~]# docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     879266c77b0964e9bca1b3a1f6cf4d6089eb18d9b9c9e549d0c41357f6dc5a35</span><br><span class="line">local     dirtycow-vdso</span><br><span class="line">local     ee9d314e1c5f3010b8d64108293246853c90d3d820c20332c338ed9bdd3f168b</span><br><span class="line">local     f3924de885d11729faa0c5869488fd0aefca9e3f6bcaddc36c9ce95f4e891603</span><br><span class="line">local     fd3d617a1c288349a4717e3a73e63dbbcf900c51f2d69fe30f9fa726ac82a08d</span><br><span class="line">没有名称的就是匿名挂载</span><br><span class="line"></span><br><span class="line"># 具名挂载</span><br><span class="line">docker run -d -P --name nginx01 -v juming_nginx:/etc/nginx nginx</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]# docker volume inspect juming_nginx</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2023-04-02T21:42:24+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/juming_nginx/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;juming_nginx&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"># 所有docker内的卷，没有指定目录的情况下都在/var/lib/docker/volumes/</span><br><span class="line"></span><br><span class="line">我们通过具名挂载可以方便的找到一个卷</span><br></pre></td></tr></table></figure>
<p>如何区分指定路径和匿名挂载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-v 容器内路径   匿名</span><br><span class="line">-v 卷名:容器内路径 具名</span><br><span class="line">-v /usr/local:/etc/nginx/ 路径</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-v 容器内路径:rw/ro 改变读写权限</span><br><span class="line">docker run -d -P --name nginx01 -v juming_nginx:/etc/nginx:ro nginx</span><br><span class="line">readonly readwrite</span><br><span class="line"></span><br><span class="line">一旦设置了容器容器权限，对我们挂载出来的内容有限定</span><br><span class="line">默认是rw，ro说明只能通过宿主机操作，容器内部无法操作</span><br></pre></td></tr></table></figure>
<h2 id="dockerfile挂载"><a class="markdownIt-Anchor" href="#dockerfile挂载">#</a> Dockerfile 挂载</h2>
<p>dockerfile 就是用来构建 docker 镜像的文件</p>
<p>镜像是一层层的，命令也是一层层的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">VOLUME [&quot;voume01&quot;,&quot;volume02&quot;]</span><br><span class="line"></span><br><span class="line">CMD echo &quot;---------------&quot;</span><br><span class="line">CMD /bin/bash</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 docker-test]# docker build -f ./dockerfile1 -t hahaha .</span><br><span class="line">[+] Building 0.1s (5/5) FINISHED                                                                 </span><br><span class="line"> =&gt; [internal] load build definition from dockerfile1                                       0.1s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 123B                                                        0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                           0.1s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                             0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/centos:latest                            0.0s</span><br><span class="line"> =&gt; [1/1] FROM docker.io/library/centos                                                     0.0s</span><br><span class="line"> =&gt; exporting to image                                                                      0.0s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                     0.0s</span><br><span class="line"> =&gt; =&gt; writing image sha256:29755edf1ce7d5c71c2c7cbbf8b0bd54f02ce72a4ebcaccdfd857aa0dcb99e  0.0s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/hahaha                                                   0.0s</span><br><span class="line"></span><br><span class="line"># 这里的每个命令都是镜像的一层</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 docker-test]# docker run -it hahaha /bin/bash </span><br><span class="line">[root@74ee4cc3e927 /]# ls </span><br><span class="line">bin  etc   lib	  lost+found  mnt  proc  run   srv  tmp  var	   voume01</span><br><span class="line">dev  home  lib64  media       opt  root  sbin  sys  usr  volume02</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> &quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">                &quot;Name&quot;: &quot;eb0e7a226b19aa2e8811eabaf339cf3cee05f3fec433af62212607e0010bda2e&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/eb0e7a226b19aa2e8811eabaf339cf3cee05f3fec433af62212607e0010bda2e/_data&quot;,</span><br><span class="line">                &quot;Destination&quot;: &quot;volume02&quot;,</span><br><span class="line">                &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">                &quot;Name&quot;: &quot;8b52d9050ada34758bacfe403a63a5b6a06e0c96cadb86830fa16aa9533a6fc8&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/8b52d9050ada34758bacfe403a63a5b6a06e0c96cadb86830fa16aa9533a6fc8/_data&quot;,</span><br><span class="line">                &quot;Destination&quot;: &quot;voume01&quot;,</span><br><span class="line">                &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>构建镜像的时候没有挂载均，需要手动 - v 挂载</p>
<h2 id="数据卷容器"><a class="markdownIt-Anchor" href="#数据卷容器">#</a> 数据卷容器</h2>
<p>实现容器之间同步数据</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230402220831342.png" alt="image-20230402220831342"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name docker01 hahaha </span><br><span class="line"></span><br><span class="line">docker run -it --name docker02 --volumes-from docker01 hahaha</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>父容器删除，其他容器的文件依然在</p>
<p>所有父容器和子容器都挂载在宿主机的文件中，如果宿主机挂载目录没了，三个容器都没了</p>
<p>数据卷的声明周期一直到没有容器使用位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /etc/yum.repos.d/*</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span><br><span class="line">yum install wget -y</span><br><span class="line">yum install nginx -y </span><br></pre></td></tr></table></figure>
<h3 id="docker数据卷备份与还原"><a class="markdownIt-Anchor" href="#docker数据卷备份与还原">#</a> docker 数据卷备份与还原</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run  --volumes-from [container name] -v $(pwd):/backup centos tar czvf /backup/backup.tar [container data volume]</span><br><span class="line"></span><br><span class="line">例子：备份datavolume6 到/backup </span><br><span class="line">docker run --volumes-from data-volume2  -v  /root/backup:/backup --name datavolume-copy centos tar zcvf /backup/data-volume2.tar.gz /datavolume6</span><br><span class="line"></span><br><span class="line">还原备份</span><br><span class="line">docker run --volumes-from [container name] -v $(pwd):/backup centos tar xzvf /backup/backup.tar.gz [container data volume]</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">docker run --volumes-from data-volume2 -v /root/backup/:/backup centos tar zxvf /backup/data-volume2.tar.gz -C /datavolume6</span><br></pre></td></tr></table></figure>
<h2 id="dockerfile"><a class="markdownIt-Anchor" href="#dockerfile">#</a> Dockerfile</h2>
<p>dockerfile 是用来构建 dockerfile 的镜像文件，命令参数脚本</p>
<p>一个基本 dockerfile</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line">MAINTAINER xianchao</span><br><span class="line">RUN <span class="built_in">rm</span> -rf /etc/yum.repos.d/*</span><br><span class="line">COPY Centos-vault-8.5.2111.repo /etc/yum.repos.d/</span><br><span class="line">RUN yum install wget -y</span><br><span class="line">RUN yum install nginx -y</span><br><span class="line">COPY index.html /usr/share/nginx/html/</span><br><span class="line">EXPOSE 80</span><br><span class="line">ENTRYPOINT [<span class="string">&quot;/usr/sbin/nginx&quot;</span>,<span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span>] </span><br><span class="line"><span class="comment"># nginx时钟前台运行，避免容器自动退出</span></span><br></pre></td></tr></table></figure>
<p>1. 编写 dockerfile</p>
<p>2.docker build 构建成为镜像</p>
<p>3.docker run 运行镜像</p>
<p>4.docker push 发布镜像</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230402224507380.png" alt="image-20230402224507380"></p>
<p>每个关键字都是大写字母</p>
<p>执行从上到下</p>
<p>#表示注释</p>
<p>每一个指令都会创建一个新的镜像层，并提交</p>
<p>发布项目都要发布 dockerfile</p>
<p>dockerfile 构建文件，定义了一切的步骤，源代码</p>
<p>dockerimages 通过 dockerfile 生成的镜像，最终发布和运行的版本</p>
<p>docker 容器：容器就是镜像运行起来提供服务</p>
<h3 id="dockerfile指令"><a class="markdownIt-Anchor" href="#dockerfile指令">#</a> dockerfile 指令</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">FROM     	# 基础镜像</span><br><span class="line"></span><br><span class="line">MAINTAINER 	# 维护者信息</span><br><span class="line"></span><br><span class="line">RUN 		# 镜像构建的时候需要运行的命令</span><br><span class="line">包含两种模式</span><br><span class="line">1、Shell</span><br><span class="line">RUN &lt;command&gt; (shell模式，这个是最常用的，需要记住)</span><br><span class="line">RUN echo hello</span><br><span class="line">2、exec模式</span><br><span class="line">RUN [“executable”，“param1”，“param2”](exec模式)</span><br><span class="line">RUN [“/bin/bash”,”-c”,”echo hello”]</span><br><span class="line">等价于/bin/bash -c echo hello</span><br><span class="line">RUN yum install wget -y等价于</span><br><span class="line">RUN [“/bin/bash”,”-c”,”yum install wget -y”]</span><br><span class="line"></span><br><span class="line">WORKDIR 	# 镜像工作目录</span><br><span class="line">进容器之后的目录</span><br><span class="line">docker build 构建镜像过程中的，每一个 RUN 命令都是新建的一层。只有通过 WORKDIR 创建的目录才会一直存在。</span><br><span class="line"></span><br><span class="line">volume		# 设置容器卷，挂载到那个位置</span><br><span class="line">1、避免重要的数据，因容器重启而丢失，这是非常致命的。</span><br><span class="line">2、避免容器不断变大。</span><br><span class="line">VOLUME [&quot;/data&quot;]</span><br><span class="line">物理机随机生成一个目录映射到容器中/data</span><br><span class="line">在启动容器 docker run 的时候，我们可以通过 -v 参数修改挂载点</span><br><span class="line"></span><br><span class="line">EXPOSE		# 指定暴露端口</span><br><span class="line">1、帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射。</span><br><span class="line">2、在运行时使用随机端口映射时，也就是 docker run -P 时，会自动随机映射 EXPOSE 的端口。</span><br><span class="line">3、可以是一个或者多个端口，也可以指定多个EXPOSE</span><br><span class="line"></span><br><span class="line">CMD			# 指定容器启动的时候要运行的命令，只有最后一个会生效，可被替代</span><br><span class="line">1、CMD 在docker run 时运行。</span><br><span class="line">2、RUN 是在 docker build构建镜像时运行的</span><br><span class="line"></span><br><span class="line">ENTRYPOINT	# 指定容器启动的时候要运行的命令，可以追加命令</span><br><span class="line">类似于 CMD 指令，但其不会被 docker run 的命令行参数指定的指令所覆盖，而且这些命令行参数会被当作参数送给 ENTRYPOINT 指令指定的程序。</span><br><span class="line">但是, 如果运行 docker run 时使用了 --entrypoint 选项，将覆盖 entrypoint指令指定的程序。</span><br><span class="line">优点：在执行 docker run 的时候可以指定 ENTRYPOINT 运行所需的参数。</span><br><span class="line">注意：如果 Dockerfile 中如果存在多个 ENTRYPOINT 指令，仅最后一个生效。</span><br><span class="line">注意：如果 Dockerfile 中如果存在多个 CMD 指令，仅最后一个生效。</span><br><span class="line">可以搭配 CMD 命令使用：一般是变参才会使用 CMD ，这里的 CMD 等于是在给 ENTRYPOINT 传参</span><br><span class="line">ENTRYPOINT [&quot;nginx&quot;, &quot;-c&quot;] # 定参</span><br><span class="line">CMD [&quot;/etc/nginx/nginx.conf&quot;] # 变参 </span><br><span class="line">不传参运行会 运行nginx -c /etc/nginx/nginx.conf</span><br><span class="line">参参运行 docker run --name nginx  nginx:test /etc/nginx/new.conf  会运行nginx -c /etc/nginx/new.conf</span><br><span class="line"></span><br><span class="line">ONBUILD		# 当构建一个被继承Dockerfile，这个时候就会运行ONBUILD指令</span><br><span class="line">用于延迟构建命令的执行。简单的说，就是 Dockerfile 里用 ONBUILD 指定的命令，在本次构建镜像的过程中不会执行（假设镜像为 test-build）。当有新的 Dockerfile 使用了之前构建的镜像 FROM test-build ，这时执行新镜像的 Dockerfile 构建时候，会执行 test-build 的 Dockerfile 里的 ONBUILD 指定的命令。</span><br><span class="line">ONBUILD COPY index.html /usr/share/nginx/html/</span><br><span class="line">docker build -t=&quot;onbuild-nginx:v1&quot; . --load</span><br><span class="line">只有当某一个dockerfile把onbuild-nginx作为基础镜像时ONBUILD才会执行</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CPOY		# 将文件拷贝到镜像中</span><br><span class="line">COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;源路径1&gt;...  &lt;目标路径&gt;</span><br><span class="line">COPY [--chown=&lt;user&gt;:&lt;group&gt;] [&quot;&lt;源路径1&gt;&quot;,...  &quot;&lt;目标路径&gt;&quot;]</span><br><span class="line">COPY hom* /mydir/</span><br><span class="line">COPY hom?.txt /mydir/</span><br><span class="line"></span><br><span class="line">ADD 		# 步骤：如果搭建tomcat，压缩包就需要add</span><br><span class="line">ADD 的优点：在执行 &lt;源文件&gt; 为 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，会自动复制并解压到 &lt;目标路径&gt;。</span><br><span class="line">ADD 的缺点：在不解压的前提下，无法复制 tar 压缩文件。会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。具体是否使用，可以根据是否需要自动解压来决定。</span><br><span class="line">ADD 指令和 COPY 的使用格式一致</span><br><span class="line"></span><br><span class="line">ENV			# 构建的时候设置环境变量</span><br><span class="line">ENV &lt;key&gt; &lt;value&gt;</span><br><span class="line">ENV &lt;key&gt;=&lt;value&gt;...</span><br><span class="line">ENV NODE_VERSION 6.6.6</span><br><span class="line">RUN curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz&quot; \</span><br><span class="line">  &amp;&amp; curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc&quot;</span><br><span class="line"> </span><br><span class="line">USER </span><br><span class="line">用于指定执行后续命令的用户和用户组，这边只是切换后续命令执行的用户（用户和用户组必须提前已经存在）。</span><br><span class="line">格式：</span><br><span class="line">USER &lt;用户名&gt;[:&lt;用户组&gt;]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>dockerhub 中大部分镜像都是从 FROM scratch 来的，然后配置需要的软件和配置来进行构建</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个centos</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> shabi&lt;<span class="number">21111</span>@qq.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MYPATH /usr/local</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$MYPATH</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install epel* -y</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y vim</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y net-tools</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="variable">$MYPATH</span></span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建镜像</span></span><br><span class="line">docker build -f dockerfile -t centoshaha:<span class="number">0.5</span> . </span><br><span class="line"></span><br><span class="line">[root@hecs-<span class="number">346515</span> dockerfile]<span class="comment"># docker build -f dockerfile -t centoshaha:0.5 . </span></span><br><span class="line">[+] Building <span class="number">199.4</span>s (<span class="number">5</span>/<span class="number">7</span>)                                                                                             </span><br><span class="line">[+] Building <span class="number">200.1</span>s (<span class="number">5</span>/<span class="number">7</span>)                                                                                             </span><br><span class="line">[+] Building <span class="number">200.6</span>s (<span class="number">5</span>/<span class="number">7</span>)                                                                                             </span><br><span class="line">[+] Building <span class="number">200.9</span>s (<span class="number">5</span>/<span class="number">7</span>)                                                                                             </span><br><span class="line">[+] Building <span class="number">228.0</span>s (<span class="number">8</span>/<span class="number">8</span>) FINISHED                                                                                    </span><br><span class="line"> =&gt; [internal] load build definition <span class="keyword">from</span> dockerfile                                                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: <span class="number">219</span>B                                                                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">2</span>B                                                                                  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/centos:<span class="number">7</span>                                                     <span class="number">16.0</span>s</span><br><span class="line"> =&gt; [<span class="number">1</span>/<span class="number">4</span>] <span class="keyword">FROM</span> docker.io/library/centos:<span class="number">7</span>@sha256:<span class="number">9</span>d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426a630e0  <span class="number">50.2</span>s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/centos:<span class="number">7</span>@sha256:<span class="number">9</span>d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426a630e09  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; sha256:<span class="number">9</span>d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426a630e0987 <span class="number">1.20</span>kB / <span class="number">1.20</span>kB                   <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; sha256:dead07b4d8ed7e29e98de0f4504d87e8880d4347859d839686a31da35a3b532f <span class="number">529</span>B / <span class="number">529</span>B                       <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; sha256:eeb6ee3f44bd0b5103bb561b4c16bcb82328cfe5809ab675bb17ab3a16c517c9 <span class="number">2.75</span>kB / <span class="number">2.75</span>kB                   <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; sha256:<span class="number">2</span>d473b07cdd5f0912cd6f1a703352c82b512407db6b05b43f2553732b55df3bc <span class="number">76.10</span>MB / <span class="number">76.10</span>MB                <span class="number">46.3</span>s</span><br><span class="line"> =&gt; =&gt; extracting sha256:<span class="number">2</span>d473b07cdd5f0912cd6f1a703352c82b512407db6b05b43f2553732b55df3bc                        <span class="number">3.6</span>s</span><br><span class="line"> =&gt; [<span class="number">2</span>/<span class="number">4</span>] <span class="keyword">WORKDIR</span><span class="language-bash"> /usr/local                                                                                     0.0s</span></span><br><span class="line"> =&gt; [<span class="number">3</span>/<span class="number">4</span>] <span class="keyword">RUN</span><span class="language-bash"> yum install -y vim                                                                               156.1s</span></span><br><span class="line"> =&gt; [<span class="number">4</span>/<span class="number">4</span>] <span class="keyword">RUN</span><span class="language-bash"> yum install -y net-tools                                                                           2.9s</span></span><br><span class="line"> =&gt; exporting to image                                                                                           <span class="number">2.7</span>s </span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                          <span class="number">2.7</span>s </span><br><span class="line"> =&gt; =&gt; writing image sha256:<span class="number">1</span>c525b4438024495ebbbf1f19a3e3ea730826dfcab5cb8337ea0fa0a0de853ad                     <span class="number">0.0</span>s </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/centoshaha:<span class="number">0.5</span>    </span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404110343127.png" alt="image-20230404110343127"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 dockerfile]# docker history 1c5</span><br><span class="line">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class="line">1c525b443802   4 minutes ago   CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;/bin/bash&quot;]                0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;echo $MYPATH&quot;]             0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   EXPOSE map[80/tcp:&#123;&#125;]                           0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c yum install -y net-tools # bu…   176MB     buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c yum install -y vim # buildkit    259MB     buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      7 minutes ago   WORKDIR /usr/local                              0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      7 minutes ago   ENV MYPATH=/usr/local                           0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      7 minutes ago   MAINTAINER shabi&lt;21111@qq.com&gt;                  0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      18 months ago   /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span><br><span class="line">&lt;missing&gt;      18 months ago   /bin/sh -c #(nop)  LABEL org.label-schema.sc…   0B        </span><br><span class="line">&lt;missing&gt;      18 months ago   /bin/sh -c #(nop) ADD file:b3ebbe8bd304723d4…   204MB     </span><br><span class="line"></span><br><span class="line">[root@hecs-346515 dockerfile]# docker history 5d0</span><br><span class="line">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class="line">5d0da3dc9764   18 months ago   /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span><br><span class="line">&lt;missing&gt;      18 months ago   /bin/sh -c #(nop)  LABEL org.label-schema.sc…   0B        </span><br><span class="line">&lt;missing&gt;      18 months ago   /bin/sh -c #(nop) ADD file:805cb5e15fb6e0bb0…   231MB     </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:7</span><br><span class="line">CMD [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hecs-346515 dockerfile]# docker build -f cmd  -t cmd:0.5 . </span><br><span class="line">[+] Building 0.3s (5/5) FINISHED                                                                                      </span><br><span class="line"> =&gt; [internal] load build definition from cmd                                                                    0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 60B                                                                              0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                  0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/centos:7                                                      0.2s</span><br><span class="line"> =&gt; CACHED [1/1] FROM docker.io/library/centos:7@sha256:9d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426  0.0s</span><br><span class="line"> =&gt; exporting to image                                                                                           0.0s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                          0.0s</span><br><span class="line"> =&gt; =&gt; writing image sha256:3ced42c5b7de1bbe7659ef7bd2349ebf83eb13eab6d1afe69f029ef65a88f9ab                     0.0s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/cmd:0.5                                                                       0.0s</span><br><span class="line">[root@hecs-346515 dockerfile]# docker run -it cmd:0.5 </span><br><span class="line">.   .dockerenv	       bin  etc   lib	 media	opt   root  sbin  sys  usr</span><br><span class="line">..  anaconda-post.log  dev  home  lib64  mnt	proc  run   srv   tmp  var</span><br><span class="line"></span><br><span class="line">CMD			# 指定容器启动的时候要运行的命令，只有最后一个会生效，可被替代</span><br><span class="line"></span><br><span class="line">docker run 3e -l    # -l不是命令所以报错</span><br><span class="line"></span><br><span class="line">docker run 3e ls -al  ls -al 替换了ls -a</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">vim entry</span><br><span class="line">FROM centos:7</span><br><span class="line">ENTRYPOINT [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 dockerfile]# docker run entry:0.5</span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">anaconda-post.log</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hecs-346515 dockerfile]# docker run entry:0.5 -l</span><br><span class="line">total 64</span><br><span class="line">drwxr-xr-x   1 root root  4096 Apr  4 03:18 .</span><br><span class="line">drwxr-xr-x   1 root root  4096 Apr  4 03:18 ..</span><br><span class="line">-rwxr-xr-x   1 root root     0 Apr  4 03:18 .dockerenv</span><br><span class="line">-rw-r--r--   1 root root 12114 Nov 13  2020 anaconda-post.log</span><br><span class="line">lrwxrwxrwx   1 root root     7 Nov 13  2020 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x   5 root root   340 Apr  4 03:18 dev</span><br><span class="line">drwxr-xr-x   1 root root  4096 Apr  4 03:18 etc</span><br><span class="line">drwxr-xr-x   2 root root  4096 Apr 11  2018 home</span><br><span class="line">lrwxrwxrwx   1 root root     7 Nov 13  2020 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx   1 root root     9 Nov 13  2020 lib64 -&gt; usr/lib64</span><br><span class="line">drwxr-xr-x   2 root root  4096 Apr 11  2018 media</span><br><span class="line">drwxr-xr-x   2 root root  4096 Apr 11  2018 mnt</span><br><span class="line">drwxr-xr-x   2 root root  4096 Apr 11  2018 opt</span><br><span class="line">dr-xr-xr-x 134 root root     0 Apr  4 03:18 proc</span><br><span class="line">dr-xr-x---   2 root root  4096 Nov 13  2020 root</span><br><span class="line">drwxr-xr-x  11 root root  4096 Nov 13  2020 run</span><br><span class="line">lrwxrwxrwx   1 root root     8 Nov 13  2020 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x   2 root root  4096 Apr 11  2018 srv</span><br><span class="line">dr-xr-xr-x  13 root root     0 Apr  4 03:18 sys</span><br><span class="line">drwxrwxrwt   7 root root  4096 Nov 13  2020 tmp</span><br><span class="line">drwxr-xr-x  13 root root  4096 Nov 13  2020 usr</span><br><span class="line">drwxr-xr-x  18 root root  4096 Nov 13  2020 var</span><br><span class="line"></span><br><span class="line">ENTRYPOINT	# 指定容器启动的时候要运行的命令，可以追加命令</span><br></pre></td></tr></table></figure>
<blockquote>
<p>entrypoint 是追加，CMD 是覆盖</p>
</blockquote>
<h3 id="制作nginx镜像"><a class="markdownIt-Anchor" href="#制作nginx镜像">#</a> 制作 nginx 镜像</h3>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">MAINTAINER</span> xianchao</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf /etc/yum.repos.d/*</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> Centos-vault-8.5.2111.repo /etc/yum.repos.d/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install wget -y</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install nginx -y</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> index.html /usr/share/nginx/html/</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/usr/sbin/nginx&quot;</span>,<span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建</span></span><br><span class="line">docker build -t=<span class="string">&quot;shinya/shabi:v1&quot;</span> .</span><br><span class="line"></span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d  -p 80 --name html2 shinya/shabi:v1</span></span><br></pre></td></tr></table></figure>
<h3 id="制作tomcat镜像"><a class="markdownIt-Anchor" href="#制作tomcat镜像">#</a> 制作 tomcat 镜像</h3>
<p>1、准备安装包</p>
<p>2、Dockerfile 是官方命名，构建时会自动寻找，就不需要 - f 指定了</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> shshshs&lt;<span class="number">110</span>@<span class="number">110</span>.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> readme.txt /usr/local/readme.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> apache-tomcat-10.1.7.tar.gz  /usr/local/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> jdk-20_linux-x64_bin.tar.gz  /usr/local/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y vim</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MYPATH /usr/local/</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$MYPATH</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/local/jdk-<span class="number">20</span></span><br><span class="line"><span class="keyword">ENV</span> CLASS_PATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"><span class="keyword">ENV</span> CATALINA_HOME /usr/local/apache-tomcat-<span class="number">10.1</span>.<span class="number">7</span>/</span><br><span class="line"><span class="keyword">ENV</span> CATALINA_BASE /usr/local/apache-tomcat-<span class="number">10.1</span>.<span class="number">7</span>/</span><br><span class="line"><span class="keyword">ENV</span> PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /usr/local/apache-tomcat-10.1.7/bin/startup.sh &amp;&amp; <span class="built_in">tail</span> -F /usr/local/apache-tomcat-10.1.7/logs/catalina.out</span></span><br></pre></td></tr></table></figure>
<p>3. 构建镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 dockerfile]# docker build -t ddcat:1.0 .</span><br><span class="line">[+] Building 61.4s (11/11) FINISHED                                                                                   </span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                             0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 690B                                                                             0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                  0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/centos:7                                                     15.3s</span><br><span class="line"> =&gt; CACHED [1/6] FROM docker.io/library/centos:7@sha256:9d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426  0.0s</span><br><span class="line"> =&gt; [internal] load build context                                                                                2.3s</span><br><span class="line"> =&gt; =&gt; transferring context: 203.75MB                                                                            2.3s</span><br><span class="line"> =&gt; [2/6] COPY readme.txt /usr/local/readme.txt                                                                  0.5s</span><br><span class="line"> =&gt; [3/6] ADD apache-tomcat-10.1.7.tar.gz  /usr/local/                                                           0.4s</span><br><span class="line"> =&gt; [4/6] ADD jdk-20_linux-x64_bin.tar.gz  /usr/local/                                                           4.6s</span><br><span class="line"> =&gt; [5/6] RUN yum install -y vim                                                                                34.4s</span><br><span class="line"> =&gt; [6/6] WORKDIR /usr/local/                                                                                    0.0s </span><br><span class="line"> =&gt; exporting to image                                                                                           3.8s </span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                          3.8s </span><br><span class="line"> =&gt; =&gt; writing image sha256:620e725ff485b1cae36720ea191ba0692cc5f2a857e516528e5b65653e752913                     0.0s </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/ddcat:1.0                                                                     0.0s </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">4.启动镜像</span><br><span class="line">[root@hecs-346515 dockerfile]# docker run -d -p 8877:8080 --name=catcatcat -v /root/dockerfile/build/tomcat/test:/usr/local/apache-tomcat-10.1.7/webapps/test -v /root/dockerfile/build/tomcat/logs:/usr/local/apache-tomcat-10.1.7/logs ddcat:1.1</span><br><span class="line">4357a9cda1d960125ac7d4ab052902ec04848c0dbbce3beb26bccf4eaff84fa4</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>5、访问测试</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404124622232.png" alt="image-20230404124622232"></p>
<p>6. 发布项目</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">version</span>=<span class="string">&quot;2.4&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/j2ee&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/j2ee </span></span></span><br><span class="line"><span class="string"><span class="tag">        http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span>                                   </span><br></pre></td></tr></table></figure>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;%--    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;--%&gt;</span><br><span class="line">&lt;%--    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;IE=edge&quot;</span>&gt;--%&gt;</span><br><span class="line">&lt;%--    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;--%&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;css/bootstrap.min.css&quot;</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;css/bootstrap.min.css.map&quot;</span>&gt;</span><br><span class="line">    &lt;script type=<span class="string">&quot;text/javascript&quot;</span> src=<span class="string">&quot;js/jquery-3.5.1.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type=<span class="string">&quot;text/javascript&quot;</span> src=<span class="string">&quot;js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">        $(function () &#123;</span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                url: <span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/type?method=findAllType&quot;</span>,</span><br><span class="line">                type: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">                dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">                success: function (data) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> i in data) &#123;</span><br><span class="line">                        <span class="type">var</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;&lt;li&gt;&lt;a href=&#x27;$&#123;pageContext.request.contextPath&#125;/product?method=show&amp;tid=&quot;</span> + data[i].tid + <span class="string">&quot;&#x27;&gt;&quot;</span> + data[i].tname + <span class="string">&quot;&lt;/a&gt;&lt;/li&gt;&quot;</span>;</span><br><span class="line">                        $(<span class="string">&quot;#goodsType&quot;</span>).append(a);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                error: function () &#123;</span><br><span class="line">                    alert(<span class="string">&quot;失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;nav class=<span class="string">&quot;navbar navbar-default&quot;</span>&gt;</span><br><span class="line">        &lt;div class=<span class="string">&quot;container-fluid&quot;</span>&gt;</span><br><span class="line">            &lt;!-- Brand and toggle get grouped <span class="keyword">for</span> better mobile display --&gt;</span><br><span class="line">            &lt;div class=<span class="string">&quot;navbar-header&quot;</span>&gt;</span><br><span class="line">                &lt;button type=<span class="string">&quot;button&quot;</span> class=<span class="string">&quot;navbar-toggle collapsed&quot;</span> data-toggle=<span class="string">&quot;collapse&quot;</span></span><br><span class="line">                        data-target=<span class="string">&quot;#bs-example-navbar-collapse-1&quot;</span> aria-expanded=<span class="string">&quot;false&quot;</span>&gt;</span><br><span class="line">                    &lt;span class=<span class="string">&quot;sr-only&quot;</span>&gt;Toggle navigation&lt;/span&gt;</span><br><span class="line">                    &lt;span class=<span class="string">&quot;icon-bar&quot;</span>&gt;&lt;/span&gt;</span><br><span class="line">                    &lt;span class=<span class="string">&quot;icon-bar&quot;</span>&gt;&lt;/span&gt;</span><br><span class="line">                    &lt;span class=<span class="string">&quot;icon-bar&quot;</span>&gt;&lt;/span&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">                &lt;a class=<span class="string">&quot;navbar-brand&quot;</span> href=<span class="string">&quot;#&quot;</span>&gt;myShop商城&lt;/a&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- Collect the nav links, forms, and other content <span class="keyword">for</span> toggling --&gt;</span><br><span class="line">            &lt;div class=<span class="string">&quot;collapse navbar-collapse&quot;</span> id=<span class="string">&quot;bs-example-navbar-collapse-1&quot;</span>&gt;</span><br><span class="line">                &lt;ul class=<span class="string">&quot;nav navbar-nav&quot;</span>&gt;</span><br><span class="line">                    &lt;li class=<span class="string">&quot;active&quot;</span>&gt;&lt;a href=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/Login.jsp&quot;</span>&gt;登录&lt;span class=<span class="string">&quot;sr-only&quot;</span>&gt;(current)&lt;/span&gt;&lt;/a&gt;</span><br><span class="line">                    &lt;/li&gt;</span><br><span class="line">                    &lt;li&gt;&lt;a href=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/Register.jsp&quot;</span>&gt;注册&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li&gt;&lt;a href=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/user?method=loginOut&quot;</span>&gt;注销&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line">                &lt;form class=<span class="string">&quot;navbar-form navbar-left&quot;</span>&gt;</span><br><span class="line">                    &lt;div class=<span class="string">&quot;form-group&quot;</span>&gt;</span><br><span class="line">                        &lt;input type=<span class="string">&quot;text&quot;</span> class=<span class="string">&quot;form-control&quot;</span> placeholder=<span class="string">&quot;搜索一下&quot;</span>&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;button type=<span class="string">&quot;submit&quot;</span> class=<span class="string">&quot;btn btn-default&quot;</span>&gt;搜索&lt;/button&gt;</span><br><span class="line">                &lt;/form&gt;</span><br><span class="line">                &lt;ul class=<span class="string">&quot;nav navbar-nav navbar-right&quot;</span>&gt;</span><br><span class="line">                    &lt;li&gt;&lt;a href=<span class="string">&quot;#&quot;</span>&gt;购物车&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line">            &lt;/div&gt;&lt;!-- /.navbar-collapse --&gt;</span><br><span class="line">        &lt;/div&gt;&lt;!-- /.container-fluid --&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line">    &lt;nav class=<span class="string">&quot;navbar navbar-default&quot;</span>&gt;</span><br><span class="line">        &lt;p&gt;</span><br><span class="line">        &lt;ul id=<span class="string">&quot;goodsType&quot;</span>&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">        &lt;/p&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@hecs</span>-<span class="number">346515</span> test]# pwd </span><br><span class="line">/root/dockerfile/build/tomcat/test</span><br><span class="line">[root<span class="meta">@hecs</span>-<span class="number">346515</span> test]# ls </span><br><span class="line">index.jsp  WEB_INF</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="go代码dockerfile做成镜像"><a class="markdownIt-Anchor" href="#go代码dockerfile做成镜像">#</a> go 代码 dockerfile 做成镜像</h3>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">yum install go -y</span><br><span class="line"></span><br><span class="line">cat main.go</span><br><span class="line">import (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func statusOKHandler(c *gin.Context) &#123;</span><br><span class="line">	c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;success~welcome to study&quot;</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func versionHandler(c *gin.Context) &#123;</span><br><span class="line">	c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;version&quot;</span>: <span class="string">&quot;v1.1版本&quot;</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	router := gin.New()</span><br><span class="line">	router.Use(gin.Recovery())</span><br><span class="line">	router.GET(<span class="string">&quot;/&quot;</span>, statusOKHandler)</span><br><span class="line">	router.GET(<span class="string">&quot;/version&quot;</span>, versionHandler)</span><br><span class="line">	router.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">go mod init test  <span class="comment"># test为当前目录</span></span><br><span class="line"><span class="comment">#设置代理</span></span><br><span class="line">go <span class="keyword">env</span> -w GOPROXY=https://goproxy.cn,direct</span><br><span class="line">go mod tidy</span><br><span class="line"><span class="comment">#构建源码</span></span><br><span class="line">CGO_ENABLED=<span class="number">0</span> GOOS=linux GOARCH=amd64 go build -o k8s-demo main.go</span><br><span class="line">./k8s-demo </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /data/app</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> k8s-demo /data/app/</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;./k8s-demo&quot;</span>]</span></span><br><span class="line"></span><br><span class="line">docker build -t dashabi:v1 .</span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d --name go2 -p 30188:8083 dashabi:v1</span></span><br><span class="line">curl localhost:<span class="number">30188</span>/version</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="python-dockerfile构建"><a class="markdownIt-Anchor" href="#python-dockerfile构建">#</a> python dockerfile 构建</h3>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf hello-python.tar.gz</span><br><span class="line"><span class="comment"># 得到main.py,requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.7</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /app </span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app </span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> . /app/ </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> /usr/local/bin/python -m pip install --upgrade pip</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install -r requirements.txt</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>,<span class="string">&quot;/app/main.py&quot;</span>]</span></span><br><span class="line"></span><br><span class="line">docker build  -t hello-python:v1 . </span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d --name python -p 30050:5000  hello-python:v1</span></span><br></pre></td></tr></table></figure>
<h2 id="发布镜像"><a class="markdownIt-Anchor" href="#发布镜像">#</a> 发布镜像</h2>
<p><strong>dockerhub</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#登录dockerhub</span><br><span class="line">[root@hecs-346515 test]# docker login -u kbshire -p </span><br><span class="line"></span><br><span class="line">[root@hecs-346515 test]# docker build -t kbshire/avcat:2.333 .</span><br><span class="line">[root@hecs-346515 test]# docker push kbshire/avcat:2.333</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>阿里云</strong></p>
<p>1. 创建命名空间</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404132912975.png" alt="image-20230404132912975"></p>
<p>2. 创建容器镜像</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404133112291.png" alt="image-20230404133112291"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404134421264.png" alt="image-20230404134421264"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404134504442.png" alt="image-20230404134504442"></p>
<h2 id="docker-网络"><a class="markdownIt-Anchor" href="#docker-网络">#</a> Docker 网络</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bridge模式：使--net =bridge指定，默认设置；</span><br><span class="line">host模式：使--net =host指定；</span><br><span class="line">none模式：使--net =none指定；</span><br><span class="line">container模式：使用--net =container:NAME orID指定。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 dockerfile]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether fa:16:3e:8b:e2:28 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.0.69/24 brd 192.168.0.255 scope global noprefixroute dynamic eth0</span><br><span class="line">       valid_lft 67882sec preferred_lft 67882sec</span><br><span class="line">    inet6 fe80::f816:3eff:fe8b:e228/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    link/ether 02:42:27:32:a6:49 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:27ff:fe32:a649/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P --name tomcat01 tomcat </span><br><span class="line"></span><br><span class="line">docker exec -it tomcat01 ip addr </span><br><span class="line"></span><br><span class="line"># yum install iproute</span><br><span class="line">[root@29ede5d03d63 local]# ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">161: eth0@if162: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">linux是可以ping通容器内部的</span><br></pre></td></tr></table></figure>
<p>每启动一个 docker 容器，docker 就会给 docker 容器分配一个 ip，我们只要安装了 docker 就会有一个网卡 docker0</p>
<p>桥接模式，就是 evth-pair 技术</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">162: vetha5d997c@if161: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    link/ether 82:60:95:bc:a3:22 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::8060:95ff:febc:a322/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>容器带来的网卡都是一对一对的</p>
<p>evth-pair 就是一队虚拟设备接口，他们是成对出现的，一端连着协议，一端彼此相连</p>
<p>evth-pair 连接各种网络设备</p>
<p>OpenStack，docker 容器之间，ovs 的连接都是使用 evth-pair</p>
<p>容器和容器之间可以互相通信</p>
<p>容器之间通信共用的 docker0，可以理解为一个路由器</p>
<p>不指定容器网络的情况下，都是 docker0 路由的，docker 回给我们的容器分配一个默认 ip</p>
<p>/16 的掩码最多可以有 65535 个地址</p>
<p>docker 使用 linux 桥接，宿主机中是一个 docker 网络的网桥 docker0</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404142456521.png" alt="image-20230404142456521"></p>
<p>docker 中所有网络接口都是虚拟的，转发效率高</p>
<p>容器删除，veth-pair 也就被删除了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install bridge-utils</span><br><span class="line">brctl show</span><br></pre></td></tr></table></figure>
<h3 id="link"><a class="markdownIt-Anchor" href="#link">#</a> –link</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 dockerfile]# docker run -it  -P --name centos05 --link gallant_poincare centoshaha:0.5</span><br><span class="line">[root@hecs-346515 ~]# docker exec -it centos05 ping gallant_poincare</span><br><span class="line">通过link实现可以通过服务名ping</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]# docker exec -it gallant_poincare ping centos05</span><br><span class="line">ping: centos05: Name or service not known</span><br><span class="line"></span><br><span class="line">docker network inspect id</span><br><span class="line"></span><br><span class="line">[root@5e0c29c45f15 local]# cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.3	gallant_poincare cef544877c1d</span><br><span class="line">172.17.0.4	5e0c29c45f15</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>–link 就是在 hosts 中增加了 gallant_poincare 的映射</strong></p>
<p>不建议使用–link</p>
<p>docker0 的问题，他不支持容器名进行连接访问</p>
<h3 id="自定义网络"><a class="markdownIt-Anchor" href="#自定义网络">#</a> 自定义网络</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 dockerfile]# docker network ls </span><br><span class="line">NETWORK ID     NAME                     DRIVER    SCOPE</span><br><span class="line">ef281869253b   bridge                   bridge    local</span><br><span class="line">81efa88be64b   host                     host      local</span><br><span class="line">57ffa6ffd57d   loadbalancejsp_default   bridge    local</span><br><span class="line">55243546bae4   none                     null      local</span><br></pre></td></tr></table></figure>
<p><strong>网络模式</strong></p>
<p>bridge：docker 之间搭桥，自己创建也使用桥接</p>
<p>none：不配置网络，一般不用</p>
<p>​	Docker 网络 none 模式是指创建的容器没有网络地址，只有 lo 网卡</p>
<p>host：和宿主机共享网络</p>
<p>container：容器内网络连通，局限很大</p>
<p>​	创建新容器的时候，通过–net container 参数，指定其和已经存在的某个容器共享一个 Network Namespace。两个容器的进程通过 lo 网卡设备通信。</p>
<p>​	docker run --name container2 --net=container:none  -it --privileged=true centos</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --net=none --privileged=true centos </span><br><span class="line">特权模式下才是真正的root 在容器内部</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">直接启动的命令默认--net bridge  这就是docker0</span><br><span class="line">docker0是默认的，不能通过域名访问</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 dockerfile]# docker network create --driver bridge --subnet 10.1.0.0/16 --gateway 10.1.0.1 sbnet </span><br><span class="line">82c4a8b68c66715f88003b8ba4ef65de670286de1c73abee49ab26f9fceb063a</span><br><span class="line">[root@hecs-346515 dockerfile]# docker network ls </span><br><span class="line">NETWORK ID     NAME                     DRIVER    SCOPE</span><br><span class="line">ef281869253b   bridge                   bridge    local</span><br><span class="line">81efa88be64b   host                     host      local</span><br><span class="line">57ffa6ffd57d   loadbalancejsp_default   bridge    local</span><br><span class="line">55243546bae4   none                     null      local</span><br><span class="line">82c4a8b68c66   sbnet                    bridge    local</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 dockerfile]# docker network inspect sbnet</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;sbnet&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;82c4a8b68c66715f88003b8ba4ef65de670286de1c73abee49ab26f9fceb063a&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2023-04-04T18:25:48.537296679+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;10.1.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;10.1.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">docker run -it  -P --name=centos11 --net sbnet centos </span><br><span class="line">docker run -it  -P --name=centos12 --net sbnet centos</span><br><span class="line">docker exec -it centos11 ping centos12 </span><br><span class="line">不使用--link也能ping通</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们自定义的网络 docker 已经帮我们维护好了关系</p>
<p>可以使不同集群使用不同的网络，保证集群的安全和健康</p>
<h3 id="网络连通"><a class="markdownIt-Anchor" href="#网络连通">#</a> 网络连通</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">docker netowrk connect sbnet centos13</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]# docker network connect sbnet centos13</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]# docker network inspect sbnet </span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;sbnet&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;82c4a8b68c66715f88003b8ba4ef65de670286de1c73abee49ab26f9fceb063a&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2023-04-04T18:25:48.537296679+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;10.1.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;10.1.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;872404abcfc68d09a65ec820c986aa2003737629a0bdf83406152793dc72f228&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;centos12&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;e393d20c796d4c081b726787210dc5a05d645d33c1a75fd6da529ac11db6e0c1&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:0a:01:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;10.1.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;974c928cc0854549c5cf9b8e257adf025bf9e1499b1169b46bf56c1632565bbe&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;centos13&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;a571e55079a80a2f36ff6e181194cadc1ec49b76bd51bb4485be030201a718c7&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:0a:01:00:04&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;10.1.0.4/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;ed93b6d1202d8953cd9ae12450e44538d1647620423a7cbf63d1bcd9f023e7a6&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;centos11&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;820d037e8faaad9c8a19cd0a58629c1ec1881cc2b9e5e26a21420a1bb8724ccd&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:0a:01:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;10.1.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">将centos13放到了bridge下，一个容器此时有两个地址</span><br></pre></td></tr></table></figure>
<p>要跨网络操作容器，需要 docker connect 连通</p>
<h3 id="redis集群"><a class="markdownIt-Anchor" href="#redis集群">#</a> Redis 集群</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">for port in $(seq 1 6); \</span><br><span class="line">do \</span><br><span class="line">mkdir -p /mydata/redis/node-$&#123;port&#125;/conf</span><br><span class="line">touch /mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class="line">cat &lt;&lt; EOF &gt;/mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class="line">port 6379 </span><br><span class="line">bind 0.0.0.0</span><br><span class="line">cluster-enabled yes </span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.38.0.1$&#123;port&#125;</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly yes</span><br><span class="line">EOF</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -p 6376:6379 -p 16376:16379 --name redis-6 -v /mydata/redis/node-6/data:/data -v /mydata/redis/node-6/conf/redis.conf:/etc/redis/redis.conf -d --net redis --ip 172.38.0.16 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf </span></span><br><span class="line"></span><br><span class="line">redis-cli --cluster create <span class="number">172.38</span>.<span class="number">0.11</span>:<span class="number">6379</span> <span class="number">172.38</span>.<span class="number">0.12</span>:<span class="number">6379</span> <span class="number">172.38</span>.<span class="number">0.13</span>:<span class="number">6379</span> <span class="number">172.38</span>.<span class="number">0.14</span>:<span class="number">6379</span> <span class="number">172.38</span>.<span class="number">0.15</span>:<span class="number">637</span></span><br><span class="line"><span class="number">9</span> <span class="number">172.38</span>.<span class="number">0.16</span>:<span class="number">6379</span> --cluster-replicas <span class="number">1</span></span><br><span class="line"></span><br><span class="line">/data <span class="comment"># redis-cli -c</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span>&gt; CLUSTER INFO</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:<span class="number">16384</span></span><br><span class="line">cluster_slots_ok:<span class="number">16384</span></span><br><span class="line">cluster_slots_pfail:<span class="number">0</span></span><br><span class="line">cluster_slots_fail:<span class="number">0</span></span><br><span class="line">cluster_known_nodes:<span class="number">6</span></span><br><span class="line">cluster_size:<span class="number">3</span></span><br><span class="line">cluster_current_epoch:<span class="number">6</span></span><br><span class="line">cluster_my_epoch:<span class="number">1</span></span><br><span class="line">cluster_stats_messages_ping_sent:<span class="number">82</span></span><br><span class="line">cluster_stats_messages_pong_sent:<span class="number">82</span></span><br><span class="line">cluster_stats_messages_sent:<span class="number">164</span></span><br><span class="line">cluster_stats_messages_ping_received:<span class="number">77</span></span><br><span class="line">cluster_stats_messages_pong_received:<span class="number">82</span></span><br><span class="line">cluster_stats_messages_meet_received:<span class="number">5</span></span><br><span class="line">cluster_stats_messages_received:<span class="number">164</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span>&gt; CLUSTER NODES</span><br><span class="line">b75997d0df1dafbbf8db3642f424eedc0cd9695f <span class="number">172.38</span>.<span class="number">0.15</span>:<span class="number">6379</span>@<span class="number">16379</span> slave <span class="number">73</span>a37cfa8c760c3069bd4fb69f9b2a411f556124 <span class="number">0</span> <span class="number">1680661677823</span> <span class="number">5</span> connected</span><br><span class="line"><span class="number">73</span>a37cfa8c760c3069bd4fb69f9b2a411f556124 <span class="number">172.38</span>.<span class="number">0.11</span>:<span class="number">6379</span>@<span class="number">16379</span> myself,master - <span class="number">0</span> <span class="number">1680661677000</span> <span class="number">1</span> connected <span class="number">0</span>-<span class="number">5460</span></span><br><span class="line"><span class="number">51</span>c02482b19b9ab5dc20ff1852f375ada2f68986 <span class="number">172.38</span>.<span class="number">0.12</span>:<span class="number">6379</span>@<span class="number">16379</span> master - <span class="number">0</span> <span class="number">1680661677522</span> <span class="number">2</span> connected <span class="number">5461</span>-<span class="number">10922</span></span><br><span class="line">ba2557b0959bed1cc5a446bcd0403721bcb8d002 <span class="number">172.38</span>.<span class="number">0.14</span>:<span class="number">6379</span>@<span class="number">16379</span> slave <span class="number">3794</span>de303a95a3718988f3d313f332241b364d7c <span class="number">0</span> <span class="number">1680661677000</span> <span class="number">4</span> connected</span><br><span class="line"><span class="number">3794</span>de303a95a3718988f3d313f332241b364d7c <span class="number">172.38</span>.<span class="number">0.13</span>:<span class="number">6379</span>@<span class="number">16379</span> master - <span class="number">0</span> <span class="number">1680661676822</span> <span class="number">3</span> connected <span class="number">10923</span>-<span class="number">16383</span></span><br><span class="line"><span class="number">73007</span>d040ed6ca3c093fb5061a3358d1ae47a18a <span class="number">172.38</span>.<span class="number">0.16</span>:<span class="number">6379</span>@<span class="number">16379</span> slave <span class="number">51</span>c02482b19b9ab5dc20ff1852f375ada2f68986 <span class="number">0</span> <span class="number">1680661676000</span> <span class="number">6</span> connected</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span>&gt; set a b </span><br><span class="line">-&gt; Redirected to slot [<span class="number">15495</span>] located at <span class="number">172.38</span>.<span class="number">0.13</span>:<span class="number">6379</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">172.38</span>.<span class="number">0.13</span>:<span class="number">6379</span>&gt; get a </span><br><span class="line">^C</span><br><span class="line">/data <span class="comment"># redis-cli -c</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6379</span>&gt; get a </span><br><span class="line">-&gt; Redirected to slot [<span class="number">15495</span>] located at <span class="number">172.38</span>.<span class="number">0.14</span>:<span class="number">6379</span></span><br><span class="line"><span class="string">&quot;b&quot;</span></span><br><span class="line"><span class="number">172.38</span>.<span class="number">0.14</span>:<span class="number">6379</span>&gt; CLUSTER NODES</span><br><span class="line">b75997d0df1dafbbf8db3642f424eedc0cd9695f <span class="number">172.38</span>.<span class="number">0.15</span>:<span class="number">6379</span>@<span class="number">16379</span> slave <span class="number">73</span>a37cfa8c760c3069bd4fb69f9b2a411f556124 <span class="number">0</span> <span class="number">1680661856417</span> <span class="number">5</span> connected</span><br><span class="line"><span class="number">73</span>a37cfa8c760c3069bd4fb69f9b2a411f556124 <span class="number">172.38</span>.<span class="number">0.11</span>:<span class="number">6379</span>@<span class="number">16379</span> master - <span class="number">0</span> <span class="number">1680661856517</span> <span class="number">1</span> connected <span class="number">0</span>-<span class="number">5460</span></span><br><span class="line">ba2557b0959bed1cc5a446bcd0403721bcb8d002 <span class="number">172.38</span>.<span class="number">0.14</span>:<span class="number">6379</span>@<span class="number">16379</span> myself,master - <span class="number">0</span> <span class="number">1680661855000</span> <span class="number">7</span> connected <span class="number">10923</span>-<span class="number">16383</span></span><br><span class="line"><span class="number">73007</span>d040ed6ca3c093fb5061a3358d1ae47a18a <span class="number">172.38</span>.<span class="number">0.16</span>:<span class="number">6379</span>@<span class="number">16379</span> slave <span class="number">51</span>c02482b19b9ab5dc20ff1852f375ada2f68986 <span class="number">0</span> <span class="number">1680661856016</span> <span class="number">6</span> connected</span><br><span class="line"><span class="number">51</span>c02482b19b9ab5dc20ff1852f375ada2f68986 <span class="number">172.38</span>.<span class="number">0.12</span>:<span class="number">6379</span>@<span class="number">16379</span> master - <span class="number">0</span> <span class="number">1680661855415</span> <span class="number">2</span> connected <span class="number">5461</span>-<span class="number">10922</span></span><br><span class="line"><span class="number">3794</span>de303a95a3718988f3d313f332241b364d7c <span class="number">172.38</span>.<span class="number">0.13</span>:<span class="number">6379</span>@<span class="number">16379</span> master,fail - <span class="number">1680661784244</span> <span class="number">1680661782238</span> <span class="number">3</span> connected</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="springboot-微服务打包docker镜像"><a class="markdownIt-Anchor" href="#springboot-微服务打包docker镜像">#</a> springboot 微服务打包 docker 镜像</h3>
<p>1. 构建 springboot 项目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">创建package controller</span><br><span class="line">创建class HelloControllerpackage com.example.demo.controller;</span><br><span class="line"></span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">public class HelloController &#123;</span><br><span class="line">    @RequestMapping(&quot;/hello&quot;)</span><br><span class="line">    public String hello() &#123;</span><br><span class="line">        return &quot;hello,shabi&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">package com.example.demo.controller;</span><br><span class="line"></span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line">public class HelloController &#123;</span><br><span class="line">    @RequestMapping(&quot;/hello&quot;)</span><br><span class="line">    public String hello() &#123;</span><br><span class="line">        return &quot;hello,shabi&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2. 打包应用</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230405110530946.png" alt="image-20230405110530946"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230405110610159.png" alt="image-20230405110610159"></p>
<p>3. 编写 dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM hzkjhub/java17:17.0.4</span><br><span class="line"></span><br><span class="line">COPY *.jar /app.jar</span><br><span class="line"></span><br><span class="line">CMD [&quot;--server.port=8080&quot;]</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;]</span><br><span class="line">~                                               </span><br></pre></td></tr></table></figure>
<p>4. 构建镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker build -t shabi .</span><br><span class="line">docker run -P -it --name docker333  shabi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl 127.0.0.1:32778/hello</span><br></pre></td></tr></table></figure>
<p>5. 发布运行</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMW9nNHkxcTdNNA==">https://www.bilibili.com/video/BV1og4y1q7M4</span></p>
<h2 id="docker-资源配额"><a class="markdownIt-Anchor" href="#docker-资源配额">#</a> docker 资源配额</h2>
<p>Docker 通过 cgroup 来控制容器使用的资源限制，可以对 docker 限制的资源包括 CPU、内存、磁盘</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">help</span> | grep cpu-shares</span><br><span class="line">  -c, --cpu-shares int                 CPU shares (relative weight)</span><br><span class="line"></span><br><span class="line">CPU shares (relative weight) 在创建容器时指定容器所使用的CPU份额值。cpu-shares的值不能保证可以获得1个vcpu或者多少GHz的CPU资源，仅仅只是一个弹性的加权值。</span><br><span class="line">默认每个docker容器的cpu份额值都是1024。在同一个CPU核心上，同时运行多个容器时，容器的cpu加权的效果才能体现出来。</span><br><span class="line">cgroups只在多个容器同时争抢同一个cpu资源时，cpu配额才会生效。因此，无法单纯根据某个容器的cpu份额来确定有多少cpu资源分配给它，资源分配结果取决于同时运行的其他容器的cpu分配和容器中进程运行情况。</span><br><span class="line"></span><br><span class="line">docker run -it --cpu-shares 512 centos  /bin/bash</span><br><span class="line">[root@df176dd75bd4 /]<span class="comment"># cat /sys/fs/cgroup/cpu/cpu.shares</span></span><br><span class="line">512</span><br><span class="line"></span><br><span class="line">container_A 的 cpu share 1024，是 container_B 的两倍。当两个容器都需要 CPU 资源时，container_A 可以得到的 CPU 是 container_B 的两倍。</span><br><span class="line"></span><br><span class="line">需要注意的是，这种按权重分配 CPU只会发生在 CPU资源紧张的情况下。如果 container_A 处于空闲状态，为了充分利用 CPU资源，container_B 也可以分配到全部可用的 CPU。</span><br><span class="line">docker run --name <span class="string">&quot;container_B&quot;</span> -c 512 ubuntu</span><br></pre></td></tr></table></figure>
<p>对多核 CPU 的服务器，docker 还可以控制容器运行限定使用哪些 cpu 内核和内存节点，即使用–cpuset-cpus 和–cpuset-mems 参数。对具有 NUMA 拓扑（具有多 CPU、多内存节点）的服务器尤其有用，可以对需要高性能计算的容器进行性能最优的配置。如果服务器只有一个内存节点，则–cpuset-mems 的配置基本上不会有明显效果。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --name docker10 --cpuset-cpus 0,1 --cpu-shares 512 centos  /bin/bash </span><br><span class="line">docker run -itd --name docker20 --cpuset-cpus 0,1 --cpu-shares 1024 centos  /bin/bash</span><br><span class="line"></span><br><span class="line">指定docker20只能在cpu0和cpu1上运行，而且docker20的使用cpu的份额1024，比dcker10多一倍</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Docker提供参数-m, --memory=&quot;&quot;限制容器的内存使用量。</span><br><span class="line"></span><br><span class="line">docker run -it  -m 128m centos</span><br><span class="line"></span><br><span class="line">cat /sys/fs/cgroup/memory/memory.limit_in_bytes </span><br><span class="line"></span><br><span class="line">docker run -it --cpuset-cpus 0,1 -m 128m centos </span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--device-write-bps value      Limit write rate (bytes per second) to a device (default [])  </span><br><span class="line"><span class="comment">#限制此设备上的写速度（bytes per second），单位可以是kb、mb或者gb。</span></span><br><span class="line">--device-read-bps value   </span><br><span class="line"><span class="comment">#限制此设备上的读速度（bytes per second），单位可以是kb、mb或者gb。</span></span><br><span class="line"></span><br><span class="line">情景：防止某个 Docker 容器吃光你的磁盘 I / O 资源</span><br><span class="line"></span><br><span class="line">docker run -it  -v /var/www/html/:/var/www/html --device /dev/sda:/dev/sda --device-write-bps /dev/sda:2mb centos  /bin/bash</span><br><span class="line"></span><br><span class="line">time <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sda of=/var/www/html/test.out bs=2M count=50 oflag=direct,nonblock</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --<span class="built_in">rm</span> --name xianchao centos  <span class="built_in">sleep</span> 6</span><br><span class="line">当容器命令运行结束后，自动删除容器，自动释放资源</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">总结：</span><br><span class="line"><span class="comment"># --cpu-shares 指定容器所使用的CPU份额值</span></span><br><span class="line"><span class="comment"># --cpuset-cpus 控制容器运行限定使用哪些cpu内核和内存节点</span></span><br><span class="line"><span class="comment"># --memory 限制容器的内存使用量</span></span><br><span class="line"><span class="comment"># --device-write-bps value 限制此设备上的写速度（bytes per second），单位可以是kb、mb或者gb</span></span><br><span class="line"><span class="comment"># --device-read-bps value #限制此设备上的读速度（bytes per second），单位可以是kb、mb或者gb</span></span><br></pre></td></tr></table></figure>
<h2 id="harbor"><a class="markdownIt-Anchor" href="#harbor">#</a> Harbor</h2>
<p>Harbor 是由 VMware 公司开源的企业级的 Docker Registry 管理项目，它包括权限管理 (RBAC)、LDAP、日志审核、管理界面、自我注册、镜像复制和中文支持等功能。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvaGFyYm9yL2hhcmJvcg==">https://github.com/goharbor/harbor</span></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out ca.key 3072</span><br><span class="line"><span class="comment">#生成一个3072位的key，也就是私钥</span></span><br><span class="line">openssl req -new -x509 -days 3650 -key ca.key -out ca.pem</span><br><span class="line"><span class="comment">#生成一个数字证书ca.pem，3650表示证书的有效时间是3年</span></span><br><span class="line"></span><br><span class="line">生成域名的证书：</span><br><span class="line">openssl genrsa -out harbor.key  3072</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成一个3072位的key，也就是私钥</span></span><br><span class="line">openssl req -new -key harbor.key -out harbor.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 签发证书</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> harbor.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out harbor.pem -days 3650</span><br><span class="line"></span><br><span class="line">yum install -y  wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack </span><br><span class="line"></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line">yum install docker-ce -y</span><br><span class="line"></span><br><span class="line">内核参数修改：br_netfilter模块用于将桥接流量转发至iptables链，br_netfilter内核参数需要开启转发。</span><br><span class="line">[root@ harbor~]<span class="comment"># modprobe br_netfilter</span></span><br><span class="line">[root@ harbor~]<span class="comment"># cat &gt; /etc/sysctl.d/docker.conf &lt;&lt;EOF</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p /etc/sysctl.d/docker.conf</span><br><span class="line"></span><br><span class="line">https://github.com/goharbor/harbor/releases/tag/v2.8.0</span><br><span class="line"></span><br><span class="line">tar xzvf harbor-offline-installer-v2.8.0.tgz </span><br><span class="line"><span class="built_in">cp</span> harbor.yml.tmpl harbor.yml</span><br><span class="line"></span><br><span class="line">vim harbor.yml</span><br><span class="line">hostname: 192.168.13.155</span><br><span class="line"></span><br><span class="line"><span class="comment"># http related config</span></span><br><span class="line">http:</span><br><span class="line">  <span class="comment"># port for http, default is 80. If https enabled, this port will redirect to https port</span></span><br><span class="line">  port: 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># https related config</span></span><br><span class="line">https:</span><br><span class="line">  <span class="comment"># https port for harbor, default is 443</span></span><br><span class="line">  port: 443</span><br><span class="line">  <span class="comment"># The path of cert and key files for nginx</span></span><br><span class="line">  certificate: /data/ssl/harbor.pem</span><br><span class="line">  private_key: /data/ssl/harbor.key</span><br><span class="line"></span><br><span class="line">admin/Harbor12345</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装docker-compose</span></span><br><span class="line"></span><br><span class="line">./prepare</span><br><span class="line">./install.sh </span><br><span class="line">[+] Running 10/10</span><br><span class="line"> ✔ Network harbor_harbor        Created                                           0.2s </span><br><span class="line"> ✔ Container harbor-log         Started                                           0.5s </span><br><span class="line"> ✔ Container registryctl        Started                                           2.0s </span><br><span class="line"> ✔ Container harbor-db          Started                                           2.0s </span><br><span class="line"> ✔ Container harbor-portal      Started                                           1.3s </span><br><span class="line"> ✔ Container registry           Started                                           1.9s </span><br><span class="line"> ✔ Container redis              Started                                           1.9s </span><br><span class="line"> ✔ Container harbor-core        Started                                           2.3s </span><br><span class="line"> ✔ Container nginx              Started                                           3.3s </span><br><span class="line"> ✔ Container harbor-jobservice  Started                                           3.0s </span><br><span class="line">✔ ----Harbor has been installed and started successfully.----</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230423153911479.png" alt="image-20230423153911479"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建项目</span></span><br><span class="line"></span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://fn5y0qpk.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;121.37.191.89&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@master ~]<span class="comment"># systemctl restart docker</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># docker login  121.37.191.89</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">docker tag hello-world:latest  121.37.191.89/test/hello-world:v1</span><br><span class="line">docker push 121.37.191.89/test/hello-world:v1</span><br><span class="line"></span><br><span class="line">docker pull 121.37.191.89/test/hello-world:v1</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230423155448444.png" alt="image-20230423155448444"></p>
<h2 id="docker-compose"><a class="markdownIt-Anchor" href="#docker-compose">#</a> Docker Compose</h2>
<p>高效的管理容器。定义运行多个容器。使用 yaml 配置</p>
<blockquote>
<p>编写 dockerfile 保证我们的项目在任何地方可以运行</p>
<p>定义服务在 docker-compose.yml 中</p>
<p>docker-compose up</p>
</blockquote>
<p>批量容器编排</p>
<p>docker-compose 是 docker 的开源项目，需要安装</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span>  <span class="comment"># optional since v1.27.0</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:5000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/code</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">logvolume01:/var/log</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">logvolume01:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>service 容器，应用</p>
<p>项目 project。一组关联的容器</p>
<h3 id="安装docker-compose"><a class="markdownIt-Anchor" href="#安装docker-compose">#</a> 安装 docker compose</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -SL https://github.com/docker/compose/releases/download/v2.17.2/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">sudo curl -L &quot;https://get.daocloud.io/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">docker-compose -version</span><br><span class="line">docker-compose version 1.29.2, build 5becea4c</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cDovLzEueG4tLWFwcC1xdzJmcTAxaC5weQ==">1. 应用 app.py</span></p>
<p>2.dockerfile 将应用打包为镜像</p>
<p>3.docker-compose yaml 文件 定义整个服务，需要的环境</p>
<p>4. 启动 compose</p>
<p>流程</p>
<p>1. 创建网络</p>
<p>2. 执行 dockercompose.yaml</p>
<p>3. 启动服务</p>
<p>默认的服务名  <code>文件名_服务名_num</code></p>
<p><code>_num</code>  代表副本数量</p>
<p>docker-compose 自动维护一个网络，项目中的内容都在同个网络下，实现域名访问</p>
<p>启动 <code>docker-compose up -d</code></p>
<p>停止 <code>docker-compose down</code>   <code>ctrl+c</code></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230405201151236.png" alt="image-20230405201151236"></p>
<h3 id="yaml"><a class="markdownIt-Anchor" href="#yaml">#</a> yaml</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;&#x27;</span>   <span class="comment"># 版本</span></span><br><span class="line"><span class="attr">services:</span>     <span class="comment"># 服务</span></span><br><span class="line">	<span class="string">服务1：web</span></span><br><span class="line">		<span class="comment"># 服务配置</span></span><br><span class="line">		<span class="string">images</span></span><br><span class="line">		<span class="string">build</span></span><br><span class="line">		<span class="string">network</span></span><br><span class="line">	<span class="string">服务2：redis</span></span><br><span class="line">		<span class="string">...</span>		</span><br><span class="line">		</span><br><span class="line"><span class="comment"># 其他配置 网络，容器卷，全局规则</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">configs:</span></span><br><span class="line">	</span><br><span class="line"><span class="comment"># 三层 - version - service - other</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vY29tcG9zZS9jb21wb3NlLWZpbGUvY29tcG9zZS1maWxlLXYzLyNidWlsZA==">Compose file version 3 reference (docker.com)</span></p>
<h3 id="docker-compose-搭建wordpress"><a class="markdownIt-Anchor" href="#docker-compose-搭建wordpress">#</a> docker-compose 搭建 WordPress</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvY2tlci9hd2Vzb21lLWNvbXBvc2UvYmxvYi9tYXN0ZXIvd29yZHByZXNzLW15c3FsL2NvbXBvc2UueWFtbA==">awesome-compose/compose.yaml at master · docker/awesome-compose (github.com)</span></p>
<p>1. 下载项目 (docker-compose.yml)</p>
<p>2. 如果需要 dockerfile</p>
<p>3. 文件准备齐全，一键启动</p>
<h3 id="实战"><a class="markdownIt-Anchor" href="#实战">#</a> 实战</h3>
<p>1. 编写微服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">views</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;views&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span> + views;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2.dockerfile 构建镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM hzkjhub/java17:17.0.4</span><br><span class="line"></span><br><span class="line">COPY *.jar /app.jar</span><br><span class="line"></span><br><span class="line">CMD [&quot;--server.port=8080&quot;]</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3.docker-compose.yml 编排项目</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">haha</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;redis:alpine3.8&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>4. 服务器 up 启动</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmNoZW5zbWFsbHgudG9wLzIwMjEvMDQvMDgvbmV4dGNsb3VkLW9uLWRvY2tlci8jZG9ja2VyLWNvbXBvc2UlRTklODUlOEQlRTclQkQlQUUlRTYlOTYlODclRTQlQkIlQjY=">使用 docker-compose 搭建 nextcloud+Nginx+MySQL+Redis | Case of Xeon (chensmallx.top)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8yMTA0NTg0">docker-compose 搭建 nginx+php+redis+mysql 环境 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Nzk2MjMwOC9hcnRpY2xlL2RldGFpbHMvMTA5MTY2OTYz">(66 条消息) Docker-compose 部署 nginx+mysql 模板_docker 部署 nginx mysql_仓鼠 小白的博客 - CSDN 博客</span></p>
<h3 id="docker-compose-network"><a class="markdownIt-Anchor" href="#docker-compose-network">#</a> docker-compose network</h3>
<h4 id="类型"><a class="markdownIt-Anchor" href="#类型">#</a> 类型</h4>
<h5 id="default"><a class="markdownIt-Anchor" href="#default">#</a> default</h5>
<p>当我们运行 docker-compose up 时，将会执行以下几步：</p>
<ul>
<li>创建一个名为 myapp_default 的网络；</li>
<li>使用 web 服务的配置创建容器，它以 “web” 这个名称加入网络 myapp_default；</li>
<li>使用 db 服务的配置创建容器，它以 “db” 这个名称加入网络 myapp_default。</li>
</ul>
<p>默认情况下 docker-compose 会建立一个默认的网络，名称为 docker-compose.yml 所在目录名称小写形式加上 “_default”，我们的 TFLinux 环境就是 “tflinux_default”。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]<span class="comment"># cd ngsql/</span></span><br><span class="line">[root@hecs-346515 ngsql]<span class="comment"># ls </span></span><br><span class="line">app  cache  db  docker-compose.yml  proxy</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]<span class="comment"># docker network ls </span></span><br><span class="line">NETWORK ID     NAME                   DRIVER    SCOPE</span><br><span class="line">5ed45bf78d6f   app_default            bridge    <span class="built_in">local</span></span><br><span class="line">2eea384bdd95   bridge                 bridge    <span class="built_in">local</span></span><br><span class="line">73c5128a4cfc   com-nginx_default      bridge    <span class="built_in">local</span></span><br><span class="line">362bcfa74398   composetest_default    bridge    <span class="built_in">local</span></span><br><span class="line">a919986fdc8c   host                   host      <span class="built_in">local</span></span><br><span class="line">a1c8315f1897   my_wordpress_default   bridge    <span class="built_in">local</span></span><br><span class="line">d1e6b687dcd0   ngsql_default          bridge    <span class="built_in">local</span></span><br><span class="line">a0d53da9cf10   none                   null      <span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p>这个默认网络会对所有 services 下面的服务生效，所以 services 下面的各个服务之间才能够通过 service 名称互相访问。</p>
<p>如果要自定义默认网络可以针对 “default” 网络进行设置，这样就会影响导默认网络了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">networks:</span><br><span class="line"></span><br><span class="line">  default:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>
<h5 id="自定义"><a class="markdownIt-Anchor" href="#自定义">#</a> 自定义</h5>
<p>除了默认网络之外，我们也可以建立自定义的网络，这个网络名称就比较随意了。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">networks:</span><br><span class="line"></span><br><span class="line">  persist:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>
<h3 id="已存在网络"><a class="markdownIt-Anchor" href="#已存在网络">#</a> 已存在网络</h3>
<p>通过 docker network create 创建好的网络，而不是让 docker-compose 创建一个新的，这个时候就需要用到 “external” 关键字了。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">networks:</span><br><span class="line"></span><br><span class="line">  persist:</span><br><span class="line">    external:</span><br><span class="line">      name: bridge2</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82ODQ0OTAzOTc2NTM0NTQwMjk2">Docker Compose 网络设置 - 掘金 (juejin.cn)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zODI3NzkxNjA=">docker-compose 的网络 networks 的使用技巧 - 知乎 (zhihu.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmNoZW5zbWFsbHgudG9wLzIwMjEvMDQvMDgvbmV4dGNsb3VkLW9uLWRvY2tlci8jZG9ja2VyLWNvbXBvc2UlRTklODUlOEQlRTclQkQlQUUlRTYlOTYlODclRTQlQkIlQjY=">使用 docker-compose 搭建 nextcloud+Nginx+MySQL+Redis | Case of Xeon (chensmallx.top)</span></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.4&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span> <span class="comment"># 这里只是给每个容器单独配置一个名称</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mariadb</span> <span class="comment"># 具体的镜像名称，可以使用“:”指定镜像的版本</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span> <span class="comment"># 重启的选项，分为no、on-failure、on-failure:x、always、unless-stopped，具体可以自行搜索查看区别</span></span><br><span class="line">    <span class="attr">expose:</span> </span><br><span class="line">    <span class="comment"># expose仅将指定的端口暴露给links的容器，而不对宿主机开放。</span></span><br><span class="line">    <span class="comment"># 和ports的区别在于，ports可以映射宿主机别的端口到容器中。</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="comment"># volumes指的是将宿主机的路径映射到容器中的指定位置</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">./db:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">    <span class="comment"># environment可以对容器创建指定多个环境变量</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=root_password</span> <span class="comment"># 这里配置root密码</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=nextcloud</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_USER=user_name</span> <span class="comment"># 这里配置一个非root账户给nextcloud使用</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=user_password</span> <span class="comment"># 这里配置上面那个账号的密码</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">./cache:/data</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--requirepass</span> <span class="string">&#x27;redis_password&#x27;</span> <span class="comment"># 这里的redis_password换成你要配置的redis密码</span></span><br><span class="line">    <span class="comment"># command指的是启动容器后代替默认启动指令来启动服务的指令</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nextcloud:fpm</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;9000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">./app/html:/var/www/html</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">./app/data:/var/www/html/data</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">./app/config:/var/www/html/config</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">./app/custom_apps:/var/www/html/custom_apps</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">    <span class="comment"># links将容器与当前容器链接起来，以使得当前容器可以访问目标容器expose的端口</span></span><br><span class="line">    <span class="comment"># 格式为 容器的原名:映射到当前容器中的名称</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">db:db</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">cache:cache</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="comment"># 依赖的容器列表，只有这些容器都成功启动了，才会启动当前容器</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">cache</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">proxy:</span> <span class="comment"># 叫做proxy是因为是作为代理来提供服务</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="comment"># ports可将容器内的端口映射到宿主机上</span></span><br><span class="line">    <span class="comment"># 这里是将容器的443端口映射到宿主机的7788端口</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">7788</span><span class="string">:443</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">./app/html:/var/www/html</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">./proxy/conf.d:/etc/nginx/conf.d:ro</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">./proxy/ssl_certs:/etc/nginx/ssl_certs:ro</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">app:app</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">app</span></span><br></pre></td></tr></table></figure>
<h2 id="docker-swarm"><a class="markdownIt-Anchor" href="#docker-swarm">#</a> docker swarm</h2>
<p>集群的方式部署</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/swarm-diagram.png" alt="Swarm mode cluster"></p>
<p>操作都在 manager</p>
<h3 id="搭建集群"><a class="markdownIt-Anchor" href="#搭建集群">#</a> 搭建集群</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">初始化管理节点</span><br><span class="line"></span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# docker swarm init --advertise-addr 172.26.35.5</span><br><span class="line">Swarm initialized: current node (amsigufjp7n6t878um697rtxx) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-378os4pztqynptic0b8kdsgysg21lq6x1u7ru4nxrv99ym9mgc-1hwbeetgvza2ympnj0s9kep3l 172.26.35.5:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">加入节点</span><br><span class="line">docker swarm join</span><br><span class="line"></span><br><span class="line">获取令牌</span><br><span class="line">docker swarm join-token manager</span><br><span class="line">docker swarm join-token worker</span><br><span class="line"></span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# docker node ls </span><br><span class="line">ID                            HOSTNAME                  STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">amsigufjp7n6t878um697rtxx *   iZuf6dzrpxpwleuxiysmvrZ   Ready     Active         Leader           23.0.3</span><br><span class="line">cg0dbg0k739u58yybwwlowr3z     iZuf6dzrpxpwleuxiysmvsZ   Ready     Active                          23.0.3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl stop firewalld </span><br><span class="line">systemctl disable firewalld </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>1. 生成主节点 inti</p>
<p>2. 加入 (manager , worker)</p>
<h3 id="raft"><a class="markdownIt-Anchor" href="#raft">#</a> raft</h3>
<p>保证大多数节点存活才可以用，集群至少 &gt; 3 台主节点，必须保证大多数节点存活才可以使用，&gt;1</p>
<p>双主双从的情况下：</p>
<p>manager 停止一个，另一个 manager 也不能用了</p>
<p>其他 worker 随便离开</p>
<p>work 只是工作，需要在管理节点操作</p>
<p>三主一从</p>
<p>至少有两个主存活集群还能使用</p>
<h3 id="弹性创建服务"><a class="markdownIt-Anchor" href="#弹性创建服务">#</a> 弹性创建服务</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# docker service --help </span><br><span class="line"></span><br><span class="line">Usage:  docker service COMMAND</span><br><span class="line"></span><br><span class="line">Manage Swarm services</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  create      Create a new service</span><br><span class="line">  inspect     Display detailed information on one or more services</span><br><span class="line">  logs        Fetch the logs of a service or task</span><br><span class="line">  ls          List services</span><br><span class="line">  ps          List the tasks of one or more services</span><br><span class="line">  rm          Remove one or more services</span><br><span class="line">  rollback    Revert changes to a service&#x27;s configuration</span><br><span class="line">  scale       Scale one or multiple replicated services</span><br><span class="line">  update      Update a service</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>灰度发布：金丝雀发布   升级不影响使用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker service create -p 8888:80 --name=nginx001  nginx </span></span><br><span class="line">vrs4gx1m5dyydclezt4bbwnkj</span><br><span class="line">overall progress: 1 out of 1 tasks </span><br><span class="line">1/1: running   </span><br><span class="line">verify: Service converged </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="comment">#容器启动，不具有扩缩容</span></span><br><span class="line">docker service <span class="comment">#具有扩缩容，滚动更新</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker service ps nginx001 </span></span><br><span class="line">ID             NAME         IMAGE          NODE                      DESIRED STATE   CURRENT STATE                ERROR     PORTS</span><br><span class="line">2eewg8do04rd   nginx001.1   nginx:latest   iZuf6dzrpxpwleuxiysmvrZ   Running         Running about a minute ago             </span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker service ls </span></span><br><span class="line">ID             NAME       MODE         REPLICAS   IMAGE          PORTS</span><br><span class="line">vrs4gx1m5dyy   nginx001   replicated   1/1        nginx:latest   *:8888-&gt;80/tcp</span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker service create -p 8888:80 --name=nginx001  nginx </span></span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker service update --replicas 3 nginx001 </span></span><br><span class="line"><span class="comment"># 服务，集群中的任意节点都可以被访问，服务可以有多个副本动态扩缩容实现高可用</span></span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker service scale nginx001=5</span></span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker service rm nginx001 </span></span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker service ls</span></span><br></pre></td></tr></table></figure>
<p><strong>swarm</strong></p>
<p>集群的管理和编排，docker 可以初始化一个集群，其他节点可以加入</p>
<p>加入时由 manager 和 worker 角色</p>
<p><strong>node</strong></p>
<p>就是一个 docker 节点，多个节点组成了网络集群</p>
<p><strong>service</strong></p>
<p>任务，可以在管理节点或工作节点运行。用户访问的就是他</p>
<p><strong>task</strong></p>
<p>容器内的命令</p>
<p>命令 -&gt; 管理 -&gt;api -&gt; 调度 -&gt; 工作节点 (创建 task 容器维护)</p>
<p>调整 service 以什么方式运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--mode string </span><br><span class="line"></span><br><span class="line">global server / replicated service </span><br><span class="line"></span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker service create --mode global --name haha centos</span></span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker service create --mode replicated --name haha centos</span></span><br></pre></td></tr></table></figure>
<p>global 能在任何节点运行，replicated 只能在 worker 运行，默认 replicated</p>
 <img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230407140542074.png" alt="image-20230407140542074" style="zoom:50%;" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# yum install bridge-utils.x86_64 </span><br></pre></td></tr></table></figure>
<p>swarm 中有三个网络，ingress，overlay，</p>
<p>ingress：特殊的 overlay，具有负载均衡功能</p>
<h2 id="docker-stack"><a class="markdownIt-Anchor" href="#docker-stack">#</a> Docker Stack</h2>
<p>集群部署项目，相当于集群版的 docker-compose</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker stack deploy 111.yml</span><br><span class="line"></span><br><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class="comment"># docker stack --help</span></span><br><span class="line"></span><br><span class="line">Usage:  docker stack COMMAND</span><br><span class="line"></span><br><span class="line">Manage Swarm stacks</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  config      Outputs the final config file, after doing merges and interpolations</span><br><span class="line">  deploy      Deploy a new stack or update an existing stack</span><br><span class="line">  <span class="built_in">ls</span>          List stacks</span><br><span class="line">  ps          List the tasks <span class="keyword">in</span> the stack</span><br><span class="line">  <span class="built_in">rm</span>          Remove one or more stacks</span><br><span class="line">  services    List the services <span class="keyword">in</span> the stack</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="docker-secret"><a class="markdownIt-Anchor" href="#docker-secret">#</a> docker  secret</h2>
<p>安全，证书，配置密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# docker secret --help </span><br><span class="line"></span><br><span class="line">Usage:  docker secret COMMAND</span><br><span class="line"></span><br><span class="line">Manage Swarm secrets</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  create      Create a secret from a file or STDIN as content</span><br><span class="line">  inspect     Display detailed information on one or more secrets</span><br><span class="line">  ls          List secrets</span><br><span class="line">  rm          Remove one or more secrets</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="docker-config"><a class="markdownIt-Anchor" href="#docker-config">#</a> docker config</h2>
<p>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# docker config --help</span><br><span class="line"></span><br><span class="line">Usage:  docker config COMMAND</span><br><span class="line"></span><br><span class="line">Manage Swarm configs</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  create      Create a config from a file or STDIN</span><br><span class="line">  inspect     Display detailed information on one or more configs</span><br><span class="line">  ls          List configs</span><br><span class="line">  rm          Remove one or more configs</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ctr-crictl"><a class="markdownIt-Anchor" href="#ctr-crictl">#</a> ctr &amp;&amp; crictl</h2>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230626205442159.png" alt="image-20230626205442159"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230626205458946.png" alt="image-20230626205458946"></p>
<p>Containerd 也有 namespaces 的概念，对于上层编排系统的支持，主要区分了 3 个命名空间分别是 <code>k8s.io</code> 、 <code>moby</code>  和 <code>default</code> ，以上我们用 crictl 操作的均在 k8s.io 命名空间完成如查看镜像列表就需要加上 <code>-n</code>  参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctr -n k8s.io images list</span><br></pre></td></tr></table></figure>

      <div class="tags">
          <a href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag"><i class="ic i-tag"></i> 运维</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-01-02 22:55:33" itemprop="dateModified" datetime="2024-01-02T22:55:33+08:00">2024-01-02</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2023/04/05/Docker/" title="docker">http://example.com/2023/04/05/Docker/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/04/03/iptables2/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;c50475797549951523025a46bab169bb.jpg" title="iptables">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> 运维</span>
  <h3>iptables</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/04/07/TCPIP_new/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;2e0802e6e5cfd05c700bc3f911f9351c.jpg" title="TCP&#x2F;IP">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>TCP/IP</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#docker"><span class="toc-number">1.</span> <span class="toc-text"> Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text"> docker 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E8%B0%83%E4%BC%98"><span class="toc-number">1.2.</span> <span class="toc-text"> 内核参数调优</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F"><span class="toc-number">1.3.</span> <span class="toc-text"> 镜像加速</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-run%E4%B9%8B%E5%90%8E%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-number">1.4.</span> <span class="toc-text"> docker run 之后发生了什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E5%91%BD%E4%BB%A4"><span class="toc-number">1.5.</span> <span class="toc-text"> docker 命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%91%BD%E4%BB%A4"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 镜像命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.5.2.</span> <span class="toc-text"> 容器命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8docker"><span class="toc-number">1.6.</span> <span class="toc-text"> 使用 docker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85nginx"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 安装 nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85tomcat"><span class="toc-number">1.6.2.</span> <span class="toc-text"> 安装 tomcat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85eskibana"><span class="toc-number">1.6.3.</span> <span class="toc-text"> 安装 es+kibana</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number">1.7.</span> <span class="toc-text"> 可视化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%94%E5%90%88%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.8.</span> <span class="toc-text"> 联合文件系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-number">1.9.</span> <span class="toc-text"> 分层原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#commit"><span class="toc-number">1.10.</span> <span class="toc-text"> commit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">1.11.</span> <span class="toc-text"> 容器数据卷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dockerfile%E6%8C%82%E8%BD%BD"><span class="toc-number">1.12.</span> <span class="toc-text"> Dockerfile 挂载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8"><span class="toc-number">1.13.</span> <span class="toc-text"> 数据卷容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#docker%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%A4%87%E4%BB%BD%E4%B8%8E%E8%BF%98%E5%8E%9F"><span class="toc-number">1.13.1.</span> <span class="toc-text"> docker 数据卷备份与还原</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dockerfile"><span class="toc-number">1.14.</span> <span class="toc-text"> Dockerfile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dockerfile%E6%8C%87%E4%BB%A4"><span class="toc-number">1.14.1.</span> <span class="toc-text"> dockerfile 指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B6%E4%BD%9Cnginx%E9%95%9C%E5%83%8F"><span class="toc-number">1.14.2.</span> <span class="toc-text"> 制作 nginx 镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B6%E4%BD%9Ctomcat%E9%95%9C%E5%83%8F"><span class="toc-number">1.14.3.</span> <span class="toc-text"> 制作 tomcat 镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E4%BB%A3%E7%A0%81dockerfile%E5%81%9A%E6%88%90%E9%95%9C%E5%83%8F"><span class="toc-number">1.14.4.</span> <span class="toc-text"> go 代码 dockerfile 做成镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python-dockerfile%E6%9E%84%E5%BB%BA"><span class="toc-number">1.14.5.</span> <span class="toc-text"> python dockerfile 构建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E9%95%9C%E5%83%8F"><span class="toc-number">1.15.</span> <span class="toc-text"> 发布镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-%E7%BD%91%E7%BB%9C"><span class="toc-number">1.16.</span> <span class="toc-text"> Docker 网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#link"><span class="toc-number">1.16.1.</span> <span class="toc-text"> –link</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C"><span class="toc-number">1.16.2.</span> <span class="toc-text"> 自定义网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%BF%9E%E9%80%9A"><span class="toc-number">1.16.3.</span> <span class="toc-text"> 网络连通</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E9%9B%86%E7%BE%A4"><span class="toc-number">1.16.4.</span> <span class="toc-text"> Redis 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#springboot-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%89%93%E5%8C%85docker%E9%95%9C%E5%83%8F"><span class="toc-number">1.16.5.</span> <span class="toc-text"> springboot 微服务打包 docker 镜像</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D"><span class="toc-number">1.17.</span> <span class="toc-text"> docker 资源配额</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#harbor"><span class="toc-number">1.18.</span> <span class="toc-text"> Harbor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-compose"><span class="toc-number">1.19.</span> <span class="toc-text"> Docker Compose</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker-compose"><span class="toc-number">1.19.1.</span> <span class="toc-text"> 安装 docker compose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yaml"><span class="toc-number">1.19.2.</span> <span class="toc-text"> yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-compose-%E6%90%AD%E5%BB%BAwordpress"><span class="toc-number">1.19.3.</span> <span class="toc-text"> docker-compose 搭建 WordPress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">1.19.4.</span> <span class="toc-text"> 实战</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-compose-network"><span class="toc-number">1.19.5.</span> <span class="toc-text"> docker-compose network</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.19.5.1.</span> <span class="toc-text"> 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#default"><span class="toc-number">1.19.5.1.1.</span> <span class="toc-text"> default</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-number">1.19.5.1.2.</span> <span class="toc-text"> 自定义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%B2%E5%AD%98%E5%9C%A8%E7%BD%91%E7%BB%9C"><span class="toc-number">1.19.6.</span> <span class="toc-text"> 已存在网络</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-swarm"><span class="toc-number">1.20.</span> <span class="toc-text"> docker swarm</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="toc-number">1.20.1.</span> <span class="toc-text"> 搭建集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#raft"><span class="toc-number">1.20.2.</span> <span class="toc-text"> raft</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%B9%E6%80%A7%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.20.3.</span> <span class="toc-text"> 弹性创建服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-stack"><span class="toc-number">1.21.</span> <span class="toc-text"> Docker Stack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-secret"><span class="toc-number">1.22.</span> <span class="toc-text"> docker  secret</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-config"><span class="toc-number">1.23.</span> <span class="toc-text"> docker config</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ctr-crictl"><span class="toc-number">1.24.</span> <span class="toc-text"> ctr &amp;&amp; crictl</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/11/27/CDN/" rel="bookmark" title="CDN&DNS">CDN&DNS</a></li><li><a href="/2023/04/03/iptables2/" rel="bookmark" title="iptables">iptables</a></li><li class="active"><a href="/2023/04/05/Docker/" rel="bookmark" title="docker">docker</a></li><li><a href="/2023/04/15/Nginx_new/" rel="bookmark" title="Nginx">Nginx</a></li><li><a href="/2023/05/20/Kubernetes/" rel="bookmark" title="Kubernetes">Kubernetes</a></li><li><a href="/2023/05/30/jenkins/" rel="bookmark" title="Jenkins">Jenkins</a></li><li><a href="/2023/06/02/k8s%E9%AB%98%E7%BA%A7/" rel="bookmark" title="k8s高级">k8s高级</a></li><li><a href="/2024/01/01/istio/" rel="bookmark" title="istio">istio</a></li><li><a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" rel="bookmark" title="集群与存储">集群与存储</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">42</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">6</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">6</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/04/03/iptables2/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/04/07/TCPIP_new/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/06/02/k8s%E9%AB%98%E7%BA%A7/" title="k8s高级">k8s高级</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/12/27/SSTI/" title="SSTI">SSTI</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/03/27/http/" title="http">http</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/10/03/hg%20ker/" title="hg内核">hg内核</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%A7%8B%E6%8B%9B/" title="In 秋招">秋招</a>
</div>

    <span><a href="/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/" title="秋招面试题">秋招面试题</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%BD%91%E7%BB%9C/" title="In 网络">网络</a>
</div>

    <span><a href="/2023/09/01/border%20leaf/" title="从三层架构到spine leaf">从三层架构到spine leaf</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/06/27/SSRF/" title="SSRF">SSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/04/07/TCPIP_new/" title="TCP&#x2F;IP">TCP/IP</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/01/%E6%B1%87%E7%BC%96/" title="汇编">汇编</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/" title="水滴rev">水滴rev</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/04/05/Docker/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
