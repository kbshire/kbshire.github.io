



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="http://example.com/2023/04/01/Nginx/">



  <title>
Nginx |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Nginx
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2023-04-01 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2023-04-01T13:38:45+08:00">2023-04-01</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gicit4jrvuj20zk0m8785.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gicliwyw55j20zk0m8hdt.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclx6phq6j20zk0m8e36.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclhnx9glj20zk0m8npd.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclh3brzpj20zk0m8ann.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giciszlczyj20zk0m816d.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/01/Nginx/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="nginx"><a class="markdownIt-Anchor" href="#nginx">#</a> Nginx</h1>
<h2 id="安装启动nginx"><a class="markdownIt-Anchor" href="#安装启动nginx">#</a> 安装启动 nginx</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install -y zlib zlib-devel </span><br><span class="line">yum install pcre pcre-devel -y</span><br><span class="line">yum install gcc -y</span><br><span class="line">./configure --prefix=/usr/local/nginx</span><br><span class="line">make</span><br><span class="line">make install </span><br><span class="line">systemctl disable firewall.service</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./nginx </span><br><span class="line">./nginx -s stop   快速停止</span><br><span class="line">./nginx -s quit  优雅关闭,退出前完成已接收的连接请求</span><br><span class="line">./nginx -s reload 重新加载配置</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//将nginx变为系统服务</span><br><span class="line">vim /usr/lib/systemd/system/nginx.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx - web server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/usr/local/nginx/logs/nginx.pid</span><br><span class="line">ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">ExecStop=/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">ExecQuit=/usr/local/nginx/sbin/nginx -s quit</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart/enable nginx </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="nginx-目录结构"><a class="markdownIt-Anchor" href="#nginx-目录结构">#</a> nginx 目录结构</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">conf nginx的主配置文件</span><br><span class="line">html 默认网页和资源</span><br><span class="line">sbin nginx的主进程文件</span><br><span class="line">log 日志，nginx.pid 记录nginx的当前PID</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230321212259838.png" alt="image-20230321212259838"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">	#通过端口号区分虚拟主机</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    proxy_pass   http://127.0.0.1;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    root           html;</span><br><span class="line">        #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        #    fastcgi_index  index.php;</span><br><span class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">        #    include        fastcgi_params;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">        # concurs with nginx&#x27;s one</span><br><span class="line">        #</span><br><span class="line">        #location ~ /\.ht &#123;</span><br><span class="line">        #    deny  all;</span><br><span class="line">        #&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # another virtual host using mix of IP-, name-, and port-based configuration</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       8000;</span><br><span class="line">    #    listen       somename:8080;</span><br><span class="line">    #    server_name  somename  alias  another.alias;</span><br><span class="line"></span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # HTTPS server</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       443 ssl;</span><br><span class="line">    #    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #    ssl_certificate      cert.pem;</span><br><span class="line">    #    ssl_certificate_key  cert.key;</span><br><span class="line"></span><br><span class="line">    #    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    #    ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">    #    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    #    ssl_prefer_server_ciphers  on;</span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>sendfile</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230321220251447.png" alt="image-20230321220251447"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230321214426306.png" alt="image-20230321214426306"></p>
<h2 id="配置nginx虚拟主机"><a class="markdownIt-Anchor" href="#配置nginx虚拟主机">#</a> 配置 nginx 虚拟主机</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen       80;</span><br><span class="line">       server_name  localhost;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">           root   html;</span><br><span class="line">           index  index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">       error_page   500 502 503 504  /50x.html;</span><br><span class="line">       location = /50x.html &#123;</span><br><span class="line">           root   html;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">server &#123;</span><br><span class="line">       listen       88;</span><br><span class="line">       server_name  a.com;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">           root   /www/wwwroot;</span><br><span class="line">           index  index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">       error_page   500 502 503 504  /50x.html;</span><br><span class="line">       location = /50x.html &#123;</span><br><span class="line">           root   html;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>配置虚拟主机可以基于端口号也可以基于子域名</p>
<h2 id="servername匹配规则"><a class="markdownIt-Anchor" href="#servername匹配规则">#</a> servername 匹配规则</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen       88;</span><br><span class="line">       server_name  a.com b.com;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">           root   /www/wwwroot;</span><br><span class="line">           index  index.html index.htm; # server中配置多个主机名</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">       error_page   500 502 503 504  /50x.html;</span><br><span class="line">       location = /50x.html &#123;</span><br><span class="line">           root   html;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>如果所有 server 都没匹配上会匹配第一个，从上往下匹配，一经匹配，不在往下匹配</p>
<h2 id="多用户二级域名短网址httpdns"><a class="markdownIt-Anchor" href="#多用户二级域名短网址httpdns">#</a> 多用户二级域名，短网址，httpdns</h2>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230322144507008.png" alt="image-20230322144507008"></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L2h0dHBkbnM=">移动解析 HttpDNS_移动互联网域名解析_域名防劫持 - 腾讯云 (tencent.com)</span></p>
<h2 id="反向代理"><a class="markdownIt-Anchor" href="#反向代理">#</a> 反向代理</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen       88;</span><br><span class="line">       server_name  a.com b.com;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">       	proxy_pass http://a.com   # 反向代理</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">       error_page   500 502 503 504  /50x.html;</span><br><span class="line">       location = /50x.html &#123;</span><br><span class="line">           root   html;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>proxy_pass 和 root 不能同时存在</p>
<p>不支持 https</p>
<h2 id="负载均衡"><a class="markdownIt-Anchor" href="#负载均衡">#</a> 负载均衡</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    </span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">    </span><br><span class="line">    upstream httpds &#123;</span><br><span class="line">    	server 192.168.44.102:80 weight=8 down;</span><br><span class="line">    	server 192.168.44.103:80 weight=2;</span><br><span class="line">    	server 192.168.44.104:80 weight=2 backup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	#通过端口号区分虚拟主机</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">          	proxy_pass http://httpds;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>weight</p>
<p>轮询的时候权重</p>
<p>down</p>
<p>代表不参与负载均衡</p>
<p>backup</p>
<p>代表备份，正常情况下不会负载均衡到这台机器</p>
<p>ip_hash</p>
<p>根据客户端 IP 来尝试保持会话</p>
<p>least_conn</p>
<p>最少连接访问</p>
<p>fair</p>
<p>根据响应时间转发请求</p>
<p>url_hash</p>
<p>完成定向流量转发，相同的 url 转到相同的流量，适用于访问固定资源不在同一服务器</p>
<h2 id="动静分离"><a class="markdownIt-Anchor" href="#动静分离">#</a> 动静分离</h2>
<p>将 img，css，js 放到 nginx 中，后端只处理动态请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    </span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">    </span><br><span class="line">    upstream httpds &#123;</span><br><span class="line">    	server 192.168.44.102:80 weight=8 down;</span><br><span class="line">    	server 192.168.44.103:80 weight=2;</span><br><span class="line">    	server 192.168.44.104:80 weight=2 backup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	#通过端口号区分虚拟主机</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">          	proxy_pass http://192.168.44.104:8080;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location /css &#123;</span><br><span class="line">          	root   html;</span><br><span class="line">            index  index.html index.htm; # server中配置多个主机名</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location /js &#123;</span><br><span class="line">          	root   html;</span><br><span class="line">            index  index.html index.htm; # server中配置多个主机名</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location /img &#123;</span><br><span class="line">          	root   html;</span><br><span class="line">            index  index.html index.htm; # server中配置多个主机名</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>/ 的优先级最低</p>
<p>正则匹配</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen       80;</span><br><span class="line">       server_name  localhost;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">       location ~*/(js|img|css) &#123;</span><br><span class="line">         	proxy_pass http://192.168.44.104:8080;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">       # redirect server error pages to the static page /50x.html</span><br><span class="line">       #</span><br><span class="line">       error_page   500 502 503 504  /50x.html;</span><br><span class="line">       location = /50x.html &#123;</span><br><span class="line">           root   html;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>一定记得在 html 文件夹中创建 img 文件夹时给足权限，不然会报 403</p>
<p>一定要关 firewalld 和 selinux</p>
<h2 id="urlrewrite"><a class="markdownIt-Anchor" href="#urlrewrite">#</a> urlrewrite</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    String pageNum = request.getParameter(&quot;pageNum&quot;);</span><br><span class="line">    out.println(&quot;this is&quot; + pageNum);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen       80;</span><br><span class="line">       server_name  localhost;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">       	rewrite ^/([0-9]+).html$ /index.jsp?pageNum=$1 break;</span><br><span class="line">		proxy_pass http://192.168.13.155:8080;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">       error_page   500 502 503 504  /50x.html;</span><br><span class="line">       location = /50x.html &#123;</span><br><span class="line">           root   html;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>last    本条规则匹配完成后，继续向下匹配新的 1ocation URI 规则</p>
<p>break     本条规则匹配完成即终止，不再匹配后面的任何规则</p>
<p>redirect    返回 302 临时重定向，浏览器地址会显示跳转后的 URL 地址</p>
<p>permanent   返回 301 永久重定向，浏览器地址栏会显示跳转后的 URL 地址</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230323154600702.png" alt="image-20230323154600702" style="zoom: 67%;" /> 
<h2 id="伪静态同时负载均衡"><a class="markdownIt-Anchor" href="#伪静态同时负载均衡">#</a> 伪静态同时负载均衡</h2>
<p>添加防火墙富规则，使外网不在能访问 tomcat 服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart firewalld.service </span><br><span class="line">firewall-cmd --permanent --add-rich-rule=&quot;rule family=&quot;ipv4&quot; source address=&quot;192.168.13.155&quot; port protocol=&quot;tcp&quot; port=&quot;8080&quot; accept&quot;</span><br><span class="line">systemctl restart firewalld.service </span><br><span class="line">firewall-cmd --list-all</span><br><span class="line">移除: remove-rich-rule</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">	upstream httpds &#123;</span><br><span class="line">    	server 192.168.13.166:80 weight=8 down;  # 负载均衡</span><br><span class="line">    	server 192.168.13.132:8080 weight=8;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	#通过端口号区分虚拟主机</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        	rewrite ^/([0-9]+).html$ /index.jsp?pageNum=$1 break;  #urlwrite</span><br><span class="line">          	proxy_pass http://httpds;   #反向代理</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        #动静分离</span><br><span class="line">        location /css &#123;</span><br><span class="line">          	root   html;</span><br><span class="line">            index  index.html index.htm; </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location /js &#123;</span><br><span class="line">          	root   html;</span><br><span class="line">            index  index.html index.htm; </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location /img &#123;</span><br><span class="line">          	root   html;</span><br><span class="line">            index  index.html index.htm; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过上面的配置，我们实现了 proxy_pass，urlrewrite，动静分离，反向代理</p>
<p>此时的 nginx 我们可以称为<strong>网关服务器</strong></p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230323200225468.png" alt="image-20230323200225468" style="zoom: 67%;" /> 
<h2 id="防盗链"><a class="markdownIt-Anchor" href="#防盗链">#</a> 防盗链</h2>
<p>在二次请求时会在请求头中加入 referer，第一次访问时是没有的</p>
<p>referer 不是本站点则判断为盗链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过proxy_pass 来模拟请求</span><br></pre></td></tr></table></figure>
<p>在 location 下配置，那个 location 不让访问就在哪配</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location ~*/(js|img|css) &#123;</span><br><span class="line">    valid_referers none 192.168.13.132;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        return 403;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm; </span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>指定在盗链时返回页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">location ~*/(js|img|css) &#123;</span><br><span class="line">    valid_referers none 192.168.13.132;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        return 401;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_page  401  /401.html;</span><br><span class="line">    location = /401.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>none，检测 Referer 头域不存在可以访问。</p>
<p>blocked，检测 Referer 头域的值被防火墙或者代理服务器删除或伪装的情况。这种情况该头域的不以 &quot;http:/&quot; 或 “https://” 开头。</p>
<p>server_names，设置一个或多个 URL，检测 Referer 头域的值是否是这些 URL 中的某一个。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl测试防盗链</span><br><span class="line">curl -I 只返回响应头信息</span><br><span class="line">curl -e &quot;referer&quot; -I &quot;URL&quot;</span><br></pre></td></tr></table></figure>
<p>通过 rewrite 返回报错图片</p>
<p>先写 401.html，这个 html 是盗链触发后显示的内容，但需要新页面打开</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">location /img &#123;</span><br><span class="line">    valid_referers none 192.168.13.132;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        return 401;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">error_page  401  /401.html;</span><br><span class="line">    location = /401.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">location /img &#123;</span><br><span class="line">    valid_referers none 192.168.13.132;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        rewrite ^/ /img/x.png break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">error_page  401  /401.html;</span><br><span class="line">    location = /401.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>实验 1：配置一台用于盗链的 nginx 服务器 166，合法的 nginx 132，tomcat 服务器 155</p>
<p>166-nginx.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;  # 域名或主机名</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">          	proxy_pass http://192.168.13.132;  </span><br><span class="line">          	root html;</span><br><span class="line">          	index index.html index.htm;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>132-nginx.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                rewrite ^/([0-9]+).html$ /index.jsp?pageNum=$1 break;</span><br><span class="line">                proxy_pass http://httpds;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~*/(js|img|css) &#123;</span><br><span class="line">            valid_referers 192.168.13.132;</span><br><span class="line">            if ($invalid_referer) &#123;</span><br><span class="line">                #rewrite ^/ /img/x.png break;</span><br><span class="line">                return 401;</span><br><span class="line">        &#125;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 401 /401.html;</span><br><span class="line">        location = /401.html &#123;</span><br><span class="line">                root html;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>在手搓一个 401.html 放在 html 下，效果：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230324151847913.png" alt="image-20230324151847913"></p>
<p>右键打开图片链接后显示的就是我们的 401.html 了</p>
<p>实验二：如果盗链返回图片</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">upstream httpds &#123;</span><br><span class="line">        server 192.168.13.155:8080 weight=4;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                rewrite ^/([0-9]+).html$ /index.jsp?pageNum=$1 break;</span><br><span class="line">                proxy_pass http://httpds;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~*/(js|img|css) &#123;</span><br><span class="line">            valid_referers 192.168.13.132;</span><br><span class="line">            if ($invalid_referer) &#123;</span><br><span class="line">                rewrite ^/ /img/x.png break;</span><br><span class="line">        &#125;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230324152426783.png" alt="image-20230324152426783"></p>
<p>哈哈哈就是 x.png</p>
<h2 id="高可用"><a class="markdownIt-Anchor" href="#高可用">#</a> 高可用</h2>
<p>通过 keepalive 实现</p>
<p>安装 keepalived</p>
<p><code>yum install keepalived</code></p>
<p>/etc/keepalived/keepalived.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens160</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.13.250</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL_BACK_UP</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;    #instance和router_id用于判断是否是一组的</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.13.250</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230324160133028.png" alt="image-20230324160133028"></p>
<p>可以通过脚本监听 nginx 服务器是否存活，一旦 nginx 不可访问，那么 kill keepalived，使 vip 漂移</p>
<h2 id="扩容"><a class="markdownIt-Anchor" href="#扩容">#</a> 扩容</h2>
<p>单机扩容：硬件资源增加</p>
<p>水平扩展：集群化</p>
<p>细粒度拆分：分布式</p>
<p>​	数据分区</p>
<p>​	上游服务 SOA 化</p>
<p>​	入口细分：</p>
<p>数据异构化</p>
<p>​	多级缓存</p>
<p>服务异步化</p>
<p>​	拆分请求</p>
<p>​</p>
<h3 id="单机垂直扩容"><a class="markdownIt-Anchor" href="#单机垂直扩容">#</a> 单机垂直扩容</h3>
<blockquote>
<p>云服务资源增加</p>
<p>・整机：IBM、浪潮、DELL、HP 等</p>
<p>・CPU / 主板：更新到主流</p>
<p>・网卡：10G/40G 网卡</p>
<p>・磁盘：SAS (SCSI) HDD（机械）、HHD（混合）、SATA SSD、PCI-e SSD、</p>
<p>MVMe SSD</p>
<p>• SSD</p>
<p>・多副本机制</p>
<p>・系统盘 / 热点数据 / 数据库存储</p>
<p>• HDD</p>
<p>・冷数据存储</p>
</blockquote>
<h3 id="水平扩展"><a class="markdownIt-Anchor" href="#水平扩展">#</a> 水平扩展</h3>
<p>会话管理</p>
<p>・Nginx 高级负载均衡</p>
<p>• ip_hash</p>
<p>・其他 Hash</p>
<p>• hash $cookie_jsessionid;</p>
<p>• hash $request_uri;</p>
<p>・使用 lua 逻辑定向分发</p>
<p>• Redis + SpringSession</p>
<p>ip_hash 先 hash，再和后端服务器的数量取余，得到的值就是需要转发到后端的服务器。不适用于局域网项目，即多用户共享 IP 的场景。容易造成流量倾斜。后端服务器宕机导致 session 丢失。适用于中小型项目，快速扩容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">upstream httpds &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server 192.168.13.155;</span><br><span class="line">    server 192.168.13.166;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">            proxy_pass http://httpds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>request_uri</p>
<p>适用于不支持 cookie 的情况下./ 后是 uri</p>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5hLmNvbS9pbmRleC5qc3A/bnVtPTEmYW1wO3Nlc3Npb25pZD0xMjM0NTY1NzY3">www.a.com/index.jsp?num=1&amp;sessionid=1234565767</span></p>
<p>资源不平均分配：只需要算出 hash 将资源放到对应的服务器 -</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">upstream httpds &#123;</span><br><span class="line">    hash $request_uri;</span><br><span class="line">    server 192.168.13.155;</span><br><span class="line">    server 192.168.13.166;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">            proxy_pass http://httpds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>$cookie_jsessionid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">upstream httpds &#123;</span><br><span class="line">      hash $cookie_jsessionid;</span><br><span class="line">      server 192.168.13.155:8080;</span><br><span class="line">      server 192.168.13.166:8080;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">      listen       80;</span><br><span class="line">      server_name  localhost;</span><br><span class="line"></span><br><span class="line">      #charset koi8-r;</span><br><span class="line"></span><br><span class="line">      #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">      location / &#123;</span><br><span class="line">              proxy_pass http://httpds;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>jsessionid 只有 tomcat 才有，并且 hash 的是 value</p>
<h3 id="水平扩展集群化"><a class="markdownIt-Anchor" href="#水平扩展集群化">#</a> 水平扩展：集群化</h3>
<p>安装 sticky</p>
<p>sticky 是第三方模块，需要重新编译 Nginx, 他可以对 Nginx 这种静态文件服务器使用基于 cookie 的负载均衡</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9iaXRidWNrZXQub3JnL25naW54LWdvb2RpZXMvbmdpbngtc3RpY2t5LW1vZHVsZS1uZy9zcmMvbWFzdGVyLw==">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/src/master/</span></p>
<p>依赖 <code>openssl-devel</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx --add-module=/root/nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d</span><br></pre></td></tr></table></figure>
<p>打开  <code>ngx_http_sticky_misc.c</code>  文件</p>
<p>在 12 行添加</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/sha.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/md5.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>备份之前的程序</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br></pre></td></tr></table></figure>
<p><strong>把编译好的 Nginx 程序替换到原来的目录里</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>
<p><strong>升级检测</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make upgrade</span><br></pre></td></tr></table></figure>
<p>检查程序中是否包含新模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">upstream httpds &#123;</span><br><span class="line">       sticky name=shabi expires=6h;</span><br><span class="line">       server 192.168.13.155:8080;</span><br><span class="line">       server 192.168.13.166:8080;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   server &#123;</span><br><span class="line">       listen       80;</span><br><span class="line">       server_name  localhost;</span><br><span class="line"></span><br><span class="line">       #charset koi8-r;</span><br><span class="line"></span><br><span class="line">       #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">               proxy_pass http://httpds;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">      location ~*/(js|img|css) &#123;</span><br><span class="line">               root   /usr/local/nginx/html;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>浏览器多标签会共享 cookie，且名字不好和 JESEEIONID 重复</p>
<p>原理是在 cookie 中加入一个字段，从会话保持，也能维持静态会话</p>
<h2 id="keepalive"><a class="markdownIt-Anchor" href="#keepalive">#</a> keepalive</h2>
<p>需要持续获取请求，通过 http 连接，则开启 keepalive</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout  65;</span><br></pre></td></tr></table></figure>
<p>活跃时间，一旦活跃就会被重置</p>
<p>请求很多但来自不同客户端，就没有必要开启 keepalive，比如时间服务器</p>
<p>=0 关闭 keepalive，connection: close 服务器没有启动 keepalive</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230326145512655.png" alt="image-20230326145512655"></p>
<p>如果一个 connections 中有多个 transactions，那么说明这些 transactions 是复用了这个 connections</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">keepalive_disable  禁用某些浏览器的keepalive</span><br><span class="line">keepalive_requests  当前一个链接可以发起多少并发请求</span><br><span class="line">send_timeout  两次向客户端写操作的间隔，超过timeout强制断开连接</span><br><span class="line">keepalive_timeout   </span><br><span class="line">一般 keepalive_timeout &gt; send_timeout </span><br><span class="line">keeplive_time  keepalive保持时间</span><br><span class="line"></span><br><span class="line">配置两个keepalive时会有两个keepalive</span><br></pre></td></tr></table></figure>
<p>对上游服务器使用 keepaliv</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">up_stream中配置</span><br><span class="line">keepalive 100;</span><br><span class="line">向上游服务器的保留连接数</span><br><span class="line">keepalive_timeout</span><br><span class="line">连接保留时间</span><br><span class="line">keepalive_requests</span><br><span class="line">一个tcp复用中可以并发接收的请求个数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server 配置</span><br><span class="line">proxy_http_version 1.1;配置http版本号</span><br><span class="line">默认使用http1.0协议，需要在request中增加&quot;connection: keep-alive&quot;header才能够支持，而HTTP1.1默认支持。</span><br><span class="line">proxy_set_header coniection &quot;&quot;;</span><br><span class="line">清除close信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> 	#keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65 66;</span><br><span class="line">    keepalive_time 1h;</span><br><span class="line">    send_timeout 60;</span><br><span class="line">    keepalive_requests 1000;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    upstream httpds &#123;</span><br><span class="line">        keepalive 100;</span><br><span class="line">        keepalive_requests 1000;</span><br><span class="line">        keepalive_timeout 65;</span><br><span class="line">        #sticky name=shabi expires=6h;</span><br><span class="line">        server 192.168.13.155:8080;</span><br><span class="line">        server 192.168.13.166:8080;</span><br><span class="line">    &#125;</span><br><span class="line"> 	server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_http_version 1.1;</span><br><span class="line">                proxy_set_header Connection &quot;&quot;;</span><br><span class="line">                proxy_pass http://httpds;</span><br><span class="line">        &#125;</span><br><span class="line">nginx在代理转发到后端服务器时会清除大部分header头部，所以为了启用keepalive需要重新设置</span><br></pre></td></tr></table></figure>
<p>AB test</p>
<p>yum install httpd-tools</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">➜  ROOT ab -n 10000 -c 30 http://192.168.13.132/</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 1843412 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 192.168.13.132 (be patient)</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 6000 requests</span><br><span class="line">Completed 7000 requests</span><br><span class="line">Completed 8000 requests</span><br><span class="line">Completed 9000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx/1.22.1</span><br><span class="line">Server Hostname:        192.168.13.132</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        11164 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   18.629 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        5000</span><br><span class="line">   (Connect: 0, Receive: 0, Length: 5000, Exceptions: 0)</span><br><span class="line">Total transferred:      112985000 bytes</span><br><span class="line">HTML transferred:       111645000 bytes</span><br><span class="line">Requests per second:    536.80 [#/sec] (mean)   qps</span><br><span class="line">Time per request:       55.887 [ms] (mean)</span><br><span class="line">Time per request:       1.863 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          5922.87 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    6   9.7      3     110</span><br><span class="line">Processing:     2   49  48.8     36     645</span><br><span class="line">Waiting:        2   46  46.4     34     645</span><br><span class="line">Total:          3   56  51.4     40     649</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%     40</span><br><span class="line">  66%     51</span><br><span class="line">  75%     61</span><br><span class="line">  80%     69</span><br><span class="line">  90%    102</span><br><span class="line">  95%    144</span><br><span class="line">  98%    211</span><br><span class="line">  99%    292</span><br><span class="line"> 100%    649 (longest request)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Server Software:        nginx/1.22.1</span><br><span class="line">Server Hostname:        192.168.13.166</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        640 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   2.784 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Total transferred:      8730000 bytes</span><br><span class="line">HTML transferred:       6400000 bytes</span><br><span class="line">Requests per second:    3592.23 [#/sec] (mean)</span><br><span class="line">Time per request:       8.351 [ms] (mean)</span><br><span class="line">Time per request:       0.278 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          3062.52 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    2   1.4      2      14</span><br><span class="line">Processing:     1    6   2.3      6      63</span><br><span class="line">Waiting:        1    6   2.2      5      59</span><br><span class="line">Total:          3    8   2.6      7      65</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%      7</span><br><span class="line">  66%      8</span><br><span class="line">  75%      9</span><br><span class="line">  80%     10</span><br><span class="line">  90%     12</span><br><span class="line">  95%     13</span><br><span class="line">  98%     15</span><br><span class="line">  99%     17</span><br><span class="line"> 100%     65 (longest request)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Server Software:        </span><br><span class="line">Server Hostname:        192.168.13.166</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        11164 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   7.672 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Total transferred:      112760000 bytes</span><br><span class="line">HTML transferred:       111640000 bytes</span><br><span class="line">Requests per second:    1303.38 [#/sec] (mean)</span><br><span class="line">Time per request:       23.017 [ms] (mean)</span><br><span class="line">Time per request:       0.767 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          14352.46 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        1    6   5.7      5     102</span><br><span class="line">Processing:     2   16  10.2     14     110</span><br><span class="line">Waiting:        1   10   7.9      8     104</span><br><span class="line">Total:          5   23  12.9     20     152</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%     20</span><br><span class="line">  66%     23</span><br><span class="line">  75%     27</span><br><span class="line">  80%     29</span><br><span class="line">  90%     35</span><br><span class="line">  95%     44</span><br><span class="line">  98%     56</span><br><span class="line">  99%     69</span><br><span class="line"> 100%    152 (longest request)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>客户端不支持 keepalive 在 tomcat 前加 nginx 性能有明显提升</p>
<h2 id="文件客户端缓冲"><a class="markdownIt-Anchor" href="#文件客户端缓冲">#</a> 文件 / 客户端缓冲</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">上游服务器返回的header是一直缓冲的</span><br><span class="line">proxy_buffer_size </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">上游服务器返回的body是否缓冲可设置</span><br><span class="line">proxy_buffering 是否缓冲读到的数据</span><br><span class="line">proxy_buffers 32 64k 缓冲区32个64k大小内存缓冲块</span><br><span class="line">proxy_temp_path 向磁盘写入缓冲文件的路径   /spool/nginx/proxy_temp  1 2;   1,2是层级目录</span><br><span class="line">proxy_temp_file_write_size 每次向磁盘缓冲文件写入大小</span><br><span class="line">proxy_max_temp_file_size 缓冲向磁盘写入的最大值</span><br></pre></td></tr></table></figure>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230327144904954.png" alt="image-20230327144904954" style="zoom:80%;" /> 
<p>配置可在 http，server，location 中配置</p>
<p>类似于继承的关系</p>
<p>缓存用完就清除，下次在搞。缓存搞完就放那</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">client_body_buffer_size 对客户端body缓冲区大小配置</span><br><span class="line">client_header_buffer_size</span><br><span class="line">client_body_temp_path 磁盘缓冲存储位置</span><br><span class="line">client_max_body_size 通过http header content-length标识请求大小，先检查在上传 =0禁用  超过限制返回413</span><br><span class="line">client_body_timeout 等待完整的body超时时间</span><br><span class="line">client_header_timeout </span><br><span class="line">clinet_body_in_file_only body完整写入缓冲区，请求结束也不删除</span><br><span class="line">client_body_in_single_buffer 缓冲body使用连续单一缓冲区</span><br><span class="line">client_body_buffer_size body缓冲区大小</span><br><span class="line">large_client_header_buffers </span><br></pre></td></tr></table></figure>
<h2 id="如何获得用户ip"><a class="markdownIt-Anchor" href="#如何获得用户ip">#</a> 如何获得用户 IP</h2>
<p>X-Forwarded-for：将上一层的 remoteaddr 写入到 x-forwarded-for</p>
<p>remote_addr 建立 tcp 连接的时候的 IP，反向代理时一定是 nginx 的 ip，无法伪造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">        proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">        proxy_pass http://httpds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果存在多级代理，除了第一级代理以外直接转发即可，无需在设置 x-forwarded-for<br>
 或者在加一个 ip X-Forwarded-For: ip1,ip2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">host 通过nginx获取的host为upstream的名字</span><br><span class="line">User-agent</span><br><span class="line">accept-encoding: gzip.deflate </span><br></pre></td></tr></table></figure>
<h2 id="gzip-压缩"><a class="markdownIt-Anchor" href="#gzip-压缩">#</a> Gzip 压缩</h2>
<p>content-encoding 压缩格式</p>
<p>transfer-encoding 传输压缩格式，chunked 分块传输，在最后一个 0 字节来之前不知道多大</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>;  <span class="comment">#默认关闭</span></span><br><span class="line"><span class="attribute">gzip_buffers</span> <span class="number">16</span> <span class="number">8k</span>; <span class="comment">#内存缓冲16个8k的块缓冲  32 4k 32位  16 8k 64位</span></span><br><span class="line"><span class="attribute">gzip_comp_level</span> <span class="number">6</span>; <span class="comment">#压缩等级</span></span><br><span class="line"><span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;  <span class="comment">#http版本号</span></span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">256</span>; <span class="comment">#最小返回数据文件，&gt;这个值才压缩</span></span><br><span class="line"><span class="attribute">gzip_proxied</span> any; <span class="comment">#只针对反向代理生效，针对上游服务器返回header做条件压缩</span></span><br><span class="line"><span class="attribute">gzip_vary</span> <span class="literal">on</span>; </span><br><span class="line"><span class="attribute">gzip_types</span> text/xml text/css text/javascript;   <span class="comment">#针对那些mine文件压缩</span></span><br><span class="line"><span class="attribute">gzip_disable</span> MSIE6   <span class="comment"># 针对那些浏览器关闭压缩，最好别搞正则， 对性能消耗太大</span></span><br></pre></td></tr></table></figure>
<p>开启动态 gzip 后无法使用 send_file</p>
<h3 id="静态压缩"><a class="markdownIt-Anchor" href="#静态压缩">#</a> 静态压缩</h3>
<p><code>./configure --prefix=/usr/local/nginx/ --with-http_gzip_static_module </code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip_static on/off/always </span><br></pre></td></tr></table></figure>
<p>gunzip 客户端不支持在解压，节省磁盘空间</p>
<p><code>./configure --prefix=/usr/local/nginx/ --with-http_gunzip_module --with-http_gzip_static_module</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gunzip on;</span><br><span class="line">gunzip_buffers 32 4k;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">                gunzip on;</span><br><span class="line">                gzip_static always;</span><br><span class="line">                gzip on;  #默认关闭</span><br><span class="line">                gzip_buffers 16 8k; #内存缓冲16个8k的块缓冲  32 4k 32位  16 8k 64位</span><br><span class="line">                gzip_comp_level 6; #压缩等级</span><br><span class="line">                gzip_http_version 1.1;  #http版本号</span><br><span class="line">                gzip_min_length 256; #最小返回数据文件，&gt;这个值才压缩</span><br><span class="line">                gzip_proxied any; #只针对反向代理生效，针对上游服务器返回header做条件压缩</span><br><span class="line">                gzip_vary on;</span><br><span class="line">                gzip_types text/xml text/css text/javascript;   #针对那些mine&gt;文件压缩</span><br><span class="line">                gzip_disable MSIE6   # 针对那些浏览器关闭压缩，最好别搞正则， 对性能消耗太大</span><br><span class="line">                proxy_http_version 1.1;</span><br><span class="line">                proxy_set_header Connection &quot;&quot;;</span><br><span class="line">                proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">                proxy_pass http://httpds;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>建议开启 gzip，不建议对音视频做压缩。</p>
<p>静态压缩适合 nginx 作为 cdn 的存储服务器，以及极为高频被访问的页面和 js</p>
<p>content-length 和 content-encoding 同时存在说明采用的是预压缩，此时在磁盘上只有压缩文件</p>
<p>gunzip -r ./</p>
<h3 id="brotil"><a class="markdownIt-Anchor" href="#brotil">#</a> brotil</h3>
<p>需要 https 支持</p>
<p>br 和 gzip 可以共存，br 优先级更高</p>
<h4 id="安装"><a class="markdownIt-Anchor" href="#安装">#</a> 安装</h4>
<ul>
<li>官网
<ul>
<li><code>https://github.com/google/ngx_brotli</code></li>
<li><code>https://codeload.github.com/google/brotli/tar.gz/refs/tags/v1.0.9</code></li>
</ul>
</li>
<li>下载 两个项目</li>
<li>解压缩</li>
</ul>
<p>把 brotli-1.0.9 下所有文件移走</p>
<p><code>mv ./* ../ngx_brotli-1.0.0rc/deps/brotli/</code></p>
<p>编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-compat --add-dynamic-module=/root/ngx_brotli-1.0.0rc --prefix=/usr/local/nginx/</span><br></pre></td></tr></table></figure>
<ul>
<li>make</li>
<li>将 <code>ngx_http_brotli_filter_module.so</code>   <code>ngx_http_brotli_static_module.so</code>  拷贝到 <code>/usr/local/nginx/modules/</code></li>
<li>复制 nginx 主程序</li>
<li>配置文件中添加</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load_module &quot;/usr/local/nginx/modules/ngx_http_brotli_filter_module.so&quot;;</span><br><span class="line">load_module &quot;/usr/local/nginx/modules/ngx_http_brotli_static_module.so&quot;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">brotli on;</span><br><span class="line">    brotli_static on;</span><br><span class="line">	brotli_comp_level 6;</span><br><span class="line">	brotli_buffers 16 8k;</span><br><span class="line">	brotli_min_length 20;</span><br><span class="line">	brotli_types text/plain text/css text/javascript application/javascript text/xml application/xml application/xml+rss application/json image/jpeg image/gif image/png;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">brotli_static</span></span><br><span class="line"></span><br><span class="line">    syntax: brotli_static <span class="literal">on</span>|<span class="literal">off</span>|always</span><br><span class="line">    default: <span class="literal">off</span></span><br><span class="line">    context: http, server, location</span><br><span class="line"></span><br><span class="line">Enables or disables checking of the existence of pre-compressed files with.br extension. With the always value, pre-compressed file is used in all cases, without checking if the client supports it.</span><br><span class="line">brotli</span><br><span class="line"></span><br><span class="line">    syntax: brotli <span class="literal">on</span>|<span class="literal">off</span></span><br><span class="line">    default: <span class="literal">off</span></span><br><span class="line">    context: http, server, location, if</span><br><span class="line"></span><br><span class="line">Enables or disables <span class="literal">on</span>-the-fly compression of responses.</span><br><span class="line">brotli_types</span><br><span class="line"></span><br><span class="line">    syntax: brotli_types &lt;mime_type&gt; [..]</span><br><span class="line">    default: text/html</span><br><span class="line">    context: http, server, location</span><br><span class="line"></span><br><span class="line">Enables <span class="literal">on</span>-the-fly compression of responses for the specified MIME types in addition to text/html. The special value * matches any MIME type. Responses with the text/html MIME type are always compressed.</span><br><span class="line">brotli_buffers</span><br><span class="line"></span><br><span class="line">    syntax: brotli_buffers &lt;number&gt; &lt;size&gt;</span><br><span class="line">    default: <span class="number">32</span> <span class="number">4k</span>|<span class="number">16</span> <span class="number">8k</span></span><br><span class="line">    context: http, server, location</span><br><span class="line"></span><br><span class="line">Deprecated, ignored.</span><br><span class="line">brotli_comp_level</span><br><span class="line"></span><br><span class="line">    syntax: brotli_comp_level &lt;level&gt;</span><br><span class="line">    default: <span class="number">6</span></span><br><span class="line">    context: http, server, location</span><br><span class="line"></span><br><span class="line">Sets <span class="literal">on</span>-the-fly compression Brotli quality (compression) level. Acceptable values are in the range from <span class="number">0</span> to <span class="number">11</span>.</span><br><span class="line">brotli_window</span><br><span class="line"></span><br><span class="line">    syntax: brotli_window &lt;size&gt;</span><br><span class="line">    default: <span class="number">512k</span></span><br><span class="line">    context: http, server, location</span><br><span class="line"></span><br><span class="line">Sets Brotli window size. Acceptable values are <span class="number">1k</span>, <span class="number">2k</span>, <span class="number">4k</span>, <span class="number">8k</span>, <span class="number">16k</span>, <span class="number">32k</span>, <span class="number">64k</span>, <span class="number">128k</span>, <span class="number">256k</span>, <span class="number">512k</span>, <span class="number">1m</span>, <span class="number">2m</span>, <span class="number">4m</span>, <span class="number">8m</span> and <span class="number">16m</span>.</span><br><span class="line">brotli_min_length</span><br><span class="line"></span><br><span class="line">    syntax: brotli_min_length &lt;length&gt;</span><br><span class="line">    default: <span class="number">20</span></span><br><span class="line">    context: http, server, location</span><br><span class="line"></span><br><span class="line">Sets the minimum length of a response that will be compressed. The length is determined only from the Content-Length response header field.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">            #gunzip on;</span><br><span class="line">            #gzip_static always;</span><br><span class="line">            gzip on;  #默认关闭</span><br><span class="line">            gzip_buffers 16 8k; #内存缓冲16个8k的块缓冲  32 4k 32位  16 8k 64位</span><br><span class="line">            gzip_comp_level 6; #压缩等级</span><br><span class="line">            gzip_http_version 1.1;  #http版本号</span><br><span class="line">            gzip_min_length 256; #最小返回数据文件，&gt;这个值才压缩</span><br><span class="line">            gzip_proxied any; #只针对反向代理生效，针对上游服务器返回header做条件压缩</span><br><span class="line">            gzip_vary on;</span><br><span class="line">            gzip_types text/xml text/css text/javascript;   #针对那些mine文件压缩</span><br><span class="line">            gzip_disable MSIE6   # 针对那些浏览器关闭压缩，最好别搞正则， 对性能消耗太大</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header Connection &quot;&quot;;</span><br><span class="line">            proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">            proxy_pass http://httpds;</span><br><span class="line">            brotli on;</span><br><span class="line">            brotli_static on;</span><br><span class="line">            brotli_comp_level 6;</span><br><span class="line">            brotli_buffers 16 8k;</span><br><span class="line">            brotli_min_length 20;</span><br><span class="line">            brotli_types text/plain text/css text/javascript application/javascript text/xml application/xml application/xml+rss application/json image/jpeg image/gif image/png;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &#x27;accept-encoding:br&#x27; -I http://192.168.13.132</span><br></pre></td></tr></table></figure>
<h2 id="concat压缩请求个数"><a class="markdownIt-Anchor" href="#concat压缩请求个数">#</a> concat 压缩请求个数</h2>
<p>concat 模块压缩请求数，减少并发请求个数</p>
<p>淘宝网即，?? 代表这是一个合并请求</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230327181444179.png" alt="image-20230327181444179"></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubmdpbnguY29tL25naW54LXdpa2kvYnVpbGQvZGlyaHRtbC9tb2R1bGVzL2NvbmNhdC8=">https://www.nginx.com/nginx-wiki/build/dirhtml/modules/concat/</span></p>
<p><code>./configure --prefix=/usr/local/nginx --add-module=/root/Downloads/nginx-http-concat/</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location /static/css/ &#123;</span><br><span class="line">    concat on;</span><br><span class="line">    concat_max_files 20;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">location /static/js/ &#123;</span><br><span class="line">    concat on;</span><br><span class="line">    concat_max_files 30;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link href=&quot;??font.css,bg.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>png 的可以一张图片包含多张图，在用切割展示不同的部分</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328173546514.png" alt="image-20230328173546514"></p>
<p>其实就是把 css 文件拼接</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328173731682.png" alt="image-20230328173731682"></p>
<h2 id="资源静态化"><a class="markdownIt-Anchor" href="#资源静态化">#</a> 资源静态化</h2>
<p>将原本需要计算的请求缓存成文件放在 nginx 里</p>
<p>并发最高的：列表，详情页</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328175858869.png" alt="image-20230328175858869" style="zoom: 67%;" /> 
<p>html 一般有</p>
<p>1. 内容</p>
<p>2. 关联</p>
<p>3. 固定共用</p>
<p>有前端合并和后端合并</p>
<p>前端合并：节约服务器资源，消耗请求数</p>
<p>后端合并：ssi</p>
<p>变化多的使用异步加载，不生成静态页面</p>
<p>如果变化的在静态页面中，可以两步提交</p>
<h3 id="文件合并"><a class="markdownIt-Anchor" href="#文件合并">#</a> 文件合并</h3>
<p>ssi 服务端文件合并</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ssi on;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ssi:command</p>
<p><span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfc3NpX21vZHVsZS5odG1s">http://nginx.org/en/docs/http/ngx_http_ssi_module.html</span></p>
<h3 id="静态资源同步"><a class="markdownIt-Anchor" href="#静态资源同步">#</a> 静态资源同步</h3>
<p>rsync</p>
<p>inotify</p>
<p>资源端：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ftp]</span><br><span class="line">    path = /usr/local/nginx/html</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync --daemon</span><br></pre></td></tr></table></figure>
<p>接收端：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rsync --list-only 192.168.13.132::ftp/</span><br><span class="line">drwxr-xr-x            150 2023/03/28 01:15:08 .</span><br><span class="line">-rw-r--r--            330 2023/03/23 23:32:14 401.html</span><br><span class="line">-rw-r--r--            497 2023/03/23 03:11:05 50x.html</span><br><span class="line">-rwxr-xr-x             33 2023/03/28 01:03:41 bg.css</span><br><span class="line">-rw-r--r--             13 2023/03/28 01:13:48 bottom.html</span><br><span class="line">-rw-r--r--             22 2023/03/28 01:03:27 font.css</span><br><span class="line">-rw-r--r--            731 2023/03/28 01:15:08 index.html</span><br><span class="line">-rwxr-xr-x          5,542 2023/03/28 00:07:23 tomcat.css</span><br><span class="line">-rw-r--r--             11 2023/03/28 01:13:16 top.html</span><br><span class="line">drwxrwxrwx             37 2023/03/24 00:21:28 img</span><br><span class="line"></span><br><span class="line">rsync -avz 192.168.13.132::ftp/ /usr/local/nginx/html</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 /etc/rsyncd.pwd </span><br><span class="line">rsync --daemon </span><br><span class="line">vim /etc/rsyncd.pwd </span><br><span class="line">shabi:111</span><br><span class="line"></span><br><span class="line">rsync --list-only shabi@192.168.13.132::ftp/  </span><br><span class="line">Password: </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyncd.pwd.client</span><br><span class="line">111</span><br><span class="line"></span><br><span class="line">chmod -R 600 /etc/rsyncd.pwd.client </span><br><span class="line">rsync --list-only  --password-file=/etc/rsyncd.pwd.client   shabi@192.168.13.132::ftp/</span><br><span class="line"></span><br><span class="line">rsync -avz  --password-file=/etc/rsyncd.pwd.client   shabi@192.168.13.132::ftp/ /usr/local/nginx/html</span><br><span class="line"></span><br><span class="line">//清除源服务器上没有的文件</span><br><span class="line">rsync -avz --delete   --password-file=/etc/rsyncd.pwd.client   shabi@192.168.13.132::ftp/ /usr/local/nginx/html</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以写 shell 脚本同步</p>
<p>有推模式和拉模式</p>
<p>实时推送即推模式，近时推送即拉模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz --password-file=/etc/rsyncd.passwd.client /usr/local/nginx/html/ sgg@192.168.44.105::ftp/</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">read only = no</span><br><span class="line">auth users = shabi</span><br><span class="line">secrets file = /etc/rsyncd.pwd</span><br><span class="line"></span><br><span class="line"> [ftp]</span><br><span class="line">        path = /usr/local/nginx/html</span><br><span class="line">        comment = ftp export area</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>inotify</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz</span><br><span class="line">./configure --prefix=/usr/local/inotify</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/inotify/bin/inotifywait -mrq --timefmt &#x27;%Y-%m-%d %H:%M:%S&#x27; --format &#x27;%T %w%f %e&#x27; -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">/usr/local/inotify/bin/inotifywait -mrq --timefmt &#x27;%d/%m/%y %H:%M&#x27; --format &#x27;%T %w%f %e&#x27; -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/ | while read file</span><br><span class="line">do</span><br><span class="line">       </span><br><span class="line">        rsync -az --delete --password-file=/etc/rsyncd.passwd.client /usr/local/nginx/html/ sgg@192.168.44.102::ftp/</span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="多级缓存"><a class="markdownIt-Anchor" href="#多级缓存">#</a> 多级缓存</h2>
<h3 id="浏览器缓存"><a class="markdownIt-Anchor" href="#浏览器缓存">#</a> 浏览器缓存</h3>
<img data-src="../AppData/Roaming/Typora/typora-user-images/image-20230329155203675.png" alt="image-20230329155203675" style="zoom: 80%;" />
<p>强制性缓存：服务器返回时携带 expire，过期时间以前都是读缓存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cache-control</span><br><span class="line">expires</span><br><span class="line"></span><br><span class="line">expires 300s;</span><br><span class="line">#Expires: Wed, 29 Mar 2023 08:40:14 GMT</span><br><span class="line"></span><br><span class="line">add_header cache-control &quot;max-age:300&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#cache contol优先级更高</span><br></pre></td></tr></table></figure>
<p>使用页面首次打开直接读取缓存数据，刷新会向服务器发起缓存</p>
<p>协商缓存：发送请求头中包含 last_modify ，如果和服务器上文件的 lastmodify 时间相同，那么直接返回 304。不在返回数据。浏览器直接读缓存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ETag: &quot;6422a20c-2db&quot;</span><br><span class="line">Last-Modified: Tue, 28 Mar 2023 08:15:08 GMT</span><br><span class="line">nginx默认开启etag和last-modify</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230329162022774.png" alt="image-20230329162022774"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230329162259608.png" alt="image-20230329162259608"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">etag off; //禁用etag</span><br><span class="line"></span><br><span class="line">禁用etag后还是有last-modify，还是可以缓存</span><br><span class="line">可以取消  add_header Last-Modified &quot;&quot;; </span><br><span class="line">禁用缓存</span><br><span class="line"></span><br><span class="line">或者通过一直返回200来禁用缓存</span><br><span class="line">if_modified_since off;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>没发生变化返回 304，发生 200</p>
<p>根据用户 IP 判断用户位置</p>
<p>GEOIP 判断 IP 所属区域，实现 IP 阻断或限制</p>
<h4 id="1-下载数据库"><a class="markdownIt-Anchor" href="#1-下载数据库">#</a> 1 下载数据库</h4>
<p>官网需注册登录</p>
<p>下载数据库</p>
<p><span class="exturl" data-url="aHR0cDovL21heG1pbmQuY29t">maxmind.com</span></p>
<h4 id="2-安装依赖"><a class="markdownIt-Anchor" href="#2-安装依赖">#</a> 2 安装依赖</h4>
<h5 id="官方git"><a class="markdownIt-Anchor" href="#官方git">#</a> 官方 git</h5>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21heG1pbmQvbGlibWF4bWluZGRi">https://github.com/maxmind/libmaxminddb</span></p>
<p>下载后执行编译安装之后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo /usr/local/lib  &gt;&gt; /etc/ld.so.conf.d/local.conf </span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>
<h4 id="nginx模块"><a class="markdownIt-Anchor" href="#nginx模块">#</a> Nginx 模块</h4>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xlZXYvbmd4X2h0dHBfZ2VvaXAyX21vZHVsZQ==">https://github.com/leev/ngx_http_geoip2_module</span></p>
<p>更完整的配置可参考官方文档</p>
<p><span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfZ2VvaXBfbW9kdWxlLmh0bWwjZ2VvaXBfcHJveHk=">http://nginx.org/en/docs/http/ngx_http_geoip_module.html#geoip_proxy</span></p>
<h4 id="nginx配置"><a class="markdownIt-Anchor" href="#nginx配置">#</a> Nginx 配置</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    geoip2 /root/GeoLite2-ASN_20220524/GeoLite2-ASN.mmdb &#123;</span><br><span class="line">$geoip2_country_code country iso_code;</span><br><span class="line">    &#125;</span><br><span class="line">    location&#123;</span><br><span class="line">add_header country $geoip2_country_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 DNS 上就可以针对 IP 访问不同服务器了，比如添加 A 记录时，如果是联通 IP 解析到某一特定 IP</p>
<h3 id="正向代理"><a class="markdownIt-Anchor" href="#正向代理">#</a> 正向代理</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">resolver 8.8.8.8;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">	proxy_pass $scheme://$host$request_uri;</span><br><span class="line">	root html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置浏览器代理：<br>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230330144832103.png" alt="image-20230330144832103" style="zoom:80%;" /></p>
<p>之后每次访问都是有 121.37 发出，但不能访问 https 网站</p>
<h4 id="代理https请求"><a class="markdownIt-Anchor" href="#代理https请求">#</a> 代理 https 请求</h4>
<p>需要第三方模块</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nob2JpdHMvbmd4X2h0dHBfcHJveHlfY29ubmVjdF9tb2R1bGU=">https://github.com/chobits/ngx_http_proxy_connect_module</span></p>
<p>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen                         3128;</span><br><span class="line"></span><br><span class="line">    # dns resolver used by forward proxying</span><br><span class="line">    resolver                       8.8.8.8;</span><br><span class="line"></span><br><span class="line">    # forward proxy for CONNECT request</span><br><span class="line">    proxy_connect;</span><br><span class="line">    proxy_connect_allow            443 563;</span><br><span class="line">    proxy_connect_connect_timeout  10s;</span><br><span class="line">    proxy_connect_read_timeout     10s;</span><br><span class="line">    proxy_connect_send_timeout     10s;</span><br><span class="line"></span><br><span class="line">    # forward proxy for non-CONNECT request</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://$host;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="反向代理缓存"><a class="markdownIt-Anchor" href="#反向代理缓存">#</a> 反向代理缓存</h3>
<p>将缓存数据写在 nginx 里，一旦命中直接返回。如果缓存过期再去 tomcat 重新找</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http模块：</span><br><span class="line">proxy_cache_path /ngx_tmp levels=1:2 keys_zone=test_cache:100m inactive=1d max_size=10g ; #每一级文件名称几个字符，缓存key快速命中缓存</span><br><span class="line">location模块：</span><br><span class="line">add_header  Nginx-Cache &quot;$upstream_cache_status&quot;;   # 显示是否命令缓存</span><br><span class="line">proxy_cache test_cache;   #使用哪个缓存，和keys_zone对应</span><br><span class="line">proxy_cache_valid 1h;   #缓存过期时间</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── cache</span><br><span class="line">│   ├── 0</span><br><span class="line">│   │   └── 73</span><br><span class="line">│   │       └── 0b3cd73b8afe98ff92e238ebbcaef730</span><br><span class="line">│   ├── 1</span><br><span class="line">│   │   └── 6c</span><br><span class="line">│   │       └── f86f8edc323791f718b1cccaa068f6c1</span><br><span class="line">│   ├── 6</span><br><span class="line">│   │   └── f1</span><br><span class="line">│   │       └── 02d9ac690b0ad1d32f123b7c4c6def16</span><br><span class="line">│   ├── 8</span><br><span class="line">│   │   ├── fb</span><br><span class="line">│   │   │   └── 80ccd3fd415f4c9fd380ffe294e25fb8</span><br><span class="line">│   │   └── fc</span><br><span class="line">│   │       └── 8249da23676a1b8b7fae236980842fc8</span><br><span class="line">│   ├── 9</span><br><span class="line">│   │   └── d4</span><br><span class="line">│   │       └── 01a49b4327ec08c30aa4cdeecc16dd49</span><br><span class="line">│   ├── a</span><br><span class="line">│   │   └── 98</span><br><span class="line">│   │       └── c9aa10b77d4100e5db76604b684b198a</span><br><span class="line">│   └── c</span><br><span class="line">│       └── 22</span><br><span class="line">│           └── 8ebbd1ad5c54886ec0727b25cfbd722c</span><br><span class="line">└── temp</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230330151139269.png" alt="image-20230330151139269"></p>
<p>正向代理和返现代理都可以用这个缓存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">KEY: http://192.168.13.155:8080/??tomcat.css,bg.css</span><br><span class="line">HTTP/1.1 200 ^M</span><br><span class="line">Content-Type: text/html;charset=UTF-8^M</span><br><span class="line">Date: Thu, 30 Mar 2023 05:26:46 GMT^M</span><br><span class="line">Connection: close^M</span><br></pre></td></tr></table></figure>
<h4 id="缓存清理"><a class="markdownIt-Anchor" href="#缓存清理">#</a> 缓存清理</h4>
<p><strong>purger</strong></p>
<p>需要第三方模块支持</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZSaUNLTEUvbmd4X2NhY2hlX3B1cmdl">https://github.com/FRiCKLE/ngx_cache_purge</span></p>
<p>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~ /purge(/.*) &#123;</span><br><span class="line"></span><br><span class="line">    proxy_cache_purge  test_cache  $1;</span><br><span class="line">&#125;</span><br><span class="line">自定义cachekey</span><br><span class="line"> proxy_cache_key $host$uri;</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMTMuMTMyL3B1cmdlLw==">http://192.168.13.132/purge/</span></p>
<p>proxy_cache_key 不同，缓存的判断方式也不同</p>
<p>断点续传</p>
<p>通过 headers 中的 Range 每次传递范围的数据、有完整 content-length 之后即可断点续传</p>
<p>range 返回的状态码为 206</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header Range $http_range;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230330165442201.png" alt="image-20230330165442201"></p>
<h3 id="缓存文件"><a class="markdownIt-Anchor" href="#缓存文件">#</a> 缓存文件</h3>
<p><strong>open_file_cache</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sendfile on;</span><br><span class="line"></span><br><span class="line">location /&#123;</span><br><span class="line">    open_file_cache max=500 inactive=60s;  # 缓存文件句柄上限  # 自动过期时间</span><br><span class="line">    open_file_cache_min_uses 1; </span><br><span class="line">    open_file_cache_valid 60s; # 每隔60s检测文件是否发生变化</span><br><span class="line">    open_file_cache_errors on; # 缓存错误信息</span><br><span class="line">    root html</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将文件描述符等记录到元数据，加速 sendfile</p>
<p><code>strace -p pid</code></p>
<p>core_module</p>
<h3 id="外置缓存"><a class="markdownIt-Anchor" href="#外置缓存">#</a> 外置缓存</h3>
<p><strong>error_page</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">error_page 404 =302 http://www.atguigu.com;</span><br><span class="line">        error_page 404 =200 /401.html;</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 401 /401.html;</span><br><span class="line">        location = /401.html &#123;</span><br><span class="line">                root html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>匿名 location</strong></p>
<p>不能直接访问的 location</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">error_page 404 = @6666;</span><br><span class="line"></span><br><span class="line">location @6666 &#123;</span><br><span class="line">		add_header content-type “text/html”;</span><br><span class="line">        return 200 &quot;shabi&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>memcached</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">yum install memcached</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# telnet 127.0.0.1 11211</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">set name 0 0 3</span><br><span class="line">ooo</span><br><span class="line">STORED</span><br><span class="line">get name</span><br><span class="line">VALUE name 0 3</span><br><span class="line">ooo</span><br><span class="line">END</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">upstream backend &#123;</span><br><span class="line">    </span><br><span class="line">#   server 192.168.44.102 weight=8 down;</span><br><span class="line">   server 192.168.44.104:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line"></span><br><span class="line">    set            $memcached_key &quot;$uri?$args&quot;;</span><br><span class="line">    memcached_pass 127.0.0.1:11211;</span><br><span class="line"></span><br><span class="line">	add_header X-Cache-Satus HIT;</span><br><span class="line"></span><br><span class="line">	add_header Content-Type &#x27;text/html; charset=utf-8&#x27;; # 强制响应数据格式为html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	# root   html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_page 404 = @failback;</span><br><span class="line"></span><br><span class="line">location @failback &#123;</span><br><span class="line">        proxy_set_header memcached_key $memcached_key;</span><br><span class="line">		proxy_pass http://192.168.13.166:8080;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>nginx 先找 mem，如果有直接返回，没有 proxy_pass 到后端服务器。后端服务器在写道 mem，下次可以直接读</p>
<p><strong>redis</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">--prefix=/usr/local/nginx --user=www --group=www --with-http_stub_status_module --with-http_v2_module --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module --with-http_flv_module --with-http_mp4_module --with-stream --add-module=/usr/local/ngx_cache_purge-2.3 --add-module=/root/Downloads/redis2-nginx-module-0.15</span><br><span class="line"></span><br><span class="line">location = /foo &#123;</span><br><span class="line"></span><br><span class="line">    default_type text/html;</span><br><span class="line"></span><br><span class="line">    redis2_query auth 123123;</span><br><span class="line"></span><br><span class="line">    set $value &#x27;first&#x27;;</span><br><span class="line"></span><br><span class="line">    redis2_query set one $value;</span><br><span class="line"></span><br><span class="line">    redis2_pass 192.168.199.161:6379;</span><br><span class="line"></span><br><span class="line"> &#125;   </span><br><span class="line"></span><br><span class="line">location = /get &#123;</span><br><span class="line"></span><br><span class="line">default_type text/html;</span><br><span class="line"></span><br><span class="line">     redis2_pass 192.168.199.161:6379;</span><br><span class="line"></span><br><span class="line">     redis2_query auth 123123;</span><br><span class="line"></span><br><span class="line">     set_unescape_uri $key $arg_key;  # this requires ngx_set_misc</span><br><span class="line"></span><br><span class="line">     redis2_query get $key;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29wZW5yZXN0eS9yZWRpczItbmdpbngtbW9kdWxl">openresty/redis2-nginx-module: Nginx upstream module for the Redis 2.0 protocol (github.com)</span></p>
<h2 id="stream"><a class="markdownIt-Anchor" href="#stream">#</a> stream</h2>
<p><span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL3N0cmVhbS9uZ3hfc3RyZWFtX2NvcmVfbW9kdWxlLmh0bWw=">http://nginx.org/en/docs/stream/ngx_stream_core_module.html</span></p>
<p>mycat 和 nginx 都可以实现 mysq 负载均衡</p>
<p>stream 可以实现四层负载均衡</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 和http同级</span></span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="section">upstream</span> mysqld&#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.13.155:3306</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.13.166:3306</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="section">srever</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">3306</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> mysqld;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据不一样可以灰度发布，一样可以负载均衡</p>
<h2 id="qps"><a class="markdownIt-Anchor" href="#qps">#</a> QPS</h2>
<p>官方文档</p>
<p><span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfbGltaXRfcmVxX21vZHVsZS5odG1s">http://nginx.org/en/docs/http/ngx_http_limit_req_module.html</span></p>
<p>测试工具</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9qbWV0ZXIuYXBhY2hlLm9yZy8=">https://jmeter.apache.org/</span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">limit_req_zone</span> <span class="variable">$binary_remote_addr</span> zone=one:<span class="number">10m</span> rate=1r/s; </span><br><span class="line">    <span class="attribute">limit_conn_zone</span> <span class="variable">$binary_remote_addr</span> zone=two:<span class="number">10m</span> rate=1r/s;<span class="comment"># 并发数限制</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /search/ &#123;</span><br><span class="line">            <span class="attribute">limit_req</span> zone=one burst=<span class="number">5</span>; <span class="comment"># QPS 限制</span></span><br><span class="line">            <span class="attribute">limit_rate_after</span> <span class="number">10m</span>;  <span class="comment"># 带宽限制</span></span><br><span class="line">            <span class="attribute">limit_rate</span> <span class="number">1k</span>; </span><br><span class="line">			<span class="attribute">limit_conn</span> two <span class="number">1</span>;</span><br><span class="line">            <span class="attribute">root</span> html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>漏桶</p>
<p>令牌桶</p>
<p>计数器</p>
<h2 id="日志"><a class="markdownIt-Anchor" href="#日志">#</a> 日志</h2>
<p>nginx 日志</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> compression <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &#x27;</span></span><br><span class="line">                       <span class="string">&#x27;&quot;<span class="variable">$request</span>&quot; <span class="variable">$status</span> <span class="variable">$bytes_sent</span> &#x27;</span></span><br><span class="line">                       <span class="string">&#x27;&quot;<span class="variable">$http_referer</span>&quot; &quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$gzip_ratio</span>&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">access_log</span> /spool/logs/nginx-access.log compression buffer=<span class="number">32k</span>;</span><br><span class="line"><span class="comment"># access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];</span></span><br><span class="line"><span class="comment"># 缓冲区大小，压缩等级，间隔写盘时间</span></span><br><span class="line"><span class="comment"># log_format name [escape=default|json|none] string ...;</span></span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfbG9nX21vZHVsZS5odG1s">Module ngx_http_log_module (nginx.org)</span></p>
<p><strong>empty_gif</strong></p>
<p>实现将请求转发到 nginx，通过访问一个 1*1 的小方块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /.gif &#123;</span><br><span class="line">	empty_gif;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>[buffer=size] [flush=time]</p>
<p>不配置上面的选项每有日志更新就会立刻写盘，buffer 实现缓冲区，缓冲区满了在写盘。time 实现指定时间间隔才写盘</p>
<p><strong>open_log_file_cache</strong>  <code>max</code> = <code>*N*</code>  [ <code>inactive</code> = <code>*time*</code> ] [ <code>min_uses</code> = <code>*N*</code> ] [ <code>valid</code> = <code>*time*</code> ];</p>
<p>缓冲文件描述符，读写的时候做缓冲，指定条件才做</p>
<p>json 格式日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">log_format  ngxlog json &#x27;&#123;&quot;timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;source&quot;:&quot;$server_addr&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;hostname&quot;:&quot;$hostname&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;remote_user&quot;:&quot;$remote_user&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;ip&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;client&quot;:&quot;$remote_addr&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;request_method&quot;:&quot;$request_method&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;scheme&quot;:&quot;$scheme&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;domain&quot;:&quot;$server_name&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;request&quot;:&quot;$request_uri&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;requesturl&quot;:&quot;$request&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;args&quot;:&quot;$args&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br><span class="line">                    &#x27;&quot;status&quot;: $status,&#x27;</span><br><span class="line">                    &#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br><span class="line">                    &#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;upstreamaddr&quot;:&quot;$upstream_addr&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;http_cookie&quot;:&quot;$http_cookie&quot;,&#x27;</span><br><span class="line">                    &#x27;&quot;https&quot;:&quot;$https&quot;&#x27;</span><br><span class="line">                    &#x27;&#125;&#x27;;</span><br></pre></td></tr></table></figure>
<p>error log</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	error_log file [level];</span><br><span class="line">Default:	</span><br><span class="line">error_log logs/error.log error;</span><br><span class="line">Context:	main, http, mail, stream, server, location</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="上游服务健康检查"><a class="markdownIt-Anchor" href="#上游服务健康检查">#</a> 上游服务健康检查</h2>
<p><strong>重试机制</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> &#123;</span><br><span class="line">    <span class="attribute">server</span> ... mmax_fails=<span class="number">5</span> fail_timeout=<span class="number">10s</span>; <span class="comment"># 最大失败次数  # 10s 5次 失败服务重新上线</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_next_upstream</span> <span class="literal">error</span> | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | http_429 | non_idempotent | <span class="literal">off</span> ...;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_next_upstream_timeout</span> time; <span class="comment"># 失败重试总时间</span></span><br><span class="line">    <span class="attribute">proxy_next_upstream_tries</span> number; <span class="comment"># 总时间内重试次数</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>主动状态检查</strong></p>
<p>tengine 版</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lhb3dlaWJpbi9uZ2lueF91cHN0cmVhbV9jaGVja19tb2R1bGU=">https://github.com/yaoweibin/nginx_upstream_check_module</span></p>
<p>nginx 商业版</p>
<p><span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfdXBzdHJlYW1faGNfbW9kdWxlLmh0bWw=">http://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1.下载安装nginx 1.20.2</span><br><span class="line"></span><br><span class="line">2.vi /root/path</span><br><span class="line">内容为:https://github.com/yaoweibin/nginx_upstream_check_module/blob/master/check_1.20.1%2B.patch</span><br><span class="line"></span><br><span class="line">3.安装patch</span><br><span class="line"></span><br><span class="line">4.进入nginx文件夹</span><br><span class="line">[root@mail nginx-1.20.2]# patch -p1 &lt; /root/path </span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/nginx20 --add-module=/root/Downloads/nginx_upstream_check_module-0.4.0</span><br><span class="line">make </span><br><span class="line">make install </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="section">upstream</span> backend &#123;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.44.102</span> weight=<span class="number">8</span> down;</span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.13.155:8080</span>;</span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.13.166:8080</span>;</span><br><span class="line">     <span class="attribute">check</span> interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http; <span class="comment">#每三秒检测一次，两次正常就up，五次失败就down，超时时间1000ms，使用http</span></span><br><span class="line">     <span class="attribute">check_http_send</span> <span class="string">&quot;HEAD / HTTP/1.0\r\n\r\n&quot;</span>;</span><br><span class="line">     <span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">     <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">     <span class="attribute">server_name</span>  localhost;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">#charset koi8-r;</span></span><br><span class="line">     </span><br><span class="line">     <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line">     </span><br><span class="line">     <span class="section">location</span> /status &#123;</span><br><span class="line">             check_status;</span><br><span class="line">             <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="section">location</span> / &#123;</span><br><span class="line">             <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">             <span class="attribute">root</span>   html;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>./nginx -c /usr/local/nginx20/conf/nginx.conf</code></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230403163536618.png" alt="image-20230403163536618"></p>
<h2 id="lua"><a class="markdownIt-Anchor" href="#lua">#</a> Lua</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE2NzQ5MDczL2FydGljbGUvZGV0YWlscy8xMTQzMDQyNDg=">(60 条消息) lua-idea lua 环境配置_qq_16749073 的博客 - CSDN 博客</span></p>
<h4 id="hello-world"><a class="markdownIt-Anchor" href="#hello-world">#</a> hello world</h4>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello world!&quot;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="保留关键字"><a class="markdownIt-Anchor" href="#保留关键字">#</a> 保留关键字</h4>
<p><code>and</code>         <code>break</code>       <code>do   </code>   <code>else</code>        <code>elseif</code>        <code>end</code>         <code>false</code>      <code> for</code>         <code>function  if</code>        <code>in</code>          <code>local</code>       <code>nil</code>        <code>not</code>        <code>or</code>        <code>repeat</code>      <code>return</code>      <code>then</code>       <code> true</code>        <code>until</code>      <code> while</code></p>
<h4 id="注释"><a class="markdownIt-Anchor" href="#注释">#</a> 注释</h4>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 两个减号是行注释</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 这是块注释</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 这是块注释.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> --]]</span></span><br></pre></td></tr></table></figure>
<h4 id="变量"><a class="markdownIt-Anchor" href="#变量">#</a> 变量</h4>
<h5 id="数字类型"><a class="markdownIt-Anchor" href="#数字类型">#</a> 数字类型</h5>
<p>Lua 的数字只有 double 型，64bits</p>
<p>你可以以如下的方式表示数字</p>
 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">num = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">3.1416</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">314.16e-2</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0.31416E1</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0x56</span></span><br></pre></td></tr></table></figure>
<h5 id="字符串"><a class="markdownIt-Anchor" href="#字符串">#</a> 字符串</h5>
<p>可以用单引号，也可以用双引号</p>
<p>也可以使用转义字符‘\n’ （换行）， ‘\r’ （回车）， ‘\t’ （横向制表）， ‘\v’ （纵向制表）， ‘\’ （反斜杠）， ‘\”‘ （双引号）， 以及 ‘\” （单引号) 等等</p>
<p>下面的四种方式定义了完全相同的字符串（其中的两个中括号可以用于定义有换行的字符串）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a = &#x27;alo\n123&quot;&#x27;</span><br><span class="line"></span><br><span class="line">a = &quot;alo\n123\&quot;&quot;</span><br><span class="line"></span><br><span class="line">a = &#x27;\97lo\10\04923&quot;&#x27;</span><br><span class="line"></span><br><span class="line">a = [[alo</span><br><span class="line"></span><br><span class="line">123&quot;]]</span><br></pre></td></tr></table></figure>
<h5 id="空值"><a class="markdownIt-Anchor" href="#空值">#</a> 空值</h5>
<p>C 语言中的 NULL 在 Lua 中是 nil，比如你访问一个没有声明过的变量，就是 nil</p>
<h5 id="布尔类型"><a class="markdownIt-Anchor" href="#布尔类型">#</a> 布尔类型</h5>
<p>只有 nil 和 false 是 false</p>
<p>数字 0，‘’空字符串（’\0’）都是 true</p>
<h5 id="作用域"><a class="markdownIt-Anchor" href="#作用域">#</a> 作用域</h5>
<p>lua 中的变量如果没有特殊说明，全是全局变量，那怕是语句块或是函数里。</p>
<p>变量前加 local 关键字的是局部变量。</p>
<h4 id="控制语句"><a class="markdownIt-Anchor" href="#控制语句">#</a> 控制语句</h4>
<h5 id="while循环"><a class="markdownIt-Anchor" href="#while循环">#</a> while 循环</h5>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">max</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> i &lt;= <span class="built_in">max</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">i = i +<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h5 id="if-else"><a class="markdownIt-Anchor" href="#if-else">#</a> if-else</h5>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> age = <span class="number">140</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> sex = <span class="string">&#x27;Male&#x27;</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> age == <span class="number">40</span> <span class="keyword">and</span> sex ==<span class="string">&quot;Male&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; 男人四十一枝花 &quot;</span>)</span><br><span class="line">  <span class="keyword">elseif</span> age &gt; <span class="number">60</span> <span class="keyword">and</span> sex ~=<span class="string">&quot;Female&quot;</span> <span class="keyword">then</span></span><br><span class="line">   </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;old man!!&quot;</span>)</span><br><span class="line">  <span class="keyword">elseif</span> age &lt; <span class="number">20</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;too young, too simple!\n&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Your age is &quot;</span>..age)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="for循环"><a class="markdownIt-Anchor" href="#for循环">#</a> for 循环</h5>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sum = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">100</span>, <span class="number">1</span>, <span class="number">-2</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">	sum = sum + i</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h5 id="函数"><a class="markdownIt-Anchor" href="#函数">#</a> 函数</h5>
<ol>
<li></li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myPower</span><span class="params">(x,y)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span>      y+x</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">power2 = myPower(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"> <span class="built_in">print</span>(power2)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li></li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newCounter</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span>     <span class="comment">-- anonymous function</span></span><br><span class="line"></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">c1 = newCounter()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c1())  <span class="comment">--&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c1())  <span class="comment">--&gt; 2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c1())</span><br></pre></td></tr></table></figure>
<h4 id="返回值"><a class="markdownIt-Anchor" href="#返回值">#</a> 返回值</h4>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name, age,bGay = <span class="string">&quot;yiming&quot;</span>, <span class="number">37</span>, <span class="literal">false</span>, <span class="string">&quot;yimingl@hotmail.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(name,age,bGay)</span><br></pre></td></tr></table></figure>
 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isMyGirl</span><span class="params">(name)</span></span></span><br><span class="line">  <span class="keyword">return</span> name == <span class="string">&#x27;xiao6&#x27;</span> , name</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> bol,name = isMyGirl(<span class="string">&#x27;xiao6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(name,bol)</span><br></pre></td></tr></table></figure>
<h4 id="table"><a class="markdownIt-Anchor" href="#table">#</a> Table</h4>
<p>key，value 的键值对 类似 map</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line">dog = &#123;name=<span class="string">&#x27;111&#x27;</span>,age=<span class="number">18</span>,height=<span class="number">165.5</span>&#125;</span><br><span class="line"></span><br><span class="line">dog.age=<span class="number">35</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dog.name,dog.age,dog.height)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dog)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="数组"><a class="markdownIt-Anchor" href="#数组">#</a> 数组</h4>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line">arr = &#123;<span class="string">&quot;string&quot;</span>, <span class="number">100</span>, <span class="string">&quot;dog&quot;</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;wangwang!&quot;</span>) <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">end</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(arr[<span class="number">4</span>]())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="遍历"><a class="markdownIt-Anchor" href="#遍历">#</a> 遍历</h4>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arr = &#123;<span class="string">&quot;string&quot;</span>, <span class="number">100</span>, <span class="string">&quot;dog&quot;</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;wangwang!&quot;</span>) <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">end</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(arr) <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">print</span>(k, v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="成员函数"><a class="markdownIt-Anchor" href="#成员函数">#</a> 成员函数</h4>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">person = &#123;name=<span class="string">&#x27;旺财&#x27;</span>,age = <span class="number">18</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span>  <span class="title">person.eat</span><span class="params">(food)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(person.name ..<span class="string">&quot; eating &quot;</span>..food)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">person.eat(<span class="string">&quot;骨头&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="openresty"><a class="markdownIt-Anchor" href="#openresty">#</a> openresty</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly9vcGVucmVzdHkub3JnL2NuL2Rvd25sb2FkLmh0bWw=">OpenResty - 下载</span></p>
<h3 id="测试lua脚本"><a class="markdownIt-Anchor" href="#测试lua脚本">#</a> 测试 lua 脚本</h3>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">在Nginx.<span class="attribute">conf</span> 中写入</span><br><span class="line">   location /lua &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">default_type</span> text/html;</span><br><span class="line">        <span class="attribute">content_by_lua</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">           ngx.say(&quot;&lt;p&gt;Hello, World!&lt;/p&gt;&quot;)</span></span><br><span class="line"><span class="string">         &#x27;</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h3 id="lua-nginx-module"><a class="markdownIt-Anchor" href="#lua-nginx-module">#</a> lua-nginx-module</h3>
<h4 id="创建配置文件luaconf"><a class="markdownIt-Anchor" href="#创建配置文件luaconf">#</a> 创建配置文件 lua.conf</h4>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">   <span class="section">location</span> /lua &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">content_by_lua_file</span> conf/lua/hello.lua;</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2023-04-06 12:05:06" itemprop="dateModified" datetime="2023-04-06T12:05:06+08:00">2023-04-06</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2023/04/01/Nginx/" title="Nginx">http://example.com/2023/04/01/Nginx/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/03/27/http/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicitf0kl1j20zk0m87fe.jpg" title="http">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>http</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/04/02/Nginx_new/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giciuv0socj20zk0m8qes.jpg" title="Nginx">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Nginx</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx"><span class="toc-number">1.</span> <span class="toc-text"> Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8nginx"><span class="toc-number">1.1.</span> <span class="toc-text"> 安装启动 nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text"> nginx 目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnginx%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-number">1.3.</span> <span class="toc-text"> 配置 nginx 虚拟主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#servername%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99"><span class="toc-number">1.4.</span> <span class="toc-text"> servername 匹配规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%94%A8%E6%88%B7%E4%BA%8C%E7%BA%A7%E5%9F%9F%E5%90%8D%E7%9F%AD%E7%BD%91%E5%9D%80httpdns"><span class="toc-number">1.5.</span> <span class="toc-text"> 多用户二级域名，短网址，httpdns</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text"> 反向代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.7.</span> <span class="toc-text"> 负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.8.</span> <span class="toc-text"> 动静分离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#urlrewrite"><span class="toc-number">1.9.</span> <span class="toc-text"> urlrewrite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%AA%E9%9D%99%E6%80%81%E5%90%8C%E6%97%B6%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.10.</span> <span class="toc-text"> 伪静态同时负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-number">1.11.</span> <span class="toc-text"> 防盗链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">1.12.</span> <span class="toc-text"> 高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9"><span class="toc-number">1.13.</span> <span class="toc-text"> 扩容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E6%9C%BA%E5%9E%82%E7%9B%B4%E6%89%A9%E5%AE%B9"><span class="toc-number">1.13.1.</span> <span class="toc-text"> 单机垂直扩容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95"><span class="toc-number">1.13.2.</span> <span class="toc-text"> 水平扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95%E9%9B%86%E7%BE%A4%E5%8C%96"><span class="toc-number">1.13.3.</span> <span class="toc-text"> 水平扩展：集群化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keepalive"><span class="toc-number">1.14.</span> <span class="toc-text"> keepalive</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%86%B2"><span class="toc-number">1.15.</span> <span class="toc-text"> 文件 &#x2F; 客户端缓冲</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%BE%97%E7%94%A8%E6%88%B7ip"><span class="toc-number">1.16.</span> <span class="toc-text"> 如何获得用户 IP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gzip-%E5%8E%8B%E7%BC%A9"><span class="toc-number">1.17.</span> <span class="toc-text"> Gzip 压缩</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%8E%8B%E7%BC%A9"><span class="toc-number">1.17.1.</span> <span class="toc-text"> 静态压缩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#brotil"><span class="toc-number">1.17.2.</span> <span class="toc-text"> brotil</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.17.2.1.</span> <span class="toc-text"> 安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#concat%E5%8E%8B%E7%BC%A9%E8%AF%B7%E6%B1%82%E4%B8%AA%E6%95%B0"><span class="toc-number">1.18.</span> <span class="toc-text"> concat 压缩请求个数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-number">1.19.</span> <span class="toc-text"> 资源静态化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%90%88%E5%B9%B6"><span class="toc-number">1.19.1.</span> <span class="toc-text"> 文件合并</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%90%8C%E6%AD%A5"><span class="toc-number">1.19.2.</span> <span class="toc-text"> 静态资源同步</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="toc-number">1.20.</span> <span class="toc-text"> 多级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="toc-number">1.20.1.</span> <span class="toc-text"> 浏览器缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.20.1.1.</span> <span class="toc-text"> 1 下载数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">1.20.1.2.</span> <span class="toc-text"> 2 安装依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%98%E6%96%B9git"><span class="toc-number">1.20.1.2.1.</span> <span class="toc-text"> 官方 git</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx%E6%A8%A1%E5%9D%97"><span class="toc-number">1.20.1.3.</span> <span class="toc-text"> Nginx 模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">1.20.1.4.</span> <span class="toc-text"> Nginx 配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">1.20.2.</span> <span class="toc-text"> 正向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%90%86https%E8%AF%B7%E6%B1%82"><span class="toc-number">1.20.2.1.</span> <span class="toc-text"> 代理 https 请求</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98"><span class="toc-number">1.20.3.</span> <span class="toc-text"> 反向代理缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%B8%85%E7%90%86"><span class="toc-number">1.20.3.1.</span> <span class="toc-text"> 缓存清理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6"><span class="toc-number">1.20.4.</span> <span class="toc-text"> 缓存文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E7%BD%AE%E7%BC%93%E5%AD%98"><span class="toc-number">1.20.5.</span> <span class="toc-text"> 外置缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stream"><span class="toc-number">1.21.</span> <span class="toc-text"> stream</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qps"><span class="toc-number">1.22.</span> <span class="toc-text"> QPS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">1.23.</span> <span class="toc-text"> 日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E6%B8%B8%E6%9C%8D%E5%8A%A1%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">1.24.</span> <span class="toc-text"> 上游服务健康检查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lua"><span class="toc-number">1.25.</span> <span class="toc-text"> Lua</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hello-world"><span class="toc-number">1.25.0.1.</span> <span class="toc-text"> hello world</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E7%95%99%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-number">1.25.0.2.</span> <span class="toc-text"> 保留关键字</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A"><span class="toc-number">1.25.0.3.</span> <span class="toc-text"> 注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">1.25.0.4.</span> <span class="toc-text"> 变量</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.25.0.4.1.</span> <span class="toc-text"> 数字类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.25.0.4.2.</span> <span class="toc-text"> 字符串</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A9%BA%E5%80%BC"><span class="toc-number">1.25.0.4.3.</span> <span class="toc-text"> 空值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.25.0.4.4.</span> <span class="toc-text"> 布尔类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">1.25.0.4.5.</span> <span class="toc-text"> 作用域</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.25.0.5.</span> <span class="toc-text"> 控制语句</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#while%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.25.0.5.1.</span> <span class="toc-text"> while 循环</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#if-else"><span class="toc-number">1.25.0.5.2.</span> <span class="toc-text"> if-else</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#for%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.25.0.5.3.</span> <span class="toc-text"> for 循环</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">1.25.0.5.4.</span> <span class="toc-text"> 函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">1.25.0.6.</span> <span class="toc-text"> 返回值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#table"><span class="toc-number">1.25.0.7.</span> <span class="toc-text"> Table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E7%BB%84"><span class="toc-number">1.25.0.8.</span> <span class="toc-text"> 数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%8D%E5%8E%86"><span class="toc-number">1.25.0.9.</span> <span class="toc-text"> 遍历</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0"><span class="toc-number">1.25.0.10.</span> <span class="toc-text"> 成员函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openresty"><span class="toc-number">1.26.</span> <span class="toc-text"> openresty</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95lua%E8%84%9A%E6%9C%AC"><span class="toc-number">1.26.1.</span> <span class="toc-text"> 测试 lua 脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lua-nginx-module"><span class="toc-number">1.26.2.</span> <span class="toc-text"> lua-nginx-module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6luaconf"><span class="toc-number">1.26.2.1.</span> <span class="toc-text"> 创建配置文件 lua.conf</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">31</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">4</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/03/27/http/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/04/02/Nginx_new/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/05/27/CSRF/" title="CSRF">CSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/12/28/mysql/" title="Mysql">Mysql</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/01/17/Segment%20Routing/" title="Segment Routing">Segment Routing</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%86%85%E7%BD%91/" title="In 内网">内网</a>
</div>

    <span><a href="/2022/05/27/emergency%20response/" title="应急响应">应急响应</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/04/05/Docker/" title="docker">docker</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/" title="水滴rev">水滴rev</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/04/03/iptables2/" title="iptables">iptables</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/11/17/JWT%20%E5%9F%BA%E7%A1%80/" title="JWT">JWT</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/05/17/include/" title="file include">file include</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/02/28/XSS/" title="XSS">XSS</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/04/01/Nginx/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
