



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="逆向" />


<link rel="canonical" href="http://example.com/2023/10/03/hg%20ker/">



  <title>
hg内核 - 逆向 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">hg内核
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2023-10-03 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2023-10-03T13:38:45+08:00">2023-10-03</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/7d1757ae7aca8931bc8769df0287647f.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/d424b2656229a0e3718abfd0a05bbff7.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/49bee8cf2d93684cad9a1acc8bc17d8a.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/1708e15cf2398f98ebe5f305d9d6074a.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/c22bb7736559a7554506b05203018145.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/263cec5f94b8b4f7e818b8b7103a1a84.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E9%80%86%E5%90%91/" itemprop="item" rel="index" title="In 逆向"><span itemprop="name">逆向</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/03/hg%20ker/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p><strong>更新中</strong></p>
<h1 id="hg内核"><a class="markdownIt-Anchor" href="#hg内核">#</a> hg 内核</h1>
<h2 id="环境配置"><a class="markdownIt-Anchor" href="#环境配置">#</a> 环境配置</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">msconfig</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;bcdedit  /copy &#123;current&#125; /d debug</span><br><span class="line">已将该项成功复制到 &#123;9f1759e1-dbea-11ec-93bf-c2eeac6128aa&#125;。</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;bcdedit.exe /displayorder &#123;39ce96d1-40cb-11ee-adc5-e87c8ac93724&#125; /addlast</span><br><span class="line">操作成功完成。</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;bcdedit.exe /dbgsettings SERIAL DEBUGPORT:1 BAUDRATE:115200</span><br><span class="line">操作成功完成。</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;bcdedit.exe /bootdebug &#123;39ce96d0-40cb-11ee-adc5-e87c8ac93724&#125; ON</span><br><span class="line">操作成功完成。</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;bcdedit.exe/debug &#123;39ce96d0-40cb-11ee-adc5-e87c8ac93724&#125; ON</span><br><span class="line">操作成功完成。</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;bcdedit.exe /timeout 30</span><br><span class="line">操作成功完成。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230930200944405.png" alt="image-20230930200944405"></p>
<p>重启需要使用系统重启，不能使用 vm 的重启</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230930201418886.png" alt="image-20230930201418886"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;E:\Windows Kits\10\Debuggers\x64\windbg.exe&quot; -y SRV*E:\symbol*http://msdl.microsoft.com/download/symbols -b -k com:port=//./pipe/com_1,baud=115200,pipe</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230930202041547.png" alt="image-20230930202041547"></p>
<p>开启配置了 debug 引导的虚拟机，并且开启 windbg</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230930202225347.png" alt="image-20230930202225347"></p>
<p>lm</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230930202654966.png" alt="image-20230930202654966"></p>
<p>.reload 根据需要加载符号</p>
<p>ld * 加载全部符号</p>
<p>安装 wdm 后，创建 wdm driver</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001204151853.png" alt="image-20231001204151853"></p>
<p>关闭 spectre</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001205417683.png" alt="image-20231001205417683"></p>
<p>关闭警告</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001205358986.png" alt="image-20231001205358986"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001205508311.png" alt="image-20231001205508311"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001205756116.png" alt="image-20231001205756116"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;11111111111111&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;22222&quot;</span>);</span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="保护模式"><a class="markdownIt-Anchor" href="#保护模式">#</a> 保护模式</h2>
<h3 id="cpu"><a class="markdownIt-Anchor" href="#cpu">#</a> CPU</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001220009107.png" alt="image-20231001220009107"></p>
<p>8086 实现了一半的保护模式，80386 完全实现保护模式</p>
<p>80486  奔腾  引入超线程  1 个 物理核虚拟出两个逻辑 cpu。寄存器，流水线，多了二级缓存</p>
<p>CPU 架构</p>
<p>RISC：移动端 ARM，定长硬编码，低耗电，一页 2kb，三级流水线</p>
<p>CISC：PC 端，变长硬编码，支持更多指令集，至少有五级流水线，一页是 4kb</p>
<p>CISC 架构指令执行过程</p>
<p>取指令，指令译码，访存取数，指令执行，结果写回</p>
<p>流水线</p>
<p>当大 jmp 到一个 eip 时，会清空局部缓存，局部缓存大约能存 9-32 条指令。执行预取，缓存指令</p>
<p>通过 JCC 跳转不会清空局部缓存，jmp 可以跳 2G，清空局部缓存</p>
<p>实模式下 ，段地址 * 0x10 + 逻辑地址 = 线性地址，导致可以跨进程修改内存</p>
<p>保护模式有 gdt 表，标识权限。多个进程共享一个内核</p>
<h3 id="段寄存器"><a class="markdownIt-Anchor" href="#段寄存器">#</a> 段寄存器</h3>
<p>保护模式下一共有六个段寄存器，实模式只有四个</p>
<p>实模式：</p>
<p>CS (Code Segment)：代码段寄存器；<br>
  DS (Data Segment)：数据段寄存器；<br>
  SS (Stack Segment)：堆栈段寄存器；<br>
  ES (Extra Segment)：附加段寄存器；</p>
<p>保护模式：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002212824591.png" alt="image-20231002212824591"></p>
<p>32 位下没有 GS，GS 是 64 位下用的</p>
<p>段名称后面的数字是段选择子</p>
<p>全局变量是 ds 段描述的，局部变量是 ss 描述的</p>
<p>段是有权限的，读写执行</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DWORD value = <span class="number">100</span>;</span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	value = <span class="number">1000</span>;</span><br><span class="line">	__asm&#123;   <span class="comment">// x86中插入内联汇编</span></span><br><span class="line">		mov ax,cs</span><br><span class="line">		mov ds,ax</span><br><span class="line">		mov eax,<span class="number">100</span></span><br><span class="line">		mov dword ptr ds:[value],eax    <span class="comment">// CS 没有写的属性</span></span><br><span class="line">		mov ax,es      <span class="comment">// DS 和 ES 段选择子此处相同，可以用ES还原被修改为CS的DS</span></span><br><span class="line">		mov ds,ax</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; r				// 看寄存器</span><br><span class="line">rax=000000000000ea01 rbx=00000000002001d1 rcx=0000000000000001</span><br><span class="line">rdx=0000000000000073 rsi=00000000000186a0 rdi=fffff80004005e80</span><br><span class="line">rip=fffff80003e8b490 rsp=fffff800054c3888 rbp=fffff78000000320</span><br><span class="line"> r8=fffffa8018df2000  r9=0000000000000072 r10=00000000ffffffff</span><br><span class="line">r11=fffff800054c3770 r12=0000000000000000 r13=fffff800054c39c0</span><br><span class="line">r14=0000000000000004 r15=0000000000000001</span><br><span class="line">iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">fffff800`03e8b490 cc              int     3</span><br><span class="line"></span><br><span class="line">kd&gt; r gdtr 			// windbg的寄存器</span><br><span class="line">gdtr=fffff800054bc000</span><br><span class="line"></span><br><span class="line">kd&gt; dq fffff800054bc000				// 看内存 db dw dd dq</span><br><span class="line">fffff800`054bc000  00000000`00000000 00000000`00000000</span><br><span class="line">fffff800`054bc010  00209b00`00000000 00cf9300`0000ffff</span><br><span class="line">fffff800`054bc020  00cffb00`0000ffff 00cff300`0000ffff</span><br><span class="line">fffff800`054bc030  0020fb00`00000000 00000000`00000000</span><br><span class="line">fffff800`054bc040  05008b4b`d0800067 00000000`fffff800</span><br><span class="line">fffff800`054bc050  ff40f3fd`a0003c00 00000000`00000000</span><br><span class="line">fffff800`054bc060  00cf9a00`0000ffff 00000000`00000000</span><br><span class="line">fffff800`054bc070  00000000`00000000 00000000`00000000</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">0: kd&gt; r</span><br><span class="line">eax=00000001 ebx=00026160 ecx=863f8c78 edx=00000000 esi=83f36d20 edi=83f38654</span><br><span class="line">eip=83e86110 esp=83f33b14 ebp=83f33b48 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=0008  ss=0010  ds=0023  es=0023  fs=0030  gs=0000             efl=00000202</span><br><span class="line">0: kd&gt; r gdtr</span><br><span class="line">gdtr=80b99000</span><br><span class="line">0: kd&gt; dq 80b99000</span><br><span class="line">80b99000  00000000`00000000 00cf9b00`0000ffff</span><br><span class="line">80b99010  00cf9300`0000ffff 00cffb00`0000ffff</span><br><span class="line">80b99020  00cff300`0000ffff 80008b1e`400020ab</span><br><span class="line">80b99030  834093f3`6c003748 0040f300`00000fff</span><br><span class="line">80b99040  0000f200`0400ffff 00000000`00000000</span><br><span class="line">80b99050  830089f3`40000068 830089f3`40680068</span><br><span class="line">80b99060  00000000`00000000 00000000`00000000</span><br><span class="line">80b99070  800092b9`900003ff 00000000`00000000</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003204330216.png" alt="image-20231003204330216"></p>
<p>LDT：  local Descriptor table</p>
<p>GDT： Global Descriptor table</p>
<p>DS == 23 == 0010 0011</p>
<p>RPL==11</p>
<p>TI == 0   // =0 查 GDT，=1 查 LDT</p>
<p>Index == 0010 0  == 0x04   // 查 GDT 第四项   <code>00cff300</code> 0000ffff`</p>
<p><code>00cff300</code> 0000ffff`</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003204845003.png" alt="image-20231003204845003"></p>
<p>Segment Limit:   f ffff</p>
<p>Base Address:  0000 0000   基址</p>
<p>type: 3</p>
<p>s:1    系统段为 0 普通段为 1</p>
<p>DPL:3</p>
<p>P:1		段有效标识，=1 段有效</p>
<p>AVL: 0</p>
<p>D/B:1</p>
<p>G:1</p>
<p>type:3</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003205741643.png" alt="image-20231003205741643"></p>
<p>A 是否被访问过。数据段至少是可读的</p>
<p>快速定位 gdtr 表中位置  1B (段选择子)  &amp; fff8 = x = 18</p>
<p>dq $(gdtr) + x  == 00cffb00`0000ffff</p>
<p>CS:1B</p>
<p>base: 00000000</p>
<p>limit: fffff</p>
<p>type: b  // 没有写权限</p>
<p>s:1</p>
<p>DPL: 3</p>
<p>P:1</p>
<p>AVL: 0</p>
<p>D/B:1</p>
<p>G:1</p>
<h4 id="实验"><a class="markdownIt-Anchor" href="#实验">#</a> 实验：</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; eq 80b99000+0x48 00cff300`0001ffff 	// 修改内存</span><br><span class="line">kd&gt; dq 80b99000+0x48   </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DWORD value = 0x100;</span><br><span class="line">DWORD value2 = 0;</span><br><span class="line">__asm&#123;</span><br><span class="line">    mov ax, 0x4b</span><br><span class="line">    mov ds,ax</span><br><span class="line">    mov eax,dword ptr ds:[value]		// eax值错乱</span><br><span class="line">    mov value2, eax</span><br><span class="line">    mov ax,es</span><br><span class="line">    mov ds,ax			// 还原后base值 变回0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>[00277000] 逻辑地址</p>
<p>逻辑地址会和 base 相加</p>
<p>如果 base 不是 0</p>
<p>会变成 [00277000 + base] 导致值变了</p>
<p>但是最后会还原 ds 的值，只是中断在那行的时候值会变</p>
<p>gdt hook 改 base</p>
<p>hook int 3</p>
<p>base + idt.offset = 0x48</p>
<p>0x12345678 - idt.offset = value</p>
<p>gdt.48.base = value</p>
<h3 id="db_g"><a class="markdownIt-Anchor" href="#db_g">#</a> DB_G</h3>
<p>64 位中没有 limit 和 base</p>
<h4 id="g"><a class="markdownIt-Anchor" href="#g">#</a> G</h4>
<p>1 页 = 4096 字节</p>
<p>G= 1 时，fffff 的单位是页 ，范围 (0xfffff+1) * 0x1000 == 0x100000000 - 1 = 0xffff ffff</p>
<p>G=0 按照字节为单位</p>
<h4 id="db"><a class="markdownIt-Anchor" href="#db">#</a> D/B</h4>
<p>default/bit</p>
<p>D/B 描述 CS 时：</p>
<p>D/B = 1 寻址空间为 32 位</p>
<p>D/B = 0 16 位</p>
<p>更变 cs， jmp 0x4b:402344</p>
<p>此时 push 的时候压栈只压 2 字节</p>
<p>进入内核的时候会修复所有段选择子，退出的时候在恢复</p>
<p>D/B 描述数据段时     数据段 + 堆栈段</p>
<p>D/B = 0 此时寻址宽度变为 16 位，esp 变为 sp，此时 push 的时候程序会直接崩溃，因为系统可访问的最低地址是 0x10000。此时 limit 描述的范围不能访问</p>
<p>DB = 1 32 位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">eq gdtr+0x48  008ff300`0000ffff</span><br><span class="line"></span><br><span class="line">mov ax,0x4b</span><br><span class="line">mov ds,ax</span><br><span class="line">push 0   // 正常访问</span><br><span class="line"></span><br><span class="line">eq gdtr+0x48  008ff600`0000ffff</span><br><span class="line">mov ax,0x4b</span><br><span class="line">mov ds,ax</span><br><span class="line">push 0   // 异常</span><br><span class="line"></span><br><span class="line">eq gdtr+0x48  00c0f600`00000000</span><br><span class="line">mov ax,0x4b</span><br><span class="line">mov ds,ax</span><br><span class="line">push 0   // 异常</span><br></pre></td></tr></table></figure>
<p>type =2 的时候，如果访问过，会自动变成 3 (accessed)</p>
<p>DB=0 limit 描述的区域都不能访问，向下扩展</p>
<p>DB=1 描述的区域可以访问，向上扩展</p>
<p>DB=0，limit=0 全部可以访问</p>
<p>DB=0，type=6，limit=fffff ，全部都不能访问</p>
<p>向上扩展： 没有描述的区域可以访问。</p>
<p>向下扩展：描述的区域可以访问</p>
<p>保护模式分为</p>
<p>段页模式</p>
<p>纯段模式</p>
<p>纯段模式下：一致代码段：R3 直接调用 R0   非一致代码段：</p>
<h3 id="权限检测"><a class="markdownIt-Anchor" href="#权限检测">#</a> 权限检测</h3>
<p>关闭增量连接，只有 debug 有</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004203140286.png" alt="image-20231004203140286"></p>
<h4 id="裸函数"><a class="markdownIt-Anchor" href="#裸函数">#</a> 裸函数</h4>
<p>64 位没有裸函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void __declspec(naked) test2()</span><br><span class="line">&#123;</span><br><span class="line">	int x;   // 有些编译器不能这么写，因为没提升堆栈</span><br><span class="line">	__asm&#123;</span><br><span class="line">		ret</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>裸函数没有对堆栈做操作，如果在裸函数中没有保存现场用堆栈会出问题</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006202157199.png" alt="image-20231006202157199"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006202220240.png" alt="image-20231006202220240"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006202344305.png" alt="image-20231006202344305"></p>
<p>DPL 段描述权限</p>
<p>RPL：request privilege level 看当前指令的段描述符   比如 mov dword ptr ds:[],0x12345678 ，DS 描述的这条，此时 RPL 为 DS 的 RPL</p>
<p>CPL：current privilege level 当前权限    值为 CS  SS 的 RPL。两个 RPL 必须一致</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006202616101.png" alt="image-20231006202616101"></p>
<p>ring0 - ring3</p>
<p>r0 权限最大</p>
<p>主流操作系统只有 R0 和 R3</p>
<p>VMware 特权级在 R1 早期，虚拟机操作系统在 R1</p>
<p>CS/SS 最后一位代表在几环  B 1011   3   0011        11 在 ring3</p>
<p>数据段取决于 CPL，CPL 数值上 &lt;= DPL 就可以访问到</p>
<p>RPL = 0 ,CPL = 3 ,DPL = 3 可以请求到，RPL 在数据段意义不大</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">eq gdtr+48  008ff300`0000ffff</span><br><span class="line"></span><br><span class="line">mov ax,0x48</span><br><span class="line">mov ds,ax</span><br><span class="line">mov edx,dword ptr ds:[eax]</span><br><span class="line">// dpl &lt; cpl = rpl</span><br><span class="line">// </span><br></pre></td></tr></table></figure>
<p>堆栈段 CPL=RPL=DPL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov ax,0x48</span><br><span class="line">mov ss,ax</span><br><span class="line">mov edx,dword ptr ss:[esp]</span><br><span class="line">// 不能改</span><br></pre></td></tr></table></figure>
<p>代码段 CPL=RPL=DPL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jmp far 4b:410112</span><br><span class="line">// 不会异常，但也不会提权</span><br></pre></td></tr></table></figure>
<h4 id="jmp-call-ref"><a class="markdownIt-Anchor" href="#jmp-call-ref">#</a> jmp call ref</h4>
<p>实验时关闭随机基址，链接器 -&gt; 高级 -&gt; 随机基址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">jmp far 0x48:0x401000  // 不能这样在编译器里面写代码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void __declspec(naked) test1()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		pop eax</span><br><span class="line">		jmp eax</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">char buf[] = &#123;0,0,0,0,0x48,0&#125;</span><br><span class="line">*(int *)&amp;buf[0] = (ULONG)test1;</span><br><span class="line">__asm&#123;</span><br><span class="line">	lea eax,[haha]</span><br><span class="line">	push eax</span><br><span class="line">	jmp fword ptr buf</span><br><span class="line">haha:</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>jmp call 没法同时修改 cs 和 ss，所以不能提权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void __declspec(naked) test1()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		retf    // 远返回，pop 8字节</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">char buf[] = &#123;0,0,0,0,0x48,0&#125;</span><br><span class="line">*(int *)&amp;buf[0] = (ULONG)test1;</span><br><span class="line">__asm&#123;</span><br><span class="line">	call fword ptr buf</span><br><span class="line">	// 会压入返回地址和CS的段选择子，跨段不提权的call 会压8个字节</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>call 过去 jmp 回来</p>
<h3 id="调用门"><a class="markdownIt-Anchor" href="#调用门">#</a> 调用门</h3>
<p>系统段在 GDT 中分成任务段和调用门</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006214637792.png" alt="image-20231006214637792"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006214841959.png" alt="image-20231006214841959"></p>
<p>函数的逻辑地址：offset in segment</p>
<p>段选择子：segment selector  0 环默认 08</p>
<p>param count 调用门压入参数</p>
<p>type：1100 32-bit call gate</p>
<p>DPL：门权限，=3，同等权限才能进入</p>
<p>组装调用门描述符</p>
<p>00401000</p>
<p>0040ec00`00081000</p>
<p>call 0x48:0x0     如果是调用门，偏移是 offset in segment，后面的 0x 随便写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">typedef int (__CRTDECL *xxxxx)(_In_z_ _Printf_format_string_ char const* const _Format,...);</span><br><span class="line">xxxxx x1 = NULL;</span><br><span class="line">char* strings = &quot;sssssss&quot;;</span><br><span class="line"></span><br><span class="line">void __declspec(naked) test1()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		push fs</span><br><span class="line">		int 3  			// esp 959deca0  数据段不区分3和0</span><br><span class="line">		pop fs</span><br><span class="line">		retf</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	x1 = (xxxxx)0x83e5141f;    // DbgPrint的地址</span><br><span class="line">	char buf[] = &#123;0,0,0,0,0x48,0&#125;</span><br><span class="line">	system(&quot;pause&quot;);</span><br><span class="line">    __asm&#123;</span><br><span class="line">    	mov eax,esp				// esp 12fe50</span><br><span class="line">		call fword ptr buf	     // 这里f10是单步不进去的</span><br><span class="line">haha:</span><br><span class="line">	&#125;</span><br><span class="line">	system(&quot;pause&quot;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dds   959deca0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 跨段提权</span><br><span class="line">401088		// 返回地址</span><br><span class="line">1b			// cs</span><br><span class="line">12fe50		// 保留3环esp</span><br><span class="line">23			// SS </span><br><span class="line"></span><br><span class="line">// 跨段不提权</span><br><span class="line">401088		// 返回地址</span><br><span class="line">1b			// cs</span><br></pre></td></tr></table></figure>
<p>跨段提权会压入四个值，不提权两个值</p>
<p>int 3 会修改 fs 为 30 ，内核层不会还原原来的 fs</p>
<p>u nt!DbgPrint   // 证明提权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">typedef int (__CRTDECL *xxxxx)(_In_z_ _Printf_format_string_ char const* const _Format,...);</span><br><span class="line">xxxxx x1 = NULL;</span><br><span class="line">char* strings = &quot;sssssss&quot;;</span><br><span class="line"></span><br><span class="line">void __declspec(naked) test1()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		push fs		// 进入ring 0之前fs是0x3b</span><br><span class="line">		mov ax, 0x30</span><br><span class="line">		mov fs,ax</span><br><span class="line">		mov eax,[strings]</span><br><span class="line">		push eax</span><br><span class="line">		call x1</span><br><span class="line">		add esp,4</span><br><span class="line">		//int 3 </span><br><span class="line">		pop fs</span><br><span class="line">		retf</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	x1 = (xxxxx)0x83e5141f;    // DbgPrint的地址</span><br><span class="line">	char buf[] = &#123;0,0,0,0,0x48,0&#125;</span><br><span class="line">	system(&quot;pause&quot;);</span><br><span class="line">    __asm&#123;</span><br><span class="line">    	mov eax,esp				// esp 12fe50</span><br><span class="line">		call fword ptr buf	     // 这里f10是单步不进去的</span><br><span class="line">haha:</span><br><span class="line">	&#125;</span><br><span class="line">	system(&quot;pause&quot;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数个数 0-31</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">返回地址</span><br><span class="line">CS</span><br><span class="line">参数1</span><br><span class="line">参数2</span><br><span class="line">ESP</span><br><span class="line">SS</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">eq gdtr+0x48 0040ec01`00081000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">typedef int (__CRTDECL *xxxxx)(_In_z_ _Printf_format_string_ char const* const _Format,...);</span><br><span class="line">xxxxx x1 = NULL;</span><br><span class="line">char* strings = &quot;sssssss&quot;;</span><br><span class="line"></span><br><span class="line">void __declspec(naked) test1()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		//int 3</span><br><span class="line">		push fs		// 进入ring 0之前fs是0x3b</span><br><span class="line">		int 3</span><br><span class="line">		pop fs</span><br><span class="line">		retf   // 跨段提权时 平衡自身esp和跨段之前的esp</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	x1 = (xxxxx)0x83e5141f;    // DbgPrint的地址</span><br><span class="line">	char buf[] = &#123;0,0,0,0,0x48,0&#125;</span><br><span class="line">	system(&quot;pause&quot;);</span><br><span class="line">    __asm&#123;</span><br><span class="line">    	push 0x111111</span><br><span class="line">		call fword ptr buf	     // 这里f10是单步不进去的</span><br><span class="line">haha:</span><br><span class="line">	&#125;</span><br><span class="line">	system(&quot;pause&quot;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>retf 在跨段提权的时候平衡的 esp 有自身的和跨段之前的  retf 4</p>
<p>用 jmp</p>
<h3 id="中断门"><a class="markdownIt-Anchor" href="#中断门">#</a> 中断门</h3>
<p>call jmp 只能在同等权限下，或者低权限往高权限跳转。jmp 不能提权调用门</p>
<p>retf iret 只能在同等权限下，或者高权限往低权限跳</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009222709758.png" alt="image-20231009222709758" style="zoom:50%;" /> 
<p>D 默认是 1  default</p>
<p>1110 32bit interrupt gate</p>
<p>可屏蔽中断 / 不可屏蔽中断</p>
<p>ELF 中第十位 IF， =0 不接收可屏蔽中断信号</p>
<p>比如关机 是不可屏蔽中断</p>
<p>键盘 USB 可屏蔽中断</p>
<p>中断在 intel 中至少有 32 种中断</p>
<p>中断在 IDT 中存放，但是中断门的段选择子还是查 GDT</p>
<p>IDT：中断描述表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; r idtr   // interrupt descriptor table</span><br><span class="line">idtr=80b99400</span><br><span class="line"></span><br><span class="line">0: kd&gt; dq 80b99400</span><br><span class="line">ReadVirtual: 80b99400 not properly sign extended</span><br><span class="line">80b99400  83e48e00`00081fc0 83e48e00`00082150</span><br><span class="line">80b99410  00008500`00580000 83e4ee00`000825c0   // 83e4ee00`000825c0  == int 3</span><br><span class="line">80b99420  83e4ee00`00082748 83e48e00`000828a8 </span><br><span class="line">80b99430  83e48e00`00082a1c 83e48e00`00083018</span><br><span class="line">80b99440  00008500`00500000 83e48e00`00083478</span><br><span class="line">80b99450  83e48e00`0008359c 83e48e00`000836dc</span><br><span class="line">80b99460  83e48e00`0008393c 83e48e00`00083c2c</span><br><span class="line">80b99470  83e48e00`000842fc 83e48e00`000846b0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0: kd&gt; !idt</span><br><span class="line">Dumping IDT: 80b99400</span><br><span class="line">b7a341b100000037:	8422f104 </span><br><span class="line">b7a341b100000051:	871a6a58 0xffffffff88f02254 (KINTERRUPT 871a6a00)</span><br><span class="line">b7a341b100000052:	871b57d8 0xffffffff88f02254 (KINTERRUPT 871b5780)</span><br><span class="line">b7a341b100000053:	871c0558 0xffffffff88f02254 (KINTERRUPT 871c0500)</span><br><span class="line">b7a341b100000054:	871cb2d8 0xffffffff88f02254 (KINTERRUPT 871cb280)</span><br><span class="line">b7a341b100000055:	871db558 0xffffffff88fc4b72 (KINTERRUPT 871db500)</span><br><span class="line">b7a341b100000060:	871a6cd8 0xffffffff88f02254 (KINTERRUPT 871a6c80)</span><br><span class="line">b7a341b100000061:	8758b558 &lt;Unloaded_serial.sys&gt;+0x2cf9 (KINTERRUPT 8758b500)</span><br><span class="line">b7a341b100000062:	871b5a58 0xffffffff88f02254 (KINTERRUPT 871b5a00)</span><br><span class="line">b7a341b100000063:	871c07d8 0xffffffff88f02254 (KINTERRUPT 871c0780)</span><br><span class="line">b7a341b100000064:	871cb558 0xffffffff88f02254 (KINTERRUPT 871cb500)</span><br><span class="line">b7a341b100000065:	871db058 0xffffffff88da148a (KINTERRUPT 871db000)</span><br><span class="line">b7a341b100000066:	8758b7d8 0xffffffffa4f727ab (KINTERRUPT 8758b780)</span><br><span class="line">b7a341b100000070:	8735c058 0xffffffff88f02254 (KINTERRUPT 8735c000)</span><br><span class="line">b7a341b100000071:	8758ba58 &lt;Unloaded_serial.sys&gt;+0x749a (KINTERRUPT 8758ba00)</span><br><span class="line">b7a341b100000072:	871b5cd8 0xffffffff88f02254 (KINTERRUPT 871b5c80)</span><br><span class="line">b7a341b100000073:	871c0a58 0xffffffff88f02254 (KINTERRUPT 871c0a00)</span><br><span class="line">b7a341b100000074:	871cb7d8 0xffffffff88f02254 (KINTERRUPT 871cb780)</span><br><span class="line">b7a341b100000075:	871db2d8 0xffffffff88da148a (KINTERRUPT 871db280)</span><br><span class="line">b7a341b100000076:	87713cd8 0xffffffffa4fdbf00 (KINTERRUPT 87713c80)</span><br><span class="line">	         0xffffffffa4e87d47 (KINTERRUPT 87713a00)</span><br><span class="line">b7a341b100000080:	8735c2d8 0xffffffff88f02254 (KINTERRUPT 8735c280)</span><br><span class="line">b7a341b100000082:	871a6058 0xffffffff88f02254 (KINTERRUPT 871a6000)</span><br><span class="line">b7a341b100000083:	871c0cd8 0xffffffff88f02254 (KINTERRUPT 871c0c80)</span><br><span class="line">b7a341b100000084:	871cba58 0xffffffff88f02254 (KINTERRUPT 871cba00)</span><br><span class="line">b7a341b100000085:	871db7d8 0xffffffff88f02254 (KINTERRUPT 871db780)</span><br><span class="line">b7a341b100000086:	8758b058 0xffffffffa4f727ab (KINTERRUPT 8758b000)</span><br><span class="line">b7a341b100000090:	8735c558 0xffffffff88f02254 (KINTERRUPT 8735c500)</span><br><span class="line">b7a341b100000092:	871a62d8 0xffffffff88f02254 (KINTERRUPT 871a6280)</span><br><span class="line">b7a341b100000093:	871b5058 0xffffffff88f02254 (KINTERRUPT 871b5000)</span><br><span class="line">b7a341b100000094:	871cbcd8 0xffffffff88f02254 (KINTERRUPT 871cbc80)</span><br><span class="line">b7a341b100000095:	871dba58 0xffffffff88f02254 (KINTERRUPT 871dba00)</span><br><span class="line">b7a341b100000096:	87235a58 0xffffffff88da148a (KINTERRUPT 87235a00)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0: kd&gt; !idt 3</span><br><span class="line">Dumping IDT: 80b99400</span><br><span class="line">b7a341b100000003:	83e425c0 nt!KiTrap03</span><br><span class="line"></span><br><span class="line">0: kd&gt; u 83e425c0 L 30</span><br><span class="line">83e425c0 6a00            push    0</span><br><span class="line">83e425c2 66c74424020000  mov     word ptr [esp+2],0</span><br><span class="line">83e425c9 55              push    ebp</span><br><span class="line">83e425ca 53              push    ebx</span><br><span class="line">83e425cb 56              push    esi</span><br><span class="line">83e425cc 57              push    edi</span><br><span class="line">83e425cd 0fa0            push    fs</span><br><span class="line">83e425cf bb30000000      mov     ebx,30h</span><br><span class="line">83e425d4 668ee3          mov     fs,bx</span><br><span class="line">83e425d7 648b1d00000000  mov     ebx,dword ptr fs:[0]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">83e4ee00`000825c0</span><br><span class="line"></span><br><span class="line">offset 83e425c0</span><br><span class="line"></span><br><span class="line">80b99500  00000000`00080000 00000000`00080000</span><br><span class="line">( 500 - 400 ) / 8 = 0x20 = 32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">可以自定义的第一个中断int 32</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">dq idtr+<span class="number">0x100</span> <span class="number">0040</span>ee00`<span class="number">00081000</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test1</span>()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		<span class="type">int</span> <span class="number">3</span></span><br><span class="line">		<span class="comment">//retf</span></span><br><span class="line">		iretd</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> buf[] = &#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x48</span>,<span class="number">0</span>&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    __asm&#123;</span><br><span class="line">		<span class="type">int</span> <span class="number">32</span></span><br><span class="line">		push <span class="number">0x3b</span></span><br><span class="line">		pop fs</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test1</span>()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		<span class="type">int</span> <span class="number">3</span></span><br><span class="line">		retf <span class="number">4</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> buf[] = &#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x48</span>,<span class="number">0</span>&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    __asm&#123;</span><br><span class="line">		<span class="type">int</span> <span class="number">32</span></span><br><span class="line">		push <span class="number">1</span></span><br><span class="line">		push <span class="number">0x3b</span></span><br><span class="line">		pop fs</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>retf 同时修改 0 环和三环的堆栈平衡</p>
<p>iretd 返回五个值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dds esp</span><br><span class="line">eip</span><br><span class="line">cs</span><br><span class="line">eflag</span><br><span class="line">esp </span><br><span class="line">ss</span><br></pre></td></tr></table></figure>
<h3 id="hook-int3"><a class="markdownIt-Anchor" href="#hook-int3">#</a> hook int3</h3>
<p>ds.base +  逻辑地址 = 线性地址 (目标地址)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; dq 807d3020</span><br><span class="line">ReadVirtual: 807d3020 not properly sign extended</span><br><span class="line">807d3020  83e88e00`00081fc0 83e88e00`00082150</span><br><span class="line">807d3030  00008500`00580000 83e8ee00`000825c0</span><br><span class="line">807d3040  83e8ee00`00082748 83e88e00`000828a8</span><br><span class="line">807d3050  83e88e00`00082a1c 83e88e00`00083018</span><br><span class="line">807d3060  00008500`00500000 83e88e00`00083478</span><br><span class="line">807d3070  83e88e00`0008359c 83e88e00`000836dc</span><br><span class="line">807d3080  83e88e00`0008393c 83e88e00`00083c2c</span><br><span class="line">807d3090  83e88e00`000842fc 83e88e00`000846b0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>d.base =  目标地址 - 逻辑地址</p>
<p>​            = 0x12345678 - 0x83e825c0</p>
<p>因为局部缓存所以会缓存几条指令，需要在这几条指令内跨段跳转 jmp fword ptr</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; r gdtr </span><br><span class="line">gdtr=<span class="number">80b</span>99000</span><br><span class="line"><span class="number">0</span>: kd&gt; dq <span class="number">80b</span>99000</span><br><span class="line"><span class="number">80b</span>99000  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>99010  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>99020  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>1e`<span class="number">400020</span>ab</span><br><span class="line"><span class="number">80b</span>99030  <span class="number">834093f</span>6`ec003748 <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>99040  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>99050  <span class="number">830089f</span>6`c0000068 <span class="number">830089f</span>6`c0680068</span><br><span class="line"><span class="number">80b</span>99060  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>99070  <span class="number">800092b</span>9`<span class="number">900003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; r idtr </span><br><span class="line">idtr=<span class="number">807</span>d3020</span><br><span class="line"><span class="number">1</span>: kd&gt; dq <span class="number">807</span>d3020</span><br><span class="line"><span class="number">807</span>d3020  <span class="number">83e88</span>e00`<span class="number">00081f</span>c0 <span class="number">83e88</span>e00`<span class="number">00082150</span></span><br><span class="line"><span class="number">807</span>d3030  <span class="number">00008500</span>`<span class="number">00580000</span> <span class="number">83e8</span>ee00`<span class="number">000825</span>c0</span><br><span class="line"><span class="number">807</span>d3040  <span class="number">83e8</span>ee00`<span class="number">00082748</span> <span class="number">83e88</span>e00`<span class="number">000828</span>a8</span><br><span class="line"><span class="number">807</span>d3050  <span class="number">83e88</span>e00`<span class="number">00082</span>a1c <span class="number">83e88</span>e00`<span class="number">00083018</span></span><br><span class="line"><span class="number">807</span>d3060  <span class="number">00008500</span>`<span class="number">00500000</span> <span class="number">83e88</span>e00`<span class="number">00083478</span></span><br><span class="line"><span class="number">807</span>d3070  <span class="number">83e88</span>e00`<span class="number">0008359</span>c <span class="number">83e88</span>e00`<span class="number">000836</span>dc</span><br><span class="line"><span class="number">807</span>d3080  <span class="number">83e88</span>e00`<span class="number">0008393</span>c <span class="number">83e88</span>e00`<span class="number">00083</span>c2c</span><br><span class="line"><span class="number">807</span>d3090  <span class="number">83e88</span>e00`<span class="number">000842f</span>c <span class="number">83e88</span>e00`<span class="number">000846b</span>0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">401000</span> - <span class="number">83e945</span>c0(<span class="type">int</span> <span class="number">3</span>) = <span class="built_in">base</span>(<span class="number">7</span>C56 CA40)</span><br><span class="line">eq <span class="number">80b</span>99048 <span class="number">7</span>ccf9b56`ca40ffff			<span class="comment">// 修改gdtr中的 48</span></span><br><span class="line">	</span><br><span class="line">eq <span class="number">80b</span>99418  <span class="number">83e9</span>ee00`<span class="number">004845</span>c0	<span class="comment">// 修改idtr中int3 的段选择子</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; g</span><br><span class="line">Break instruction exception - code <span class="number">80000003</span> (first chance)</span><br><span class="line"><span class="number">001b</span>:<span class="number">004010</span>d4 cc              <span class="type">int</span>     <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">int</span> (__cdecl *DbgPrintf)(_In_z_ _Printf_format_string_ <span class="type">const</span> <span class="type">char</span> * _Format, ...);</span><br><span class="line">DbgPrintf dbgprintf = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">char</span>* shabi = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		sub esp,<span class="number">8</span></span><br><span class="line">		lea eax,haha</span><br><span class="line">		mov [esp],eax</span><br><span class="line">		mov [esp+<span class="number">4</span>],<span class="number">0x8</span></span><br><span class="line">		jmp fword ptr [esp]</span><br><span class="line"></span><br><span class="line">haha:</span><br><span class="line">		add esp, <span class="number">8</span></span><br><span class="line">		push fs</span><br><span class="line">		push <span class="number">0x30</span></span><br><span class="line">		pop fs</span><br><span class="line">		mov eax,[shabi]</span><br><span class="line">		push eax</span><br><span class="line">		call dbgprintf</span><br><span class="line">		add esp,<span class="number">4</span></span><br><span class="line">		pop fs</span><br><span class="line">		mov eax, <span class="number">0x83e945c0</span>		<span class="comment">// int 3</span></span><br><span class="line">		jmp eax</span><br><span class="line">		<span class="comment">// 00401000 - 83e465c0= base(7C5B AA40)</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>,test);</span><br><span class="line"></span><br><span class="line">	dbgprintf = (DbgPrintf)<span class="number">0x83e6441f</span>;</span><br><span class="line"></span><br><span class="line">	shabi = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">30</span>);</span><br><span class="line">	<span class="built_in">memset</span>(shabi,<span class="number">0</span>,<span class="number">30</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(shabi,<span class="string">&quot;shabi!!!!!!!!&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;shabi&quot;</span>));</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	__asm&#123;</span><br><span class="line">		<span class="type">int</span> <span class="number">3</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行的时候不能直接在调试器里运行，直接运行exe</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231014235313749.png" alt="image-20231014235313749"></p>
<h3 id="陷阱门"><a class="markdownIt-Anchor" href="#陷阱门">#</a> 陷阱门</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">0040</span>ee00`<span class="number">00081000</span></span><br><span class="line">eq <span class="number">80b</span>99500  <span class="number">0040</span>ee00`<span class="number">00081000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// xianjingmen.cpp : 定义控制台应用程序的入口点。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> eflags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		pushfd</span><br><span class="line">		pop eax</span><br><span class="line">		mov [eflags],eax</span><br><span class="line">		push fs</span><br><span class="line">		push <span class="number">0x30</span></span><br><span class="line">		pop fs</span><br><span class="line">		<span class="type">int</span> <span class="number">3</span></span><br><span class="line">		pop fs</span><br><span class="line">		iretd</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	eflags = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>,test);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	__asm&#123;</span><br><span class="line">		<span class="type">int</span> <span class="number">32</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%X\r\n&quot;</span>,eflags);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;<span class="comment">// eflag = 46</span></span><br></pre></td></tr></table></figure>
<p>中断门清空 VM TF IF NT	ELF=0x46</p>
<p>陷阱门清空 VM TF NT		ELF=0x246</p>
<p>VM 虚拟 8086   TF 调试位   IF 可屏蔽中断  NT 嵌套任务</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231014002754457.png" alt="image-20231014002754457"></p>
<h3 id="任务段"><a class="markdownIt-Anchor" href="#任务段">#</a> 任务段</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231014195203261.png" alt="image-20231014195203261"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231014195304362.png" alt="image-20231014195304362"></p>
<p>B = busy 当然任务段是否运行，初始 = 0 ，此时 type=9    busy=1 时，type=b，用于判断是否运行过</p>
<p>previous task link ：前一个任务的连接，上一个运行的任务段，类似于链表指向前一个节点的</p>
<p>esp0 ss0  0 环</p>
<p>esp2 2 环</p>
<p>esp 3 环</p>
<p>I/O map base 写死的值，用于 IOPL (ELF) ,=0 读写任意端口</p>
<p>1.22</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line">str          # 获取段寄存器的值</span><br><span class="line"></span><br><span class="line">ltr 寄存器/内存   # 设置</span><br><span class="line">    </span><br><span class="line">CPU没有线程，最小执行单元叫做任务。操作系统中最小执行单元是线程</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; r tr</span><br><span class="line">tr=<span class="number">00000028</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; r gdtr </span><br><span class="line">gdtr=<span class="number">80b</span>99000</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dq <span class="number">80b</span>99000</span><br><span class="line">ReadVirtual: <span class="number">80b</span>99000 <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">80b</span>99000  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00</span>cf9b00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>99010  <span class="number">00</span>cf9300`<span class="number">0000f</span>fff <span class="number">00</span>cffb00`<span class="number">0000f</span>fff</span><br><span class="line"><span class="number">80b</span>99020  <span class="number">00</span>cff300`<span class="number">0000f</span>fff <span class="number">80008b</span>1e`<span class="number">400020</span>ab</span><br><span class="line"><span class="number">80b</span>99030  <span class="number">834093f</span>6`ec003748 <span class="number">0040f</span>300`<span class="number">00000f</span>ff</span><br><span class="line"><span class="number">80b</span>99040  <span class="number">0000f</span>200`<span class="number">0400f</span>fff <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>99050  <span class="number">830089f</span>6`c0000068 <span class="number">830089f</span>6`c0680068</span><br><span class="line"><span class="number">80b</span>99060  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">80b</span>99070  <span class="number">800092b</span>9`<span class="number">900003f</span>f <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt nt!_*TSS*</span><br><span class="line">          ntkrpamp!_KTSS</span><br><span class="line">          </span><br><span class="line"><span class="number">0</span>: kd&gt; dt _KTSS</span><br><span class="line">nt!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : Uint2B</span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : Uint2B</span><br><span class="line">   +<span class="number">0x004</span> Esp0             : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> Ss0              : Uint2B</span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : Uint2B</span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> CR3              : Uint4B</span><br><span class="line">   +<span class="number">0x020</span> Eip              : Uint4B</span><br><span class="line">   +<span class="number">0x024</span> EFlags           : Uint4B</span><br><span class="line">   +<span class="number">0x028</span> Eax              : Uint4B</span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : Uint4B</span><br><span class="line">   +<span class="number">0x030</span> Edx              : Uint4B</span><br><span class="line">   +<span class="number">0x034</span> Ebx              : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> Esp              : Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : Uint4B</span><br><span class="line">   +<span class="number">0x040</span> Esi              : Uint4B</span><br><span class="line">   +<span class="number">0x044</span> Edi              : Uint4B</span><br><span class="line">   +<span class="number">0x048</span> Es               : Uint2B</span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : Uint2B</span><br><span class="line">   +<span class="number">0x04c</span> Cs               : Uint2B</span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : Uint2B</span><br><span class="line">   +<span class="number">0x050</span> Ss               : Uint2B</span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : Uint2B</span><br><span class="line">   +<span class="number">0x054</span> Ds               : Uint2B</span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : Uint2B</span><br><span class="line">   +<span class="number">0x058</span> Fs               : Uint2B</span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : Uint2B</span><br><span class="line">   +<span class="number">0x05c</span> Gs               : Uint2B</span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : Uint2B</span><br><span class="line">   +<span class="number">0x060</span> LDT              : Uint2B</span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : Uint2B</span><br><span class="line">   +<span class="number">0x064</span> Flags            : Uint2B</span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : Uint2B</span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>] UChar</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dg <span class="number">28</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0028</span> <span class="number">801</span>ca000 <span class="number">000020</span>ab TSS32 Busy <span class="number">0</span> Nb By P  Nl <span class="number">0000008b</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt _KTSS <span class="number">801</span>ca000 </span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x8415bcb0</span>  <span class="comment">//</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; r esp</span><br><span class="line">esp=<span class="number">80</span>de6ae4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cr3</span><br><span class="line"><span class="number">393b</span>6000</span><br><span class="line"><span class="number">403378</span></span><br><span class="line"></span><br><span class="line">eq <span class="number">80b</span>95048 <span class="number">0000e940</span>`<span class="number">50300100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; r tr</span><br><span class="line">tr=<span class="number">00000048</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dg <span class="number">28</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0028</span> <span class="number">801</span>ca000 <span class="number">000020</span>ab TSS32 Busy <span class="number">0</span> Nb By P  Nl <span class="number">0000008b</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt _KTSS <span class="number">801</span>ca000 </span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x901e3cb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0x401111</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">0x202</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0x3d5e38</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0x3d0178</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0x12ff2c</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0x12ff44</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0x6e49cbe3</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0x409430</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">0x1b</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0x3b</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;???&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dg <span class="number">48</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0048</span> <span class="number">00403378</span> <span class="number">00000100</span> TSS32 Busy <span class="number">3</span> Nb By P  Nl <span class="number">000000</span>eb</span><br><span class="line"><span class="number">0</span>: kd&gt; dt _KTSS <span class="number">00403378</span> </span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0x28</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x407418</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0x1e033000</span></span><br><span class="line">   +<span class="number">0x020</span> Eip              : <span class="number">0x401000</span></span><br><span class="line">   +<span class="number">0x024</span> EFlags           : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x028</span> Eax              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> Ecx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> Edx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x034</span> Ebx              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x038</span> Esp              : <span class="number">0x409418</span></span><br><span class="line">   +<span class="number">0x03c</span> Ebp              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> Esi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Edi              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> Es               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x04a</span> Reserved2        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x04c</span> Cs               : <span class="number">8</span></span><br><span class="line">   +<span class="number">0x04e</span> Reserved3        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x050</span> Ss               : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x052</span> Reserved4        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x054</span> Ds               : <span class="number">0x23</span></span><br><span class="line">   +<span class="number">0x056</span> Reserved5        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x058</span> Fs               : <span class="number">0x30</span></span><br><span class="line">   +<span class="number">0x05a</span> Reserved6        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05c</span> Gs               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x05e</span> Reserved7        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x060</span> LDT              : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x062</span> Reserved8        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x064</span> Flags            : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x066</span> IoMapBase        : <span class="number">0x20ac</span></span><br><span class="line">   +<span class="number">0x068</span> IoMaps           : [<span class="number">1</span>] _KiIoAccessMap</span><br><span class="line">   +<span class="number">0x208c</span> IntDirectionMap  : [<span class="number">32</span>]  <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="number">0</span>: kd&gt; r esp </span><br><span class="line">esp=<span class="number">00409418</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">efl=<span class="number">00004002</span>			任务嵌套</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 手工修复CR3</span></span><br><span class="line"><span class="number">1</span>: kd&gt; r tr </span><br><span class="line">tr=<span class="number">00000028</span></span><br><span class="line"><span class="number">1</span>: kd&gt; dg <span class="number">28</span> </span><br><span class="line">    </span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0028</span> <span class="number">807</span>cd750 <span class="number">000020</span>ab TSS32 Busy <span class="number">0</span> Nb By P  Nl <span class="number">0000008b</span></span><br><span class="line"><span class="number">1</span>: kd&gt; dt _KTSS <span class="number">807</span>cd750 </span><br><span class="line">ntdll!_KTSS</span><br><span class="line">   +<span class="number">0x000</span> Backlink         : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x002</span> Reserved0        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x004</span> Esp0             : <span class="number">0x807e6cb0</span></span><br><span class="line">   +<span class="number">0x008</span> Ss0              : <span class="number">0x10</span></span><br><span class="line">   +<span class="number">0x00a</span> Reserved1        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> NotUsed1         : [<span class="number">4</span>] <span class="number">0</span></span><br><span class="line">   +<span class="number">0x01c</span> CR3              : <span class="number">0</span></span><br><span class="line">   </span><br><span class="line"><span class="number">1</span>: kd&gt; ed <span class="number">807</span>cd750+<span class="number">1</span>c <span class="number">3e876600</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// renwuduan.cpp : 定义控制台应用程序的入口点。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span></span><br><span class="line">&#123;</span><br><span class="line">	UCHAR DirectionMap[<span class="number">32</span>];                                                 <span class="comment">//0x0</span></span><br><span class="line">	UCHAR IoMap[<span class="number">8196</span>];                                                      <span class="comment">//0x20</span></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_KTSS</span></span><br><span class="line">&#123;</span><br><span class="line">	USHORT Backlink;                                                        <span class="comment">//0x0</span></span><br><span class="line">	USHORT Reserved0;                                                       <span class="comment">//0x2</span></span><br><span class="line">	ULONG Esp0;                                                             <span class="comment">//0x4</span></span><br><span class="line">	USHORT Ss0;                                                             <span class="comment">//0x8</span></span><br><span class="line">	USHORT Reserved1;                                                       <span class="comment">//0xa</span></span><br><span class="line">	ULONG NotUsed1[<span class="number">4</span>];                                                      <span class="comment">//0xc</span></span><br><span class="line">	ULONG CR3;                                                              <span class="comment">//0x1c</span></span><br><span class="line">	ULONG Eip;                                                              <span class="comment">//0x20</span></span><br><span class="line">	ULONG EFlags;                                                           <span class="comment">//0x24</span></span><br><span class="line">	ULONG Eax;                                                              <span class="comment">//0x28</span></span><br><span class="line">	ULONG Ecx;                                                              <span class="comment">//0x2c</span></span><br><span class="line">	ULONG Edx;                                                              <span class="comment">//0x30</span></span><br><span class="line">	ULONG Ebx;                                                              <span class="comment">//0x34</span></span><br><span class="line">	ULONG Esp;                                                              <span class="comment">//0x38</span></span><br><span class="line">	ULONG Ebp;                                                              <span class="comment">//0x3c</span></span><br><span class="line">	ULONG Esi;                                                              <span class="comment">//0x40</span></span><br><span class="line">	ULONG Edi;                                                              <span class="comment">//0x44</span></span><br><span class="line">	USHORT Es;                                                              <span class="comment">//0x48</span></span><br><span class="line">	USHORT Reserved2;                                                       <span class="comment">//0x4a</span></span><br><span class="line">	USHORT Cs;                                                              <span class="comment">//0x4c</span></span><br><span class="line">	USHORT Reserved3;                                                       <span class="comment">//0x4e</span></span><br><span class="line">	USHORT Ss;                                                              <span class="comment">//0x50</span></span><br><span class="line">	USHORT Reserved4;                                                       <span class="comment">//0x52</span></span><br><span class="line">	USHORT Ds;                                                              <span class="comment">//0x54</span></span><br><span class="line">	USHORT Reserved5;                                                       <span class="comment">//0x56</span></span><br><span class="line">	USHORT Fs;                                                              <span class="comment">//0x58</span></span><br><span class="line">	USHORT Reserved6;                                                       <span class="comment">//0x5a</span></span><br><span class="line">	USHORT Gs;                                                              <span class="comment">//0x5c</span></span><br><span class="line">	USHORT Reserved7;                                                       <span class="comment">//0x5e</span></span><br><span class="line">	USHORT LDT;                                                             <span class="comment">//0x60</span></span><br><span class="line">	USHORT Reserved8;                                                       <span class="comment">//0x62</span></span><br><span class="line">	USHORT Flags;                                                           <span class="comment">//0x64</span></span><br><span class="line">	USHORT IoMapBase;                                                       <span class="comment">//0x66</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">_KiIoAccessMap</span> IoMaps[<span class="number">1</span>];                                        <span class="comment">//0x68</span></span><br><span class="line">	UCHAR IntDirectionMap[<span class="number">32</span>];                                              <span class="comment">//0x208c</span></span><br><span class="line">&#125;KTSS,*PKTSS;; </span><br><span class="line"></span><br><span class="line">KTSS tss = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> bufesp0[<span class="number">0x2000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">char</span> bufesp3[<span class="number">0x2000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test</span>()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> <span class="number">3</span></span><br><span class="line">		pushfd		<span class="comment">// repair eflag</span></span><br><span class="line">		pop eax</span><br><span class="line">		<span class="keyword">or</span> eax,<span class="number">0x4000</span></span><br><span class="line">		push eax</span><br><span class="line">		popfd</span><br><span class="line">		iretd</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">short</span> trxx = <span class="number">0</span>;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		str trxx    <span class="comment">// get segment descriptor  = 0x28</span></span><br><span class="line">		ltr trxx    <span class="comment">// edit tr ,ring 3 no privilege</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(bufesp0,<span class="number">0</span>,<span class="number">0x02000</span>);</span><br><span class="line">	<span class="built_in">memset</span>(bufesp3,<span class="number">0</span>,<span class="number">0x02000</span>);</span><br><span class="line">	tss.Esp0 = (ULONG)bufesp0 + <span class="number">0x1ff0</span>;  <span class="comment">//堆栈是从下往上分配的，所以需要分配到堆栈最底段</span></span><br><span class="line">	tss.Esp = (ULONG)bufesp3 + <span class="number">0x1ff0</span>;</span><br><span class="line">	tss.Ss0 = <span class="number">0x10</span>;</span><br><span class="line">	tss.Ss = <span class="number">0x10</span>;			<span class="comment">// 提权 </span></span><br><span class="line">	tss.Cs = <span class="number">0x8</span>;</span><br><span class="line">	tss.Ds = <span class="number">0x23</span>;</span><br><span class="line">	tss.Es = <span class="number">0x23</span>;</span><br><span class="line">	tss.Fs = <span class="number">0x30</span>;</span><br><span class="line">	tss.EFlags = <span class="number">0x2</span>;</span><br><span class="line">	tss.Eip = (ULONG)test;</span><br><span class="line">	tss.IoMapBase = <span class="number">0x20ac</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;cr3\r\n&quot;</span>);</span><br><span class="line">	DWORD dwcr3 = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%x&quot;</span>,&amp;dwcr3);</span><br><span class="line">	tss.CR3 = dwcr3;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%X\r\n&quot;</span>,&amp;tss);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> bufcode[] = &#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x68</span>,<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	__asm&#123;</span><br><span class="line">		call fword ptr bufcode</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>CPU 中最小执行单元叫做任务，操作系统中叫做线程</p>
<p>一个进程本质来说就是一个任务，在 CPU 看来</p>
<p>任务本质上就是切换寄存器</p>
<p>64 位任务段被废弃，作为别的用处</p>
<p>int 3 把 nt 清了，导致无法返回</p>
<p>iretd 首先检测 NT 为，如果等于 0 就按照堆栈返回</p>
<p>如果 NT=1，就按照 backlink 找到要回去的上下文环境</p>
<h3 id="任务门"><a class="markdownIt-Anchor" href="#任务门">#</a> 任务门</h3>
<p>gdtr 中 10 和 40 都是任务门</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1827556-20200307193208249-33161271.png" alt="img"></p>
<p>type = 5</p>
<p>TSS S S = 任务段段选择子</p>
<p>int 8 双重异常！idt 8</p>
<p>task selector = 0x50</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !idt 8</span><br><span class="line"></span><br><span class="line">Dumping IDT: 80b99400</span><br><span class="line"></span><br><span class="line">bfe94bd900000008:	Task Selector = 0x0050</span><br><span class="line"></span><br><span class="line">0: kd&gt; dg 50</span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line">0050 83f40000 00000068 TSS32 Avl  0 Nb By P  Nl 00000089</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _KTSS 83f40000 </span><br><span class="line">nt!_KTSS</span><br><span class="line">   +0x000 Backlink         : 0</span><br><span class="line">   +0x002 Reserved0        : 0</span><br><span class="line">   +0x004 Esp0             : 0x83f3d000</span><br><span class="line">   +0x008 Ss0              : 0x10</span><br><span class="line">   +0x00a Reserved1        : 0</span><br><span class="line">   +0x00c NotUsed1         : [4] 0</span><br><span class="line">   +0x01c CR3              : 0x185000</span><br><span class="line">   +0x020 Eip              : 0x83e57357</span><br><span class="line">   +0x024 EFlags           : 0</span><br><span class="line">   +0x028 Eax              : 0</span><br><span class="line">   +0x02c Ecx              : 0</span><br><span class="line">   +0x030 Edx              : 0</span><br><span class="line">   +0x034 Ebx              : 0</span><br><span class="line">   +0x038 Esp              : 0x83f3d000</span><br><span class="line">   +0x03c Ebp              : 0</span><br><span class="line">   +0x040 Esi              : 0</span><br><span class="line">   +0x044 Edi              : 0</span><br><span class="line">   +0x048 Es               : 0x23</span><br><span class="line">   +0x04a Reserved2        : 0</span><br><span class="line">   +0x04c Cs               : 8</span><br><span class="line">   +0x04e Reserved3        : 0</span><br><span class="line">   +0x050 Ss               : 0x10</span><br><span class="line">   +0x052 Reserved4        : 0</span><br><span class="line">   +0x054 Ds               : 0x23</span><br><span class="line">   +0x056 Reserved5        : 0</span><br><span class="line">   +0x058 Fs               : 0x30</span><br><span class="line">   +0x05a Reserved6        : 0</span><br><span class="line">   +0x05c Gs               : 0</span><br><span class="line">   +0x05e Reserved7        : 0</span><br><span class="line">   +0x060 LDT              : 0</span><br><span class="line">   +0x062 Reserved8        : 0</span><br><span class="line">   +0x064 Flags            : 0</span><br><span class="line">   +0x066 IoMapBase        : 0x20ac</span><br><span class="line">   +0x068 IoMaps           : [1] _KiIoAccessMap</span><br><span class="line">   +0x208c IntDirectionMap  : [32]  &quot;???&quot;</span><br><span class="line"></span><br><span class="line">// 代码和上节课一样</span><br><span class="line"></span><br><span class="line">eq 80b99048 0000e940`50300100       // 48</span><br><span class="line"></span><br><span class="line">eq 807d3120  0000e500`00480000      // int 32</span><br><span class="line"></span><br><span class="line">1: kd&gt; ed 807cd750+1c 3e876580      // 修复dg 28的cr3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">80b99040</span><br></pre></td></tr></table></figure>
<h3 id="配置101012"><a class="markdownIt-Anchor" href="#配置101012">#</a> 配置 101012</h3>
<p>CR4 中有 PAE，导致分页为 29912，29912 的 CR3 最后两位为 20 的倍数</p>
<p>1. 添加新条目</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231015211644175.png" alt="image-20231015211644175"></p>
<p>2. 高级设置</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231015211718524.png" alt="image-20231015211718524"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231015211727770.png" alt="image-20231015211727770"></p>
<p>配置后 dirbase 都应该是 000 结尾，以 1k 为单位</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231015211843834.png" alt="image-20231015211843834"></p>
<p>32 位下有两种分页模式  29912 101012    64 位有 999912</p>
<p>ntoskrnl 101012 对应页表内核</p>
<p>ntkrnlpa 29912d 对应页表内核</p>
<p>虚拟内存</p>
<p>32 位 一个进程有自己的 4GB 空间，因为指针宽度是 32 位，寻址是 2^32</p>
<p>4GB 是虚拟内存，和真实物理内存没有联系</p>
<p>0018e0b0</p>
<p>10 (PDE)   10 (PTE)   12（页内偏移）		page director element    page table element</p>
<p>0000 0000 0000         0001 1000 1110          0000 1011 0000（页内偏移）   注意前面的两位 00 是需要补上去的，这样 10+2=12</p>
<p>0									18e								0b0</p>
<p>CR3 页表查询起始地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">!dd  // 查看物理地址</span><br><span class="line">!dd 50601000(CR3)</span><br><span class="line"></span><br><span class="line">!dd 50601000 + 0*4    // 拿到第一项，把最后三位清零  56457867 -&gt; 56457000</span><br><span class="line">!dd 56457000 + 18e*4   // 58073867 -&gt; 58073000</span><br><span class="line">!dd 58073000 + 0b0	   // 0b0 是页内偏移  物理地址</span><br></pre></td></tr></table></figure>
<p>CR3 中每一个元素都是 PDE</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231018174920595.png" alt="image-20231018174920595"></p>
<p>PTT 中可能没有挂物理页，此时 PTE 中为 NULL</p>
<p><code>1024*1024*4 = 4M</code>  只需要 4m 就能管理 4G</p>
<p>一个进程实际只有 2G , 高地址的 2G 是所有进程共享的</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231018180122932.png" alt="image-20231018180122932"></p>
<p>intel 和 amd 最小页是 4k</p>
<p>Windows 64k</p>
<p>0-0x10000 和 0x7fff000 - 0x7fffffff 不能访问。前一个是 NULL 区，后一个是隔离区</p>
<p>从 0x8000000 到 0xfffffff 没有保留区域</p>
<p>CPU 中是通过 MMU 寻址。MMU 是一个寻址模块</p>
<p>MMU 寻址时</p>
<p>1. 把线性地址 右移 12 位</p>
<p>2.TLB 没有找到，找页表结构缓存，如果没有找到，就自己转化</p>
<p>3. 有 PTE + 页内偏移拿到数据</p>
<p>4. 所有的缓存中找不到，把物理地址转化为真正的物理地址 (内存条 板卡地址)</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231016234849139.png" alt="image-20231016234849139"></p>
<p>L1 L2 叫做局部缓存，是 CPU 内部缓存，每一个核都有自己的 L1 L2</p>
<p>L3 所有 CPU 共享缓存</p>
<p>虚拟的逻辑 CPU 对用一个 L1 L2 缓存</p>
<p>data 数据缓存   inst 指令缓存</p>
<p>从 L2 中拿到缓存，会把 L2 这页的缓存替换到 L1 中</p>
<p>L3 拿到会写到 L2 和 L1</p>
<h3 id="幽灵地址"><a class="markdownIt-Anchor" href="#幽灵地址">#</a> 幽灵地址</h3>
<p>101012 中所有的地址都可以被当做代码执行</p>
<p>申请内存的时候如果没有初始化，只有线性地址，没有物理地址，没有物理页，!dd 中为 0</p>
<p>共享内存：多个线性地址共用一个或多个物理页</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231020172843070.png" alt="image-20231020172843070"></p>
<p>多核场景下，同时写一块物理内存会有问题。可以加锁，还可以互斥体，信号量，时间可以，临界区不行，因为他不能跨进程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int _tmain(int argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	int *x = NULL;</span><br><span class="line">	PVOID mem = VirtualAlloc(0,0x100,MEM_COMMIT,PAGE_EXECUTE_READWRITE);</span><br><span class="line">	memset(mem,1,4);</span><br><span class="line"></span><br><span class="line">	printf(&quot;%x\r\n&quot;,mem);</span><br><span class="line">	system(&quot;pause&quot;);</span><br><span class="line"></span><br><span class="line">	printf(&quot;%x\r\n&quot;,*x);</span><br><span class="line">	</span><br><span class="line">	system(&quot;pause&quot;);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过修改 PDE 实现挂物理页，!ed</p>
<p>跨进程挂物理页</p>
<p>把 A 进程的物理页拿出来，挂到的 B 的 0 地址上</p>
<p>通过远程线程跑起来</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span>*x =  <span class="literal">NULL</span>;</span><br><span class="line">	PVOID mem = <span class="built_in">VirtualAlloc</span>(<span class="number">0</span>,<span class="number">0x100</span>,MEM_COMMIT,PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="comment">//memset(mem,1,4);</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%x\r\n	&quot;</span>,mem);</span><br><span class="line">	<span class="type">char</span> bufcode[]=</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="number">0x6A</span>,<span class="number">0</span>,</span><br><span class="line">		<span class="number">0x6A</span>,<span class="number">0</span>,</span><br><span class="line">		<span class="number">0x6A</span>,<span class="number">0</span>,</span><br><span class="line">		<span class="number">0x6A</span>,<span class="number">0</span>,</span><br><span class="line">		<span class="number">0xb8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">		<span class="number">0xff</span>,<span class="number">0xd0</span>,</span><br><span class="line">		<span class="number">0xc2</span>,<span class="number">4</span>,<span class="number">0</span></span><br><span class="line">		</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> user32[]=&#123;<span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="type">char</span> MessageBoxAA[]=&#123;<span class="string">&quot;MessageBoxA&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">	HMODULE hmodule = <span class="built_in">LoadLibraryA</span>(user32);</span><br><span class="line">	ULONG messageBox = (ULONG)<span class="built_in">GetProcAddress</span>(hmodule,MessageBoxAA);</span><br><span class="line">	*(PULONG)&amp;bufcode[<span class="number">9</span>] = messageBox;</span><br><span class="line">	<span class="built_in">memcpy</span>(mem,bufcode,<span class="built_in">sizeof</span>(bufcode));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	HANDLE hProcess = <span class="built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE,<span class="number">1292</span>);</span><br><span class="line"></span><br><span class="line">	HANDLE hThread = <span class="built_in">CreateRemoteThread</span>(hProcess,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%x\r\n&quot;</span>,*x);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//int error = GetLastError();</span></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1. 没有多余的额内存，直接申请 64k</p>
<p>2. 有多余的没存，在多余的内存，在多余的内存，按照 4k 对齐</p>
<h3 id="页属性"><a class="markdownIt-Anchor" href="#页属性">#</a> 页属性</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">char *x = &quot;1111111&quot;;    // 可读，包含初始化的数据</span><br><span class="line">通过characteristic 判断是否可写</span><br><span class="line">标志(属性块) 常用特征值对照表：</span><br><span class="line">[值:00000020h] [IMAGE_SCN_CNT_CODE                // Section contains code.(包含可执行代码)]</span><br><span class="line">[值:00000040h] [IMAGE_SCN_CNT_INITIALIZED_DATA    // Section contains initialized data.(该块包含已初始化的数据)]</span><br><span class="line">[值:00000080h] [IMAGE_SCN_CNT_UNINITIALIZED_DATA  // Section contains uninitialized data.(该块包含未初始化的数据)]</span><br><span class="line">[值:00000200h] [IMAGE_SCN_LNK_INFO                // Section contains comments or some other type of information.]</span><br><span class="line">[值:00000800h] [IMAGE_SCN_LNK_REMOVE              // Section contents will not become part of image.]</span><br><span class="line">[值:00001000h] [IMAGE_SCN_LNK_COMDAT              // Section contents comdat.]</span><br><span class="line">[值:00004000h] [IMAGE_SCN_NO_DEFER_SPEC_EXC       // Reset speculative exceptions handling bits in the TLB entries for this section.]</span><br><span class="line">[值:00008000h] [IMAGE_SCN_GPREL                   // Section content can be accessed relative to GP.]</span><br><span class="line">[值:00500000h] [IMAGE_SCN_ALIGN_16BYTES           // Default alignment if no others are specified.]</span><br><span class="line">[值:01000000h] [IMAGE_SCN_LNK_NRELOC_OVFL         // Section contains extended relocations.]</span><br><span class="line">[值:02000000h] [IMAGE_SCN_MEM_DISCARDABLE         // Section can be discarded.]</span><br><span class="line">[值:04000000h] [IMAGE_SCN_MEM_NOT_CACHED          // Section is not cachable.]</span><br><span class="line">[值:08000000h] [IMAGE_SCN_MEM_NOT_PAGED           // Section is not pageable.]</span><br><span class="line">[值:10000000h] [IMAGE_SCN_MEM_SHARED              // Section is shareable(该块为共享块).]</span><br><span class="line">[值:20000000h] [IMAGE_SCN_MEM_EXECUTE             // Section is executable.(该块可执行)]</span><br><span class="line">[值:40000000h] [IMAGE_SCN_MEM_READ                // Section is readable.(该块可读)]</span><br><span class="line">[值:80000000h] [IMAGE_SCN_MEM_WRITE               // Section is writeable.(该块可写)]</span><br><span class="line">// x 在 rdata中，40000040 可读，包含已初始化数据，但是不可写</span><br><span class="line"></span><br><span class="line">// 查询</span><br><span class="line">sgdt 内存，6字节</span><br><span class="line">sidt</span><br><span class="line"></span><br><span class="line">// 特权指令</span><br><span class="line">1gdt</span><br><span class="line">lidt</span><br><span class="line"></span><br><span class="line">char sgdtbuf[6] = &#123;0&#125;;</span><br><span class="line">__asm&#123;</span><br><span class="line">	sgdt sgdtbuf</span><br><span class="line">&#125; </span><br><span class="line">ULONG gdtTable = *(PULONG)&amp;sgdtbuf[2];</span><br><span class="line">ULONG gdtlimit = *(PSHORT)&amp;sgdtbuf[0];</span><br><span class="line">printf(&quot;%x\r\n %x\r\n&quot;,gdtTable,gdtlimit)   r gdtr    r gdtl</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231020233208888.png" alt="image-20231020233208888"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231020231326046.png" alt="image-20231020231326046"></p>
<p>P：当前页是否有效，即真实物理页</p>
<p>R/W： 0 当前页只读页      = PTE &amp; PDE=1 时，可以修改</p>
<p>U/S: 页特权位，=0 只有 3 环能访问   User/Super</p>
<p>G：全局页，切换 CR3 不刷新，只有内核中有，不手动刷新会一直缓存</p>
<p>A 、 D 和段一样，access 被访问过 A=1，被写过 D=1</p>
<p>PS：PDE.PS=1, 此时没有 PTE   大页，此时是 10 22 ，10 是索引，22 是偏移，一个 PDE 有 4M</p>
<p>avail：操作系统用到</p>
<p>3 环要是写高地址需要 P=1 R/W=1  U/S=1 P=0</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021194659993.png" alt="image-20231021194659993"></p>
<h3 id="页基址"><a class="markdownIt-Anchor" href="#页基址">#</a> 页基址</h3>
<p>无法直接操作物理地址，只能通过线性地址</p>
<p>第一次进入保护模式 的时候 线性地址与物理地址有一对一的等价映射</p>
<p>高地址中页管理的空间不是共享的</p>
<p>每个进程在高地址中有 4M 空间不共享</p>
<p>system 在低地址中没有内存</p>
<p>内核中没有附加进程，属于 system 进程</p>
<p>挂物理页，且 P=1，那么有效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">.text:00489B98                 mov     eax, ecx</span><br><span class="line">.text:00489B9A                 shr     eax, 14h			右移20位</span><br><span class="line">.text:00489B9D                 and     eax, 0FFCh</span><br><span class="line">.text:00489BA2                 sub     eax, 3FD00000h</span><br><span class="line">.text:00489BA7                 mov     eax, [eax]</span><br><span class="line">.text:00489BA9                 test    al, 1</span><br><span class="line">.text:00489BAB                 jnz     short loc_489BB0    ;判断PDE p位</span><br><span class="line">.text:00489BAD</span><br><span class="line">.text:00489BAD loc_489BAD:                             ; CODE XREF: sub_489B98+32j</span><br><span class="line">.text:00489BAD                 xor     al, al</span><br><span class="line">.text:00489BAF                 retn</span><br><span class="line">.text:00489BB0 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00489BB0</span><br><span class="line">.text:00489BB0 loc_489BB0:                             ; CODE XREF: sub_489B98+13j</span><br><span class="line">.text:00489BB0                 test    al, al</span><br><span class="line">.text:00489BB2                 jns     short loc_489BB7; 判断是否是大页</span><br><span class="line">.text:00489BB4                 mov     al, 1</span><br><span class="line">.text:00489BB6                 retn</span><br><span class="line">.text:00489BB7 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00489BB7</span><br><span class="line">.text:00489BB7 loc_489BB7:                             ; CODE XREF: sub_489B98+1Aj</span><br><span class="line">.text:00489BB7                 shr     ecx, 0Ah</span><br><span class="line">.text:00489BBA                 and     ecx, 3FFFFCh</span><br><span class="line">.text:00489BC0                 sub     ecx, 40000000h</span><br><span class="line">.text:00489BC6                 mov     eax, [ecx]</span><br><span class="line">.text:00489BC8                 test    al, 1</span><br><span class="line">.text:00489BCA                 jz      short loc_489BAD</span><br><span class="line">.text:00489BCC                 and     al, 80h</span><br><span class="line">.text:00489BCE                 cmp     al, 80h</span><br><span class="line">.text:00489BD0                 setnz   al</span><br><span class="line">.text:00489BD3                 retn</span><br><span class="line">.text:00489BD3 sub_489B98      endp</span><br></pre></td></tr></table></figure>
<p>PDE，P=1，PS=1，有效</p>
<p>PDE P=1，ps=0，PTE P=1 PAT=0 有效</p>
<p>C0300000 + PDI*4 = PDE</p>
<p>C0000000 + PDI * 0x1000 + PTI*4 = PTE</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231210191417372.png" alt="image-20231210191417372"></p>
<h3 id="29912"><a class="markdownIt-Anchor" href="#29912">#</a> 29912</h3>
<p>ARM 分页 2048</p>
<p>PC 4096</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0x80b99000</span><br><span class="line"></span><br><span class="line">10    -   2</span><br><span class="line"></span><br><span class="line">00 0000 101   5</span><br><span class="line"></span><br><span class="line">1 1001 1001      199</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">!dq cr3 + 2 * 8 + 5 * 8 + 199 * 8</span><br></pre></td></tr></table></figure>
<p>29912 虚拟地址还是 32 位，支持 36 根地址总线，所以物理地址是 36 位</p>
<p>PDPTE -&gt; PDE -&gt; PTE</p>
<p>2^2* 8 = 0x20</p>
<p>29912 中基址只有 PDE 和 PTE</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">.text:00411717 ; BOOLEAN __stdcall MmIsAddressValid(PVOID VirtualAddress)</span><br><span class="line">.text:00411717                 public MmIsAddressValid</span><br><span class="line">.text:00411717 MmIsAddressValid proc near              ; CODE XREF: sub_40471B+31p</span><br><span class="line">.text:00411717                                         ; sub_4C9A84+13p ...</span><br><span class="line">.text:00411717</span><br><span class="line">.text:00411717 VirtualAddress  = dword ptr  8</span><br><span class="line">.text:00411717</span><br><span class="line">.text:00411717                 mov     edi, edi</span><br><span class="line">.text:00411719                 push    ebp</span><br><span class="line">.text:0041171A                 mov     ebp, esp</span><br><span class="line">.text:0041171C                 mov     edx, [ebp+VirtualAddress]</span><br><span class="line">.text:0041171F                 call    sub_4B4AA8</span><br><span class="line">.text:00411724                 pop     ebp</span><br><span class="line">.text:00411725                 retn    4</span><br><span class="line">.text:00411725 MmIsAddressValid endp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.text:004B4AA8                 mov     edi, edi</span><br><span class="line">.text:004B4AAA                 push    ebp</span><br><span class="line">.text:004B4AAB                 mov     ebp, esp</span><br><span class="line">.text:004B4AAD                 push    ecx            		;保存易变寄存器</span><br><span class="line">.text:004B4AAE                 push    ecx				    ; esi-sbp是非易变寄存器</span><br><span class="line">.text:004B4AAF                 mov     eax, edx     		;edx是外部传来的线性地址</span><br><span class="line">.text:004B4AB1                 shr     eax, 12h				;右移18位，</span><br><span class="line">.text:004B4AB4                 and     eax, 3FF8h</span><br><span class="line">.text:004B4AB9                 sub     eax, 3FA00000h		; PDE 基址</span><br><span class="line">.text:004B4ABE                 mov     ecx, [eax]			; 低4字节存</span><br><span class="line">.text:004B4AC0                 mov     eax, [eax+4]</span><br><span class="line">.text:004B4AC3                 mov     [ebp+var_4], eax</span><br><span class="line">.text:004B4AC6                 mov     eax, ecx				;低位给eax</span><br><span class="line">.text:004B4AC8                 and     eax, 1				;判断p位</span><br><span class="line">.text:004B4ACB                 push    0</span><br><span class="line">.text:004B4ACD                 mov     [ebp+var_8], eax</span><br><span class="line">.text:004B4AD0                 pop     eax</span><br><span class="line">.text:004B4AD1                 jz      short loc_4B4AD7			; 根据p位是否 =0 跳 ， =0 跳</span><br><span class="line">.text:004B4AD3                 test    eax, eax</span><br><span class="line">.text:004B4AD5                 jz      short loc_4B4ADB			;效果和jmp一样</span><br><span class="line">.text:004B4AD7</span><br><span class="line">.text:004B4AD7 loc_4B4AD7:                             ; CODE XREF: sub_4B4AA8+29j</span><br><span class="line">.text:004B4AD7                 xor     al, al				; 返回0</span><br><span class="line">.text:004B4AD9                 leave</span><br><span class="line">.text:004B4ADA                 retn</span><br><span class="line">.text:004B4ADB ; ---------------------------------------------------------------------------</span><br><span class="line">.text:004B4ADB</span><br><span class="line">.text:004B4ADB loc_4B4ADB:                             ; CODE XREF: sub_4B4AA8+2Dj</span><br><span class="line">.text:004B4ADB                 push    esi				; 保存非易变寄存器</span><br><span class="line">.text:004B4ADC                 mov     esi, 80h			; 判断大页 ,80是大页</span><br><span class="line">.text:004B4AE1                 and     ecx, esi</span><br><span class="line">.text:004B4AE3                 push    0</span><br><span class="line">.text:004B4AE5                 mov     [ebp+var_8], ecx</span><br><span class="line">.text:004B4AE8                 pop     eax</span><br><span class="line">.text:004B4AE9                 jz      short loc_4B4AEF  =0 是小页</span><br><span class="line">.text:004B4AEB                 test    eax, eax</span><br><span class="line">.text:004B4AED                 jz      short loc_4B4B2B		;如果是大页，返回1</span><br><span class="line">.text:004B4AEF</span><br><span class="line">.text:004B4AEF loc_4B4AEF:                             ; CODE XREF: sub_4B4AA8+41j</span><br><span class="line">.text:004B4AEF                 shr     edx, 9</span><br><span class="line">.text:004B4AF2                 and     edx, 7FFFF8h</span><br><span class="line">.text:004B4AF8                 mov     ecx, [edx-3FFFFFFCh]			; 获取pte高位4字节，c0000000 是PTE基址，29912下c0600000是PDE基址</span><br><span class="line">.text:004B4AFE                 sub     edx, 40000000h					(edx &gt;&gt; 9) &amp; 0x7fff8 ,ecx=*(edx+c00000004)</span><br><span class="line">.text:004B4B04                 mov     eax, [edx]						eax = *(edx+c0000000)</span><br><span class="line">.text:004B4B06                 mov     [ebp+var_4], ecx</span><br><span class="line">.text:004B4B09                 mov     ecx, eax</span><br><span class="line">.text:004B4B0B                 and     ecx, 1							PTE.P </span><br><span class="line">.text:004B4B0E                 push    0</span><br><span class="line">.text:004B4B10                 mov     [ebp+var_8], ecx</span><br><span class="line">.text:004B4B13                 pop     ecx</span><br><span class="line">.text:004B4B14                 jz      short loc_4B4B27</span><br><span class="line">.text:004B4B16                 test    ecx, ecx</span><br><span class="line">.text:004B4B18                 jnz     short loc_4B4B27					pte.pat</span><br><span class="line">.text:004B4B1A                 and     eax, esi</span><br><span class="line">.text:004B4B1C                 push    ecx</span><br><span class="line">.text:004B4B1D                 mov     [ebp+var_8], eax</span><br><span class="line">.text:004B4B20                 pop     eax</span><br><span class="line">.text:004B4B21                 jz      short loc_4B4B2B</span><br><span class="line">.text:004B4B23                 test    eax, eax</span><br><span class="line">.text:004B4B25                 jnz     short loc_4B4B2B</span><br><span class="line">.text:004B4B27</span><br><span class="line">.text:004B4B27 loc_4B4B27:                             ; CODE XREF: sub_4B4AA8+6Cj</span><br><span class="line">.text:004B4B27                                         ; sub_4B4AA8+70j</span><br><span class="line">.text:004B4B27                 xor     al, al</span><br><span class="line">.text:004B4B29                 jmp     short loc_4B4B2D</span><br><span class="line">.text:004B4B2B ; ---------------------------------------------------------------------------</span><br><span class="line">.text:004B4B2B</span><br><span class="line">.text:004B4B2B loc_4B4B2B:                             ; CODE XREF: sub_4B4AA8+45j</span><br><span class="line">.text:004B4B2B                                         ; sub_4B4AA8+79j ...</span><br><span class="line">.text:004B4B2B                 mov     al, 1</span><br><span class="line">.text:004B4B2D</span><br><span class="line">.text:004B4B2D loc_4B4B2D:                             ; CODE XREF: sub_4B4AA8+81j</span><br><span class="line">.text:004B4B2D                 pop     esi</span><br><span class="line">.text:004B4B2E                 leave</span><br><span class="line">.text:004B4B2F                 retn</span><br><span class="line"></span><br><span class="line">80b99000</span><br><span class="line">右移18位 == 202e</span><br><span class="line">202e &amp; 3ff8 == 2028</span><br><span class="line">2028- 3fa00000 = c0602028</span><br></pre></td></tr></table></figure>
<p>内核编译器和 ring3 编译器不一样</p>
<p>XD = 0 当前页可以执行</p>
<p>// PDE 与 PTE 最高位进行与， = 0 可执行  （小页看 PTE 高位，大页看 PDE 高位）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">00000000`62cc1867  // PDE</span><br><span class="line">80000000`636ec867  // PTE </span><br></pre></td></tr></table></figure>
<p>如果 XD 描述 PDE，那么代表这个 PDE 管理了所有的 PTE</p>
<p>PDPTE 没有属性，只有 PCD 和 PWT</p>
<p>4 个 PDPTE * 512 = 2048 PDE</p>
<p>2048*512*8 = 8M</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231105211300962.png" alt="image-20231105211300962"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231108000856947.png" alt="image-20231108000856947"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231108180550851.png" alt="image-20231108180550851"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231108180847403.png" alt="image-20231108180847403"></p>
<h3 id="缓存"><a class="markdownIt-Anchor" href="#缓存">#</a> 缓存</h3>
<p>缓存类型</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231108220412054.png" alt="image-20231108220412054"></p>
<p>UC 没有缓存，直接从板卡地址拿数据。强制无缓存</p>
<p>UC- 有读缓存，无写缓存。弱无缓存</p>
<p>WC 写组合 \ 写合并，尝试从 L1 缓存行拿地址， 一次写 4 个地址，小于等于 4 都是按照组合写在同一时刻。每次刷新一个缓存行 (64 字节)</p>
<p>WB 回写，到时间才刷到内存中去。延时性低。只需要写到缓存，定时一次性刷新</p>
<p>WT 直写 直接写到缓存中，并且写到内存条中 。通常是做多媒体。全部写完才会返回</p>
<p>主存不是完全的内存，是显卡 + 设备内存</p>
<p>WP 写保护，只读</p>
<p>系统的 dll 是写拷贝。当无法写入的时候产生异常，拷贝一份</p>
<p>DLL 代码段一般是运行 只读 R/W=0 ，VAD 虚拟地址管理器，描述当前线性地址属性。线性地址和物理地址属性不一样</p>
<p>write copy 写时拷贝：多个 exe 加载一个路径下同一个名字的 dll，或者任意的 PE 文件的时候，此 dll 的物理地址只有一份</p>
<p>2.exe 如果强行去写 dll，不触发页异常的情况下 (修改 r/w=1)，会导致所有引用这个 dll 的 exe 全部被修改</p>
<p>通过 VirtualProtected 修改之后，此时的 dll 已经不是一个物理页了，会挂新的物理页，再把 dll 复制过来</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231109193507076.png" alt="image-20231109193507076"></p>
<p>PAT</p>
<p>PWT = 0 回写  = 1 直写</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231109193730790.png" alt="image-20231109193730790"></p>
<h3 id="tlb"><a class="markdownIt-Anchor" href="#tlb">#</a> TLB</h3>
<p>每个核有四个 TLB，两个数据 TLB- DTLB，两个指令 TLB-ITLB</p>
<p>小的 TLB 存 PTE，大的 TLB 存 PDE</p>
<p>PDE 大页一般都是 G=1，基本上在内核模块中        G=1 全局页</p>
<p>!pte gdtr				// 当前进程下</p>
<p>!vtop cr3 gdtr</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231109233501934.png" alt="image-20231109233501934"></p>
<p>1. 申请 2 个地址分别赋值</p>
<p>2. 把第一个地址挂在 0 地址上，然后访问，取出结果保存变量</p>
<p>3. 又把第二个地址挂在 o 地址上，然后访问，取出结果也保存变量</p>
<p>4. 观察变量 1, 变量 2 的结果有什么不同</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 12.TLB.cpp : 定义控制台应用程序的入口点。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">PUCHAR addr1 = <span class="literal">NULL</span>;</span><br><span class="line">PUCHAR addr2 = <span class="literal">NULL</span>;</span><br><span class="line">ULONG temp1=<span class="number">0</span>,temp2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __declspec(naked) <span class="built_in">test1</span>()</span><br><span class="line">&#123;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		pushad;</span><br><span class="line">		pushfd;</span><br><span class="line">		push <span class="number">0x30</span>;</span><br><span class="line">		pop fs;</span><br><span class="line">	</span><br><span class="line">		mov eax,[addr1];<span class="comment">//线形地址1</span></span><br><span class="line">		shr eax,<span class="number">0x9</span>;</span><br><span class="line">		<span class="keyword">and</span> eax,<span class="number">0x7ffff8</span>;</span><br><span class="line">		add eax,<span class="number">0xc0000000</span>;</span><br><span class="line">		mov ecx,[eax];   <span class="comment">//取低4字节</span></span><br><span class="line">		mov edx,[eax+<span class="number">4</span>]; <span class="comment">//取高4字节</span></span><br><span class="line">		<span class="comment">// or ecx,0x100;   // 设置G，G=1无法通过CR3导致刷新</span></span><br><span class="line">		mov dword ptr ds:[<span class="number">0xc0000000</span>],ecx;</span><br><span class="line">		mov dword ptr ds:[<span class="number">0xc0000004</span>],edx;</span><br><span class="line">		mov eax,dword ptr ds:[<span class="number">0</span>];</span><br><span class="line">		mov [temp1],eax;</span><br><span class="line">	</span><br><span class="line">		<span class="comment">//mov eax,cr3;</span></span><br><span class="line">		<span class="comment">//mov cr3,eax;</span></span><br><span class="line"></span><br><span class="line">		mov eax,[addr2];<span class="comment">//线形地址2</span></span><br><span class="line">		shr eax,<span class="number">0x9</span>;</span><br><span class="line">		<span class="keyword">and</span> eax,<span class="number">0x7ffff8</span>;</span><br><span class="line">		add eax,<span class="number">0xc0000000</span>;</span><br><span class="line">		mov ecx,[eax];   <span class="comment">//取低4字节</span></span><br><span class="line">		mov edx,[eax+<span class="number">4</span>]; <span class="comment">//取高4字节</span></span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 挂物理页</span></span><br><span class="line">		mov dword ptr ds:[<span class="number">0xc0000000</span>],ecx;</span><br><span class="line">		mov dword ptr ds:[<span class="number">0xc0000004</span>],edx;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//刷单条TLB</span></span><br><span class="line">		<span class="comment">//invlpg dword ptr ds:[0]</span></span><br><span class="line"></span><br><span class="line">		mov eax,dword ptr ds:[<span class="number">0</span>];</span><br><span class="line">		mov [temp2],eax;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		push <span class="number">0x3b</span>;</span><br><span class="line">		pop fs;</span><br><span class="line">		popfd;</span><br><span class="line">		popad;</span><br><span class="line"></span><br><span class="line">		retf;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	addr1 = (PUCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>,<span class="number">0x1000</span>,MEM_COMMIT,PAGE_EXECUTE_READWRITE);</span><br><span class="line">	addr2 = (PUCHAR)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>,<span class="number">0x1000</span>,MEM_COMMIT,PAGE_EXECUTE_READWRITE);</span><br><span class="line">	*(PULONG)addr1 = <span class="number">0x1000</span>;</span><br><span class="line">	*(PULONG)addr2 = <span class="number">0x2000</span>;</span><br><span class="line"></span><br><span class="line">	temp1 = <span class="number">0</span>;</span><br><span class="line">	temp2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;addr1 = %x,addr2 = %x,test1=%x\r\n&quot;</span>,addr1,addr2,test1);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> bufcode[]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4b</span>,<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		call fword ptr bufcode;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;temp1 = %x,temp2 = %x\r\n&quot;</span>,temp1,temp2);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>切换 CR3 的时候回认为切换页表，导致 TLB 刷新，TLB 中 G=0 的全部刷掉</p>
<p>mov eax,cr3</p>
<p>mov cr3,eax</p>
<p>invlpg dowrd ptr ds:[]</p>
<p>刷新方式： 切页表刷新 (刷新除 G=1 的情况)  /   invlpg 把地址变成无效缓存 (刷新一条)    /   CR4 控制寄存器中有一个 PGE，控制所有的 G 位是否有效 (刷新所有)</p>
<p>切换线程的时候，判断当前被切换与切换是否是一个进程，如果不是会切换页表 CR3</p>
<p>本质上切换进程就是切换 CR3</p>
<h3 id="控制寄存器"><a class="markdownIt-Anchor" href="#控制寄存器">#</a> 控制寄存器</h3>
<p>x86 有五个，x64 还有一个 CR8</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231111195301493.png" alt="image-20231111195301493"></p>
<p>CR2 保存了出异常的线性地址。针对于缺页和内存有问题的异常</p>
<p>CR0 PE：开启保护模式，但是没有分页保护，只有段保护</p>
<p>实模式通过写入字，打开 A20 端口，设置 CR0 进入保护模式</p>
<p>PG：开启分页模式    PG+PE = 段页保护模式</p>
<p>PE = 0，PG=1 无效    PE=0，PG=0 实模式   PE=1  PG = 0 段保护</p>
<p>Windows 无法使用实模式，除非是裸机，但是有虚拟 8086 模式，叫做虚拟实模式</p>
<p>TS：切换任务段，call 进去 =1 ，任务段切换标识</p>
<p>CD = 1 关闭缓存</p>
<p>AM 对齐位。对应 eflag 中 ac 的对齐检查。=1 32 位下堆栈必须 4 字节对齐，64 8 字节对齐</p>
<p>WP  = 0 关闭写保护，不可写地址也可以写入。是 0 环写 3 环</p>
<p>CR4 辅助功能</p>
<p>VEM 开启虚拟中断，允许开启虚拟 8086 模式</p>
<p>PVI 是否支持虚拟 8086 虚拟化中断，=1 允许</p>
<p>TSD  只有特权级可以执行， = 1  3 环可以调用指令计算时间</p>
<p>DE  =1 调试寄存器 DR4 和 DR5 可使用。DR6，DR7 的别名</p>
<p>PSE 大页开关  =0 强制小页</p>
<p>PAE  =1 29912， =0 10102 ，只在 32 位下有用，64 下面只有 999912</p>
<p>MCE 机器检查</p>
<p>PGE  =1 代表 G=1   =0 G=1 无效即没有全局页</p>
<p>PCE  性能监控器是否开启</p>
<p>VMXE VT 开启位 ， =1 进入 VT</p>
<p>SMXE  SMM 上帝模式  super mode manage</p>
<p>SMEP  SMAP  super mode execute protect   super mode access protect   =1 0 环不能执行 / 访问 US=1 的地址  。AM=0  这两个位无效</p>
<p>PKE  页表密钥  =1 保护 key 保护用户地址</p>
<p>IA-32e 兼容 cpu 支持 32 和 64，允许 64 位下运行 32 位程序</p>
<p>IA-64 纯 64 位 cpu</p>
<h2 id="驱动"><a class="markdownIt-Anchor" href="#驱动">#</a> 驱动</h2>
<p>加载驱动类似于用户区加载 dll，驱动是所有进程共享的。驱动本质是模块</p>
<p>驱动有 NT 驱动，WDM，WDF (KWDF,UWDF</p>
<p>NT 虚拟驱动，如果出现绑定设备，不能卸载，只能重启</p>
<p>WDM 驱动，是一个热插拔方式，不需要重启</p>
<p>WDF 简化开发的，封装了一部分驱动，相当于事件驱动机制 。KWDF 内核驱动框架  UWDF 用户驱动框架，基于 com 开发</p>
<p>com 是 Windows 的一套组件，定义了一系列接口。对于 C#,js 等语言效果明显</p>
<h3 id="hello-world"><a class="markdownIt-Anchor" href="#hello-world">#</a> hello world</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118144931361.png" alt="image-20231118144931361"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118145032673.png" alt="image-20231118145032673"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">创建 empty wdm 文件</span><br><span class="line">#include &lt;ntifs.h&gt;</span><br><span class="line"></span><br><span class="line">NTSTATUS DriverEntry(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span><br><span class="line">&#123;</span><br><span class="line">	return STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sys 入口是 GsDriverEntry</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">INIT:00405000 ; int __stdcall GsDriverEntry(_DRIVER_OBJECT *DriverObject, _UNICODE_STRING *RegistryPath)</span><br><span class="line">INIT:00405000                 public _GsDriverEntry@8</span><br><span class="line">INIT:00405000 _GsDriverEntry@8 proc near              ; DATA XREF: .rdata:00402004↑o</span><br><span class="line">INIT:00405000</span><br><span class="line">INIT:00405000 DriverObject    = dword ptr  8</span><br><span class="line">INIT:00405000 RegistryPath    = dword ptr  0Ch</span><br><span class="line">INIT:00405000</span><br><span class="line">INIT:00405000                 mov     edi, edi</span><br><span class="line">INIT:00405002                 push    ebp</span><br><span class="line">INIT:00405003                 mov     ebp, esp</span><br><span class="line">INIT:00405005                 call    ___security_init_cookie</span><br><span class="line">INIT:0040500A                 pop     ebp</span><br><span class="line">INIT:0040500B                 jmp     _DriverEntry@8  ; DriverEntry(x,x)</span><br><span class="line">INIT:0040500B _GsDriverEntry@8 endp</span><br><span class="line">INIT:0040500B</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118150152408.png" alt="image-20231118150152408"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118151446842.png" alt="image-20231118151446842"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118152630283.png" alt="image-20231118152630283"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt pDriver </span><br><span class="line">Local var @ 0x8c72c9e0 Type _DRIVER_OBJECT*</span><br><span class="line">0x865c9f08 </span><br><span class="line">   +0x000 Type             : 0n4</span><br><span class="line">   +0x002 Size             : 0n168</span><br><span class="line">   +0x004 DeviceObject     : (null) </span><br><span class="line">   +0x008 Flags            : 2</span><br><span class="line">   +0x00c DriverStart      : 0x96dcb000 Void</span><br><span class="line">   +0x010 DriverSize       : 0x6000</span><br><span class="line">   +0x014 DriverSection    : 0x864ef0d8 Void</span><br><span class="line">   +0x018 DriverExtension  : 0x865c9fb0 _DRIVER_EXTENSION</span><br><span class="line">   +0x01c DriverName       : _UNICODE_STRING &quot;\Driver\3&quot;</span><br><span class="line">   +0x024 HardwareDatabase : 0x84177250 _UNICODE_STRING &quot;\REGISTRY\MACHINE\HARDWARE\DESCRIPTION\SYSTEM&quot;</span><br><span class="line">   +0x028 FastIoDispatch   : (null) </span><br><span class="line">   +0x02c DriverInit       : 0x96dcf000     long  3!GsDriverEntry+0</span><br><span class="line">   +0x030 DriverStartIo    : (null) </span><br><span class="line">   +0x034 DriverUnload     : (null) </span><br><span class="line">   +0x038 MajorFunction    : [28] 0x83ec0da3     long  nt!IopInvalidDeviceRequest+0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _DRIVER_EXTENSION 0x865c9fb0</span><br><span class="line">nt!_DRIVER_EXTENSION</span><br><span class="line">   +0x000 DriverObject     : 0x865c9f08 _DRIVER_OBJECT</span><br><span class="line">   +0x004 AddDevice        : (null) </span><br><span class="line">   +0x008 Count            : 0</span><br><span class="line">   +0x00c ServiceKeyName   : _UNICODE_STRING &quot;3&quot;</span><br><span class="line">   +0x014 ClientDriverExtension : (null) </span><br><span class="line">   +0x018 FsFilterCallbacks : (null) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118153307784.png" alt="image-20231118153307784"></p>
<p>start  2 开启自启  3 手工启动  4 禁用</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118153559163.png" alt="image-20231118153559163"></p>
<p>ImagePath  ?? 是内核路径</p>
<p>type 驱动 = 1</p>
<p>加载驱动</p>
<p>1. 服务加载。调用 Windows 所提供的服务，并不是本进程加载。通过 csrss 写注册表</p>
<p>opensrcmanage</p>
<p>CreateService</p>
<p>StartService</p>
<p>StopService</p>
<p>DeleteService</p>
<p>2. 本地加载</p>
<p>调用 zw/ntloadDriver</p>
<p>卸载调用 Zw/NtUnloadDriver</p>
<p>杀软链接模块加载时候，方式一拦截不到进程，只能通过其他方式获取进程是谁</p>
<p>方式二直接拦截，知道是谁加载</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> &#123;</span></span><br><span class="line">    USHORT Length;</span><br><span class="line">    USHORT MaximumLength;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> MIDL_PASS</span></span><br><span class="line">    [size_is(MaximumLength / <span class="number">2</span>), length_is((Length) / <span class="number">2</span>) ] USHORT * Buffer;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">// MIDL_PASS</span></span></span><br><span class="line">    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH   Buffer;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// MIDL_PASS</span></span></span><br><span class="line">&#125; UNICODE_STRING;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 命令行启动 3.sys</span></span><br><span class="line">net start <span class="number">3</span>  </span><br><span class="line">    </span><br><span class="line">net stop <span class="number">3</span> </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DRIVERUNLOAD</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;unload\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgBreakPoint();</span><br><span class="line">	pDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class="line">	DbgPrint(<span class="string">&quot;===================%wZ=========\r\n&quot;</span>,pReg);  <span class="comment">// printf  wz打印Unicode字符串指针  ===================\REGISTRY\MACHINE\SYSTEM\ControlSet001\services\9=========</span></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="类型"><a class="markdownIt-Anchor" href="#类型">#</a> 类型</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">INT - int</span><br><span class="line">UCHAR - unsigned char</span><br><span class="line">typedef _Return_type_success_(return &gt;= 0) LONG NTSTATUS;</span><br><span class="line"></span><br><span class="line">NTSTATUS status = xxx;</span><br><span class="line">if (NT_SUCCESS(status)) &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="字符串函数"><a class="markdownIt-Anchor" href="#字符串函数">#</a> 字符串函数</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@[comment(&quot;MVI_tracked&quot;)]</span></span><br><span class="line">__kernel_entry NTSYSCALLAPI</span><br><span class="line">NTSTATUS</span><br><span class="line">NTAPI</span><br><span class="line"><span class="title function_">NtOpenProcess</span> <span class="params">(</span></span><br><span class="line"><span class="params">    _Out_ PHANDLE ProcessHandle,</span></span><br><span class="line"><span class="params">    _In_ ACCESS_MASK DesiredAccess,</span></span><br><span class="line"><span class="params">    _In_ POBJECT_ATTRIBUTES ObjectAttributes,</span></span><br><span class="line"><span class="params">    _In_opt_ PCLIENT_ID ClientId</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">UNICODE_STRING unName = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">RtlInitUnicodeString(&amp;unName, <span class="string">L&quot;www&quot;</span>);</span><br><span class="line">    </span><br><span class="line">OBJECT_ATTRIBUTES obj = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">obj.ObjectName = &amp;unName; </span><br><span class="line"><span class="comment">// 	InitializeObjectAttributes</span></span><br><span class="line">    </span><br><span class="line">HANDLE hProcess = <span class="literal">NULL</span>;</span><br><span class="line">NtOpenProcess(&amp;hProcess,PROCESS_ALL_ACCESS,&amp;obj,<span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UNICODE_STRING unName = &#123;0&#125;;</span><br><span class="line">PWCH x = L&quot;xxxx&quot;;</span><br><span class="line">RtlInitUnicodeString(&amp;unName, x);</span><br><span class="line">DbgPrintEx(77,0,&quot;%x %x&quot;,x,unName.Buffer);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">char* xxx = &quot;1111&quot;;</span><br><span class="line">UNICODE_STRING unName = &#123; 0 &#125;;</span><br><span class="line">STRING str = &#123; 0 &#125;;</span><br><span class="line">RtlInitString(&amp;str, xxx);</span><br><span class="line"></span><br><span class="line">NTSTATUS status = RtlAnsiStringToUnicodeString(&amp;unName, &amp;str, TRUE);</span><br><span class="line">DbgPrintEx(77, 0, &quot;%x&quot;, status);</span><br><span class="line"></span><br><span class="line">if (NT_SUCCESS(status))</span><br><span class="line">&#123;</span><br><span class="line">	DbgPrintEx(77, 0, &quot;%x %x&quot;, str.Buffer, unName.Buffer);</span><br><span class="line">	RtlFreeUnicodeString(&amp;unName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;ntstrsafe.h&gt;</span><br><span class="line">char bb[1000] = &#123; 0 &#125;;</span><br><span class="line">RtlStringCbPrintfA(bb, 1000, &quot;%d  %s&quot;, 10, &quot;ssss&quot;);</span><br><span class="line">DbgPrintEx(77, 0, &quot;%s&quot;, bb);</span><br><span class="line"></span><br><span class="line">RtlStringCbPrintfW</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RtiInitString 初始化多字节ascii</span><br><span class="line">RtlInitUnicodeString 初始化宽字符</span><br><span class="line">RtlFreeUnicodeString释放uncode学符串</span><br><span class="line">RtlStringCbPrintfA格式化输出――记得引用#include &lt;ntstrsafe.h&gt;</span><br><span class="line">RtlCompareUnicodeString(a, b, TRUE);  字符串比较</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 申请内存</span><br><span class="line">ExAllocatePool()</span><br><span class="line"></span><br><span class="line">ExAllocatePool(NonPagedPool, size);  // 可执行</span><br><span class="line">ExAllocatePoolWithTag(NonPagedPool, size,&#x27;111&#x27;);</span><br><span class="line">!pte Address</span><br><span class="line"></span><br><span class="line">ExFreePool(mem);</span><br></pre></td></tr></table></figure>
<h3 id="创建线程"><a class="markdownIt-Anchor" href="#创建线程">#</a> 创建线程</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void work(PVOID StartContext)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">HANDLE hThread = NULL;</span><br><span class="line">NTSTATUS status = PsCreateSystemThread(&amp;hThread, THREAD_ALL_ACCESS, NULL, NULL, NULL, work, NULL);</span><br><span class="line">if (NT_SUCCESS(status))</span><br><span class="line">&#123;</span><br><span class="line">	ZwClose(hThread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="驱动-2"><a class="markdownIt-Anchor" href="#驱动-2">#</a> 驱动</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt _LIST_ENTRY</span><br><span class="line">ntdll!_LIST_ENTRY</span><br><span class="line">   +0x000 Flink            : Ptr32 _LIST_ENTRY</span><br><span class="line">   +0x004 Blink            : Ptr32 _LIST_ENTRY</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _SINGLE_LIST_ENTRY</span><br><span class="line">ntdll!_SINGLE_LIST_ENTRY</span><br><span class="line">   +0x000 Next             : Ptr32 _SINGLE_LIST_ENTRY</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">InitializeListHead();  // 链表定义在局部变量的时候需要初始化，防止垃圾数据，全局变量默认初始化都是0</span><br><span class="line">IsListEmpty();</span><br><span class="line">InsertHeadList();</span><br><span class="line">InsertTailList();</span><br><span class="line">RemoveHeadList();</span><br><span class="line">RemoveTailList();</span><br><span class="line">RemoveEntryList();</span><br><span class="line">CONTAINING_RECORD();</span><br><span class="line">	</span><br><span class="line">#include &lt;ntifs.h&gt;</span><br><span class="line"></span><br><span class="line">RTL_GENERIC_TABLE gTABLE = &#123; 0 &#125;;</span><br><span class="line"></span><br><span class="line">typedef struct _AAA</span><br><span class="line">&#123;</span><br><span class="line">	int id;</span><br><span class="line">	int y;</span><br><span class="line">	int x;</span><br><span class="line">&#125;AAA, * PAAA;</span><br><span class="line"></span><br><span class="line">void DRIVERUNLOAD(PDRIVER_OBJECT DriverObject)</span><br><span class="line">&#123;</span><br><span class="line">	DbgPrint(&quot;unload\r\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RTL_GENERIC_COMPARE_RESULTS NTAPI GenericCmp(</span><br><span class="line">	_In_ struct _RTL_GENERIC_TABLE* Table,</span><br><span class="line">	_In_ PVOID FirstStruct,</span><br><span class="line">	_In_ PVOID SecondStruct</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">	PAAA  a1 = (PAAA)FirstStruct;</span><br><span class="line">	PAAA  a2 = (PAAA)SecondStruct;</span><br><span class="line">	if (a1-&gt;id == a2-&gt;id)</span><br><span class="line">	&#123;</span><br><span class="line">		return GenericEqual;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (a1-&gt;id &gt; a2-&gt;id) return GenericGreaterThan;</span><br><span class="line">	return GenericLessThan;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PVOID NTAPI GenericAllocate(</span><br><span class="line">	_In_ struct _RTL_GENERIC_TABLE* Table,</span><br><span class="line">	_In_ CLONG ByteSize</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">	return ExAllocatePool(NonPagedPool, ByteSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID NTAPI GenericFree(</span><br><span class="line">	_In_ struct _RTL_GENERIC_TABLE* Table,</span><br><span class="line">	_In_ __drv_freesMem(Mem) _Post_invalid_ PVOID Buffer</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">	ExFreePool(Buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NTSTATUS DriverEntry(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span><br><span class="line">&#123;</span><br><span class="line">	AAA aaa = &#123; 0 &#125;;</span><br><span class="line">	//DbgBreakPoint();</span><br><span class="line"></span><br><span class="line">	//InitializeListHead();  // 链表定义在局部变量的时候需要初始化，防止垃圾数据，全局变量默认初始化都是0</span><br><span class="line">	//IsListEmpty();</span><br><span class="line">	//InsertHeadList();</span><br><span class="line">	//InsertTailList();</span><br><span class="line">	//RemoveHeadList();</span><br><span class="line">	//RemoveTailList();</span><br><span class="line">	//RemoveEntryList();</span><br><span class="line">	//CONTAINING_RECORD();</span><br><span class="line"></span><br><span class="line">	aaa.id = 1;</span><br><span class="line">	aaa.x = 2;</span><br><span class="line">	aaa.y = 3;</span><br><span class="line"></span><br><span class="line">	AAA node = &#123; 3,2,1 &#125;;</span><br><span class="line"></span><br><span class="line">	BOOLEAN newE = FALSE;</span><br><span class="line"></span><br><span class="line">	RtlInitializeGenericTable(&amp;gTABLE, GenericCmp, GenericAllocate, GenericFree, NULL);</span><br><span class="line">	//RtlInitializeGenericTableAvl();  二叉搜索树</span><br><span class="line">	RtlInsertElementGenericTable(&amp;gTABLE, &amp;aaa, sizeof(AAA), &amp;newE);   // 用栈插入的数据会申请内存，把栈上的变成堆上的，保证数据不会被释放</span><br><span class="line">	AAA * xxx = RtlLookupElementGenericTable(&amp;gTABLE, &amp;aaa);</span><br><span class="line">	int num = RtlNumberGenericTableElements(&amp;gTABLE);</span><br><span class="line">	RtlDeleteElementGenericTable(&amp;gTABLE, &amp;node);</span><br><span class="line">	RtlIsGenericTableEmpty(&amp;gTABLE);</span><br><span class="line"></span><br><span class="line">	AAA* RestartKey = NULL;</span><br><span class="line">	AAA* xx = 0;</span><br><span class="line">	if (!RtlIsGenericTableEmpty(&amp;gTABLE))</span><br><span class="line">	&#123;</span><br><span class="line">		//遍历</span><br><span class="line">		for (xx = RtlEnumerateGenericTableWithoutSplaying(&amp;gTABLE, &amp;RestartKey);</span><br><span class="line">			xx != NULL;</span><br><span class="line">			xx = RtlEnumerateGenericTableWithoutSplaying(&amp;gTABLE, &amp;RestartKey))</span><br><span class="line">		&#123;</span><br><span class="line">			DbgPrintEx(77, 0, &quot;%x\r\n&quot;, xx-&gt;id);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class="line">	return STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="驱动断链"><a class="markdownIt-Anchor" href="#驱动断链">#</a> 驱动断链</h3>
<p>pc hunter 会遍历 driver 和 filesystem 组成内核模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt _DRIVER_OBJECT</span><br><span class="line">nt!_DRIVER_OBJECT</span><br><span class="line">   +0x000 Type             : Int2B</span><br><span class="line">   +0x002 Size             : Int2B</span><br><span class="line">   +0x004 DeviceObject     : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +0x008 Flags            : Uint4B</span><br><span class="line">   +0x00c DriverStart      : Ptr32 Void</span><br><span class="line">   +0x010 DriverSize       : Uint4B</span><br><span class="line">   +0x014 DriverSection    : Ptr32 Void</span><br><span class="line">   +0x018 DriverExtension  : Ptr32 _DRIVER_EXTENSION</span><br><span class="line">   +0x01c DriverName       : _UNICODE_STRING</span><br><span class="line">   +0x024 HardwareDatabase : Ptr32 _UNICODE_STRING</span><br><span class="line">   +0x028 FastIoDispatch   : Ptr32 _FAST_IO_DISPATCH</span><br><span class="line">   +0x02c DriverInit       : Ptr32     long </span><br><span class="line">   +0x030 DriverStartIo    : Ptr32     void </span><br><span class="line">   +0x034 DriverUnload     : Ptr32     void </span><br><span class="line">   +0x038 MajorFunction    : [28] Ptr32     long </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 遍历所有驱动模块</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">	LIST_ENTRY <span class="built_in">exp</span>;</span><br><span class="line">	ULONG un;</span><br><span class="line">	ULONG NonPagedDebugInfo;</span><br><span class="line">	ULONG DllBase;</span><br><span class="line">	ULONG EntryPoint;</span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">	ULONG Flags;</span><br><span class="line">	USHORT LoadCount;</span><br><span class="line">	USHORT __Undefined5;</span><br><span class="line">	ULONG  __Undefined6;</span><br><span class="line">	ULONG  CheckSum;</span><br><span class="line">	ULONG  TimeDateStamp;</span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DRIVERUNLOAD</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;unload\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgBreakPoint();</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;  <span class="comment">// 下一个节点</span></span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (next != pre)</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrintEx(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;%wZ\r\n&quot;</span>, &amp;next-&gt;FullDllName);</span><br><span class="line">		next = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt ldr</span><br><span class="line">Local var @ <span class="number">0x8cb309cc</span> Type _KLDR_DATA_TABLE_ENTRY*</span><br><span class="line"><span class="number">0x887d8e50</span> </span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class="number">0x83f53850</span> - <span class="number">0x880ac730</span> ]</span><br><span class="line">   +<span class="number">0x008</span> <span class="built_in">exp</span>              : _LIST_ENTRY [ <span class="number">0xffffffff</span> - <span class="number">0xffffffff</span> ]</span><br><span class="line">   +<span class="number">0x010</span> un               : <span class="number">0x887d8e68</span></span><br><span class="line">   +<span class="number">0x014</span> NonPagedDebugInfo : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x018</span> DllBase          : <span class="number">0x9609a000</span></span><br><span class="line">   +<span class="number">0x01c</span> EntryPoint       : <span class="number">0x9609e000</span></span><br><span class="line">   +<span class="number">0x020</span> SizeOfImage      : <span class="number">0x6000</span></span><br><span class="line">   +<span class="number">0x024</span> FullDllName      : _UNICODE_STRING <span class="string">&quot;\??\C:\Users\shinya\Desktop\MyDriver2.sys&quot;</span></span><br><span class="line">   +<span class="number">0x02c</span> BaseDllName      : _UNICODE_STRING <span class="string">&quot;MyDriver2.sys&quot;</span></span><br><span class="line">   +<span class="number">0x034</span> Flags            : <span class="number">0x49104000</span></span><br><span class="line">   +<span class="number">0x038</span> LoadCount        : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x03a</span> __Undefined5     : <span class="number">0x86f8</span></span><br><span class="line">   +<span class="number">0x03c</span> __Undefined6     : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> CheckSum         : <span class="number">0x1d5e</span></span><br><span class="line">   +<span class="number">0x044</span> TimeDateStamp    : <span class="number">0x2010002</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt pDriver</span><br><span class="line">Local var @ <span class="number">0x8cb309e0</span> Type _DRIVER_OBJECT*</span><br><span class="line"><span class="number">0x887dcae8</span> </span><br><span class="line">   +<span class="number">0x000</span> Type             : <span class="number">0</span>n4</span><br><span class="line">   +<span class="number">0x002</span> Size             : <span class="number">0</span>n168</span><br><span class="line">   +<span class="number">0x004</span> DeviceObject     : (null) </span><br><span class="line">   +<span class="number">0x008</span> Flags            : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x00c</span> DriverStart      : <span class="number">0x9609a000</span> Void</span><br><span class="line">   +<span class="number">0x010</span> DriverSize       : <span class="number">0x6000</span></span><br><span class="line">   +<span class="number">0x014</span> DriverSection    : <span class="number">0x887d8e50</span> Void</span><br><span class="line">   +<span class="number">0x018</span> DriverExtension  : <span class="number">0x887dcb90</span> _DRIVER_EXTENSION</span><br><span class="line">   +<span class="number">0x01c</span> DriverName       : _UNICODE_STRING <span class="string">&quot;\Driver\MyDriver2&quot;</span></span><br><span class="line">   +<span class="number">0x024</span> HardwareDatabase : <span class="number">0x84175250</span> _UNICODE_STRING <span class="string">&quot;\REGISTRY\MACHINE\HARDWARE\DESCRIPTION\SYSTEM&quot;</span></span><br><span class="line">   +<span class="number">0x028</span> FastIoDispatch   : (null) </span><br><span class="line">   +<span class="number">0x02c</span> DriverInit       : <span class="number">0x9609e000</span>     <span class="type">long</span>  MyDriver2!GsDriverEntry+<span class="number">0</span></span><br><span class="line">   +<span class="number">0x030</span> DriverStartIo    : (null) </span><br><span class="line">   +<span class="number">0x034</span> DriverUnload     : (null) </span><br><span class="line">   +<span class="number">0x038</span> MajorFunction    : [<span class="number">28</span>] <span class="number">0x83ebeda3</span>     <span class="type">long</span>  nt!IopInvalidDeviceRequest+<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt PKLDR_DATA_TABLE_ENTRY  <span class="number">0x83f53850</span> </span><br><span class="line">MyDriver2!PKLDR_DATA_TABLE_ENTRY</span><br><span class="line"><span class="number">0x86541c98</span> </span><br><span class="line">   +<span class="number">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class="number">0x86541c20</span> - <span class="number">0x83f53850</span> ]</span><br><span class="line">   +<span class="number">0x008</span> <span class="built_in">exp</span>              : _LIST_ENTRY [ <span class="number">0x83e81544</span> - <span class="number">0x12</span> ]</span><br><span class="line">   +<span class="number">0x010</span> un               : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x014</span> NonPagedDebugInfo : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x018</span> DllBase          : <span class="number">0x83e09000</span></span><br><span class="line">   +<span class="number">0x01c</span> EntryPoint       : <span class="number">0x83f284d8</span></span><br><span class="line">   +<span class="number">0x020</span> SizeOfImage      : <span class="number">0x412000</span></span><br><span class="line">   +<span class="number">0x024</span> FullDllName      : _UNICODE_STRING <span class="string">&quot;\SystemRoot\system32\ntkrnlpa.exe&quot;</span></span><br><span class="line">   +<span class="number">0x02c</span> BaseDllName      : _UNICODE_STRING <span class="string">&quot;ntoskrnl.exe&quot;</span></span><br><span class="line">   +<span class="number">0x034</span> Flags            : <span class="number">0x8004000</span></span><br><span class="line">   +<span class="number">0x038</span> LoadCount        : <span class="number">0x6c</span></span><br><span class="line">   +<span class="number">0x03a</span> __Undefined5     : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x03c</span> __Undefined6     : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x040</span> CheckSum         : <span class="number">0x3c88ac</span></span><br><span class="line">   +<span class="number">0x044</span> TimeDateStamp    : <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231202145017088.png" alt="image-20231202145017088"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">	LIST_ENTRY <span class="built_in">exp</span>;</span><br><span class="line">	ULONG un;</span><br><span class="line">	ULONG NonPagedDebugInfo;</span><br><span class="line">	ULONG DllBase;</span><br><span class="line">	ULONG EntryPoint;</span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">	ULONG Flags;</span><br><span class="line">	USHORT LoadCount;</span><br><span class="line">	USHORT __Undefined5;</span><br><span class="line">	ULONG  __Undefined6;</span><br><span class="line">	ULONG  CheckSum;</span><br><span class="line">	ULONG  TimeDateStamp;</span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE* IoDriverObjectType;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DRIVERUNLOAD</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;unload\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgBreakPoint();</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//UNICODE_STRING driverName = &#123; 0 &#125;;</span></span><br><span class="line">	<span class="comment">//RtlInitUnicodeString(&amp;driverName, L&quot;\\driver\\http&quot;);</span></span><br><span class="line"></span><br><span class="line">	UNICODE_STRING driverName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	RtlInitUnicodeString(&amp;driverName, <span class="string">L&quot;http.sys&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (next != pre)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (next-&gt;BaseDllName.Length != <span class="number">0</span> &amp;&amp; RtlCompareUnicodeString(&amp;driverName, &amp;next-&gt;BaseDllName, TRUE)==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//PDRIVER_OBJECT httpDriver = NULL;</span></span><br><span class="line">			<span class="comment">//NTSTATUS status = ObReferenceObjectByName(&amp;driverName, FILE_ALL_ACCESS, 0, 0, *IoDriverObjectType, KernelMode, NULL, *httpDriver);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="comment">//if (NT_SUCCESS(status))</span></span><br><span class="line">			<span class="comment">//&#123;</span></span><br><span class="line">				DbgPrintEx(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;%wZ\r\n&quot;</span>, &amp;next-&gt;FullDllName);</span><br><span class="line">				RemoveEntryList(&amp;next-&gt;InLoadOrderLinks);</span><br><span class="line">				<span class="comment">//httpDriver-&gt;DriverInit = NULL;</span></span><br><span class="line">				<span class="comment">//httpDriver-&gt;DriverSection = NULL;</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">//break;</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		next = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231203225145824.png" alt="image-20231203225145824"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">	LIST_ENTRY <span class="built_in">exp</span>;</span><br><span class="line">	ULONG un;</span><br><span class="line">	ULONG NonPagedDebugInfo;</span><br><span class="line">	ULONG DllBase;</span><br><span class="line">	ULONG EntryPoint;</span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">	ULONG Flags;</span><br><span class="line">	USHORT LoadCount;</span><br><span class="line">	USHORT __Undefined5;</span><br><span class="line">	ULONG  __Undefined6;</span><br><span class="line">	ULONG  CheckSum;</span><br><span class="line">	ULONG  TimeDateStamp;</span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line">NTKERNELAPI NTSTATUS <span class="title function_">ObReferenceObjectByName</span><span class="params">(</span></span><br><span class="line"><span class="params">	__in PUNICODE_STRING ObjectName,</span></span><br><span class="line"><span class="params">	__in ULONG Attributes,</span></span><br><span class="line"><span class="params">	__in_opt PACCESS_STATE AccessState,</span></span><br><span class="line"><span class="params">	__in_opt ACCESS_MASK DesiredAccess,</span></span><br><span class="line"><span class="params">	__in POBJECT_TYPE ObjectType,</span></span><br><span class="line"><span class="params">	__in KPROCESSOR_MODE AccessMode, </span></span><br><span class="line"><span class="params">	__inout_opt PVOID ParseContext,</span></span><br><span class="line"><span class="params">	__out PVOID* Object</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE* IoDriverObjectType;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DRIVERUNLOAD</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;unload\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgBreakPoint();</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span><br><span class="line"></span><br><span class="line">	UNICODE_STRING driverName1 = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	RtlInitUnicodeString(&amp;driverName1, <span class="string">L&quot;\\driver\\http&quot;</span>);</span><br><span class="line"></span><br><span class="line">	UNICODE_STRING driverName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	RtlInitUnicodeString(&amp;driverName, <span class="string">L&quot;http.sys&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (next != pre)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (next-&gt;BaseDllName.Length != <span class="number">0</span> &amp;&amp; RtlCompareUnicodeString(&amp;driverName, &amp;next-&gt;BaseDllName, TRUE)==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			PDRIVER_OBJECT httpDriver = <span class="literal">NULL</span>;</span><br><span class="line">			NTSTATUS status = ObReferenceObjectByName(&amp;driverName1, FILE_ALL_ACCESS, <span class="number">0</span>, <span class="number">0</span>, *IoDriverObjectType, KernelMode, <span class="literal">NULL</span>, &amp;httpDriver);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (NT_SUCCESS(status))</span><br><span class="line">			&#123;</span><br><span class="line">				RemoveEntryList(&amp;next-&gt;InLoadOrderLinks);</span><br><span class="line">				httpDriver-&gt;DriverInit = <span class="literal">NULL</span>;</span><br><span class="line">				httpDriver-&gt;DriverSection = <span class="literal">NULL</span>;</span><br><span class="line">				httpDriver-&gt;Type = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			DbgPrintEx(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;%wZ\r\n&quot;</span>, &amp;next-&gt;FullDllName);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		next = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"># 隐藏当前驱动</span><br><span class="line"># 调用完入口点在隐藏</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">	LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">	LIST_ENTRY <span class="built_in">exp</span>;</span><br><span class="line">	ULONG un;</span><br><span class="line">	ULONG NonPagedDebugInfo;</span><br><span class="line">	ULONG DllBase;</span><br><span class="line">	ULONG EntryPoint;</span><br><span class="line">	ULONG SizeOfImage;</span><br><span class="line">	UNICODE_STRING FullDllName;</span><br><span class="line">	UNICODE_STRING BaseDllName;</span><br><span class="line">	ULONG Flags;</span><br><span class="line">	USHORT LoadCount;</span><br><span class="line">	USHORT __Undefined5;</span><br><span class="line">	ULONG  __Undefined6;</span><br><span class="line">	ULONG  CheckSum;</span><br><span class="line">	ULONG  TimeDateStamp;</span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line">NTKERNELAPI NTSTATUS <span class="title function_">ObReferenceObjectByName</span><span class="params">(</span></span><br><span class="line"><span class="params">	__in PUNICODE_STRING ObjectName,</span></span><br><span class="line"><span class="params">	__in ULONG Attributes,</span></span><br><span class="line"><span class="params">	__in_opt PACCESS_STATE AccessState,</span></span><br><span class="line"><span class="params">	__in_opt ACCESS_MASK DesiredAccess,</span></span><br><span class="line"><span class="params">	__in POBJECT_TYPE ObjectType,</span></span><br><span class="line"><span class="params">	__in KPROCESSOR_MODE AccessMode,</span></span><br><span class="line"><span class="params">	__inout_opt PVOID ParseContext,</span></span><br><span class="line"><span class="params">	__out PVOID* Object</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE* IoDriverObjectType;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DriverHide</span><span class="params">(PWCH ObjName)</span></span><br><span class="line">&#123;</span><br><span class="line">	LARGE_INTEGER in = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	in.QuadPart = <span class="number">-10000</span> * <span class="number">5000</span>;</span><br><span class="line">	KeDelayExecutionThread(KernelMode, FALSE, in.QuadPart);</span><br><span class="line">	UNICODE_STRING driverName1 = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	RtlInitUnicodeString(&amp;ObjName, <span class="string">L&quot;\\driver\\http&quot;</span>);</span><br><span class="line">	PDRIVER_OBJECT httpDriver = <span class="literal">NULL</span>;</span><br><span class="line">	NTSTATUS status = ObReferenceObjectByName(&amp;driverName1, FILE_ALL_ACCESS, <span class="number">0</span>, <span class="number">0</span>, *IoDriverObjectType, KernelMode, <span class="literal">NULL</span>, &amp;httpDriver);</span><br><span class="line">	PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)httpDriver-&gt;DriverSection;</span><br><span class="line">	<span class="keyword">if</span> (NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		httpDriver-&gt;DriverSection = ldr-&gt;InLoadOrderLinks.Flink;</span><br><span class="line">		RemoveEntryList(&amp;ldr-&gt;InLoadOrderLinks);</span><br><span class="line">		DbgPrintEx(<span class="number">77</span>, <span class="number">0</span>, <span class="string">&quot;%wZ\r\n&quot;</span>, &amp;ldr-&gt;FullDllName);</span><br><span class="line">		httpDriver-&gt;DriverInit = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//httpDriver-&gt;Type = 0;</span></span><br><span class="line">		ObDereferenceObject(httpDriver);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DRIVERUNLOAD</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;unload\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span><br><span class="line">&#123;</span><br><span class="line">	DbgBreakPoint();</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	PKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span></span><br><span class="line"><span class="comment">	PKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment">	PKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	UNICODE_STRING driverName1 = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">	RtlInitUnicodeString(&amp;driverName1, L&quot;\\driver\\http&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	UNICODE_STRING driverName = &#123; 0 &#125;;</span></span><br><span class="line"><span class="comment">	RtlInitUnicodeString(&amp;driverName, L&quot;http.sys&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	while (next != pre)</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		if (next-&gt;BaseDllName.Length != 0 &amp;&amp; RtlCompareUnicodeString(&amp;driverName, &amp;next-&gt;BaseDllName, TRUE) == 0)</span></span><br><span class="line"><span class="comment">		&#123;</span></span><br><span class="line"><span class="comment">			PDRIVER_OBJECT httpDriver = NULL;</span></span><br><span class="line"><span class="comment">			NTSTATUS status = ObReferenceObjectByName(&amp;driverName1, FILE_ALL_ACCESS, 0, 0, *IoDriverObjectType, KernelMode, NULL, &amp;httpDriver);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			if (NT_SUCCESS(status))</span></span><br><span class="line"><span class="comment">			&#123;</span></span><br><span class="line"><span class="comment">				RemoveEntryList(&amp;next-&gt;InLoadOrderLinks);</span></span><br><span class="line"><span class="comment">				httpDriver-&gt;DriverInit = NULL;</span></span><br><span class="line"><span class="comment">				httpDriver-&gt;DriverSection = NULL;</span></span><br><span class="line"><span class="comment">				httpDriver-&gt;Type = 0;</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">			DbgPrintEx(77, 0, &quot;%wZ\r\n&quot;, &amp;next-&gt;FullDllName);</span></span><br><span class="line"><span class="comment">			break;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		next = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">	NTSTATUS status = PsCreateSystemThread(&amp;hThread, THREAD_ALL_ACCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, DriverHide, <span class="string">L&quot;\\driver\\http&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		NtClose(hThread);</span><br><span class="line">	&#125;</span><br><span class="line">	pDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>dll 驱动必须通过主驱动调用加载</p>
<h3 id="蓝屏分析"><a class="markdownIt-Anchor" href="#蓝屏分析">#</a> 蓝屏分析</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">analyze -v</span><br><span class="line">kv   // 查看堆栈调用</span><br><span class="line"></span><br><span class="line">For analysis of this file, run !analyze -v</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">83e85110 cc              int     3</span><br><span class="line">0: kd&gt; !analyze -v</span><br><span class="line">*******************************************************************************</span><br><span class="line">*                                                                             *</span><br><span class="line">*                        Bugcheck Analysis                                    *</span><br><span class="line">*                                                                             *</span><br><span class="line">*******************************************************************************</span><br><span class="line"></span><br><span class="line">SYSTEM_THREAD_EXCEPTION_NOT_HANDLED (7e)</span><br><span class="line">This is a very common bugcheck.  Usually the exception address pinpoints</span><br><span class="line">the driver/function that caused the problem.  Always note this address</span><br><span class="line">as well as the link date of the driver/image that contains this address.</span><br><span class="line">Arguments:</span><br><span class="line">Arg1: c0000005, The exception code that was not handled</span><br><span class="line">Arg2: 952fe02f, The address that the exception occurred at</span><br><span class="line">Arg3: 8cb3490c, Exception Record Address</span><br><span class="line">Arg4: 8cb34370, Context Record Address</span><br><span class="line"></span><br><span class="line">Debugging Details:</span><br><span class="line">------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Press ctrl-c (cdb, kd, ntsd) or ctrl-break (windbg) to abort symbol loads that take too long.</span><br><span class="line">Run !sym noisy before .reload to track down problems loading symbols.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">KEY_VALUES_STRING: 1</span><br><span class="line"></span><br><span class="line">    Key  : AV.Dereference</span><br><span class="line">    Value: NullPtr</span><br><span class="line"></span><br><span class="line">    Key  : AV.Fault</span><br><span class="line">    Value: Write</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.CPU.Sec</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.DebugAnalysisProvider.CPP</span><br><span class="line">    Value: Create: 8007007e on DESKTOP-BEKKQKM</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.DebugData</span><br><span class="line">    Value: CreateObject</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.DebugModel</span><br><span class="line">    Value: CreateObject</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.Elapsed.Sec</span><br><span class="line">    Value: 17</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.Memory.CommitPeak.Mb</span><br><span class="line">    Value: 77</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.System</span><br><span class="line">    Value: CreateObject</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BUGCHECK_CODE:  7e</span><br><span class="line"></span><br><span class="line">BUGCHECK_P1: ffffffffc0000005</span><br><span class="line"></span><br><span class="line">BUGCHECK_P2: ffffffff952fe02f</span><br><span class="line"></span><br><span class="line">BUGCHECK_P3: ffffffff8cb3490c</span><br><span class="line"></span><br><span class="line">BUGCHECK_P4: ffffffff8cb34370</span><br><span class="line"></span><br><span class="line">EXCEPTION_RECORD:  8cb3490c -- (.exr 0xffffffff8cb3490c)</span><br><span class="line">ExceptionAddress: 952fe02f (MyDriver3!DriverEntry+0x0000000f)</span><br><span class="line">   ExceptionCode: c0000005 (Access violation)</span><br><span class="line">  ExceptionFlags: 00000000</span><br><span class="line">NumberParameters: 2</span><br><span class="line">   Parameter[0]: 00000001</span><br><span class="line">   Parameter[1]: 00000000</span><br><span class="line">Attempt to write to address 00000000</span><br><span class="line"></span><br><span class="line">CONTEXT:  8cb34370 -- (.cxr 0xffffffff8cb34370)</span><br><span class="line">eax=00000000 ebx=00000000 ecx=bb40e64e edx=00000651 esi=868ac9a8 edi=866c2000</span><br><span class="line">eip=952fe02f esp=8cb349d4 ebp=8cb349d8 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=0008  ss=0010  ds=0023  es=0023  fs=0030  gs=0000             efl=00010206</span><br><span class="line">MyDriver3!DriverEntry+0xf:</span><br><span class="line">952fe02f c70050000000    mov     dword ptr [eax],50h  ds:0023:00000000=????????</span><br><span class="line">Resetting default scope</span><br><span class="line"></span><br><span class="line">PROCESS_NAME:  System</span><br><span class="line"></span><br><span class="line">WRITE_ADDRESS:  00000000 </span><br><span class="line"></span><br><span class="line">ERROR_CODE: (NTSTATUS) 0xc0000005 - 0x%p            0x%p                    %s</span><br><span class="line"></span><br><span class="line">EXCEPTION_CODE_STR:  c0000005</span><br><span class="line"></span><br><span class="line">EXCEPTION_PARAMETER1:  00000001</span><br><span class="line"></span><br><span class="line">EXCEPTION_PARAMETER2:  00000000</span><br><span class="line"></span><br><span class="line">EXCEPTION_STR:  0xc0000005</span><br><span class="line"></span><br><span class="line">STACK_TEXT:  </span><br><span class="line">8cb349d8 83fce2e6 868ac9a8 866c2000 00000000 MyDriver3!DriverEntry+0xf [C:\Users\Administrator\source\repos\MyDriver3\MyDriver3\main.c @ 16] </span><br><span class="line">8cb34bbc 83fd1d98 00000001 00000000 8cb34be4 nt!IopLoadDriver+0x7ed</span><br><span class="line">8cb34c00 83e87aab 961f6bd0 00000000 86601020 nt!IopLoadUnloadDriver+0x70</span><br><span class="line">8cb34c50 84013f5e 00000001 c9778f12 00000000 nt!ExpWorkerThread+0x10d</span><br><span class="line">8cb34c90 83ebb219 83e8799e 00000001 00000000 nt!PspSystemThreadStartup+0x9e</span><br><span class="line">00000000 00000000 00000000 00000000 00000000 nt!KiThreadStartup+0x19</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FAULTING_SOURCE_LINE:  C:\Users\Administrator\source\repos\MyDriver3\MyDriver3\main.c</span><br><span class="line"></span><br><span class="line">FAULTING_SOURCE_FILE:  C:\Users\Administrator\source\repos\MyDriver3\MyDriver3\main.c</span><br><span class="line"></span><br><span class="line">FAULTING_SOURCE_LINE_NUMBER:  16</span><br><span class="line"></span><br><span class="line">FAULTING_SOURCE_CODE:  </span><br><span class="line">    12: &#123;</span><br><span class="line">    13: 	DbgBreakPoint();</span><br><span class="line">    14: </span><br><span class="line">    15: 	int* x = 0;</span><br><span class="line">&gt;   16: 	*x = 80;</span><br><span class="line">    17: </span><br><span class="line">    18: 	pDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class="line">    19: 	return STATUS_SUCCESS;</span><br><span class="line">    20: &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SYMBOL_NAME:  MyDriver3!DriverEntry+f</span><br><span class="line"></span><br><span class="line">IMAGE_NAME:  MyDriver3.sys</span><br><span class="line"></span><br><span class="line">MODULE_NAME: MyDriver3</span><br><span class="line"></span><br><span class="line">STACK_COMMAND:  .cxr 0xffffffff8cb34370 ; kb</span><br><span class="line"></span><br><span class="line">FAILURE_BUCKET_ID:  0x7E_MyDriver3!DriverEntry+f</span><br><span class="line"></span><br><span class="line">OS_VERSION:  7.1.7601.17514</span><br><span class="line"></span><br><span class="line">BUILDLAB_STR:  win7sp1_rtm</span><br><span class="line"></span><br><span class="line">OSPLATFORM_TYPE:  x86</span><br><span class="line"></span><br><span class="line">OSNAME:  Windows 7</span><br><span class="line"></span><br><span class="line">FAILURE_ID_HASH:  &#123;82a16a6f-d5b4-0708-1c67-c393a5a8a872&#125;</span><br><span class="line"></span><br><span class="line">Followup:     MachineOwner</span><br><span class="line">---------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0: kd&gt; kv</span><br><span class="line"> # ChildEBP RetAddr  Args to Child              </span><br><span class="line">00 83f32b10 83e8510b 00000001 83e850dd 00000002 nt!RtlpBreakWithStatusInstruction (FPO: [1,0,0])</span><br><span class="line">01 83f32b18 83e850dd 00000002 00000000 fffffffd nt!KdCheckForDebugBreak+0x22 (FPO: [0,0,0])</span><br><span class="line">02 83f32b48 83e84f6b 83e81e1a bc788c41 00000000 nt!KeUpdateRunTime+0x164</span><br><span class="line">03 83f32ba0 83e89c17 01da2802 01da2802 000000d1 nt!KeUpdateSystemTime+0x613</span><br><span class="line">04 83f32ba0 83e81e1a 01da2802 01da2802 000000d1 nt!KeUpdateSystemTimeAssist+0x13 (FPO: [0,2] TrapFrame @ 83f32bb4)</span><br><span class="line">05 83f32c24 00000000 0000000e 00000000 00000000 nt!KiIdleLoop+0x1a (FPO: [0,0,0])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dump 文件在 配置路径下</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231206223053930.png" alt="image-20231206223053930"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231206223751789.png" alt="image-20231206223751789"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231206224032245.png" alt="image-20231206224032245"></p>
<p>将 memory 拖到 windbg 分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dds esp </span><br><span class="line">8cb34218  0000007e</span><br><span class="line">8cb3421c  c0000005</span><br><span class="line">8cb34220  952fe02f MyDriver3+0x102f</span><br><span class="line">8cb34224  8cb3490c</span><br><span class="line">8cb34228  8cb34370</span><br><span class="line">8cb3422c  00000000</span><br><span class="line">8cb34230  8cb34c90</span><br><span class="line">8cb34234  84013f9e nt!RtlAnsiStringToUnicodeString+0x1dd</span><br><span class="line">8cb34238  0000007e</span><br><span class="line">8cb3423c  c0000005</span><br><span class="line">8cb34240  952fe02f MyDriver3+0x102f</span><br><span class="line">8cb34244  8cb3490c</span><br><span class="line">8cb34248  8cb34370</span><br><span class="line">8cb3424c  83e84494 nt!alloca_probe+0x130</span><br><span class="line">8cb34250  00000000</span><br><span class="line">8cb34254  8cb34c90</span><br><span class="line">8cb34258  83e60d48 nt!NtBuildGUID+0xbcc4</span><br><span class="line">8cb3425c  8cb34284</span><br><span class="line">8cb34260  83ec9d5a nt!PsGetCurrentProcessSessionId+0x1a8</span><br><span class="line">8cb34264  00000000</span><br><span class="line">8cb34268  00000000</span><br><span class="line">8cb3426c  00000000</span><br><span class="line">8cb34270  8cb3490c</span><br><span class="line">8cb34274  8cb34370</span><br><span class="line">8cb34278  83e60d58 nt!NtBuildGUID+0xbcd4</span><br><span class="line">8cb3427c  00000001</span><br><span class="line">8cb34280  00e0a000</span><br><span class="line">8cb34284  8cb342a8</span><br><span class="line">8cb34288  83e82622 nt!KeReleaseInStackQueuedSpinLockFromDpcLevel+0x1e6</span><br><span class="line">8cb3428c  fffffffe</span><br><span class="line">8cb34290  8cb34c80</span><br><span class="line">8cb34294  8cb34370</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BUGCHECK_CODE:  7e</span><br><span class="line">Bug Check 0x7E: SYSTEM_THREAD_EXCEPTION_NOT_HANDLED</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231209161413434.png" alt="image-20231209161413434"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Arguments:</span><br><span class="line">Arg1: c0000005, The exception code that was not handled</span><br><span class="line">Arg2: 952fe02f, The address that the exception occurred at</span><br><span class="line">Arg3: 8cb3490c, Exception Record Address</span><br><span class="line">Arg4: 8cb34370, Context Record Address</span><br><span class="line"></span><br><span class="line">// 代码蓝屏位置</span><br><span class="line">MyDriver3+0x102f:</span><br><span class="line">952fe02f c70050000000    mov     dword ptr [eax],50h  ds:0023:00000000=????????</span><br><span class="line"></span><br><span class="line">0: kd&gt; .trap TrapFrame</span><br><span class="line">ESP EDITED! New esp=00000001</span><br><span class="line">ErrCode = fffffffe</span><br><span class="line">eax=00000001 ebx=badb0d00 ecx=83e4b3d8 edx=8cb34960 esi=952fe02f edi=8cb349d8</span><br><span class="line">eip=83ead744 esp=8cb34980 ebp=00000651 iopl=0         nv up di pl nz na po nc</span><br><span class="line">cs=0000  ss=0010  ds=0000  es=0095  fs=8d8a  gs=0000             efl=00000000</span><br><span class="line">nt!RtlInitEnumerationHashTable+0xb17:</span><br><span class="line">83ead744 c23400          ret     34h</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>内核线程栈 12k</p>
<h3 id="驱动通信"><a class="markdownIt-Anchor" href="#驱动通信">#</a> 驱动通信</h3>
<p>一个 DRIVER_OBJECT 可以管理多个设备</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt _DRIVER_OBJECT</span><br><span class="line">nt!_DRIVER_OBJECT</span><br><span class="line">   +0x000 Type             : Int2B</span><br><span class="line">   +0x002 Size             : Int2B</span><br><span class="line">   +0x004 DeviceObject     : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +0x008 Flags            : Uint4B</span><br><span class="line">   +0x00c DriverStart      : Ptr32 Void</span><br><span class="line">   +0x010 DriverSize       : Uint4B</span><br><span class="line">   +0x014 DriverSection    : Ptr32 Void</span><br><span class="line">   +0x018 DriverExtension  : Ptr32 _DRIVER_EXTENSION</span><br><span class="line">   +0x01c DriverName       : _UNICODE_STRING</span><br><span class="line">   +0x024 HardwareDatabase : Ptr32 _UNICODE_STRING</span><br><span class="line">   +0x028 FastIoDispatch   : Ptr32 _FAST_IO_DISPATCH</span><br><span class="line">   +0x02c DriverInit       : Ptr32     long </span><br><span class="line">   +0x030 DriverStartIo    : Ptr32     void </span><br><span class="line">   +0x034 DriverUnload     : Ptr32     void </span><br><span class="line">   +0x038 MajorFunction    : [28] Ptr32     long </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _DEVICE_OBJECT</span><br><span class="line">nt!_DEVICE_OBJECT</span><br><span class="line">   +0x000 Type             : Int2B</span><br><span class="line">   +0x002 Size             : Uint2B</span><br><span class="line">   +0x004 ReferenceCount   : Int4B</span><br><span class="line">   +0x008 DriverObject     : Ptr32 _DRIVER_OBJECT</span><br><span class="line">   +0x00c NextDevice       : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +0x010 AttachedDevice   : Ptr32 _DEVICE_OBJECT</span><br><span class="line">   +0x014 CurrentIrp       : Ptr32 _IRP</span><br><span class="line">   +0x018 Timer            : Ptr32 _IO_TIMER</span><br><span class="line">   +0x01c Flags            : Uint4B</span><br><span class="line">   +0x020 Characteristics  : Uint4B</span><br><span class="line">   +0x024 Vpb              : Ptr32 _VPB</span><br><span class="line">   +0x028 DeviceExtension  : Ptr32 Void</span><br><span class="line">   +0x02c DeviceType       : Uint4B</span><br><span class="line">   +0x030 StackSize        : Char</span><br><span class="line">   +0x034 Queue            : &lt;unnamed-tag&gt;</span><br><span class="line">   +0x05c AlignmentRequirement : Uint4B</span><br><span class="line">   +0x060 DeviceQueue      : _KDEVICE_QUEUE</span><br><span class="line">   +0x074 Dpc              : _KDPC</span><br><span class="line">   +0x094 ActiveThreadCount : Uint4B</span><br><span class="line">   +0x098 SecurityDescriptor : Ptr32 Void</span><br><span class="line">   +0x09c DeviceLock       : _KEVENT</span><br><span class="line">   +0x0ac SectorSize       : Uint2B</span><br><span class="line">   +0x0ae Spare1           : Uint2B</span><br><span class="line">   +0x0b0 DeviceObjectExtension : Ptr32 _DEVOBJ_EXTENSION</span><br><span class="line">   +0x0b4 Reserved         : Ptr32 Void</span><br><span class="line"></span><br><span class="line">PDO 物理设备</span><br><span class="line">FDO filter device  io</span><br><span class="line">附加设备：FDO 附加到 PDO</span><br><span class="line">三环首先访问到FDO，经过多个FDO，访问到PDO 。PDO返回逐FDO返回</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _IRP</span><br><span class="line">nt!_IRP</span><br><span class="line">   +0x000 Type             : Int2B</span><br><span class="line">   +0x002 Size             : Uint2B</span><br><span class="line">   +0x004 MdlAddress       : Ptr32 _MDL</span><br><span class="line">   +0x008 Flags            : Uint4B</span><br><span class="line">   +0x00c AssociatedIrp    : &lt;unnamed-tag&gt;</span><br><span class="line">   +0x010 ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +0x018 IoStatus         : _IO_STATUS_BLOCK</span><br><span class="line">   +0x020 RequestorMode    : Char</span><br><span class="line">   +0x021 PendingReturned  : UChar</span><br><span class="line">   +0x022 StackCount       : Char			// 设备栈层数</span><br><span class="line">   +0x023 CurrentLocation  : Char			// 设备栈索引</span><br><span class="line">   +0x024 Cancel           : UChar</span><br><span class="line">   +0x025 CancelIrql       : UChar</span><br><span class="line">   +0x026 ApcEnvironment   : Char</span><br><span class="line">   +0x027 AllocationFlags  : UChar</span><br><span class="line">   +0x028 UserIosb         : Ptr32 _IO_STATUS_BLOCK</span><br><span class="line">   +0x02c UserEvent        : Ptr32 _KEVENT</span><br><span class="line">   +0x030 Overlay          : &lt;unnamed-tag&gt;</span><br><span class="line">   +0x038 CancelRoutine    : Ptr32     void </span><br><span class="line">   +0x03c UserBuffer       : Ptr32 Void</span><br><span class="line">   +0x040 Tail             : &lt;unnamed-tag&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      <div class="tags">
          <a href="/tags/%E9%80%86%E5%90%91/" rel="tag"><i class="ic i-tag"></i> 逆向</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2023-12-20 23:19:23" itemprop="dateModified" datetime="2023-12-20T23:19:23+08:00">2023-12-20</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2023/10/03/hg%20ker/" title="hg内核">http://example.com/2023/10/03/hg ker/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/10/01/1234567/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;a1f3404a5032323ea4857ac5a6354d2f.jpg" title="windows逆向进阶">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> 逆向</span>
  <h3>windows逆向进阶</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2024/01/01/istio/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;2e0802e6e5cfd05c700bc3f911f9351c.jpg" title="istio">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> 运维</span>
  <h3>istio</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#hg%E5%86%85%E6%A0%B8"><span class="toc-number">1.</span> <span class="toc-text"> hg 内核</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text"> 环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text"> 保护模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cpu"><span class="toc-number">1.2.1.</span> <span class="toc-text"> CPU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AE%B5%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 段寄存器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C"><span class="toc-number">1.2.2.1.</span> <span class="toc-text"> 实验：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#db_g"><span class="toc-number">1.2.3.</span> <span class="toc-text"> DB_G</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#g"><span class="toc-number">1.2.3.1.</span> <span class="toc-text"> G</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#db"><span class="toc-number">1.2.3.2.</span> <span class="toc-text"> D&#x2F;B</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%A3%80%E6%B5%8B"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 权限检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%B8%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.4.1.</span> <span class="toc-text"> 裸函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jmp-call-ref"><span class="toc-number">1.2.4.2.</span> <span class="toc-text"> jmp call ref</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%97%A8"><span class="toc-number">1.2.5.</span> <span class="toc-text"> 调用门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E9%97%A8"><span class="toc-number">1.2.6.</span> <span class="toc-text"> 中断门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hook-int3"><span class="toc-number">1.2.7.</span> <span class="toc-text"> hook int3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%B7%E9%98%B1%E9%97%A8"><span class="toc-number">1.2.8.</span> <span class="toc-text"> 陷阱门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%AE%B5"><span class="toc-number">1.2.9.</span> <span class="toc-text"> 任务段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E9%97%A8"><span class="toc-number">1.2.10.</span> <span class="toc-text"> 任务门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE101012"><span class="toc-number">1.2.11.</span> <span class="toc-text"> 配置 101012</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%BD%E7%81%B5%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.12.</span> <span class="toc-text"> 幽灵地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B5%E5%B1%9E%E6%80%A7"><span class="toc-number">1.2.13.</span> <span class="toc-text"> 页属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B5%E5%9F%BA%E5%9D%80"><span class="toc-number">1.2.14.</span> <span class="toc-text"> 页基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#29912"><span class="toc-number">1.2.15.</span> <span class="toc-text"> 29912</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.16.</span> <span class="toc-text"> 缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tlb"><span class="toc-number">1.2.17.</span> <span class="toc-text"> TLB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">1.2.18.</span> <span class="toc-text"> 控制寄存器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.3.</span> <span class="toc-text"> 驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hello-world"><span class="toc-number">1.3.1.</span> <span class="toc-text"> hello world</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 字符串函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 创建线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8-2"><span class="toc-number">1.3.5.</span> <span class="toc-text"> 驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E6%96%AD%E9%93%BE"><span class="toc-number">1.3.6.</span> <span class="toc-text"> 驱动断链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%93%9D%E5%B1%8F%E5%88%86%E6%9E%90"><span class="toc-number">1.3.7.</span> <span class="toc-text"> 蓝屏分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E9%80%9A%E4%BF%A1"><span class="toc-number">1.3.8.</span> <span class="toc-text"> 驱动通信</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/11/01/%E6%B1%87%E7%BC%96/" rel="bookmark" title="汇编">汇编</a></li><li><a href="/2022/11/11/reverse/" rel="bookmark" title="逆向">逆向</a></li><li><a href="/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/" rel="bookmark" title="水滴rev">水滴rev</a></li><li><a href="/2023/08/15/%E7%A0%B4%E8%A7%A3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B9%8B%E8%AE%A4%E8%AF%86%E5%A3%B3%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%89%B9%E5%BE%81/" rel="bookmark" title="破解基础知识之认识壳与程序的特征">破解基础知识之认识壳与程序的特征</a></li><li><a href="/2023/08/22/%E5%8E%BB%E5%BC%B9%E7%AA%97%E7%BB%BF%E5%8C%96/" rel="bookmark" title="破解相关">破解相关</a></li><li><a href="/2023/10/01/1234567/" rel="bookmark" title="windows逆向进阶">windows逆向进阶</a></li><li class="active"><a href="/2023/10/03/hg%20ker/" rel="bookmark" title="hg内核">hg内核</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">41</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">6</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">6</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/10/01/1234567/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2024/01/01/istio/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/05/20/Kubernetes/" title="Kubernetes">Kubernetes</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/06/02/k8s%E9%AB%98%E7%BA%A7/" title="k8s高级">k8s高级</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/08/16/Unserialize/" title="unserialize">unserialize</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/04/07/TCPIP_new/" title="TCP&#x2F;IP">TCP/IP</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/08/15/%E7%A0%B4%E8%A7%A3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B9%8B%E8%AE%A4%E8%AF%86%E5%A3%B3%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%89%B9%E5%BE%81/" title="破解基础知识之认识壳与程序的特征">破解基础知识之认识壳与程序的特征</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/03/27/http/" title="http">http</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%BD%91%E7%BB%9C/" title="In 网络">网络</a>
</div>

    <span><a href="/2023/01/20/VXLAN/" title="VXLAN">VXLAN</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%A7%8B%E6%8B%9B/" title="In 秋招">秋招</a>
</div>

    <span><a href="/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/" title="秋招总结">秋招总结</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/02/28/XSS/" title="XSS">XSS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/04/15/Nginx_new/" title="Nginx">Nginx</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/10/03/hg ker/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
