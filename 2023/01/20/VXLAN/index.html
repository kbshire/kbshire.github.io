



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="网络" />


<link rel="canonical" href="http://example.com/2023/01/20/VXLAN/">



  <title>
VXLAN - 网络 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">VXLAN
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2023-01-20 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2023-01-20T13:38:45+08:00">2023-01-20</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/6edf0eae0c5c58dadd09198c6c3c9f6d.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/132a88e4e5cfe7e3847ed93deae688d2.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/8cf4932745804d12b330608b12a53aca.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/7b6444f4b5464a4670e99b60aca4dbbf.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/46d0371c19c0586fb0629e97bac23133.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/fdfd6e7899b03b32390187931cea99ba.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="item" rel="index" title="In 网络"><span itemprop="name">网络</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/20/VXLAN/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="vxlan"><a class="markdownIt-Anchor" href="#vxlan">#</a> VXLAN</h1>
<h2 id="enspvirtualbox设置"><a class="markdownIt-Anchor" href="#enspvirtualbox设置">#</a> ensp&amp;virtualbox 设置</h2>
<p>1. 导入 CE 镜像</p>
<p>拖一台 CE12800，启动设备，系统会让自动选择镜像，选择 CE 镜像，正确的镜像为 1.3G 的</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101221931649.png" alt="image-20230101221931649"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222035060.png" alt="image-20230101222035060"></p>
<p>导入后 virtualbox 中会显示</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101221847981.png" alt="image-20230101221847981"></p>
<p>更改 CE 设置，设置内存，每台 CE12800 大概需要 1G 内存</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222420086.png" alt="image-20230101222420086"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222459733.png" alt="image-20230101222459733"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222528294.png" alt="image-20230101222528294"></p>
<h2 id="vxlan-2"><a class="markdownIt-Anchor" href="#vxlan-2">#</a> VXLAN</h2>
<p>VXLAN 是由 IETF 定义的 NVO3 (Network Virtualization over Layer 3) 标准技术之一，采用 L2 over L4 ( MAC-in-UDP) 的报文封装模式，将二层报文用三层协议进行封装，可实现二层网络在三层范围内进行扩展，同时满足数据中心大二层虚拟迁移和多租户的需求。</p>
<p>Vxlan 是一种无控制平面，利用底层 IP 网络实现二层通信的隧道技术。</p>
<p>GRE 也是无控制平面，不需要使用协议维护隧道状态。比如 LDP 是 LSP 的控制平面。</p>
<p>底层的 IP 网络称为 Underlay 网络，Vxlan 则称为 Overlayer 网络。</p>
<h2 id="名词解释"><a class="markdownIt-Anchor" href="#名词解释">#</a> 名词解释</h2>
<h3 id="nvo3-nve"><a class="markdownIt-Anchor" href="#nvo3-nve">#</a> NVO3 &amp; NVE</h3>
<p>NVO3 (Network Virtualization Over Layer 3), 基于三层 IP overlay 网络构建虚拟网络技术统称为 NVO3。运行 NVO3 的设备叫做 NVE (NetworkVirtualization Edge) ，它位于 overlay 网络的边界，实现二、三层的虚拟化功能。<strong>NVE 是执行 VXLAN 封装和接封装的设备</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101223857131.png" alt="image-20230101223857131"></p>
<h3 id="vtep"><a class="markdownIt-Anchor" href="#vtep">#</a> VTEP</h3>
<p><strong>VXLAN 网络中的 NVE 以 VTEP 进行标识</strong>，VTEP (VXLAN Tunnel Endpoint，VXLAN 隧道端点)<br>
 每一个 NVE 至少有一个 VTEP，VTEP 使用 NVE 的 IP 地址表示<br>
两个 VTEP 可以确定一条 VXLAN 隧道，VTEP 间的这条 VXLAN 隧道将被两个 NVE 间的所有 VNI 所公用</p>
<p>VTEP 即标识设备，也标识 VXLAN 隧道，两个 VTEP 地址之间唯一的确定一条 VXLAN 隧道。所以 VTEP 的地址要求全网可达</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101223916250.png" alt="image-20230101223916250" style="zoom: 80%;" /> 
<h3 id="vni"><a class="markdownIt-Anchor" href="#vni">#</a> VNI</h3>
<p>VNI - VXLAN 网络标识符</p>
<p><strong>VNI 是一种类似于 VLANID 的用户标示，一个 VNl 代表了一个租户</strong>，属于不同 VNI 的虚拟机之间不能直接进行二层通信。VXLAN 报文封装时，给 VNI 分配了足够的空间使其可以支持海量租户的隔离。</p>
<p>应用场景</p>
<p>虚拟机在同一网段需要互访的情景，在没有 VXLAN 是，只能在同一个物理机上。使用 VXLAN，可以去除网络限制，使资源分配</p>
<p>2 层 VPN：封装的对象是帧，VXLAN，TRILL，L2TP，PPTP，VPLS</p>
<p>3 层 VPN：封装的对象是包，IPSEC，GRE，DSVPN，MPLS VPN</p>
<p>ipsec vpn 隧道模式，3 层 vpn</p>
<p>ipsec vpn 传输模式，只封装 IP 之上的内容</p>
<p>应用层 VPN：SSL VPN</p>
<p>MPLS VPN：三层</p>
<p>VPLS：二层</p>
<h2 id="实验1同子网互访"><a class="markdownIt-Anchor" href="#实验1同子网互访">#</a> 实验 1: 同子网互访</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">LSW1 &amp; LSW2</span><br><span class="line">trunk - access </span><br><span class="line"></span><br><span class="line">CE1 &amp; CE2 &amp; CE3</span><br><span class="line">1.underlay</span><br><span class="line">配置物理接口&amp;环回口地址</span><br><span class="line">配置路由协议</span><br><span class="line">2.VXLAN业务接入配置</span><br><span class="line">配置BD域:BD域用于在NVE上本地区分不同的大二层网络，本地有效,没有全局意义，每一个BD域只能关联一个vni，在一台NVE上不同BD域需要关联不同VNI</span><br><span class="line">bridge-domain 10 </span><br><span class="line">VXLAN vni 10</span><br><span class="line">将vlanid和BD域关联，BD域又和vni关联</span><br><span class="line">int g1/0/0.10 mode l2</span><br><span class="line">encapsulation dot1q vid 10</span><br><span class="line">bridge-domain 10</span><br><span class="line">创建VXLAN隧道</span><br><span class="line">int nve 1</span><br><span class="line">source 2.2.2.2</span><br><span class="line">vin 10 head-end peer-list 3.3.3.3</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110110558492.png" alt="image-20230110110558492"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">LSW1</span><br><span class="line">vlan batch 10 20 30 40</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/1</span><br><span class="line"> port link-type access</span><br><span class="line"> port default vlan 10</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/2</span><br><span class="line"> port link-type trunk</span><br><span class="line"> port trunk allow-pass vlan 2 to 4094</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/3</span><br><span class="line"> port link-type access</span><br><span class="line"> port default vlan 30</span><br><span class="line"></span><br><span class="line">CE2</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">bridge-domain 20</span><br><span class="line"> vxlan vni 20</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 2.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0.10 mode l2</span><br><span class="line"> encapsulation dot1q vid 10</span><br><span class="line"> bridge-domain 10</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0.30 mode l2</span><br><span class="line"> encapsulation dot1q vid 30</span><br><span class="line"> bridge-domain 20</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.12.2 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 2.2.2.2</span><br><span class="line"> vni 10 head-end peer-list 3.3.3.3</span><br><span class="line"> vni 20 head-end peer-list 3.3.3.3</span><br><span class="line"> </span><br><span class="line">CE3</span><br><span class="line">bridge-domain 20</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">bridge-domain 30</span><br><span class="line"> vxlan vni 20</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 3.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.3 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.20 mode l2</span><br><span class="line"> encapsulation dot1q vid 20</span><br><span class="line"> bridge-domain 20</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.40 mode l2</span><br><span class="line"> encapsulation dot1q vid 40</span><br><span class="line"> bridge-domain 30</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 3.3.3.3 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 3.3.3.3</span><br><span class="line"> vni 10 head-end peer-list 2.2.2.2</span><br><span class="line"> vni 20 head-end peer-list 2.2.2.2</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110111117399.png" alt="image-20230110111117399"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110111302369.png" alt="image-20230110111302369"></p>
<p>数据帧在 CE2 通过子接口，MAC，BD 上形成 MAC 地址表</p>
<p>MAC-IN-UDP  通过封装 UDP 实现按照流的负载分担，Dport 4789</p>
<p>在 VXLAN 中，不关心主机所在 VXLAN，只要在同一网段即可实现</p>
<p>既可以实现网络虚拟化，将网络虚拟为两个不同的虚拟网络，租户之间网络隔离</p>
<p>此时逻辑拓扑变为虚拟交换机连接同一租户的不同设备</p>
<p>在公有云场景，为了适应虚拟机迁移的场景，使用 SDN 动态下发配置</p>
<p>VXLAN 头端复制</p>
<p>将 VXLAN 报文复制多份发给每一个当前 vni 中的 peer list</p>
<p>vxlan 网络对 BUM 报文的转发行为默认是头端复制   broadcast-unknown-Multicast</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111205055822.png" alt="image-20230111205055822"></p>
<p>VXLAN I flag: 必须置为 1，标识 VNI 字段有效。</p>
<p>UDP Dest Port: VXLAN 保留 UDP 目的端口号，默认为 4789</p>
<p>UDP Source Port: 根据数据流 HASH 动态生成。</p>
<p>不同流封装类型的接口对报文的处理方式</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111211200322.png" alt="image-20230111211200322"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111213612876.png" alt="image-20230111213612876"></p>
<p>一个物理接口下如果存在 default 接口，那么不能存在其他类型的接口</p>
<h2 id="实验二跨子网互通集中式网关"><a class="markdownIt-Anchor" href="#实验二跨子网互通集中式网关">#</a> 实验二：跨子网互通（集中式网关）</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">CE1作为网关</span><br><span class="line">bridge-domain 10</span><br><span class="line"></span><br><span class="line">bridge-domain 20</span><br><span class="line"></span><br><span class="line">int vbdif 10</span><br><span class="line">ip add 192.168.1.254 24 </span><br><span class="line">int vbdif 20</span><br><span class="line">ip add 192.168.2.254 24 </span><br><span class="line"></span><br><span class="line">CE2 - CE1 建立VXLAN </span><br><span class="line">int nve 1</span><br><span class="line">vni 10 head peer 1.1.1.1</span><br><span class="line">vni 20 head peer 1.1.1.1 </span><br><span class="line">CE3 - CE1 建立VXLAN</span><br><span class="line">int nve 1</span><br><span class="line">vni 10 head peer 1.1.1.1</span><br><span class="line">vni 20 head peer 1.1.1.1 </span><br><span class="line"></span><br><span class="line">int nv1 </span><br><span class="line">vni 10 head peer 2.2.2.2 3.3.3.3</span><br><span class="line">vni 20 head peer 2.2.2.2 3.3.3.3</span><br><span class="line"></span><br><span class="line">主机网关设置vdbif接口地址</span><br><span class="line"></span><br><span class="line">对于多租户在网关上使用ip vpn-instance 实现</span><br><span class="line"></span><br><span class="line">ip vpn-instance A</span><br><span class="line">route-dist 1:1</span><br><span class="line"></span><br><span class="line">int vbdif 10 </span><br><span class="line">ip binding vpn-instance 10</span><br><span class="line">ip add </span><br><span class="line"></span><br><span class="line">int vbdif 20 </span><br><span class="line">ip binding vpn-instance 10</span><br><span class="line">ip add </span><br><span class="line"></span><br><span class="line">对于每一个租户分配一个VPN-instance </span><br><span class="line"></span><br><span class="line">对于普通的vlan网络，设置接口类型，vlanif接口，即可实现vlan与VXLAN互通</span><br><span class="line"></span><br><span class="line">对于需要访问外网的场景</span><br><span class="line">将VPN-instance中的路由泄露到public中，在VPN-instance中添加了一条静态路由</span><br><span class="line">ip route-static vpn-instance A 0.0.0.0 0 10.1.11.10 public</span><br><span class="line"></span><br><span class="line">注意回包路由</span><br><span class="line">1.将租户路由引回私网中</span><br><span class="line">ip route-static 192.168.1.1 24 10.1.11.1</span><br><span class="line">2.将public泄露到vpn中,public中会有一下一跳为VPN-instance的路由，迭代到出接口vbdif </span><br><span class="line">ip route-static 192.168.1.0 24 vpn-instance A 192.168.1.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">要求</span><br><span class="line">1.对于同一租户，同子网和跨子网互通</span><br><span class="line">2.vlan和VXLAN互通</span><br><span class="line">3.VXLAN中租户和公网互通</span><br><span class="line">4.CE1旁挂防火墙，实现路由隔离，nat在fw上，租户互通通过fw</span><br></pre></td></tr></table></figure>
<p>网络虚拟化，对于租户来说，只消耗 vni 和直连路由</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230112221742698.png" alt="image-20230112221742698"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230112224309888.png" alt="image-20230112224309888"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">CE1</span><br><span class="line">vlan batch 10 20 30</span><br><span class="line">#</span><br><span class="line">ip vpn-instance A</span><br><span class="line"> ipv4-family</span><br><span class="line">  route-distinguisher 1:1</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">bridge-domain 20</span><br><span class="line"> vxlan vni 20</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 1.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">interface Vbdif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.1.254 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface Vbdif20</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.2.254 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface Vlanif30</span><br><span class="line"> ip address 192.168.3.254 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.12.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.11.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/3</span><br><span class="line"> undo shutdown</span><br><span class="line"> port default vlan 30</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 1.1.1.1</span><br><span class="line"> vni 10 head-end peer-list 2.2.2.2</span><br><span class="line"> vni 10 head-end peer-list 3.3.3.3</span><br><span class="line"> vni 20 head-end peer-list 2.2.2.2</span><br><span class="line"> vni 20 head-end peer-list 3.3.3.3</span><br><span class="line">#</span><br><span class="line">ip route-static 192.168.1.0 255.255.255.0 vpn-instance A 192.168.1.1</span><br><span class="line">ip route-static 192.168.2.0 255.255.255.0 vpn-instance A 192.168.2.1</span><br><span class="line">ip route-static vpn-instance A 0.0.0.0 0.0.0.0 10.1.11.2 public</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CE2</span><br><span class="line">vlan batch 10 20</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">bridge-domain 20</span><br><span class="line"> vxlan vni 20</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 2.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.12.2 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.10 mode l2</span><br><span class="line"> encapsulation dot1q vid 10</span><br><span class="line"> bridge-domain 10</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.20 mode l2</span><br><span class="line"> encapsulation dot1q vid 20</span><br><span class="line"> bridge-domain 20</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 2.2.2.2</span><br><span class="line"> vni 10 head-end peer-list 1.1.1.1</span><br><span class="line"> vni 10 head-end peer-list 3.3.3.3</span><br><span class="line"> vni 20 head-end peer-list 1.1.1.1</span><br><span class="line"> vni 20 head-end peer-list 3.3.3.3</span><br><span class="line"> </span><br><span class="line">AR1</span><br><span class="line">acl number 2000  </span><br><span class="line"> rule 5 permit source 192.168.1.0 0.0.0.255 </span><br><span class="line"> rule 10 permit source 192.168.2.0 0.0.0.255 </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/0</span><br><span class="line"> ip address 10.1.11.2 255.255.255.0 </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/1</span><br><span class="line"> ip address 10.1.21.1 255.255.255.0 </span><br><span class="line"> nat outbound 2000</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 10.1.21.2</span><br><span class="line">ip route-static 192.168.1.0 255.255.255.0 10.1.11.1</span><br><span class="line">ip route-static 192.168.2.0 255.255.255.0 10.1.11.1</span><br></pre></td></tr></table></figure>
<p>两个 VTEP 可以确定一条 VXLAN 隧道，VTEP 间的这条 VXLAN 隧道将被两个 NVE 间的所有 VNI 所共用。</p>
<p>VXLAN 二层网关：允许租户接入 VxLAN 网络，实现相同 VxLAN 内部流量互访。</p>
<p>VxLAN L3 Gateway: 实现不同 VxLAN 直接互访，或者 VxLAN 与非 VxLAN 网络互访。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230114212602424.png" alt="image-20230114212602424"></p>
<p>L2-Subif: 用于用户接入，子接口上可以配置一层 tag 接入或者不配置 tag 接入；</p>
<p>BD (Bridge-Domain): 标识一个二层广播域，BD 和 VNI 1:1 映射。所有广播域功能基于 BD 支持，如 MAC 学习、二层查表、广播复制等；</p>
<p>NVE (Network Virtualization Edge): 主要用于本地 VTEP 地址管理，VXLAN 隧道管理，头端复制列表管理；</p>
<p>VXLAN 隧道: VXLAN 隧道用于 VXLAN 报文的转发，用本地 VTEP 地址 + 远端 VTEP 地址标识﹔</p>
<p>BDIF:BD 域的三层路由接口，用于二层流量进入三层进行路由转发；</p>
<p>bridge-domain 20</p>
<p>L2 binding vlan 10  // 全局关联 vlan 端口到 BD 域中</p>
<p>VLAN 绑定 BD 后，该 BD 不支持创建对应的 VBDIF 接口。同时不支持创建该 VLAN 对应的 VLANIF 接口。</p>
<p>VLAN 绑定 BD 功能和 ARP 广播报文抑制功能互斥，配置 VLAN 为 VXLAN 业务接入点后，不建议再使能 ARP 广播报文抑制功能</p>
<p>ARP 广播抑制：抑制后续的 ARP 广播报文，由于首包之后 CE 上已经有了 arp 请求的主机的位置，只需要单播请求即可。arp 广播请求变 arp 单播请求</p>
<p>第一次虚拟化：利用隧道技术将边缘设备互连透传二层报文；整网抽象理解成一台端口数目扩展的超大 LAN switch。</p>
<p>第二次虚拟化利用 VNI 将这台超大的交换机虚拟出多个二层的广播域，和 VLAN 本质是一样的，VNI 类比 VLANID. 并通过定义 VXLAN header 中的 VNI 字段，将子网范围由 4K 扩展至 16M。</p>
<p>vxlan 主要优点</p>
<p>基于 IP 的 overlay, 仅需要边界设备间 IP 可达。</p>
<p>隧道间水平分割、IP overlay TTL 避免环路。 网络层收到的 VXLAN 报文只能发给用户侧</p>
<p>数据流量基于 IP 路由 SPF 及 ECMP 快速转发。</p>
<p>网络变化实时侦听全网拓扑毫秒收敛</p>
<p>Overlay+VNI 构建虚拟网络，支持多达 16M 的虚拟网络。</p>
<p>物理设备、vSwitch 均能够部署。CE1800V 软件交换机也能做 VXLAN</p>
<p>VXLAN 同子网互访模型</p>
<p>1. 同一 OVS 之间</p>
<p>2. 不同 OVS 之间</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191207957.png" alt="image-20230122191207957"></p>
<p>3. 不同 tor 之间</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191226332.png" alt="image-20230122191226332"></p>
<p>VXLAN 不同子网护网</p>
<p>集中式网关</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191735252.png" alt="image-20230122191735252"></p>
<p>1. 流量迂回</p>
<p>2. 网关 arp 表项过多可能成为网络瓶颈</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192007255.png" alt="image-20230122192007255"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192117780.png" alt="image-20230122192117780"></p>
<p>VXLAN 基于 spine-leaf 组网架构</p>
<p>胖树</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192248454.png" alt="image-20230122192248454"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122193919103.png" alt="image-20230122193919103"></p>
<p>spine 和网关分离部署，解决集中式网关容量问题</p>
<p>spine 和网关融合部署</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122194413496.png" alt="image-20230122194413496"></p>
<p>集中式网关场景下网关双活</p>
<p>华为最多支持四台做多活，但只提高转发效率，不提高表项</p>
<p>表项通过 DFS 同步</p>
<p>需要通过双活组做网关扩容</p>
<p>多活网关需要 VTEP 一样</p>
<p>CE 模拟器基于包做负载分担</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122195628679.png" alt="image-20230122195628679"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122195938635.png" alt="image-20230122195938635"></p>
<p>集中式网关特点</p>
<p>1. 流量存在迂回现象</p>
<p>2. 网关需要维护主机的 mac 地址信息和 arp 信息，对设备表项容量要求高，容易遇到瓶颈</p>
<p>3. 网关容易存在单点故障</p>
<p>4. 跨子网的流量都由网关来完成，流量有明显控制点，网关维护用户路由信息，MAC 地址，ARP 表项，VXLAN 隧道路由</p>
<p>leaf 只需要维护 MAC 地址信息和 VXLAN 隧道的路由信息，无需维护用户的路由信息</p>
<p>第一个和第二三个问题可以采用分布式网关解决</p>
<p>第三个问题可以使用双活网关解决</p>
<p>如果非要用集中式网关</p>
<p>1. 第一个问题无法解决</p>
<p>2. 第二个问题采用多组网关解决容量问题</p>
<p>3. 第三个问题采用多活网关</p>
<p>集中式网关有网关和 spine 融合组网  适用业务稳定，规模稳定的私有云</p>
<p>网关和 spine 分离组网    适用于业务变更频繁业务规模可以弹性伸缩的时候，中大型公有云和私有云</p>
<h2 id="集中式双活网关过墙"><a class="markdownIt-Anchor" href="#集中式双活网关过墙">#</a> 集中式双活网关过墙</h2>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123214500930.png" alt="image-20230123214500930"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">网关上创建互联vlan</span><br><span class="line">一个vlan绑定到用户的VPN-instance中，用于和用户的vfw实现三层互连</span><br><span class="line">一个vlan绑定到public中，和root防火墙实现三层互联，此链路所有租户共享</span><br><span class="line"></span><br><span class="line">fw上创建互联vlan</span><br><span class="line">一个vlan关联到租户的虚墙，实现和租户在gw上的VPN-instance对接</span><br><span class="line">一个vlan关联root防火墙和gw的public对接</span><br><span class="line"></span><br><span class="line">gw</span><br><span class="line">vlan 10</span><br><span class="line">des vpn A</span><br><span class="line"></span><br><span class="line">vlan 20</span><br><span class="line">des public </span><br><span class="line"></span><br><span class="line">int g1/0/1</span><br><span class="line">p l t </span><br><span class="line">p t a v a </span><br><span class="line"></span><br><span class="line">int vlanif 10</span><br><span class="line">ip add 192.168.10.1 24 </span><br><span class="line">ip bing vpn A</span><br><span class="line"></span><br><span class="line">int vlan 20 </span><br><span class="line">ip add 192.168.20.1 24 </span><br><span class="line"></span><br><span class="line">ip route vpn A 0.0.0.0 0 192.168.10.10</span><br><span class="line"></span><br><span class="line">ip rou 0.0.0.0 0 192.168.30.1</span><br><span class="line"></span><br><span class="line">ip rou 202.1.1.0 24 192.168.20.20</span><br><span class="line"></span><br><span class="line">fw</span><br><span class="line">vlan 10 20</span><br><span class="line">int g1/0/0</span><br><span class="line">portswitch</span><br><span class="line">p l t</span><br><span class="line">p t a v a </span><br><span class="line"></span><br><span class="line">vsys enable</span><br><span class="line">vsys name A</span><br><span class="line">assign vlan 10</span><br><span class="line">int vlanif 10 </span><br><span class="line">ip add 192.168.10.10 24 </span><br><span class="line">service pin p</span><br><span class="line">switch vsys A</span><br><span class="line">firewall zone trust</span><br><span class="line">add interface vlanif 10</span><br><span class="line">//华为NGFW默认出厂存在一个virtual-if0，它属于root的一个逻辑接口，用于和虚拟fw的virtual-if接口实现通信</span><br><span class="line">在创建vfw时，也会为vfw自动创建一个virtual-if接口，接口号设备自行分配</span><br><span class="line">Firewall zone untrust </span><br><span class="line">add inter vitural-if 1</span><br><span class="line"></span><br><span class="line">firewall zone trust  </span><br><span class="line">add inter vit 0</span><br><span class="line"></span><br><span class="line">int vlan 20</span><br><span class="line">ip add 192.168.20.20  24 </span><br><span class="line">service pin p</span><br><span class="line">firewall zon un </span><br><span class="line">add int vlan 20</span><br><span class="line"></span><br><span class="line">switch vsys A </span><br><span class="line">ip route-static 192.168.1.0 24 192.168.10.1</span><br><span class="line">security-po </span><br><span class="line">ru name test </span><br><span class="line">trust-&gt;untrust</span><br><span class="line">sourece 192.168.1.0 </span><br><span class="line">ac pe</span><br><span class="line">ip route 0.0.0.0 0 public</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">security-policy </span><br><span class="line">def ac per</span><br><span class="line">ip route 0.0.0.0 0 192.168.20.1</span><br><span class="line"></span><br><span class="line">nat add A</span><br><span class="line">section 202.1.1.1 202.1.1.10</span><br><span class="line"></span><br><span class="line">vsys name A</span><br><span class="line">assign global 202.1.1.1 202.1.1.10 free</span><br><span class="line"></span><br><span class="line">switch vsys A </span><br><span class="line">nat add A</span><br><span class="line">sec 202.1.1.1 202.1.1.3</span><br><span class="line">nat-policy </span><br><span class="line">ru name A</span><br><span class="line">source-zon  t</span><br><span class="line">de un</span><br><span class="line">source 192.168.1.0 24 </span><br><span class="line">ac so add A </span><br><span class="line"></span><br><span class="line">ip rou 202.1.1.0 28 vpn A</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R1</span><br><span class="line">ip rou 202.1.1.0 24 192.168.30.1</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123211745121.png" alt="image-20230123211745121"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">//1.网关双活</span><br><span class="line">[CE1]dis cu </span><br><span class="line">ip vpn-instance A</span><br><span class="line"> ipv4-family</span><br><span class="line">  route-distinguisher 100:1</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">interface Vbdif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.1.254 255.255.255.0</span><br><span class="line"> mac-address 5489-9825-6da0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 1.1.1.1</span><br><span class="line"> vni 10 head-end peer-list 3.3.3.3</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 1.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[CE3]dis cu </span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 1</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.3 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.23.3 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2.10 mode l2</span><br><span class="line"> encapsulation untag</span><br><span class="line"> bridge-domain 10</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 3.3.3.3 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 3.3.3.3</span><br><span class="line"> vni 10 head-end peer-list 1.1.1.1</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 3.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">//网关双活过墙</span><br><span class="line">[CE1]di cu </span><br><span class="line">vlan batch 10 20 30</span><br><span class="line">#</span><br><span class="line">ip vpn-instance A</span><br><span class="line"> ipv4-family</span><br><span class="line">  route-distinguisher 100:1</span><br><span class="line">#</span><br><span class="line">vlan 10</span><br><span class="line"> description VPN-instance  A</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">interface Vbdif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.1.254 255.255.255.0</span><br><span class="line"> mac-address 5489-9825-6da0</span><br><span class="line">#</span><br><span class="line">interface Vlanif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.10.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface Vlanif20</span><br><span class="line"> description public</span><br><span class="line"> ip address 192.168.20.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo shutdown</span><br><span class="line"> port link-type trunk</span><br><span class="line"> port trunk allow-pass vlan 2 to 4094</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 192.168.30.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 1.1.1.1</span><br><span class="line"> vni 10 head-end peer-list 3.3.3.3</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 1.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 192.168.30.30</span><br><span class="line">ip route-static 202.1.1.0 255.255.255.0 192.168.20.20</span><br><span class="line">ip route-static vpn-instance A 0.0.0.0 0.0.0.0 192.168.10.10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[USG6000V1]dis cu </span><br><span class="line">vlan batch 10 20 30</span><br><span class="line">#</span><br><span class="line">vsys enable</span><br><span class="line">#</span><br><span class="line">vsys name A 1</span><br><span class="line"> assign vlan 10</span><br><span class="line"> assign global-ip 201.1.1.1 202.1.1.10 free</span><br><span class="line">#</span><br><span class="line">interface Vlanif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.10.10 255.255.255.0</span><br><span class="line"> service-manage ping permit</span><br><span class="line">#</span><br><span class="line">interface Vlanif20</span><br><span class="line"> ip address 192.168.20.20 255.255.255.0</span><br><span class="line"> service-manage ping permit</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1/0/0</span><br><span class="line"> portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> port link-type trunk</span><br><span class="line"> port trunk allow-pass vlan 2 to 4094</span><br><span class="line">#</span><br><span class="line">firewall zone trust</span><br><span class="line"> set priority 85</span><br><span class="line"> add interface GigabitEthernet0/0/0</span><br><span class="line"> add interface Virtual-if0</span><br><span class="line">#</span><br><span class="line">firewall zone untrust</span><br><span class="line"> set priority 5</span><br><span class="line"> add interface Vlanif20</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 192.168.20.1</span><br><span class="line">ip route-static 202.1.1.0 255.255.255.240 vpn-instance A</span><br><span class="line">#</span><br><span class="line">security-policy</span><br><span class="line"> default action permit</span><br><span class="line"> rule name test</span><br><span class="line">#</span><br><span class="line">switch vsys A</span><br><span class="line">#</span><br><span class="line">interface Vlanif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.10.10 255.255.255.0</span><br><span class="line"> service-manage ping permit</span><br><span class="line">#</span><br><span class="line">firewall zone trust</span><br><span class="line"> set priority 85</span><br><span class="line"> add interface Vlanif10</span><br><span class="line">#</span><br><span class="line">firewall zone untrust</span><br><span class="line"> set priority 5</span><br><span class="line"> add interface Virtual-if1</span><br><span class="line">#</span><br><span class="line">nat address-group A 0</span><br><span class="line"> mode pat</span><br><span class="line"> section 0 202.1.1.1 202.1.1.3</span><br><span class="line">#</span><br><span class="line">security-policy</span><br><span class="line"> rule name test</span><br><span class="line">  source-zone trust</span><br><span class="line">  destination-zone untrust</span><br><span class="line">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class="line">  action permit</span><br><span class="line">#</span><br><span class="line">nat-policy</span><br><span class="line"> rule name A</span><br><span class="line">  source-zone trust</span><br><span class="line">  destination-zone untrust</span><br><span class="line">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class="line">  action source-nat address-group A</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 public</span><br><span class="line">ip route-static 192.168.1.0 255.255.255.0 192.168.10.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[R1]dis cu</span><br><span class="line">[V200R003C00]</span><br><span class="line">interface GigabitEthernet0/0/0</span><br><span class="line"> ip address 192.168.30.30 255.255.255.0 </span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 8.8.8.8 255.255.255.255 </span><br><span class="line">#</span><br><span class="line">ip route-static 202.1.1.0 255.255.255.0 192.168.30.1</span><br></pre></td></tr></table></figure>
<h2 id="evpn"><a class="markdownIt-Anchor" href="#evpn">#</a> EVPN</h2>
<p>EVPN 作为数据中心 VXLAN 技术的控制平面，转发平面还是采用 VXLAN 对数据进行封装</p>
<p>EVPN 支持集中式网关组网，也支持分布式网关组网</p>
<p>EVPN 在数据中心实现同子网互访和跨子网互访</p>
<p>为了在数据中心支持 VXLAN。EVPN 在 BGP 协议的基础上新增了一种 NLRI，称为 EVPN NLRI</p>
<p>EVPN NLRI 定义了三种路由信息</p>
<p>1.type 2 路由称为 MAC/IP 路由，根据不同的作用，也称为 ARP 路由 / IRB 路由（IRB  集成的路由与桥接），用于</p>
<p>@数据中心支持 ARP 广播抑制</p>
<p>@动态虚拟机迁移</p>
<p>@虚拟机主机路由的发布，实现跨子网互访</p>
<p>2.type 3 路由，称为集成组播路由，用于在 VTEP 之间动态建立 VXLAN 隧道，并动态实现头端复制列表的生成，用于支持 BUM 报文的转发</p>
<p>3.type 5 路由，称为前缀路由，常用于将数据中心外部路由引入到各租户的 VPN-instance 中，实现数据中心内部访问外部</p>
<p>另外标准的 EVPN 协议还定义了 type 1 的路由</p>
<p>type 1 路由 Ethernet AD Route    (auto discovery)</p>
<p>双归场景下用于防环快速收敛，别名</p>
<p>type 4 路由，Ethernet Segment Route</p>
<p>双归场景下用于实现 DF 的选举和执行负载分担的维护</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">//CE1-CE4之间建立EVPN邻居</span><br><span class="line">CE1</span><br><span class="line">evpn-overlay enable </span><br><span class="line">bgp 100</span><br><span class="line">peer 2.2.2.2 as 100</span><br><span class="line">peer 2.2.2.2 con l 0 </span><br><span class="line">peer 3.3.3.3</span><br><span class="line">peer 4.4.4.4</span><br><span class="line">l2vpn-fa evpn </span><br><span class="line">peer 2.2.2.2 enable</span><br><span class="line">peer 2.2.2.2 re</span><br><span class="line">peer 3.3.3.3 </span><br><span class="line">peer 4.4.4.4</span><br><span class="line">//peer 2.2.2.2 ad arp</span><br><span class="line">//peer 3.3.3.3 ad arp</span><br><span class="line">//peer 4.4.4.4 ad arp</span><br><span class="line">undo p v</span><br><span class="line"></span><br><span class="line">CE2</span><br><span class="line">evpn-overlay enable </span><br><span class="line">bgp 100</span><br><span class="line">peer 1.1.1.1 as 100</span><br><span class="line">peer 1.1.1.1 con l 0 </span><br><span class="line">l2vpn-fa evpn </span><br><span class="line">peer 1.1.1.1 en</span><br><span class="line">//peer 1.1.1.1 ad arp</span><br><span class="line"></span><br><span class="line">dis bgp evpn peer </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CE2-CE3-CE4</span><br><span class="line">BD 10</span><br><span class="line">vx  10</span><br><span class="line">evpn</span><br><span class="line">router- 100:1</span><br><span class="line">vpn-t 100:1 b</span><br><span class="line"></span><br><span class="line">int g1/0/1.10 </span><br><span class="line">bd 10</span><br><span class="line">enca 10</span><br><span class="line">//EVPN实例中本地的每个BD域都可以看成是一个独立的EVPN实例，一个二层的广播域</span><br><span class="line"></span><br><span class="line">int Nve1</span><br><span class="line">source 2.2.2.2</span><br><span class="line">vni 10 head peer pro bgp    //type3</span><br><span class="line">dis bgp evpn rout in 0:32:2.2.2.2</span><br><span class="line"></span><br><span class="line">CE4</span><br><span class="line">int vbdif 10</span><br><span class="line">ip add 192.168.1.254 24 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">没有反射器的场景需要在所有节点建立全互联EVPN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CE2-CE3</span><br><span class="line">ip vpn- A</span><br><span class="line">router 100:1</span><br><span class="line">vpn 100:1 both evpn</span><br><span class="line">vxlan vni 100   //三层VNI</span><br><span class="line"></span><br><span class="line">int vbdif 10</span><br><span class="line">ip bin vpn A</span><br><span class="line">arp dist enable</span><br><span class="line">arp collect host enable</span><br><span class="line">ip addr</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>Type3 路由 ——Inclusive Multicast 路由</strong><br>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125212349933.png" alt="image-20230125212349933"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125212635735.png" alt="image-20230125212635735"></p>
<p>还会携带 ERT，不在 EVPN 中，在 BGP 中，用于设置感兴趣路由</p>
<p>1. 对方收到 type3 路由后，比较 RT 是否匹配，如果匹配则接收该 type3 的路由</p>
<p>2. 提取 type3 中 org router ip (VTEP 地址) ，如果该地址路由可达，则创建 VXLAN 隧道</p>
<p>3. 提取 PMSI 属性中二层 VNI 值，看是否和本端 EVPN 实例中的相同，如果相同则将 PSMI 中携带的 VTEP 地址添加到 VXLAN 隧道的头端复制列表中</p>
<p>如果希望在 EVPN 邻居之间传递 type2 的路由 (ARP 路由 / IRB 路由)</p>
<p>peer 1.1.1.1 advertise arp   传递 ARP 路由 / MAC 路由</p>
<p>peer 1.1.1.1 advertise irb    传递 IRB 类型的路由</p>
<p>默认只传 type3</p>
<p>MAC route 实现 VM 之间二层互访，需要在 EVPN 邻居之间传递 MAC  route</p>
<p>MAC route 特征</p>
<p>携带 RD+MAC + 二层 VNI</p>
<p>为了支持 ARP 广播抑制和虚拟机热迁移，需要在 EVPN 邻居之间传递 ARP 类型的路由</p>
<p>传递 IRB peer 1.1.1.1 ad irb</p>
<p><strong>Type2 路由 ——MAC/IP 路由</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126212428010.png" alt="image-20230126212428010"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126212535678.png" alt="image-20230126212535678"></p>
<p>arp 路由的特征：携带 RD+MAC+IP + 二层 VNI</p>
<p>irb 类型的特征：携带 RD+MAC+IP + 二层 VNI + 三层 VNI，irb 类型的路由也具备 arp 类型路由的功能</p>
<p>什么时候发送 ARP 类型的路由，集中式网关部署时发送 ARP 类型的路由即可</p>
<p>什么时候发送 IRB 类型的路由，分布式网关一定要发送 IRB 类型的路由</p>
<p>当邻居之间发布 arp 路由命令后，设备会将用户侧学到主机的 IP+MAC 信息通过 arp 类型的路由发送给 evpn 邻居</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">type 2路由在VXLAN控制平面中的作用包括：</span><br><span class="line"></span><br><span class="line">主机MAC地址通告</span><br><span class="line"></span><br><span class="line">要实现同子网主机的二层互访，两端VTEP需要相互学习主机MAC。作为BGP EVPN对等体的VTEP之间通过交换MAC/IP路由，可以相互通告已经获取到的主机MAC。其中，MAC Address Length和MAC Address字段为主机MAC地址。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">主机ARP通告</span><br><span class="line"></span><br><span class="line">MAC/IP路由可以同时携带主机MAC地址+主机IP地址，因此该路由可以用来在VTEP之间传递主机ARP表项，实现主机ARP通告。其中，MAC Address和MAC Address Length字段为主机MAC地址，IP Address和IP Address Length字段为主机IP地址。此时的MAC/IP路由也称为ARP类型路由。主机ARP通告主要用于以下两种场景：</span><br><span class="line"></span><br><span class="line">1.ARP广播抑制。当三层网关学习到其子网下的主机ARP时，生成主机信息（包含主机IP地址、主机MAC地址、二层VNI、网关VTEP IP地址），然后通过传递ARP类型路由将主机信息同步到二层网关上。这样当二层网关再收到ARP请求时，先查找是否存在目的IP地址对应的主机信息，如果存在，则直接将ARP请求报文中的广播MAC地址替换为目的单播MAC地址，实现广播变单播，达到ARP广播抑制的目的。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.分布式网关场景下的虚拟机迁移。当一台虚拟机从当前网关迁移到另一个网关下之后，新网关学习到该虚拟机的ARP（一般通过虚拟机发送免费ARP实现），并生成主机信息（包含主机IP地址、主机MAC地址、二层VNI、网关VTEP IP地址），然后通过传递ARP类型路由将主机信息发送给虚拟机的原网关。原网关收到后，感知到虚拟机的位置发生变化，触发ARP探测，当探测不到原位置的虚拟机时，撤销原位置虚拟机的ARP和主机路由。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230128140404626.png" alt="image-20230128140404626"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">[CE1]dis cu </span><br><span class="line">evpn-overlay enable</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 10.0.0.0</span><br><span class="line"> network 1.0.0.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.12.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.14.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255</span><br><span class="line">#</span><br><span class="line">bgp 100</span><br><span class="line"> peer 2.2.2.2 as-number 100</span><br><span class="line"> peer 2.2.2.2 connect-interface LoopBack0</span><br><span class="line"> peer 3.3.3.3 as-number 100</span><br><span class="line"> peer 3.3.3.3 connect-interface LoopBack0</span><br><span class="line"> peer 4.4.4.4 as-number 100</span><br><span class="line"> peer 4.4.4.4 connect-interface LoopBack0</span><br><span class="line"> #</span><br><span class="line"> ipv4-family unicast</span><br><span class="line">  peer 2.2.2.2 enable</span><br><span class="line">  peer 3.3.3.3 enable</span><br><span class="line">  peer 4.4.4.4 enable</span><br><span class="line"> #</span><br><span class="line"> l2vpn-family evpn</span><br><span class="line">  undo policy vpn-target</span><br><span class="line">  peer 2.2.2.2 enable</span><br><span class="line">  peer 2.2.2.2 advertise irb</span><br><span class="line">  peer 2.2.2.2 reflect-client</span><br><span class="line">  peer 3.3.3.3 enable</span><br><span class="line">  peer 3.3.3.3 advertise irb</span><br><span class="line">  peer 3.3.3.3 reflect-client</span><br><span class="line">  peer 4.4.4.4 enable</span><br><span class="line">  peer 4.4.4.4 advertise irb</span><br><span class="line">  peer 4.4.4.4 reflect-client</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">[CE2]dis  cu </span><br><span class="line">evpn-overlay enable</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line"> evpn</span><br><span class="line">  route-distinguisher 100:1</span><br><span class="line">  vpn-target 100:1 export-extcommunity</span><br><span class="line">  vpn-target 100:1 import-extcommunity</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 10.0.0.0</span><br><span class="line"> network 2.0.0.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0.10 mode l2</span><br><span class="line"> encapsulation dot1q vid 10</span><br><span class="line"> bridge-domain 10</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.12.2 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 2.2.2.2</span><br><span class="line"> vni 10 head-end peer-list protocol bgp</span><br><span class="line">#</span><br><span class="line">bgp 100</span><br><span class="line"> peer 1.1.1.1 as-number 100</span><br><span class="line"> peer 1.1.1.1 connect-interface LoopBack0</span><br><span class="line"> #</span><br><span class="line"> ipv4-family unicast</span><br><span class="line">  peer 1.1.1.1 enable</span><br><span class="line"> #</span><br><span class="line"> l2vpn-family evpn</span><br><span class="line">  policy vpn-target</span><br><span class="line">  peer 1.1.1.1 enable</span><br><span class="line">  peer 1.1.1.1 advertise irb</span><br></pre></td></tr></table></figure>
<p>配置分布式网关并且通告 irb 类型路由后‘</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230128150821743.png" alt="image-20230128150821743"></p>
<h2 id="分布式网关"><a class="markdownIt-Anchor" href="#分布式网关">#</a> 分布式网关</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">CE2-CE3</span><br><span class="line">evpn en	</span><br><span class="line">bgp 100</span><br><span class="line">peer 3.3.3.3 as 100</span><br><span class="line">peer 3.3.3.3 con l 0</span><br><span class="line">l2vpn evpn</span><br><span class="line">peer 3.3.3.3 enable</span><br><span class="line">peer 3.3.3.3 ad irb</span><br><span class="line"></span><br><span class="line">bd 10</span><br><span class="line">vxxlan 10</span><br><span class="line">evpn </span><br><span class="line">route</span><br><span class="line">vpn-target 100:1</span><br><span class="line"></span><br><span class="line">bbd 20</span><br><span class="line">vpn 100:2</span><br><span class="line"></span><br><span class="line">ip vpn-instance A</span><br><span class="line">route 100:1</span><br><span class="line">vpn- 100:1 both </span><br><span class="line">vpn- 100:1 evpn</span><br><span class="line">vpn 100:2 evpn imp</span><br><span class="line">vxlan vni 99</span><br><span class="line"></span><br><span class="line">int vbdif 10 </span><br><span class="line">ip bind vpn A</span><br><span class="line">ip add </span><br><span class="line">arp dis en</span><br><span class="line">arp coll host en</span><br><span class="line"></span><br><span class="line">int nv 1 </span><br><span class="line">source 2.2.2.2</span><br><span class="line">vni 10 h p p bgp</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>二层 VNI 用于同子网互访</p>
<p>三层 VNI 用于实现跨子网互访</p>
<ul>
<li>
<p>ARP 类型路由携带的有效信息有：主机 MAC 地址 + 主机 IP 地址 + 二层 VNI；IRB 类型路由携带的有效信息有：主机 MAC 地址 + 主机 IP 地址 + 二层 VNI + 三层 VNI。因此，IRB 类型路由包含着 ARP 类型路由，不仅可以用于主机 IP 路由通告，也能用于主机 ARP 通告。</p>
</li>
<li>
<p>主机 IP 路由通告</p>
<p>在分布式网关场景中，要实现跨子网主机的三层互访，两端 VTEP（作为三层网关）需要互相学习主机 IP 路由。作为 BGP EVPN 对等体的 VTEP 之间通过交换 MAC/IP 路由，可以相互通告已经获取到的主机 IP 路由。其中，IP Address Length 和 IP Address 字段为主机 IP 路由的目的地址，同时 MPLS Label2 字段必须携带三层 VNI。此时的 MAC/IP 路由也称为 IRB（Integrated Routing and Bridge）类型路由。</p>
</li>
</ul>
<p><span class="exturl" data-url="aHR0cDovLzEuQkQ=">1.BD</span> rt 匹配，如果匹配实现广播抑制虚拟机热迁移</p>
<p>2. 当 Eert 和本端 VPN-instance 中 Eirt 匹配时，会将其中携带的 IP 地址加入到 VPN-instance 路由表中，生成一条主机路由</p>
<p>export-rt evpn Eert</p>
<p>import-rt evpn Eirt</p>
<p>Leaf2 收到 Leaf1 发来的 BGP EVPN 路由后，同时进行如下处理：</p>
<ul>
<li>检查该路由携带的 ERT，如果与本端 EVPN 实例的 IRT 相同，则接收该路由。EVPN 实例获取到 IRB 类型路由后，还能提取到其中包含的 ARP 类型路由，用于主机 ARP 通告。</li>
<li>检查该路由携带的 ERT，如果与本端 L3VPN 实例的 eIRT 相同，则接收该路由。然后，L3VPN 实例获取到该路由携带的 IRB 类型路由，从中提取 Host1 的主机 IP 地址、三层 VNI，在其路由表中保存 Host1 的主机 IP 路由，并根据路由的下一跳迭代出接口，最终迭代结果是指向 Leaf1 的 VXLAN 隧道，如<span class="exturl" data-url="bWs6TVNJVFN0b3JlOkQ6JTVDQV8lRTUlQUQlQTYlRTQlQjklQTAlNUMlRTQlQkElQTclRTUlOTMlODElRTYlOTYlODclRTYlQTElQTMlNUNDRTEyODAwLmNobTo6L2RjL2RjX3ZycF9mZWF0dXJlX3Z4bGFuXzEwMzkuaHRtbCNaSC1DTl9DT05DRVBUXzAxNDExMTg4NTBfX2ZpZ19kY192cnBfZmVhdHVyZV92eGxhbl8xMDM5MDc=">图 6</span> 所示。</li>
</ul>
<p>分布式网关只需要维护 rt 匹配的路由</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230130224834603.png" alt="image-20230130224834603"></p>
<p>dis ip rou vpn A</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131144845172.png" alt="image-20230131144845172"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">[CE3]di cu </span><br><span class="line">vlan batch 10 20</span><br><span class="line">#</span><br><span class="line">evpn-overlay enable</span><br><span class="line">#</span><br><span class="line">ip vpn-instance A</span><br><span class="line"> ipv4-family</span><br><span class="line">  route-distinguisher 100:4</span><br><span class="line">  vpn-target 100:5 export-extcommunity</span><br><span class="line">  vpn-target 100:22 export-extcommunity evpn</span><br><span class="line">  vpn-target 100:5 import-extcommunity</span><br><span class="line">  vpn-target 100:22 import-extcommunity evpn</span><br><span class="line"> vxlan vni 99</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line"> evpn</span><br><span class="line">  route-distinguisher 100:1</span><br><span class="line">  vpn-target 100:11 export-extcommunity</span><br><span class="line">  vpn-target 100:22 export-extcommunity</span><br><span class="line">  vpn-target 100:11 import-extcommunity</span><br><span class="line">  vpn-target 100:22 import-extcommunity</span><br><span class="line">#</span><br><span class="line">bridge-domain 20</span><br><span class="line"> vxlan vni 20</span><br><span class="line"> evpn</span><br><span class="line">  route-distinguisher 100:2</span><br><span class="line">  vpn-target 100:3 export-extcommunity</span><br><span class="line">  vpn-target 100:22 export-extcommunity</span><br><span class="line">  vpn-target 100:100 export-extcommunity</span><br><span class="line">  vpn-target 100:3 import-extcommunity</span><br><span class="line">  vpn-target 100:22 import-extcommunity</span><br><span class="line">  vpn-target 100:100 import-extcommunity</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 3.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">interface Vbdif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.1.254 255.255.255.0</span><br><span class="line"> arp distribute-gateway enable</span><br><span class="line"> arp collect host enable</span><br><span class="line">#</span><br><span class="line">interface Vbdif20</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.2.254 255.255.255.0</span><br><span class="line"> arp distribute-gateway enable</span><br><span class="line"> arp collect host enable</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.10 mode l2</span><br><span class="line"> encapsulation dot1q vid 10</span><br><span class="line"> bridge-domain 10</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.20 mode l2</span><br><span class="line"> encapsulation dot1q vid 20</span><br><span class="line"> bridge-domain 20</span><br><span class="line">#</span><br><span class="line">interface GE1/0/6</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.3 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 3.3.3.3 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 3.3.3.3</span><br><span class="line"> vni 10 head-end peer-list protocol bgp</span><br><span class="line"> vni 20 head-end peer-list protocol bgp</span><br><span class="line">#</span><br><span class="line">bgp 100</span><br><span class="line"> peer 2.2.2.2 as-number 100</span><br><span class="line"> peer 2.2.2.2 connect-interface LoopBack0</span><br><span class="line"> #</span><br><span class="line"> ipv4-family unicast</span><br><span class="line">  peer 2.2.2.2 enable</span><br><span class="line"> #</span><br><span class="line"> l2vpn-family evpn</span><br><span class="line">  policy vpn-target</span><br><span class="line">  peer 2.2.2.2 enable</span><br><span class="line">  peer 2.2.2.2 advertise irb</span><br><span class="line">  </span><br><span class="line">[CE1]dis cu </span><br><span class="line">evpn-overlay enable</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 10.0.0.0</span><br><span class="line"> network 1.0.0.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/3</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/4</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.12.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[CE2]dis cu </span><br><span class="line">vlan batch 10 20</span><br><span class="line">#</span><br><span class="line">evpn-overlay enable</span><br><span class="line">#</span><br><span class="line">ip vpn-instance A</span><br><span class="line"> ipv4-family</span><br><span class="line">  route-distinguisher 100:1</span><br><span class="line">  vpn-target 100:3 export-extcommunity</span><br><span class="line">  vpn-target 100:22 export-extcommunity evpn</span><br><span class="line">  vpn-target 100:3 import-extcommunity</span><br><span class="line">  vpn-target 100:22 import-extcommunity evpn</span><br><span class="line"> vxlan vni 99</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line"> evpn</span><br><span class="line">  route-distinguisher 100:1</span><br><span class="line">  vpn-target 100:100 export-extcommunity</span><br><span class="line">  vpn-target 100:22 export-extcommunity</span><br><span class="line">  vpn-target 100:100 import-extcommunity</span><br><span class="line">#</span><br><span class="line">bridge-domain 20</span><br><span class="line"> vxlan vni 20</span><br><span class="line"> evpn</span><br><span class="line">  route-distinguisher 100:2</span><br><span class="line">  vpn-target 100:100 export-extcommunity</span><br><span class="line">  vpn-target 100:22 export-extcommunity</span><br><span class="line">  vpn-target 100:100 import-extcommunity</span><br><span class="line">  vpn-target 100:22 import-extcommunity</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 10.0.0.0</span><br><span class="line"> network 2.0.0.0</span><br><span class="line">#</span><br><span class="line">interface Vbdif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.1.254 255.255.255.0</span><br><span class="line"> arp distribute-gateway enable</span><br><span class="line"> arp collect host enable</span><br><span class="line">#</span><br><span class="line">interface Vbdif20</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.2.254 255.255.255.0</span><br><span class="line"> arp distribute-gateway enable</span><br><span class="line"> arp collect host enable</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.10 mode l2</span><br><span class="line"> encapsulation dot1q vid 10</span><br><span class="line"> bridge-domain 10</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.20 mode l2</span><br><span class="line"> encapsulation dot1q vid 20</span><br><span class="line"> bridge-domain 20</span><br><span class="line">#</span><br><span class="line">interface GE1/0/5</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.12.2 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 2.2.2.2</span><br><span class="line"> vni 10 head-end peer-list protocol bgp</span><br><span class="line"> vni 20 head-end peer-list protocol bgp</span><br><span class="line">#</span><br><span class="line">bgp 100</span><br><span class="line"> peer 3.3.3.3 as-number 100</span><br><span class="line"> peer 3.3.3.3 connect-interface LoopBack0</span><br><span class="line"> #</span><br><span class="line"> ipv4-family unicast</span><br><span class="line">  peer 3.3.3.3 enable</span><br><span class="line"> #</span><br><span class="line"> l2vpn-family evpn</span><br><span class="line">  policy vpn-target</span><br><span class="line">  peer 3.3.3.3 enable</span><br><span class="line">  peer 3.3.3.3 advertise irb</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131144906251.png" alt="image-20230131144906251"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131145050065.png" alt="image-20230131145050065"></p>
<h2 id="分布式网关访问外网"><a class="markdownIt-Anchor" href="#分布式网关访问外网">#</a> 分布式网关访问外网</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">CE2-CE3</span><br><span class="line">bgp 100</span><br><span class="line">peer 1.1.1.1 as 100</span><br><span class="line">peer 1.1.1.1 con l 0</span><br><span class="line">l2vpn</span><br><span class="line">peer 1.1.1.1 en</span><br><span class="line">peer 1.1.1.1 ad irb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CE1</span><br><span class="line">peer 2.2.2.2 as 100</span><br><span class="line">peer 2.2.2.2 con l 0 </span><br><span class="line">l2vpn </span><br><span class="line">peer 2.2.2.2 en</span><br><span class="line">peer 2.2.2.2 ad irb</span><br><span class="line"></span><br><span class="line">//1.建立EVPN邻居</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip vpn A </span><br><span class="line">route 100:1</span><br><span class="line">vxlan vni 99</span><br><span class="line">vpn- 100:100 b evpn </span><br><span class="line">vpn 100:100 e e</span><br><span class="line"></span><br><span class="line">int g1/0/3 </span><br><span class="line">p l t </span><br><span class="line">p t a v a </span><br><span class="line"></span><br><span class="line">int vlan 10</span><br><span class="line">ip bin vpn A</span><br><span class="line">ip add 192.168.10.1 24 </span><br><span class="line"></span><br><span class="line">ip rou vpn A  0.0.0.0 0 192.168.10.10 </span><br><span class="line">ip rou vpn A  8.8.8.0 24 192.168.10.10</span><br><span class="line"></span><br><span class="line">bgp 100</span><br><span class="line">ipv4 vpn A</span><br><span class="line">import  static</span><br><span class="line">ad l2vpn evpn   //vpnv4转换为EVPN type 5路由</span><br><span class="line"></span><br><span class="line">b 10</span><br><span class="line">vxlan vni 10</span><br><span class="line">evpn</span><br><span class="line">rd 100:1</span><br><span class="line">rt 100:1 b</span><br><span class="line">b20</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">int nv 1</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FW </span><br><span class="line">int g1/0/0.1</span><br><span class="line">vlan-type dot 10</span><br><span class="line">ip add 192.168.10.10 24 </span><br><span class="line"></span><br><span class="line">fir zon trust</span><br><span class="line">add g1/0/0.1</span><br><span class="line">ser p p</span><br><span class="line"></span><br><span class="line">ip rou 0.0.0.0 0 192.168.10.1 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>Type5 路由 ——IP 前缀路由</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131220410404.png" alt="image-20230131220410404"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131220430645.png" alt="image-20230131220430645"></p>
<p>发送时</p>
<p>tpye 2，3 路由携带 evpn 实例下自身的 ERT</p>
<p>type 5 路由携带 vpn 实例下 eert</p>
<p>接收时</p>
<p>匹配 vpn 实例下 eirt</p>
<p>1.14</p>
<p>EVN</p>
<p>用于 vlan 的场景下实现跨数据中心互访，完成不同数据中心相同 vlan 互访，只用于二层互访</p>
<p>@集成多播路由 (Inclusive Multicast Route) : 当 PE 之间的 BGP 邻居关系建立成功后，PE 之间会传递集成多播路由。用于生成 BUM 转发表，同时自动建立传送数<br>
据报文的 VXLAN 隧道。</p>
<p>MAC 地址通告路由 (MAC Advertisement Route) : BGP 邻居关系建立后，当 PE 上的 MAC 表信息发生变化时，PE 即向对等体 PE 发送 MAC 地址通告路由，用于更新对端 PE 上的 MAC 表，指导单播报文的转发。</p>
<p>@以太自动发现路由（Ethernet Auto-Discovery Routa) : PE 之间的 BGP 邻居关系建立成功后，.PE 之间会传递以太自动发现路由。以太目动发现路由可以向其他 PE 通告本端 PE 对接入站点的 MAC 地址的可达性，主要用于 CE 多归属的场景中的水平分割和快速收敛。</p>
<p>以太网段路由 (Ethernet Segment Route) : 当 PE 之间的 BGP 邻居关系建立成功后，PE 之间会传递以太网段路由，用来实现连接到相同 CE 的 PE 设备之间互相自动发现。以太网段路由主要用于 CE 多归属场景中的 DF 的选举。在单归属场景中，主要涉及前两种路由的交互。接下来我们就看一下，这两种路由信息是如何促成控制面表项和隧道生成的。</p>
<p>type 1</p>
<p>双规场景下实现别名，快速收敛，水平分割</p>
<p>esi 用于实现 PE 是否连在一台 CE 上，本端 PE 知道，对端 PE 也知道</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201215825630.png" alt="image-20230201215825630"></p>
<p>通过阻塞链路或者负载分担防环</p>
<p>阻塞链路：single active</p>
<p>负载分担：all- active</p>
<p>多活时与 CE 相连的 PE 必须都是多活</p>
<p>有一个单活就必须使用第一种</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201220430613.png" alt="image-20230201220430613"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201221300402.png" alt="image-20230201221300402"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201222213560.png" alt="image-20230201222213560"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203212914411.png" alt="image-20230203212914411"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203213933709.png" alt="image-20230203213933709"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203214050214.png" alt="image-20230203214050214"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203214445292.png" alt="image-20230203214445292"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203214823555.png" alt="image-20230203214823555"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203215114418.png" alt="image-20230203215114418"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203215133032.png" alt="image-20230203215133032"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203220526567.png" alt="image-20230203220526567"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">vlan batch 30 100 200</span><br><span class="line">vsys enable</span><br><span class="line">vsys name A 1</span><br><span class="line"> assign vlan 100</span><br><span class="line"> assign global-ip 203.1.1.1 203.1.1.10 free</span><br><span class="line">interface Vlanif100</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.100.100 255.255.255.0</span><br><span class="line"> service-manage ping permit</span><br><span class="line">#</span><br><span class="line">interface Vlanif200</span><br><span class="line"> ip address 192.168.200.200 255.255.255.0</span><br><span class="line"> service-manage ping permit</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/0</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip binding vpn-instance default</span><br><span class="line"> ip address 192.168.0.1 255.255.255.0</span><br><span class="line"> alias GE0/METH</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1/0/0</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1/0/1</span><br><span class="line"> portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> port link-type trunk</span><br><span class="line"> port trunk allow-pass vlan 2 to 4094</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1/0/2</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1/0/3</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1/0/4</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1/0/5</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1/0/6</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface Virtual-if0</span><br><span class="line">#</span><br><span class="line">interface Virtual-if1</span><br><span class="line">#</span><br><span class="line">interface NULL0</span><br><span class="line">#</span><br><span class="line">firewall zone local</span><br><span class="line"> set priority 100</span><br><span class="line">#</span><br><span class="line">firewall zone trust</span><br><span class="line"> set priority 85</span><br><span class="line"> add interface GigabitEthernet0/0/0</span><br><span class="line"> add interface Virtual-if0</span><br><span class="line">#</span><br><span class="line">firewall zone untrust</span><br><span class="line"> set priority 5</span><br><span class="line"> add interface Vlanif200</span><br><span class="line">#</span><br><span class="line">firewall zone dmz</span><br><span class="line"> set priority 50</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 192.168.200.1</span><br><span class="line">ip route-static 203.1.1.0 255.255.255.240 vpn-instance A</span><br><span class="line">#</span><br><span class="line">user-interface con 0</span><br><span class="line"> authentication-mode aaa</span><br><span class="line"> idle-timeout 0 0</span><br><span class="line">user-interface vty 0 4</span><br><span class="line"> authentication-mode aaa</span><br><span class="line"> protocol inbound ssh</span><br><span class="line">user-interface vty 16 20</span><br><span class="line">#</span><br><span class="line">switch vsys A</span><br><span class="line">sys </span><br><span class="line">interface Vlanif100</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.100.100 255.255.255.0</span><br><span class="line"> service-manage ping permit</span><br><span class="line"></span><br><span class="line">firewall zone local</span><br><span class="line"> set priority 100</span><br><span class="line">#</span><br><span class="line">firewall zone trust</span><br><span class="line"> set priority 85</span><br><span class="line"> add interface Vlanif100</span><br><span class="line">#</span><br><span class="line">firewall zone untrust</span><br><span class="line"> set priority 5</span><br><span class="line"> add interface Virtual-if1</span><br><span class="line">#</span><br><span class="line">firewall zone dmz</span><br><span class="line"> set priority 50</span><br><span class="line">#</span><br><span class="line">location</span><br><span class="line">#</span><br><span class="line">nat address-group A 0</span><br><span class="line"> mode pat</span><br><span class="line"> section 0 203.1.1.1 203.1.1.3</span><br><span class="line">#</span><br><span class="line">multi-linkif</span><br><span class="line"> mode proportion-of-weight</span><br><span class="line">#</span><br><span class="line">security-policy</span><br><span class="line"> rule name test</span><br><span class="line">  source-zone trust</span><br><span class="line">  destination-zone untrust</span><br><span class="line">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class="line">  source-address 192.168.2.0 mask 255.255.255.0</span><br><span class="line">  action permit</span><br><span class="line">#</span><br><span class="line">auth-policy</span><br><span class="line">#</span><br><span class="line">traffic-policy</span><br><span class="line">#</span><br><span class="line">policy-based-route</span><br><span class="line">#</span><br><span class="line">nat-policy</span><br><span class="line"> rule name A</span><br><span class="line">  source-zone trust</span><br><span class="line">  destination-zone untrust</span><br><span class="line">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class="line">  source-address 192.168.2.0 mask 255.255.255.0</span><br><span class="line">  action source-nat address-group A</span><br><span class="line">#</span><br><span class="line">quota-policy</span><br><span class="line">#</span><br><span class="line">pcp-policy</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 public</span><br><span class="line">ip route-static 192.168.1.0 255.255.255.0 192.168.100.1</span><br><span class="line">ip route-static 192.168.2.0 255.255.255.0 192.168.100.1</span><br><span class="line">#</span><br><span class="line">return</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      <div class="tags">
          <a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"><i class="ic i-tag"></i> 网络</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-01-02 22:57:03" itemprop="dateModified" datetime="2024-01-02T22:57:03+08:00">2024-01-02</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2023/01/20/VXLAN/" title="VXLAN">http://example.com/2023/01/20/VXLAN/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/01/17/Segment%20Routing/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;db2a95362955b963ac39e3b449f84fa0.jpg" title="Segment Routing">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> 网络</span>
  <h3>Segment Routing</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/02/21/https%E5%8E%9F%E7%90%86/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;e1077c43120f41fdab6a5b79cc10a94b.jpg" title="https+TLS">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>https+TLS</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#vxlan"><span class="toc-number">1.</span> <span class="toc-text"> VXLAN</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#enspvirtualbox%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text"> ensp&amp;virtualbox 设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vxlan-2"><span class="toc-number">1.2.</span> <span class="toc-text"> VXLAN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-number">1.3.</span> <span class="toc-text"> 名词解释</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nvo3-nve"><span class="toc-number">1.3.1.</span> <span class="toc-text"> NVO3 &amp; NVE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vtep"><span class="toc-number">1.3.2.</span> <span class="toc-text"> VTEP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vni"><span class="toc-number">1.3.3.</span> <span class="toc-text"> VNI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C1%E5%90%8C%E5%AD%90%E7%BD%91%E4%BA%92%E8%AE%BF"><span class="toc-number">1.4.</span> <span class="toc-text"> 实验 1: 同子网互访</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BA%8C%E8%B7%A8%E5%AD%90%E7%BD%91%E4%BA%92%E9%80%9A%E9%9B%86%E4%B8%AD%E5%BC%8F%E7%BD%91%E5%85%B3"><span class="toc-number">1.5.</span> <span class="toc-text"> 实验二：跨子网互通（集中式网关）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E4%B8%AD%E5%BC%8F%E5%8F%8C%E6%B4%BB%E7%BD%91%E5%85%B3%E8%BF%87%E5%A2%99"><span class="toc-number">1.6.</span> <span class="toc-text"> 集中式双活网关过墙</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#evpn"><span class="toc-number">1.7.</span> <span class="toc-text"> EVPN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%BD%91%E5%85%B3"><span class="toc-number">1.8.</span> <span class="toc-text"> 分布式网关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%BD%91%E5%85%B3%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91"><span class="toc-number">1.9.</span> <span class="toc-text"> 分布式网关访问外网</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2023/01/17/Segment%20Routing/" rel="bookmark" title="Segment Routing">Segment Routing</a></li><li class="active"><a href="/2023/01/20/VXLAN/" rel="bookmark" title="VXLAN">VXLAN</a></li><li><a href="/2023/09/01/border%20leaf/" rel="bookmark" title="从三层架构到spine leaf">从三层架构到spine leaf</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">41</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">6</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">6</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/01/17/Segment%20Routing/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/02/21/https%E5%8E%9F%E7%90%86/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/04/16/Upload/" title="File upload">File upload</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/11/reverse/" title="逆向">逆向</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/01/01/%E5%8F%91%E7%8E%B0%E5%B0%8F%E5%8F%AF%E7%88%B1%EF%BC%81/" title="about me">about me</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/11/17/JWT%20%E5%9F%BA%E7%A1%80/" title="JWT">JWT</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/02/21/https%E5%8E%9F%E7%90%86/" title="https+TLS">https+TLS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%86%85%E7%BD%91/" title="In 内网">内网</a>
</div>

    <span><a href="/2022/12/25/%E5%86%85%E7%BD%91/" title="内网渗透">内网渗透</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/05/30/jenkins/" title="Jenkins">Jenkins</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%BD%91%E7%BB%9C/" title="In 网络">网络</a>
</div>

    <span><a href="/2023/01/20/VXLAN/" title="VXLAN">VXLAN</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/10/01/1234567/" title="windows逆向进阶">windows逆向进阶</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/09/15/%E7%BC%93%E5%AD%98%E6%B1%A1%E6%9F%93/" title="缓存污染&#x2F;请求走私">缓存污染/请求走私</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/01/20/VXLAN/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
