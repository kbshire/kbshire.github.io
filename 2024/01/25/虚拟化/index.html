



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="运维" />


<link rel="canonical" href="http://example.com/2024/01/25/%E8%99%9A%E6%8B%9F%E5%8C%96/">



  <title>
虚拟化 - 运维 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">虚拟化
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2024-01-25 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2024-01-25T13:38:45+08:00">2024-01-25</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/ae23eaf87c243eca94d1200ec5cbee87.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/11a6a57662360e218ec542ca527b4a53.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/c50475797549951523025a46bab169bb.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/3f20154a69ec2ac89963a3c94445fdd7.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/b7dd27ac7273dd91b0085c941520d6f5.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/cf4be7119bd8f8bbbb499428b4effd12.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="item" rel="index" title="In 运维"><span itemprop="name">运维</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/25/%E8%99%9A%E6%8B%9F%E5%8C%96/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="虚拟化"><a class="markdownIt-Anchor" href="#虚拟化">#</a> 虚拟化</h1>
<h2 id="kvm"><a class="markdownIt-Anchor" href="#kvm">#</a> kvm</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 配置yum</span><br><span class="line">mount -t iso9660 -o ro,loop xxx    /www</span><br><span class="line">mount 只能mount块设备。mount文件的时候，会先做成块设备，再mount</span><br><span class="line"></span><br><span class="line">// 把文件做成块设备</span><br><span class="line">losetup /dev/loop1 xxx.iso</span><br><span class="line">losetup -a</span><br><span class="line">// mount -t iso9660 -o ro /dev/loop1  /www    -&gt;   mount -t iso9660 -o ro,loop xxx    /www</span><br><span class="line"></span><br><span class="line">简写</span><br><span class="line">mount xxx.iso /ppp</span><br><span class="line"></span><br><span class="line">mount -l</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 自定义yum</span><br><span class="line">createrepo xxx    // 生成repodata</span><br><span class="line"></span><br><span class="line">baseurl配置和 repodata 同一目录</span><br><span class="line">gpgcheck 需要配合私钥使用。 RPM-GPG-KEY</span><br></pre></td></tr></table></figure>
<h3 id="虚拟化-2"><a class="markdownIt-Anchor" href="#虚拟化-2">#</a> 虚拟化</h3>
<p>kvm / vcenter  /  xen  /  hyper-v</p>
<h3 id="kvm-qemu-libvirtd"><a class="markdownIt-Anchor" href="#kvm-qemu-libvirtd">#</a> KVM /QEMU /LIBVIRTD</h3>
<p>KVM 是 linux 内核的模块，他需要 CPU 的支持，采用硬件辅助虚拟化技术 Intel-VT，AMD-V，内存的相关如 Intel 的 EPT 和 AMD 的 RVI 技术</p>
<p>QEMU 是一个虚拟化的仿真工具，通过 ioctl 与内核 kvm 交互完成对硬件的虚拟化支持</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240123230817999.png" alt="image-20240123230817999" style="zoom:50%;" /> 
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240123230901146.png" alt="image-20240123230901146" style="zoom: 25%;" /> 
<p>Libvirt 是一个对虚拟化管理的接口和工具，提供用户端程序 virsh ,virt-install, virt-manager, virt-view 与用户交互</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost usr]# ps -efww | grep qemu </span><br><span class="line">qemu       4075      1 99 06:41 ?        00:13:46 /usr/libexec/qemu-kvm -name generic -S -machine pc-i440fx-rhel7.0.0,accel=tcg,usb=off,dump-guest-core=off -m 1024 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid 7693d5c3-1153-43aa-a38e-4093f30292a0 -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-3-generic/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-reboot -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot strict=on -device ich9-usb-ehci1,id=usb,bus=pci.0,addr=0x5.0x7 -device ich9-usb-uhci1,masterbus=usb.0,firstport=0,bus=pci.0,multifunction=on,addr=0x5 -device ich9-usb-uhci2,masterbus=usb.0,firstport=2,bus=pci.0,addr=0x5.0x1 -device ich9-usb-uhci3,masterbus=usb.0,firstport=4,bus=pci.0,addr=0x5.0x2 -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x6 -drive file=/var/lib/libvirt/images/generic.qcow2,format=qcow2,if=none,id=drive-ide0-0-0 -device ide-hd,bus=ide.0,unit=0,drive=drive-ide0-0-0,id=ide0-0-0,bootindex=2 -drive file=/root/CentOS-7-x86_64-Minimal-2009.iso,format=raw,if=none,id=drive-ide0-0-1,readonly=on -device ide-cd,bus=ide.0,unit=1,drive=drive-ide0-0-1,id=ide0-0-1,bootindex=1 -netdev tap,fd=26,id=hostnet0 -device rtl8139,netdev=hostnet0,id=net0,mac=52:54:00:3d:35:10,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev spicevmc,id=charchannel0,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -vga qxl -global qxl-vga.ram_size=67108864 -global qxl-vga.vram_size=67108864 -global qxl-vga.vgamem_mb=16 -global qxl-vga.max_outputs=1 -device intel-hda,id=sound0,bus=pci.0,addr=0x4 -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 -chardev spicevmc,id=charredir0,name=usbredir -device usb-redir,chardev=charredir0,id=redir0,bus=usb.0,port=1 -chardev spicevmc,id=charredir1,name=usbredir -device usb-redir,chardev=charredir1,id=redir1,bus=usb.0,port=2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x7 -msg timestamp=on</span><br><span class="line">root       4863   2914  0 06:53 pts/0    00:00:00 grep --color=auto qemu</span><br><span class="line"></span><br><span class="line">// 必选组件</span><br><span class="line">yum install qemu-kvm libvirt-daemon libvirt-client libvirt-daemon-driver-qemu -y</span><br><span class="line">systemctl enable --now libvirtd</span><br><span class="line"></span><br><span class="line">// 可选组件</span><br><span class="line">virt-install 系统安装工具</span><br><span class="line">virt-manager 图形管理工具</span><br><span class="line">virt-v2v  虚拟机迁移工具</span><br><span class="line">virt-p2v  物理机迁移工具</span><br></pre></td></tr></table></figure>
<p>虚拟机的组成<br>
内核虚拟化模块 (KVM)</p>
<p>系统设备仿真 (QEMU)</p>
<p>虚拟机管理程序 (LIBVIRT)</p>
<p>一个 XML 文件 (虚拟机配置声明文件)</p>
<p>位置 /etc/libvirt/qemu/</p>
<p>一个磁盘镜像文件 (虚拟机的硬盘)</p>
<p>位置 /var/lib/libvirt/images/</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost usr]# cd /etc/libvirt/qemu/</span><br><span class="line">[root@localhost qemu]# ls </span><br><span class="line">generic.xml  networks</span><br><span class="line"></span><br><span class="line">[root@localhost qemu]# cat generic.xml </span><br><span class="line">&lt;!--</span><br><span class="line">WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span><br><span class="line">OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:</span><br><span class="line">  virsh edit generic</span><br><span class="line">or other application using the libvirt API.</span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line">&lt;domain type=&#x27;qemu&#x27;&gt;</span><br><span class="line">  &lt;name&gt;generic&lt;/name&gt;</span><br><span class="line">  &lt;uuid&gt;7693d5c3-1153-43aa-a38e-4093f30292a0&lt;/uuid&gt;</span><br><span class="line">  &lt;memory unit=&#x27;KiB&#x27;&gt;1048576&lt;/memory&gt;</span><br><span class="line">  &lt;currentMemory unit=&#x27;KiB&#x27;&gt;1048576&lt;/currentMemory&gt;</span><br><span class="line">  &lt;vcpu placement=&#x27;static&#x27;&gt;1&lt;/vcpu&gt;</span><br><span class="line">  &lt;os&gt;</span><br><span class="line">    &lt;type arch=&#x27;x86_64&#x27; machine=&#x27;pc-i440fx-rhel7.0.0&#x27;&gt;hvm&lt;/type&gt;</span><br><span class="line">    &lt;boot dev=&#x27;hd&#x27;/&gt;</span><br><span class="line">  &lt;/os&gt;</span><br><span class="line">  &lt;features&gt;</span><br><span class="line">    &lt;acpi/&gt;</span><br><span class="line">    &lt;apic/&gt;</span><br><span class="line">  &lt;/features&gt;</span><br><span class="line">  &lt;clock offset=&#x27;utc&#x27;&gt;</span><br><span class="line">    &lt;timer name=&#x27;rtc&#x27; tickpolicy=&#x27;catchup&#x27;/&gt;</span><br><span class="line">    &lt;timer name=&#x27;pit&#x27; tickpolicy=&#x27;delay&#x27;/&gt;</span><br><span class="line">    &lt;timer name=&#x27;hpet&#x27; present=&#x27;no&#x27;/&gt;</span><br><span class="line">  &lt;/clock&gt;</span><br><span class="line">  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</span><br><span class="line">  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</span><br><span class="line">  &lt;on_crash&gt;destroy&lt;/on_crash&gt;</span><br><span class="line">  &lt;pm&gt;</span><br><span class="line">    &lt;suspend-to-mem enabled=&#x27;no&#x27;/&gt;</span><br><span class="line">    &lt;suspend-to-disk enabled=&#x27;no&#x27;/&gt;</span><br><span class="line">  &lt;/pm&gt;</span><br><span class="line">  &lt;devices&gt;</span><br><span class="line">    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</span><br><span class="line">    &lt;disk type=&#x27;file&#x27; device=&#x27;disk&#x27;&gt;</span><br><span class="line">      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27;/&gt;</span><br><span class="line">      &lt;source file=&#x27;/var/lib/libvirt/images/generic.qcow2&#x27;/&gt;</span><br><span class="line">      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;</span><br><span class="line">      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27;/&gt;</span><br><span class="line">      &lt;target dev=&#x27;hdb&#x27; bus=&#x27;ide&#x27;/&gt;</span><br><span class="line">      &lt;readonly/&gt;</span><br><span class="line">      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-ehci1&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x7&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-uhci1&#x27;&gt;</span><br><span class="line">      &lt;master startport=&#x27;0&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x0&#x27; multifunction=&#x27;on&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-uhci2&#x27;&gt;</span><br><span class="line">      &lt;master startport=&#x27;2&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x1&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-uhci3&#x27;&gt;</span><br><span class="line">      &lt;master startport=&#x27;4&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x2&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;pci&#x27; index=&#x27;0&#x27; model=&#x27;pci-root&#x27;/&gt;</span><br><span class="line">    &lt;controller type=&#x27;ide&#x27; index=&#x27;0&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x01&#x27; function=&#x27;0x1&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;virtio-serial&#x27; index=&#x27;0&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x06&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;interface type=&#x27;network&#x27;&gt;</span><br><span class="line">      &lt;mac address=&#x27;52:54:00:3d:35:10&#x27;/&gt;</span><br><span class="line">      &lt;source network=&#x27;default&#x27;/&gt;</span><br><span class="line">      &lt;model type=&#x27;rtl8139&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x03&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">    &lt;serial type=&#x27;pty&#x27;&gt;</span><br><span class="line">      &lt;target type=&#x27;isa-serial&#x27; port=&#x27;0&#x27;&gt;</span><br><span class="line">        &lt;model name=&#x27;isa-serial&#x27;/&gt;</span><br><span class="line">      &lt;/target&gt;</span><br><span class="line">    &lt;/serial&gt;</span><br><span class="line">    &lt;console type=&#x27;pty&#x27;&gt;</span><br><span class="line">      &lt;target type=&#x27;serial&#x27; port=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;/console&gt;</span><br><span class="line">    &lt;channel type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;target type=&#x27;virtio&#x27; name=&#x27;com.redhat.spice.0&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;virtio-serial&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; port=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/channel&gt;</span><br><span class="line">    &lt;input type=&#x27;mouse&#x27; bus=&#x27;ps2&#x27;/&gt;</span><br><span class="line">    &lt;input type=&#x27;keyboard&#x27; bus=&#x27;ps2&#x27;/&gt;</span><br><span class="line">    &lt;graphics type=&#x27;spice&#x27; autoport=&#x27;yes&#x27;&gt;</span><br><span class="line">      &lt;listen type=&#x27;address&#x27;/&gt;</span><br><span class="line">      &lt;image compression=&#x27;off&#x27;/&gt;</span><br><span class="line">    &lt;/graphics&gt;</span><br><span class="line">    &lt;sound model=&#x27;ich6&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/sound&gt;</span><br><span class="line">    &lt;video&gt;</span><br><span class="line">      &lt;model type=&#x27;qxl&#x27; ram=&#x27;65536&#x27; vram=&#x27;65536&#x27; vgamem=&#x27;16384&#x27; heads=&#x27;1&#x27; primary=&#x27;yes&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/video&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;0&#x27; port=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;0&#x27; port=&#x27;2&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;memballoon model=&#x27;virtio&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x07&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/memballoon&gt;</span><br><span class="line">  &lt;/devices&gt;</span><br><span class="line">&lt;/domain&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost images]# ls </span><br><span class="line">generic.qcow2</span><br></pre></td></tr></table></figure>
<h3 id="virsh-命令"><a class="markdownIt-Anchor" href="#virsh-命令">#</a> virsh 命令</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">// 两种方式</span><br><span class="line">[root@localhost images]# virsh </span><br><span class="line">Welcome to virsh, the virtualization interactive terminal.</span><br><span class="line"></span><br><span class="line">Type:  &#x27;help&#x27; for help with commands</span><br><span class="line">       &#x27;quit&#x27; to quit</span><br><span class="line"></span><br><span class="line">virsh # list </span><br><span class="line"> Id    Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 3     generic                        running</span><br><span class="line"></span><br><span class="line">virsh # exit </span><br><span class="line"></span><br><span class="line">[root@localhost images]# virsh list   				// 列出启动的虚拟机</span><br><span class="line"> Id    Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 3     generic                        running</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost images]# virsh list  --all 				// 列出所有虚拟机</span><br><span class="line"> Id    Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 3     generic                        running</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost images]# virsh start/reboot/shutdown xxx 			// 启动虚拟机</span><br><span class="line"></span><br><span class="line">[root@localhost images]# virsh destroy xxx 			// 强制关闭虚拟机</span><br><span class="line"></span><br><span class="line">[root@localhost images]# virsh define/undefine  xxx 			// 根据xml创建删除虚拟机</span><br><span class="line"></span><br><span class="line">[root@localhost images]# virsh console  xxx 			// 链接虚拟机console</span><br><span class="line">ctrl + ]  退出console</span><br><span class="line"></span><br><span class="line">[root@localhost images]# virsh edit  xxx 				// 调整虚拟机参数</span><br><span class="line"></span><br><span class="line">[root@localhost images]# virsh autostart  xxx 			// 开机自启</span><br><span class="line"></span><br><span class="line">[root@localhost images]# virsh domiflist  xxx			// 设置虚拟机网卡 		</span><br><span class="line"></span><br><span class="line">[root@localhost images]# virsh domblklist  xxx			// 设置虚拟机硬盘 		</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 虚拟交换机命令</span><br><span class="line">[root@localhost images]# virsh net-list --all</span><br><span class="line"> Name                 State      Autostart     Persistent</span><br><span class="line">----------------------------------------------------------</span><br><span class="line"> default              active     yes           yes</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# virsh net-start </span><br><span class="line">[root@localhost ~]# virsh net-destroy</span><br><span class="line">[root@localhost ~]# virsh net-define</span><br><span class="line">[root@localhost ~]# virsh net-undefine</span><br><span class="line">[root@localhost ~]# virsh net-edit</span><br><span class="line">[root@localhost ~]# virsh net-autostart</span><br></pre></td></tr></table></figure>
<h3 id="虚拟机磁盘管理"><a class="markdownIt-Anchor" href="#虚拟机磁盘管理">#</a> 虚拟机磁盘管理</h3>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240124212020114.png" alt="image-20240124212020114" style="zoom:50%;" /> 
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">qemu-img 是虚拟机的磁盘管理命令，支持非常多的磁盘格式，例如raw、qcow2、vdi、vmdk等等</span><br><span class="line"></span><br><span class="line">qemu-img create -f qcow2 aa.img 50G</span><br><span class="line">qemu-img create -b haha.img -f qcow2 111.img    // -b使用后端模板文件</span><br><span class="line"></span><br><span class="line">qemu-img info aa.img</span><br><span class="line"></span><br><span class="line">qemu-img convert   // 转换磁盘格式</span><br><span class="line"></span><br><span class="line">qemu-img info</span><br><span class="line"></span><br><span class="line">qemu-img resize</span><br></pre></td></tr></table></figure>
<p>qcow2 占用空间小，创建系统时不会把所有空间全部占用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /var/lib/libvirt/images/</span><br><span class="line">[root@localhost images]# qemu-img create -f qcow2 node_base  20G</span><br><span class="line">Formatting &#x27;node_base&#x27;, fmt=qcow2 size=21474836480 encryption=off cluster_size=65536 lazy_refcounts=off </span><br><span class="line">[root@localhost images]# qemu-img create -b node_base -f qcow2 node_node.img 20G</span><br><span class="line">Formatting &#x27;node_node.img&#x27;, fmt=qcow2 size=21474836480 backing_file=&#x27;node_base&#x27; encryption=off cluster_size=65536 lazy_refcounts=off </span><br><span class="line"></span><br><span class="line">[root@localhost images]# qemu-img  info node_base </span><br><span class="line">image: node_base</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 20G (21474836480 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: false</span><br><span class="line">    </span><br><span class="line">[root@localhost images]# qemu-img  info node_node.img </span><br><span class="line">image: node_node.img</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 20G (21474836480 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">backing file: node_base</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: false</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>cow</p>
<p>Copy On Write，写时复制</p>
<p>直接映射原始盘的数据内容</p>
<p>当数据有修改要求时，在修改之前自动将旧数据拷贝存入前端盘后，对前端盘进行修改</p>
<p>原始盘始终是只读的</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240124215416657.png" alt="image-20240124215416657"></p>
<h3 id="克隆虚拟机"><a class="markdownIt-Anchor" href="#克隆虚拟机">#</a> 克隆虚拟机</h3>
<p>复制已经存在的 xml 为 zzz.xml</p>
<p>修改 name，和 xml 名字一样</p>
<p>修改 disk file</p>
<p>执行：</p>
<p>virsh define zzz.xml</p>
<p>virsh start zzz</p>
<p>virsh list</p>
<p>virsh console zzz</p>
<h3 id="扩容磁盘"><a class="markdownIt-Anchor" href="#扩容磁盘">#</a> 扩容磁盘</h3>
<p>磁盘 -&gt;  分区  -&gt;  文件系统</p>
<p>不能缩，只能扩</p>
<p>1. 硬件扩容</p>
<p>virsh blockresize --path /var/lib/libvirt/images/node1.img --size 50G  node1</p>
<p>下面的命令在虚拟机上执行</p>
<p>2. 磁盘空间扩容</p>
<p>growpart /dev/vda 1</p>
<p>3. 扩容文件系统</p>
<p>xfs_growfs /dev/vda1</p>
<h2 id="openstack"><a class="markdownIt-Anchor" href="#openstack">#</a> OpenStack</h2>
<h3 id="openstack-组件"><a class="markdownIt-Anchor" href="#openstack-组件">#</a> openstack 组件</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240126212642843.png" alt="image-20240126212642843"></p>
<p>Keystone</p>
<p>为其他服务提供认证和授权的集中身份管理服务</p>
<p>也提供了集中的目录服务</p>
<p>支持多种身份认证模式，如密码认证、令牌认证、以及 AWS 登陆</p>
<p>为用户和其他服务提供了 SSO 认证服务</p>
<p>Neutron</p>
<p>一种软件定义网络服务</p>
<p>用于创建网络、子网、路由器、管理浮动 IP 地址</p>
<p>可以实现虚拟交换机、虚拟路由器</p>
<p>可用于在项目中创建 VPN</p>
<h3 id="部署"><a class="markdownIt-Anchor" href="#部署">#</a> 部署</h3>
<p>三台 8C 16G 主机，一个 hostname openstack，另外两个 nova1 和  nova2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">// 以下操作在每台节点上执行</span><br><span class="line">vim /etc/resolve.conf</span><br><span class="line">8.8.8.8</span><br><span class="line"></span><br><span class="line">vim /etc/hosts</span><br><span class="line">192.168.13.201 openstack</span><br><span class="line">192.168.13.202 nova1</span><br><span class="line">192.168.13.202 nova2</span><br><span class="line"></span><br><span class="line">yum install chrony -y</span><br><span class="line">vim /etc/chrony.conf</span><br><span class="line">server ntp2.aliyun.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp.aliyun.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp1.aliyun.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp1.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp10.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp11.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp12.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp2.aliyun.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp2.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp3.aliyun.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp3.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp4.aliyun.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp4.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp5.aliyun.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp5.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp6.aliyun.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp6.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp7.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp8.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line">server ntp9.cloud.aliyuncs.com minpoll 4 maxpoll 10 iburst</span><br><span class="line"></span><br><span class="line">systemctl restart chronyd</span><br><span class="line">chronyc sources -v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum install qemu-kvm libvirt-daemon libvirt-daemon-driver-qemu libvirt-client python-setuptools -y</span><br><span class="line">yum remove NetworkManager* -y</span><br><span class="line">yum remove firewalld* -y </span><br><span class="line"></span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-ens33 </span><br><span class="line">BOOTPROTO=static</span><br><span class="line">systemctl restart network</span><br><span class="line"></span><br></pre></td></tr></table></figure>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// openstack节点</span><br><span class="line">bash &lt;(curl -sSL https://gitee.com/SuperManito/LinuxMirrors/raw/main/ChangeMirrors.sh)</span><br><span class="line">    选择中科大镜像源。</span><br><span class="line">    注意不要安装EPEL扩展源因为会导致稍后安装packstack失败，建议只更换基础源不要更换OpenStack相关的源避免后续在获取某些软件包时超时失败。</span><br><span class="line">    使用HTTP协议</span><br><span class="line">    更新软件包</span><br><span class="line">    清空已下载软件包缓存</span><br><span class="line"></span><br><span class="line">yum install centos-release-openstack-train</span><br><span class="line">yum install openstack-packstack</span><br><span class="line"></span><br><span class="line">packstack --gen-answer-file=answer.ini</span><br><span class="line">packstack --answer-file=answer.ini</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CONFIG_CONTROLLER_HOST=192.168.13.201</span><br><span class="line">CONFIG_COMPUTE_HOSTS=192.168.13.202</span><br><span class="line"></span><br><span class="line"># List of servers on which to install the network service such as</span><br><span class="line"># Compute networking (nova network) or OpenStack Networking (neutron).</span><br><span class="line">CONFIG_NETWORK_HOSTS=192.168.13.201,192.168.13.202</span><br></pre></td></tr></table></figure>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240127214826167.png" alt="image-20240127214826167" style="zoom:50%;" /> 
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240127222426338.png" alt="image-20240127222426338"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl show</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@openstack ~]# . keystonerc_admin </span><br><span class="line">[root@openstack ~(keystone_admin)]# openstack user list</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| ID                               | Name      |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| b88c0404f054445ab8c099673ecdb0f9 | admin     |</span><br><span class="line">| 592cf7de5ffe4ec69bec764c6e6a3506 | glance    |</span><br><span class="line">| a62eaa55c4c44dbf9c559b471bde2394 | cinder    |</span><br><span class="line">| 7edbdc229b8f4286bde2aa477521b2ad | nova      |</span><br><span class="line">| 51b14b54bc124655b6bb29fb2b0b8458 | placement |</span><br><span class="line">| 4facc9243f4c471a91bc9a9d5b5c45d0 | neutron   |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line"></span><br><span class="line">// 不退出终端</span><br><span class="line">[root@openstack ~]# bash</span><br><span class="line">[root@openstack ~]# . keystonerc_admin </span><br><span class="line">[root@openstack ~(keystone_admin)]# </span><br><span class="line">[root@openstack ~(keystone_admin)]# exit</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">// 查看帮助</span><br><span class="line">[root@openstack ~]# openstack help user </span><br><span class="line">Command &quot;user&quot; matches:</span><br><span class="line">  user create</span><br><span class="line">  user delete</span><br><span class="line">  user list</span><br><span class="line">  user password set</span><br><span class="line">  user set</span><br><span class="line">  user show</span><br></pre></td></tr></table></figure>
<h3 id="项目管理"><a class="markdownIt-Anchor" href="#项目管理">#</a> 项目管理</h3>
<p>项目：一组隔离的资源和对象。由一组关联的用户进行管理</p>
<p>在旧版本里，也用租户 (tenant) 来表示</p>
<p>根据配置的需求，项目对应一个组织、一个公司或是一个使用客户等</p>
<p>项目中可以有多个用户，项目中的用户可以在该项目创建、管理虚拟资</p>
<p>源具有 admin 角色的用户可以创建项目</p>
<p>项目相关信息保存到 MariaDB 中</p>
<p>缺省情况下，packstack 安装的 openstack 中有两个独立的项目</p>
<ul>
<li>admin: 为 admin 账户创建的项目</li>
<li>services: 与安装的各个服务相关联</li>
</ul>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128195410374.png" alt="image-20240128195410374"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// 创建项目</span><br><span class="line">[root@openstack ~(keystone_admin)]# openstack project create myproject</span><br><span class="line"></span><br><span class="line">[root@openstack ~(keystone_admin)]# openstack project list</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| ID                               | Name      |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| 54aa5d992e084017a2aef3282fdb1119 | admin     |</span><br><span class="line">| 735ea2227d2e4c509af906f8e519c95d | myproject |</span><br><span class="line">| c0e8ee283cca473d87676ff1a0f099ef | services  |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line"></span><br><span class="line">[root@openstack ~(keystone_admin)]# openstack project show myproject </span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description |                                  |</span><br><span class="line">| domain_id   | default                          |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | 735ea2227d2e4c509af906f8e519c95d |</span><br><span class="line">| is_domain   | False                            |</span><br><span class="line">| name        | myproject                        |</span><br><span class="line">| options     | &#123;&#125;                               |</span><br><span class="line">| parent_id   | default                          |</span><br><span class="line">| tags        | []                               |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">[root@openstack ~(keystone_admin)]# openstack project set --disable 激活/禁用项目</span><br><span class="line"></span><br><span class="line">// 查看项目配额</span><br><span class="line">[root@openstack ~(keystone_admin)]# nova quota-show --tenant myproject </span><br><span class="line"></span><br><span class="line">// 更新vcpu数目</span><br><span class="line">[root@openstack ~(keystone_admin)]# nova quota-update --cores 30</span><br><span class="line"></span><br><span class="line">// 删除</span><br><span class="line">[root@openstack ~(keystone_admin)]# openstack project delete myproject</span><br></pre></td></tr></table></figure>
<p>创建项目</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128200815326.png" alt="image-20240128200815326"></p>
<p>创建用户</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128200738517.png" alt="image-20240128200738517"></p>
<p>修改密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@openstack ~(keystone_admin)]# openstack user set --password 123456 kbshire		// 修改密码</span><br><span class="line">[root@openstack ~(keystone_admin)]# openstack role remove --project myproject --user kbshire _member_    // 删除用户</span><br><span class="line">[root@openstack ~(keystone_admin)]# openstack  user delete  kbshire </span><br></pre></td></tr></table></figure>
<p>资源配额</p>
<p>安全组规则：指定每个项目可用的规则数</p>
<p>核心：指定每个项可用的 VCPU 核心数</p>
<p>固定 IP 地址：指定每个项目可用的固定 IP 数</p>
<p>浮动 IP 地址：指定每个项目可用的浮动 IP 数</p>
<p>注入文件大小：指定每个项目内容大小</p>
<p>注入文件路径：指定每个项目注入的文件路径长度</p>
<p>注入文件：指定每个项目允许注入的文件数目</p>
<p>实例：指定每个项目可创建的虚拟机实例数目</p>
<p>密钥对：指定每个项可创建的密钥数</p>
<p>元数据：指定每个项目可用的元数据数目</p>
<p>内存：指定每个项目可用的最大内存</p>
<p>安全组：指定每个项目可创建的安全组数目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">列出项目的缺省配额</span><br><span class="line">[root@openstack~(keystone_admin)]# nova quota-defaults</span><br><span class="line">列出myproject的配额</span><br><span class="line">[root@openstack~(keystone admin)]# nova quota-show --tenant myproject</span><br><span class="line">修改浮动IP地址配额</span><br><span class="line">[root@openstack~(keystone admin)]# nova quota-update --floating-ips 20 myproject</span><br></pre></td></tr></table></figure>
<p>云主机类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">云主机类型就是资源的模板</span><br><span class="line">它定义了一台云主机可以使用的资源，如内存大小磁盘容量和CPU核心数等</span><br><span class="line">Openstack提供了几个默认的云主机类型</span><br><span class="line">管理员还可以自定义云主机类型</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128202210696.png" alt="image-20240128202210696"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">列出所有的云主机类型</span><br><span class="line">[root@openstack~(keystone admin)]# openstack flavor list</span><br><span class="line">创建一个云主机类型</span><br><span class="line">[root@openstack~(keystone admin)]# openstack flavor create --public demo.tiny--id auto --ram 512 --disk 10 --vcpus 1</span><br><span class="line">删除云主机类型</span><br><span class="line">[root@openstack~(keystone admin)]# openstack flavor delete demo.tiny</span><br></pre></td></tr></table></figure>
<p>在红帽 Openstack 平台中，镜像指的是虚拟磁盘文件</p>
<p>磁盘文件中应该已经安装了可启动的操作系统</p>
<p>镜像管理功能由 Glance 服务提供</p>
<p>它形成了创建虚拟机实例最底层的块结构</p>
<p>镜像可以由用户上传，也可以通过红帽官方站点下载</p>
<p>镜像容器格式</p>
<p>raw: 非结构化磁盘镜像格式</p>
<p>vhd:VMware、Xen、Microsoft、VirtualBox 等均支持的通用磁盘格式</p>
<p>vmdk: 是 Vmware 的虚拟磁盘格式</p>
<p>vdi:VirtualBox 虚拟机和 QEMU 支持磁盘格式</p>
<p>iso: 光盘数据内容的归档格式</p>
<p>qcow2:QEMU 支持的磁盘格式。空间自动扩展并支持写时复制 copy-on-write</p>
<p>bare: 镜像中没有容器或元数据封装</p>
<p>ovf: 一种开源的文件规范，描述了一个开源、安全、有效、可拓展的便携式虚拟打包以及软件分布格式</p>
<p>ova:OVA 归档文件</p>
<p>aki: 亚马逊内核镜像</p>
<p>ami: 亚马逊主机镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">上传镜像</span><br><span class="line">[root@openstack~(keystone admin)]# openstack image create --disk-format qcow2 -min-disk 10 --min-ram 512 --file /root/small.img small_rhel6</span><br><span class="line">列出镜像</span><br><span class="line">[root@openstack~(keystone admin)]# openstack image list</span><br><span class="line">查看镜像详情</span><br><span class="line">[root@openstack~(keystone admin)]# openstack image show small_rhel6</span><br></pre></td></tr></table></figure>
<h3 id="网络"><a class="markdownIt-Anchor" href="#网络">#</a> 网络</h3>
<p>实例被分配到子网中，以实现网络连通性</p>
<p>每个项目可以有一到多个子网</p>
<p>在红帽的 Openstack 平台中，OpenStack 网络服务是缺省的网络选项，Nova 网络服务作为备用</p>
<p>管理员能够配置丰富的网络，将其他 Openstack 服务连接到这些网络的接口上</p>
<p>每个项目都能拥有多个私有网络，各个项目的私有网络互相不受干扰</p>
<p>项目网络：由 Neutron 提供的项目内部网络，网络间可用 VLAN 隔离</p>
<p>外部网络：可以让虚拟机接入外部网络，但需要配置浮动 IP 地址</p>
<p>提供商网络：将实例连接到现有网络，实现虚拟机实例与外部系统共享同一二层网络</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128210136299.png" alt="image-20240128210136299"></p>
<p>创建内部网络子网</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128212140879.png" alt="image-20240128212140879"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128212159932.png" alt="image-20240128212159932"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128212339442.png" alt="image-20240128212339442"></p>
<p>创建外部网络子网</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128212509791.png" alt="image-20240128212509791"></p>
<p>新建路由打通内外网</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128212721055.png" alt="image-20240128212721055"></p>
<p>添加接口</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128212830047.png" alt="image-20240128212830047"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128212803249.png" alt="image-20240128212803249"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240128212851644.png" alt="image-20240128212851644"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@openstack ~]#  systemctl status openstack-nova-compute.service </span><br></pre></td></tr></table></figure>
<p>创建浮动 IP 关联主机</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240129212317869.png" alt="image-20240129212317869"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240129212303012.png" alt="image-20240129212303012"></p>
<p>扩容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">扩容 openstack 计算节点参考 nova01 配置过程</span><br><span class="line"></span><br><span class="line">配置静态 ip:192.168.1.12，及主机名</span><br><span class="line">保证与 openstack,和 nova01 能相互 ping 通</span><br><span class="line">配置/etc/resolv.conf ，删除 search 开头行</span><br><span class="line">配置时间同步 /etc/chrony.conf</span><br><span class="line">配置 yum 源，软仓库</span><br><span class="line">安装依赖软件包 qemu-kvm libvirt-client libvirt-daemon libvirt-daemon-driver-qemu pythonsetuptools</span><br><span class="line"></span><br><span class="line">  96 # List the servers on which to install the Compute service.</span><br><span class="line">  97 CONFIG_COMPUTE_HOSTS=192.168.13.202</span><br><span class="line">  98 </span><br><span class="line">  99 # List of servers on which to install the network service such as</span><br><span class="line"> 100 # Compute networking (nova network) or OpenStack Networking (neutron).</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240129221506929.png" alt="image-20240129221506929" style="zoom:50%;" /> 
<p>迁移云主机</p>
<p>有多个 nova 计算节点的时候，我们可以选择性的把某一个云主机从某台机器上迁移到另外一台机器上</p>
<p>迁移条件</p>
<p>nova 计算节点与 openstack 管理节点都能相互 ping 通，主机名称也要能 ping 通</p>
<p>所有计算节点安装 qemu-img-rhev,qemu-kvm-rhev</p>
<p>如未安装，在安装以后需要重启 libvirtd 服务</p>
<h2 id="openstack-2"><a class="markdownIt-Anchor" href="#openstack-2">#</a> openstack</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Openstack通过一组相互关联的服务提供基础设施即服务(laas)解决方案，每个服务都提供了一个应用程序编程接口(API)来促进这种集成</span><br><span class="line">Openstack项目是一个适用于所有类型云的开源云计算平台，项目目标是提供实施简单、可大规模扩展、丰富、标准统一的云计算平台</span><br><span class="line"></span><br><span class="line">Openstack实际上由一系列叫作脚本的命令组成。这些脚本会被捆绑到名为项目的软件包中，这些软件包则用于传递创建云环境的任务为了创建这些环境，0penstack还会使用2种其他类型的软件:</span><br><span class="line">虚拟化软件，用于创建从硬件中抽象出来的虚拟资源层</span><br><span class="line">基础操作系统(0S)，用于执行0penstack脚本发出的命令</span><br><span class="line">Openstack本身不会虚拟化资源但会使用虚拟化资源来构建云</span><br><span class="line">openstack、虚拟化和基础操作系统，这3种技术协同工作服务用户</span><br><span class="line"></span><br><span class="line">0penstack每年两个大版本，一般在4月和10月中旬发布，版本命名从字母A-Z</span><br><span class="line"></span><br><span class="line">[root@openstack ~]# rpm -qa | grep cinder </span><br><span class="line">openstack-cinder-15.6.0-1.el7.noarch</span><br><span class="line">puppet-cinder-15.5.0-1.el7.noarch</span><br><span class="line">python2-cinder-15.6.0-1.el7.noarch</span><br><span class="line">python2-cinderclient-5.0.2-1.el7.noarch</span><br><span class="line">[root@openstack ~]# rpm -qa | grep nova</span><br><span class="line">openstack-nova-scheduler-20.6.0-1.el7.noarch</span><br><span class="line">openstack-nova-compute-20.6.0-1.el7.noarch</span><br><span class="line">openstack-nova-novncproxy-20.6.0-1.el7.noarch</span><br><span class="line">openstack-nova-api-20.6.0-1.el7.noarch</span><br><span class="line">python2-novaclient-15.1.1-1.el7.noarch</span><br><span class="line">openstack-nova-common-20.6.0-1.el7.noarch</span><br><span class="line">openstack-nova-migration-20.6.0-1.el7.noarch</span><br><span class="line">python2-nova-20.6.0-1.el7.noarch</span><br><span class="line">openstack-nova-conductor-20.6.0-1.el7.noarch</span><br><span class="line">puppet-nova-15.8.1-1.el7.noarch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nova-api-20.6.0-1根据这个版本可以找到对应的版本，即t版</span><br><span class="line">https://releases.openstack.org/train/index.html</span><br><span class="line"></span><br><span class="line">Openstack不是虚拟化，0penstack只是系统的控制面，不包括系统的数据面组件，如Hypervisor、存储和网络设备等</span><br><span class="line">虚拟化是Openstack底层的技术实现手段之一，但并非核心关注点Openstack与虚拟化的关键区别:</span><br><span class="line"></span><br><span class="line">0penstack只是构建云计算的关键组件</span><br><span class="line">内核、骨干、框架、总线</span><br><span class="line"></span><br><span class="line">openstack只是一个内核，不能直接用于商业化，需要进行二次开发</span><br></pre></td></tr></table></figure>
<h3 id="组件"><a class="markdownIt-Anchor" href="#组件">#</a> 组件</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">horizon 提供图形页面dashboard</span><br><span class="line">nova 提供计算资源 controller + compute  controller目前独立存在</span><br><span class="line">Controller 提供各种api入口，如glance-api,nova-api  通过controller操作各种资源，需要安装mysql ntp MQ AD 通过zookeeper做集群，必须单数</span><br><span class="line">compute 装了kvm的主机，也可以是xen lxc esxi</span><br><span class="line">华为云需要3controller + 2 network + N compute</span><br><span class="line"></span><br><span class="line">glance 提供镜像服务</span><br><span class="line">swift 提供对象存储</span><br><span class="line">cender 提供块存储</span><br><span class="line">neutron 网络组件，可以提供二层网络功能，3层路由功能，dhcp等功能</span><br><span class="line">heat 编排服务</span><br><span class="line">ceilometer：计量服务，监控各个主机的资源使用情况，计费</span><br><span class="line">keystone 身份验证</span><br></pre></td></tr></table></figure>
<p>gpenstack, 各个组件去对接虚拟化平台，对接存储等，都需要开发驱动程序</p>
<p>当执行 openstack 标准指令，通过驱动将 penstack 指令转化为存储指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">部署方式</span><br><span class="line">packstack</span><br><span class="line">devstack</span><br><span class="line">ansible</span><br><span class="line">开源方式部署</span><br><span class="line">Triple O openstack on openstack  通过heat自动化编排工具，填写参数完成</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">最佳部署:3台(一台 Controller+2台Compute 节点)CentOs8Stream，最少两台(一台Controller + 一台 Compute 节点)，Controller 节点内存最好 8G，最少 4G，Compute 节点4G 内存或者 8G硬盘 100G</span><br><span class="line">CPU 至少2core，最佳 4cores 。并且开启 VT-X每台主机两块网卡，其中第一块网卡需要能访问Internet，用来做管理网络和安装软件包</span><br><span class="line"></span><br><span class="line">controller 节点: NOVA-API, glance-api ,cinder-api等组件部署在该节点上，所有访问服务入口</span><br><span class="line">ntp</span><br><span class="line">database</span><br><span class="line">message queue</span><br><span class="line">keystone</span><br><span class="line"></span><br><span class="line">Zookeeper 必须单数，防止脑裂controller 节点至少三个节点768G 内存 HCS</span><br><span class="line"></span><br><span class="line">networking </span><br><span class="line">TYPE1:网络功能是由 neutron 提供，VLAN ROUTER DHCP 等，网络节点  （自服务网络 self-service）</span><br><span class="line">TYPE2: 硬件 SDN 控制器 </span><br><span class="line">TYPE3: Provider networks 网络功能是由底层硬件来实现的，比如 VLAN Router （provider network ）</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240317225954032.png" alt="image-20240317225954032"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line"># 虚拟机规划</span><br><span class="line">192.168.13.20 controller </span><br><span class="line">192.168.13.21 compute01</span><br><span class="line">192.168.13.22 compute02</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置ip</span><br><span class="line">[root@controller ~]#nmcli connection modify ens160 ipv4.addresses 192.168.13.20/24 ipv4.dns 8.8.8.8 ipv4.gateway 192.168.13.2 ipv4.method manual autoconnect yes </span><br><span class="line">[root@controller ~]#nmcli connection up ens160 </span><br><span class="line">[root@compute01 ~]#nmcli connection modify ens160 ipv4.addresses 192.168.13.21/24 ipv4.dns 8.8.8.8 ipv4.gateway 192.168.13.2 ipv4.method manual autoconnect yes </span><br><span class="line">[root@compute01 ~]#nmcli connection up ens160 </span><br><span class="line">[root@compute02 ~]#nmcli connection modify ens160 ipv4.addresses 192.168.13.22/24 ipv4.dns 8.8.8.8 ipv4.gateway 192.168.13.2 ipv4.method manual autoconnect yes </span><br><span class="line">[root@compute02 ~]#nmcli connection up ens160 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在所有机器上编辑/etc/hosts,增加如下配置，不要删除127.0.0.1</span><br><span class="line">192.168.13.20 controller </span><br><span class="line">192.168.13.21 compute01</span><br><span class="line">192.168.13.22 compute02</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置计算机名</span><br><span class="line">[root@controller ~]# hostnamectl set-hostname controller </span><br><span class="line">[root@compute01 ~]# hostnamectl set-hostname compute01</span><br><span class="line">[root@compute02 ~]# hostnamectl set-hostname compute02</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在所有节点上关闭selinux &amp;&amp; firewalld</span><br><span class="line">systemctl disable firewalld --now </span><br><span class="line">sed -ri &#x27;s#(SELINUX=)enforcing#1disabled#&#x27; /etc/selinux/config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># keygen </span><br><span class="line">[root@controller ~]# ssh-keygen -t rsa </span><br><span class="line">[root@controller ~]# ssh-copy-id controller</span><br><span class="line">[root@controller ~]# ssh-copy-id compute01</span><br><span class="line">[root@controller ~]# ssh-copy-id compute02</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ntp</span><br><span class="line">dnf install chrony -y </span><br><span class="line">systemctl enable chronyd --now </span><br><span class="line"></span><br><span class="line">[root@controller ~]# vim /etc/chrony.conf</span><br><span class="line"># pool 2.centos.pool.ntp.org iburst</span><br><span class="line">allow 0.0.0.0/0</span><br><span class="line">local stratum 10</span><br><span class="line"></span><br><span class="line">systemctl restart chronyd</span><br><span class="line"></span><br><span class="line">[root@compute01 ~]# vim /etc/chrony.conf</span><br><span class="line">pool controller iburst</span><br><span class="line"></span><br><span class="line">[root@compute01 ~]# systemctl restart chronyd</span><br><span class="line"></span><br><span class="line">[root@compute02 ~]# vim /etc/chrony.conf</span><br><span class="line">pool controller iburst</span><br><span class="line"></span><br><span class="line">[root@compute01 ~]# systemctl restart chronyd</span><br><span class="line"></span><br><span class="line">chronyc -a makestep</span><br><span class="line">chronyc sources</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 开启安装源，在所有节点上执行，centos8可以直接yum install</span><br><span class="line">yum install centos-release-openstack-ussuri.noarch -y</span><br><span class="line">yum config-manager --set-enabled powertools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在所有节点上执行</span><br><span class="line">yum upgrade</span><br><span class="line">reboot</span><br><span class="line">yum install python3-openstackclient</span><br><span class="line">yum install openstack-selinux -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 控制节点安装数据库</span><br><span class="line">yum install mariadb mariadb-server python2-PyMySQL -y</span><br><span class="line">[root@controller my.cnf.d]# vim openstack.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">bind-address = controller</span><br><span class="line">default-storage-engine = innodb</span><br><span class="line">innodb_file_per_table = on</span><br><span class="line">max_connections = 4096</span><br><span class="line">collation-server = utf8_general_ci</span><br><span class="line">character-set-server = utf8</span><br><span class="line"></span><br><span class="line">systemctl enable mariadb --now </span><br><span class="line"></span><br><span class="line">mysql_secure_installation</span><br><span class="line"> 全部为Y。密码此处为redhat</span><br><span class="line"> </span><br><span class="line">systemctl restart mariadb.service </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 控制节点安装消息队列</span><br><span class="line">yum install rabbitmq-server -y</span><br><span class="line">systemctl enable rabbitmq-server.service --now</span><br><span class="line">rabbitmqctl add_user openstack redhat</span><br><span class="line">rabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br><span class="line">tcp6       0      0 :::5672                 :::*                    LISTEN      5373/beam.smp  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 控制节点安装memcache，keystone缓存token</span><br><span class="line">The Identity service authentication mechanism for services uses Memcached to cache tokens.</span><br><span class="line">yum install memcached python3-memcached -y</span><br><span class="line">vim  /etc/sysconfig/memcached </span><br><span class="line">PORT=&quot;11211&quot;</span><br><span class="line">USER=&quot;memcached&quot;</span><br><span class="line">MAXCONN=&quot;1024&quot;</span><br><span class="line">CACHESIZE=&quot;64&quot;</span><br><span class="line">OPTIONS=&quot;-l 127.0.0.1,::1,controller&quot;</span><br><span class="line"></span><br><span class="line">systemctl enable memcached.service --now </span><br><span class="line">tcp        0      0 192.168.13.20:11211     0.0.0.0:*               LISTEN      7961/memcached     </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 控制节点安装etcd</span><br><span class="line">yum install etcd -y</span><br><span class="line">vim /etc/etcd/etcd.conf</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;http://192.168.13.20:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;http://192.168.13.20:2379&quot;</span><br><span class="line">ETCD_NAME=&quot;controller&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;http://192.168.13.20:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;http://192.168.13.20:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;controller=http://192.168.13.20:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster-01&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line"></span><br><span class="line">systemctl enable etcd --now </span><br><span class="line"></span><br><span class="line">tcp        0      0 192.168.13.20:2379      0.0.0.0:*               LISTEN      9441/etcd              </span><br><span class="line">tcp        0      0 192.168.13.20:2380      0.0.0.0:*               LISTEN      9441/etcd  </span><br><span class="line"></span><br><span class="line">https://docs.openstack.org/install-guide/environment-packages-rdo.html</span><br><span class="line">#######环境搭建完毕###### </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 安装keystone https://docs.openstack.org/keystone/ussuri/install/keystone-install-rdo.html</span><br><span class="line">mysql -uroot -predhat</span><br><span class="line">CREATE DATABASE keystone;</span><br><span class="line">GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line"></span><br><span class="line">yum install openstack-keystone httpd python3-mod_wsgi -y</span><br><span class="line"></span><br><span class="line">vim /etc/keystone/keystone.conf</span><br><span class="line">[database]</span><br><span class="line">...</span><br><span class="line">connection = mysql+pymysql://keystone:redhat@controller/keystone</span><br><span class="line">...</span><br><span class="line">[token]</span><br><span class="line">provider = fernet</span><br><span class="line"></span><br><span class="line">su -s /bin/sh -c &quot;keystone-manage db_sync&quot; keystone</span><br><span class="line">keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone</span><br><span class="line">keystone-manage credential_setup --keystone-user keystone --keystone-group keystone</span><br><span class="line"></span><br><span class="line">keystone-manage bootstrap --bootstrap-password redhat \</span><br><span class="line">  --bootstrap-admin-url http://controller:5000/v3/ \</span><br><span class="line">  --bootstrap-internal-url http://controller:5000/v3/ \</span><br><span class="line">  --bootstrap-public-url http://controller:5000/v3/ \</span><br><span class="line">  --bootstrap-region-id RegionOne</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">vim /etc/httpd/conf/httpd.conf</span><br><span class="line">ServerName controller</span><br><span class="line"></span><br><span class="line">ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/</span><br><span class="line"></span><br><span class="line">systemctl enable httpd.service --now </span><br><span class="line"></span><br><span class="line">vim admin-openrc</span><br><span class="line">export OS_USERNAME=admin</span><br><span class="line">export OS_PASSWORD=redhat</span><br><span class="line">export OS_PROJECT_NAME=admin</span><br><span class="line">export OS_USER_DOMAIN_NAME=Default</span><br><span class="line">export OS_PROJECT_DOMAIN_NAME=Default</span><br><span class="line">export OS_AUTH_URL=http://controller:5000/v3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br><span class="line"></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line">openstack domain create --description &quot;An Example Domain&quot; example</span><br><span class="line"></span><br><span class="line">openstack project create --domain default \</span><br><span class="line">  --description &quot;Service Project&quot; service</span><br><span class="line">openstack project create --domain default \</span><br><span class="line">  --description &quot;Demo Project&quot; myproject</span><br><span class="line"> </span><br><span class="line"> openstack user create --domain default \</span><br><span class="line">  --password-prompt myuser</span><br><span class="line">  </span><br><span class="line">openstack role create myrole</span><br><span class="line">openstack role add --project myproject --user myuser myrole</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 安装glance   https://docs.openstack.org/glance/ussuri/install/install-rdo.html#prerequisites</span><br><span class="line">mysql -u root -predhat</span><br><span class="line">CREATE DATABASE glance;</span><br><span class="line">GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;localhost&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;%&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">  </span><br><span class="line">. admin-openrc</span><br><span class="line">openstack user create --domain default --password-prompt glance		# 在openstack中创建用户glance</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">openstack role add --project service --user glance admin</span><br><span class="line"></span><br><span class="line">openstack service create --name glance \</span><br><span class="line">  --description &quot;OpenStack Image&quot; image</span><br><span class="line">  </span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  image public http://controller:9292</span><br><span class="line">  </span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  image internal http://controller:9292</span><br><span class="line">  </span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  image admin http://controller:9292</span><br><span class="line">  </span><br><span class="line"> vim /etc/glance/glance-api.conf</span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://glance:redhat@controller/glance</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri  = http://controller:5000</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = glance</span><br><span class="line">password = redhat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[paste_deploy]</span><br><span class="line">flavor = keystone</span><br><span class="line"></span><br><span class="line">[glance_store]</span><br><span class="line">stores = file,http</span><br><span class="line">default_store = file </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 验证glance</span><br><span class="line">. admin-openrc</span><br><span class="line">wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img</span><br><span class="line"></span><br><span class="line">glance image-create --name &quot;cirros&quot; \</span><br><span class="line">  --file cirros-0.4.0-x86_64-disk.img \</span><br><span class="line">  --disk-format qcow2 --container-format bare \</span><br><span class="line">  --visibility=public</span><br><span class="line">  </span><br><span class="line">glance image-list</span><br><span class="line">+--------------------------------------+--------+</span><br><span class="line">| ID                                   | Name   |</span><br><span class="line">+--------------------------------------+--------+</span><br><span class="line">| e4c7903b-fc16-4d62-b60c-0e5ca211054e | cirros |</span><br><span class="line">+--------------------------------------+--------+</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># 安装placement，在s版之前，placement集成在novaapi中，之后单独分离出来。</span><br><span class="line"># 当用户申请创建云主机时，会向nova api发送请求，NovaAPI会统计所有的compute节点资源剩余情况，决定哪个compute节点执行</span><br><span class="line"># https://docs.openstack.org/placement/ussuri/install/install-rdo.html</span><br><span class="line">mysql -u root -p </span><br><span class="line"> CREATE DATABASE placement;</span><br><span class="line"> GRANT ALL PRIVILEGES ON placement.* TO &#x27;placement&#x27;@&#x27;localhost&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line"> GRANT ALL PRIVILEGES ON placement.* TO &#x27;placement&#x27;@&#x27;%&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">. admin-openrc</span><br><span class="line">openstack user create --domain default --password-prompt placement</span><br><span class="line">openstack role add --project service --user placement admin</span><br><span class="line">openstack service create --name placement --description &quot;Placement API&quot; placement</span><br><span class="line">openstack endpoint create --region RegionOne placement public http://controller:8778</span><br><span class="line">openstack endpoint create --region RegionOne placement internal http://controller:8778</span><br><span class="line">openstack endpoint create --region RegionOne placement admin http://controller:8778</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum install openstack-placement-api</span><br><span class="line">vim /etc/placement/placement.conf</span><br><span class="line">[placement_database]</span><br><span class="line">connection = mysql+pymysql://placement:redhat@controller/placement</span><br><span class="line">[api]</span><br><span class="line">auth_strategy = keystone</span><br><span class="line">[keystone_authtoken]</span><br><span class="line">auth_url = http://controller:5000/v3</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = placement</span><br><span class="line">password = redhat</span><br><span class="line"></span><br><span class="line">su -s /bin/sh -c &quot;placement-manage db sync&quot; placement</span><br><span class="line"></span><br><span class="line">vim /etc/httpd/conf.d/00-placement-api.conf</span><br><span class="line">&lt;VirtualHost *:8778&gt;</span><br><span class="line">...</span><br><span class="line">  &lt;Directory /usr/bin&gt;</span><br><span class="line">    &lt;IfVersion &gt;= 2.4&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/IfVersion&gt;</span><br><span class="line">    &lt;IfVersion &lt; 2.4&gt;</span><br><span class="line">        Order allow,deny</span><br><span class="line">        Allow from all</span><br><span class="line">    &lt;/IfVersion&gt;</span><br><span class="line">  &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">systemctl restart httpd</span><br><span class="line"></span><br><span class="line"># 检查</span><br><span class="line">placement-status upgrade check</span><br><span class="line">pip install osc-placement</span><br><span class="line">openstack --os-placement-api-version 1.2 resource class list --sort-column name</span><br><span class="line">openstack --os-placement-api-version 1.6 trait list --sort-column name</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"># nova</span><br><span class="line"># https://docs.openstack.org/nova/ussuri/install/</span><br><span class="line"># controller node</span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line">CREATE DATABASE nova_api;</span><br><span class="line">CREATE DATABASE nova;</span><br><span class="line">CREATE DATABASE nova_cell0;</span><br><span class="line"></span><br><span class="line">GRANT ALL PRIVILEGES ON nova_api.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">GRANT ALL PRIVILEGES ON nova_api.* TO &#x27;nova&#x27;@&#x27;%&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line"></span><br><span class="line">GRANT ALL PRIVILEGES ON nova.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">GRANT ALL PRIVILEGES ON nova.* TO &#x27;nova&#x27;@&#x27;%&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line"></span><br><span class="line">GRANT ALL PRIVILEGES ON nova_cell0.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">GRANT ALL PRIVILEGES ON nova_cell0.* TO &#x27;nova&#x27;@&#x27;%&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">  </span><br><span class="line">. admin-openrc</span><br><span class="line">openstack user create --domain default --password-prompt nova</span><br><span class="line">openstack role add --project service --user nova admin</span><br><span class="line"></span><br><span class="line">openstack service create --name nova \</span><br><span class="line">  --description &quot;OpenStack Compute&quot; compute</span><br><span class="line">  </span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  compute public http://controller:8774/v2.1</span><br><span class="line">  </span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  compute internal http://controller:8774/v2.1</span><br><span class="line">  </span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  compute admin http://controller:8774/v2.1</span><br><span class="line">  </span><br><span class="line">yum install openstack-nova-api openstack-nova-conductor \</span><br><span class="line">  openstack-nova-novncproxy openstack-nova-scheduler -y</span><br><span class="line">  </span><br><span class="line">vim /etc/nova/nova.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">enabled_apis = osapi_compute,metadata</span><br><span class="line"></span><br><span class="line">[api_database]</span><br><span class="line">connection = mysql+pymysql://nova:redhat@controller/nova_api</span><br><span class="line"></span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://nova:redhat@controller/nova</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">transport_url = rabbit://openstack:redhat@controller:5672/</span><br><span class="line"></span><br><span class="line">[api]</span><br><span class="line">auth_strategy = keystone</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = http://controller:5000/</span><br><span class="line">auth_url = http://controller:5000/</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = nova</span><br><span class="line">password = redhat</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">my_ip = 192.168.13.20</span><br><span class="line"></span><br><span class="line">[vnc]</span><br><span class="line">enabled = true</span><br><span class="line">server_listen = $my_ip</span><br><span class="line">server_proxyclient_address = $my_ip</span><br><span class="line"></span><br><span class="line">[glance]</span><br><span class="line">api_servers = http://controller:9292</span><br><span class="line"></span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lib/nova/tmp</span><br><span class="line"></span><br><span class="line">[placement]</span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">auth_type = password</span><br><span class="line">user_domain_name = Default</span><br><span class="line">auth_url = http://controller:5000/v3</span><br><span class="line">username = placement</span><br><span class="line">password = redhat</span><br><span class="line"></span><br><span class="line">su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova</span><br><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 map_cell0&quot; nova</span><br><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 create_cell --name=cell1 --verbose&quot; nova</span><br><span class="line">su -s /bin/sh -c &quot;nova-manage db sync&quot; nova</span><br><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 list_cells&quot; nova</span><br><span class="line"></span><br><span class="line">systemctl enable \</span><br><span class="line">    openstack-nova-api.service \</span><br><span class="line">    openstack-nova-scheduler.service \</span><br><span class="line">    openstack-nova-conductor.service \</span><br><span class="line">    openstack-nova-novncproxy.service \</span><br><span class="line">    --now</span><br><span class="line">    </span><br><span class="line"># compute node </span><br><span class="line">yum install openstack-nova-compute</span><br><span class="line"></span><br><span class="line"># 不同节点替换my_ip</span><br><span class="line">vim /etc/nova/nova.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">enabled_apis = osapi_compute,metadata</span><br><span class="line">transport_url = rabbit://openstack:redhat@controller</span><br><span class="line">my_ip = 192.168.13.21</span><br><span class="line"></span><br><span class="line">[api]</span><br><span class="line">auth_strategy = keystone</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = http://controller:5000/</span><br><span class="line">auth_url = http://controller:5000/</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = nova</span><br><span class="line">password = redhat</span><br><span class="line"></span><br><span class="line">[vnc]</span><br><span class="line">enabled = true</span><br><span class="line">server_listen = 0.0.0.0</span><br><span class="line">server_proxyclient_address = $my_ip</span><br><span class="line">novncproxy_base_url = http://controller:6080/vnc_auto.html</span><br><span class="line"></span><br><span class="line">[glance]</span><br><span class="line">api_servers = http://controller:9292</span><br><span class="line"></span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lib/nova/tmp</span><br><span class="line"></span><br><span class="line">[placement]</span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">auth_type = password</span><br><span class="line">user_domain_name = Default</span><br><span class="line">auth_url = http://controller:5000/v3</span><br><span class="line">username = placement</span><br><span class="line">password = redhat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">egrep -c &#x27;(vmx|svm)&#x27; /proc/cpuinfo</span><br><span class="line"></span><br><span class="line"># centos stream9 ，2024版本需要</span><br><span class="line">yum install qemu-kvm libvirt libvirt-daemon virt-install virt-manager libvirt-dbus -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl enable libvirtd.service openstack-nova-compute.service --now </span><br><span class="line">chmod 777 -R /usr/lib/python3.9/site-packages/</span><br><span class="line"></span><br><span class="line"># controller node </span><br><span class="line">openstack compute service list --service nova-compute</span><br><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova</span><br><span class="line"></span><br><span class="line">vim /etc/nova/nova.conf</span><br><span class="line">[scheduler]</span><br><span class="line">discover_hosts_in_cells_interval = 300</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 验证</span><br><span class="line">openstack compute service list</span><br><span class="line">openstack catalog list</span><br><span class="line">nova-status upgrade check</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"># neutron</span><br><span class="line"></span><br><span class="line"># controller node 执行</span><br><span class="line">mysql -u root -p</span><br><span class="line">CREATE DATABASE neutron;</span><br><span class="line">GRANT ALL PRIVILEGES ON neutron.* TO &#x27;neutron&#x27;@&#x27;localhost&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">GRANT ALL PRIVILEGES ON neutron.* TO &#x27;neutron&#x27;@&#x27;%&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">  </span><br><span class="line">. admin-openrc</span><br><span class="line">openstack user create --domain default --password-prompt neutron</span><br><span class="line">openstack role add --project service --user neutron admin</span><br><span class="line">openstack service create --name neutron \</span><br><span class="line">  --description &quot;OpenStack Networking&quot; network</span><br><span class="line">  </span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  network public http://controller:9696</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  network internal http://controller:9696</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  network admin http://controller:9696</span><br><span class="line">  </span><br><span class="line">yum install openstack-neutron openstack-neutron-ml2 \</span><br><span class="line">  openstack-neutron-linuxbridge ebtables</span><br><span class="line">  </span><br><span class="line">vim /etc/neutron/neutron.conf</span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://neutron:redhat@controller/neutron</span><br><span class="line">[DEFAULT]</span><br><span class="line">core_plugin = ml2</span><br><span class="line">service_plugins = router</span><br><span class="line">allow_overlapping_ips = true</span><br><span class="line">transport_url = rabbit://openstack:redhat@controller</span><br><span class="line">auth_strategy = keystone</span><br><span class="line">notify_nova_on_port_status_changes = true</span><br><span class="line">notify_nova_on_port_data_changes = true</span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = redhat</span><br><span class="line">[nova]</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_name = service</span><br><span class="line">username = nova</span><br><span class="line">password = redhat</span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lib/neutron/tmp</span><br><span class="line"></span><br><span class="line">vim /etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="line">[ml2]</span><br><span class="line">type_drivers = flat,vlan,vxlan</span><br><span class="line">tenant_network_types = vxlan</span><br><span class="line">mechanism_drivers = linuxbridge,l2population</span><br><span class="line">extension_drivers = port_security</span><br><span class="line">[ml2_type_flat]</span><br><span class="line">flat_networks = provider</span><br><span class="line">[ml2_type_vxlan]</span><br><span class="line">vni_ranges = 1:1000</span><br><span class="line">[securitygroup]    </span><br><span class="line">enable_ipset = true</span><br><span class="line"></span><br><span class="line">vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span><br><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = provider:ens160</span><br><span class="line">[vxlan]</span><br><span class="line">enable_vxlan = true</span><br><span class="line">local_ip = 192.168.13.20</span><br><span class="line">l2_population = true</span><br><span class="line">[securitygroup]</span><br><span class="line">enable_security_group = true</span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br><span class="line"></span><br><span class="line"># 该命令所有节点上执行</span><br><span class="line">yum install bridge-utils -y		</span><br><span class="line">modprobe br_netfilter			</span><br><span class="line">echo br_netfilter &gt; /etc/modules-load.d/br_netfilter.conf			</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">sysctl -a | grep bridge				# 确保下面的为 1</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line"></span><br><span class="line">vim /etc/neutron/l3_agent.ini</span><br><span class="line">[DEFAULT]</span><br><span class="line">interface_driver = linuxbridge</span><br><span class="line"></span><br><span class="line">vim /etc/neutron/dhcp_agent.ini</span><br><span class="line">[DEFAULT]</span><br><span class="line">interface_driver = linuxbridge</span><br><span class="line">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq</span><br><span class="line">enable_isolated_metadata = true</span><br><span class="line"></span><br><span class="line">vim /etc/neutron/metadata_agent.ini </span><br><span class="line">[DEFAULT]</span><br><span class="line">nova_metadata_host = controller</span><br><span class="line">metadata_proxy_shared_secret = redhat</span><br><span class="line"></span><br><span class="line">vim/etc/nova/nova.conf</span><br><span class="line">[neutron]</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = redhat</span><br><span class="line">service_metadata_proxy = true</span><br><span class="line">metadata_proxy_shared_secret = redhat</span><br><span class="line"></span><br><span class="line">ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</span><br><span class="line">su -s /bin/sh -c &quot;neutron-db-manage --config-file /etc/neutron/neutron.conf \</span><br><span class="line">  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head&quot; neutron</span><br><span class="line">  </span><br><span class="line">systemctl restart openstack-nova-api.service</span><br><span class="line">systemctl enable neutron-server.service \</span><br><span class="line">   neutron-linuxbridge-agent.service neutron-dhcp-agent.service \</span><br><span class="line">   neutron-metadata-agent.service \</span><br><span class="line">   --now</span><br><span class="line">   </span><br><span class="line">systemctl enable neutron-l3-agent.service --now </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># compute node</span><br><span class="line">yum install openstack-neutron-linuxbridge ebtables ipset</span><br><span class="line"></span><br><span class="line">vim /etc/neutron/neutron.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">transport_url = rabbit://openstack:redhat@controller</span><br><span class="line">auth_strategy = keystone</span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = redhat</span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lib/neutron/tmp</span><br><span class="line"></span><br><span class="line">vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini </span><br><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = provider:ens160</span><br><span class="line">[vxlan]</span><br><span class="line">enable_vxlan = true</span><br><span class="line">local_ip = 192.168.13.21</span><br><span class="line">l2_population = true</span><br><span class="line">[securitygroup]</span><br><span class="line">enable_security_group = true</span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br><span class="line"></span><br><span class="line">vim  /etc/nova/nova.conf</span><br><span class="line">[neutron]</span><br><span class="line"># ...</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = redhat</span><br><span class="line"></span><br><span class="line">#  openstack 2024 需要配置</span><br><span class="line">mkdir /usr/lib/python3.9/site-packages/instances</span><br><span class="line">chown -R root.nova /usr/lib/python3.9/site-packages/instances</span><br><span class="line"></span><br><span class="line">systemctl restart openstack-nova-compute.service</span><br><span class="line">systemctl enable neutron-linuxbridge-agent.service --now </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 验证</span><br><span class="line">. admin-openrc</span><br><span class="line">[root@controller ~]# openstack network agent list </span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+</span><br><span class="line">| ID                                   | Agent Type         | Host       | Availability Zone | Alive | State | Binary                    |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+</span><br><span class="line">| 1e065961-ca8a-4fef-8d0b-65cb8525108a | Metadata agent     | controller | None              | :-)   | UP    | neutron-metadata-agent    |</span><br><span class="line">| 3acf922b-2984-4d6a-aa2a-ed0ccba26c1c | Linux bridge agent | controller | None              | :-)   | UP    | neutron-linuxbridge-agent |</span><br><span class="line">| 63815950-35ab-4298-8726-bfc416e2fb35 | Linux bridge agent | compute02  | None              | :-)   | UP    | neutron-linuxbridge-agent |</span><br><span class="line">| 9ec3deda-192f-4a52-882f-9a468277beee | L3 agent           | controller | nova              | :-)   | UP    | neutron-l3-agent          |</span><br><span class="line">| d41fbf03-5391-43c9-bba4-02d2fdd959e5 | DHCP agent         | controller | nova              | :-)   | UP    | neutron-dhcp-agent        |</span><br><span class="line">| f4d841d6-ef98-4fca-8548-30975d7a6aff | Linux bridge agent | compute01  | None              | :-)   | UP    | neutron-linuxbridge-agent |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># dashboard</span><br><span class="line">yum install openstack-dashboard</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OPENSTACK_HOST = &quot;controller&quot;</span><br><span class="line">ALLOWED_HOSTS = [&#x27;*&#x27;]</span><br><span class="line">SESSION_ENGINE = &#x27;django.contrib.sessions.backends.cache&#x27;</span><br><span class="line">CACHES = &#123;</span><br><span class="line">    &#x27;default&#x27;: &#123;</span><br><span class="line">         &#x27;BACKEND&#x27;: &#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;,</span><br><span class="line">         &#x27;LOCATION&#x27;: &#x27;controller:11211&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">OPENSTACK_KEYSTONE_URL = &quot;http://%s:5000/v3&quot; % OPENSTACK_HOST</span><br><span class="line">TIME_ZONE = &quot;Asia/Shanghai&quot;</span><br><span class="line">OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True</span><br><span class="line">OPENSTACK_API_VERSIONS = &#123;</span><br><span class="line">    &quot;identity&quot;: 3,</span><br><span class="line">    &quot;image&quot;: 2,</span><br><span class="line">    &quot;volume&quot;: 3,</span><br><span class="line">&#125;</span><br><span class="line">OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = &quot;Default&quot;</span><br><span class="line">OPENSTACK_KEYSTONE_DEFAULT_ROLE = &quot;user&quot;</span><br><span class="line"></span><br><span class="line">vim /etc/httpd/conf.d/openstack-dashboard.conf</span><br><span class="line">WSGIApplicationGroup %&#123;GLOBAL&#125;</span><br><span class="line"></span><br><span class="line">systemctl restart httpd.service memcached.service</span><br><span class="line"></span><br><span class="line">vim /usr/share/openstack-dashboard/openstack_dashboard/defaults.py </span><br><span class="line">WEBROOT = &#x27;/dashboard&#x27;  # from openstack_auth</span><br><span class="line"></span><br><span class="line">vim /usr/share/openstack-dashboard/openstack_dashboard/test/settings.py </span><br><span class="line">WEBROOT = &#x27;/dashboard&#x27;</span><br><span class="line"></span><br><span class="line">systemctl restart httpd.service memcached.service</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMTMuMjAvZGFzaGJvYXJk">http://192.168.13.20/dashboard</span></p>
<p>Default</p>
<p>admin</p>
<p>redhat</p>
<p>机器重启后无法登陆，重启服务 <code>systemctl restart httpd.service memcached.service</code></p>
<h3 id="发放云主机"><a class="markdownIt-Anchor" href="#发放云主机">#</a> 发放云主机</h3>
<p>开启配置后，可以支持多域</p>
<p>OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True</p>
<h4 id="创建镜像"><a class="markdownIt-Anchor" href="#创建镜像">#</a> 创建镜像</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240330230051647.png" alt="image-20240330230051647"></p>
<p>创建虚拟机时，不能比创建镜像时指定的最小磁盘和最小内存小，否则虚拟机会发放失败</p>
<h4 id="创建实例类型"><a class="markdownIt-Anchor" href="#创建实例类型">#</a> 创建实例类型</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240330230640185.png" alt="image-20240330230640185"></p>
<h4 id="创建外部网络"><a class="markdownIt-Anchor" href="#创建外部网络">#</a> 创建外部网络</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240330232923961.png" alt="image-20240330232923961"></p>
<p>一般来说，宿主机会有两块网卡，一块用于管理网络，一块用于 node 之间通信和访问 Internet</p>
<p>只有通过 L3 Agent 才可以访问 Internet，L3Agent 只有 controller 上才有，compute 节点必须通过上图中 ens37 网络到 controller，才可以访问 Internet。此时网络节点可以称 vRouter</p>
<p>此时这种方式叫做集中式路由。每个 compute node 有自己的网络节点的时候称为分布式路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"># 添加一块桥接网卡</span><br><span class="line">nmcli device up ens224</span><br><span class="line">nmcli connection modify ens224 ipv4.address 192.168.1.100/24 ipv4.dns 8.8.8.8 ipv4.gateway 192.168.1.1 ipv4.method manual autoconnect yes</span><br><span class="line">nmcli connection up ens224</span><br><span class="line"></span><br><span class="line"># controller node </span><br><span class="line"># 配置第二块网卡提供业务网络</span><br><span class="line">vim /etc/neutron/plugins/ml2/ml2_conf.ini </span><br><span class="line">[ml2_type_flat]</span><br><span class="line">flat_networks = provider</span><br><span class="line"></span><br><span class="line">vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span><br><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = provider:ens224</span><br><span class="line"></span><br><span class="line">systemctl restart neutron-server.service neutron-linuxbridge-agent.service</span><br><span class="line"></span><br><span class="line"># compute node </span><br><span class="line">vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini </span><br><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = provider:ens224</span><br><span class="line"></span><br><span class="line">systemctl restart neutron-linuxbridge-agent.service </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#######################</span><br><span class="line">ip a </span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:87:28:54 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 192.168.13.20/24 brd 192.168.13.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe87:2854/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: ens224: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:87:28:5e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp19s0</span><br><span class="line">    inet 192.168.1.100/24 brd 192.168.1.255 scope global noprefixroute ens224</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 2409:8a1e:3b41:f0f0:6dd3:d917:4cba:7b6/64 scope global dynamic noprefixroute </span><br><span class="line">       valid_lft 212884sec preferred_lft 126484sec</span><br><span class="line">    inet6 fe80::fe05:4ac6:73b8:b7d7/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">此时ens224是业务网络，ens160是管理网络</span><br><span class="line">ens224也是上行链路</span><br><span class="line"></span><br><span class="line">[root@controller ~]# brctl show </span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">virbr0          8000.5254003bb141       yes</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">供应商网络类型</span><br><span class="line">local 只有本机能访问</span><br><span class="line">vlan 带标签的网络</span><br><span class="line">flat 不带标签的网络</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331135306896.png" alt="image-20240331135306896"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331135322478.png" alt="image-20240331135322478"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331135657000.png" alt="image-20240331135657000"></p>
<h4 id="创建用户和租户"><a class="markdownIt-Anchor" href="#创建用户和租户">#</a> 创建用户和租户</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331140213319.png" alt="image-20240331140213319"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331140310038.png" alt="image-20240331140310038"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331140854102.png" alt="image-20240331140854102"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331140953477.png" alt="image-20240331140953477"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331142451867.png" alt="image-20240331142451867"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331142502501.png" alt="image-20240331142502501"></p>
<h4 id="创建网络过程"><a class="markdownIt-Anchor" href="#创建网络过程">#</a> 创建网络过程</h4>
<p>管理员操作：创建网络 -&gt; 创建路由 禁用 dhcp</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331152924281.png" alt="image-20240331152924281"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331152951577.png" alt="image-20240331152951577"></p>
<p>切换至租户：创建网络，添加路由器接口</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331153033771.png" alt="image-20240331153033771"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240404165722581.png" alt="image-20240404165722581"></p>
<p>最后的网络拓扑如下</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331152751856.png" alt="image-20240331152751856"></p>
<p>注意：管理员既有管理权限，也有项目权限。用户只有项目权限，所以创建路由不在一个地方</p>
<h4 id="创建安全组"><a class="markdownIt-Anchor" href="#创建安全组">#</a> 创建安全组</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331153439809.png" alt="image-20240331153439809"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331153452616.png" alt="image-20240331153452616"></p>
<h4 id="创建浮动ip"><a class="markdownIt-Anchor" href="#创建浮动ip">#</a> 创建浮动 ip</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331153620660.png" alt="image-20240331153620660"></p>
<h4 id="创建秘钥对"><a class="markdownIt-Anchor" href="#创建秘钥对">#</a> 创建秘钥对</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331154621290.png" alt="image-20240331154621290"></p>
<h4 id="创建实例"><a class="markdownIt-Anchor" href="#创建实例">#</a> 创建实例</h4>
<h4 id="绑定浮动ip"><a class="markdownIt-Anchor" href="#绑定浮动ip">#</a> 绑定浮动 IP</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240331163643142.png" alt="image-20240331163643142"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 配置更新，my_ip 需要是controller的ip，不然会导致虚拟机无法调度。novncproxy_base_url需要是ip，因为本机没有配置hosts</span><br><span class="line">vim /etc/nova/nova.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">enabled_apis = osapi_compute,metadata</span><br><span class="line">transport_url = rabbit://openstack:redhat@controller</span><br><span class="line">my_ip = 192.168.13.20</span><br><span class="line">[vnc]</span><br><span class="line">enabled = true</span><br><span class="line">server_listen = 0.0.0.0</span><br><span class="line">server_proxyclient_address = $my_ip</span><br><span class="line">novncproxy_base_url = http://192.168.13.20:6080/vnc_auto.html</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果没有 snat，需要购买 nat 网关，否则无法访问外网</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># 报错解决</span><br><span class="line">Failed to allocate the network(s), not rescheduling</span><br><span class="line">https://blog.51cto.com/royfans/5612693</span><br><span class="line">在nova的计算节点修改 /etc/nova/nova.conf</span><br><span class="line"></span><br><span class="line"># Determine if instance should boot or fail on VIF plugging timeout. For more</span><br><span class="line"># information, refer to the documentation. (boolean value)</span><br><span class="line">vif_plugging_is_fatal=false</span><br><span class="line"></span><br><span class="line"># Timeout for Neutron VIF plugging event message arrival. For more information,</span><br><span class="line"># refer to the documentation. (integer value)</span><br><span class="line"># Minimum value: 0</span><br><span class="line">vif_plugging_timeout=0</span><br><span class="line"></span><br><span class="line">systemctl restart openstack-nova-compute.service </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Unknown auth type: None</span><br><span class="line">https://blog.51cto.com/molewan/1906366</span><br><span class="line">所有节点都编辑neutron.conf</span><br><span class="line">vim /etc/neutron/neutron.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">core_plugin = ml2</span><br><span class="line">service_plugins = router</span><br><span class="line">allow_overlapping_ips = true</span><br><span class="line">transport_url = rabbit://openstack:redhat@controller</span><br><span class="line">auth_strategy = keystone</span><br><span class="line">notify_nova_on_port_status_changes = true</span><br><span class="line">notify_nova_on_port_data_changes = true</span><br><span class="line">rpc_backend = rabbit</span><br><span class="line"></span><br><span class="line">controller重启</span><br><span class="line">systemctl restart neutron-server.service </span><br><span class="line">compute重启</span><br><span class="line">systemctl restart neutron-linuxbridge-agent.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Load key &quot;C:\\key000.pem&quot;: bad permissions</span><br><span class="line">https://blog.csdn.net/weixin_37989267/article/details/126270640</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 测试</span><br><span class="line">ssh -i c:\key000.pem centos@192.168.1.230</span><br><span class="line"></span><br><span class="line">[centos@111 ~]$ ping www.baidu.com</span><br><span class="line">PING www.a.shifen.com (36.155.132.76) 56(84) bytes of data.</span><br><span class="line">64 bytes from 36.155.132.76 (36.155.132.76): icmp_seq=1 ttl=52 time=12.3 ms</span><br><span class="line">64 bytes from 36.155.132.76 (36.155.132.76): icmp_seq=2 ttl=52 time=12.8 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[centos@111 ~]$ ping 192.168.1.1</span><br><span class="line">PING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.1: icmp_seq=1 ttl=63 time=0.963 ms</span><br><span class="line">64 bytes from 192.168.1.1: icmp_seq=2 ttl=63 time=2.33 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[centos@111 ~]$ ping 192.168.100.254</span><br><span class="line">PING 192.168.100.254 (192.168.100.254) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.100.254: icmp_seq=1 ttl=64 time=0.848 ms</span><br><span class="line">64 bytes from 192.168.100.254: icmp_seq=2 ttl=64 time=1.16 ms</span><br></pre></td></tr></table></figure>
<h3 id="命令行管理openstack"><a class="markdownIt-Anchor" href="#命令行管理openstack">#</a> 命令行管理 OpenStack</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"># 创建不同用户的环境变量</span><br><span class="line"></span><br><span class="line">vim user2-openrc</span><br><span class="line">export OS_USERNAME=user2</span><br><span class="line">export OS_PASSWORD=redhat</span><br><span class="line">export OS_PROJECT_NAME=edu</span><br><span class="line">export OS_USER_DOMAIN_NAME=Default</span><br><span class="line">export OS_PROJECT_DOMAIN_NAME=Default</span><br><span class="line">export OS_AUTH_URL=http://controller:5000/v3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br><span class="line">export PS1=&#x27;[\u@\h \W user2]#&#x27;</span><br><span class="line"></span><br><span class="line">[root@controller ~ user2]#source  user2-openrc </span><br><span class="line">[root@controller ~ user2]#openstack server list </span><br><span class="line">+--------------------------------------+------+--------+-------------------------------------+----------------+-----------+</span><br><span class="line">| ID                                   | Name | Status | Networks                            | Image          | Flavor    |</span><br><span class="line">+--------------------------------------+------+--------+-------------------------------------+----------------+-----------+</span><br><span class="line">| b389755c-c00a-494c-8df1-9fec65a2cadc | 111  | ACTIVE | VPC01=192.168.100.27, 192.168.1.230 | centos7-qcows2 | t.large.7 |</span><br><span class="line">+--------------------------------------+------+--------+-------------------------------------+----------------+-----------+</span><br><span class="line"></span><br><span class="line">[root@controller ~ user2]#source  admin-openrc </span><br><span class="line">[root@controller ~]#openstack server list --all</span><br><span class="line">+--------------------------------------+------+--------+-------------------------------------+----------------+-----------+</span><br><span class="line">| ID                                   | Name | Status | Networks                            | Image          | Flavor    |</span><br><span class="line">+--------------------------------------+------+--------+-------------------------------------+----------------+-----------+</span><br><span class="line">| b389755c-c00a-494c-8df1-9fec65a2cadc | 111  | ACTIVE | VPC01=192.168.100.27, 192.168.1.230 | centos7-qcows2 | t.large.7 |</span><br><span class="line">+--------------------------------------+------+--------+-------------------------------------+----------------+-----------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 列出云主机</span><br><span class="line">nova list </span><br><span class="line">openstack server list </span><br><span class="line"></span><br><span class="line"># 删除云主机</span><br><span class="line">openstack server delete 111</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 列出密钥对</span><br><span class="line">[root@controller ~ user2]#openstack keypair list </span><br><span class="line">+--------+-------------------------------------------------+</span><br><span class="line">| Name   | Fingerprint                                     |</span><br><span class="line">+--------+-------------------------------------------------+</span><br><span class="line">| key000 | 4b:5b:72:fa:ef:14:15:d4:ef:d3:3e:c9:70:9c:7c:8b |</span><br><span class="line">+--------+-------------------------------------------------+</span><br><span class="line">openstack keypair delete key000</span><br><span class="line"></span><br><span class="line"># 列出安全组</span><br><span class="line">[root@controller ~ user2]#openstack security group list </span><br><span class="line">+--------------------------------------+---------+------------------------+----------------------------------+------+</span><br><span class="line">| ID                                   | Name    | Description            | Project                          | Tags |</span><br><span class="line">+--------------------------------------+---------+------------------------+----------------------------------+------+</span><br><span class="line">| 46131584-5aa3-4ed5-b98a-555b0d0b361f | default | Default security group | e087871141144d04809921dc4695c91a | []   |</span><br><span class="line">| c042b0bc-e7c0-460a-9666-09ebe0b14871 | sec0    |                        | e087871141144d04809921dc4695c91a | []   |</span><br><span class="line">+--------------------------------------+---------+------------------------+----------------------------------+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 列出浮动IP</span><br><span class="line">[root@controller ~ user2]#openstack floating ip list </span><br><span class="line">+--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+</span><br><span class="line">| ID                                   | Floating IP Address | Fixed IP Address | Port                                 | Floating Network                     | Project                          |</span><br><span class="line">+--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+</span><br><span class="line">| 5e0d6da9-4d2e-4958-9772-0fea529062c4 | 192.168.1.226       | None             | None                                 | 4c8c74c7-8764-45c3-a7be-4b4de94aca42 | e087871141144d04809921dc4695c91a |</span><br><span class="line">| 94ebf368-704b-4b68-8ea0-bf054cc356c0 | 192.168.1.230       | 192.168.100.27   | 80555d60-734e-404b-83a1-e7a002e8a019 | 4c8c74c7-8764-45c3-a7be-4b4de94aca42 | e087871141144d04809921dc4695c91a |</span><br><span class="line">+--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 列出路由器</span><br><span class="line">[root@controller ~ user2]#openstack route list </span><br><span class="line">+--------------------------------------+---------+--------+-------+----------------------------------+</span><br><span class="line">| ID                                   | Name    | Status | State | Project                          |</span><br><span class="line">+--------------------------------------+---------+--------+-------+----------------------------------+</span><br><span class="line">| e4867095-b421-4cf8-8f6d-e461fb6bc005 | router0 | ACTIVE | UP    | e087871141144d04809921dc4695c91a |</span><br><span class="line">+--------------------------------------+---------+--------+-------+----------------------------------+</span><br><span class="line"></span><br><span class="line"># 列出子网</span><br><span class="line">[root@controller ~ user2]#openstack subnet list </span><br><span class="line">+--------------------------------------+---------------+--------------------------------------+------------------+</span><br><span class="line">| ID                                   | Name          | Network                              | Subnet           |</span><br><span class="line">+--------------------------------------+---------------+--------------------------------------+------------------+</span><br><span class="line">| 0bfeeedd-40b8-4604-bd29-c64537e54095 | publicsubnet1 | 4c8c74c7-8764-45c3-a7be-4b4de94aca42 | 192.168.1.0/24   |</span><br><span class="line">| f601029d-74bf-4ccc-a03a-a2d42731a2ae | subnet01      | 1630bf29-e5d9-41e7-971b-32f84e1cc8cb | 192.168.100.0/24 |</span><br><span class="line">+--------------------------------------+---------------+--------------------------------------+------------------+</span><br><span class="line"></span><br><span class="line">[root@controller ~ user2]#source admin-openrc </span><br><span class="line">[root@controller ~]#openstack project list </span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| ID                               | Name      |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| 1845901c8800478b81b1e80de5148cf3 | admin     |</span><br><span class="line">| 49bda9ea06794ea180ab0d45e714ac83 | myproject |</span><br><span class="line">| 955a68e6247048d3a9a7d99a0e6fc895 | service   |</span><br><span class="line">| e087871141144d04809921dc4695c91a | edu       |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line"></span><br><span class="line">[root@controller ~]#openstack user list </span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| ID                               | Name      |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| 7b028a214e104565b90648e521c9a490 | admin     |</span><br><span class="line">| ea4d56a09b484ccc81a363b95064b4d0 | glance    |</span><br><span class="line">| 262dea2a3392437d9ef45e534360049e | myuser    |</span><br><span class="line">| 077dc3eac993404586105cf3c88cfe0b | placement |</span><br><span class="line">| 8de7eefc14074d4a857ad184aa1f02ba | nova      |</span><br><span class="line">| 6f8e00c5f08b460c97bc30bbc4377531 | neutron   |</span><br><span class="line">| 8d86d72b27d74bf18b5a36be3fc6cb40 | user2     |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@controller ~]# openstack flavor list </span><br><span class="line">+--------------------------------------+-----------+------+------+-----------+-------+-----------+</span><br><span class="line">| ID                                   | Name      |  RAM | Disk | Ephemeral | VCPUs | Is Public |</span><br><span class="line">+--------------------------------------+-----------+------+------+-----------+-------+-----------+</span><br><span class="line">| 2d14e3c1-42e7-4f24-aeb6-79560d8effdb | t.small.1 |  512 |   10 |         0 |     1 | True      |</span><br><span class="line">| 3917bde7-c655-4892-a1e2-2a1af2be58c8 | t.large.7 | 1024 |   20 |         0 |     2 | True      |</span><br><span class="line">+--------------------------------------+-----------+------+------+-----------+-------+-----------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@controller ~]# openstack image list </span><br><span class="line">+--------------------------------------+----------------+--------+</span><br><span class="line">| ID                                   | Name           | Status |</span><br><span class="line">+--------------------------------------+----------------+--------+</span><br><span class="line">| 30bddbe2-25d1-4b87-86a2-6eaf5d03f9d7 | centos7-qcows2 | active |</span><br><span class="line">| e4c7903b-fc16-4d62-b60c-0e5ca211054e | cirros         | active |</span><br><span class="line">+--------------------------------------+----------------+--------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="查看日志信息"><a class="markdownIt-Anchor" href="#查看日志信息">#</a> 查看日志信息</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ca /var/log/nova</span><br><span class="line">nova-api.log  nova-conductor.log  nova-manage.log  nova-novncproxy.log  nova-scheduler.log</span><br><span class="line"></span><br><span class="line">[root@controller nova]# cd ../neutron/</span><br><span class="line">[root@controller neutron]# ls </span><br><span class="line">dhcp-agent.log  l3-agent.log  linuxbridge-agent.log  metadata-agent.log  server.log</span><br><span class="line"></span><br><span class="line">如果想要更详细日志，需要开启debug级别日志</span><br><span class="line"></span><br><span class="line"># 每个节点修改</span><br><span class="line">vim nova.conf</span><br><span class="line">debug=true</span><br></pre></td></tr></table></figure>
<p>云主机在本地存储时，使用本地磁盘空间位置</p>
<p>/var/lib/nova/instance</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@compute01 instances]# ls</span><br><span class="line">431b7e00-6d33-48f6-9b2b-2241410bddea  _base  compute_nodes  locks</span><br><span class="line">[root@compute01 instances]# cd 431b7e00-6d33-48f6-9b2b-2241410bddea/</span><br><span class="line">[root@compute01 431b7e00-6d33-48f6-9b2b-2241410bddea]# ls </span><br><span class="line">console.log  disk  disk.info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_base 是基础盘</span><br><span class="line">xxx-xxx-xxx-xxx-xxx 是差分盘</span><br></pre></td></tr></table></figure>
<p>开源 openstack 默认使用的是本地硬盘</p>
<h3 id="cinder"><a class="markdownIt-Anchor" href="#cinder">#</a> cinder</h3>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240404144243112.png" alt="image-20240404144243112" style="zoom:50%;" /> 
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240404144425508.png" alt="image-20240404144425508" style="zoom:50%;" /> 
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240404145645486.png" alt="image-20240404145645486" style="zoom:50%;" /> 
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240404145940122.png" alt="image-20240404145940122" style="zoom:50%;" /> 
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"># 安装cinder</span><br><span class="line"># controller node </span><br><span class="line">mysql -u root -p</span><br><span class="line">CREATE DATABASE cinder;</span><br><span class="line">GRANT ALL PRIVILEGES ON cinder.* TO &#x27;cinder&#x27;@&#x27;localhost&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">GRANT ALL PRIVILEGES ON cinder.* TO &#x27;cinder&#x27;@&#x27;%&#x27; \</span><br><span class="line">  IDENTIFIED BY &#x27;redhat&#x27;;</span><br><span class="line">  </span><br><span class="line">openstack user create --domain default --password-prompt cinder</span><br><span class="line"></span><br><span class="line">openstack role add --project service --user cinder admin</span><br><span class="line"></span><br><span class="line">openstack service create --name cinderv2 \</span><br><span class="line">  --description &quot;OpenStack Block Storage&quot; volumev2</span><br><span class="line">openstack service create --name cinderv3 \</span><br><span class="line">  --description &quot;OpenStack Block Storage&quot; volumev3</span><br><span class="line">  </span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev2 public http://controller:8776/v2/%\(project_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev2 internal http://controller:8776/v2/%\(project_id\)s </span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev2 admin http://controller:8776/v2/%\(project_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev3 public http://controller:8776/v3/%\(project_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev3 internal http://controller:8776/v3/%\(project_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev3 admin http://controller:8776/v3/%\(project_id\)s</span><br><span class="line">  </span><br><span class="line">yum install openstack-cinder -y</span><br><span class="line"></span><br><span class="line">vim  /etc/cinder/cinder.conf </span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://cinder:redhat@controller/cinder</span><br><span class="line">[DEFAULT]</span><br><span class="line">transport_url = rabbit://openstack:redhat@controller</span><br><span class="line">auth_strategy = keystone</span><br><span class="line">my_ip = 192.168.1.20</span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">project_name = service</span><br><span class="line">username = cinder</span><br><span class="line">password = redhat</span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /var/lib/cinder/tmp</span><br><span class="line"></span><br><span class="line">su -s /bin/sh -c &quot;cinder-manage db sync&quot; cinder</span><br><span class="line"></span><br><span class="line">vim /etc/nova/nova.conf</span><br><span class="line">[cinder]</span><br><span class="line">os_region_name = RegionOne</span><br><span class="line"></span><br><span class="line">systemctl restart openstack-nova-api.service</span><br><span class="line">systemctl enable openstack-cinder-api.service openstack-cinder-scheduler.service --now</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># storage node </span><br><span class="line">此处复用controller node ,在controller上增加一块磁盘</span><br><span class="line">yum install lvm2 device-mapper-persistent-data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@controller ~]# lsblk </span><br><span class="line">NAME        MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sr0          11:0    1   1G  0 rom  </span><br><span class="line">nvme0n1     259:0    0  40G  0 disk </span><br><span class="line">└─nvme0n1p1 259:1    0  40G  0 part /</span><br><span class="line">nvme0n2     259:2    0  80G  0 disk </span><br><span class="line"></span><br><span class="line">pvcreate /dev/nvme0n2</span><br><span class="line">vgcreate cinder-volumes /dev/nvme0n2</span><br><span class="line"></span><br><span class="line">yum install openstack-cinder targetcli python3-keystone -y</span><br><span class="line"></span><br><span class="line">vim /etc/cinder/cinder.conf</span><br><span class="line">[lvm]</span><br><span class="line">volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver</span><br><span class="line">volume_group = cinder-volumes</span><br><span class="line">target_protocol = iscsi</span><br><span class="line">target_helper = lioadm</span><br><span class="line">[DEFAULT]</span><br><span class="line">enabled_backends = lvm</span><br><span class="line">glance_api_servers = http://controller:9292</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl enable openstack-cinder-volume.service target.service --now</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 校验</span><br><span class="line">[root@controller ~]# . admin-openrc </span><br><span class="line">[root@controller ~]# openstack volume service list</span><br><span class="line">+------------------+----------------+------+---------+-------+----------------------------+</span><br><span class="line">| Binary           | Host           | Zone | Status  | State | Updated At                 |</span><br><span class="line">+------------------+----------------+------+---------+-------+----------------------------+</span><br><span class="line">| cinder-scheduler | controller     | nova | enabled | up    | 2024-04-04T09:35:37.000000 |</span><br><span class="line">| cinder-volume    | controller@lvm | nova | enabled | up    | 2024-04-04T09:35:46.000000 |</span><br><span class="line">+------------------+----------------+------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240404173920622.png" alt="image-20240404173920622" style="zoom:50%;" /> 
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@controller ~]# vgdisplay  -v cinder-volumes</span><br><span class="line">   </span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/cinder-volumes/volume-84b2b73b-bfad-4bfa-97e7-fc6be4eb10a9</span><br><span class="line">  LV Name                volume-84b2b73b-bfad-4bfa-97e7-fc6be4eb10a9</span><br><span class="line">  VG Name                cinder-volumes</span><br><span class="line">  LV UUID                Q2qgz8-UJdJ-QlWd-mLo9-N3CW-WP3P-oMqRXN</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time controller, 2024-04-04 17:41:24 +0800</span><br><span class="line">  LV Pool name           cinder-volumes-pool</span><br><span class="line">  LV Status              available</span><br><span class="line">  # open                 0</span><br><span class="line">  LV Size                2.00 GiB</span><br><span class="line">  Mapped size            0.00%</span><br><span class="line">  Current LE             512</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:4</span><br></pre></td></tr></table></figure>
<p>cinder 只用于做存储管理，数据写盘的时候不会经过 cinder</p>
<p>硬盘挂载给云主机的时候是 nova 操作</p>
<p>硬盘附加给云主机的时候，会挂载到云主机所在的宿主机，通过 kvm 映射给云主机</p>
<p>nova 挂载的时候向 cinder-api 请求卷信息</p>
<p>阵列侧添加主机和 lun 的映射</p>
<p>主机侧扫描 scsi 总线</p>
<p>多路径生成虚拟磁盘</p>
<p>Nova 调用 libvirt 接口将磁盘添加到 xml</p>
<p>experiment： use glusterfs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 自己的ip不用probe，自己的ip是192.168.9.77</span><br><span class="line">gluster peer probe 192.168.9.88</span><br><span class="line"></span><br><span class="line">gluster peer status </span><br><span class="line"></span><br><span class="line">gluster volume create aaa replica 2 192.168.9.77:/volume/node1 192.168.9.88:/volume/node2</span><br><span class="line"></span><br><span class="line">gluster volume start aaa</span><br><span class="line"></span><br><span class="line">gluster volume info aaa</span><br><span class="line"></span><br><span class="line"># controller node测试。 fuse 用户空间提供 ，不在内核空间</span><br><span class="line">yum install gluster-fuse</span><br><span class="line"></span><br><span class="line">vim /etcd/cinder/cinder.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">enabled_backends = glusterfs123</span><br><span class="line">[glusterfs123]</span><br><span class="line">volume_driver = cinder.volume.drivers.glusterfs.GlusterfsDriver</span><br><span class="line">gluster_shares_config = /etc/cinder/haha</span><br><span class="line">volume_backend_name = rhs</span><br><span class="line"></span><br><span class="line">vim /etc/cinder/haha</span><br><span class="line">192.168.9.77:/firstvol</span><br><span class="line"></span><br><span class="line">systemctl restart openstack-cinder-api.service </span><br><span class="line"></span><br><span class="line">. admin-openrc</span><br><span class="line">cinder tpye-create glusterfs</span><br><span class="line">cinder tpye-key glusterfs set volume_backend_name=rhs</span><br><span class="line"></span><br><span class="line"># compute </span><br><span class="line">yum install gluster-fuse -y</span><br><span class="line"></span><br><span class="line"># horizon 上创建glustefs存储，attach 到云主机上</span><br><span class="line">cinder create --display-name aaa</span><br><span class="line">nova volume-attache server1 volume disk1 </span><br></pre></td></tr></table></figure>
<h3 id="keystone"><a class="markdownIt-Anchor" href="#keystone">#</a> keystone</h3>
<blockquote>
<p>Domain: 域，keystone 中资源 (project、user、group) 的持有：者</p>
<p>Project: 租户，其他组件中资源 (虚拟机、镜像等) 的持有者</p>
<p>User: 用户，云系统的使用者</p>
<p>Group: 用户组，可以把多个用户作为一个整体进行角色管理</p>
<p>Role: 角色，基于角色进行访问控制</p>
<p>Trust: 委托，把自己拥有的角色临时授权给别人</p>
<p>Service: 服务，一组相关功能的集合，比如计算服务、网络服务、镜像服务、存储服务等</p>
<p>Endpoint: 必须和一个服务关联，代表这个服务的访问地址，一般一个服务需要提供三种类型的访问地址:public、internal、adrmin</p>
<p>Region: 区域，在 keystone 里基本代表一个数据中心</p>
<p>Policy: 访问控制策略，定义接口访问控制规则</p>
<p>Assignment: 一个 (actor, target, role) 三元组叫一个 assignment,actor 包括 user、group,target 包括 domain、project。每个 assignment 代表一次赋权操作</p>
<p>Token: 令牌，用户访问服务的凭证，代表着用户的账户信息，一般需要包含 user 信息、scope 信息 (project、domain 或者 trust)、1role 信息。分为 PKI,UUID,PKIZ,Fernet 几种类型。</p>
</blockquote>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240404232439884.png" alt="image-20240404232439884"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack user create user2</span><br><span class="line">openstack user set --password-prompt user2</span><br><span class="line">openstack project create Huawei</span><br><span class="line">openstack role add --user user2 --project huawei admin</span><br></pre></td></tr></table></figure>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240405141643113.png" alt="image-20240405141643113" style="zoom:50%;" /> 
<p>用户从 keystone 申请 token</p>
<p>用户使用 token 访问服务</p>
<p>被访问组件验证 token</p>
<p>用户得到返回消息</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240518184912812.png" alt="image-20240518184912812"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openstack-dashboard/</span><br><span class="line">cinder_policy.json    keystone_policy.json  neutron_policy.json   nova_policy.json      </span><br><span class="line">glance_policy.json    local_settings        nova_policy.d/       </span><br><span class="line"></span><br><span class="line">cp glance_policy.json /etc/glance/policy.json </span><br><span class="line">chown </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dashborad 下的json 是模板文件，需要复制到对应的配置目录下修改并重启服务生效</span><br><span class="line"></span><br><span class="line">上传镜像的时候，默认不能上传为公有镜像，需要修改policy.json</span><br><span class="line"></span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>权限不是由 ksysone 决定的，而是服务本身决定的（policy.json）。keystone 只做身份验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@controller openstack-dashboard]<span class="comment"># ll /etc/openstack-dashboard/</span></span><br><span class="line">total 432</span><br><span class="line">-rw-r----- 1 root apache  77821 Mar 18 15:47 cinder_policy.yaml</span><br><span class="line">drwxr-xr-x 2 root root     4096 May 16 16:38 default_policies</span><br><span class="line">-rw-r----- 1 root apache  21507 Mar 18 15:47 glance_policy.yaml</span><br><span class="line">-rw-r----- 1 root apache  95071 Mar 18 15:47 keystone_policy.yaml</span><br><span class="line">-rw-r----- 1 root apache  12009 May 16 16:38 local_settings</span><br><span class="line">-rw-r----- 1 root apache 111993 Mar 18 15:47 neutron_policy.yaml</span><br><span class="line">drwxr-xr-x 2 root root     4096 May 16 16:38 nova_policy.d</span><br><span class="line">-rw-r----- 1 root apache 104596 Mar 18 15:47 nova_policy.yaml</span><br></pre></td></tr></table></figure>
<p>角色本身没有意义，需要授权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim policy.json</span><br><span class="line"><span class="comment"># Publicize given image</span></span><br><span class="line"><span class="comment"># PATCH  /v2/images/&#123;image_id&#125;</span></span><br><span class="line"><span class="comment"># Intended scope(s): project</span></span><br><span class="line"><span class="comment">#&quot;publicize_image&quot;: &quot;rule:context_is_admin&quot;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240518184942515.png" alt="image-20240518184942515"></p>
<h3 id="glance"><a class="markdownIt-Anchor" href="#glance">#</a> glance</h3>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240406183941236.png" alt="image-20240406183941236" style="zoom:50%;" /> 
<p>写操作会通过 glance-registry，读操作可以直接去数据库中查</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240406185433747.png" alt="image-20240406185433747" style="zoom:50%;" /> 
<p>glance 使用 swift</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">default_store = swift</span><br><span class="line">stores = file,http,swift</span><br><span class="line">swift_store_auth_version = 2</span><br><span class="line">swift_store_auth_address = &lt;None&gt;             # keystone address + port + version</span><br><span class="line">swift_store_user = edu:user1                        # 用户需要有上传swift权限</span><br><span class="line">swift_store_key = redhat</span><br><span class="line">swift_store_container = glance</span><br><span class="line">swift_store_create_container_on_put = True</span><br><span class="line">swift_store_large_object_size = 5120</span><br><span class="line"></span><br><span class="line">swift list</span><br><span class="line">swift list hahah</span><br><span class="line">swift download </span><br><span class="line">swift upload</span><br><span class="line">swift post</span><br></pre></td></tr></table></figure>
<h4 id="制作镜像"><a class="markdownIt-Anchor" href="#制作镜像">#</a> 制作镜像</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">安装kvm</span><br><span class="line"></span><br><span class="line">在kvm中安装需要的虚拟机</span><br><span class="line"></span><br><span class="line">创建虚拟机磁盘</span><br><span class="line">qemu-img create -f qcow2 /root/qq.qcow2 10G -o preallocation=metadata</span><br><span class="line"></span><br><span class="line">最小化安装</span><br><span class="line"></span><br><span class="line">安装cloud-init</span><br><span class="line">yum install https://archives.fedoraproject.org/pub/epel/8/Everything/x86_64/Packages/e/epel-release-8-19.el8.noarch.rpm</span><br><span class="line">yum install cloud-init -y</span><br><span class="line"></span><br><span class="line">systemctl enable cloud-init-local.service cloud-init.service cloud-config.service cloud-final.service</span><br><span class="line"></span><br><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-ens160 </span><br><span class="line">获取方式dhcp</span><br><span class="line">删除uuid</span><br><span class="line"></span><br><span class="line">vim /etc/cloud/cloud.cfg</span><br><span class="line"></span><br><span class="line">https://support.huaweicloud.com/intl/zh-cn/bestpractice-ims/ims_bp_0024.html</span><br><span class="line"></span><br><span class="line">关闭开启的实例</span><br><span class="line"></span><br><span class="line">压缩虚拟机镜像,在宿主机上执行</span><br><span class="line">qemu-img convert -c -O qcow2 /root/qq.qcow2 /tmp/ww.qcow2</span><br></pre></td></tr></table></figure>
<p>注入</p>
<p>systemctl status neutron-metadata-agent.service<br>
systemctl status openstack-nova-metadata-api.service</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLjUxY3RvLmNvbS9seWFuaG9uZy8xOTI0Mjcx">https://blog.51cto.com/lyanhong/1924271</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2N1aWJpbjE5OTEvYXJ0aWNsZS9kZXRhaWxzLzEyNDE0MDM0Ng==">https://blog.csdn.net/cuibin1991/article/details/124140346</span></p>
<p><span class="exturl" data-url="aHR0cDovL2Nsb3VkLmNlbnRvcy5vcmcvY2VudG9zLzcvaW1hZ2VzLw==">http://cloud.centos.org/centos/7/images/</span></p>
<h3 id="升级搭建dalmatian版-openstack"><a class="markdownIt-Anchor" href="#升级搭建dalmatian版-openstack">#</a> 升级，搭建 [Dalmatian] 版 openstack</h3>
<p>注意：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">大部分步骤按照官网来即可，但是neutron按照官网存在问题，这里按照u版配置neutron的方式配置，verify正常</span><br><span class="line"></span><br><span class="line">注意nova.conf 中配置的keystone的端口是 80 还是 5000，协议是http还是https</span><br><span class="line">否则会导致无法登陆或者无法发放主机</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https://blog.csdn.net/qq_41158292/article/details/135750315</span><br></pre></td></tr></table></figure>
<h3 id="创建网络"><a class="markdownIt-Anchor" href="#创建网络">#</a> 创建网络</h3>
<p>1. 创建租户 edu，租户内存在用户 user2</p>
<p>2. 在 admin 空间内，管理员视图下，创建网络 public。这是共享的，外部网络，关闭 dchp</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240408232800085.png" alt="image-20240408232800085"></p>
<p>3. 在 admin 空间内，管理员视图下，创建路由，项目为 edu</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240408232905803.png" alt="image-20240408232905803"></p>
<p>4. 切换至 user2，在项目视图下，创建网络 vpc01，不共享，子网随意写，开启 dhcp</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240408233004196.png" alt="image-20240408233004196"></p>
<p>5，user2，在项目视图下，添加路由的 接口</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240408233049592.png" alt="image-20240408233049592"></p>
<p>6. 最终网络拓扑图如下</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240408233205646.png" alt="image-20240408233205646" style="zoom:50%;" /> 
<h3 id="nova"><a class="markdownIt-Anchor" href="#nova">#</a> nova</h3>
<p>虚拟机生命周期管理</p>
<p>其他计算资源生命周期管理</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240518184329485.png" alt="image-20240518184329485"></p>
<p>主机发放完之后可以把镜像删掉，因为系统盘是通过镜像复制的</p>
<p>openstack 中实例快照是作为镜像使用的，可以直接作为云主机镜像，不能直接还原</p>
<p>硬盘快照是用于创建相同的云硬盘，可以挂载给主机，不能直接还原快照。也可以放做启动盘使用</p>
<p>Nova 依赖 Keystone 认证服务</p>
<p>通过 Nova 模块创建计算实例，Nova 调用 Glance 模块提供的镜像服务</p>
<p>通过 Nova 模块创建的计算实例启动时，连接到的虚拟或物理网络由 Neutron 负责</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240422213122040.png" alt="image-20240422213122040"></p>
<p>最后一个服务已经没有了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@controller ~]# openstack compute service list </span><br><span class="line">+----+----------------+------------+----------+---------+-------+----------------------------+</span><br><span class="line">| ID | Binary         | Host       | Zone     | Status  | State | Updated At                 |</span><br><span class="line">+----+----------------+------------+----------+---------+-------+----------------------------+</span><br><span class="line">|  2 | nova-scheduler | controller | internal | enabled | up    | 2024-04-22T13:36:31.000000 |</span><br><span class="line">|  6 | nova-conductor | controller | internal | enabled | up    | 2024-04-22T13:36:37.000000 |</span><br><span class="line">| 10 | nova-compute   | compute01  | nova     | enabled | up    | 2024-04-22T13:36:39.000000 |</span><br><span class="line">| 11 | nova-compute   | compute02  | nova     | enabled | up    | 2024-04-22T13:36:40.000000 |</span><br><span class="line">+----+----------------+------------+----------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@controller ~]# systemctl status openstack-nova-novncproxy.service </span><br><span class="line">● openstack-nova-novncproxy.service - OpenStack Nova NoVNC Proxy Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/openstack-nova-novncproxy.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2024-04-08 22:13:09 CST; 1 weeks 6 days ago</span><br><span class="line">   </span><br><span class="line"> controller 不需要安装vnc客户端，novncproxy集成在浏览器中。</span><br><span class="line"> 链接的时候通过http://controller:6080 连接</span><br><span class="line"> </span><br><span class="line"> tcp        0      0 0.0.0.0:6080            0.0.0.0:*               LISTEN      20389/python3     </span><br><span class="line"> </span><br><span class="line"> 通过nonvcproxy访问到 compute上面 的5900 实现 vnc访问</span><br><span class="line"> </span><br><span class="line"> tcp        0      0 0.0.0.0:5900            0.0.0.0:*               LISTEN      4881/qemu-kvm </span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240422214400251.png" alt="image-20240422214400251"></p>
<p>nova-api</p>
<p>对外提供 rest 接口的处理</p>
<p>对传入的参数进行合法性校验和约束限制</p>
<p>对请求的资源进行配额 (quota) 的校验和预留</p>
<p>资源的创建，更新，删除查询等</p>
<p>虚拟机生命周期的入口</p>
<p>可水平扩展部署</p>
<p>nova-conductor</p>
<p>G 版本引进</p>
<p>数据库操作。解耦其他组件 (nova-compute) 数据库访问。</p>
<p>Nova 复杂流程控制，如创建，冷迁移，热迁移，虚拟机规格调整，虚拟机重建。</p>
<p>其他组件的依赖。如 nova-compute 需要依赖 nova-conductor 启动成功后才能启动成功。</p>
<p>其他组件的心跳定时写入。</p>
<p>可水平扩展</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240422215610585.png" alt="image-20240422215610585"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240422215737162.png" alt="image-20240422215737162"></p>
<p>服务内组件之间的消息全部通过 MQ 来进行转发，包括控制、查询、监控指标等。</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240422215843874.png" alt="image-20240422215843874" style="zoom:67%;" /> 
<p>无中心架构</p>
<p>各组件无本地持久化状态</p>
<p>可水平扩展</p>
<p>通常将 nova-api、nova-scheduler、nova-condyctor 组件合并部署在控制节点上</p>
<p>通过部署多个控制节点实现 HA 和负载均衡</p>
<p>通过增加控制节点和计算节点实现简单方便的系统扩容</p>
<p>nova-api-Cell  网格化管理，适用于大规模 nova 管理</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240423213730132.png" alt="image-20240423213730132"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240423213748648.png" alt="image-20240423213748648"></p>
<p>一个 az 中可以有多个 HA</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240423213926394.png" alt="image-20240423213926394"></p>
<p>region 一个区域，代表一个数据中心</p>
<p>一个 region 下可以有多个 az，提高资源可用率</p>
<p>ZA 下可以有多个主机集合。一般会将同一配置的主机放入一个主机集合，方便热迁移</p>
<p>一个主机集合中可以有多个主机组</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240423214535271.png" alt="image-20240423214535271"></p>
<p>主机组可以设置亲和性</p>
<p>创建主机集合</p>
<p>主机聚合只能在 admin 下创建</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240423215618659.png" alt="image-20240423215618659"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240423215709934.png" alt="image-20240423215709934"></p>
<p>Nova-Scheduler 功能</p>
<p>筛选和确定将虚拟机实例分配到哪一台物理机</p>
<p>分配过程主要分为两步过滤和权重</p>
<p>通过过滤器选择满足条件的计算节点</p>
<p>通过权重选择最优的节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nova list</span><br><span class="line">+--------------------------------------+-----------+--------+------------+-------------+-------------------------------------+</span><br><span class="line">| ID                                   | Name      | Status | Task State | Power State | Networks                            |</span><br><span class="line">+--------------------------------------+-----------+--------+------------+-------------+-------------------------------------+</span><br><span class="line">| 93da63d8-4f0b-4818-a01b-50c7af88c6dd | volume111 | ACTIVE | -          | Running     | VPC01=192.168.200.37, 192.168.1.197 |</span><br><span class="line">+--------------------------------------+-----------+--------+------------+-------------+-------------------------------------+</span><br></pre></td></tr></table></figure>
<p>vmstate: 数据库中记录的虚拟机状态 t</p>
<p>ask state: 当前虚拟机的任务状态，一般是中间态或者 None</p>
<p>powerstate: 从 hypervisor 获取的虚拟机的真实状志</p>
<p>Status: 对外呈现的虚拟机状态</p>
<p>状态之间的关系</p>
<p>系统内部！记求 ymstate 和 task state，power  state</p>
<p>status 星由 vmstate 和 task state 联合生成的</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240423221612792.png" alt="image-20240423221612792"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240423221628004.png" alt="image-20240423221628004"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240423221636417.png" alt="image-20240423221636417"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240424225838328.png" alt="image-20240424225838328"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> openstack server list --all </span><br><span class="line">+--------------------------------------+-----------+--------+-------------------------------------+---------+-----------+</span><br><span class="line">| ID                                   | Name      | Status | Networks                            | Image   | Flavor    |</span><br><span class="line">+--------------------------------------+-----------+--------+-------------------------------------+---------+-----------+</span><br><span class="line">| 93da63d8-4f0b-4818-a01b-50c7af88c6dd | volume111 | ACTIVE | VPC01=192.168.200.37, 192.168.1.197 | centos7 | t.large.7 |</span><br><span class="line">+--------------------------------------+-----------+--------+-------------------------------------+---------+-----------+</span><br><span class="line">openstack server show 93da63d8-4f0b-4818-a01b-50c7af88c6dd</span><br><span class="line">+-------------------------------------+----------------------------------------------------------+</span><br><span class="line">| Field                               | Value                                                    |</span><br><span class="line">+-------------------------------------+----------------------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig                   | AUTO                                                     |</span><br><span class="line">| OS-EXT-AZ:availability_zone         | nova                                                     |</span><br><span class="line">| OS-EXT-SRV-ATTR:host                | compute02                                                |</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname | compute02                                                |</span><br></pre></td></tr></table></figure>
<h3 id="neutron"><a class="markdownIt-Anchor" href="#neutron">#</a> neutron</h3>
<p>neutron-server：分为 core api 和 extent api，实现不同的功能， 比如 extent 实现 elb，fw，vpn,core 实现基本网络功能</p>
<p>plugin：类似 driver，可以理解为插件</p>
<p>agent：功能实现，比如 l2 l3</p>
<p>neutron 包含 netutron-server，plugin，agent</p>
<p>运行 l3 agent 的节点是网络节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@controller ~]# neutron agent-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">| id                                   | agent_type         | host       | availability_zone | alive | admin_state_up | binary                    |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">| 2a77cf87-be5f-40b6-86d1-8b2b60018073 | Linux bridge agent | controller |                   | :-)   | True           | neutron-linuxbridge-agent |</span><br><span class="line">| 448ef5c9-84ba-4a19-936c-bceb21854113 | Linux bridge agent | compute01  |                   | :-)   | True           | neutron-linuxbridge-agent |</span><br><span class="line">| 5971fc42-dfb5-4e07-9a1a-597f64ecca14 | DHCP agent         | controller | nova              | :-)   | True           | neutron-dhcp-agent        |</span><br><span class="line">| 9bc53f0e-c66f-439d-8767-23247b4d6aaf | Metadata agent     | controller |                   | :-)   | True           | neutron-metadata-agent    |</span><br><span class="line">| eafa283c-0bb8-46f1-9fc1-6da948bb4c11 | Linux bridge agent | compute02  |                   | :-)   | True           | neutron-linuxbridge-agent |</span><br><span class="line">| fd8e4b80-f243-4e0b-9672-814e14f9f10e | L3 agent           | controller | nova              | :-)   | True           | neutron-l3-agent          |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+----------------+--------------------</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240507212129451.png" alt="image-20240507212129451"></p>
<p>neutron-server 分为 core api 和 extension api</p>
<p>core-api</p>
<p>它可以看做是插件功能的最小集合，即每个插件都必须有的功能，也就是对网络、子网和端口的查询、加删和更新操作等。</p>
<p>extension api</p>
<p>它们一般是针对具体插件实现的，这样租户就可以利用这些插件独特的功能，比方说访问控制 (ACL) 和 Qos。</p>
<p>plugin</p>
<p>存储当前逻辑网络的配置信息，判断和存储逻辑网络和物理网络的对应关系 (比如为一个逻辑网络选择一个 van)，并与一种或多种交换机通信来实现这种对应关系 (- 般通过宿主机上的插件代理来实现这种操作，或者远程登录到交换机上来配置)。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240507212554971.png" alt="image-20240507212554971"></p>
<p>ml2 用于对接不同的 plugin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ml2]</span><br><span class="line">type_drivers = flat,vlan,vxlan</span><br><span class="line">tenant_network_types = vxlan</span><br><span class="line">mechanism_drivers = linuxbridge,l2population</span><br><span class="line">extension_drivers = port_security</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240507213559161.png" alt="image-20240507213559161"></p>
<p>一台主机只有一个 br-int，但是可以有多个 br-ethx</p>
<p>只有通过 br-ex 才能访问 Internet</p>
<p>vm1 和 vm2 在同网段通信的时候，只需要经过 br-int</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240507222300730.png" alt="image-20240507222300730"></p>
<p>99.2 是 dhcp 的地址</p>
<p>overlay 网络可以通过 flat 网络通</p>
<p>创建网络时必须创建配置文件中允许的网络类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">brctl show</span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">brq0298a5c0-e0          8000.4e18bd44ecd4       no              tap46a10425-89</span><br><span class="line">                                                        tap90fda3ce-83</span><br><span class="line">                                                        vxlan-790</span><br><span class="line">brq5fb8b5b5-2e          8000.000c2903cf83       no              ens224</span><br><span class="line">                                                        tap3459ccb0-de</span><br><span class="line">virbr0          8000.525400f28462       yes</span><br></pre></td></tr></table></figure>
<p>网络类型</p>
<p>local   本地网络</p>
<p>flat   没有 vlan 的网络</p>
<p>vlan 带有 vlan tag 的网络</p>
<p>qbr</p>
<p>linux bridge，用于实现安全组，每个 vm 都有自己的 qbr</p>
<p>br-ex</p>
<p>连接外部 (external) 网络的网桥。在配置文件中指定的名字，可以修改</p>
<p>br-int</p>
<p>集成 (integration) 网桥，所有 instance 的虚拟网卡和其他虚拟网络设备都将连接到该网桥。没有上行链路的虚拟交换机</p>
<p>br-tun</p>
<p>隧道 (tunnel) 网桥，基于隧道技术的 VxLAN 和 GRE 网络将使用该网桥进行通信。</p>
<p>br-eth1</p>
<p>有上行链路虚拟交换机，不同节点之间通信，包括云主机之间通信</p>
<p>openstack 网络类型 flat，vlan，vxlan，local</p>
<p><strong>local</strong>：本地网络，经过 br-int 实现内部通信，不能出去</p>
<p><strong>flat</strong>：不带 vlan tag 的网络</p>
<p><strong>vlan</strong>：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240526174248982.png" alt="image-20240526174248982"></p>
<p>tenant_network_types 决定了网络类型，对应配置是下面的 ml2_type_vlan</p>
<p>集中式路由场景，不同 vpc 互访需要到 network 节点。分布式路由，会把 l3 agent 部署在 compute 上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="line">[ml2]</span><br><span class="line">type_drivers = flat,vlan,vxlan</span><br><span class="line">tenant_network_types = vlan</span><br><span class="line">mechanism_drivers = openvswitch,l2population</span><br><span class="line">extension_drivers = port_security</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_flat]</span><br><span class="line"># flat_networks = provider</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># From neutron.ml2</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># List of physical_network names with which flat networks can be created. Use</span><br><span class="line"># default &#x27;*&#x27; to allow flat networks with arbitrary physical_network names. Use</span><br><span class="line"># an empty list to disable flat networks. (list value)</span><br><span class="line">#flat_networks = *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_geneve]</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># From neutron.ml2</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># Comma-separated list of &lt;vni_min&gt;:&lt;vni_max&gt; tuples enumerating ranges of</span><br><span class="line"># Geneve VNI IDs that are available for tenant network allocation. Note OVN</span><br><span class="line"># does not use the actual values. (list value)</span><br><span class="line">#vni_ranges =</span><br><span class="line"></span><br><span class="line"># The maximum allowed Geneve encapsulation header size (in bytes). Geneve</span><br><span class="line"># header is extensible, this value is used to calculate the maximum MTU for</span><br><span class="line"># Geneve-based networks. The default is 30, which is the size of the Geneve</span><br><span class="line"># header without any additional option headers. Note the default is not enough</span><br><span class="line"># for OVN which requires at least 38. (integer value)</span><br><span class="line">#max_header_size = 30</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_gre]</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># From neutron.ml2</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># Comma-separated list of &lt;tun_min&gt;:&lt;tun_max&gt; tuples enumerating ranges of GRE</span><br><span class="line"># tunnel IDs that are available for tenant network allocation (list value)</span><br><span class="line">#tunnel_id_ranges =</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_vlan]</span><br><span class="line">network_vlan_ranges = huawei:10:1000</span><br><span class="line">#</span><br><span class="line"># From neutron.ml2</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># List of &lt;physical_network&gt;:&lt;vlan_min&gt;:&lt;vlan_max&gt; or &lt;physical_network&gt;</span><br><span class="line"># specifying physical_network names usable for VLAN provider and tenant</span><br><span class="line"># networks, as well as ranges of VLAN tags on each available for allocation to</span><br><span class="line"># tenant networks. If no range is defined, the whole valid VLAN ID set [1,</span><br><span class="line"># 4094] will be assigned. (list value)</span><br><span class="line">#network_vlan_ranges =</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_vxlan]</span><br><span class="line"># vni_ranges = 1:1000</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/neutron/plugins/ml2/openvswitch_agent.ini </span><br><span class="line">[ovs]</span><br><span class="line">bridge_mappings = huawei:eth1</span><br><span class="line">local_ip = OVERLAY_INTERFACE_IP_ADDRESS</span><br></pre></td></tr></table></figure>
<p>ovs 流表，优先级数值大优先级越高</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ovs-ofctl dump-flows br-int </span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.780s, table=0, n_packets=0, n_bytes=0, priority=65535,dl_vlan=4095 actions=drop</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.769s, table=0, n_packets=0, n_bytes=0, priority=2,in_port=&quot;int-br-provider&quot; actions=drop</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.784s, table=0, n_packets=8, n_bytes=792, priority=0 actions=resubmit(,58)</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.785s, table=23, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.781s, table=24, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.779s, table=30, n_packets=0, n_bytes=0, priority=0 actions=resubmit(,58)</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.779s, table=31, n_packets=0, n_bytes=0, priority=0 actions=resubmit(,58)</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.783s, table=58, n_packets=8, n_bytes=792, priority=0 actions=resubmit(,60)</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=3522.763s, table=60, n_packets=4, n_bytes=392, priority=100,in_port=&quot;tapbb45b827-28&quot; actions=load:0x3-&gt;NXM_NX_REG5[],load:0x1-&gt;NXM_NX_REG6[],resubmit(,73)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ovs-ofctl show br-int </span><br><span class="line">OFPT_FEATURES_REPLY (xid=0x2): dpid:00006aad96360649</span><br><span class="line">n_tables:254, n_buffers:0</span><br><span class="line">capabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS ARP_MATCH_IP</span><br><span class="line">actions: output enqueue set_vlan_vid set_vlan_pcp strip_vlan mod_dl_src mod_dl_dst mod_nw_src mod_nw_dst mod_nw_tos mod_tp_src mod_tp_dst</span><br><span class="line"> 1(int-br-provider): addr:6e:ee:f9:c2:36:2f</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line"> 2(patch-tun): addr:9a:cd:9f:d6:ad:fb</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line"> 3(tapbb45b827-28): addr:fa:16:3e:fa:16:a6</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line"> LOCAL(br-int): addr:6a:ad:96:36:06:49</span><br><span class="line">     config:     PORT_DOWN</span><br><span class="line">     state:      LINK_DOWN</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line">OFPT_GET_CONFIG_REPLY (xid=0x4): frags=normal miss_send_len=0</span><br></pre></td></tr></table></figure>
<p>在 vlan 模式下，vlan tag 的转换需要在 br-int 和 br-ethx 两个网桥上进行相互配合。即 br-int 负责从 int-br-ethX 过来的包（带外部 vlan）转换为内部 vlan，而 br-ethx 负责从 phy-br-ethx 过来的包（带内部 vlan）转化为外部的 vlan。</p>
<p>同节点上 vm 相同 vlan，只需要走内部 vlan 即可</p>
<p>vmware 中外层交换机是 vment，vmnet 不能放行带 vlan 的。导致 dhcp 到不了其他节点，获取不到 IP</p>
<p><strong>vxlan</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@controller ml2]<span class="comment">#  ovs-ofctl dump-flows br-tun </span></span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.402s, table=0, n_packets=4, n_bytes=392, priority=1,in_port=<span class="string">&quot;patch-int&quot;</span> actions=resubmit(,2)</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.402s, table=0, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.400s, table=2, n_packets=0, n_bytes=0, priority=0,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,20)</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.399s, table=2, n_packets=4, n_bytes=392, priority=0,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,22)</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.398s, table=3, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=6467.440s, table=4, n_packets=0, n_bytes=0, priority=1,tun_id=0xf9 actions=mod_vlan_vid:1,resubmit(,10)</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.398s, table=4, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.397s, table=6, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.395s, table=10, n_packets=0, n_bytes=0, priority=1 actions=learn(table=20,hard_timeout=300,priority=1,cookie=0x3dcfb0afa749164c,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:0-&gt;NXM_OF_VLAN_TCI[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:OXM_OF_IN_PORT[]),output:<span class="string">&quot;patch-int&quot;</span></span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.394s, table=20, n_packets=0, n_bytes=0, priority=0 actions=resubmit(,22)</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.393s, table=22, n_packets=4, n_bytes=392, priority=0 actions=drop</span><br></pre></td></tr></table></figure>
<h5 id="openstack-网络类型"><a class="markdownIt-Anchor" href="#openstack-网络类型">#</a> openstack 网络类型</h5>
<p>flat，vlan，vxlan，local，gre</p>
<p><strong>local</strong>：本地网络，经过 br-int 实现内部通信，不能出去</p>
<p><strong>flat</strong>：不带 vlan tag 的网络</p>
<p>配置参考 vlan 网络，在 ml2.ini 中，配置支持 flat 网络类型，租户网络类型</p>
<p>在 [flat] 中定义标识</p>
<p>flat_networks = provider1111</p>
<p>vim  /etc/neutron/plugins/ml2/openvswitch_agent.ini  [ovs] bridge_mappings = provider1111:br-eth1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="line">[ml2]</span><br><span class="line">type_drivers = flat,vlan,vxlan</span><br><span class="line">tenant_network_types = flat</span><br><span class="line">mechanism_drivers = openvswitch,l2population</span><br><span class="line">extension_drivers = port_security</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_flat]</span><br><span class="line">flat_networks = provider111</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim  /etc/neutron/plugins/ml2/openvswitch_agent.ini </span><br><span class="line">[ovs]</span><br><span class="line">bridge_mappings = provider111:br-eth1</span><br><span class="line"></span><br><span class="line">openstack-service restart neutron</span><br></pre></td></tr></table></figure>
<p>br-int 只有一个，br-eth1 可以有多个</p>
<p>vnet0 只有在 kvm 中可以看到</p>
<p>flat 网络在 br-int 中有内部 tag，同一租户，内部 tag 一样</p>
<p><strong>vlan</strong>：</p>
<p>tenant_network_types 决定了网络类型，对应配置是下面的 ml2_type_vlan</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="line">[ml2]</span><br><span class="line">type_drivers = flat,vlan,vxlan</span><br><span class="line">tenant_network_types = vlan</span><br><span class="line">mechanism_drivers = openvswitch,l2population</span><br><span class="line">extension_drivers = port_security</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_flat]</span><br><span class="line">flat_networks = provider</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># From neutron.ml2</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of physical_network names with which flat networks can be created. Use</span></span><br><span class="line"><span class="comment"># default &#x27;*&#x27; to allow flat networks with arbitrary physical_network names. Use</span></span><br><span class="line"><span class="comment"># an empty list to disable flat networks. (list value)</span></span><br><span class="line"><span class="comment">#flat_networks = *</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_geneve]</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># From neutron.ml2</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Comma-separated list of &lt;vni_min&gt;:&lt;vni_max&gt; tuples enumerating ranges of</span></span><br><span class="line"><span class="comment"># Geneve VNI IDs that are available for tenant network allocation. Note OVN</span></span><br><span class="line"><span class="comment"># does not use the actual values. (list value)</span></span><br><span class="line"><span class="comment">#vni_ranges =</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The maximum allowed Geneve encapsulation header size (in bytes). Geneve</span></span><br><span class="line"><span class="comment"># header is extensible, this value is used to calculate the maximum MTU for</span></span><br><span class="line"><span class="comment"># Geneve-based networks. The default is 30, which is the size of the Geneve</span></span><br><span class="line"><span class="comment"># header without any additional option headers. Note the default is not enough</span></span><br><span class="line"><span class="comment"># for OVN which requires at least 38. (integer value)</span></span><br><span class="line"><span class="comment">#max_header_size = 30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_gre]</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># From neutron.ml2</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Comma-separated list of &lt;tun_min&gt;:&lt;tun_max&gt; tuples enumerating ranges of GRE</span></span><br><span class="line"><span class="comment"># tunnel IDs that are available for tenant network allocation (list value)</span></span><br><span class="line"><span class="comment">#tunnel_id_ranges =</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_vlan]</span><br><span class="line">network_vlan_ranges = huawei:10:1000</span><br><span class="line"><span class="comment"># 标识，vlan range，标识可以有多个</span></span><br><span class="line"><span class="comment"># From neutron.ml2</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of &lt;physical_network&gt;:&lt;vlan_min&gt;:&lt;vlan_max&gt; or &lt;physical_network&gt;</span></span><br><span class="line"><span class="comment"># specifying physical_network names usable for VLAN provider and tenant</span></span><br><span class="line"><span class="comment"># networks, as well as ranges of VLAN tags on each available for allocation to</span></span><br><span class="line"><span class="comment"># tenant networks. If no range is defined, the whole valid VLAN ID set [1,</span></span><br><span class="line"><span class="comment"># 4094] will be assigned. (list value)</span></span><br><span class="line"><span class="comment">#network_vlan_ranges =</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ml2_type_vxlan]</span><br><span class="line"><span class="comment"># vni_ranges = 1:1000</span></span><br><span class="line">vim  /etc/neutron/plugins/ml2/openvswitch_agent.ini </span><br><span class="line"><span class="comment"># 计算和网络都需要改</span></span><br><span class="line">[ovs]</span><br><span class="line">bridge_mappings = huawei:eth1</span><br><span class="line">local_ip = OVERLAY_INTERFACE_IP_ADDRESS</span><br></pre></td></tr></table></figure>
<p>段 id 就是 vlan id，vlanid 只是限制租户的 vlanid，admin vlanid 不受限</p>
<p>ovs 流标，优先级数值大优先级越高</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ovs-ofctl dump-flows br-int </span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.780s, table=0, n_packets=0, n_bytes=0, priority=65535,dl_vlan=4095 actions=drop</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.769s, table=0, n_packets=0, n_bytes=0, priority=2,in_port=<span class="string">&quot;int-br-provider&quot;</span> actions=drop</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.784s, table=0, n_packets=8, n_bytes=792, priority=0 actions=resubmit(,58)</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.785s, table=23, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.781s, table=24, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.779s, table=30, n_packets=0, n_bytes=0, priority=0 actions=resubmit(,58)</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.779s, table=31, n_packets=0, n_bytes=0, priority=0 actions=resubmit(,58)</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=81941.783s, table=58, n_packets=8, n_bytes=792, priority=0 actions=resubmit(,60)</span><br><span class="line"> cookie=0x10c394b632250c4c, duration=3522.763s, table=60, n_packets=4, n_bytes=392, priority=100,in_port=<span class="string">&quot;tapbb45b827-28&quot;</span> actions=load:0x3-&gt;NXM_NX_REG5[],load:0x1-&gt;NXM_NX_REG6[],resubmit(,73)</span><br><span class="line">ovs-ofctl show br-int </span><br><span class="line">OFPT_FEATURES_REPLY (xid=0x2): dpid:00006aad96360649</span><br><span class="line">n_tables:254, n_buffers:0</span><br><span class="line">capabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS ARP_MATCH_IP</span><br><span class="line">actions: output enqueue set_vlan_vid set_vlan_pcp strip_vlan mod_dl_src mod_dl_dst mod_nw_src mod_nw_dst mod_nw_tos mod_tp_src mod_tp_dst</span><br><span class="line"> 1(int-br-provider): addr:6e:ee:f9:c2:36:2f</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line"> 2(patch-tun): addr:9a:<span class="built_in">cd</span>:9f:d6:ad:fb</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line"> 3(tapbb45b827-28): addr:fa:16:3e:fa:16:a6</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line"> LOCAL(br-int): addr:6a:ad:96:36:06:49</span><br><span class="line">     config:     PORT_DOWN</span><br><span class="line">     state:      LINK_DOWN</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line">OFPT_GET_CONFIG_REPLY (xid=0x4): frags=normal miss_send_len=0</span><br></pre></td></tr></table></figure>
<p>在 vlan 模式下，vlan tag 的转换需要在 br-int 和 br-ethx 两个网桥上进行相互配合。即 br-int 负责从 int-br-ethX 过来的包（带外部 vlan）转换为内部 vlan，而 br-ethx 负责从 phy-br-ethx 过来的包（带内部 vlan）转化为外部的 vlan。</p>
<p>同节点上 vm 相同 vlan，只需要走内部 vlan 即可</p>
<p>vmware 中外层交换机是 vment，vmnet 不能放行带 vlan 的。导致 dhcp 到不了其他节点，获取不到 IP</p>
<p><strong>vxlan</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@controller ml2]<span class="comment">#  ovs-ofctl dump-flows br-tun </span></span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.402s, table=0, n_packets=4, n_bytes=392, priority=1,in_port=<span class="string">&quot;patch-int&quot;</span> actions=resubmit(,2)</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.402s, table=0, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.400s, table=2, n_packets=0, n_bytes=0, priority=0,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,20)</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.399s, table=2, n_packets=4, n_bytes=392, priority=0,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,22)</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.398s, table=3, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=6467.440s, table=4, n_packets=0, n_bytes=0, priority=1,tun_id=0xf9 actions=mod_vlan_vid:1,resubmit(,10)</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.398s, table=4, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.397s, table=6, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.395s, table=10, n_packets=0, n_bytes=0, priority=1 actions=learn(table=20,hard_timeout=300,priority=1,cookie=0x3dcfb0afa749164c,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:0-&gt;NXM_OF_VLAN_TCI[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:OXM_OF_IN_PORT[]),output:<span class="string">&quot;patch-int&quot;</span></span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.394s, table=20, n_packets=0, n_bytes=0, priority=0 actions=resubmit(,22)</span><br><span class="line"> cookie=0x3dcfb0afa749164c, duration=84884.393s, table=22, n_packets=4, n_bytes=392, priority=0 actions=drop </span><br></pre></td></tr></table></figure>
<h4 id="router"><a class="markdownIt-Anchor" href="#router">#</a> router</h4>
<p>添加 public subnet 的时候不需要网关，公网 IP 不需要网关，也不需要 dhcp</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">ip netns <span class="built_in">exec</span> qrouter-a51268a3-68a6-47f0-a51d-03b98216b2f8 ip -c a s </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: qg-3faec10c-ad: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether fa:16:3e:93:bb:1e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.0.203/24 brd 192.168.0.255 scope global qg-3faec10c-ad</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.0.27/32 brd 192.168.0.27 scope global qg-3faec10c-ad</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f816:3eff:fe93:bb1e/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">13: qr-bab87452-44: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether fa:16:3e:43:b9:2f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.100.254/24 brd 192.168.100.255 scope global qr-bab87452-44</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f816:3eff:fe43:b92f/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">ip netns <span class="built_in">exec</span> qrouter-a51268a3-68a6-47f0-a51d-03b98216b2f8 iptables -t nat -nvxL</span><br><span class="line"></span><br><span class="line">Chain neutron-l3-agent-OUTPUT (1 references)</span><br><span class="line">    pkts      bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">       0        0 DNAT       0    --  *      *       0.0.0.0/0            192.168.0.27         to:192.168.100.97</span><br><span class="line"></span><br><span class="line">Chain neutron-l3-agent-POSTROUTING (1 references)</span><br><span class="line">    pkts      bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">       0        0 ACCEPT     0    --  *      !qg-3faec10c-ad  0.0.0.0/0            0.0.0.0/0            ! ctstate DNAT</span><br><span class="line"></span><br><span class="line">Chain neutron-l3-agent-PREROUTING (1 references)</span><br><span class="line">    pkts      bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">       0        0 REDIRECT   6    --  qr-+   *       0.0.0.0/0            169.254.169.254      tcp dpt:80 redir ports 9697</span><br><span class="line">       4      272 DNAT       0    --  *      *       0.0.0.0/0            192.168.0.27         to:192.168.100.97</span><br><span class="line"></span><br><span class="line">Chain neutron-l3-agent-float-snat (1 references)</span><br><span class="line">    pkts      bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">      16     1196 SNAT       0    --  *      *       192.168.100.97       0.0.0.0/0            to:192.168.0.27 random-fully</span><br><span class="line"></span><br><span class="line">Chain neutron-l3-agent-snat (1 references)</span><br><span class="line">    pkts      bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">      31     2230 neutron-l3-agent-float-snat  0    --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">      11      762 SNAT       0    --  *      qg-3faec10c-ad  0.0.0.0/0            0.0.0.0/0            to:192.168.0.203 random-fully</span><br><span class="line">       0        0 SNAT       0    --  *      *       0.0.0.0/0            0.0.0.0/0            mark match ! 0x2/0xffff ctstate DNAT to:192.168.0.203 random-fully</span><br></pre></td></tr></table></figure>
<p>float ip 比 snat 优先级更高，按照 iptables 匹配规则</p>
<h4 id="metadata"><a class="markdownIt-Anchor" href="#metadata">#</a> metadata</h4>
<p>获取客户自己定义，但无法传送给虚拟机的数据</p>
<blockquote>
<p>为了满足公有云虚拟机的差异化定制，虚拟机（overlay 网络）需要从控制面（underlay 网络）获取一些信息，但是虚拟机是不能够直接与控制面进行通信的，所以增加 metadata 来传递虚拟机和控制面的数据交换。目前实现数据类型有初始化（第一次创建密码，公钥，hostname 等注入），AssumeRole，重置密码 / 公钥。</p>
</blockquote>
<p>metatdata 分为 neutron metadata 和 nova metadata</p>
<p>为了保证使用私有镜像创建的新云服务器可以通过 &quot;用户数据注入&quot; 功能注入初始化自定义信息 (例如为云服务器设置登录密码), 请在创建私有镜像前安装 Cloud-Init 工具。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@controller ~]<span class="comment"># file cirros-0.4.0-x86_64-disk.img </span></span><br><span class="line">cirros-0.4.0-x86_64-disk.img: QEMU QCOW2 Image (v3), 46137344 bytes</span><br></pre></td></tr></table></figure>
<p>cloud-init 是 Linux 的一个工具，当系统启动时，cloud-init 可从 novametadata 服务或者 config drive 中获取 metadata</p>
<p>windows 安装 cloudbase-init</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240526174445778.png" alt="image-20240526174445778"></p>
<p>metatdata 分为 neutron metadata 和 nova metadata</p>
<p>为了保证使用私有镜像创建的新云服务器可以通过 &quot;用户数据注入&quot; 功能注入初始化自定义信息 (例如为云服务器设置登录密码), 请在创建私有镜像前安装 Cloud-Init 工具。</p>
<p>cloud-init 是 Linux 的一个工具，当系统启动时，cloud-init i 可从 novametadata 服务或者 config drive 中获取 metadata</p>
<p>通过路由器获取</p>
<p>instance 通过默认网关到网络节点，网络节点通过管理网络到 nova 上获取 metadata</p>
<p>必须要有 router，不然没有办法到 gw</p>
<p>用户在发放云主机时，自定义主机名，密码等信息，发送给 novaapi-metadata</p>
<p>获取计算机名和密码流程</p>
<p>1. 云主机启动后，通过 DHCP 获得 IP 地址</p>
<p>2. 运行 cloud-init,cloud-init 开始去访问 http://169.254.169.254:80</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240526174524098.png" alt="image-20240526174524098"></p>
<p>3. 这个请求将丢给网关 (Router)</p>
<p>4.iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --t9697</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ip netns exec qrouter-a51268a3-68a6-47f0-a51d-03b98216b2f8 iptables -t nat -nvxL</span><br><span class="line">Chain neutron-l3-agent-PREROUTING (1 references)</span><br><span class="line">    pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">       0        0 REDIRECT   6    --  qr-+   *       0.0.0.0/0            169.254.169.254      tcp dpt:80 redir ports 9697</span><br><span class="line">       4      272 DNAT       0    --  *      *       0.0.0.0/0            192.168.0.27         to:192.168.100.97</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">ip netns exec qrouter-a51268a3-68a6-47f0-a51d-03b98216b2f8 netstat -lntup</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp6       0      0 :::9697                 :::*                    LISTEN      5673/haproxy</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>#ps aux |grep 9697</p>
<p>5. 请求会转发给 neutron-metadata</p>
<p>6.neutron-metadata 会通过管理网络访问 nova-api-metadata, 从而得到计算机名和密码</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240518184630823.png" alt="image-20240518184630823"></p>
<ol>
<li>instance 通过 neutron network (Project 网络) 将 metadata 请求发送到 neutron-ns-metadata-proxy。</li>
<li>neutron-ns-metadata-proxy 通过 unixdomain socket 将请求发给 neutron-metadata-agento</li>
</ol>
<p>3.neutron-metadata-agent 通过内部管理网络将请求发送给 nova-api-metadata。</p>
<p>各家云厂商会更改这个地址，比如 volc 的地址就是 http://100.96.0.96，在 ecs 中 curl</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://100.96.0.96/2021-07-01/hostname</span><br><span class="line">iv-yd5c3xliwwcva4f4b9cl</span><br></pre></td></tr></table></figure>
<p>通过 dhcp 获取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/neutron/dhcp_agent.ini </span><br><span class="line">enable_isolated_metadata = True</span><br></pre></td></tr></table></figure>
<p>生成一条去往 dhcp 的路由 169.254.169.254  gw dhcp ，到网络节点后，通过管理网络发给 nova</p>
<p>dhcp 生成一条去往 network node 的路由 169.254.169.254  gw dhcp ，到网络节点后，通过管理网络发给 nova</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240518184658504.png" alt="image-20240518184658504"></p>
<h3 id="mq"><a class="markdownIt-Anchor" href="#mq">#</a> MQ</h3>
<p>MQ 全称为 MessageQueue, 应用程序通过读写出入队列的消息 (针对应用程序的数据) 来通信，而无需专用连接来连接它们。</p>
<p>MQ 会处理服务内组件之间的消息，包括控制，查询，监控</p>
<p>不同服务之间不过消息队列</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240518184721516.png" alt="image-20240518184721516"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240518184728969.png" alt="image-20240518184728969"></p>
<p>rabbitmqctl list_queues</p>
<p>华为云管理节点数目与规模</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240518184748793.png" alt="image-20240518184748793"></p>
<p>小型场景下，rabbitmq 部署在 controller 上作为一个进程</p>
<h3 id="openstack-使用-source-安装dashboard"><a class="markdownIt-Anchor" href="#openstack-使用-source-安装dashboard">#</a> openstack 使用 source  安装 dashboard</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 下载源码包</span><br><span class="line">git clone https://opendev.org/openstack/horizon -b stable/2023.1 --depth=1</span><br><span class="line">cd horizon</span><br><span class="line"></span><br><span class="line"># 安装依赖</span><br><span class="line">yum install pcre* zlib* openldap-devel libsystemd* krb5-devel  libvirt-devel libvirt-daemon-kvm libvirt-client libpq-devel liberasurecode* postgresql-devel</span><br><span class="line">pip install -c https://opendev.org/openstack/requirements/raw/branch/stable/2023.1/upper-constraints.txt .</span><br><span class="line">如果这个命令执行报错，可以打开上面那个网页，里面有所有的依赖包，保存成 req.txt </span><br><span class="line">wget -O &quot;req.txt&quot; &quot;https://opendev.org/openstack/requirements/raw/branch/stable/2023.1/upper-constraints.txt&quot;</span><br><span class="line">pip install -r req.txt</span><br><span class="line"></span><br><span class="line">#或者horizon中也有requirements.txt install这个也可以</span><br><span class="line"></span><br><span class="line">https://docs.openstack.org/horizon/2024.1/install/from-source.html#installation</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hpeGl4aWxhbGFsYWhhaGEvYXJ0aWNsZS9kZXRhaWxzLzEwOTgxMDM4Mg==">https://blog.csdn.net/xixixilalalahaha/article/details/109810382</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xNDI0NjY0NjE=">https://zhuanlan.zhihu.com/p/142466461</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Fsd2F5c2JlZmluZS9hcnRpY2xlL2RldGFpbHMvMTI4ODU0ODUw">https://blog.csdn.net/alwaysbefine/article/details/128854850</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzc0OTAxOTIyL2FydGljbGUvZGV0YWlscy8xMzQ4ODUxMzY=">https://blog.csdn.net/m0_74901922/article/details/134885136</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZHlkMTY4L3AvMTQ0NjY3NDQuaHRtbA==">https://www.cnblogs.com/dyd168/p/14466744.html</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vc2FtbXlsaXUvcC81OTk5NjEyLmh0bWw=">https://www.cnblogs.com/sammyliu/p/5999612.html</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjQxMDgzL2FydGljbGUvZGV0YWlscy8xMDMxNDMwODU=">https://blog.csdn.net/qq_44241083/article/details/103143085</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzU3Nzc2NTk4L2FydGljbGUvZGV0YWlscy8xMzQzNDkwMTY=">https://blog.csdn.net/m0_57776598/article/details/134349016</span></p>
<p>装不出来… 下面用 kolla-openstack 安装</p>
<h3 id="使用kolla-openstack安装openstack"><a class="markdownIt-Anchor" href="#使用kolla-openstack安装openstack">#</a> 使用 kolla-openstack 安装 openstack</h3>
<p>The host machine must satisfy the following minimum requirements:</p>
<ul>
<li>2 network interfaces</li>
<li>8GB main memory</li>
<li>40GB disk space</li>
</ul>
<p>需要双网卡，第一块作为管理网，配置管理 ip，第二块只需要 up 起来，不需要配置 ip</p>
<p>两块硬盘 sdb 做 lvm</p>
<p>centos9 上安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># Install Python build dependencies:</span><br><span class="line">dnf update</span><br><span class="line">dnf install git python3-devel libffi-devel gcc openssl-devel python3-libselinux -y</span><br><span class="line"></span><br><span class="line"># Create a virtual environment and activate it:</span><br><span class="line">python3 -m venv /path/to/venv</span><br><span class="line">source /path/to/venv/bin/activate</span><br><span class="line"></span><br><span class="line"># Ensure the latest version of pip is installed:</span><br><span class="line">pip install -U pip</span><br><span class="line"># Install Ansible. Kolla Ansible requires at least Ansible 6 and supports up to 7.</span><br><span class="line"># ansible core 版本必须在2.14-2.16 之间</span><br><span class="line">pip install &#x27;ansible&gt;=6,&lt;8&#x27;</span><br><span class="line"></span><br><span class="line"># install docker</span><br><span class="line">rpm --import https://download.docker.com/linux/centos/gpg</span><br><span class="line">dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">dnf install docker-ce docker-ce-cli containerd.io</span><br><span class="line">vim /etc/docker/daemon.json  # 还原 一定要换</span><br><span class="line">systemctl restart docker </span><br><span class="line">systemctl enable docker --now </span><br><span class="line"></span><br><span class="line"># lvm</span><br><span class="line">pvcreate /dev/sdb </span><br><span class="line">vgcreate cinder-volumes /dev/sdb </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Install kolla-ansible and its dependencies using pip.</span><br><span class="line">pip install git+https://opendev.org/openstack/kolla-ansible@2023.1</span><br><span class="line"></span><br><span class="line"># Create the /etc/kolla directory.</span><br><span class="line">sudo mkdir -p /etc/kolla</span><br><span class="line">sudo chown $USER:$USER /etc/kolla</span><br><span class="line"></span><br><span class="line"># Copy globals.yml and passwords.yml to /etc/kolla directory.</span><br><span class="line">cp -r /path/to/venv/share/kolla-ansible/etc_examples/kolla/* /etc/kolla</span><br><span class="line"></span><br><span class="line"># Copy all-in-one inventory file to the current directory.</span><br><span class="line">cp /path/to/venv/share/kolla-ansible/ansible/inventory/all-in-one  .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 后面参考：</span><br><span class="line">https://docs.openstack.org/project-deploy-guide/kolla-ansible/2023.1/quickstart.html#install-dependencies</span><br><span class="line"># 注意，每个kolla-ansible  命令后面都需要加 -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27; 指定环境，不然报错</span><br><span class="line"></span><br><span class="line"># 下面附上命令记录</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> 54  kolla-ansible install-deps</span><br><span class="line"> 55  kolla-ansible install-deps -vvv</span><br><span class="line"> 56  ansible -i all-in-one all -m ping</span><br><span class="line"> 57  kolla-genpwd </span><br><span class="line"> 58  vim /etc/kolla/passwords.yml </span><br><span class="line"> 59  vim /etc/kolla/globals.yml </span><br><span class="line"> 60  kolla-ansible -i ./all-in-one bootstrap-servers</span><br><span class="line"> 61  vim /root/.ansible/collections/ansible_collections/openstack/kolla/roles/baremetal/tasks/pre-install.yml</span><br><span class="line"> 62  kolla-ansible -i ./all-in-one bootstrap-servers</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> 67  kolla-ansible -i ./all-in-one bootstrap-servers</span><br><span class="line"> 68  dnf install git python3-devel libffi-devel gcc openssl-devel python3-libselinux</span><br><span class="line"> 69  pip install -I PyYAML</span><br><span class="line"> 70  pip -h</span><br><span class="line"> 71  kolla-ansible install-deps</span><br><span class="line"> 72  pip install -U &#x27;ansible&gt;=4,&lt;6&#x27;</span><br><span class="line"> 73  kolla-ansible install-deps</span><br><span class="line"> 74  pip uninstall  -U &#x27;ansible&gt;=4,&lt;6&#x27;</span><br><span class="line"> 75  pip uninstall  ansible</span><br><span class="line"> 76  pip list ansible </span><br><span class="line"> 77  pip uninstall ansible-core</span><br><span class="line"> 78  pip list ansible </span><br><span class="line"> 79  pip list </span><br><span class="line"> 80  pip install -U &#x27;ansible-core&gt;=2.14,&lt;2.16&#x27;</span><br><span class="line"> 81  pip list </span><br><span class="line"> 82  kolla-ansible install-deps</span><br><span class="line"> 83  kolla-ansible -i ./all-in-one bootstrap-servers</span><br><span class="line"> 84  kolla-ansible -i ./all-in-one prechecks</span><br><span class="line"> 85  find / -name ansible.cfg</span><br><span class="line"> 86  mkdir /etc/ansible </span><br><span class="line"> 87  echo &quot;[defaults]</span><br><span class="line"> 88  host_key_checking=False</span><br><span class="line"> 89  pipelining=True</span><br><span class="line"> 90  forks=100&quot; &gt; /etc/ansible/ansible.cfg</span><br><span class="line"> 91  cd /etc/ansible/</span><br><span class="line"> 92  ls </span><br><span class="line"> 93  vim ansible.cfg </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">126  vim all-in-one </span><br><span class="line">127  cat /etc/kolla/globals.yml |grep -v ^$|grep -v ^#</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">150  pip install requests</span><br><span class="line">151  kolla-ansible -i all-in-one prechecks -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line">152  pip install dbus </span><br><span class="line">153  yum install python3-dbus </span><br><span class="line">154  pip list | grep dbus </span><br><span class="line">155  pip install dbus </span><br><span class="line">156  pip install dbus-python </span><br><span class="line">157  yum install python-dbus </span><br><span class="line">158  yum install *dbus*</span><br><span class="line">159  kolla-ansible -i all-in-one prechecks -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line">160  yum install python-dbus </span><br><span class="line">161  pip install dbus-python </span><br><span class="line">162  kolla-ansible -i all-in-one prechecks -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line">163  vim /etc/hosts </span><br><span class="line">164  kolla-ansible -i all-in-one prechecks -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">207  source /path/to/venv/bin/activate</span><br><span class="line">208  kolla-ansible -i all-in-one prechecks -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line">209  vim /etc/kolla/globals.yml </span><br><span class="line">210  kolla-ansible -i ./all-in-one bootstrap-servers</span><br><span class="line">211  kolla-ansible -i all-in-one prechecks -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line">212  vim /etc/hosts </span><br><span class="line">213  kolla-ansible -i all-in-one prechecks -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line">214  kolla-ansible -i ./all-in-one deploy</span><br><span class="line">215  kolla-ansible -i all-in-one deploy -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line">216  kolla-ansible -i all-in-one destroy -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line">217  kolla-ansible pull</span><br><span class="line">218  kolla-ansible -i all-in-one pull  -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">224  kolla-ansible -i all-in-one pull  -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line">225  kolla-ansible -i all-in-one deploy -e &#x27;ansible_python_interpreter=/path/to/venv/bin/python&#x27;</span><br><span class="line">226  pip install python-openstackclient -c https://releases.openstack.org/constraints/upper/2023.2</span><br><span class="line">227  kolla-ansible post-deploy</span><br><span class="line">228  cp /etc/kolla/clouds.yaml ~/.config/openstack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">docker ps </span><br><span class="line">CONTAINER ID   IMAGE                                                              COMMAND                  CREATED        STATUS                  PORTS     NAMES</span><br><span class="line">47e62b420516   quay.io/openstack.kolla/horizon:2023.2-rocky-9                     &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             horizon</span><br><span class="line">e5285087e35f   quay.io/openstack.kolla/neutron-metadata-agent:2023.2-rocky-9      &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             neutron_metadata_agent</span><br><span class="line">bbb47ee8c476   quay.io/openstack.kolla/neutron-l3-agent:2023.2-rocky-9            &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             neutron_l3_agent</span><br><span class="line">839f0f531918   quay.io/openstack.kolla/neutron-dhcp-agent:2023.2-rocky-9          &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             neutron_dhcp_agent</span><br><span class="line">c6f50c1293e0   quay.io/openstack.kolla/neutron-openvswitch-agent:2023.2-rocky-9   &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             neutron_openvswitch_agent</span><br><span class="line">39feba299841   quay.io/openstack.kolla/neutron-server:2023.2-rocky-9              &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             neutron_server</span><br><span class="line">70d90912fcdc   quay.io/openstack.kolla/openvswitch-vswitchd:2023.2-rocky-9        &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             openvswitch_vswitchd</span><br><span class="line">bb6df74b3f1d   quay.io/openstack.kolla/openvswitch-db-server:2023.2-rocky-9       &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             openvswitch_db</span><br><span class="line">d4751b1dfbb5   quay.io/openstack.kolla/nova-compute:2023.2-rocky-9                &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             nova_compute</span><br><span class="line">24a42e1df05e   quay.io/openstack.kolla/nova-libvirt:2023.2-rocky-9                &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             nova_libvirt</span><br><span class="line">9a7a7a13409e   quay.io/openstack.kolla/nova-ssh:2023.2-rocky-9                    &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             nova_ssh</span><br><span class="line">f75137a92750   quay.io/openstack.kolla/nova-novncproxy:2023.2-rocky-9             &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             nova_novncproxy</span><br><span class="line">1c77ed148f49   quay.io/openstack.kolla/nova-conductor:2023.2-rocky-9              &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             nova_conductor</span><br><span class="line">70a2a86cb8b6   quay.io/openstack.kolla/nova-api:2023.2-rocky-9                    &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             nova_api</span><br><span class="line">bd0481ecd240   quay.io/openstack.kolla/nova-scheduler:2023.2-rocky-9              &quot;dumb-init --single-…&quot;   23 hours ago   Up 23 hours (healthy)             nova_scheduler</span><br><span class="line">82412f5ca441   quay.io/openstack.kolla/placement-api:2023.2-rocky-9               &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             placement_api</span><br><span class="line">a5d05de19056   quay.io/openstack.kolla/cinder-backup:2023.2-rocky-9               &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             cinder_backup</span><br><span class="line">c3e027e14226   quay.io/openstack.kolla/cinder-volume:2023.2-rocky-9               &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             cinder_volume</span><br><span class="line">bf036ab1112a   quay.io/openstack.kolla/cinder-scheduler:2023.2-rocky-9            &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             cinder_scheduler</span><br><span class="line">69049f38cb8f   quay.io/openstack.kolla/cinder-api:2023.2-rocky-9                  &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             cinder_api</span><br><span class="line">1c7fd275af75   quay.io/openstack.kolla/glance-api:2023.2-rocky-9                  &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             glance_api</span><br><span class="line">38e076c265a3   quay.io/openstack.kolla/keystone:2023.2-rocky-9                    &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             keystone</span><br><span class="line">550512e6bdae   quay.io/openstack.kolla/keystone-fernet:2023.2-rocky-9             &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             keystone_fernet</span><br><span class="line">2868f0629ed9   quay.io/openstack.kolla/keystone-ssh:2023.2-rocky-9                &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             keystone_ssh</span><br><span class="line">a88187cf88aa   quay.io/openstack.kolla/rabbitmq:2023.2-rocky-9                    &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             rabbitmq</span><br><span class="line">b4ad3cc04760   quay.io/openstack.kolla/iscsid:2023.2-rocky-9                      &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours                       iscsid</span><br><span class="line">e0f1238ff21c   quay.io/openstack.kolla/memcached:2023.2-rocky-9                   &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours (healthy)             memcached</span><br><span class="line">0d102ad3d111   quay.io/openstack.kolla/mariadb-server:2023.2-rocky-9              &quot;dumb-init -- kolla_…&quot;   29 hours ago   Up 24 hours (healthy)             mariadb</span><br><span class="line">0b9a8bc49b05   quay.io/openstack.kolla/cron:2023.2-rocky-9                        &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours                       cron</span><br><span class="line">fc04f58ead68   quay.io/openstack.kolla/kolla-toolbox:2023.2-rocky-9               &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours                       kolla_toolbox</span><br><span class="line">5fd58c753412   quay.io/openstack.kolla/fluentd:2023.2-rocky-9                     &quot;dumb-init --single-…&quot;   29 hours ago   Up 24 hours                       fluentd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">所有的配置文件都挂载在/etc/kolla下</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 备注：</span><br><span class="line">目前发现无法直接在dashboard上创建镜像</span><br><span class="line">需要去docker中</span><br><span class="line">docker cp cirros-0.4.0-x86_64-disk.img  glance_api:/home</span><br><span class="line">docker exec -it glance_api bash </span><br><span class="line"></span><br><span class="line">vi admin-openrc</span><br><span class="line">export OS_PROJECT_DOMAIN_NAME=Default</span><br><span class="line">export OS_USER_DOMAIN_NAME=Default</span><br><span class="line">export OS_PROJECT_NAME=admin</span><br><span class="line">export OS_USERNAME=admin</span><br><span class="line">export OS_PASSWORD=redhat</span><br><span class="line">export OS_AUTH_URL=http://192.168.13.82:5000/v3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br><span class="line">export OS_IMAGE_API_VERSION=2</span><br><span class="line"></span><br><span class="line">. admin-openrc </span><br><span class="line"></span><br><span class="line">cd /home</span><br><span class="line">glance image-create --name cirros  --file cirros-0.4.0-x86_64-disk.img  --disk-format qcow2  --container-format bare --visibility public --progress</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240518193026936.png" alt="image-20240518193026936"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">如果执行bootstrap-servers 报错 xxxping 一般是ansible版本问题 ，换ansible或者aisible-core版本即可解决</span><br><span class="line">执行完后可能会因为openssh版本升级导致ssh无法连接</span><br><span class="line">yum remove openssh -y</span><br><span class="line">yum install openssh* -y</span><br><span class="line">重装旧的ssh即可</span><br><span class="line"></span><br><span class="line">在pre-check时，会有dbus报错， pip install dbus-python</span><br><span class="line"></span><br><span class="line">如果在bootstrap-servers 提示docker 超时，可以自己先装docker，在跑这个</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>参考：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY2hhb2Zhbi0vcC8xMTcxNTQwMi5odG1s">kolla-ansible 部署 openstack 常见错误汇总 (stein) - 超凡 - - 博客园</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01hbl9Jbl9UaGVfTmlnaHQvYXJ0aWNsZS9kZXRhaWxzLzEwNzM1NjYyNQ==">https://blog.csdn.net/Man_In_The_Night/article/details/107356625</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veGlhb2xpLXF6L3AvMTc1ODAwNTguaHRtbA==">Kolla-ansible 自动化部署 openstack - 小李 222 - 博客园</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvbmd6dy9hcnRpY2xlL2RldGFpbHMvMTA2OTUyOTQ4">https://blog.csdn.net/zongzw/article/details/106952948</span></p>
<p>有用文章：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDg3Mjk4MS9hcnRpY2xlL2RldGFpbHMvMTM3Mzk3Nzk4">https://blog.csdn.net/weixin_44872981/article/details/137397798</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLjUxY3RvLmNvbS91XzE2MjEzNzExLzgwMTc2ODk=">https://blog.51cto.com/u_16213711/8017689</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JjaG9tZS5jb20vMTY3NTM=">https://www.orchome.com/16753</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYnJvb2stdy5jb20vcGFnZXMvb3BlbnN0YWNrL2MyOThiNi8jJUU3JUFFJTgwJUU0JUJCJThC">https://www.brook-w.com/pages/openstack/c298b6/#%E7%AE%80%E4%BB%8B</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzY2MzIzOC9hcnRpY2xlL2RldGFpbHMvMTMzODMxNzE3">https://blog.csdn.net/weixin_43663238/article/details/133831717</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81Njc0NDc1My9hcnRpY2xlL2RldGFpbHMvMTM0NjEzNzEz">https://blog.csdn.net/weixin_56744753/article/details/134613713</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLjUxY3RvLmNvbS91XzE2MjEzNjU0Lzg3NjYxMDM=">https://blog.51cto.com/u_16213654/8766103</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC83MDMwMTk1Mzg4Njc4MTQ0MDMw">https://juejin.cn/post/7030195388678144030</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzU3Nzc2NTk4L2FydGljbGUvZGV0YWlscy8xMzQzNDkwMTY=">https://blog.csdn.net/m0_57776598/article/details/134349016</span></p>
<h3 id="openvswitch"><a class="markdownIt-Anchor" href="#openvswitch">#</a> openvswitch</h3>
<p>​        对于一个 Linux 系统来说，可以分为用户空间（user space）和内核空间（kernel space），网络设备接入到内核空间。如果需要将数据传输到用户程序则需要通过内核空间将数据上送到用户空间，如果需要在网络设备之间转发数据，直接在内核空间就可以完成。</p>
<p>​        作为运行在 x86 服务器中的软件交换机，直观上来看，应该在内核空间来实现转发。因此，Open vSwitch 在最早期的时候，是在 Linux 内核模块实现了所有的 OpenFlow 的处理。当时的 OpenvSwitch 内核模块处理流程是接收网络数据包，根据 OpenFlow 规则一步步的 Match，并根据 Action 修改网络数据包，最后从某个网络设备送出。</p>
<p>​        但是这种方式很快就被认为是不能实际应用的。首先，虽然在内核实现可以缩短网络数据包在操作系统的路径，但是在内核进行程序开发和更新也更加困难，以 OpenvSwitch 的更新速度，完全在内核实现将变得不切实际。其次，完全按照 OpenFlow pipeline 去处理网络包，势必要消耗大量 CPU，进而降低网络性能。</p>
<p>​        因此，最新版本（2.x 版本）的 OpenVSwitch 采用了一种很不一样的方式来避免这些问题。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install @<span class="string">&#x27;Development Tools&#x27;</span> rpm-build yum-utils</span><br><span class="line"><span class="comment"># yum install -y epel-release</span></span><br><span class="line">yum install -y centos-release-openstack-train</span><br><span class="line">yum install openvswitch libibverbs -y</span><br><span class="line">systemctl <span class="built_in">enable</span> --now openvswitch</span><br></pre></td></tr></table></figure>
<h5 id="bridge"><a class="markdownIt-Anchor" href="#bridge">#</a> bridge</h5>
<p>Bridge 代表一个以太网交换机 (Switch)，一个主机中可以创建一个或者多个 Bridge。Bridge 的功能是根据一定规则，把从端口收到的数据包转发到另一个或多个端口，上面例子中有三个 Bridge，br-tun，br-int，br-ext</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl add-br br0</span><br></pre></td></tr></table></figure>
<h5 id="port"><a class="markdownIt-Anchor" href="#port">#</a> <strong>Port</strong></h5>
<p>​        端口 Port 与物理交换机的端口概念类似，Port 是 OVS Bridge 上创建的一个虚拟端口，每个 Port 都隶属于一个 Bridge。Port 有以下几种类型：</p>
<h6 id="normal"><a class="markdownIt-Anchor" href="#normal">#</a> Normal</h6>
<p>​        可以把操作系统中已有的网卡 (物理网卡 em1/eth0, 或虚拟机的虚拟网卡 tapxxx) 挂载到 ovs 上，ovs 会生成一个同名 Port 处理这块网卡进出的数据包。此时端口类型为 Normal。</p>
<p>​        如下，主机中有一块物理网卡 eth1，把其挂载到 OVS 网桥 br-ext 上，OVS 会自动创建同名 Port eth1</p>
<p>​        有一点要注意的是，挂载到 OVS 上的网卡设备不支持分配 IP 地址，因此若之前 eth1 配置有 IP 地址，挂载到 OVS 之后 IP 地址将不可访问。这里的网卡设备不只包括物理网卡，也包括主机上创建的虚拟网卡。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl add-port br0 eth1</span><br><span class="line"><span class="comment"># 这里eth1就是port</span></span><br><span class="line"></span><br><span class="line">    Bridge <span class="string">&quot;br0&quot;</span></span><br><span class="line">        Port <span class="string">&quot;eth1&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;eth1&quot;</span></span><br><span class="line">        Port <span class="string">&quot;br0&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;br0&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br></pre></td></tr></table></figure>
<h6 id="internal"><a class="markdownIt-Anchor" href="#internal">#</a> Internal</h6>
<p>​        Internal 类型是 OVS 内部创建的虚拟网卡接口，每创建一个 Port，OVS 会自动创建一个同名接口 (Interface) 挂载到新创建的 Port 上。接口的概念下面会提到。</p>
<p>​        下面创建一个网桥 br0，并创建一个 Internal 类型的 Port p0。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl add-br br1</span><br><span class="line">ovs-vsctl add-port br1 p0 -- <span class="built_in">set</span> Interface p0 <span class="built_in">type</span>=internal</span><br><span class="line"></span><br><span class="line">[root@iv-yd5uco04qo5i3z39s0gj /]<span class="comment"># ovs-vsctl show </span></span><br><span class="line">24558780-9b54-41d2-8b8e-1a1dd7c5127e</span><br><span class="line">    Bridge br-ext</span><br><span class="line">        Port <span class="string">&quot;p0&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;p0&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port br-ext</span><br><span class="line">            Interface br-ext</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br></pre></td></tr></table></figure>
<p>可以看到有两个 Port。当 ovs 创建一个新网桥时，默认会创建一个与网桥同名的 Internal Port。在 OVS 中，只有”internal” 类型的设备才支持配置 IP 地址信息，因此我们可以为 br0 接口配置一个 IP 地址，当然 p0 也可以配置 IP 地址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 192.168.10.11/24 dev br0</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line"><span class="comment">#添加默认路由</span></span><br><span class="line">ip route add default via 192.168.10.1 dev br0</span><br></pre></td></tr></table></figure>
<p>上面两种 Port 类型区别在于，Internal 类型会自动创建接口 (Interface)，而 Normal 类型是把主机中已有的网卡接口添加到 OVS 中。</p>
<h6 id="patch"><a class="markdownIt-Anchor" href="#patch">#</a> Patch</h6>
<p>​        当主机中有多个 ovs 网桥时，可以使用 Patch Port 把两个网桥连起来。Patch Port 总是成对出现，分别连接在两个网桥上，从一个 Patch Port 收到的数据包会被转发到另一个 Patch Port，类似于 Linux 系统中的 veth。使用 Patch 连接的两个网桥跟一个网桥没什么区别，OpenStack Neutron 中使用到了 Patch Port。上面网桥 br-ext 中的 Port phy-br-ext 与 br-int 中的 Port int-br-ext 是一对 Patch Port。</p>
<p>​        可以使用 ovs-vsctl 创建 patch 设备，如下创建两个网桥 br0,br1，然后使用一对 Patch Port 连接它们。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl add-br br10</span><br><span class="line">ovs-vsctl add-br br20</span><br><span class="line">ovs-vsctl -- add-port br10 patch0 -- <span class="built_in">set</span> Interface patch0 <span class="built_in">type</span>=patch options:peer=patch1 \</span><br><span class="line">-- add-port br20 patch1 -- <span class="built_in">set</span> Interface patch1 <span class="built_in">type</span>=patch options:peer=patch0</span><br><span class="line">    Bridge <span class="string">&quot;br20&quot;</span></span><br><span class="line">        Port <span class="string">&quot;br20&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;br20&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port <span class="string">&quot;patch1&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;patch1&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=<span class="string">&quot;patch0&quot;</span>&#125;</span><br><span class="line">                </span><br><span class="line">    Bridge <span class="string">&quot;br10&quot;</span></span><br><span class="line">        Port <span class="string">&quot;br10&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;br10&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port <span class="string">&quot;patch0&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;patch0&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=<span class="string">&quot;patch1&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>连接两个网桥不止上面一种方法，linux 中支持创建 Veth 设备对，我们可以首先创建一对 Veth 设备对，然后把这两个 Veth 分别添加到两个网桥上，其效果跟 OVS 中创建 Patch Port 一样</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建veth设备对veth-a,veth-b</span></span><br><span class="line">ip <span class="built_in">link</span> add veth-a <span class="built_in">type</span> veth peer name veth-b</span><br><span class="line"><span class="comment">#使用Veth连接两个网桥</span></span><br><span class="line">ovs-vsctl add-port br0 veth-a</span><br><span class="line">ovs-vsctl add-port br1 veth-b</span><br></pre></td></tr></table></figure>
<h6 id="tunnel"><a class="markdownIt-Anchor" href="#tunnel">#</a> Tunnel</h6>
<p>​        OVS 中支持添加隧道 (Tunnel) 端口，常见隧道技术有两种 gre 或 vxlan。隧道技术是在现有的物理网络之上构建一层虚拟网络，上层应用只与虚拟网络相关，以此实现的虚拟网络比物理网络配置更加灵活，并能够实现跨主机的 L2 通信以及必要的租户隔离。不同隧道技术其大体思路均是将以太网报文使用隧道协议封装，然后使用底层 IP 网络转发封装后的数据包，其差异性在于选择和构造隧道的协议不同。Tunnel 在 OpenStack 中用作实现大二层网络以及租户隔离，以应对公有云大规模，多租户的复杂网络环境。</p>
<p>​        OpenStack 是多节点结构，同一子网的虚拟机可能被调度到不同计算节点上，因此需要有隧道技术来保证这些同子网不同节点上的虚拟机能够二层互通，就像他们连接在同一个交换机上，同时也要保证能与其它子网隔离。</p>
<p>​        OVS 在计算和网络节点上建立隧道 Port 来连接各节点上的网桥 br-int，这样所有网络和计算节点上的 br-int 互联形成了一个大的虚拟的跨所有节点的逻辑网桥 (内部靠 tunnel id 或 VNI 隔离不同子网)，这个逻辑网桥对虚拟机和 qrouter 是透明的，它们觉得自己连接到了一个大的 br-int 上。从某个计算节点虚拟机发出的数据包会被封装进隧道通过底层网络传输到目的主机然后解封装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#主机192.168.7.21上</span></span><br><span class="line">ovs-vsctl add-br br-vxlan</span><br><span class="line"><span class="comment">#主机192.168.7.23上</span></span><br><span class="line">ovs-vsctl add-br br-vxlan</span><br><span class="line"><span class="comment">#主机192.168.7.21上添加连接到7.23的Tunnel Port</span></span><br><span class="line">ovs-vsctl add-port br-vxlan tun0 -- <span class="built_in">set</span> Interfacetun0 <span class="built_in">type</span>=vxlan options:remote_ip=192.168.7.23</span><br><span class="line"><span class="comment">#主机192.168.7.23上添加连接到7.21的Tunnel Port</span></span><br><span class="line">ovs-vsctl add-port br-vxlan tun0 -- <span class="built_in">set</span> Interfacetun0 <span class="built_in">type</span>=vxlan options:remote_ip=192.168.7.21</span><br></pre></td></tr></table></figure>
<p>两个主机上桥接到 br-vxlan 的虚拟机就像连接到同一个交换机一样，可以实现跨主机的 L2 连接，同时又完全与物理网络隔离。</p>
<h5 id="interface"><a class="markdownIt-Anchor" href="#interface">#</a> <strong>Interface</strong></h5>
<p>​        Interface 是连接到 Port 的网络接口设备，是 OVS 与外部交换数据包的组件，在通常情况下，Port 和 Interface 是一对一的关系，只有在配置 Port 为 bond 模式后，Port 和 Interface 是一对多的关系。这个网络接口设备可能是创建 Internal 类型 Port 时 OVS 自动生成的虚拟网卡，也可能是系统的物理网卡或虚拟网卡 (TUN/TAP) 挂载在 ovs 上。 OVS 中只有”Internal” 类型的网卡接口才支持配置 IP 地址。</p>
<p>​        Interface 是一块网络接口设备，负责接收或发送数据包，Port 是 OVS 网桥上建立的一个虚拟端口，Interface 挂载在 Port 上。</p>
<h5 id="命令行工具"><a class="markdownIt-Anchor" href="#命令行工具">#</a> 命令行工具</h5>
<p>我们可以修改和配置的是 OpenFlow flows。datapath flow 和”hidden” flows 由 OVS 自身管理，我们不必去修改它。当然，调试场景下还是可以使用工具修改的。</p>
<p>​        介绍下上面三种 flows 管理工具，不具体说明，具体使用可以查看相关 man 手册。</p>
<ul>
<li>ovs-ofctl dump-flows 打印指定网桥内的所有 OpenFlow flows，可以存在多个流表 (flow tables)，按表顺序显示。不包括”hidden” flows。这是最常用的查看 flows 命令，当然这条命令对所有 OpenFlow 交换机都有效，不单单是 OVS；</li>
<li>ovs-appctl bridge/dump-flows 打印指定网桥内所有 OpenFlow flows，包括”hidden” flows，in-band control 模式下排错可以用到；</li>
<li>ovs-dpctl dump-flows dp 打印内核模块中 datapath flows，dp 可以省略，默认主机中只有一个 datapath system@ovs-systemman 手册可以找到非常详细的用法说明，注意 ovs-ofctl 管理的是 OpenFlow flows；</li>
</ul>
<h4 id="241-ovs-vsctl"><a class="markdownIt-Anchor" href="#241-ovs-vsctl">#</a> <strong>2.4.1 ovs-vsctl</strong></h4>
<p>​        ovs-vsctl 是一个管理或配置 ovs-vswitchd 的高级命令行工具，高级是说其操作对用户友好，封装了对数据库的操作细节。它是管理 OVS 最常用的命令，除了配置 flows 之外，其它大部分操作比如 Bridge/Port/Interface/Controller/Database/Vlan 等都可以完成。</p>
<p><img data-src="https://bytedance.larkoffice.com/space/api/box/stream/download/asynccode/?code=YzljYzlhOWFjZmI4MGU4OWVjMWI4M2Y0NTJlMjMzZDJfRWRWVDRRQ3JQa3o4YWFNUm41WlpJYkk4dFNMOEVtM3hfVG9rZW46SUxSQWJXd2Q4b0kwa1l4aWtWaGNJRWN6blZnXzE3MTYyMTU4MTE6MTcxNjIxOTQxMV9WNA" alt="img"></p>
<h4 id="242-ovsdb-tool"><a class="markdownIt-Anchor" href="#242-ovsdb-tool">#</a> <strong>2.4.2 ovsdb-tool</strong></h4>
<p>​        ovsdb-tool 是一个专门管理 OVS 数据库文件的工具，不常用，它不直接与 ovsdb-server 进程通信。</p>
<p><img data-src="https://bytedance.larkoffice.com/space/api/box/stream/download/asynccode/?code=NGQxYjk1MzY4Mzg2NGEzZjg0Nzk0NWY3Y2NjMGMzNWRfOU5rNVFpdGpCUHZaQnJWN0NoMVlUMXRIZm9rUnRCZnJfVG9rZW46QklaOGJoTEJFbzJWTWN4UHZBMWNmSVRJblNkXzE3MTYyMTU4MTE6MTcxNjIxOTQxMV9WNA" alt="img"></p>
<h4 id="243-ovsdb-client"><a class="markdownIt-Anchor" href="#243-ovsdb-client">#</a> <strong>2.4.3 ovsdb-client</strong></h4>
<p>​        ovsdb-client 是 ovsdb-server 进程的命令行工具，主要是从正在运行的 ovsdb-server 中查询信息，操作的是数据库相关。</p>
<p><img data-src="https://bytedance.larkoffice.com/space/api/box/stream/download/asynccode/?code=OTUyZDE0ODA2ODY3NTQwOGY2YWQyMzE0ZGQ5MDgxOGRfTTZ1VUNpbEswUlZuMGdPblNZYkxGSWg2U1B2V3NOTnlfVG9rZW46UFRDemJRMlptbzQybTl4YlRhQ2N4TUQybmdUXzE3MTYyMTU4MTE6MTcxNjIxOTQxMV9WNA" alt="img"></p>
<h4 id="244-ovs-ofctl"><a class="markdownIt-Anchor" href="#244-ovs-ofctl">#</a> <strong>2.4.4 ovs-ofctl</strong></h4>
<p>​        ovs-ofctl 是专门管理配置 OpenFlow 交换机的命令行工具，我们可以用它手动配置 OVS 中的 OpenFlow flows，注意其不能操作 datapath flows 和”hidden” flows。</p>
<p><img data-src="https://bytedance.larkoffice.com/space/api/box/stream/download/asynccode/?code=Mjc5ZDU3OGRjNmI4YzNlOTNjMzA1ZjZhNGFjYWJhYWJfSmFqaEpESmZmUDhXeWxwN1lOSUpHZ0FOVjRieDg0amhfVG9rZW46QmFJemIwWjJ1b2N4djd4Y2hVMmNsMlpRbjdmXzE3MTYyMTU4MTE6MTcxNjIxOTQxMV9WNA" alt="img"></p>
<p>​         ovs-vsctl 是一个综合的配置管理工具，ovsdb-client 倾向于从数据库中查询某些信息，而 ovsdb-tool 是维护数据库文件工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep ovs </span><br><span class="line">openvsw+ 28481     1  0 15:58 ?        00:00:00 ovsdb-server /etc/openvswitch/conf.db -vconsole:emer -vsyslog:err -vfile:info --remote=punix:/var/run/openvswitch/db.sock --private-key=db:Open_vSwitch,SSL,private_key --certificate=db:Open_vSwitch,SSL,certificate --bootstrap-ca-cert=db:Open_vSwitch,SSL,ca_cert --user openvswitch:hugetlbfs --no-chdir --log-file=/var/log/openvswitch/ovsdb-server.log --pidfile=/var/run/openvswitch/ovsdb-server.pid --detach</span><br><span class="line">openvsw+ 28553     1  0 15:58 ?        00:00:03 ovs-vswitchd unix:/var/run/openvswitch/db.sock -vconsole:emer -vsyslog:err -vfile:info --mlockall --user openvswitch:hugetlbfs --no-chdir --log-file=/var/log/openvswitch/ovs-vswitchd.log --pidfile=/var/run/openvswitch/ovs-vswitchd.pid --detach</span><br></pre></td></tr></table></figure>
<p><img data-src="https://bytedance.larkoffice.com/space/api/box/stream/download/asynccode/?code=MDY0YzBjMWVhMTU5NDcwNGI3MmI1ZGVjNTM2ZjI3MThfVWM4RVBrdnY5M0pzZk9abFRIMTZ5UFdrNkk5MFNva2xfVG9rZW46RVpCZmJnd0FYb3k2NVl4azJ3MmNaUlNtbmZkXzE3MTYyMTU4MTE6MTcxNjIxOTQxMV9WNA" alt="img"></p>
<ul>
<li>ovs-vswitchd：守护程序，实现交换功能，和 Linux 内核兼容模块一起，实现基于流的交换 flow-based switching。</li>
<li>ovsdb-server：轻量级的数据库服务，主要保存了整个 OVS 的配置信息，包括接口，交换内容，VLAN 啊等等。ovs-vswitchd 会根据数据库中的配置信息工作。</li>
<li>ovs-dpctl：一个工具，用来配置交换机内核模块，可以控制转发规则。</li>
<li>ovs-vsctl：主要是获取或者更改 ovs-vswitchd 的配置信息，此工具操作的时候会更新 ovsdb-server 中的数据库。</li>
<li>ovs-appctl：主要是向 OVS 守护进程发送命令的，一般用不上。</li>
<li>ovsdbmonitor：GUI 工具来显示 ovsdb-server 中数据信息。</li>
<li>ovs-controller：一个简单的 OpenFlow 控制器.</li>
<li>ovs-ofctl：用来控制 OVS 作为 OpenFlow 交换机工作时候的流表内容。</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8yMDQ2Njk1">https://cloud.tencent.com/developer/article/2046695</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8yMDQ2Njk4">https://cloud.tencent.com/developer/article/2046698</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82ODE5OTIyNzU=">https://zhuanlan.zhihu.com/p/681992275</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjM1MzM2Ni9hcnRpY2xlL2RldGFpbHMvMTMyMDM4Njc4">https://blog.csdn.net/weixin_46353366/article/details/132038678</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuc2RubGFiLmNvbS9zZG4tZ3VpZGUvMTQ3NDcuaHRtbA==">https://www.sdnlab.com/sdn-guide/14747.html</span></p>

      <div class="tags">
          <a href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag"><i class="ic i-tag"></i> 运维</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-05-26 17:46:12" itemprop="dateModified" datetime="2024-05-26T17:46:12+08:00">2024-05-26</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2024/01/25/%E8%99%9A%E6%8B%9F%E5%8C%96/" title="虚拟化">http://example.com/2024/01/25/虚拟化/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;ef128de47d4db8fad3281150b16d7793.jpg" title="集群与存储">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> 运维</span>
  <h3>集群与存储</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2024/01/31/%E5%8F%B0%E7%90%83/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;2b0a8c81d91579602eee343aff82c4c9.jpg" title="台球入门教程">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>台球入门教程</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text"> 虚拟化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kvm"><span class="toc-number">1.1.</span> <span class="toc-text"> kvm</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96-2"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kvm-qemu-libvirtd"><span class="toc-number">1.1.2.</span> <span class="toc-text"> KVM &#x2F;QEMU &#x2F;LIBVIRTD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virsh-%E5%91%BD%E4%BB%A4"><span class="toc-number">1.1.3.</span> <span class="toc-text"> virsh 命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86"><span class="toc-number">1.1.4.</span> <span class="toc-text"> 虚拟机磁盘管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%8B%E9%9A%86%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">1.1.5.</span> <span class="toc-text"> 克隆虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E7%A3%81%E7%9B%98"><span class="toc-number">1.1.6.</span> <span class="toc-text"> 扩容磁盘</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openstack"><span class="toc-number">1.2.</span> <span class="toc-text"> OpenStack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#openstack-%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text"> openstack 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 项目管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 网络</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openstack-2"><span class="toc-number">1.3.</span> <span class="toc-text"> openstack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E6%94%BE%E4%BA%91%E4%B8%BB%E6%9C%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 发放云主机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="toc-number">1.3.2.1.</span> <span class="toc-text"> 创建镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.2.2.</span> <span class="toc-text"> 创建实例类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C"><span class="toc-number">1.3.2.3.</span> <span class="toc-text"> 创建外部网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%92%8C%E7%A7%9F%E6%88%B7"><span class="toc-number">1.3.2.4.</span> <span class="toc-text"> 创建用户和租户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.2.5.</span> <span class="toc-text"> 创建网络过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%89%E5%85%A8%E7%BB%84"><span class="toc-number">1.3.2.6.</span> <span class="toc-text"> 创建安全组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B5%AE%E5%8A%A8ip"><span class="toc-number">1.3.2.7.</span> <span class="toc-text"> 创建浮动 ip</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%A7%98%E9%92%A5%E5%AF%B9"><span class="toc-number">1.3.2.8.</span> <span class="toc-text"> 创建秘钥对</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.3.2.9.</span> <span class="toc-text"> 创建实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E6%B5%AE%E5%8A%A8ip"><span class="toc-number">1.3.2.10.</span> <span class="toc-text"> 绑定浮动 IP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%AE%A1%E7%90%86openstack"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 命令行管理 OpenStack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 查看日志信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cinder"><span class="toc-number">1.3.5.</span> <span class="toc-text"> cinder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#keystone"><span class="toc-number">1.3.6.</span> <span class="toc-text"> keystone</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#glance"><span class="toc-number">1.3.7.</span> <span class="toc-text"> glance</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F"><span class="toc-number">1.3.7.1.</span> <span class="toc-text"> 制作镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E6%90%AD%E5%BB%BAdalmatian%E7%89%88-openstack"><span class="toc-number">1.3.8.</span> <span class="toc-text"> 升级，搭建 [Dalmatian] 版 openstack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C"><span class="toc-number">1.3.9.</span> <span class="toc-text"> 创建网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nova"><span class="toc-number">1.3.10.</span> <span class="toc-text"> nova</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#neutron"><span class="toc-number">1.3.11.</span> <span class="toc-text"> neutron</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#openstack-%E7%BD%91%E7%BB%9C%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.11.0.1.</span> <span class="toc-text"> openstack 网络类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#router"><span class="toc-number">1.3.11.1.</span> <span class="toc-text"> router</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#metadata"><span class="toc-number">1.3.11.2.</span> <span class="toc-text"> metadata</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mq"><span class="toc-number">1.3.12.</span> <span class="toc-text"> MQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openstack-%E4%BD%BF%E7%94%A8-source-%E5%AE%89%E8%A3%85dashboard"><span class="toc-number">1.3.13.</span> <span class="toc-text"> openstack 使用 source  安装 dashboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8kolla-openstack%E5%AE%89%E8%A3%85openstack"><span class="toc-number">1.3.14.</span> <span class="toc-text"> 使用 kolla-openstack 安装 openstack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openvswitch"><span class="toc-number">1.3.15.</span> <span class="toc-text"> openvswitch</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#bridge"><span class="toc-number">1.3.15.0.1.</span> <span class="toc-text"> bridge</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#port"><span class="toc-number">1.3.15.0.2.</span> <span class="toc-text"> Port</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#normal"><span class="toc-number">1.3.15.0.2.1.</span> <span class="toc-text"> Normal</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#internal"><span class="toc-number">1.3.15.0.2.2.</span> <span class="toc-text"> Internal</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#patch"><span class="toc-number">1.3.15.0.2.3.</span> <span class="toc-text"> Patch</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#tunnel"><span class="toc-number">1.3.15.0.2.4.</span> <span class="toc-text"> Tunnel</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#interface"><span class="toc-number">1.3.15.0.3.</span> <span class="toc-text"> Interface</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">1.3.15.0.4.</span> <span class="toc-text"> 命令行工具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#241-ovs-vsctl"><span class="toc-number">1.3.15.1.</span> <span class="toc-text"> 2.4.1 ovs-vsctl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#242-ovsdb-tool"><span class="toc-number">1.3.15.2.</span> <span class="toc-text"> 2.4.2 ovsdb-tool</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#243-ovsdb-client"><span class="toc-number">1.3.15.3.</span> <span class="toc-text"> 2.4.3 ovsdb-client</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#244-ovs-ofctl"><span class="toc-number">1.3.15.4.</span> <span class="toc-text"> 2.4.4 ovs-ofctl</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/11/27/CDN/" rel="bookmark" title="CDN&DNS">CDN&DNS</a></li><li><a href="/2023/04/03/iptables2/" rel="bookmark" title="iptables">iptables</a></li><li><a href="/2023/04/05/Docker/" rel="bookmark" title="docker">docker</a></li><li><a href="/2023/04/15/Nginx_new/" rel="bookmark" title="Nginx">Nginx</a></li><li><a href="/2023/05/20/Kubernetes/" rel="bookmark" title="Kubernetes">Kubernetes</a></li><li><a href="/2023/05/30/jenkins/" rel="bookmark" title="Jenkins">Jenkins</a></li><li><a href="/2023/06/02/k8s%E9%AB%98%E7%BA%A7/" rel="bookmark" title="k8s高级">k8s高级</a></li><li><a href="/2024/01/01/istio/" rel="bookmark" title="istio">istio</a></li><li><a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" rel="bookmark" title="集群与存储">集群与存储</a></li><li class="active"><a href="/2024/01/25/%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="bookmark" title="虚拟化">虚拟化</a></li><li><a href="/2024/02/01/%E7%9B%91%E6%8E%A7/" rel="bookmark" title="监控">监控</a></li><li><a href="/2024/02/15/Elastic%20Stack/" rel="bookmark" title="Elastic stack">Elastic stack</a></li><li><a href="/2024/06/01/openstack/" rel="bookmark" title="OpenStack+openvswitch">OpenStack+openvswitch</a></li><li><a href="/2024/07/01/GPU%E5%85%A5%E9%97%A8%E6%A6%82%E8%AE%BA/" rel="bookmark" title="GPU入门概论">GPU入门概论</a></li><li><a href="/2024/12/01/redis/" rel="bookmark" title="Redis">Redis</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">54</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">7</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">7</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2024/01/31/%E5%8F%B0%E7%90%83/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/11/reverse/" title="逆向">逆向</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/08/22/%E5%8E%BB%E5%BC%B9%E7%AA%97%E7%BB%BF%E5%8C%96/" title="破解相关">破解相关</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" title="集群与存储">集群与存储</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/04/15/Nginx_new/" title="Nginx">Nginx</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" title="In 大数据">大数据</a>
</div>

    <span><a href="/2024/05/01/hive_flink/" title="hive_flink">hive_flink</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2024/02/01/%E7%9B%91%E6%8E%A7/" title="监控">监控</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/05/17/include/" title="file include">file include</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/01/01/%E5%8F%91%E7%8E%B0%E5%B0%8F%E5%8F%AF%E7%88%B1%EF%BC%81/" title="about me">about me</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/" title="水滴rev">水滴rev</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/08/15/%E7%A0%B4%E8%A7%A3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B9%8B%E8%AE%A4%E8%AF%86%E5%A3%B3%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%89%B9%E5%BE%81/" title="破解基础知识之认识壳与程序的特征">破解基础知识之认识壳与程序的特征</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2024/01/25/虚拟化/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
